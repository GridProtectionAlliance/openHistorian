"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[4979],{3658:(et,C,i)=>{i.r(C),i.d(C,{plugin:()=>G});var a=i(74848),D=i(65158),R=i(79924),c=i(32196),I=i(96540),N=i(64423),P=i(71733),w=i(26272),F=i(69129),B=i(47232),V=i(32264),S=i(39601),b=i(17172),E=i(40276),O=i(55852),j=i(64149),$=i(3911),k=i(85918),M=i(28138),f=i(14792),p=i(40845),u=i(10860),H=i(44522),Z=i(56034);const z=({options:r,annotation:s,formatDate:t,onClick:o,onAvatarClick:n,onTagClick:l})=>{const e=(0,p.of)(y),{showUser:d,showTags:m,showTime:h}=r,{text:J="",login:A,email:X,avatarUrl:Y,tags:L,time:v,timeEnd:T}=s,q=()=>{o(s)},_=()=>{n(s)},tt=A&&d,at=v&&h,st=T&&T!==v&&h;return(0,a.jsxs)(u.Z,{className:e.card,onClick:q,children:[(0,a.jsx)(u.Z.Heading,{children:(0,a.jsx)(H.I,{className:e.heading,onClick:x=>{x.stopPropagation()},content:J})}),at&&(0,a.jsxs)(u.Z.Description,{className:e.timestamp,children:[(0,a.jsx)(U,{formatDate:t,time:v}),st&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("span",{className:e.time,children:"-"}),(0,a.jsx)(U,{formatDate:t,time:T})," "]})]}),tt&&(0,a.jsx)(u.Z.Meta,{className:e.meta,children:(0,a.jsx)(Q,{email:X,login:A,avatarUrl:Y,onClick:_})}),m&&L&&(0,a.jsx)(u.Z.Tags,{children:(0,a.jsx)(j.L,{tags:L,onClick:x=>l(x,!1)})})]})},Q=({onClick:r,avatarUrl:s,login:t,email:o})=>{const n=(0,p.of)(y),l=d=>{d.stopPropagation(),r()},e=(0,a.jsxs)("span",{children:["Created by:",(0,a.jsx)("br",{})," ",o]});return(0,a.jsx)(Z.m,{content:e,theme:"info",placement:"top",children:(0,a.jsx)("button",{onClick:l,className:n.avatar,children:(0,a.jsx)("img",{src:s,alt:"avatar icon"})})})},U=({time:r,formatDate:s})=>{const t=(0,p.of)(y);return(0,a.jsx)("span",{className:t.time,children:(0,a.jsx)("span",{children:s(r)})})};function y(r){return{card:(0,c.css)({gridTemplateAreas:'"Heading Description Meta Tags"',gridTemplateColumns:"auto 1fr auto auto",padding:r.spacing(1),margin:r.spacing(.5),width:"inherit"}),heading:(0,c.css)({a:{zIndex:1,position:"relative",color:r.colors.text.link,"&:hover":{textDecoration:"underline"}}}),meta:(0,c.css)({margin:0,position:"relative",justifyContent:"end"}),timestamp:(0,c.css)({margin:0,alignSelf:"center"}),time:(0,c.css)({marginLeft:r.spacing(1),marginRight:r.spacing(1),fontSize:r.typography.bodySmall.fontSize,color:r.colors.text.secondary}),avatar:(0,c.css)({border:"none",background:"inherit",margin:0,padding:r.spacing(.5),img:{borderRadius:r.shape.radius.circle,width:r.spacing(2),height:r.spacing(2)}})}}class W extends I.PureComponent{constructor(s){super(s),this.style=K(V.$.theme2),this.subs=new N.yU,this.tagListRef=(0,I.createRef)(),this.onAnnoClick=async t=>{if(!t.time)return;const{options:o}=this.props,l=(0,f.UA)().getCurrent(),e={from:this._timeOffset(t.time,o.navigateBefore,!0),to:this._timeOffset(t.timeEnd??t.time,o.navigateAfter,!1),viewPanel:o.navigateToPanel&&t.panelId?t.panelId:void 0};if(!t.dashboardUID||l?.uid===t.dashboardUID){S.Ny.partial(e);return}const d=await(0,b.AI)().get("/api/search",{dashboardUIDs:t.dashboardUID});if(d&&d.length&&d[0].uid===t.dashboardUID){const m=d[0],h=new URL(m.url,window.location.origin);h.searchParams.set("from",String(e.from)),h.searchParams.set("to",String(e.to)),S.Ny.push(P.I.stripBaseFromUrl(h.toString()));return}M.A.emit(w.r1.alertWarning,["Unknown Dashboard: "+t.dashboardUID])},this.onTagClick=(t,o)=>{if(!o&&this.state.queryTags.includes(t))return;const n=o?this.state.queryTags.filter(e=>e!==t):[...this.state.queryTags,t];let l;if(o){const e=document.activeElement,d=e?.getAttribute("data-tag-id");if(this.tagListRef.current?.contains(e)&&d){const m=Number.parseInt(d,10),h=this.tagListRef.current.querySelector(`[data-tag-id="${m+1}"]`)??this.tagListRef.current.querySelector(`[data-tag-id="${m-1}"]`);h instanceof HTMLElement&&(l=h)}}this.setState({queryTags:n},()=>l?.focus())},this.onUserClick=t=>{this.setState({queryUser:{id:t.userId,login:t.login,email:t.email}})},this.onClearUser=()=>{this.setState({queryUser:void 0})},this.renderItem=(t,o)=>{const{options:n}=this.props,l=(0,f.UA)().getCurrent();return l?(0,a.jsx)(z,{annotation:t,formatDate:l.formatDate,onClick:this.onAnnoClick,onAvatarClick:this.onUserClick,onTagClick:this.onTagClick,options:n}):(0,a.jsx)(a.Fragment,{})},this.state={annotations:[],timeInfo:"",loaded:!1,queryTags:[]}}componentDidMount(){this.doSearch(),this.subs.add(this.props.eventBus.getStream(F.We).subscribe({next:()=>{this.doSearch()}}))}componentWillUnmount(){this.subs.unsubscribe()}componentDidUpdate(s,t){const{options:o,timeRange:n}=this.props;(o!==s.options||this.state.queryTags!==t.queryTags||this.state.queryUser!==t.queryUser||s.renderCounter!==this.props.renderCounter||o.onlyInTimeRange&&n!==s.timeRange)&&this.doSearch()}async doSearch(){const{options:s}=this.props,{queryUser:t,queryTags:o}=this.state,n={tags:s.tags,limit:s.limit,type:"annotation"};s.onlyFromThisDashboard&&(n.dashboardUID=(0,f.UA)().getCurrent()?.uid);let l="";if(s.onlyInTimeRange){const{timeRange:d}=this.props;n.from=d.from.valueOf(),n.to=d.to.valueOf()}else l="All Time";t&&(n.userId=t.id),s.tags&&s.tags.length&&(n.tags=s.tags.map(d=>this.props.replaceVariables(d))),o.length&&(n.tags=n.tags?[...n.tags,...o]:o);const e=await(0,b.AI)().get("/api/annotations",n,`anno-list-panel-${this.props.id}`);this.setState({annotations:e,timeInfo:l,loaded:!0})}_timeOffset(s,t,o=!1){let n=5,l="m";const e=/^(\d+)(\w)/.exec(t);e&&e.length===3&&(n=parseInt(e[1],10),l=e[2]);const d=(0,B.KQ)(s);return o&&(n*=-1),d.add(n,l).valueOf()}render(){const{loaded:s,annotations:t,queryUser:o,queryTags:n}=this.state;if(!s)return(0,a.jsx)("div",{children:"loading..."});const l=o||n.length>0;return(0,a.jsxs)(E.E,{autoHeightMin:"100%",children:[l&&(0,a.jsxs)("div",{className:this.style.filter,children:[(0,a.jsx)("b",{children:"Filter:"}),o&&(0,a.jsx)(O.$n,{size:"sm",variant:"secondary",fill:"text",onClick:this.onClearUser,"aria-label":`Remove filter: ${o.email}`,children:o.email}),n.length>0&&(0,a.jsx)(j.L,{icon:"times",tags:n,onClick:e=>this.onTagClick(e,!0),getAriaLabel:e=>`Remove ${e} tag`,className:this.style.tagList,ref:this.tagListRef})]}),t.length<1&&(0,a.jsx)("div",{className:this.style.noneFound,children:"No Annotations Found"}),(0,a.jsx)(k.p,{items:t,renderItem:this.renderItem,getItemKey:e=>`${e.id}`})]})}}const K=(0,$.N)(r=>({noneFound:(0,c.css)({display:"flex",alignItems:"center",justifyContent:"center",width:"100%",height:"calc(100% - 30px)"}),filter:(0,c.css)({alignItems:"center",display:"flex",flexWrap:"wrap",gap:r.spacing(.5),padding:r.spacing(.5)}),tagList:(0,c.css)({justifyContent:"flex-start","li > button":{paddingLeft:"3px"}})})),g={limit:10,navigateAfter:"10m",navigateBefore:"10m",navigateToPanel:!0,onlyFromThisDashboard:!1,onlyInTimeRange:!1,showTags:!0,showTime:!0,showUser:!0,tags:[]},G=new D.m(W).setPanelOptions(r=>{r.addRadio({category:["Annotation query"],path:"onlyFromThisDashboard",name:"Query filter",defaultValue:g.onlyFromThisDashboard,settings:{options:[{value:!1,label:"All dashboards"},{value:!0,label:"This dashboard"}]}}).addRadio({category:["Annotation query"],path:"onlyInTimeRange",name:"Time range",defaultValue:g.onlyInTimeRange,settings:{options:[{value:!1,label:"None"},{value:!0,label:"This dashboard"}]}}).addCustomEditor({category:["Annotation query"],id:"tags",path:"tags",name:"Tags",description:"Match annotation tags",editor(s){return(0,a.jsx)(R.u,{tags:s.value,onChange:s.onChange})}}).addNumberInput({category:["Annotation query"],path:"limit",name:"Limit",defaultValue:g.limit}).addBooleanSwitch({category:["Display"],path:"showUser",name:"Show user",defaultValue:g.showUser}).addBooleanSwitch({category:["Display"],path:"showTime",name:"Show time",defaultValue:g.showTime}).addBooleanSwitch({category:["Display"],path:"showTags",name:"Show tags",defaultValue:g.showTags}).addRadio({category:["Link behavior"],path:"navigateToPanel",name:"Link target",defaultValue:g.navigateToPanel,settings:{options:[{value:!0,label:"Panel"},{value:!1,label:"Dashboard"}]}}).addTextInput({category:["Link behavior"],path:"navigateBefore",name:"Time before",defaultValue:g.navigateBefore,description:""}).addTextInput({category:["Link behavior"],path:"navigateAfter",name:"Time after",defaultValue:g.navigateAfter,description:""})}).setPanelChangeHandler((r,s,t)=>s==="ryantxu-annolist-panel"?t:r.options)}}]);

//# sourceMappingURL=annoListPanel.d02e69c368b26a55c97c.js.map