(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[8831],{1762:(e,t,n)=>{"use strict";n.r(t),n.d(t,{AND:()=>f,ASC:()=>c,BY:()=>l,COMPARISON_OPERATORS:()=>x,DESC:()=>u,EQUALS:()=>y,FROM:()=>i,GROUP:()=>s,KEYWORDS:()=>h,LIMIT:()=>d,LOGICAL_OPERATORS:()=>v,NOT_EQUALS:()=>b,ORDER:()=>o,SCHEMA:()=>m,SELECT:()=>r,STATISTICS:()=>g,WHERE:()=>a,WITH:()=>p,conf:()=>w,language:()=>S});const r="SELECT",i="FROM",a="WHERE",s="GROUP",o="ORDER",l="BY",u="DESC",c="ASC",d="LIMIT",p="WITH",m="SCHEMA",h=[r,i,a,s,o,l,u,c,d,p,m],g=["AVG","COUNT","MAX","MIN","SUM"],f="AND",v=[f],y="=",b="!=",x=[y,b],S={defaultToken:"",tokenPostfix:".sql",ignoreCase:!0,brackets:[{open:"[",close:"]",token:"delimiter.square"},{open:"(",close:")",token:"delimiter.parenthesis"}],keywords:h,operators:v,builtinFunctions:g,tokenizer:{root:[[/\$[a-zA-Z0-9-_]+/,"variable"],{include:"@comments"},{include:"@whitespace"},{include:"@numbers"},{include:"@strings"},{include:"@complexIdentifiers"},[/[;,.]/,"delimiter"],[/[()]/,"@brackets"],[/[\w@#$]+/,{cases:{"@keywords":"keyword","@operators":"operator","@builtinFunctions":"predefined","@default":"identifier"}}],[/[=!%&+\-*/|~^]/,"operator"]],whitespace:[[/\s+/,"white"]],comments:[[/--+.*/,"comment"]],comment:[[/[^*/]+/,"comment"],[/./,"comment"]],numbers:[[/0[xX][0-9a-fA-F]*/,"number"],[/[$][+-]*\d*(\.\d*)?/,"number"],[/((\d+(\.\d*)?)|(\.\d+))([eE][\-+]?\d+)?/,"number"]],strings:[[/N'/,{token:"string",next:"@string"}],[/'/,{token:"string",next:"@string"}],[/"/,{token:"type",next:"@string_double"}]],string:[[/[^']+/,"string"],[/''/,"string"],[/'/,{token:"string",next:"@pop"}]],string_double:[[/[^\\"]+/,"type"],[/"/,"type","@pop"]],complexIdentifiers:[[/\[/,{token:"identifier.quote",next:"@bracketedIdentifier"}],[/"/,{token:"identifier.quote",next:"@quotedIdentifier"}]],bracketedIdentifier:[[/[^\]]+/,"identifier"],[/]]/,"identifier"],[/]/,{token:"identifier.quote",next:"@pop"}]],quotedIdentifier:[[/[^"]+/,"identifier"],[/""/,"identifier"],[/"/,{token:"identifier.quote",next:"@pop"}]]}},w={comments:{lineComment:"--",blockComment:["/*","*/"]},brackets:[["{","}"],["[","]"],["(",")"]],autoClosingPairs:[{open:"{",close:"}"},{open:"[",close:"]"},{open:"(",close:")"},{open:'"',close:'"'},{open:"'",close:"'"}],surroundingPairs:[{open:"{",close:"}"},{open:"[",close:"]"},{open:"(",close:")"},{open:'"',close:'"'},{open:"'",close:"'"}]}},48284:(e,t,n)=>{"use strict";n.r(t),n.d(t,{DYNAMIC_LABEL_PATTERNS:()=>r,conf:()=>a,language:()=>i});const r=["${DATAPOINT_COUNT}","${FIRST}","${FIRST_LAST_RANGE}","${FIRST_LAST_TIME_RANGE}","${FIRST_TIME}","${FIRST_TIME_RELATIVE}","${LABEL}","${LAST}","${LAST_TIME}","${LAST_TIME_RELATIVE}","${MAX}","${MAX_TIME}","${MAX_TIME_RELATIVE}","${MIN}","${MIN_MAX_RANGE}","${MIN_MAX_TIME_RANGE}","${MIN_TIME}","${MIN_TIME_RELATIVE}","${PROP('AccountId')}","${PROP('MetricName')}","${PROP('Namespace')}","${PROP('Period')}","${PROP('Region')}","${PROP('Stat')}","${SUM}"],i={id:"dynamicLabels",ignoreCase:!1,tokenizer:{root:[{include:"@whitespace"},{include:"@builtInFunctions"},{include:"@string"},[/\$\{PROP\('Dim.[a-zA-Z0-9-_]?.*'\)\}+/,"predefined"]],builtInFunctions:[[r.map((function(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")})).join("|"),"predefined"]],whitespace:[[/\s+/,"white"]],string:[]}},a={}},67929:(e,t,n)=>{"use strict";n.r(t),n.d(t,{METRIC_MATH_FNS:()=>r,METRIC_MATH_KEYWORDS:()=>a,METRIC_MATH_OPERATORS:()=>s,METRIC_MATH_PERIODS:()=>o,METRIC_MATH_STATISTIC_KEYWORD_STRINGS:()=>i,conf:()=>u,language:()=>l});const r=["ABS","ANOMALY_DETECTION_BAND","AVG","CEIL","DATAPOINT_COUNT","DIFF","DIFF_TIME","FILL","FIRST","LAST","FLOOR","IF","INSIGHT_RULE_METRIC","LOG","LOG10","MAX","METRIC_COUNT","METRICS","MIN","MINUTE","HOUR","DAY","DATE","MONTH","YEAR","EPOCH","PERIOD","RATE","REMOVE_EMPTY","RUNNING_SUM","SEARCH","SERVICE_QUOTA","SLICE","SORT","STDDEV","SUM","TIME_SERIES"],i=["Average","Maximum","Minimum","Sum","SampleCount"],a=["REPEAT","LINEAR","ASC","DSC"],s=["+","-","*","/","^","==","!=","<=",">=","<",">","AND","&&","OR","||"],o=[10,60,300,900,3e3,21600,86400],l={id:"metricMath",ignoreCase:!1,brackets:[{open:"[",close:"]",token:"delimiter.square"},{open:"(",close:")",token:"delimiter.parenthesis"},{open:"{",close:"}",token:"delimiter.curly"}],tokenizer:{root:[{include:"@nonNestableStates"},{include:"@strings"}],nonNestableStates:[{include:"@variables"},{include:"@whitespace"},{include:"@numbers"},{include:"@assignment"},{include:"@keywords"},{include:"@operators"},{include:"@builtInFunctions"},[/[;,.]/,"delimiter"],[/[(){}\[\]]/,"@brackets"]],keywords:[[a.map(c).join("|"),"keyword"]],operators:[[s.map(c).join("|"),"operator"]],builtInFunctions:[[r.map(c).join("|"),"predefined"]],variables:[[/\$[a-zA-Z0-9-_]+/,"variable"]],whitespace:[[/\s+/,"white"]],assignment:[[/=/,"tag"]],numbers:[[/0[xX][0-9a-fA-F]*/,"number"],[/[$][+-]*\d*(\.\d*)?/,"number"],[/((\d+(\.\d*)?)|(\.\d+))([eE][\-+]?\d+)?/,"number"]],strings:[[/'/,{token:"string",next:"@string"}],[/"/,{token:"type",next:"@string_double"}]],string:[[/{/,{token:"delimiter.curly",next:"@nestedCurly"}],[/\(/,{token:"delimiter.parenthesis",next:"@nestedParens"}],[/"/,{token:"type",next:"@string_double"}],[/'/,{token:"string",next:"@pop"}],{include:"@nonNestableStates"},[/[^']/,"string"]],string_double:[[/[^"]/,"type"],[/"/,{token:"type",next:"@pop"}]],nestedCurly:[[/}/,{token:"delimiter.curly",next:"@pop"}],[/'/,{token:"string",next:"@string"}],[/"/,{token:"type",next:"@string_double"}]],nestedParens:[[/\)/,{token:"delimiter.parenthesis",next:"@pop"}],[/'/,{token:"string",next:"@string"}],[/"/,{token:"type",next:"@string_double"}]]}},u={brackets:[["{","}"],["[","]"],["(",")"]],autoClosingPairs:[{open:"{",close:"}"},{open:"[",close:"]"},{open:"(",close:")"},{open:'"',close:'"'},{open:"'",close:"'"}],surroundingPairs:[{open:"{",close:"}"},{open:"[",close:"]"},{open:"(",close:")"},{open:'"',close:'"'},{open:"'",close:"'"}]};function c(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}},25090:(e,t,n)=>{"use strict";n.r(t),n.d(t,{plugin:()=>mr});var r=n(43215),i=n(68404),a=n(93368),s=n(16538),o=n(90923),l=n(3490),u=n(36537),c=n(58257),d=n(67436),p=n(56340),m=n(82897);const h=e=>({label:e,value:e}),g=(e,t)=>[...t,{label:"Template Variables",options:e.getVariables().map(h)}];var f=n(45916);const v=e=>{let{region:t,selectedLogGroups:n,onChange:a,datasource:s,onRunQuery:o,onOpenMenu:d,refId:h,width:v,saved:y=!0}=e;const[b,x]=(0,i.useState)(!1),[S,w]=(0,i.useState)([]),C=(0,i.useMemo)((()=>(0,m.unionBy)(S,null==n?void 0:n.map(r.toOption),"value")),[S,n]),I=(0,i.useCallback)((async(e,t)=>{if(!s)return[];try{return(await s.describeLogGroups({refId:h,region:e,logGroupNamePrefix:t})).map(r.toOption)}catch(e){return(0,p.WI)((0,u.$l)((0,c.t_)("string"==typeof e?e:JSON.stringify(e)))),[]}}),[s,h]);(0,i.useEffect)((()=>{y&&async function(){if(s&&s.getActualRegion(t))return x(!0),I(s.getActualRegion(t)).then((e=>{const t=(0,m.intersection)(n,e.map((e=>e.value||"")));a(t),w(e)})).finally((()=>{x(!1)}));w([])}()}),[s,t,y]);const E=(0,m.debounce)((async(e,t,n)=>{if("input-change"!==n.action||!s)return;if(!/^[\.\-_/#A-Za-z0-9]+$/.test(e))return void(""!==e&&(0,p.WI)((0,u.$l)((0,c.t_)("Invalid Log Group name: "+e))));x(!0);const r=await I(t,e);w((0,m.unionBy)(S,r,"value")),x(!1)}),300);return(0,f.jsx)(l.MultiSelect,{inputId:"default-log-groups","aria-label":"Log Groups",allowCustomValue:!0,options:s?g(s,C):C,value:n,onChange:e=>a(e.filter((e=>{let{value:t}=e;return t})).map((e=>{let{value:t}=e;return t}))),onBlur:o,closeMenuOnSelect:!1,isClearable:!0,isOptionDisabled:()=>n.length>=20,placeholder:"Choose Log Groups",maxVisibleValues:4,noOptionsMessage:"No log groups available",isLoading:b,onOpenMenu:async()=>{d&&await d()},onInputChange:(e,n)=>{E(e,t,n)},width:v})};var y,b,x=n(36636);const S=e=>({infoText:x.css`
    padding-bottom: ${e.spacing(2)};
    color: ${e.colors.text.secondary};
  `}),w="grafana-x-ray-datasource";function C(e){let{datasourceUid:t,onChange:n}=e;const r=Boolean((0,d.ak)().getList({pluginId:w}).length),i=(0,l.useStyles2)(S);return(0,f.jsxs)(f.Fragment,{children:[y||(y=(0,f.jsx)("h3",{className:"page-heading",children:"X-ray trace link"})),(0,f.jsx)("div",{className:i.infoText,children:"Grafana will automatically create a link to a trace in X-ray data source if logs contain @xrayTraceId field"}),!r&&(b||(b=(0,f.jsx)(l.Alert,{title:"There is no X-ray datasource to link to. First add an X-ray data source and then link it to Cloud Watch. ",severity:"info"}))),(0,f.jsx)("div",{className:"gf-form-group",children:(0,f.jsx)(l.InlineField,{htmlFor:"data-source-picker",label:"Data source",labelWidth:28,tooltip:"X-ray data source containing traces",children:(0,f.jsx)(o.DataSourcePicker,{pluginId:w,onChange:e=>n(e.uid),current:t,noDefault:!0})})})]})}var I;var E,T,j=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),A=(E=["",""],T=["",""],Object.freeze(Object.defineProperties(E,{raw:{value:Object.freeze(T)}})));function R(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var O=function(){function e(){for(var t=this,n=arguments.length,r=Array(n),i=0;i<n;i++)r[i]=arguments[i];return R(this,e),this.tag=function(e){for(var n=arguments.length,r=Array(n>1?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];return"function"==typeof e?t.interimTag.bind(t,e):"string"==typeof e?t.transformEndResult(e):(e=e.map(t.transformString.bind(t)),t.transformEndResult(e.reduce(t.processSubstitutions.bind(t,r))))},r.length>0&&Array.isArray(r[0])&&(r=r[0]),this.transformers=r.map((function(e){return"function"==typeof e?e():e})),this.tag}return j(e,[{key:"interimTag",value:function(e,t){for(var n=arguments.length,r=Array(n>2?n-2:0),i=2;i<n;i++)r[i-2]=arguments[i];return this.tag(A,e.apply(void 0,[t].concat(r)))}},{key:"processSubstitutions",value:function(e,t,n){var r=this.transformSubstitution(e.shift(),t);return"".concat(t,r,n)}},{key:"transformString",value:function(e){return this.transformers.reduce((function(e,t){return t.onString?t.onString(e):e}),e)}},{key:"transformSubstitution",value:function(e,t){return this.transformers.reduce((function(e,n){return n.onSubstitution?n.onSubstitution(e,t):e}),e)}},{key:"transformEndResult",value:function(e){return this.transformers.reduce((function(e,t){return t.onEndResult?t.onEndResult(e):e}),e)}}]),e}();const F=O;var M={separator:"",conjunction:"",serial:!1};const D=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:M;return{onSubstitution:function(t,n){if(Array.isArray(t)){var r=t.length,i=e.separator,a=e.conjunction,s=e.serial,o=n.match(/(\n?[^\S\n]+)$/);if(t=o?t.join(i+o[1]):t.join(i+" "),a&&r>1){var l=t.lastIndexOf(i);t=t.slice(0,l)+(s?i:"")+" "+a+t.slice(l+1)}}return t}}};function k(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}const N=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"initial";return{onEndResult:function(t){if("initial"===e){var n=t.match(/^[^\S\n]*(?=\S)/gm),r=n&&Math.min.apply(Math,k(n.map((function(e){return e.length}))));if(r){var i=new RegExp("^.{"+r+"}","gm");return t.replace(i,"")}return t}if("all"===e)return t.replace(/^[^\S\n]+/gm,"");throw new Error("Unknown type: "+e)}}};const P=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return{onEndResult:function(t){if(""===e)return t.trim();if("start"===(e=e.toLowerCase())||"left"===e)return t.replace(/^\s*/,"");if("end"===e||"right"===e)return t.replace(/\s*$/,"");throw new Error("Side not supported: "+e)}}};new F(D({separator:","}),N,P);new F(D({separator:",",conjunction:"and"}),N,P);new F(D({separator:",",conjunction:"or"}),N,P);const q=function(e){return{onSubstitution:function(t,n){if(null==e||"string"!=typeof e)throw new Error("You need to specify a string character to split by.");return"string"==typeof t&&t.includes(e)&&(t=t.split(e)),t}}};var L=function(e){return null!=e&&!Number.isNaN(e)&&"boolean"!=typeof e};const K=function(){return{onSubstitution:function(e){return Array.isArray(e)?e.filter(L):L(e)?e:""}}};new F(q("\n"),K,D,N,P);const $=function(e,t){return{onSubstitution:function(n,r){if(null==e||null==t)throw new Error("replaceSubstitutionTransformer requires at least 2 arguments.");return null==n?n:n.toString().replace(e,t)}}};new F(q("\n"),D,N,P,$(/&/g,"&amp;"),$(/</g,"&lt;"),$(/>/g,"&gt;"),$(/"/g,"&quot;"),$(/'/g,"&#x27;"),$(/`/g,"&#x60;"));const V=function(e,t){return{onEndResult:function(n){if(null==e||null==t)throw new Error("replaceResultTransformer requires at least 2 arguments.");return n.replace(e,t)}}};new F(V(/(?:\n(?:\s*))+/g," "),P);new F(V(/(?:\n\s*)/g,""),P);new F(D({separator:","}),V(/(?:\s+)/g," "),P);new F(D({separator:",",conjunction:"or"}),V(/(?:\s+)/g," "),P);new F(D({separator:",",conjunction:"and"}),V(/(?:\s+)/g," "),P);new F(D,N,P);new F(D,V(/(?:\s+)/g," "),P);const Q=new F(N,P);const B=new F(N("all"),P);var W=n(50539),_=n.n(W),G=n(79149);const U=[{label:"fields",documentation:"Retrieves the specified fields from log events"},{label:"display",documentation:"Specifies which fields to display in the query results"},{label:"filter",documentation:"Filters the results of a query based on one or more conditions"},{label:"stats",documentation:"Calculates aggregate statistics based on the values of log fields"},{label:"sort",documentation:"Sorts the retrieved log events"},{label:"limit",documentation:"Specifies the number of log events returned by the query"},{label:"parse",documentation:"Extracts data from a log field, creating one or more ephemeral fields that you can process further in the query"}],H=[{label:"abs",detail:"abs(a)",documentation:"Absolute value."},{label:"ceil",detail:"ceil(a)",documentation:"Round to ceiling (the smallest integer that is greater than the value of a)."},{label:"floor",detail:"floor(a)",documentation:"Round to floor (the largest integer that is smaller than the value of a)."},{label:"greatest",detail:"greatest(a,b, ... z)",documentation:"Returns the largest value."},{label:"least",detail:"least(a, b, ... z)",documentation:"Returns the smallest value."},{label:"log",detail:"log(a)",documentation:"Natural logarithm."},{label:"sqrt",detail:"sqrt(a)",documentation:"Square root."}],J=[{label:"isempty",detail:"isempty(fieldname)",documentation:"Returns true if the field is missing or is an empty string."},{label:"isblank",detail:"isblank(fieldname)",documentation:"Returns true if the field is missing, an empty string, or contains only white space."},{label:"concat",detail:"concat(string1, string2, ... stringz)",documentation:"Concatenates the strings."},{label:"ltrim",detail:"ltrim(string) or ltrim(string1, string2)",documentation:"Remove white space from the left of the string. If the function has a second string argument, it removes the characters of string2 from the left of string1."},{label:"rtrim",detail:"rtrim(string) or rtrim(string1, string2)",documentation:"Remove white space from the right of the string. If the function has a second string argument, it removes the characters of string2 from the right of string1."},{label:"trim",detail:"trim(string) or trim(string1, string2)",documentation:"Remove white space from both ends of the string. If the function has a second string argument, it removes the characters of string2 from both sides of string1."},{label:"strlen",detail:"strlen(string)",documentation:"Returns the length of the string in Unicode code points."},{label:"toupper",detail:"toupper(string)",documentation:"Converts the string to uppercase."},{label:"tolower",detail:"tolower(string)",documentation:"Converts the string to lowercase."},{label:"substr",detail:"substr(string1, x), or substr(string1, x, y)",documentation:"Returns a substring from the index specified by the number argument to the end of the string. If the function has a second number argument, it contains the length of the substring to be retrieved."},{label:"replace",detail:"replace(string1, string2, string3)",documentation:"Replaces all instances of string2 in string1 with string3."},{label:"strcontains",detail:"strcontains(string1, string2)",documentation:"Returns 1 if string1 contains string2 and 0 otherwise."}],z=[{label:"bin",detail:"bin(period)",documentation:"Rounds the value of @timestamp to the given period and then truncates."},{label:"datefloor",detail:"datefloor(a, period)",documentation:"Truncates the timestamp to the given period."},{label:"dateceil",detail:"dateceil(a, period)",documentation:"Rounds up the timestamp to the given period and then truncates."},{label:"fromMillis",detail:"fromMillis(fieldname)",documentation:"Interprets the input field as the number of milliseconds since the Unix epoch and converts it to a timestamp."},{label:"toMillis",detail:"toMillis(fieldname)",documentation:"Converts the timestamp found in the named field into a number representing the milliseconds since the Unix epoch."}],X=[{label:"isValidIp",detail:"isValidIp(fieldname)",documentation:"Returns true if the field is a valid v4 or v6 IP address."},{label:"isValidIpV4",detail:"isValidIpV4(fieldname)",documentation:"Returns true if the field is a valid v4 IP address."},{label:"isValidIpV6",detail:"isValidIpV6(fieldname)",documentation:"Returns true if the field is a valid v6 IP address."},{label:"isIpInSubnet",detail:"isIpInSubnet(fieldname, string)",documentation:"Returns true if the field is a valid v4 or v6 IP address within the specified v4 or v6 subnet."},{label:"isIpv4InSubnet",detail:"isIpv4InSubnet(fieldname, string)",documentation:"Returns true if the field is a valid v4 IP address within the specified v4 subnet."},{label:"isIpv6InSubnet",detail:"isIpv6InSubnet(fieldname, string)",documentation:"Returns true if the field is a valid v6 IP address within the specified v6 subnet."}],Y=[{label:"ispresent",detail:"ispresent(fieldname)",documentation:"Returns true if the field exists."},{label:"isempty",detail:"isempty(fieldname)",documentation:"Returns true if the field is missing or is an empty string."},{label:"isblank",detail:"isblank(fieldname)",documentation:"Returns true if the field is missing, an empty string, or contains only white space."},{label:"strcontains",detail:"strcontains(string1, string2)",documentation:"Returns 1 if string1 contains string2 and 0 otherwise."},...X],Z=[{label:"avg",detail:"avg(NumericFieldname)",documentation:"The average of the values in the specified field."},{label:"count",detail:"count(fieldname) or count(*)",documentation:"Counts the log records."},{label:"count_distinct",detail:"count_distinct(fieldname)",documentation:"Returns the number of unique values for the field."},{label:"max",detail:"max(fieldname)",documentation:"The maximum of the values for this log field in the queried logs."},{label:"min",detail:"min(fieldname)",documentation:"The minimum of the values for this log field in the queried logs."},{label:"pct",detail:"pct(fieldname, value)",documentation:"A percentile indicates the relative standing of a value in a datas."},{label:"stddev",detail:"stddev(NumericFieldname)",documentation:"The standard deviation of the values in the specified field."},{label:"sum",detail:"sum(NumericFieldname)",documentation:"The sum of the values in the specified field."}],ee=[...Z,{label:"earliest",detail:"earliest(fieldname)",documentation:"Returns the value of fieldName from the log event that has the earliest time stamp in the queried logs."},{label:"latest",detail:"latest(fieldname)",documentation:"Returns the value of fieldName from the log event that has the latest time stamp in the queried logs."},{label:"sortsFirst",detail:"sortsFirst(fieldname)",documentation:"Returns the value of fieldName that sorts first in the queried logs."},{label:"sortsLast",detail:"sortsLast(fieldname)",documentation:"Returns the value of fieldName that sorts last in the queried logs."}],te=[...H,{label:"ispresent",detail:"ispresent(fieldname)",documentation:"Returns true if the field exists."},{label:"coalesce",detail:"coalesce(fieldname1, fieldname2, ... fieldnamex)",documentation:"Returns the first non-null value from the list."},...J,...z,...X],ne=[...te,...ee],re={comment:{pattern:/^#.*/,greedy:!0},backticks:{pattern:/`.*?`/,alias:"string",greedy:!0},quote:{pattern:/".*?"/,alias:"string",greedy:!0},regex:{pattern:/\/.*?\/(?=\||\s*$|,)/,greedy:!0},"query-command":{pattern:new RegExp(`\\b(?:${U.map((e=>e.label)).join("|")})\\b`,"i"),alias:"function"},function:{pattern:new RegExp(`\\b(?:${ne.map((e=>e.label)).join("|")})\\b`,"i")},keyword:{pattern:new RegExp(`(\\s+)(${["as","like","by","in","desc","asc"].join("|")})(?=\\s+)`,"i"),lookbehind:!0},"field-name":{pattern:/(@?[_a-zA-Z]+[_.0-9a-zA-Z]*)|(`((\\`)|([^`]))*?`)/,greedy:!0},number:/\b-?\d+((\.\d*)?([eE][+-]?\d+)?)?\b/,"command-separator":{pattern:/\|/,alias:"punctuation"},"comparison-operator":{pattern:/([<>]=?)|(!?=)/},punctuation:/[{}()`,.]/,whitespace:/\s+/};var ie,ae;const se=[{category:"Lambda",examples:[{title:"View latency statistics for 5-minute intervals",expr:B`filter @type = "REPORT" |
                           stats avg(@duration), max(@duration), min(@duration) by bin(5m)`},{title:"Determine the amount of overprovisioned memory",expr:Q`
        filter @type = "REPORT" |
        stats max(@memorySize / 1024 / 1024) as provisonedMemoryMB,
              min(@maxMemoryUsed / 1024 / 1024) as smallestMemoryRequestMB,
              avg(@maxMemoryUsed / 1024 / 1024) as avgMemoryUsedMB,
              max(@maxMemoryUsed / 1024 / 1024) as maxMemoryUsedMB,
              provisonedMemoryMB - maxMemoryUsedMB as overProvisionedMB`},{title:"Find the most expensive requests",expr:B`filter @type = "REPORT" |
                           fields @requestId, @billedDuration |
                           sort by @billedDuration desc`}]},{category:"VPC Flow Logs",examples:[{title:"Average, min, and max byte transfers by source and destination IP addresses",expr:"stats avg(bytes), min(bytes), max(bytes) by srcAddr, dstAddr"},{title:"IP addresses using UDP transfer protocol",expr:"filter protocol=17 | stats count(*) by srcAddr"},{title:"Top 10 byte transfers by source and destination IP addresses",expr:B`stats sum(bytes) as bytesTransferred by srcAddr, dstAddr |
                           sort bytesTransferred desc |
                           limit 10`},{title:"Top 20 source IP addresses with highest number of rejected requests",expr:B`filter action="REJECT" |
                           stats count(*) as numRejections by srcAddr |
                           sort numRejections desc |
                           limit 20`}]},{category:"CloudTrail",examples:[{title:"Number of log entries by service, event type, and region",expr:"stats count(*) by eventSource, eventName, awsRegion"},{title:"Number of log entries by region and EC2 event type",expr:B`filter eventSource="ec2.amazonaws.com" |
                           stats count(*) as eventCount by eventName, awsRegion |
                           sort eventCount desc`},{title:"Regions, usernames, and ARNs of newly created IAM users",expr:B`filter eventName="CreateUser" |
                           fields awsRegion, requestParameters.userName, responseElements.user.arn`}]},{category:"Common Queries",examples:[{title:"25 most recently added log events",expr:B`fields @timestamp, @message |
                           sort @timestamp desc |
                           limit 25`},{title:"Number of exceptions logged every 5 minutes",expr:B`filter @message like /Exception/ |
                           stats count(*) as exceptionCount by bin(5m) |
                           sort exceptionCount desc`},{title:"List of log events that are not exceptions",expr:"fields @message | filter @message not like /Exception/"}]},{category:"Route 53",examples:[{title:"Number of requests received every 10  minutes by edge location",expr:"stats count(*) by queryType, bin(10m)"},{title:"Number of unsuccessful requests by domain",expr:'filter responseCode="SERVFAIL" | stats count(*) by queryName'},{title:"Number of requests received every 10  minutes by edge location",expr:"stats count(*) as numRequests by resolverIp | sort numRequests desc | limit 10"}]},{category:"AWS AppSync",examples:[{title:"Number of unique HTTP status codes",expr:B`fields ispresent(graphQLAPIId) as isApi |
                           filter isApi |
                           filter logType = "RequestSummary" |
                           stats count() as statusCount by statusCode |
                           sort statusCount desc`},{title:"Top 10 resolvers with maximum latency",expr:B`fields resolverArn, duration |
                           filter logType = "Tracing" |
                           sort duration desc |
                           limit 10`},{title:"Most frequently invoked resolvers",expr:B`fields ispresent(resolverArn) as isRes |
                           stats count() as invocationCount by resolverArn |
                           filter isRes |
                           filter logType = "Tracing" |
                           sort invocationCount desc |
                           limit 10`},{title:"Resolvers with most errors in mapping templates",expr:B`fields ispresent(resolverArn) as isRes |
                           stats count() as errorCount by resolverArn, logType |
                           filter isRes and (logType = "RequestMapping" or logType = "ResponseMapping") and fieldInError |
                           sort errorCount desc |
                           limit 10`},{title:"Field latency statistics",expr:B`fields requestId, latency |
                           filter logType = "RequestSummary" |
                           sort latency desc |
                           limit 10`},{title:"Resolver latency statistics",expr:B`fields ispresent(resolverArn) as isRes |
                           filter isRes |
                           filter logType = "Tracing" |
                           stats min(duration), max(duration), avg(duration) as avgDur by resolverArn |
                           sort avgDur desc |
                           limit 10`},{title:"Top 10 requests with maximum latency",expr:B`fields requestId, latency |
                           filter logType = "RequestSummary" |
                           sort latency desc |
                           limit 10`}]}];function oe(e,t){const n=re,r=(0,G.a)(_().tokenize(e,n)).filter((e=>"string"!=typeof e)).map(((e,n)=>(0,f.jsx)("span",{className:`prism-token token ${e.types.join(" ")} ${e.aliases.join(" ")}`,children:e.content},`${t}-token-${n}`)));return(0,f.jsx)("div",{className:"slate-query-field",children:r})}const le=x.css`
  margin-top: 5px;
`;class ue extends i.PureComponent{onClickExample(e){this.props.onClickExample(e)}renderExpression(e,t){return(0,f.jsx)("div",{className:"cheat-sheet-item__example",onClick:()=>{var t,n;return this.onClickExample({refId:null!==(t=this.props.query.refId)&&void 0!==t?t:"A",expression:e,queryMode:"Logs",region:this.props.query.region,id:null!==(n=this.props.query.refId)&&void 0!==n?n:"A",logGroupNames:"logGroupNames"in this.props.query?this.props.query.logGroupNames:[]})},children:(0,f.jsx)("pre",{children:oe(e,t)})},e)}renderLogsCheatSheet(){return(0,f.jsxs)("div",{children:[ie||(ie=(0,f.jsx)("h2",{children:"CloudWatch Logs Cheat Sheet"})),se.map(((e,t)=>(0,f.jsxs)("div",{children:[(0,f.jsx)("div",{className:`cheat-sheet-item__title ${(0,x.cx)(le)}`,children:e.category}),e.examples.map(((e,t)=>(0,f.jsxs)("div",{className:"cheat-sheet-item",children:[(0,f.jsx)("h4",{children:e.title}),this.renderExpression(e.expr,`item-${t}`)]},`item-${t}`)))]},`${e.category}-${t}`)))]})}render(){return(0,f.jsxs)("div",{children:[ae||(ae=(0,f.jsx)("h3",{children:"CloudWatch Logs cheat sheet"})),se.map(((e,t)=>(0,f.jsxs)("div",{children:[(0,f.jsx)("div",{className:`cheat-sheet-item__title ${(0,x.cx)(le)}`,children:e.category}),e.examples.map(((e,t)=>(0,f.jsxs)("div",{className:"cheat-sheet-item",children:[(0,f.jsx)("h4",{children:e.title}),this.renderExpression(e.expr,`item-${t}`)]},`item-${t}`)))]},`cat-${t}`)))]})}}var ce;const de=e=>"Logs"===e.queryMode,pe=e=>"Metrics"===e.queryMode||!e.hasOwnProperty("queryMode"),me=e=>"Annotations"===e.queryMode;var he=n(8072),ge=n(80027);const fe={value:"*",label:"*"},ve=e=>{let{filter:t,metricStat:{region:n,namespace:a,metricName:s,dimensions:o},datasource:u,dimensionKeys:c,disableExpressions:d,onChange:p,onDelete:m}=e;const h=(0,i.useMemo)((()=>((e,t)=>Object.entries(null!=e?e:{}).reduce(((e,n)=>{let[r,i]=n;return r!==t?Object.assign({},e,{[r]:i}):e}),{}))(null!=o?o:{},t.key)),[o,t]),[v,y]=(0,ge.Z)((async()=>t.key?u.getDimensionValues(n,a,s,t.key,h).then((e=>(e.length&&!d&&e.unshift(fe),g(u,e)))):[]),[t.key,o]),b=(0,l.useTheme2)(),S=ye(b);return(0,f.jsx)("div",{"data-testid":"cloudwatch-dimensions-filter-item",children:(0,f.jsxs)(he.InputGroup,{children:[(0,f.jsx)(l.Select,{"aria-label":"Dimensions filter key",inputId:"cloudwatch-dimensions-filter-item-key",width:"auto",value:t.key?(0,r.toOption)(t.key):null,allowCustomValue:!0,options:c,onChange:e=>{e.label&&p({key:e.label,value:void 0})}}),(0,f.jsx)("span",{className:(0,x.cx)(S.root),children:"="}),(0,f.jsx)(l.Select,{"aria-label":"Dimensions filter value",inputId:"cloudwatch-dimensions-filter-item-value",onOpenMenu:y,width:"auto",value:t.value?(0,r.toOption)(t.value):null,allowCustomValue:!0,isLoading:v.loading,options:v.value,onChange:e=>{e.value&&p(Object.assign({},t,{value:e.value}))}}),(0,f.jsx)(he.AccessoryButton,{"aria-label":"remove",icon:"times",variant:"secondary",onClick:m,type:"button"})]})})},ye=(0,l.stylesFactory)((e=>({root:(0,x.css)({padding:e.spacing(0,1),alignSelf:"center"})}))),be=e=>{let{metricStat:t,datasource:n,dimensionKeys:r,disableExpressions:a,onChange:s}=e;const o=(0,i.useMemo)((()=>{return e=t.dimensions,Object.entries(null!=e?e:{}).reduce(((e,t)=>{let[n,r]=t;if(r&&"string"==typeof r){const t={key:n,value:r,operator:"="};return[...e,t]}return e}),[]);var e}),[t.dimensions]),[l,u]=(0,i.useState)(o);return(0,f.jsx)(he.EditorList,{items:l,onChange:e=>{u(e);const n=e.reduce(((e,t)=>{let{key:n,value:r}=t;return n&&r?Object.assign({},e,{[n]:r}):e}),{});(0,m.isEqual)(n,t.dimensions)||s(n)},renderItem:xe(n,t,r,a)})};function xe(e,t,n,r){return function(i,a,s){return(0,f.jsx)(ve,{filter:i,onChange:e=>a(e),datasource:e,metricStat:t,disableExpressions:r,dimensionKeys:n,onDelete:s})}}const Se=n(36993);function we(e,t){return`https://${t}.console.aws.amazon.com/cloudwatch/home?region=${t}#logs-insights:queryDetail=${Se.stringify(e)}`}var Ce;class Ie extends i.Component{constructor(){var e,t,n;super(...arguments),n={href:""},(t="state")in(e=this)?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n}async componentDidUpdate(e){const{panelData:t}=this.props,{panelData:n}=e;if(n!==t&&null!=t&&t.request){const e=this.getExternalLink();this.setState({href:e})}}getExternalLink(){var e,t,n;const{query:r,panelData:i,datasource:a}=this.props,s=null==i||null===(e=i.request)||void 0===e?void 0:e.range;if(!s)return"";const o=s.from.toISOString();return we({end:s.to.toISOString(),start:o,timeType:"ABSOLUTE",tz:"UTC",editorString:null!==(t=r.expression)&&void 0!==t?t:"",isLiveTail:!1,source:null!==(n=r.logGroupNames)&&void 0!==n?n:[]},a.getActualRegion(r.region))}render(){const{href:e}=this.state;return(0,f.jsxs)("a",{href:e,target:"_blank",rel:"noopener noreferrer",children:[Ce||(Ce=(0,f.jsx)(l.Icon,{name:"share-alt"}))," CloudWatch Logs Insights"]})}}const Ee=/\s+by\s+/im,Te=/([\w$@().]+)(?:(\s+as\s+)([\w$]+))?\s*,?\s*/iy;function je(e){let t,n=[];if(t=e.match(Ee)){let r;for(Te.lastIndex=t.index+t[0].length;r=Te.exec(e);)n.push(r[2]?r[3]:r[1]),Te.lastIndex=r.index+r[0].length}return n}const Ae=function(e,t,n){var r=(0,i.useRef)(void 0);r.current&&n(t,r.current)||(r.current=t),(0,i.useEffect)(e,r.current)};var Re=n(48322);const Oe=n.n(Re)();const Fe=function(e,t){Ae(e,t,Oe)},Me=e=>{const[t,n]=(0,i.useState)(!1),[a,s]=(0,i.useState)([{label:"default",value:"default"}]);return(0,i.useEffect)((()=>{n(!0);const t={label:"Template Variables",options:e.getVariables().map(r.toOption)};e.getRegions().then((e=>s([...e,t]))).finally((()=>n(!1)))}),[e]),[a,t]},De=e=>{const[t,n]=(0,i.useState)([]);return(0,i.useEffect)((()=>{e.getNamespaces().then((t=>{n(g(e,t))}))}),[e]),t},ke=(e,t,n)=>{const[r,a]=(0,i.useState)([]);return(0,i.useEffect)((()=>{e.getMetrics(n,t).then((t=>{a(g(e,t))}))}),[e,t,n]),r},Ne=(e,t,n,r,a)=>{const[s,o]=(0,i.useState)([]);return Fe((()=>{e.getDimensionKeys(n,t,a,r).then((t=>{o(g(e,t))}))}),[e,t,n,r,a]),s};var Pe,qe=n(93889);const Le=[{label:"Metric Search",value:qe.$5.Search},{label:"Metric Query",value:qe.$5.Query}],Ke=[{label:"Builder",value:qe.MQ.Builder},{label:"Code",value:qe.MQ.Code}],$e=e=>{let{query:t,sqlCodeEditorIsDirty:n,onChange:r,onRunQuery:a}=e;const{metricEditorMode:s,metricQueryType:o}=t,[u,c]=(0,i.useState)(!1),d=(0,i.useCallback)((e=>{n&&o===qe.$5.Query&&s===qe.MQ.Code?c(!0):r(Object.assign({},t,{metricEditorMode:e}))}),[c,r,n,t,s,o]);return(0,f.jsxs)(f.Fragment,{children:[(0,f.jsx)(he.InlineSelect,{"aria-label":"Metric editor mode",value:Le.find((e=>e.value===o)),options:Le,onChange:e=>{let{value:n}=e;r(Object.assign({},t,{metricQueryType:n}))}}),Pe||(Pe=(0,f.jsx)(he.FlexItem,{grow:1})),(0,f.jsx)(l.RadioButtonGroup,{options:Ke,size:"sm",value:s,onChange:d}),t.metricQueryType===qe.$5.Query&&t.metricEditorMode===qe.MQ.Code&&(0,f.jsx)(l.Button,{variant:"secondary",size:"sm",onClick:()=>a(),children:"Run query"}),(0,f.jsx)(l.ConfirmModal,{isOpen:u,title:"Are you sure?",body:"You will lose manual changes done to the query if you go back to the visual builder.",confirmText:"Yes, I am sure.",dismissText:"No, continue editing the query manually.",icon:"exclamation-triangle",onConfirm:()=>{c(!1),r(Object.assign({},t,{metricEditorMode:qe.MQ.Builder}))},onDismiss:()=>c(!1)})]})},Ve=[{label:"CloudWatch Metrics",value:"Metrics"},{label:"CloudWatch Logs",value:"Logs"}],Qe=e=>{let{query:t,sqlCodeEditorIsDirty:n,datasource:i,onChange:a,onRunQuery:s}=e;const{queryMode:o,region:l}=t,[u,c]=Me(i);return(0,f.jsxs)(he.EditorHeader,{children:[(0,f.jsx)(he.InlineSelect,{label:"Region",value:l,placeholder:"Select region",allowCustomValue:!0,onChange:e=>{let{value:n}=e;return n&&(async e=>{let{value:n}=e;a(Object.assign({},t,{region:n}))})({value:n})},options:u,isLoading:c}),(0,f.jsx)(he.InlineSelect,{"aria-label":"Query mode",value:o,options:Ve,onChange:e=>{let{value:n}=e;if(n!==o){const e=(0,m.pick)(t,"id","region","namespace","refId","hide","key","queryType","datasource");a(Object.assign({},e,{queryMode:n}))}}}),o===r.ExploreMode.Metrics&&(0,f.jsx)($e,{query:t,datasource:i,onChange:a,onRunQuery:s,sqlCodeEditorIsDirty:n})]})};function Be(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}const We=x.css`
  gap: 3px;
`;class _e extends i.PureComponent{constructor(e,t){super(e,t),Be(this,"state",{hint:void 0}),Be(this,"plugins",void 0),Be(this,"componentDidMount",(()=>{const{query:e,datasource:t,onChange:n}=this.props;var r;n&&n(Object.assign({},e,{logGroupNames:null!==(r=e.logGroupNames)&&void 0!==r?r:t.defaultLogGroups}))})),Be(this,"onChangeQuery",(e=>{const{query:t,onChange:n}=this.props;if(n){n(Object.assign({},t,{expression:e,statsGroups:je(e)}))}})),Be(this,"onTypeahead",(async e=>{const{datasource:t,query:n}=this.props,{logGroupNames:r}=n;if(!t.languageProvider)return{suggestions:[]};const i=t.languageProvider,{history:a,absoluteRange:s}=this.props,{prefix:o,text:l,value:u,wrapperClasses:c,labelKey:d,editor:p}=e;return await i.provideCompletionItems({text:l,value:u,prefix:o,wrapperClasses:c,labelKey:d,editor:p},{history:a,absoluteRange:s,logGroupNames:r,region:n.region})})),this.plugins=[(0,l.BracesPlugin)(),(0,l.SlatePrism)({onlyIn:e=>"block"===e.object&&"code_block"===e.type,getSyntax:e=>"cloudwatch"},Object.assign({},W.languages,{cloudwatch:re}))]}render(){var e;const{onRunQuery:t,onChange:n,ExtraFieldElement:r,data:i,query:a,datasource:s}=this.props,{region:o,refId:u,expression:c,logGroupNames:d}=a,{hint:p}=this.state,m=i&&i.error&&i.error.refId===a.refId,h=s.languageProvider?s.languageProvider.cleanText:void 0;return(0,f.jsxs)(f.Fragment,{children:[(0,f.jsx)(Qe,{query:a,onRunQuery:t,datasource:s,onChange:n,sqlCodeEditorIsDirty:!1}),(0,f.jsx)("div",{className:`gf-form gf-form--grow flex-grow-1 ${We}`,children:(0,f.jsx)(l.LegacyForms.FormField,{label:"Log Groups",labelWidth:6,className:"flex-grow-1",inputEl:(0,f.jsx)(v,{region:o,selectedLogGroups:null!=d?d:s.defaultLogGroups,datasource:s,onChange:function(e){n(Object.assign({},a,{logGroupNames:e}))},onRunQuery:t,refId:u})})}),(0,f.jsxs)("div",{className:"gf-form-inline gf-form-inline--nowrap flex-grow-1",children:[(0,f.jsx)("div",{className:"gf-form gf-form--grow flex-shrink-1",children:(0,f.jsx)(l.QueryField,{additionalPlugins:this.plugins,query:null!=c?c:"",onChange:this.onChangeQuery,onRunQuery:this.props.onRunQuery,onTypeahead:this.onTypeahead,cleanText:h,placeholder:"Enter a CloudWatch Logs Insights query (run with Shift+Enter)",portalOrigin:"cloudwatch",disabled:!d||0===d.length})}),r]}),p&&(0,f.jsx)("div",{className:"query-row-break",children:(0,f.jsxs)("div",{className:"text-warning",children:[p.message,(0,f.jsx)("a",{className:"text-link muted",onClick:p.fix.action,children:p.fix.label})]})}),m?(0,f.jsx)("div",{className:"query-row-break",children:(0,f.jsx)("div",{className:"prom-query-field-info text-error",children:null==i||null===(e=i.error)||void 0===e?void 0:e.message})}):null]})}}const Ge=x.css`
  margin-left: 3px;
  flex-grow: 0;
`,Ue=(0,i.memo)((function(e){var t,n;const{query:r,data:i,datasource:a,onRunQuery:s,onChange:o,exploreId:u}=e;let c;if(null!=i&&null!==(t=i.request)&&void 0!==t&&null!==(n=t.range)&&void 0!==n&&n.from){const{range:e}=i.request;c={from:e.from.valueOf(),to:e.to.valueOf()}}else c={from:Date.now()-1e4,to:Date.now()};return(0,f.jsx)(_e,{exploreId:u,datasource:a,query:r,onChange:o,onRunQuery:s,history:[],data:i,absoluteRange:c,ExtraFieldElement:(0,f.jsx)(l.InlineFormLabel,{className:`gf-form-label--btn ${Ge}`,width:"auto",tooltip:"Link to Graph in AWS",children:(0,f.jsx)(Ie,{query:r,panelData:i,datasource:a})})})}));function He(e){var t;let{refId:n,metricStat:r,datasource:i,disableExpressions:a=!1,onChange:s,onRunQuery:o}=e;const{region:u,namespace:c,metricName:d,dimensions:p}=r,m=De(i),v=ke(i,u,c),y=Ne(i,u,c,d,null!=p?p:{}),b=e=>{s(e),o()},x=async e=>{let{metricName:t,namespace:n,region:r}=e;return t?(await i.getMetrics(n,r).then((e=>{e.find((e=>e.value===t))||(t="")})),Object.assign({},e,{metricName:t})):e};return(0,f.jsxs)(he.EditorRows,{children:[(0,f.jsx)(he.EditorRow,{children:(0,f.jsxs)(he.EditorFieldGroup,{children:[(0,f.jsx)(he.EditorField,{label:"Namespace",width:26,children:(0,f.jsx)(l.Select,{"aria-label":"Namespace",value:(null==r?void 0:r.namespace)&&h(r.namespace),allowCustomValue:!0,options:m,onChange:e=>{let{value:t}=e;t&&(async e=>{const t=await x(e);b(t)})(Object.assign({},r,{namespace:t}))}})}),(0,f.jsx)(he.EditorField,{label:"Metric name",width:16,children:(0,f.jsx)(l.Select,{"aria-label":"Metric name",value:(null==r?void 0:r.metricName)&&h(r.metricName),allowCustomValue:!0,options:v,onChange:e=>{let{value:t}=e;t&&b(Object.assign({},r,{metricName:t}))}})}),(0,f.jsx)(he.EditorField,{label:"Statistic",width:16,children:(0,f.jsx)(l.Select,{inputId:`${n}-metric-stat-editor-select-statistic`,allowCustomValue:!0,value:h(null!==(t=r.statistic)&&void 0!==t?t:i.standardStatistics[0]),options:g(i,i.standardStatistics.filter((e=>e!==r.statistic)).map(h)),onChange:e=>{let{value:t}=e;t&&(i.standardStatistics.includes(t)||/^p\d{2}(?:\.\d{1,2})?$/.test(t)||t.startsWith("$"))&&b(Object.assign({},r,{statistic:t}))}})})]})}),(0,f.jsx)(he.EditorRow,{children:(0,f.jsx)(he.EditorField,{label:"Dimensions",children:(0,f.jsx)(be,{metricStat:r,onChange:e=>b(Object.assign({},r,{dimensions:e})),dimensionKeys:y,disableExpressions:a,datasource:i})})}),!a&&(0,f.jsx)(he.EditorRow,{children:(0,f.jsx)(he.EditorField,{label:"Match exact",optional:!0,tooltip:"Only show metrics that exactly match all defined dimension names.",children:(0,f.jsx)(he.EditorSwitch,{id:`${n}-cloudwatch-match-exact`,value:!!r.matchExact,onChange:e=>{b(Object.assign({},r,{matchExact:e.currentTarget.checked}))}})})})]})}var Je=n(7166);let ze,Xe;!function(e){e.String="string"}(ze||(ze={})),function(e){e.Property="property",e.Operator="operator",e.Or="or",e.And="and",e.GroupBy="groupBy",e.Function="function",e.FunctionParameter="functionParameter"}(Xe||(Xe={}));class Ye{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,Je.J)();this.templateSrv=e}expressionToSqlQuery(e){var t,n,r;let{select:i,from:a,where:s,groupBy:o,orderBy:l,orderByDirection:u,limit:c}=e;if(!a||null==i||!i.name||null==i||null===(t=i.parameters)||void 0===t||!t.length)return;let d=[];return this.appendSelect(i,d),this.appendFrom(a,d),this.appendWhere(s,d,!0,null!==(n=null==s||null===(r=s.expressions)||void 0===r?void 0:r.length)&&void 0!==n?n:0),this.appendGroupBy(o,d),this.appendOrderBy(l,u,d),this.appendLimit(c,d),d.join(" ")}appendSelect(e,t){t.push("SELECT"),this.appendFunction(e,t)}appendFrom(e,t){var n,r;t.push("FROM"),(null==e?void 0:e.type)===Xe.Function?this.appendFunction(e,t):t.push(this.formatValue(null!==(n=null==e||null===(r=e.property)||void 0===r?void 0:r.name)&&void 0!==n?n:""))}appendWhere(e,t,n,r){if(!e)return;const i="expressions"in e&&e.expressions.length>0;if(n&&i&&t.push("WHERE"),e.type===Xe.And){const i=[];if(e.expressions.map((e=>this.appendWhere(e,i,!1,r))),0===i.length)return;const a=i.join(" AND "),s=!n&&r>1&&i.length>1;return t.push(s?`(${a})`:a)}if(e.type!==Xe.Or)return e.type===Xe.Operator?this.appendOperator(e,t):void 0;{const i=[];if(e.expressions.map((e=>this.appendWhere(e,i,!1,r))),0===i.length)return;const a=i.join(" OR "),s=!n&&r>1&&i.length>1;t.push(s?`(${a})`:a)}}appendGroupBy(e,t){const n=[];for(const t of null!==(r=null==e?void 0:e.expressions)&&void 0!==r?r:[]){var r;(null==t?void 0:t.type)===Xe.GroupBy&&t.property.name&&n.push(this.formatValue(t.property.name))}n.length>0&&t.push(`GROUP BY ${n.join(", ")}`)}appendOrderBy(e,t,n){e&&(n.push("ORDER BY"),this.appendFunction(e,n),n.push(null!=t?t:"ASC"))}appendLimit(e,t){e&&t.push(`LIMIT ${e}`)}appendOperator(e,t,n){const{property:r,operator:i}=e;r.name&&i.name&&i.value&&t.push(`${this.formatValue(r.name)} ${i.name} '${i.value}'`)}appendFunction(e,t){var n;if(null==e||!e.name)return;const r=(null!==(n=e.parameters)&&void 0!==n?n:[]).map((e=>e.name&&this.formatValue(e.name))).filter(Boolean).join(", ");t.push(`${e.name}(${r})`)}formatValue(e){const t=this.templateSrv.replace(e,{},"raw");return/[/\s\.-]/.test(t)?`"${e}"`:e}}var Ze=n(1762);function et(e){var t;return null==e||null===(t=e.parameters)||void 0===t?void 0:t[0].name}function tt(e){return(null==e?void 0:e.type)===Xe.Property?e.property.name:(null==e?void 0:e.type)===Xe.Function?null===(t=e.parameters)||void 0===t?void 0:t[0].name:void 0;var t}function nt(e){var t,n,r;const i=null===(t=e.property)||void 0===t?void 0:t.name,a=null===(n=e.operator)||void 0===n?void 0:n.value,s=null===(r=e.operator)||void 0===r?void 0:r.name;if(i&&a&&s)return{type:Xe.Operator,property:{type:ze.String,name:i},operator:{value:a,name:s}}}function rt(e){return e.flatMap((e=>e.type===Xe.Operator?e:e.type===Xe.And||e.type===Xe.Or?rt(e.expressions):[]))}function it(e){var t;const n=e.where;return rt(null!==(t=null==n?void 0:n.expressions)&&void 0!==t?t:[])}function at(e){var t;const n=e.groupBy;return(null!==(t=null==n?void 0:n.expressions)&&void 0!==t?t:[]).flatMap((e=>e.type===Xe.GroupBy?e:[]))}function st(e,t){var n;return Object.assign({},e,{sql:Object.assign({},null!==(n=e.sql)&&void 0!==n?n:{},t)})}function ot(e,t){var n,r;return st(e,{select:Object.assign({type:Xe.Function},null!==(n=null===(r=e.sql)||void 0===r?void 0:r.select)&&void 0!==n?n:{},{name:t})})}const lt=Ze.STATISTICS.map(r.toOption),ut=e=>{var t,n;let{datasource:a,query:s,onQueryChange:o}=e;const u=null!==(t=s.sql)&&void 0!==t?t:{},c=null===(n=u.select)||void 0===n?void 0:n.name;(0,i.useEffect)((()=>{c||o(ot(s,Ze.STATISTICS[0]))}),[c,o,s]);const d=et(u.select),p=tt(u.from),m=function(e){var t;if((null==e?void 0:e.type)===Xe.Function&&null!=e&&null!==(t=e.parameters)&&void 0!==t&&t.length){var n;return(null==e||null===(n=e.parameters)||void 0===n?void 0:n.length)<=1?[]:(null==e?void 0:e.parameters.slice(1)).reduce(((e,t)=>t.name?[...e,t.name]:e),[])}}(u.from),h=(null==(v=u.from)?void 0:v.type)===Xe.Function&&v.name===Ze.SCHEMA;var v;const y=De(a),b=ke(a,s.region,p),x=(0,i.useMemo)((()=>(null!=m?m:[]).reduce(((e,t)=>t?Object.assign({},e,{[t]:null}):e),{})),[m]),S=Ne(a,s.region,p,d,x),w=(0,i.useMemo)((()=>null!=m&&m.length?[...S,...m.map(r.toOption)]:S),[S,m]),C=async e=>{let{region:t,sql:n}=e;return await a.getMetrics(e.namespace,t).then((t=>{t.some((e=>e.value===d))||(n=function(e){var t,n;const r=Object.assign({},e);return null===(t=r.sql)||void 0===t||null===(n=t.select)||void 0===n||delete n.parameters,r}(e).sql)})),Object.assign({},e,{sql:n})};return(0,f.jsxs)(f.Fragment,{children:[(0,f.jsxs)(he.EditorFieldGroup,{children:[(0,f.jsx)(he.EditorField,{label:"Namespace",width:16,children:(0,f.jsx)(l.Select,{"aria-label":"Namespace",value:p?(0,r.toOption)(p):null,inputId:`${s.refId}-cloudwatch-sql-namespace`,options:y,allowCustomValue:!0,onChange:e=>{let{value:t}=e;return t&&(async e=>{const t=await C(e);o(t)})(function(e,t){var n;const r=null!==(n=e.sql)&&void 0!==n?n:{};if(e.namespace=t||"",void 0===t)return st(e,{from:void 0});if(!r.from||r.from.type===Xe.Property)return st(e,{from:{type:Xe.Property,property:{type:ze.String,name:t}}});if(r.from.type===Xe.Function){var i;const n={type:Xe.FunctionParameter,name:t},a=(null!==(i=r.from.parameters)&&void 0!==i?i:[]).slice(1);return st(e,{from:{type:Xe.Function,name:Ze.SCHEMA,parameters:[n,...a]}})}return e}(s,t))}})}),(0,f.jsx)(he.EditorField,{label:"With schema",children:(0,f.jsx)(he.EditorSwitch,{id:`${s.refId}-cloudwatch-sql-withSchema`,value:h,onChange:e=>e.target instanceof HTMLInputElement&&o(function(e,t){var n;const r=tt((null!==(n=e.sql)&&void 0!==n?n:{}).from);if(t){const t={type:Xe.FunctionParameter,name:r};return st(e,{from:{type:Xe.Function,name:Ze.SCHEMA,parameters:[t]}})}return st(e,{from:{type:Xe.Property,property:{type:ze.String,name:r}}})}(s,e.target.checked))})}),h&&(0,f.jsx)(he.EditorField,{label:"Schema labels",disabled:!p,children:(0,f.jsx)(l.Select,{id:`${s.refId}-cloudwatch-sql-schema-label-keys`,width:"auto",isMulti:!0,value:m?m.map(r.toOption):null,options:w,allowCustomValue:!0,onChange:e=>e&&o(function(e,t){var n,r,i;const a=null!==(n=e.sql)&&void 0!==n?n:{};if(t=Array.isArray(t)?t.map((e=>e.value)):[t.value],(null===(r=a.from)||void 0===r?void 0:r.type)===Xe.Function&&null!==(i=a.from.parameters)&&void 0!==i&&i.length){var s,o;const n=(null!==(s=t)&&void 0!==s?s:[]).map((e=>({type:Xe.FunctionParameter,name:e}))),r=(null!==(o=a.from.parameters)&&void 0!==o?o:[])[0];return st(e,{from:{type:Xe.Function,name:Ze.SCHEMA,parameters:[r,...n]}})}return e}(s,e))})})]}),(0,f.jsxs)(he.EditorFieldGroup,{children:[(0,f.jsx)(he.EditorField,{label:"Metric name",width:16,children:(0,f.jsx)(l.Select,{"aria-label":"Metric name",value:d?(0,r.toOption)(d):null,options:b,allowCustomValue:!0,onChange:e=>{let{value:t}=e;return t&&o(function(e,t){var n,r;const i={type:Xe.FunctionParameter,name:t};return st(e,{select:Object.assign({type:Xe.Function},null!==(n=null===(r=e.sql)||void 0===r?void 0:r.select)&&void 0!==n?n:{},{parameters:[i]})})}(s,t))}})}),(0,f.jsx)(he.EditorField,{label:"Aggregation",width:16,children:(0,f.jsx)(l.Select,{"aria-label":"Aggregation",value:c?(0,r.toOption)(c):null,options:g(a,lt),onChange:e=>{let{value:t}=e;return t&&o(ot(s,t))}})})]})]})},ct=Ze.COMPARISON_OPERATORS.map(r.toOption);function dt(e,t){return function(n,r,i){return(0,f.jsx)(mt,{datasource:e,query:t,filter:n,onChange:r,onDelete:i})}}const pt=e=>{let{query:t,onQueryChange:n,datasource:r}=e;const a=(0,i.useMemo)((()=>{var e;return it(null!==(e=t.sql)&&void 0!==e?e:{})}),[t.sql]),[s,o]=(0,i.useState)(a);return(0,f.jsx)(he.EditorList,{items:s,onChange:e=>{const r=e.map((e=>{var t,n;return{type:Xe.Operator,property:null!==(t=e.property)&&void 0!==t?t:{type:ze.String},operator:null!==(n=e.operator)&&void 0!==n?n:{name:Ze.EQUALS}}}));o(r);const i=[];for(const e of r){const t=nt(e);t&&i.push(t)}const a=i.length?{type:Xe.And,expressions:i}:void 0;n(st(t,{where:a}))},renderItem:dt(r,t)})},mt=e=>{var t,n,i,a,s,o,u,c;const{datasource:d,query:p,filter:m,onChange:h,onDelete:v}=e,y=null!==(t=p.sql)&&void 0!==t?t:{},b=tt(y.from),x=et(y.select),S=Ne(d,p.region,b,x),[w,C]=(0,ge.Z)((async()=>{var e;return null!==(e=m.property)&&void 0!==e&&e.name?d.getDimensionValues(p.region,b,x,m.property.name,{}).then((e=>g(d,e))):[]}),[p.region,b,x,null===(n=m.property)||void 0===n?void 0:n.name]);return(0,f.jsxs)(he.InputGroup,{children:[(0,f.jsx)(l.Select,{width:"auto",value:null!==(i=m.property)&&void 0!==i&&i.name?(0,r.toOption)(null===(a=m.property)||void 0===a?void 0:a.name):null,options:S,allowCustomValue:!0,onChange:e=>{let{value:t}=e;return t&&h((n=m,r=t,{type:Xe.Operator,property:{type:ze.String,name:r},operator:null!==(i=n.operator)&&void 0!==i?i:{}}));var n,r,i}}),(0,f.jsx)(l.Select,{width:"auto",value:(null===(s=m.operator)||void 0===s?void 0:s.name)&&(0,r.toOption)(m.operator.name),options:ct,onChange:e=>{let{value:t}=e;return t&&h((n=m,r=t,{type:Xe.Operator,property:null!==(i=n.property)&&void 0!==i?i:{type:ze.String},operator:Object.assign({},n.operator,{name:r})}));var n,r,i}}),(0,f.jsx)(l.Select,{width:"auto",isLoading:w.loading,value:null!==(o=m.operator)&&void 0!==o&&o.value&&"string"==typeof(null===(u=m.operator)||void 0===u?void 0:u.value)?(0,r.toOption)(null===(c=m.operator)||void 0===c?void 0:c.value):null,options:w.value,allowCustomValue:!0,onOpenMenu:C,onChange:e=>{let{value:t}=e;return t&&h(function(e,t){var n;return{type:Xe.Operator,property:null!==(n=e.property)&&void 0!==n?n:{type:ze.String},operator:Object.assign({},e.operator,{value:t})}}(m,t))}}),(0,f.jsx)(he.AccessoryButton,{"aria-label":"remove",icon:"times",variant:"secondary",onClick:v})]})};function ht(e){return function(t,n,r){return(0,f.jsx)(gt,{options:e,item:t,onChange:n,onDelete:r})}}const gt=e=>{var t;const{options:n,item:i,onChange:a,onDelete:s}=e,o=null===(t=i.property)||void 0===t?void 0:t.name;return(0,f.jsxs)(he.InputGroup,{children:[(0,f.jsx)(l.Select,{"aria-label":`Group by ${null!=o?o:"filter key"}`,width:"auto",value:o?(0,r.toOption)(o):null,options:n,allowCustomValue:!0,onChange:e=>{let{value:t}=e;return t&&a((n=t,{type:Xe.GroupBy,property:{type:ze.String,name:n}}));var n}}),(0,f.jsx)(he.AccessoryButton,{"aria-label":"remove",icon:"times",variant:"secondary",onClick:s})]})},ft=e=>{var t;let{query:n,datasource:r,onQueryChange:a}=e;const s=null!==(t=n.sql)&&void 0!==t?t:{},o=(0,i.useMemo)((()=>{var e;return at(null!==(e=n.sql)&&void 0!==e?e:{})}),[n.sql]),[l,u]=(0,i.useState)(o),c=tt(s.from),d=et(s.select),p=Ne(r,n.region,c,d),m=(0,i.useMemo)((()=>p.filter((e=>!o.some((t=>t.property.name===e.value))))),[p,o]);return(0,f.jsx)(he.EditorList,{items:l,onChange:e=>{const t=e.map((e=>{var t;return{type:Xe.GroupBy,property:{type:ze.String,name:null===(t=e.property)||void 0===t?void 0:t.name}}}));u(t);const r=t.filter((e=>{var t;return null===(t=e.property)||void 0===t?void 0:t.name})),i=r.length?{type:Xe.And,expressions:r}:void 0;a(st(n,{groupBy:i}))},renderItem:ht(m)})},vt=[{label:Ze.ASC,value:Ze.ASC},{label:Ze.DESC,value:Ze.DESC}],yt=e=>{var t,n;let{query:i,onQueryChange:a,datasource:s}=e;const o=null!==(t=i.sql)&&void 0!==t?t:{},u=null===(n=o.orderBy)||void 0===n?void 0:n.name,c=o.orderByDirection;return(0,f.jsxs)(he.EditorFieldGroup,{children:[(0,f.jsx)(he.EditorField,{label:"Order by",optional:!0,width:16,children:(0,f.jsxs)(he.InputGroup,{children:[(0,f.jsx)(l.Select,{"aria-label":"Order by",onChange:e=>{let{value:t}=e;return t&&a(function(e,t){return st(e,{orderBy:{type:Xe.Function,name:t}})}(i,t))},options:g(s,Ze.STATISTICS.map(r.toOption)),value:u?(0,r.toOption)(u):null}),u&&(0,f.jsx)(he.AccessoryButton,{"aria-label":"remove",icon:"times",variant:"secondary",onClick:()=>a(st(i,{orderBy:void 0}))})]})}),(0,f.jsx)(he.EditorField,{label:"Direction",disabled:!u,width:16,children:(0,f.jsx)(l.Select,{"aria-label":"Direction",inputId:"cloudwatch-sql-order-by-direction",value:c?(0,r.toOption)(c):vt[0],options:g(s,vt),onChange:e=>e&&a(st(i,{orderByDirection:e.value}))})})]})};function bt(e){var t;let{query:n,datasource:r,onChange:a,onRunQuery:s}=e;const o=null!==(t=n.sql)&&void 0!==t?t:{},u=(0,i.useCallback)((e=>{var t;const n=(new Ye).expressionToSqlQuery(null!==(t=e.sql)&&void 0!==t?t:{}),r=Object.assign({},e,{sqlExpression:n});a(r),s()}),[a,s]),[c,d]=(0,i.useState)();return(0,i.useEffect)((()=>{var e;const t=(new Ye).expressionToSqlQuery(null!==(e=n.sql)&&void 0!==e?e:{});c!==t&&d(t)}),[n,c,d]),(0,f.jsxs)(he.EditorRows,{children:[(0,f.jsx)(he.EditorRow,{children:(0,f.jsx)(ut,{query:n,onQueryChange:u,datasource:r})}),(0,f.jsx)(he.EditorRow,{children:(0,f.jsx)(he.EditorField,{label:"Filter",optional:!0,children:(0,f.jsx)(pt,{query:n,onQueryChange:u,datasource:r})})}),(0,f.jsxs)(he.EditorRow,{children:[(0,f.jsx)(he.EditorField,{label:"Group by",optional:!0,children:(0,f.jsx)(ft,{query:n,onQueryChange:u,datasource:r})}),(0,f.jsx)(yt,{query:n,onQueryChange:u,datasource:r}),(0,f.jsx)(he.EditorField,{label:"Limit",optional:!0,children:(0,f.jsx)(l.Input,{id:`${n.refId}-cloudwatch-sql-builder-editor-limit`,value:o.limit,onChange:e=>{const t=e.currentTarget.valueAsNumber;u(st(n,{limit:isNaN(t)?void 0:t}))},type:"number",min:1})})]}),c&&(0,f.jsxs)(he.EditorRow,{children:[!1,(0,f.jsx)("pre",{children:null!=c?c:""})]})]})}const xt={id:"cloudwatch-MetricMath",extensions:[],aliases:[],mimetypes:[],loader:()=>Promise.resolve().then(n.bind(n,67929))},St={id:"editor.action.triggerSuggest",title:""},wt=(e,t,n)=>{const{id:r,loader:i}=t;e.languages.getLanguages().find((e=>e.id===r))||(e.languages.register({id:r}),i().then((i=>{e.languages.setMonarchTokensProvider(r,i.language),e.languages.setLanguageConfiguration(r,i.conf),e.languages.registerCompletionItemProvider(r,n.getCompletionProvider(e,t))})))};function Ct(e){let{expression:t,onChange:n,onRunQuery:r,datasource:a}=e;const s=(0,i.useRef)(null),o=(0,i.useCallback)(((e,t)=>{e.onDidFocusEditorText((()=>e.trigger(St.id,St.id,{}))),e.addCommand(t.KeyMod.Shift|t.KeyCode.Enter,(()=>{const t=e.getValue();n(t),r()}));const i=()=>{const t=s.current;if(null!==t&&e.getContentHeight()<200){const n=Math.max(32,e.getContentHeight());t.style.height=`${n}px`,t.style.width="100%";const r=t.clientWidth;e.layout({width:r,height:n})}};e.onDidContentSizeChange(i),i()}),[n,r]);return(0,f.jsx)("div",{ref:s,children:(0,f.jsx)(l.CodeEditor,{monacoOptions:{scrollBeyondLastLine:!1,fontSize:14,lineNumbers:"off",renderLineHighlight:"none",scrollbar:{vertical:"hidden",horizontal:"hidden"},suggestFontSize:12,wordWrap:"on",padding:{top:6}},language:xt.id,value:t,onBlur:e=>{e!==t&&(n(e),r())},onBeforeEditorMount:e=>wt(e,xt,a.metricMathCompletionItemProvider),onEditorDidMount:o})})}const It={id:"cloudwatch-sql",extensions:[".cloudwatchSql"],aliases:["CloudWatch","cloudwatch","CloudWatchSQL"],mimetypes:[],loader:()=>Promise.resolve().then(n.bind(n,1762))},Et=e=>{let{region:t,sql:n,onChange:r,onRunQuery:a,datasource:s}=e;(0,i.useEffect)((()=>{s.sqlCompletionItemProvider.setRegion(t)}),[t,s]);const o=(0,i.useCallback)(((e,t)=>{e.onDidFocusEditorText((()=>e.trigger(St.id,St.id,{}))),e.addCommand(t.KeyMod.Shift|t.KeyCode.Enter,(()=>{const t=e.getValue();r(t),a()}))}),[r,a]);return(0,f.jsx)(l.CodeEditor,{height:"150px",language:It.id,value:n,onBlur:e=>{e!==n&&r(e)},showMiniMap:!1,showLineNumbers:!0,onBeforeEditorMount:e=>wt(e,It,s.sqlCompletionItemProvider),onEditorDidMount:o})};class Tt{constructor(e,t,n,r,i,a){this.type=e,this.value=t,this.range=n,this.previous=r,this.next=i,this.tokenTypes=a}isKeyword(){return this.type===this.tokenTypes.Keyword}isWhiteSpace(){return this.type===this.tokenTypes.Whitespace}isParenthesis(){return this.type===this.tokenTypes.Parenthesis}isIdentifier(){return this.type===this.tokenTypes.Identifier}isString(){return this.type===this.tokenTypes.String}isDoubleQuotedString(){return this.type===this.tokenTypes.Type}isVariable(){return this.type===this.tokenTypes.Variable}isFunction(){return this.type===this.tokenTypes.Function}isNumber(){return this.type===this.tokenTypes.Number}is(e,t){const n=this.type===e;return void 0!==t?n&&this.value===t:n}endsWith(e){return this.value===e||this.value[this.value.length-1]===e}getPreviousNonWhiteSpaceToken(){let e=this.previous;for(;null!=e;){if(!e.isWhiteSpace())return e;e=e.previous}return null}getPreviousOfType(e,t){let n=this.previous;for(;null!=n;){const r=n.type===e;if(void 0!==t?r&&n.value===t:r)return n;n=n.previous}return null}getPreviousUntil(e,t,n){let r=[],i=this.previous;for(;null!=i;){if(t.some((e=>{var t;return e===(null===(t=i)||void 0===t?void 0:t.type)}))){i=i.previous;continue}const a=i.type===e;if(void 0!==n?a&&i.value===n:a)return r;i.isWhiteSpace()||r.push(i),i=i.previous}return r}getNextUntil(e,t,n){let r=[],i=this.next;for(;null!=i;){if(t.some((e=>{var t;return e===(null===(t=i)||void 0===t?void 0:t.type)}))){i=i.next;continue}const a=i.type===e;if(void 0!==n?a&&i.value===n:a)return r;i.isWhiteSpace()||r.push(i),i=i.next}return r}getPreviousKeyword(){let e=this.previous;for(;null!=e;){if(e.isKeyword())return e;e=e.previous}return null}getNextNonWhiteSpaceToken(){let e=this.next;for(;null!=e;){if(!e.isWhiteSpace())return e;e=e.next}return null}getNextOfType(e,t){let n=this.next;for(;null!=n;){const r=n.type===e;if(void 0!==t?r&&n.value===t:r)return n;n=n.next}return null}}function jt(e,t,n,r,i){var a;let s=null,o=null;const l=e.editor.tokenize(null!==(a=n.getValue())&&void 0!==a?a:"",t.id);for(let a=0;a<l.length;a++){const u=l[a];if(!u.length&&o){const e={offset:0,type:i.Whitespace,language:t.id,_tokenBrand:void 0};u.push(e)}for(let t=0;t<u.length;t++){const l=u[t];let c=u.length>t+1?u[t+1].offset+1:n.getLineLength(a+1)+1;const d={startLineNumber:a+1,startColumn:0===l.offset?0:l.offset+1,endLineNumber:a+1,endColumn:c},p=n.getValueInRange(d),m=new Tt(l.type,p,d,o,null,i);e.Range.containsPosition(d,r)&&(s=m),o&&(o.next=m),o=m}}return s}let At,Rt,Ot;!function(e){e[e.Unknown=0]="Unknown",e[e.SelectKeyword=1]="SelectKeyword",e[e.AfterSelectKeyword=2]="AfterSelectKeyword",e[e.AfterSelectFuncFirstArgument=3]="AfterSelectFuncFirstArgument",e[e.AfterFromKeyword=4]="AfterFromKeyword",e[e.SchemaFuncFirstArgument=5]="SchemaFuncFirstArgument",e[e.SchemaFuncExtraArgument=6]="SchemaFuncExtraArgument",e[e.FromKeyword=7]="FromKeyword",e[e.AfterFrom=8]="AfterFrom",e[e.WhereKey=9]="WhereKey",e[e.WhereComparisonOperator=10]="WhereComparisonOperator",e[e.WhereValue=11]="WhereValue",e[e.AfterWhereValue=12]="AfterWhereValue",e[e.AfterGroupByKeywords=13]="AfterGroupByKeywords",e[e.AfterGroupBy=14]="AfterGroupBy",e[e.AfterOrderByKeywords=15]="AfterOrderByKeywords",e[e.AfterOrderByFunction=16]="AfterOrderByFunction",e[e.AfterOrderByDirection=17]="AfterOrderByDirection",e[e.PredefinedFunction=18]="PredefinedFunction",e[e.SearchFuncSecondArg=19]="SearchFuncSecondArg",e[e.SearchFuncThirdArg=20]="SearchFuncThirdArg",e[e.PredefinedFuncSecondArg=21]="PredefinedFuncSecondArg",e[e.AfterFunction=22]="AfterFunction",e[e.WithinString=23]="WithinString"}(At||(At={})),function(e){e[e.SelectKeyword=0]="SelectKeyword",e[e.FunctionsWithArguments=1]="FunctionsWithArguments",e[e.Metrics=2]="Metrics",e[e.FromKeyword=3]="FromKeyword",e[e.SchemaKeyword=4]="SchemaKeyword",e[e.Namespaces=5]="Namespaces",e[e.LabelKeys=6]="LabelKeys",e[e.WhereKeyword=7]="WhereKeyword",e[e.GroupByKeywords=8]="GroupByKeywords",e[e.OrderByKeywords=9]="OrderByKeywords",e[e.FunctionsWithoutArguments=10]="FunctionsWithoutArguments",e[e.LimitKeyword=11]="LimitKeyword",e[e.SortOrderDirectionKeyword=12]="SortOrderDirectionKeyword",e[e.ComparisonOperators=13]="ComparisonOperators",e[e.LabelValues=14]="LabelValues",e[e.LogicalOperators=15]="LogicalOperators",e[e.KeywordArguments=16]="KeywordArguments",e[e.Operators=17]="Operators",e[e.Statistic=18]="Statistic",e[e.Period=19]="Period"}(Rt||(Rt={})),function(e){e.High="a",e.MediumHigh="d",e.Medium="g",e.MediumLow="k",e.Low="q"}(Ot||(Ot={}));var Ft=n(48284);const Mt={id:"cloudwatch-dynamicLabels",extensions:[],aliases:[],mimetypes:[],loader:()=>Promise.resolve().then(n.bind(n,48284))},Dt=new class{constructor(){var e,t,n;n=void 0,(t="tokenTypes")in(e=this)?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,this.tokenTypes={Parenthesis:"delimiter.parenthesis.cloudwatch-dynamicLabels",Whitespace:"white.cloudwatch-dynamicLabels",Keyword:"keyword.cloudwatch-dynamicLabels",Delimiter:"delimiter.cloudwatch-dynamicLabels",Operator:"operator.cloudwatch-dynamicLabels",Identifier:"identifier.cloudwatch-dynamicLabels",Type:"type.cloudwatch-dynamicLabels",Function:"predefined.cloudwatch-dynamicLabels",Number:"number.cloudwatch-dynamicLabels",String:"string.cloudwatch-dynamicLabels",Variable:"variable.cloudwatch-dynamicLabels"}}getCompletionProvider(e,t){return{triggerCharacters:[" ","$",",","(","'"],provideCompletionItems:async(n,r)=>{const i=jt(e,t,n,r,this.tokenTypes),a=(null==i?void 0:i.isWhiteSpace())||(null==i?void 0:i.isParenthesis())||null==i||!i.range?e.Range.fromPositions(r):null==i?void 0:i.range,s=function(t){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const r=Object.assign({label:t,insertText:t,kind:e.languages.CompletionItemKind.Field,range:a,sortText:Ot.Medium},n);return r};let o=[];const l=null==i?void 0:i.next;return null!=i&&i.isFunction()||l&&!l.isWhiteSpace()||(o=Ft.DYNAMIC_LABEL_PATTERNS.map((e=>s(e))),o.push(s("${PROP('Dim.')}",{sortText:Ot.High,insertText:"${PROP('Dim.$0')} ",insertTextRules:e.languages.CompletionItemInsertTextRule.InsertAsSnippet}))),{suggestions:o}}}}};function kt(e){let{label:t,width:n,onChange:r,onRunQuery:a}=e;const s=(0,l.useTheme2)(),o=(0,l.getInputStyles)({theme:s,width:n}),u=(0,i.useRef)(null),c=(0,i.useCallback)(((e,t)=>{e.onDidFocusEditorText((()=>e.trigger(St.id,St.id,{}))),e.addCommand(t.KeyMod.Shift|t.KeyCode.Enter,(()=>{const t=e.getValue();r(t),a()}));const n=u.current;null!==n&&e.layout({width:n.clientWidth,height:n.clientHeight})}),[r,a]);return(0,f.jsx)("div",{ref:u,className:(0,x.cx)(o.wrapper),children:(0,f.jsx)(l.CodeEditor,{containerStyles:x.css`
          border: 1px solid ${s.colors.action.disabledBackground};
          &:hover {
            border-color: ${s.components.input.borderColor};
          }
        `,monacoOptions:{scrollBeyondLastLine:!1,fontSize:14,lineNumbers:"off",renderLineHighlight:"none",overviewRulerLanes:0,scrollbar:{vertical:"hidden",horizontal:"hidden"},suggestFontSize:12,padding:{top:6}},language:Mt.id,value:t,onBlur:e=>{e!==t&&(r(e),a())},onBeforeEditorMount:e=>wt(e,Mt,Dt),onEditorDidMount:c})})}const Nt=e=>{let{value:t="",onChange:n,id:r}=e;const[a,s]=(0,i.useState)(t),o=(0,m.debounce)(n,1500);return n=e=>{s(e.target.value),o(e.target.value)},(0,f.jsx)(l.Input,{id:r,type:"text",value:a,onChange:n,"aria-label":"Optional alias"})};var Pt=n(10322),qt=n.n(Pt);function Lt(e){const t=function(e){if(o.config.featureToggles.cloudWatchDynamicLabels&&!e.hasOwnProperty("label")){var t,n;const r=/{{\s*(.+?)\s*}}/g;e.label=null!==(t=null===(n=e.alias)||void 0===n?void 0:n.replace(r,((e,t)=>Kt.hasOwnProperty(t)?`\${${Kt[t]}}`:`\${PROP('Dim.${t}')}`)))&&void 0!==t?t:""}return e}(e);return t}const Kt={metric:"PROP('MetricName')",namespace:"PROP('Namespace')",period:"PROP('Period')",region:"PROP('Region')",stat:"PROP('Stat')",label:"LABEL"};const $t={queryMode:"Metrics",namespace:"",metricName:"",expression:"",dimensions:{},region:"default",id:"",statistic:"Average",period:"",metricQueryType:qe.$5.Search,metricEditorMode:qe.MQ.Builder,sqlExpression:"",matchExact:!0},Vt=(e,t)=>{const n=(0,i.useMemo)((()=>(e=>{const t=Lt(Object.assign({},$t,e));return qt()(t,e)?e:t})(e)),[e]);return(0,i.useEffect)((()=>{n!==e&&t(n)}),[n,e,t]),n};var Qt,Bt;const Wt=e=>{var t,n,r,a;const{query:s,onRunQuery:u,datasource:c}=e,[d,p]=(0,i.useState)(!1),m=Vt(s,e.onChange),h=t=>{const{onChange:n,onRunQuery:r}=e;n(t),r()};return(0,f.jsxs)(f.Fragment,{children:[(0,f.jsx)(Qe,{query:s,onRunQuery:u,datasource:c,onChange:e=>{pe(e)&&e.metricEditorMode!==s.metricEditorMode&&p(!1),h(e)},sqlCodeEditorIsDirty:d}),Qt||(Qt=(0,f.jsx)(he.Space,{v:.5})),s.metricQueryType===qe.$5.Search&&(0,f.jsxs)(f.Fragment,{children:[s.metricEditorMode===qe.MQ.Builder&&(0,f.jsx)(He,Object.assign({},e,{refId:s.refId,metricStat:s,onChange:t=>e.onChange(Object.assign({},s,t))})),s.metricEditorMode===qe.MQ.Code&&(0,f.jsx)(Ct,{onRunQuery:u,expression:null!==(t=s.expression)&&void 0!==t?t:"",onChange:t=>e.onChange(Object.assign({},s,{expression:t})),datasource:c})]}),s.metricQueryType===qe.$5.Query&&(0,f.jsxs)(f.Fragment,{children:[s.metricEditorMode===qe.MQ.Code&&(0,f.jsx)(Et,{region:s.region,sql:null!==(n=s.sqlExpression)&&void 0!==n?n:"",onChange:t=>{d||p(!0),e.onChange(Object.assign({},m,{sqlExpression:t}))},onRunQuery:u,datasource:c}),s.metricEditorMode===qe.MQ.Builder&&(0,f.jsx)(f.Fragment,{children:(0,f.jsx)(bt,{query:s,onChange:e.onChange,onRunQuery:u,datasource:c})})]}),Bt||(Bt=(0,f.jsx)(he.Space,{v:.5})),(0,f.jsxs)(he.EditorRow,{children:[(0,f.jsx)(he.EditorField,{label:"ID",width:26,optional:!0,tooltip:"ID can be used to reference other queries in math expressions. The ID can include numbers, letters, and underscore, and must start with a lowercase letter.",invalid:!!s.id&&!/^$|^[a-z][a-zA-Z0-9_]*$/.test(s.id),children:(0,f.jsx)(l.Input,{id:`${s.refId}-cloudwatch-metric-query-editor-id`,onBlur:u,onChange:e=>h(Object.assign({},m,{id:e.target.value})),type:"text",value:s.id})}),(0,f.jsx)(he.EditorField,{label:"Period",width:26,tooltip:"Minimum interval between points in seconds.",children:(0,f.jsx)(l.Input,{id:`${s.refId}-cloudwatch-metric-query-editor-period`,value:s.period||"",placeholder:"auto",onBlur:u,onChange:e=>h(Object.assign({},m,{period:e.target.value}))})}),o.config.featureToggles.cloudWatchDynamicLabels?(0,f.jsx)(he.EditorField,{label:"Label",width:26,optional:!0,tooltip:"Change time series legend name using Dynamic labels. See documentation for details.",children:(0,f.jsx)(kt,{width:52,onRunQuery:u,label:null!==(r=m.label)&&void 0!==r?r:"",onChange:t=>e.onChange(Object.assign({},s,{label:t}))})}):(0,f.jsx)(he.EditorField,{label:"Alias",width:26,optional:!0,tooltip:"Change time series legend name using this field. See documentation for replacement variable formats.",children:(0,f.jsx)(Nt,{id:`${s.refId}-cloudwatch-metric-query-editor-alias`,value:null!==(a=m.alias)&&void 0!==a?a:"",onChange:e=>h(Object.assign({},m,{alias:e}))})})]})]})};class _t extends i.PureComponent{render(){const{query:e}=this.props;return(0,f.jsxs)(f.Fragment,{children:[pe(e)&&(0,f.jsx)(Wt,Object.assign({},this.props,{query:e})),de(e)&&(0,f.jsx)(Ue,Object.assign({},this.props,{query:e}))]})}}var Gt,Ut,Ht=n(71808),Jt=n(94396),zt=n(58799),Xt=n(3321),Yt=n(59366),Zt=n(86558),en=n(16976),tn=n(71114),nn=n(35778),rn=n(76747),an=n(87067),sn=n(2027),on=n(20746),ln=n(39419),un=n(63758),cn=n(24298),dn=n(14444),pn=n(78837),mn=n(75478),hn=n(47570);const gn={prepareAnnotation:e=>(e=>{var t;return"Annotations"===(null===(t=e.target)||void 0===t?void 0:t.queryMode)})(e)?e:{datasource:e.datasource,enable:e.enable,iconColor:e.iconColor,name:e.name,builtIn:e.builtIn,hide:e.hide,target:Object.assign({},e.target,e,{statistic:e.statistic||"Average",region:e.region||"default",queryMode:"Annotations",refId:e.refId||"annotationQuery"})},prepareQuery:e=>{if(!e.target)return;const{prefixMatching:t,actionPrefix:n,alarmNamePrefix:r,statistic:i,namespace:a,metricName:s,dimensions:o={}}=e.target,l=!!t&&!!n&&!!r,u=!(t||!a||!s||!i||!Object.values(o).length);return l||u?e.target:void 0},QueryEditor:e=>{const{query:t,onChange:n,datasource:r}=e,[i,a]=Me(r);return me(t)?(0,f.jsxs)(f.Fragment,{children:[(0,f.jsx)(he.EditorHeader,{children:(0,f.jsx)(he.InlineSelect,{label:"Region",value:i.find((e=>e.value===t.region)),placeholder:"Select region",allowCustomValue:!0,onChange:e=>{let{value:r}=e;return r&&n(Object.assign({},t,{region:r}))},options:i,isLoading:a})}),Gt||(Gt=(0,f.jsx)(he.Space,{v:.5})),(0,f.jsx)(He,Object.assign({},e,{refId:t.refId,metricStat:t,disableExpressions:!0,onChange:e=>n(Object.assign({},t,e)),onRunQuery:()=>{}})),Ut||(Ut=(0,f.jsx)(he.Space,{v:.5})),(0,f.jsxs)(he.EditorRow,{children:[(0,f.jsx)(he.EditorField,{label:"Period",width:26,tooltip:"Minimum interval between points in seconds.",children:(0,f.jsx)(l.Input,{value:t.period||"",placeholder:"auto",onChange:e=>n(Object.assign({},t,{period:e.target.value}))})}),(0,f.jsx)(he.EditorField,{label:"Enable Prefix Matching",optional:!0,children:(0,f.jsx)(he.EditorSwitch,{value:t.prefixMatching,onChange:e=>{n(Object.assign({},t,{prefixMatching:e.currentTarget.checked}))}})}),(0,f.jsx)(he.EditorField,{label:"Action",optional:!0,disabled:!t.prefixMatching,children:(0,f.jsx)(l.Input,{value:t.actionPrefix||"",onChange:e=>n(Object.assign({},t,{actionPrefix:e.target.value}))})}),(0,f.jsx)(he.EditorField,{label:"Alarm Name",optional:!0,disabled:!t.prefixMatching,children:(0,f.jsx)(l.Input,{value:t.alarmNamePrefix||"",onChange:e=>n(Object.assign({},t,{alarmNamePrefix:e.target.value}))})})]})]}):(0,f.jsx)(l.Alert,{severity:"error",title:"Invalid annotation query",topSpacing:2,children:JSON.stringify(t,null,4)})}};function fn(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class vn{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,o.getTemplateSrv)();fn(this,"templateVariables",void 0),fn(this,"datasource",void 0),fn(this,"templateSrv",void 0),fn(this,"tokenTypes",void 0),this.datasource=e,this.templateSrv=t,this.templateVariables=this.datasource.getVariables(),this.templateSrv=t,this.tokenTypes={Parenthesis:"delimiter.parenthesis",Whitespace:"white",Keyword:"keyword",Delimiter:"delimiter",Operator:"operator",Identifier:"identifier",Type:"type",Function:"predefined",Number:"number",String:"string",Variable:"variable"}}getStatementPosition(e){return At.Unknown}getSuggestionKinds(e){return[]}getSuggestions(e,t,n,r,i){return Promise.reject([])}getCompletionProvider(e,t){return{triggerCharacters:[" ","$",",","(","'"],provideCompletionItems:async(n,r)=>{const i=jt(e,t,n,r,this.tokenTypes),a=this.getStatementPosition(i),s=this.getSuggestionKinds(a);return{suggestions:await this.getSuggestions(e,i,s,a,r)}}}}}const yn={Parenthesis:"delimiter.parenthesis.sql",Whitespace:"white.sql",Keyword:"keyword.sql",Delimiter:"delimiter.sql",Operator:"operator.sql",Identifier:"identifier.sql",Type:"type.sql",Function:"predefined.sql",Number:"number.sql",String:"string.sql",Variable:"variable.sql"};function bn(e){var t,n,r,i,a,s;const o=null==e?void 0:e.getPreviousNonWhiteSpaceToken(),l=null==e?void 0:e.getPreviousKeyword(),u=null==e||null===(t=e.getPreviousNonWhiteSpaceToken())||void 0===t?void 0:t.is(yn.Operator,"/");return null===e||e.isWhiteSpace()&&null===e.previous||e.is(yn.Keyword,Ze.SELECT)&&null===e.previous||u||e.isIdentifier()&&(u||null===(null==e?void 0:e.previous))?At.SelectKeyword:(null==o?void 0:o.value)===Ze.SELECT?At.AfterSelectKeyword:(null!=o&&o.is(yn.Parenthesis,"(")||null!=e&&e.is(yn.Parenthesis,"()"))&&(null==l?void 0:l.value)===Ze.SELECT?At.AfterSelectFuncFirstArgument:(null==l?void 0:l.value)===Ze.SELECT&&null!=o&&o.isParenthesis()?At.FromKeyword:(null==o?void 0:o.value)===Ze.FROM?At.AfterFromKeyword:(null!=o&&o.is(yn.Parenthesis,"(")||null!=e&&e.is(yn.Parenthesis,"()"))&&(null==l?void 0:l.value)===Ze.SCHEMA?At.SchemaFuncFirstArgument:(null==l?void 0:l.value)===Ze.SCHEMA&&null!=o&&o.is(yn.Delimiter,",")?At.SchemaFuncExtraArgument:(null==l?void 0:l.value)===Ze.FROM&&null!=o&&o.isDoubleQuotedString()||(null==l?void 0:l.value)===Ze.FROM&&null!=o&&o.isVariable()||(null==l?void 0:l.value)===Ze.SCHEMA&&null!=o&&o.is(yn.Parenthesis,")")?At.AfterFrom:(null==l?void 0:l.value)===Ze.WHERE&&(null!=o&&o.isKeyword()||null!=o&&o.is(yn.Parenthesis,"(")||null!=o&&o.is(yn.Operator,Ze.AND))?At.WhereKey:(null==l?void 0:l.value)===Ze.WHERE&&(null!=o&&o.isIdentifier()||null!=o&&o.isDoubleQuotedString())?At.WhereComparisonOperator:(null==l?void 0:l.value)===Ze.WHERE&&(null!=o&&o.is(yn.Operator,Ze.EQUALS)||null!=o&&o.is(yn.Operator,Ze.NOT_EQUALS))?At.WhereValue:(null==l?void 0:l.value)===Ze.WHERE&&(null!=o&&o.isString()||null!=o&&o.is(yn.Parenthesis,")"))?At.AfterWhereValue:null!=l&&l.is(yn.Keyword,Ze.BY)&&null!=l&&null!==(n=l.getPreviousKeyword())&&void 0!==n&&n.is(yn.Keyword,Ze.GROUP)&&(null!=o&&o.is(yn.Keyword,Ze.BY)||null!=o&&o.is(yn.Delimiter,","))?At.AfterGroupByKeywords:null!=l&&l.is(yn.Keyword,Ze.BY)&&null!=l&&null!==(r=l.getPreviousKeyword())&&void 0!==r&&r.is(yn.Keyword,Ze.GROUP)&&(null!=o&&o.isIdentifier()||null!=o&&o.isDoubleQuotedString())?At.AfterGroupBy:null!=o&&o.is(yn.Keyword,Ze.BY)&&null!=o&&null!==(i=o.getPreviousKeyword())&&void 0!==i&&i.is(yn.Keyword,Ze.ORDER)?At.AfterOrderByKeywords:null!=l&&l.is(yn.Keyword,Ze.BY)&&null!=l&&null!==(a=l.getPreviousKeyword())&&void 0!==a&&a.is(yn.Keyword,Ze.ORDER)&&null!=o&&o.is(yn.Parenthesis)&&null!=o&&null!==(s=o.getPreviousNonWhiteSpaceToken())&&void 0!==s&&s.is(yn.Function)?At.AfterOrderByFunction:null!=l&&l.is(yn.Keyword,Ze.DESC)||null!=l&&l.is(yn.Keyword,Ze.ASC)?At.AfterOrderByDirection:At.Unknown}function xn(e){switch(e){case At.SelectKeyword:return[Rt.SelectKeyword];case At.AfterSelectKeyword:return[Rt.FunctionsWithArguments];case At.AfterSelectFuncFirstArgument:return[Rt.Metrics];case At.AfterFromKeyword:return[Rt.Namespaces,Rt.SchemaKeyword];case At.SchemaFuncFirstArgument:return[Rt.Namespaces];case At.SchemaFuncExtraArgument:return[Rt.LabelKeys];case At.FromKeyword:return[Rt.FromKeyword];case At.AfterFrom:return[Rt.WhereKeyword,Rt.GroupByKeywords,Rt.OrderByKeywords,Rt.LimitKeyword];case At.WhereKey:return[Rt.LabelKeys];case At.WhereComparisonOperator:return[Rt.ComparisonOperators];case At.WhereValue:return[Rt.LabelValues];case At.AfterWhereValue:return[Rt.LogicalOperators,Rt.GroupByKeywords,Rt.OrderByKeywords,Rt.LimitKeyword];case At.AfterGroupByKeywords:return[Rt.LabelKeys];case At.AfterGroupBy:return[Rt.OrderByKeywords,Rt.LimitKeyword];case At.AfterOrderByKeywords:return[Rt.FunctionsWithoutArguments];case At.AfterOrderByFunction:return[Rt.SortOrderDirectionKeyword,Rt.LimitKeyword];case At.AfterOrderByDirection:return[Rt.LimitKeyword]}return[]}const Sn=e=>{var t;return null!==(t=null==e?void 0:e.getPreviousOfType(yn.Keyword,Ze.SELECT))&&void 0!==t?t:null},wn=e=>{var t,n;const r=null===(t=(e=>{var t;const n=null===(t=Sn(e))||void 0===t?void 0:t.getNextNonWhiteSpaceToken();return null!=n&&n.isVariable()||null!=n&&n.isFunction()?n:null})(e))||void 0===t||null===(n=t.next)||void 0===n?void 0:n.next;return null!=r&&r.isVariable()||null!=r&&r.isIdentifier()?r:null},Cn=e=>{var t;const n=(e=>{const t=Sn(e);return null==t?void 0:t.getNextOfType(yn.Keyword,Ze.FROM)})(e),r=null==n?void 0:n.getNextNonWhiteSpaceToken();if(null!=r&&r.isDoubleQuotedString()||null!=r&&r.isVariable()&&(null==r?void 0:r.value.toUpperCase())!==Ze.SCHEMA)return r;if(null!=r&&r.isKeyword()&&null!==(t=r.next)&&void 0!==t&&t.is(yn.Parenthesis,"(")){var i;const e=null===(i=r.next)||void 0===i?void 0:i.next;if(null!=e&&e.isDoubleQuotedString()||null!=e&&e.isVariable())return e}return null};class In extends vn{constructor(e){var t,n,r;super(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,o.getTemplateSrv)()),r=void 0,(n="region")in(t=this)?Object.defineProperty(t,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[n]=r,this.region=e.getActualRegion(),this.getStatementPosition=bn,this.getSuggestionKinds=xn,this.tokenTypes=yn}setRegion(e){this.region=e}async getSuggestions(e,t,n,r,i){let a=[];const s=(null==t?void 0:t.isWhiteSpace())||(null==t?void 0:t.isParenthesis())||null==t||!t.range?e.Range.fromPositions(i):null==t?void 0:t.range,o=function(t){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const r=Object.assign({label:t,insertText:t,kind:e.languages.CompletionItemKind.Field,range:s,sortText:Ot.Medium},n);return r};function l(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};a=[...a,o(e,t)]}for(const i of n)switch(i){case Rt.SelectKeyword:l(Ze.SELECT,{insertText:`${Ze.SELECT} $0`,insertTextRules:e.languages.CompletionItemInsertTextRule.InsertAsSnippet,kind:e.languages.CompletionItemKind.Keyword,command:St});break;case Rt.FunctionsWithArguments:Ze.STATISTICS.map((t=>l(t,{insertText:`${t}($0)`,insertTextRules:e.languages.CompletionItemInsertTextRule.InsertAsSnippet,command:St,kind:e.languages.CompletionItemKind.Function})));break;case Rt.FunctionsWithoutArguments:Ze.STATISTICS.map((t=>l(t,{insertText:`${t}() `,insertTextRules:e.languages.CompletionItemInsertTextRule.InsertAsSnippet,command:St,kind:e.languages.CompletionItemKind.Function})));break;case Rt.Metrics:{const e=Cn(t);if(null!=e&&e.value){(await this.datasource.getMetrics(this.templateSrv.replace(null==e?void 0:e.value.replace(/\"/g,"")),this.templateSrv.replace(this.region))).map((e=>l(e.value)))}else{const e=await this.datasource.getAllMetrics(this.templateSrv.replace(this.region));(0,m.uniq)(e.map((e=>e.metricName))).map((e=>l(e,{insertText:e})))}}break;case Rt.FromKeyword:l(Ze.FROM,{insertText:`${Ze.FROM} `,command:St});break;case Rt.SchemaKeyword:l(Ze.SCHEMA,{sortText:Ot.High,insertText:`${Ze.SCHEMA}($0)`,insertTextRules:e.languages.CompletionItemInsertTextRule.InsertAsSnippet,command:St,kind:e.languages.CompletionItemKind.Function});break;case Rt.Namespaces:const n=wn(t);let i=[];if(null!=n&&n.value){const e=await this.datasource.getAllMetrics(this.region),t=this.templateSrv.replace(n.value);i=e.filter((e=>e.metricName===t)).map((e=>e.namespace))}else{i=(await this.datasource.getNamespaces()).map((e=>e.value))}i.map((e=>l(`"${e}"`,{insertText:`"${e}"`})));break;case Rt.LabelKeys:{const e=wn(t),n=Cn(t);if(null!=n&&n.value){var u;let i,a={};r===At.SchemaFuncExtraArgument?i=null==n?void 0:n.getNextUntil(this.tokenTypes.Parenthesis,[this.tokenTypes.Delimiter,this.tokenTypes.Whitespace]):r===At.AfterGroupByKeywords&&(i=null==t?void 0:t.getPreviousUntil(this.tokenTypes.Keyword,[this.tokenTypes.Delimiter,this.tokenTypes.Whitespace])),a=(i||[]).reduce(((e,t)=>Object.assign({},e,{[t.value]:null})),{});(await this.datasource.getDimensionKeys(this.templateSrv.replace(n.value.replace(/\"/g,"")),this.templateSrv.replace(this.region),a,null!==(u=null==e?void 0:e.value)&&void 0!==u?u:"")).map((e=>{l(/[\s\.-]/.test(e.value)?`"${e.value}"`:e.value)}))}}break;case Rt.LabelValues:{var c;const e=Cn(t),n=wn(t),r=null==t||null===(c=t.getPreviousNonWhiteSpaceToken())||void 0===c?void 0:c.getPreviousNonWhiteSpaceToken();if(null!=e&&e.value&&null!=r&&r.value&&null!=n&&n.value){(await this.datasource.getDimensionValues(this.templateSrv.replace(this.region),this.templateSrv.replace(e.value.replace(/\"/g,"")),this.templateSrv.replace(n.value),this.templateSrv.replace(r.value),{})).map((e=>l(`'${e.value}'`,{insertText:`'${e.value}' `,command:St})))}}break;case Rt.LogicalOperators:Ze.LOGICAL_OPERATORS.map((e=>l(`${e}`,{insertText:`${e} `,command:St,sortText:Ot.MediumHigh})));break;case Rt.WhereKeyword:l(`${Ze.WHERE}`,{insertText:`${Ze.WHERE} `,command:St,sortText:Ot.High});break;case Rt.ComparisonOperators:Ze.COMPARISON_OPERATORS.map((e=>l(`${e}`,{insertText:`${e} `,command:St})));break;case Rt.GroupByKeywords:l(`${Ze.GROUP} ${Ze.BY}`,{insertText:`${Ze.GROUP} ${Ze.BY} `,command:St,sortText:Ot.MediumHigh});break;case Rt.OrderByKeywords:l(`${Ze.ORDER} ${Ze.BY}`,{insertText:`${Ze.ORDER} ${Ze.BY} `,command:St,sortText:Ot.Medium});break;case Rt.LimitKeyword:l(Ze.LIMIT,{insertText:`${Ze.LIMIT} `,sortText:Ot.MediumLow});break;case Rt.SortOrderDirectionKeyword:[Ze.ASC,Ze.DESC].map((e=>l(e,{insertText:`${e} `,command:St})))}return this.templateVariables.map((t=>{l(t,{range:s,label:t,insertText:t,kind:e.languages.CompletionItemKind.Variable,sortText:Ot.Low})})),a}}var En;const Tn=e=>{let{region:t}=e;return(0,f.jsxs)("p",{children:["Please visit the",(0,f.jsx)("a",{target:"_blank",rel:"noreferrer",className:"text-link",href:`https://${t}.console.aws.amazon.com/servicequotas/home?region=${t}#!/services/monitoring/quotas/L-5E141212`,children:"AWS Service Quotas console"}),"to request a quota increase or see our",En||(En=(0,f.jsx)("a",{target:"_blank",rel:"noreferrer",className:"text-link",href:"https://grafana.com/docs/grafana/latest/datasources/cloudwatch/#service-quotas",children:"documentation"})),"to learn more."]})};function jn(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class An extends r.LanguageProvider{constructor(e,t){super(),jn(this,"started",!1),jn(this,"datasource",void 0),jn(this,"cleanText",(e=>e.replace(/[()]/g,"").trim())),jn(this,"request",((e,t)=>(0,zt.n)(this.datasource.awsRequest(e,t)))),jn(this,"start",(()=>(this.startTask||(this.startTask=Promise.resolve().then((()=>(this.started=!0,[])))),this.startTask))),jn(this,"fetchedFieldsCache",void 0),jn(this,"fetchFields",(async(e,t)=>{if(this.fetchedFieldsCache&&Date.now()-this.fetchedFieldsCache.time<3e4&&(0,m.sortedUniq)(this.fetchedFieldsCache.logGroups).join("|")===(0,m.sortedUniq)(e).join("|"))return this.fetchedFieldsCache.fields;const n=await Promise.all(e.map((e=>this.datasource.getLogGroupFields({logGroupName:e,region:t})))),r=[...new Set(n.reduce(((e,t)=>{var n;return e.concat(null===(n=t.logGroupFields)||void 0===n?void 0:n.map((e=>e.name)))}),[])).values()];return this.fetchedFieldsCache={time:Date.now(),logGroups:e,fields:r},r})),jn(this,"handleKeyword",(async e=>{var t;const n=await this.getFieldCompletionItems(null!==(t=null==e?void 0:e.logGroupNames)&&void 0!==t?t:[],(null==e?void 0:e.region)||"default"),r=[{searchFunctionType:l.SearchFunctionType.Prefix,label:"Functions",items:J.concat(z,X)}];return n.suggestions.push(...r),n})),jn(this,"handleCommand",(async(e,t,n)=>{var r;const i=e.content.toLowerCase(),a=Rn(t),s=a===e;if("sort"===i)return this.handleSortCommand(s,t,n);var o;if("parse"===i&&s)return await this.getFieldCompletionItems(null!==(o=null==n?void 0:n.logGroupNames)&&void 0!==o?o:[],(null==n?void 0:n.region)||"default");const l=Fn(e.next,"whitespace")&&!(null!==(r=e.next)&&void 0!==r&&r.next),u=l||function(e){let t=e;for(;t.next;){if(!t.next.types.includes("whitespace"))return t.next;t=t.next}return null}(e)===t,c=Fn(t,"punctuation",","),d=c||Fn(a,"punctuation",",");if(!u&&!d)return{suggestions:[]};if(["display","fields"].includes(i)){var p;const e=await this.getFieldCompletionItems(null!==(p=null==n?void 0:n.logGroupNames)&&void 0!==p?p:[],(null==n?void 0:n.region)||"default");return e.suggestions.push(...this.getFieldAndFilterFunctionCompletionItems().suggestions),e}if("stats"===i){const e=this.getStatsAggCompletionItems();return(c||l)&&(null==e||e.suggestions.forEach((e=>{e.skipFilter=!0}))),e}if("filter"===i&&s){var m;const e=await this.getFieldCompletionItems(null!==(m=null==n?void 0:n.logGroupNames)&&void 0!==m?m:[],(null==n?void 0:n.region)||"default"),t=this.getBoolFuncCompletionItems();return e.suggestions.push(...t.suggestions),e}return{suggestions:[]}})),jn(this,"handleComparison",(async e=>{var t;const n=await this.getFieldCompletionItems(null!==(t=null==e?void 0:e.logGroupNames)&&void 0!==t?t:[],(null==e?void 0:e.region)||"default"),r=this.getComparisonCompletionItems();return n.suggestions.push(...r.suggestions),n})),jn(this,"getCommandCompletionItems",(()=>({suggestions:[{searchFunctionType:l.SearchFunctionType.Prefix,label:"Commands",items:U}]}))),jn(this,"getFieldAndFilterFunctionCompletionItems",(()=>({suggestions:[{searchFunctionType:l.SearchFunctionType.Prefix,label:"Functions",items:te}]}))),jn(this,"getStatsAggCompletionItems",(()=>({suggestions:[{searchFunctionType:l.SearchFunctionType.Prefix,label:"Functions",items:Z}]}))),jn(this,"getBoolFuncCompletionItems",(()=>({suggestions:[{searchFunctionType:l.SearchFunctionType.Prefix,label:"Functions",items:Y}]}))),jn(this,"getComparisonCompletionItems",(()=>({suggestions:[{searchFunctionType:l.SearchFunctionType.Prefix,label:"Functions",items:H.concat(Y)}]}))),jn(this,"getFieldCompletionItems",(async(e,t)=>({suggestions:[{label:"Fields",items:(await this.fetchFields(e,t)).map((e=>({label:e,insertText:e.match(/@?[_a-zA-Z]+[_.0-9a-zA-Z]*/)?void 0:`\`${e}\``})))}]}))),this.datasource=e,Object.assign(this,t)}getSyntax(){return re}isStatsQuery(e){var t;const n=this.getSyntax();return!!(null!==(t=_().tokenize(e,n))&&void 0!==t?t:[]).find((e=>"string"!=typeof e&&"stats"===e.content.toString().toLowerCase()&&"query-command"===e.type))}async provideCompletionItems(e,t){const{value:n}=e,r=null==n?void 0:n.data.get("tokens");if(!r||!r.length)return{suggestions:[]};const i=r.filter((e=>{var t,r,i,a;return e.offsets.start<=(null===(t=n.selection)||void 0===t||null===(r=t.start)||void 0===r?void 0:r.offset)&&e.offsets.end>=(null===(i=n.selection)||void 0===i||null===(a=i.start)||void 0===a?void 0:a.offset)}))[0],a=!i.prev,s=Rn(i);if(a||!a&&(null==s?void 0:s.types.includes("command-separator")))return this.getCommandCompletionItems();var o;if(function(e){const t=Rn(e);if(!t)return!1;const n="("===e.content?e:"("===t.content?t:void 0;if(n){const e=Rn(n);if(e)return On.includes(e.content.toLowerCase())&&e.types.includes("function")}return!1}(i))return await this.getFieldCompletionItems(null!==(o=null==t?void 0:t.logGroupNames)&&void 0!==o?o:[],(null==t?void 0:t.region)||"default");if(function(e,t){const n=Mn(t,["whitespace","function","punctuation","field-name","number"]);if(Fn(n,"keyword","by")){const e=Mn(t,["whitespace"]);if(e===n||Fn(e,"punctuation",","))return!0}return!1}(0,i))return this.handleKeyword(t);if(null!=s&&s.types.includes("comparison-operator"))return this.handleComparison(t);const l=function(e){let t=e;for(;t.prev;)if(t=t.prev,t.types.includes("query-command")&&(!t.prev||Fn(Rn(t),"command-separator")))return t;return null}(i);return l?await this.handleCommand(l,i,t):{suggestions:[]}}async handleSortCommand(e,t,n){var r;return e?await this.getFieldCompletionItems(null!==(r=null==n?void 0:n.logGroupNames)&&void 0!==r?r:[],(null==n?void 0:n.region)||"default"):Fn(Rn(t),"field-name")?{suggestions:[{searchFunctionType:l.SearchFunctionType.Prefix,label:"Sort Order",items:[{label:"asc"},{label:"desc"}]}]}:{suggestions:[]}}}function Rn(e){let t=e;for(;t.prev;){if(!Fn(t.prev,"whitespace"))return t.prev;t=t.prev}return null}const On=["avg","count","count_distinct","earliest","latest","sortsFirst","sortsLast","max","min","pct","stddev","ispresent","fromMillis","toMillis","isempty","isblank","isValidIp","isValidIpV4","isValidIpV6","isIpInSubnet","isIpv4InSubnet","isIpv6InSubnet"].map((e=>e.toLowerCase()));function Fn(e,t,n){return!(null==e||!e.types.includes(t))&&(!n||(null==e?void 0:e.content.toLowerCase())===n)}function Mn(e,t){let n=e.prev;e:for(;n;){for(const e of t)if("string"==typeof e){if(n.types.includes(e)){n=n.prev;continue e}}else if(n.types.includes(e.type)&&n.content.toLowerCase()===e.value){n=n.prev;continue e}break}return n}const Dn=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:7e3;const n=(0,m.memoize)((function(){return(0,m.debounce)(e,t,{leading:!0})}),(function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return JSON.stringify(t)}));return function(){return n(...arguments)(...arguments)}};var kn=n(67929);const Nn={Parenthesis:"delimiter.parenthesis.cloudwatch-MetricMath",Whitespace:"white.cloudwatch-MetricMath",Keyword:"keyword.cloudwatch-MetricMath",Delimiter:"delimiter.cloudwatch-MetricMath",Operator:"operator.cloudwatch-MetricMath",Identifier:"identifier.cloudwatch-MetricMath",Type:"type.cloudwatch-MetricMath",Function:"predefined.cloudwatch-MetricMath",Number:"number.cloudwatch-MetricMath",String:"string.cloudwatch-MetricMath",Variable:"variable.cloudwatch-MetricMath"};function Pn(e){const t=null==e?void 0:e.getPreviousNonWhiteSpaceToken();if(e&&e.isString())return At.WithinString;if(e&&t){const n=e.getPreviousOfType(Nn.Function),r=t.is(Nn.Delimiter,","),i=n&&"SEARCH"===n.value,a=e.getPreviousUntil(Nn.Function,[],"SEARCH")||[];if(i){if(1===a.filter((e=>{let{value:t}=e;return"'"===t})).length)return At.WithinString;const e=t.getPreviousOfType(Nn.Delimiter,",");if(e){if(e.range.startColumn>n.range.startColumn&&e.range.startLineNumber>=n.range.startLineNumber)return At.SearchFuncThirdArg}return At.SearchFuncSecondArg}if(!i&&r)return At.PredefinedFuncSecondArg}return null!=t&&t.endsWith(")")?At.AfterFunction:e&&e.isString()?At.Unknown:At.PredefinedFunction}function qn(e){switch(e){case At.PredefinedFunction:return[Rt.FunctionsWithArguments];case At.PredefinedFuncSecondArg:return[Rt.FunctionsWithArguments,Rt.KeywordArguments];case At.AfterFunction:return[Rt.Operators];case At.SearchFuncSecondArg:return[Rt.Statistic];case At.SearchFuncThirdArg:return[Rt.Period]}return[]}class Ln extends vn{constructor(e){super(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,o.getTemplateSrv)()),this.getStatementPosition=Pn,this.getSuggestionKinds=qn,this.tokenTypes=Nn}async getSuggestions(e,t,n,r,i){let a=[];const s=(null==t?void 0:t.isWhiteSpace())||(null==t?void 0:t.isParenthesis())||null==t||!t.range?e.Range.fromPositions(i):null==t?void 0:t.range,o=function(t){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const r=Object.assign({label:t,insertText:t,kind:e.languages.CompletionItemKind.Field,range:s,sortText:Ot.Medium},n);return r};function l(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};a=[...a,o(e,t)]}for(const t of n)switch(t){case Rt.FunctionsWithArguments:kn.METRIC_MATH_FNS.map((t=>l(t,{insertText:"SEARCH"===t?`${t}('$0')`:`${t}($0)`,insertTextRules:e.languages.CompletionItemInsertTextRule.InsertAsSnippet,command:St,kind:e.languages.CompletionItemKind.Function})));break;case Rt.KeywordArguments:kn.METRIC_MATH_KEYWORDS.map((t=>l(t,{insertText:t,command:St,kind:e.languages.CompletionItemKind.Keyword,sortText:Ot.MediumHigh})));break;case Rt.Statistic:kn.METRIC_MATH_STATISTIC_KEYWORD_STRINGS.map((e=>l(e,{insertText:`'${e}', `,command:St})));break;case Rt.Operators:kn.METRIC_MATH_OPERATORS.map((e=>l(e,{insertText:`${e} `,command:St})));break;case Rt.Period:kn.METRIC_MATH_PERIODS.map(((t,n)=>l(t.toString(),{kind:e.languages.CompletionItemKind.Value,sortText:String.fromCharCode(97+n)})))}return this.templateVariables.map((t=>{l(t,{range:s,label:t,insertText:t,kind:e.languages.CompletionItemKind.Variable,sortText:Ot.Low})})),a}}async function Kn(e,t){let n;try{n=await(0,o.getDataSourceSrv)().get(e)}catch(e){return void console.error("Could not load linked xray data source, it was probably deleted after it was linked",e)}return{title:n.name,url:"",internal:{query:{query:"${__value.raw}",queryType:"getTrace",region:t},datasourceUid:e,datasourceName:n.name}}}function $n(e,t,n,r,i){var a,s;const o=e.expression?r(e.expression):"",l=null!==(a=null===(s=e.logGroupNames)||void 0===s?void 0:s.flatMap(i))&&void 0!==a?a:[];return{url:we({end:t.to.toISOString(),start:t.from.toISOString(),timeType:"ABSOLUTE",tz:"UTC",editorString:o,isLiveTail:!1,source:l},n),title:"View in CloudWatch console",targetBlank:!0}}function Vn(e,t,n){const r=new Date;let i,a,s=0,l={};return new en.y((u=>(function t(c){a=e(c).subscribe({next(e){const t=(0,o.toDataQueryResponse)({data:{results:l}}).data||[];u.next({frames:[...t,...e]}),u.complete()},error(e){if("string"==typeof e)return void u.error(e);const a=function(e){var t;const n=null===(t=e.data)||void 0===t?void 0:t.results;if(!n)return;return Object.keys(n).reduce(((t,r)=>{var i;return null!==(i=n[r].error)&&void 0!==i&&i.startsWith("LimitExceededException")?(t.errorMessage=n[r].error,t.errors.push(e.config.data.queries.find((e=>e.refId===r)))):t.good[r]=n[r],t}),{errors:[],good:{},errorMessage:""})}(e);var c;if(a)if(a.errors.length)if(n(s,r.valueOf()))if(Object.keys(l).length||Object.keys(a.good).length){var d,p,m;const e=(0,o.toDataQueryResponse)({data:{results:Object.assign({},null!==(d=a.good)&&void 0!==d?d:{},null!==(p=l)&&void 0!==p?p:{})}});e.error=Object.assign({},null!==(m=e.error)&&void 0!==m?m:{},{message:`Some queries timed out: ${a.errorMessage}`}),u.next({error:e.error,frames:e.data}),u.complete()}else{var h,g;const t=(0,o.toDataQueryResponse)({data:{results:null!==(h=null===(g=e.data)||void 0===g?void 0:g.results)&&void 0!==h?h:{}}});u.error(t.error)}else l=Object.assign({},l,a.good),i=setTimeout((()=>{s++,t(a.errors)}),(c=s+1,1e3*Math.pow(2,c)+100*Math.random()));else u.error(e);else u.error(e)}})}(t),()=>{clearTimeout(i),a.unsubscribe()})))}var Qn=n(56861);function Bn(e){if(!e)return;const{subscriber:t,counter:n,period:r,step:i,endPeriod:a}=e;t.next(n);const s=Math.min(r+i,a);this.schedule({subscriber:t,counter:n+1,period:s,step:i,endPeriod:a},s)}const Wn=/\${(\w+):json}/g;function _n(e){const t=e.replace(Wn,'"$$$1"'),n=JSON.parse(t),r={};return Object.keys(n).forEach((e=>{const t=n[e];"string"==typeof t?r[e]=[t]:void 0!==t&&(r[e]=t)})),r}function Gn(e){if(function(e){return"string"!=typeof e&&"string"!=typeof e.ec2Filters&&"string"!=typeof e.tags}(e))return e;if("string"!=typeof e){const t=(0,m.omit)(e,["dimensionFilters","ec2Filters","tags"]);if(t.dimensionFilters={},t.ec2Filters={},t.tags={},""!==e.dimensionFilters&&"[]"!==e.ec2Filters){const n=e.dimensionFilters.replace(Wn,'"$$$1"');try{t.dimensionFilters=JSON.parse(n)}catch{throw new Error(`unable to migrate poorly formed filters: ${e.dimensionFilters}`)}}if(""!==e.ec2Filters&&"[]"!==e.ec2Filters)try{t.ec2Filters=_n(e.ec2Filters)}catch{throw new Error(`unable to migrate poorly formed filters: ${e.ec2Filters}`)}if(""!==e.tags&&"[]"!==e.tags)try{t.tags=_n(e.tags)}catch{throw new Error(`unable to migrate poorly formed filters: ${e.tags}`)}return t}const t={refId:"CloudWatchVariableQueryEditor-VariableQuery",queryType:qe.wf.Regions,namespace:"",region:"",metricName:"",dimensionKey:"",dimensionFilters:{},ec2Filters:{},instanceID:"",attributeName:"",resourceType:"",tags:{}};if(""===e)return t;if(e.match(/^regions\(\)/))return t;if(e.match(/^namespaces\(\)/))return t.queryType=qe.wf.Namespaces,t;const n=e.match(/^metrics\(([^\)]+?)(,\s?([^,]+?))?\)/);if(n)return t.queryType=qe.wf.Metrics,t.namespace=n[1],t.region=n[3]||"",t;const r=e.match(/^dimension_keys\(([^\)]+?)(,\s?([^,]+?))?\)/);if(r)return t.queryType=qe.wf.DimensionKeys,t.namespace=r[1],t.region=r[3]||"",t;const i=e.match(/^dimension_values\(([^,]+?),\s?([^,]+?),\s?([^,]+?),\s?([^,]+?)(,\s?(.+))?\)/);if(i){if(t.queryType=qe.wf.DimensionValues,t.region=i[1],t.namespace=i[2],t.metricName=i[3],t.dimensionKey=i[4],t.dimensionFilters={},i[6]&&"[]"!==i[6]){const e=i[6].replace(Wn,'"$$$1"');try{t.dimensionFilters=JSON.parse(e)}catch{throw new Error(`unable to migrate poorly formed filters: ${i[6]}`)}}return t}const a=e.match(/^ebs_volume_ids\(([^,]+?),\s?([^,]+?)\)/);if(a)return t.queryType=qe.wf.EBSVolumeIDs,t.region=a[1],t.instanceID=a[2],t;const s=e.match(/^ec2_instance_attribute\(([^,]+?),\s?([^,]+?),\s?(.+?)\)/);if(s){if(t.queryType=qe.wf.EC2InstanceAttributes,t.region=s[1],t.attributeName=s[2],s[3]&&"[]"!==s[3])try{t.ec2Filters=_n(s[3])}catch{throw new Error(`unable to migrate poorly formed filters: ${s[3]}`)}return t}const o=e.match(/^resource_arns\(([^,]+?),\s?([^,]+?),\s?(.+?)\)/);if(o){if(t.queryType=qe.wf.ResourceArns,t.region=o[1],t.resourceType=o[2],o[3]&&"[]"!==o[3])try{t.tags=_n(o[3])}catch{throw new Error(`unable to migrate poorly formed filters: ${o[3]}`)}return t}if(e.match(/^statistics\(\)/))return t.queryType=qe.wf.Statistics,t;throw new Error("unable to parse old variable query")}const Un=e=>{var t;let{filter:n,onChange:r,onDelete:a,keyPlaceholder:s}=e;const[o,u]=(0,i.useState)(n.key||""),[c,d]=(0,i.useState)((null===(t=n.value)||void 0===t?void 0:t.join(", "))||""),p=(0,l.useTheme2)(),m=Hn(p);return(0,f.jsx)("div",{"data-testid":"cloudwatch-multifilter-item",children:(0,f.jsxs)(he.InputGroup,{children:[(0,f.jsx)(l.Input,{"data-testid":"cloudwatch-multifilter-item-key","aria-label":"Filter key",value:o,placeholder:null!=s?s:"key",onChange:e=>u(e.currentTarget.value),onBlur:()=>{o&&o!==n.key&&r(Object.assign({},n,{key:o}))}}),(0,f.jsx)("span",{className:(0,x.cx)(m.root),children:"="}),(0,f.jsx)(l.Input,{"data-testid":"cloudwatch-multifilter-item-value","aria-label":"Filter value",value:c,placeholder:"value1, value2,...",onChange:e=>d(e.currentTarget.value),onBlur:()=>{const e=c.split(",").map((e=>e.trim()));c&&e!==n.value&&r(Object.assign({},n,{value:e})),d(e.join(", "))}}),(0,f.jsx)(he.AccessoryButton,{"aria-label":"remove",icon:"times",variant:"secondary",onClick:a,type:"button"})]})})},Hn=(0,l.stylesFactory)((e=>({root:(0,x.css)({padding:e.spacing(0,1),alignSelf:"center"})}))),Jn=e=>{let{filters:t,onChange:n,keyPlaceholder:r}=e;const[a,s]=(0,i.useState)([]);(0,i.useEffect)((()=>s(t?(e=>Object.keys(e).map((t=>({key:t,value:e[t],operator:"="}))))(t):[])),[t]);return(0,f.jsx)(he.EditorList,{items:a,onChange:e=>{s(e);const r=(e=>{const t={};return e.forEach((e=>{let{key:n,value:r}=e;n&&r&&(t[n]=r)})),t})(e);(0,m.isEqual)(r,t)||n(r)},renderItem:zn(r)})};function zn(e){return function(t,n,r){return(0,f.jsx)(Un,{filter:t,onChange:e=>n(e),onDelete:r,keyPlaceholder:e})}}const Xn=e=>{let{label:t,onChange:n,value:r,options:i,allowCustomValue:a=!1,isLoading:s=!1,inputId:o=t}=e;return(0,f.jsx)(l.InlineField,{label:t,labelWidth:20,htmlFor:o,children:(0,f.jsx)(l.Select,{"aria-label":t,width:25,allowCustomValue:a,value:r,onChange:e=>{let{value:t}=e;return n(t)},options:i,isLoading:s,inputId:o})})},Yn=e=>{let{interactive:t,label:n,onBlur:r,placeholder:a,value:s,tooltip:o}=e;const[u,c]=(0,i.useState)(s);return(0,f.jsx)(l.InlineField,{interactive:t,label:n,labelWidth:20,tooltip:o,grow:!0,children:(0,f.jsx)(l.Input,{"aria-label":n,placeholder:a,value:u,onChange:e=>c(e.currentTarget.value),onBlur:()=>r(u)})})};var Zn,er;const tr=[{value:qe.wf.Regions,label:"Regions"},{value:qe.wf.Namespaces,label:"Namespaces"},{value:qe.wf.Metrics,label:"Metrics"},{value:qe.wf.DimensionKeys,label:"Dimension Keys"},{value:qe.wf.DimensionValues,label:"Dimension Values"},{value:qe.wf.EBSVolumeIDs,label:"EBS Volume IDs"},{value:qe.wf.EC2InstanceAttributes,label:"EC2 Instance Attributes"},{value:qe.wf.ResourceArns,label:"Resource ARNs"},{value:qe.wf.Statistics,label:"Statistics"},{value:qe.wf.LogGroups,label:"Log Groups"}],nr=e=>{var t;let{query:n,datasource:r,onChange:i}=e;const a=Gn(n),{region:s,namespace:o,metricName:u,dimensionKey:c,dimensionFilters:d}=a,[p,m]=Me(r),h=De(r),g=ke(r,s,o),v=Ne(r,s,o,u),y=Ne(r,s,o,u,null!=d?d:{}),b=e=>{i(Object.assign({},e,{refId:"CloudWatchVariableQueryEditor-VariableQuery"}))},x=async e=>{let{metricName:t,dimensionKey:n,dimensionFilters:i,namespace:a,region:s}=e;return t&&await r.getMetrics(a,s).then((e=>{e.find((e=>e.value===t))||(t="")})),n&&await r.getDimensionKeys(a,s).then((e=>{e.find((e=>e.value===n))||(n="",i={})})),Object.assign({},e,{metricName:t,dimensionKey:n,dimensionFilters:i})},S=[qe.wf.Metrics,qe.wf.DimensionKeys,qe.wf.DimensionValues,qe.wf.EBSVolumeIDs,qe.wf.EC2InstanceAttributes,qe.wf.ResourceArns,qe.wf.LogGroups].includes(a.queryType),w=[qe.wf.Metrics,qe.wf.DimensionKeys,qe.wf.DimensionValues].includes(a.queryType);return(0,f.jsxs)(f.Fragment,{children:[(0,f.jsx)(Xn,{value:a.queryType,options:tr,onChange:e=>b(Object.assign({},a,{queryType:e})),label:"Query type",inputId:`variable-query-type-${n.refId}`}),S&&(0,f.jsx)(Xn,{value:s,options:p,onChange:e=>(async e=>{const t=await x(Object.assign({},a,{region:e}));b(t)})(e),label:"Region",isLoading:m,inputId:`variable-query-region-${n.refId}`}),w&&(0,f.jsx)(Xn,{value:o,options:h,onChange:e=>(async e=>{const t=await x(Object.assign({},a,{namespace:e}));b(t)})(e),label:"Namespace",inputId:`variable-query-namespace-${n.refId}`,allowCustomValue:!0}),a.queryType===qe.wf.DimensionValues&&(0,f.jsxs)(f.Fragment,{children:[(0,f.jsx)(Xn,{value:u||null,options:g,onChange:e=>b(Object.assign({},a,{metricName:e})),label:"Metric",inputId:`variable-query-metric-${n.refId}`,allowCustomValue:!0}),(0,f.jsx)(Xn,{value:c||null,options:v,onChange:e=>b(Object.assign({},a,{dimensionKey:e})),label:"Dimension key",inputId:`variable-query-dimension-key-${n.refId}`,allowCustomValue:!0}),(0,f.jsx)(l.InlineField,{label:"Dimensions",labelWidth:20,tooltip:"Dimensions to filter the returned values on",children:(0,f.jsx)(be,{metricStat:Object.assign({},a,{dimensions:a.dimensionFilters}),onChange:e=>{i(Object.assign({},a,{dimensionFilters:e}))},dimensionKeys:y,disableExpressions:!0,datasource:r})})]}),a.queryType===qe.wf.EBSVolumeIDs&&(0,f.jsx)(Yn,{value:n.instanceID,placeholder:"i-XXXXXXXXXXXXXXXXX",onBlur:e=>b(Object.assign({},a,{instanceID:e})),label:"Instance ID"}),a.queryType===qe.wf.EC2InstanceAttributes&&(0,f.jsxs)(f.Fragment,{children:[(0,f.jsx)(Yn,{value:a.attributeName,onBlur:e=>b(Object.assign({},a,{attributeName:e})),label:"Attribute name",interactive:!0,tooltip:(0,f.jsxs)(f.Fragment,{children:['Attribute or tag to query on. Tags should be formatted "Tags.<name>". ',Zn||(Zn=(0,f.jsx)("a",{href:"https://grafana.com/docs/grafana/latest/datasources/aws-cloudwatch/template-queries-cloudwatch/#selecting-attributes",target:"_blank",rel:"noreferrer",children:"See the documentation for more details"}))]})}),(0,f.jsx)(l.InlineField,{label:"Filters",labelWidth:20,tooltip:(0,f.jsxs)(f.Fragment,{children:[er||(er=(0,f.jsx)("a",{href:"https://grafana.com/docs/grafana/latest/datasources/aws-cloudwatch/template-queries-cloudwatch/#selecting-attributes",target:"_blank",rel:"noreferrer",children:"Pre-defined ec2:DescribeInstances filters/tags"}))," and the values to filter on. Tags should be formatted tag:<name>."]}),children:(0,f.jsx)(Jn,{filters:a.ec2Filters,onChange:e=>{i(Object.assign({},a,{ec2Filters:e}))},keyPlaceholder:"filter/tag"})})]}),a.queryType===qe.wf.ResourceArns&&(0,f.jsxs)(f.Fragment,{children:[(0,f.jsx)(Yn,{value:a.resourceType,onBlur:e=>b(Object.assign({},a,{resourceType:e})),label:"Resource type"}),(0,f.jsx)(l.InlineField,{label:"Tags",labelWidth:20,tooltip:"Tags to filter the returned values on.",children:(0,f.jsx)(Jn,{filters:a.tags,onChange:e=>{i(Object.assign({},a,{tags:e}))},keyPlaceholder:"tag"})})]}),a.queryType===qe.wf.LogGroups&&(0,f.jsx)(Yn,{value:null!==(t=n.logGroupPrefix)&&void 0!==t?t:"",onBlur:e=>b(Object.assign({},a,{logGroupPrefix:e})),label:"Log group prefix"})]})};function rr(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class ir extends r.CustomVariableSupport{constructor(e){super(),rr(this,"datasource",void 0),rr(this,"editor",nr),this.datasource=e,this.query=this.query.bind(this)}query(e){const t=Gn(e.targets[0]);return(0,Jt.D)(this.execute(t)).pipe((0,nn.U)((e=>({data:e}))))}async execute(e){try{switch(e.queryType){case qe.wf.Regions:return this.handleRegionsQuery();case qe.wf.Namespaces:return this.handleNamespacesQuery();case qe.wf.Metrics:return this.handleMetricsQuery(e);case qe.wf.DimensionKeys:return this.handleDimensionKeysQuery(e);case qe.wf.DimensionValues:return this.handleDimensionValuesQuery(e);case qe.wf.EBSVolumeIDs:return this.handleEbsVolumeIdsQuery(e);case qe.wf.EC2InstanceAttributes:return this.handleEc2InstanceAttributeQuery(e);case qe.wf.ResourceArns:return this.handleResourceARNsQuery(e);case qe.wf.Statistics:return this.handleStatisticsQuery();case qe.wf.LogGroups:return this.handleLogGroupsQuery(e)}}catch(t){return console.error(`Could not run CloudWatchMetricFindQuery ${e}`,t),[]}}async handleLogGroupsQuery(e){let{region:t,logGroupPrefix:n}=e;return(await this.datasource.describeLogGroups({region:t,logGroupNamePrefix:n})).map((e=>({text:e,value:e,expandable:!0})))}async handleRegionsQuery(){return(await this.datasource.getRegions()).map((e=>({text:e.label,value:e.value,expandable:!0})))}async handleNamespacesQuery(){return(await this.datasource.getNamespaces()).map((e=>({text:e.label,value:e.value,expandable:!0})))}async handleMetricsQuery(e){let{namespace:t,region:n}=e;return(await this.datasource.getMetrics(t,n)).map((e=>({text:e.label,value:e.value,expandable:!0})))}async handleDimensionKeysQuery(e){let{namespace:t,region:n}=e;return(await this.datasource.getDimensionKeys(t,n)).map((e=>({text:e.label,value:e.value,expandable:!0})))}async handleDimensionValuesQuery(e){let{namespace:t,region:n,dimensionKey:r,metricName:i,dimensionFilters:a}=e;if(!r||!i)return[];return(await this.datasource.getDimensionValues(n,t,i,r,null!=a?a:{})).map((e=>({text:e.label,value:e.value,expandable:!0})))}async handleEbsVolumeIdsQuery(e){let{region:t,instanceID:n}=e;if(!n)return[];return(await this.datasource.getEbsVolumeIds(t,n)).map((e=>({text:e.label,value:e.value,expandable:!0})))}async handleEc2InstanceAttributeQuery(e){let{region:t,attributeName:n,ec2Filters:r}=e;if(!n)return[];return(await this.datasource.getEc2InstanceAttribute(t,n,null!=r?r:{})).map((e=>({text:e.label,value:e.value,expandable:!0})))}async handleResourceARNsQuery(e){let{region:t,resourceType:n,tags:r}=e;if(!n)return[];return(await this.datasource.getResourceARNs(t,n,null!=r?r:{})).map((e=>({text:e.label,value:e.value,expandable:!0})))}async handleStatisticsQuery(){return this.datasource.standardStatistics.map((e=>({text:e,value:e,expandable:!0})))}}function ar(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}const sr="/api/ds/query",or="__log__grafana_internal__",lr="__logstream__grafana_internal__",ur=(e,t)=>p.h.dispatch((0,u.$l)((0,c.t_)(`CloudWatch request limit reached in ${t} for data source ${e}`,"",void 0,i.createElement(Tn,{region:t},null)))),cr=(e,t)=>p.h.dispatch((0,u.$l)((0,c.t_)(e,t)));class dr extends o.DataSourceWithBackend{constructor(e){var t;let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,Je.J)(),i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:(0,mn.$t)();super(e),t=this,ar(this,"proxyUrl",void 0),ar(this,"defaultRegion",void 0),ar(this,"datasourceName",void 0),ar(this,"languageProvider",void 0),ar(this,"sqlCompletionItemProvider",void 0),ar(this,"metricMathCompletionItemProvider",void 0),ar(this,"tracingDataSourceUid",void 0),ar(this,"logsTimeout",void 0),ar(this,"defaultLogGroups",void 0),ar(this,"type","cloudwatch"),ar(this,"standardStatistics",["Average","Maximum","Minimum","Sum","SampleCount"]),ar(this,"debouncedAlert",Dn(ur,hn.bd.Error)),ar(this,"debouncedCustomAlert",Dn(cr,hn.bd.Error)),ar(this,"logQueries",{}),ar(this,"handleLogQueries",((e,t)=>{const n=e.map((e=>({queryString:e.expression||"",refId:e.refId,logGroupNames:e.logGroupNames||this.defaultLogGroups,region:this.replace(this.getActualRegion(e.region),t.scopedVars,!0,"region")}))),i=n.filter((e=>{var t;return null===(t=e.logGroupNames)||void 0===t?void 0:t.length}));if(e.length>i.length)return(0,Ht.of)({data:[],error:{message:"Log group is required"}});if((0,m.isEmpty)(i))return(0,Ht.of)({data:[],state:r.LoadingState.Done});const a=new Date,s=()=>Date.now()>=a.valueOf()+r.rangeUtil.intervalToMs(this.logsTimeout);return Vn((e=>this.makeLogActionRequest("StartQuery",e,{makeReplacements:!0,scopedVars:t.scopedVars,skipCache:!0})),n,s).pipe((0,tn.z)((t=>{let{frames:n,error:r}=t;return this.logsQuery(n.map((t=>{var n,r,i;return{queryId:t.fields[0].values.get(0),region:null!==(n=null===(r=t.meta)||void 0===r||null===(i=r.custom)||void 0===i?void 0:i.Region)&&void 0!==n?n:"default",refId:t.refId,statsGroups:e.find((e=>e.refId===t.refId)).statsGroups}})),s).pipe((0,nn.U)((e=>(!e.error&&r&&(e.error=r),e))))})),(0,tn.z)((e=>(0,Jt.D)((async()=>(await async function(e,t,n,r,i,a,s){const o=(e,n)=>r(e,t.scopedVars,!0,n),l=e=>i(e,t.scopedVars);for(const r of e.data){var u;const e=t.targets.find((e=>e.refId===r.refId)),i=a(o(null!==(u=e.region)&&void 0!==u?u:"","region"));for(const t of r.fields)if("@xrayTraceId"===t.name&&s){var c;a(o(null!==(c=e.region)&&void 0!==c?c:"","region"));const n=await Kn(s,i);n&&(t.config.links=[n])}else t.config.links=[$n(e,n,i,o,l)]}}(e,t,this.timeSrv.timeRange(),this.replace.bind(this),this.expandVariableToArray.bind(this),this.getActualRegion.bind(this),this.tracingDataSourceUid),e))()))))})),ar(this,"handleMetricQueries",((e,t)=>{var n,i;const a=(0,r.dateTimeFormat)(Date.now(),{timeZone:t.timezone,format:"Z"}).replace(":",""),s=e.filter(this.filterMetricQuery).map((e=>{const n=Lt(e),r=this.replaceMetricQueryVars(n,t);return Object.assign({timezoneUTCOffset:a,intervalMs:t.intervalMs,maxDataPoints:t.maxDataPoints},r,{type:"timeSeriesQuery",datasource:this.getRef()})}));if((0,m.isEmpty)(s))return(0,Ht.of)({data:[]});const o={from:null==t||null===(n=t.range)||void 0===n?void 0:n.from.valueOf().toString(),to:null==t||null===(i=t.range)||void 0===i?void 0:i.to.valueOf().toString(),queries:s};return this.performTimeSeriesQuery(o,t.range)})),ar(this,"getLogRowContext",(async function(e){let{limit:n=10,direction:r="BACKWARD"}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2?arguments[2]:void 0,a=null,s=null;for(const t of e.dataFrame.fields)if(t.name===lr){if(a=t,null!==s)break}else if(t.name===or&&(s=t,null!==a))break;const o={limit:n,startFromHead:"BACKWARD"!==r,region:null==i?void 0:i.region,logGroupName:pr(s.values.get(e.rowIndex)),logStreamName:a.values.get(e.rowIndex)};"BACKWARD"===r?o.endTime=e.timeEpochMs:o.startTime=e.timeEpochMs;const l=await(0,zt.n)(t.makeLogActionRequest("GetLogEvents",[o]));return{data:l}})),ar(this,"getTargetsByQueryMode",(e=>{const t=[],n=[],r=[];return e.forEach((e=>{me(e)?r.push(e):de(e)?t.push(e):n.push(e)})),{logQueries:t,metricsQueries:n,annotationQueries:r}})),this.templateSrv=n,this.timeSrv=i,this.proxyUrl=e.url,this.defaultRegion=e.jsonData.defaultRegion,this.datasourceName=e.name,this.languageProvider=new An(this),this.tracingDataSourceUid=e.jsonData.tracingDatasourceUid,this.logsTimeout=e.jsonData.logsTimeout||"15m",this.defaultLogGroups=e.jsonData.defaultLogGroups||[],this.sqlCompletionItemProvider=new In(this,this.templateSrv),this.metricMathCompletionItemProvider=new Ln(this,this.templateSrv),this.variables=new ir(this),this.annotations=gn}filterQuery(e){return!0!==e.hide||pe(e)&&""!==e.id}query(e){let t=(e=(0,m.cloneDeep)(e)).targets.filter(this.filterQuery);const{logQueries:n,metricsQueries:i,annotationQueries:a}=this.getTargetsByQueryMode(t),s=[];return n.length>0&&s.push(this.handleLogQueries(n,e)),i.length>0&&s.push(this.handleMetricQueries(i,e)),a.length>0&&s.push(this.handleAnnotationQuery(a,e)),(0,m.isEmpty)(s)?(0,Ht.of)({data:[],state:r.LoadingState.Done}):(0,Xt.T)(...s)}filterMetricQuery(e){const{region:t,metricQueryType:n,metricEditorMode:r,expression:i,metricName:a,namespace:s,sqlExpression:o,statistic:l}=e;if(!t)return!1;if(n===qe.$5.Search&&r===qe.MQ.Builder)return!!s&&!!a&&!!l;if(n===qe.$5.Search&&r===qe.MQ.Code)return!!i;if(n===qe.$5.Query)return!!o;throw new Error("invalid metric editor mode")}replaceMetricQueryVars(e,t){var n;return e.region=this.templateSrv.replace(this.getActualRegion(e.region),t.scopedVars),e.namespace=this.replace(e.namespace,t.scopedVars,!0,"namespace"),e.metricName=this.replace(e.metricName,t.scopedVars,!0,"metric name"),e.dimensions=this.convertDimensionFormat(null!==(n=e.dimensions)&&void 0!==n?n:{},t.scopedVars),e.statistic=this.templateSrv.replace(e.statistic,t.scopedVars),e.period=String(this.getPeriod(e,t)),e.id=this.templateSrv.replace(e.id,t.scopedVars),e.expression=this.templateSrv.replace(e.expression,t.scopedVars),e.sqlExpression=this.templateSrv.replace(e.sqlExpression,t.scopedVars,"raw"),e}handleAnnotationQuery(e,t){return this.awsRequest(sr,{from:t.range.from.valueOf().toString(),to:t.range.to.valueOf().toString(),queries:e.map((e=>{var t,n,r,i;return Object.assign({},e,{statistic:this.templateSrv.replace(e.statistic),region:this.templateSrv.replace(this.getActualRegion(e.region)),namespace:this.templateSrv.replace(e.namespace),metricName:this.templateSrv.replace(e.metricName),dimensions:this.convertDimensionFormat(null!==(t=e.dimensions)&&void 0!==t?t:{},{}),period:null!==(n=e.period)&&void 0!==n?n:"",actionPrefix:null!==(r=e.actionPrefix)&&void 0!==r?r:"",alarmNamePrefix:null!==(i=e.alarmNamePrefix)&&void 0!==i?i:"",type:"annotationQuery",datasource:this.getRef()})}))}).pipe((0,nn.U)((e=>({data:(0,o.toDataQueryResponse)({data:e}).data}))))}logsQuery(e,t){this.logQueries={},e.forEach((e=>{var t,n,r;this.logQueries[e.refId]={id:e.queryId,region:e.region,statsQuery:null!==(t=(null!==(n=null===(r=e.statsGroups)||void 0===r?void 0:r.length)&&void 0!==n?n:0)>0)&&void 0!==t&&t}}));const n=function(e){let{startPeriod:t=0,endPeriod:n=5e3,step:r=1e3}=e,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Qn.z;return new en.y((e=>{const a={subscriber:e,counter:0,period:t,step:r,endPeriod:n};return e.add(i.schedule(Bn,t,a)),e}))}({startPeriod:100,endPeriod:1e3,step:300}).pipe((0,rn.b)((t=>this.makeLogActionRequest("GetQueryResults",e,{skipCache:!0}))),(0,an.r)(),(0,sn.B)()),i=n.pipe((0,on.R)(((e,t)=>{let{failures:n,prevRecordsMatched:r}=e;n++;for(const e of t){var i,a,s,o;const t=null===(i=e.meta)||void 0===i||null===(a=i.stats)||void 0===a||null===(s=a.find((e=>"Records scanned"===e.displayName)))||void 0===s?void 0:s.value;t>(null!==(o=r[e.refId])&&void 0!==o?o:0)&&(n=0),r[e.refId]=t}return{failures:n,prevRecordsMatched:r}}),{failures:0,prevRecordsMatched:{}}),(0,nn.U)((e=>{let{failures:t}=e;return t})),(0,sn.B)()),a=(0,Yt.$)(n,i).pipe((0,ln.b)((e=>{let[t]=e;for(const e of t){var n,r;[qe.KB.Complete,qe.KB.Cancelled,qe.KB.Failed].includes(null===(n=e.meta)||void 0===n||null===(r=n.custom)||void 0===r?void 0:r.Status)&&this.logQueries.hasOwnProperty(e.refId)&&delete this.logQueries[e.refId]}})),(0,nn.U)((e=>{let[n,i]=e;if(t())for(const e of n)(0,m.set)(e,"meta.custom.Status",qe.KB.Cancelled);return{data:n,key:"test-key",state:n.every((e=>{var t,n;return[qe.KB.Complete,qe.KB.Cancelled,qe.KB.Failed].includes(null===(t=e.meta)||void 0===t||null===(n=t.custom)||void 0===n?void 0:n.Status)}))?r.LoadingState.Done:r.LoadingState.Loading,error:t()?{message:`error: query timed out after ${i} attempts`,type:r.DataQueryErrorType.Timeout}:void 0}})),(0,un.o)((e=>{let{state:t}=e;return t!==r.LoadingState.Error&&t!==r.LoadingState.Done}),!0));return s=a,o=()=>this.stopQueries(),new en.y((e=>{const t=s.subscribe({next:t=>e.next(t),error:t=>e.next(t),complete:()=>e.complete()});return()=>{t.unsubscribe(),o()}}));var s,o}stopQueries(){Object.keys(this.logQueries).length>0&&this.makeLogActionRequest("StopQuery",Object.values(this.logQueries).map((e=>({queryId:e.id,region:e.region}))),{makeReplacements:!1,skipCache:!0}).pipe((0,cn.x)((()=>{this.logQueries={}})))}async describeLogGroups(e){var t,n,r;return null!==(t=null===(n=(await(0,zt.n)(this.makeLogActionRequest("DescribeLogGroups",[e])))[0])||void 0===n||null===(r=n.fields[0])||void 0===r?void 0:r.values.toArray())&&void 0!==t?t:[]}async getLogGroupFields(e){var t;const n=await(0,zt.n)(this.makeLogActionRequest("GetLogGroupFields",[e])),r=n[0].fields[0].values.toArray(),i=n[0].fields[1].values.toArray();return{logGroupFields:null!==(t=r.map(((e,t)=>({name:e,percent:i[t]}))))&&void 0!==t?t:[]}}getVariables(){return this.templateSrv.getVariables().map((e=>`$${e.name}`))}getPeriod(e,t){let n=this.templateSrv.replace(e.period,t.scopedVars);return n&&"auto"!==n.toLowerCase()&&(n=/^\d+$/.test(n)?parseInt(n,10):r.rangeUtil.intervalToSeconds(n),n<1&&(n=1)),n||""}performTimeSeriesQuery(e,t){let{from:n,to:i}=t;return this.awsRequest(sr,e).pipe((0,nn.U)((e=>{const t=(0,o.toDataQueryResponse)({data:e}).data;if(!t||t.length<=0)return{data:[]};const n=(0,m.findLast)(e.results,(e=>!!e.error));return t.forEach((e=>{e.fields.forEach((t=>{var n,i;t.type===r.FieldType.time&&(t.config.interval=1e3*(null===(n=e.meta)||void 0===n||null===(i=n.custom)||void 0===i?void 0:i.period))}))})),{data:t,error:n?{message:n.error}:null}})),(0,dn.K)((t=>{if(!t.data.results&&t.data&&"Metric request error"===t.data.message&&t.data.error)return t.message=t.data.error,(0,Zt._)((()=>t));const n=Object.values(t.data.results),r=n.find((e=>e.error));if(r&&(t.message=r.error),n.some((e=>e.error&&/^Throttling:.*/.test(e.error)))){const n=Object.keys(t.data.results);Object.values(e.queries).reduce(((e,t)=>{let{refId:r,region:i}=t;return r&&!n.includes(r)||e.includes(i)?e:[...e,i]}),[]).forEach((e=>{const t=this.getActualRegion(e);t&&this.debouncedAlert(this.datasourceName,t)}))}return(0,Zt._)((()=>t))})))}doMetricResourceRequest(e,t){return this.getResource(e,t)}makeLogActionRequest(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{makeReplacements:!0,skipCache:!1};const r=this.timeSrv.timeRange(),i={from:r.from.valueOf().toString(),to:r.to.valueOf().toString(),queries:t.map((t=>Object.assign({refId:t.refId||"A",intervalMs:1,maxDataPoints:1,datasource:this.getRef(),type:"logAction",subtype:e},t)))};n.makeReplacements&&i.queries.forEach((e=>{const t=["queryString","logGroupNames","logGroupName","logGroupNamePrefix"],r=e;for(const i of t)e.hasOwnProperty(i)&&(Array.isArray(r[i])?r[i]=r[i].flatMap((e=>"logGroupNames"===i?this.expandVariableToArray(e,n.scopedVars||{}):this.replace(e,n.scopedVars,!0,i))):r[i]=this.replace(r[i],n.scopedVars,!0,i));r.region&&(r.region=this.replace(r.region,n.scopedVars,!0,"region"),r.region=this.getActualRegion(r.region))}));let a={};return n.skipCache&&(a={"X-Cache-Skip":!0}),this.awsRequest(sr,i,a).pipe((0,nn.U)((e=>{return t={data:e},(0,o.toDataQueryResponse)(t).data||[];var t})),(0,dn.K)((e=>{var t,n;if(pn.vc.featureToggles.datasourceQueryMultiStatus&&207===e.status)throw e;if(400===e.status)throw e;if(null!==(t=e.data)&&void 0!==t&&t.error)throw e.data.error;if(null!==(n=e.data)&&void 0!==n&&n.message)throw e.data.message;throw e})))}getRegions(){return this.doMetricResourceRequest("regions").then((e=>[{label:"default",value:"default",text:"default"},...e]))}getNamespaces(){return this.doMetricResourceRequest("namespaces")}async getMetrics(e,t){return e?this.doMetricResourceRequest("metrics",{region:this.templateSrv.replace(this.getActualRegion(t)),namespace:this.templateSrv.replace(e)}):[]}async getAllMetrics(e){return(await this.doMetricResourceRequest("all-metrics",{region:this.templateSrv.replace(this.getActualRegion(e))})).map((e=>({metricName:e.value,namespace:e.text})))}async getDimensionKeys(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"";return e?this.doMetricResourceRequest("dimension-keys",{region:this.templateSrv.replace(this.getActualRegion(t)),namespace:this.templateSrv.replace(e),dimensionFilters:JSON.stringify(this.convertDimensionFormat(n,{})),metricName:r}):[]}async getDimensionValues(e,t,n,r,i){if(!t||!n)return[];return await this.doMetricResourceRequest("dimension-values",{region:this.templateSrv.replace(this.getActualRegion(e)),namespace:this.templateSrv.replace(t),metricName:this.templateSrv.replace(n.trim()),dimensionKey:this.templateSrv.replace(r),dimensions:JSON.stringify(this.convertDimensionFormat(i,{}))})}getEbsVolumeIds(e,t){return this.doMetricResourceRequest("ebs-volume-ids",{region:this.templateSrv.replace(this.getActualRegion(e)),instanceId:this.templateSrv.replace(t)})}getEc2InstanceAttribute(e,t,n){return this.doMetricResourceRequest("ec2-instance-attribute",{region:this.templateSrv.replace(this.getActualRegion(e)),attributeName:this.templateSrv.replace(t),filters:JSON.stringify(this.convertMultiFilterFormat(n,"filter key"))})}getResourceARNs(e,t,n){return this.doMetricResourceRequest("resource-arns",{region:this.templateSrv.replace(this.getActualRegion(e)),resourceType:this.templateSrv.replace(t),tags:JSON.stringify(this.convertMultiFilterFormat(n,"tag name"))})}targetContainsTemplate(e){var t;return this.templateSrv.containsTemplate(e.region)||this.templateSrv.containsTemplate(e.namespace)||this.templateSrv.containsTemplate(e.metricName)||this.templateSrv.containsTemplate(e.expression)||(null===(t=e.logGroupNames)||void 0===t?void 0:t.some((e=>this.templateSrv.containsTemplate(e))))||(0,m.find)(e.dimensions,((e,t)=>this.templateSrv.containsTemplate(t)||this.templateSrv.containsTemplate(e)))}awsRequest(e,t){const n={method:"POST",url:e,data:t,headers:arguments.length>2&&void 0!==arguments[2]?arguments[2]:{}};return(0,o.getBackendSrv)().fetch(n).pipe((0,nn.U)((e=>e.data)))}getDefaultRegion(){return this.defaultRegion}getActualRegion(e){return"default"===e||void 0===e||""===e?this.getDefaultRegion():e}showContextToggle(){return!0}convertToCloudWatchTime(e,t){return(0,m.isString)(e)&&(e=r.dateMath.parse(e,t)),Math.round(e.valueOf()/1e3)}convertDimensionFormat(e,t){return Object.entries(e).reduce(((e,n)=>{let[r,i]=n;if(r=this.replace(r,t,!0,"dimension keys"),Array.isArray(i))return Object.assign({},e,{[r]:i});if(!i)return Object.assign({},e,{[r]:null});const a=this.expandVariableToArray(i,t);return Object.assign({},e,{[r]:a})}),{})}expandVariableToArray(e,t){const n=this.templateSrv.getVariableName(e),r=this.templateSrv.getVariables().find((e=>{let{name:t}=e;return t===n}));return n&&r?r.multi?this.templateSrv.replace(e,t,"pipe").split("|"):[this.templateSrv.replace(e,t)]:[e]}convertMultiFilterFormat(e,t){return Object.entries(e).reduce(((e,n)=>{let[r,i]=n;if(r=this.replace(r,{},!0,t),!i)return Object.assign({},e,{[r]:null});const a=i.reduce(((e,t)=>[...e,...this.expandVariableToArray(t,{})]),[]);return Object.assign({},e,{[r]:a})}),{})}replace(e,t,n,r){if(n&&e){const t=this.templateSrv.getVariables().find((t=>{let{name:n}=t;return n===this.templateSrv.getVariableName(e)}));t&&t.multi&&this.debouncedCustomAlert("CloudWatch templating error",`Multi template variables are not supported for ${r||e}`)}return this.templateSrv.replace(e,t)}getQueryDisplayText(e){var t;return"Logs"===e.queryMode?null!==(t=e.expression)&&void 0!==t?t:"":JSON.stringify(e)}interpolateVariablesInQueries(e,t){return e.length?e.map((e=>Object.assign({},e,{region:this.getActualRegion(this.replace(e.region,t))},pe(e)&&this.interpolateMetricsQueryVariables(e,t)))):e}interpolateMetricsQueryVariables(e,t){var n;return{alias:this.replace(e.alias,t),metricName:this.replace(e.metricName,t),namespace:this.replace(e.namespace,t),period:this.replace(e.period,t),sqlExpression:this.replace(e.sqlExpression,t),dimensions:this.convertDimensionFormat(null!==(n=e.dimensions)&&void 0!==n?n:{},t)}}}function pr(e){const t=e.lastIndexOf(":");return e.slice(t+1)}const mr=new r.DataSourcePlugin(dr).setQueryEditorHelp(ue).setConfigEditor((e=>{var t,n;const{options:m}=e,{defaultLogGroups:h,logsTimeout:g,defaultRegion:y}=m.jsonData,[b,x]=(0,i.useState)(!!m.version&&m.version>1),S=function(e,t){const[n,r]=(0,i.useState)();return(0,i.useEffect)((()=>{t&&(0,d.ak)().loadDatasource(e).then((e=>{r(e)}))}),[e,t]),n}(m.name,b);!function(e){const t=e=>{p.h.dispatch((0,u.$l)((0,c.ZR)("CloudWatch Authentication",e)))};(0,i.useEffect)((()=>{"arn"===e.authType?t('Since grafana 7.3 authentication type "arn" is deprecated, falling back to default SDK provider'):"credentials"!==e.authType||e.profile||e.database||t('As of grafana 7.3 authentication type "credentials" should be used only for shared file credentials.              If you don\'t have a credentials file, switch to the default SDK provider for extracting credentials              from environment variables or IAM roles')}),[e.authType,e.database,e.profile])}(m.jsonData);const w=function(e){const[t,n]=(0,i.useState)(void 0);return(0,a.Z)((()=>{if(e)try{r.rangeUtil.describeInterval(e),n(void 0)}catch(e){e instanceof Error&&n(e.toString())}else n(void 0)}),350,[e]),t}(g);(0,i.useEffect)((()=>{x(!1)}),[e.options.jsonData.assumeRoleArn,e.options.jsonData.authType,e.options.jsonData.defaultRegion,e.options.jsonData.endpoint,e.options.jsonData.externalId,e.options.jsonData.profile,null===(t=e.options.secureJsonData)||void 0===t?void 0:t.accessKey,null===(n=e.options.secureJsonData)||void 0===n?void 0:n.secretKey]);return(0,f.jsxs)(f.Fragment,{children:[(0,f.jsx)(s.ConnectionConfig,Object.assign({},e,{loadRegions:S&&(()=>S.getRegions().then((e=>e.filter((e=>"default"!==e.value)).map((e=>e.value))))),children:(0,f.jsx)(l.InlineField,{label:"Namespaces of Custom Metrics",labelWidth:28,tooltip:"Namespaces of Custom Metrics.",children:(0,f.jsx)(l.Input,{width:60,placeholder:"Namespace1,Namespace2",value:m.jsonData.customMetricsNamespaces||"",onChange:(0,r.onUpdateDatasourceJsonDataOption)(e,"customMetricsNamespaces")})})})),I||(I=(0,f.jsx)("h3",{className:"page-heading",children:"CloudWatch Logs"})),(0,f.jsxs)("div",{className:"gf-form-group",children:[(0,f.jsx)(l.InlineField,{label:"Timeout",labelWidth:28,tooltip:'Custom timeout for CloudWatch Logs insights queries which have max concurrency limits. Default is 15 minutes. Must be a valid duration string, such as "15m" "30s" "2000ms" etc.',invalid:Boolean(w),children:(0,f.jsx)(l.Input,{width:60,placeholder:"15m",value:m.jsonData.logsTimeout||"",onChange:(0,r.onUpdateDatasourceJsonDataOption)(e,"logsTimeout"),title:'The timeout must be a valid duration string, such as "15m" "30s" "2000ms" etc.'})}),(0,f.jsx)(l.InlineField,{label:"Default Log Groups",labelWidth:28,tooltip:"Optionally, specify default log groups for CloudWatch Logs queries.",children:(0,f.jsx)(v,{region:null!=y?y:"",selectedLogGroups:null!=h?h:[],datasource:S,onChange:t=>{(0,r.updateDatasourcePluginJsonDataOption)(e,"defaultLogGroups",t)},onOpenMenu:async()=>{b||(await(0,o.getBackendSrv)().put(`/api/datasources/${m.id}`,m).then((t=>{(0,r.updateDatasourcePluginOption)(e,"version",t.datasource.version)})),x(!0))},width:60,saved:b})})]}),(0,f.jsx)(C,{onChange:t=>(0,r.updateDatasourcePluginJsonDataOption)(e,"tracingDatasourceUid",t),datasourceUid:m.jsonData.tracingDatasourceUid})]})})).setQueryEditor(_t).setMetadataInspector((function(e){let{data:t=[]}=e;const n=(0,i.useMemo)((()=>(0,m.groupBy)(t,"refId")),[t]);return(0,f.jsx)(f.Fragment,{children:(0,f.jsxs)("table",{className:"filter-table form-inline",children:[ce||(ce=(0,f.jsx)("thead",{children:(0,f.jsxs)("tr",{children:[(0,f.jsx)("th",{children:"RefId"}),(0,f.jsx)("th",{children:"Metric Data Query ID"}),(0,f.jsx)("th",{children:"Metric Data Query Expression"}),(0,f.jsx)("th",{children:"Period"}),(0,f.jsx)("th",{})]})})),Object.entries(n).map(((e,t)=>{var n,r;let[i,a]=e;if(!a.length)return null;const s=a[0],o=null===(n=s.meta)||void 0===n?void 0:n.custom;return o?(0,f.jsx)("tbody",{children:(0,f.jsxs)("tr",{children:[(0,f.jsx)("td",{children:i}),(0,f.jsx)("td",{children:o.id}),(0,f.jsx)("td",{children:null===(r=s.meta)||void 0===r?void 0:r.executedQueryString}),(0,f.jsx)("td",{children:o.period})]})},t):null}))]})})}))},61933:(e,t,n)=>{var r,i=n(68404),a=(r=i)&&"object"==typeof r&&"default"in r?r.default:r,s=n(3490),o=n(43215),l=n(82897),u=function(){return(u=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)};function c(e,t,n,r){return new(n||(n=Promise))((function(i,a){function s(e){try{l(r.next(e))}catch(e){a(e)}}function o(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,o)}l((r=r.apply(e,t||[])).next())}))}function d(e,t){var n,r,i,a,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return a={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function o(a){return function(o){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(i=2&a[0]?r.return:a[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,a[1])).done)return i;switch(r=0,i&&(a=[2&a[0],i.value]),a[0]){case 0:case 1:i=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,r=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!((i=(i=s.trys).length>0&&i[i.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!i||a[1]>i[0]&&a[1]<i[3])){s.label=a[1];break}if(6===a[0]&&s.label<i[1]){s.label=i[1],i=a;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(a);break}i[2]&&s.ops.pop(),s.trys.pop();continue}a=t.call(e,s)}catch(e){a=[6,e],r=0}finally{n=i=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,o])}}}function p(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,i,a=n.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(r=a.next()).done;)s.push(r.value)}catch(e){i={error:e}}finally{try{r&&!r.done&&(n=a.return)&&n.call(a)}finally{if(i)throw i.error}}return s}var m,h=["af-south-1","ap-east-1","ap-northeast-1","ap-northeast-2","ap-northeast-3","ap-south-1","ap-southeast-1","ap-southeast-2","ca-central-1","cn-north-1","cn-northwest-1","eu-central-1","eu-north-1","eu-west-1","eu-west-2","eu-west-3","me-south-1","sa-east-1","us-east-1","us-east-2","us-gov-east-1","us-gov-west-1","us-iso-east-1","us-isob-east-1","us-west-1","us-west-2"];(m=t._e||(t._e={})).Keys="keys",m.Credentials="credentials",m.Default="default",m.EC2IAMRole="ec2_iam_role",m.ARN="arn";var g,f=[{label:"Workspace IAM Role",value:t._e.EC2IAMRole},{label:"AWS SDK Default",value:t._e.Default},{label:"Access & secret key",value:t._e.Keys},{label:"Credentials file",value:t._e.Credentials}],v=function(e){return{value:e,label:e}},y=function(e){var n,r,l,c,d,m,g,y,b,x=p(i.useState((e.standardRegions||h).map(v)),2),S=x[0],w=x[1],C=e.loadRegions,I=e.onOptionsChange,E=e.skipHeader,T=void 0!==E&&E,j=e.skipEndpoint,A=void 0!==j&&j,R=e.options,O=R.jsonData.profile;void 0===O&&(O=R.database);var F=window.grafanaBootData.settings,M=null!==(n=F.awsAllowedAuthProviders)&&void 0!==n?n:[t._e.Default,t._e.Keys,t._e.Credentials],D=null===(r=F.awsAssumeRoleEnabled)||void 0===r||r,k=f.find((function(e){return e.value===R.jsonData.authType}));return i.useEffect((function(){!k&&M.length&&I(u(u({},R),{jsonData:u(u({},R.jsonData),{authType:M[0]})}))}),[k,R,I]),i.useEffect((function(){C&&C().then((function(e){return w(e.map(v))}))}),[C]),a.createElement(s.FieldSet,{label:T?"":"Connection Details","data-testid":"connection-config"},a.createElement(s.InlineField,{label:"Authentication Provider",labelWidth:28,tooltip:"Specify which AWS credentials chain to use."},a.createElement(s.Select,{"aria-label":"Authentication Provider",className:"width-30",value:k,options:f.filter((function(e){return M.includes(e.value)})),defaultValue:R.jsonData.authType,onChange:function(t){o.onUpdateDatasourceJsonDataOptionSelect(e,"authType")(t)},menuShouldPortal:!0})),"credentials"===R.jsonData.authType&&a.createElement(s.InlineField,{label:"Credentials Profile Name",labelWidth:28,tooltip:"Credentials profile name, as specified in ~/.aws/credentials, leave blank for default."},a.createElement(s.Input,{"aria-label":"Credentials Profile Name",className:"width-30",placeholder:"default",value:O,onChange:o.onUpdateDatasourceJsonDataOption(e,"profile")})),"keys"===R.jsonData.authType&&a.createElement(a.Fragment,null,a.createElement(s.InlineField,{label:"Access Key ID",labelWidth:28},(null===(l=e.options.secureJsonFields)||void 0===l?void 0:l.accessKey)?a.createElement(s.ButtonGroup,{className:"width-30"},a.createElement(s.Input,{disabled:!0,placeholder:"Configured"}),a.createElement(s.ToolbarButton,{icon:"edit",tooltip:"Edit Access Key ID",type:"button",onClick:o.onUpdateDatasourceResetOption(e,"accessKey")})):a.createElement(s.Input,{"aria-label":"Access Key ID",className:"width-30",value:null!==(d=null===(c=R.secureJsonData)||void 0===c?void 0:c.accessKey)&&void 0!==d?d:"",onChange:o.onUpdateDatasourceSecureJsonDataOption(e,"accessKey")})),a.createElement(s.InlineField,{label:"Secret Access Key",labelWidth:28},(null===(m=e.options.secureJsonFields)||void 0===m?void 0:m.secretKey)?a.createElement(s.ButtonGroup,{className:"width-30"},a.createElement(s.Input,{disabled:!0,placeholder:"Configured"}),a.createElement(s.ToolbarButton,{icon:"edit",type:"button",tooltip:"Edit Secret Access Key",onClick:o.onUpdateDatasourceResetOption(e,"secretKey")})):a.createElement(s.Input,{"aria-label":"Secret Access Key",className:"width-30",value:null!==(y=null===(g=R.secureJsonData)||void 0===g?void 0:g.secretKey)&&void 0!==y?y:"",onChange:o.onUpdateDatasourceSecureJsonDataOption(e,"secretKey")}))),D&&a.createElement(a.Fragment,null,a.createElement(s.InlineField,{label:"Assume Role ARN",labelWidth:28,tooltip:"Optionally, specify the ARN of a role to assume. Specifying a role here will ensure that the selected authentication provider is used to assume the specified role rather than using the credentials directly. Leave blank if you don't need to assume a role at all"},a.createElement(s.Input,{"aria-label":"Assume Role ARN",className:"width-30",placeholder:"arn:aws:iam:*",value:R.jsonData.assumeRoleArn||"",onChange:o.onUpdateDatasourceJsonDataOption(e,"assumeRoleArn")})),a.createElement(s.InlineField,{label:"External ID",labelWidth:28,tooltip:"If you are assuming a role in another account, that has been created with an external ID, specify the external ID here."},a.createElement(s.Input,{"aria-label":"External ID",className:"width-30",placeholder:"External ID",value:R.jsonData.externalId||"",onChange:o.onUpdateDatasourceJsonDataOption(e,"externalId")}))),!A&&a.createElement(s.InlineField,{label:"Endpoint",labelWidth:28,tooltip:"Optionally, specify a custom endpoint for the service"},a.createElement(s.Input,{"aria-label":"Endpoint",className:"width-30",placeholder:null!==(b=e.defaultEndpoint)&&void 0!==b?b:"https://{service}.{region}.amazonaws.com",value:R.jsonData.endpoint||"",onChange:o.onUpdateDatasourceJsonDataOption(e,"endpoint")})),a.createElement(s.InlineField,{label:"Default Region",labelWidth:28,tooltip:"Specify the region, such as for US West (Oregon) use ` us-west-2 ` as the region."},a.createElement(s.Select,{"aria-label":"Default Region",className:"width-30",value:S.find((function(e){return e.value===R.jsonData.defaultRegion})),options:S,defaultValue:R.jsonData.defaultRegion,allowCustomValue:!0,onChange:o.onUpdateDatasourceJsonDataOptionSelect(e,"defaultRegion"),formatCreateLabel:function(e){return"Use region: "+e},menuShouldPortal:!0})),e.children)};function b(e){var t=this,n=p(i.useState(e.value||e.default||null),2),r=n[0],o=n[1],m=p(i.useState(r?[r]:[]),2),h=m[0],g=m[1],f=p(i.useState(e.dependencies),2),v=f[0],y=f[1],b=p(i.useState(!1),2),x=b[0],S=b[1],w=p(i.useState(!1),2),C=w[0],I=w[1],E=i.useMemo((function(){var t=[{label:"default ("+e.default+")",value:"__default",description:"Default value set in the data source"}];return e.value&&"__default"!==e.value&&t.push({label:e.value,value:e.value}),t}),[e.default,e.value]),T=p(i.useState(e.default?E:[]),2),j=T[0],A=T[1];return i.useEffect((function(){void 0!==e.resources&&g(e.resources)}),[e.resources]),i.useEffect((function(){var t=e.default?E:[];h.length?(h.forEach((function(e){var n="string"==typeof e?e:e.value;t.find((function(e){return e.value===n}))||("string"==typeof e?t.push({label:e,value:e}):t.push(e))})),A(t)):A([])}),[h,E,e.default]),i.useEffect((function(){l.isEqual(e.dependencies,v)||(I(!1),o(null),e.onChange(null),y(e.dependencies))}),[e,v]),a.createElement(s.InlineField,{label:e.label,labelWidth:e.labelWidth,tooltip:e.tooltip,hidden:e.hidden},a.createElement("div",{"data-testid":e["data-testid"],title:e.title},a.createElement(s.Select,u({},e,{"aria-label":e.label,options:j,onChange:function(t){e.onChange(t),t.value&&o(t.value)},isLoading:x,className:e.className||"min-width-6",onOpenMenu:function(){return e.fetch&&c(t,void 0,void 0,(function(){return d(this,(function(n){switch(n.label){case 0:S(!0),n.label=1;case 1:return n.trys.push([1,,3,4]),[4,c(t,void 0,void 0,(function(){var t;return d(this,(function(n){switch(n.label){case 0:return C?[2]:e.saveOptions?[4,e.saveOptions()]:[3,2];case 1:n.sent(),n.label=2;case 2:return n.trys.push([2,,4,5]),[4,e.fetch()];case 3:return t=n.sent(),g(t),[3,5];case 4:return I(!0),[7];case 5:return[2]}}))}))];case 2:return n.sent(),[3,4];case 3:return S(!1),[7];case 4:return[2]}}))}))},menuShouldPortal:!0}))))}(g=t.rB||(t.rB={}))[g.Previous=0]="Previous",g[g.Null=1]="Null",g[g.Value=2]="Value";var x=[{label:"Previous Value",value:t.rB.Previous},{label:"NULL",value:t.rB.Null},{label:"Value",value:t.rB.Value}];function S(e){return"string"==typeof e?e:e.map((function(e){return function(e){return"'"+String(e).replace(/'/g,"''")+"'"}(e)})).join(",")}t.ConnectionConfig=y,t.SIGV4ConnectionConfig=function(e){var t,n,r,i,s=e.onOptionsChange,o=e.options,l={onOptionsChange:function(e){var t,n,r,i,a=u(u({},o),{jsonData:u(u({},o.jsonData),{sigV4AuthType:e.jsonData.authType,sigV4Profile:e.jsonData.profile,sigV4AssumeRoleArn:e.jsonData.assumeRoleArn,sigV4ExternalId:e.jsonData.externalId,sigV4Region:e.jsonData.defaultRegion,sigV4Endpoint:e.jsonData.endpoint}),secureJsonFields:{sigV4AccessKey:null===(t=e.secureJsonFields)||void 0===t?void 0:t.accessKey,sigV4SecretKey:null===(n=e.secureJsonFields)||void 0===n?void 0:n.secretKey},secureJsonData:{sigV4AccessKey:null===(r=e.secureJsonData)||void 0===r?void 0:r.accessKey,sigV4SecretKey:null===(i=e.secureJsonData)||void 0===i?void 0:i.secretKey}});s(a)},options:u(u({},o),{jsonData:u(u({},o.jsonData),{authType:o.jsonData.sigV4AuthType,profile:o.jsonData.sigV4Profile,assumeRoleArn:o.jsonData.sigV4AssumeRoleArn,externalId:o.jsonData.sigV4ExternalId,defaultRegion:o.jsonData.sigV4Region,endpoint:o.jsonData.sigV4Endpoint}),secureJsonFields:{accessKey:null===(t=o.secureJsonFields)||void 0===t?void 0:t.sigV4AccessKey,secretKey:null===(n=o.secureJsonFields)||void 0===n?void 0:n.sigV4SecretKey},secureJsonData:{accessKey:null===(r=o.secureJsonData)||void 0===r?void 0:r.sigV4AccessKey,secretKey:null===(i=o.secureJsonData)||void 0===i?void 0:i.sigV4SecretKey}})};return a.createElement(a.Fragment,null,a.createElement("div",{className:"gf-form"},a.createElement("h6",null,"SigV4 Auth Details")),a.createElement(y,u({},l,{skipHeader:!0,skipEndpoint:!0})))}},16538:(e,t,n)=>{"use strict";e.exports=n(61933)},48322:e=>{"use strict";e.exports=function e(t,n){if(t===n)return!0;if(t&&n&&"object"==typeof t&&"object"==typeof n){if(t.constructor!==n.constructor)return!1;var r,i,a;if(Array.isArray(t)){if((r=t.length)!=n.length)return!1;for(i=r;0!=i--;)if(!e(t[i],n[i]))return!1;return!0}if(t.constructor===RegExp)return t.source===n.source&&t.flags===n.flags;if(t.valueOf!==Object.prototype.valueOf)return t.valueOf()===n.valueOf();if(t.toString!==Object.prototype.toString)return t.toString()===n.toString();if((r=(a=Object.keys(t)).length)!==Object.keys(n).length)return!1;for(i=r;0!=i--;)if(!Object.prototype.hasOwnProperty.call(n,a[i]))return!1;for(i=r;0!=i--;){var s=a[i];if(("_owner"!==s||!t.$$typeof)&&!e(t[s],n[s]))return!1}return!0}return t!=t&&n!=n}},36993:(e,t,n)=>{e.exports=n(78353)},78353:(e,t)=>{!function(e){"use strict";e.stringify=function e(t){function n(e){return/[^\w-.]/.test(e)?e.replace(/[^\w-.]/g,(function(e){return"$"===e?"!":(e=e.charCodeAt(0))<256?"*"+("00"+e.toString(16)).slice(-2):"**"+("0000"+e.toString(16)).slice(-4)})):e}var r;switch(typeof t){case"number":return isFinite(t)?"~"+t:"~null";case"boolean":return"~"+t;case"string":return"~'"+n(t);case"object":if(!t)return"~null";if(r=[],Array.isArray(t)){for(var i=0;i<t.length;i++)r[i]=e(t[i])||"~null";return"~("+(r.join("")||"~")+")"}for(var a in t)if(t.hasOwnProperty(a)){var s=e(t[a]);s&&r.push(n(a)+s)}return"~("+r.join("~")+")";default:return}};var t={true:!0,false:!1,null:null};e.parse=function(e){if(!e)return e;e=e.replace(/%(25)*27/g,"'");var n=0,r=e.length;function i(t){if(e.charAt(n)!==t)throw new Error("bad JSURL syntax: expected "+t+", got "+(e&&e.charAt(n)));n++}function a(){for(var t,i=n,a="";n<r&&"~"!==(t=e.charAt(n))&&")"!==t;)switch(t){case"*":i<n&&(a+=e.substring(i,n)),"*"===e.charAt(n+1)?(a+=String.fromCharCode(parseInt(e.substring(n+2,n+6),16)),i=n+=6):(a+=String.fromCharCode(parseInt(e.substring(n+1,n+3),16)),i=n+=3);break;case"!":i<n&&(a+=e.substring(i,n)),a+="$",i=++n;break;default:n++}return a+e.substring(i,n)}return function s(){var o,l,u;switch(i("~"),l=e.charAt(n)){case"(":if(n++,"~"===e.charAt(n))if(o=[],")"===e.charAt(n+1))n++;else do{o.push(s())}while("~"===e.charAt(n));else if(o={},")"!==e.charAt(n))do{o[a()]=s()}while("~"===e.charAt(n)&&++n);i(")");break;case"'":n++,o=a();break;default:for(u=n++;n<r&&/[^)~]/.test(e.charAt(n));)n++;var c=e.substring(u,n);if(/[\d\-]/.test(l))o=parseFloat(c);else if(void 0===(o=t[c]))throw new Error("bad value keyword: "+c)}return o}()},e.tryParse=function(t,n){try{return e.parse(t)}catch(e){return n}}}(t)}}]);
//# sourceMappingURL=cloudwatchPlugin.b8bad0519ade99accb41.js.map