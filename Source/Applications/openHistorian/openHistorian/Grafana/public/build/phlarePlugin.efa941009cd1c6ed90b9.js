"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[9704],{61674:(M,h,o)=>{o.r(h),o.d(h,{plugin:()=>Ie});var v=o(7238),a=o(68404),x=o(12006),b=o(12580),p=o(14835),C=o(97291),z=o(47694);const O=e=>{const{options:t,onOptionsChange:n}=e;return a.createElement(a.Fragment,null,a.createElement(x.E,{defaultUrl:"http://localhost:4100",dataSourceConfig:t,showAccessOptions:!1,onChange:n}),z.vc.featureToggles.secureSocksDatasourceProxy&&a.createElement(b.i,{options:t,onOptionsChange:n}),a.createElement("h3",{className:"page-heading"},"Querying"),a.createElement("div",{className:"gf-form-group"},a.createElement("div",{className:"gf-form-inline"},a.createElement("div",{className:"gf-form"},a.createElement(p.LegacyForms.FormField,{label:"Minimal step",labelWidth:13,inputEl:a.createElement(p.LegacyForms.Input,{className:"width-6",value:t.jsonData.minStep,spellCheck:!1,placeholder:"15s",onChange:r=>{n({...t,jsonData:{...t.jsonData,minStep:r.currentTarget.value}})},validationEvents:{[C.JU.onBlur]:[(0,C.FE)(/^$|^\d+(ms|[Mwdhmsy])$/,"Value is not valid, you can use number with time unit specifier: y, M, w, d, h, m, s")]}}),tooltip:"Minimal step used for metric query. Should be the same or higher as the scrape interval setting in the Phlare database."})))))};var D=o(82897),Q=o(22350),L=o(40400),W=o(19974);const Pe=Object.freeze([0,0]),U="both",$={groupBy:[],labelSelector:"{}"};var g=o(9892),m=o(72648);function S(e){const t=(0,m.wW)((0,a.useCallback)(n=>j(n,e),[e]));return a.createElement("div",{className:t.root},e.children)}const j=(e,t)=>({root:(0,g.css)({display:"flex",flexDirection:t.direction??"row",flexWrap:t.wrap??!0?"wrap":void 0,alignItems:t.alignItems,gap:e.spacing(t.gap??2),flexGrow:t.flexGrow})}),N=({children:e,stackProps:t})=>{const n=(0,m.wW)(K);return a.createElement("div",{className:n.root},a.createElement(S,{gap:2,...t},e))},K=e=>({root:(0,g.css)({padding:e.spacing(1),backgroundColor:e.colors.background.secondary,borderRadius:e.shape.borderRadius(1)})}),V=({children:e})=>a.createElement(S,{gap:.5,direction:"column"},e);var G=o(56021),Z=o(9405);const H={id:"phlareql",extensions:[".phlareql"],aliases:["phlare","phlareql"],mimetypes:[],def:{language:{ignoreCase:!1,defaultToken:"",tokenPostfix:".phlareql",keywords:[],operators:[],symbols:/[=><!~?:&|+\-*\/^%]+/,escapes:/\\(?:[abfnrtv\\"']|x[0-9A-Fa-f]{1,4}|u[0-9A-Fa-f]{4}|U[0-9A-Fa-f]{8})/,digits:/\d+(_+\d+)*/,octaldigits:/[0-7]+(_+[0-7]+)*/,binarydigits:/[0-1]+(_+[0-1]+)*/,hexdigits:/[[0-9a-fA-F]+(_+[0-9a-fA-F]+)*/,integersuffix:/(ll|LL|u|U|l|L)?(ll|LL|u|U|l|L)?/,floatsuffix:/[fFlL]?/,tokenizer:{root:[[/[a-z_]\w*(?=\s*(=|!=|=~|!~))/,"tag"],[/"([^"\\]|\\.)*$/,"string.invalid"],[/'([^'\\]|\\.)*$/,"string.invalid"],[/"/,"string","@string_double"],[/'/,"string","@string_single"],{include:"@whitespace"},[/[{}()\[\]]/,"@brackets"],[/[<>](?!@symbols)/,"@brackets"],[/@symbols/,{cases:{"@operators":"delimiter","@default":""}}],[/\d+/,"number"],[/\d*\d+[eE]([\-+]?\d+)?(@floatsuffix)/,"number.float"],[/\d*\.\d+([eE][\-+]?\d+)?(@floatsuffix)/,"number.float"],[/0[xX][0-9a-fA-F']*[0-9a-fA-F](@integersuffix)/,"number.hex"],[/0[0-7']*[0-7](@integersuffix)/,"number.octal"],[/0[bB][0-1']*[0-1](@integersuffix)/,"number.binary"],[/\d[\d']*\d(@integersuffix)/,"number"],[/\d(@integersuffix)/,"number"]],string_double:[[/[^\\"]+/,"string"],[/@escapes/,"string.escape"],[/\\./,"string.escape.invalid"],[/"/,"string","@pop"]],string_single:[[/[^\\']+/,"string"],[/@escapes/,"string.escape"],[/\\./,"string.escape.invalid"],[/'/,"string","@pop"]],clauses:[[/[^(,)]/,"tag"],[/\)/,"identifier","@pop"]],whitespace:[[/[ \t\r\n]+/,"white"]]}},languageConfiguration:{wordPattern:/(-?\d*\.\d\w*)|([^`~!#%^&*()\-=+\[{\]}\\|;:'",.<>\/?\s]+)/g,brackets:[["{","}"]],autoClosingPairs:[{open:"{",close:"}"},{open:'"',close:'"'},{open:"'",close:"'"}],surroundingPairs:[{open:"{",close:"}"},{open:'"',close:'"'},{open:"'",close:"'"}],folding:{}}}};class k{constructor(){this.triggerCharacters=["{",",","[","(","=","~"," ",'"'],this.labels={}}provideCompletionItems(t,n){if(!(this.monaco&&this.editor))throw new Error("provideCompletionItems called before CompletionProvider was initialized");if(this.editor.getModel()?.id!==t.id)return{suggestions:[]};const{range:r,offset:s}=ee(this.monaco,t,n),l=_(t.getValue(),s),i=this.getCompletions(l),f=i.length.toString().length;return{suggestions:i.map((c,d)=>({kind:J(c.type,this.monaco),label:c.label,insertText:c.insertText,sortText:d.toString().padStart(f,"0"),range:r}))}}setSeries(t){this.labels=t.reduce((n,r)=>{const s=r.labels.reduce((l,i)=>(l[i.name]=l[i.name]||new Set,l[i.name].add(i.value),l),{});for(const l of Object.keys(s))n[l]=new Set([...n[l]||[],...s[l]]);return n},{})}getCompletions(t){if(!Object.keys(this.labels).length)return[];switch(t.type){case"UNKNOWN":return[];case"EMPTY":return Object.keys(this.labels).map(n=>({label:n,insertText:`{${n}="`,type:"LABEL_NAME"}));case"IN_LABEL_NAME":return Object.keys(this.labels).map(n=>({label:n,insertText:n,type:"LABEL_NAME"}));case"IN_LABEL_VALUE":return Array.from(this.labels[t.labelName].values()).map(n=>({label:n,insertText:t.betweenQuotes?n:`"${n}"`,type:"LABEL_VALUE"}));default:throw new Error(`Unexpected situation ${t}`)}}}function J(e,t){switch(e){case"LABEL_NAME":return t.languages.CompletionItemKind.Enum;case"LABEL_VALUE":return t.languages.CompletionItemKind.EnumMember;default:throw new Error(`Unexpected CompletionType: ${e}`)}}const A=/[a-zA-Z_][a-zA-Z0-9_]*/,T=/[^"]*/,X=new RegExp(`(${A.source})="(${T.source})"`,"g"),Y=new RegExp(`(${A.source})=("?)${T.source}$`),q=new RegExp(/[{,]\s*[a-zA-Z0-9_]*$/);function _(e,t){if(e==="")return{type:"EMPTY"};const n=e.matchAll(X),r=Array.from(n).reduce((i,f)=>{const[u,c,d]=f[1];return i.push({name:c,value:d}),i},[]),s=e.substring(0,t).match(Y);return s?{type:"IN_LABEL_VALUE",labelName:s[1],betweenQuotes:!!s[2],otherLabels:r}:e.substring(0,t).match(q)?{type:"IN_LABEL_NAME",otherLabels:r}:{type:"UNKNOWN"}}function ee(e,t,n){const r=t.getWordAtPosition(n),s=r!=null?e.Range.lift({startLineNumber:n.lineNumber,endLineNumber:n.lineNumber,startColumn:r.startColumn,endColumn:r.endColumn}):e.Range.fromPositions(n),l={column:n.column,lineNumber:n.lineNumber};return{offset:t.getOffsetAt(l),range:s}}function te(e){const t=ae(e.series),n=(0,m.wW)(oe),r=(0,G.Z)(e.onRunQuery),s=(0,a.useRef)(null);return a.createElement("div",{className:n.wrapper,ref:s},a.createElement(Z.p,{value:e.value,language:y,onBlur:e.onChange,containerStyles:n.queryField,monacoOptions:{folding:!1,fontSize:14,lineNumbers:"off",overviewRulerLanes:0,renderLineHighlight:"none",scrollbar:{vertical:"hidden",verticalScrollbarSize:8,horizontal:"hidden",horizontalScrollbarSize:0},scrollBeyondLastLine:!1,wordWrap:"on",padding:{top:5,bottom:6}},onBeforeEditorMount:re,onEditorDidMount:(l,i)=>{t(l,i);const f=()=>{const u=s.current;if(u!==null){const c=l.getContentHeight();u.style.height=`${c+ne}px`,u.style.width="100%";const d=u.clientWidth;l.layout({width:d,height:c})}};l.onDidContentSizeChange(f),f(),l.addCommand(i.KeyMod.Shift|i.KeyCode.Enter,()=>{r.current(l.getValue())})}}))}const ne=2;function ae(e){const t=(0,a.useRef)(new k);(0,a.useEffect)(()=>{e&&t.current.setSeries(e)},[e]);const n=(0,a.useRef)(null);return(0,a.useEffect)(()=>()=>{n.current?.()},[]),(r,s)=>{t.current.editor=r,t.current.monaco=s;const{dispose:l}=s.languages.registerCompletionItemProvider(y,t.current);n.current=l}}let R=!1;const y="phlareql";function re(e){if(R===!1){R=!0;const{aliases:t,extensions:n,mimetypes:r,def:s}=H;e.languages.register({id:y,aliases:t,extensions:n,mimetypes:r}),e.languages.setMonarchTokensProvider(y,s.language),e.languages.setLanguageConfiguration(y,s.languageConfiguration)}}const oe=()=>({queryField:g.css`
      flex: 1;
      // Not exactly sure but without this the editor doe not shrink after resizing (so you can make it bigger but not
      // smaller). At the same time this does not actually make the editor 100px because it has flex 1 so I assume
      // this should sort of act as a flex-basis (but flex-basis does not work for this). So yeah CSS magic.
      width: 100px;
    `,wrapper:g.css`
      display: flex;
      flex: 1;
      border: 1px solid rgba(36, 41, 46, 0.3);
      border-radius: 2px;
    `});var se=o(86253),w=o(39904),le=o(2594),ie=o(53217),ce=o(61970),ue=o(6554),ge=o(24799),de=o(7804);const I=e=>{const{label:t,optional:n,tooltip:r,children:s,width:l,...i}=e,f=(0,m.l4)(),u=fe(f,l),c=i?.htmlFor||ce?.getChildId(s),d=a.createElement(a.Fragment,null,a.createElement("label",{className:u.label,htmlFor:c},t,n&&a.createElement("span",{className:u.optional}," - optional"),r&&a.createElement(ue.u,{placement:"top",content:r,theme:"info"},a.createElement(w.J,{name:"info-circle",size:"sm",className:u.icon}))),a.createElement("span",{className:u.space}));return a.createElement("div",{className:u.root},a.createElement(ge.g,{className:u.field,label:d,...i},s))},fe=(0,de.B)((e,t)=>({space:(0,g.css)({paddingRight:e.spacing(0),paddingBottom:e.spacing(.5)}),root:(0,g.css)({minWidth:e.spacing(t??0)}),label:(0,g.css)({fontSize:12,fontWeight:e.typography.fontWeightMedium}),optional:(0,g.css)({fontStyle:"italic",color:e.colors.text.secondary}),field:(0,g.css)({marginBottom:0}),icon:(0,g.css)({color:e.colors.text.secondary,marginLeft:e.spacing(1),":hover":{color:e.colors.text.primary}})})),P=[{value:"metrics",label:"Metric",description:"Return aggregated metrics"},{value:"profile",label:"Profile",description:"Return profile"},{value:"both",label:"Both",description:"Return both metric and profile data"}];function pe(e){return e===L.zj.Explore?P:P.filter(t=>t.value!=="both")}function me(e){let t=[];if(e){const n=e.flatMap(r=>r.labels.map(s=>s.name));t=Array.from(new Set(n)).map(r=>({label:r,value:r}))}return t}function ye({query:e,onQueryChange:t,app:n,series:r}){const[s,l]=(0,se.Z)(!1),i=(0,m.wW)(he),f=pe(n),u=me(r);return a.createElement(S,{gap:0,direction:"column"},a.createElement("div",{className:i.header,onClick:l,title:"Click to edit options"},a.createElement("div",{className:i.toggle},a.createElement(w.J,{name:s?"angle-down":"angle-right"})),a.createElement("h6",{className:i.title},"Options"),!s&&a.createElement("div",{className:i.description},[`Type: ${e.queryType}`,e.groupBy?.length?`Group by: ${e.groupBy.join(", ")}`:void 0].filter(c=>c).map((c,d)=>a.createElement("span",{key:d},c)))),s&&a.createElement("div",{className:i.body},a.createElement(I,{label:"Query Type"},a.createElement(le.S,{options:f,value:e.queryType,onChange:c=>t({...e,queryType:c})})),a.createElement(I,{label:"Group by",tooltip:a.createElement(a.Fragment,null,"Used to group the metric result by a specific label or set of labels. Does not apply to profile query.")},a.createElement(ie.NU,{placeholder:"Label",value:e.groupBy,allowCustomValue:!0,options:u,onChange:c=>{const d=c.map(E=>E.value);t({...e,groupBy:d})}}))))}const he=e=>({switchLabel:(0,g.css)({color:e.colors.text.secondary,cursor:"pointer",fontSize:e.typography.bodySmall.fontSize,"&:hover":{color:e.colors.text.primary}}),header:(0,g.css)({display:"flex",cursor:"pointer",alignItems:"baseline",color:e.colors.text.primary,"&:hover":{background:e.colors.emphasize(e.colors.background.primary,.03)}}),title:(0,g.css)({flexGrow:1,overflow:"hidden",fontSize:e.typography.bodySmall.fontSize,fontWeight:e.typography.fontWeightMedium,margin:0}),description:(0,g.css)({color:e.colors.text.secondary,fontSize:e.typography.bodySmall.fontSize,paddingLeft:e.spacing(2),gap:e.spacing(2),display:"flex"}),body:(0,g.css)({display:"flex",paddingTop:e.spacing(2),gap:e.spacing(2),flexWrap:"wrap"}),toggle:(0,g.css)({color:e.colors.text.secondary,marginRight:`${e.spacing(1)}`})}),be={...$,queryType:U};function Ee(e){const t=xe(e.datasource);function n(c,d){if(d.length===0)return;const E=d[d.length-1].value;if(typeof E!="string")throw new Error("id is not string");e.onChange({...e.query,profileTypeId:E})}function r(c){e.onChange({...e.query,labelSelector:c})}function s(c){e.onChange({...e.query,labelSelector:c}),e.onRunQuery()}const l=(0,Q.Z)(()=>e.datasource.getSeries(),[e.datasource]),i=ve(t),f=Se(t,e.query.profileTypeId);let u=F(e.query,e.app);return a.createElement(V,null,a.createElement(N,{stackProps:{wrap:!1,gap:1}},a.createElement(W.O,{onChange:n,options:i,buttonProps:{variant:"secondary"}},f),a.createElement(te,{value:u.labelSelector,onChange:r,onRunQuery:s,series:l.value})),a.createElement(N,null,a.createElement(ye,{query:u,onQueryChange:e.onChange,app:e.app,series:l.value})))}function ve(e){return(0,a.useMemo)(()=>{let t=new Map;for(let n of e)t.has(n.name)||t.set(n.name,{label:n.name,value:n.ID,children:[]}),t.get(n.name)?.children?.push({label:n.sample_type,value:n.ID});return Array.from(t.values())},[e])}function xe(e){const[t,n]=(0,a.useState)([]);return(0,a.useEffect)(()=>{(async()=>{const r=await e.getProfileTypes();n(r)})()},[e]),t}function Se(e,t){return(0,a.useMemo)(()=>{if(!e)return"Loading";const n=e.find(r=>r.ID===t);return n?n.name+" - "+n.sample_type:"Select a profile type"},[t,e])}function F(e,t){let n=(0,D.defaults)(e,be);return t!==L.zj.Explore&&n.queryType==="both"&&(n.queryType="profile"),n}var Ce=o(57706),Le=o.n(Ce),Ne=o(59980),Ae=o(22069),Te=o(20308),B=o(51649);class Re extends Ae.CK{constructor(t,n=(0,Te.J)()){super(t),this.templateSrv=n}query(t){const n=t.targets.filter(r=>r.profileTypeId).map(r=>r.labelSelector===""?{...r,labelSelector:"{}"}:F(r,t.app));return n.length?super.query({...t,targets:n}):(0,Ne.of)({data:[]})}async getProfileTypes(){return await super.getResource("profileTypes")}async getSeries(){return await super.getResource("series",{matchers:["{}"]})}async getLabelNames(){return await super.getResource("labelNames")}applyTemplateVariables(t,n){return{...t,labelSelector:this.templateSrv.replace(t.labelSelector??"",n)}}async importFromAbstractQueries(t){return t.map(n=>this.importFromAbstractQuery(n))}importFromAbstractQuery(t){return{refId:t.refId,labelSelector:(0,B.PL)(t),queryType:"both",profileTypeId:"",groupBy:[""]}}async exportToAbstractQueries(t){return t.map(n=>this.exportToAbstractQuery(n))}exportToAbstractQuery(t){const n=t.labelSelector;if(!n||n.length===0)return{refId:t.refId,labelMatchers:[]};const r=Le().tokenize(n,we);return{refId:t.refId,labelMatchers:(0,B.UO)(r)}}}const we={"context-labels":{pattern:/\{[^}]*(?=}?)/,greedy:!0,inside:{comment:{pattern:/#.*/},"label-key":{pattern:/[a-zA-Z_]\w*(?=\s*(=|!=|=~|!~))/,alias:"attr-name",greedy:!0},"label-value":{pattern:/"(?:\\.|[^\\"])*"/,greedy:!0,alias:"attr-value"},punctuation:/[{]/}},punctuation:/[{}(),.]/},Ie=new v.hf(Re).setConfigEditor(O).setQueryEditor(Ee)},56021:(M,h,o)=>{o.d(h,{Z:()=>x});var v=o(68404),a=function(b){var p=(0,v.useRef)(b);return p.current=b,p};const x=a}}]);

//# sourceMappingURL=phlarePlugin.efa941009cd1c6ed90b9.js.map