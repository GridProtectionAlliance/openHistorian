(window.webpackJsonp=window.webpackJsonp||[]).push([[40],{"2Wqq":function(t,e,r){"use strict";r.r(e);var a=r("LvDl"),n=r.n(a),i=r("mrSG"),s=function(){function t(t){this.$q=t}return t.prototype.processQueryResult=function(t){var e,r,a,n,s=[];if(!t.data.results)return{data:s};for(var o in t.data.results){var u=t.data.results[o];if(u.series)try{for(var l=(e=void 0,i.i(u.series)),m=l.next();!m.done;m=l.next()){var p=m.value;s.push({target:p.name,datapoints:p.points,refId:u.refId,meta:u.meta})}}catch(t){e={error:t}}finally{try{m&&!m.done&&(r=l.return)&&r.call(l)}finally{if(e)throw e.error}}if(u.tables)try{for(var c=(a=void 0,i.i(u.tables)),h=c.next();!h.done;h=c.next()){var d=h.value;d.type="table",d.refId=u.refId,d.meta=u.meta,s.push(d)}}catch(t){a={error:t}}finally{try{h&&!h.done&&(n=c.return)&&n.call(c)}finally{if(a)throw a.error}}}return{data:s}},t.prototype.parseMetricFindQueryResult=function(t,e){if(!e||0===e.data.length||0===e.data.results[t].meta.rowCount)return[];var r=e.data.results[t].tables[0].columns,a=e.data.results[t].tables[0].rows,n=this.findColIndex(r,"__text"),i=this.findColIndex(r,"__value");return 2===r.length&&-1!==n&&-1!==i?this.transformToKeyValueList(a,n,i):this.transformToSimpleList(a)},t.prototype.transformToKeyValueList=function(t,e,r){for(var a=[],n=0;n<t.length;n++)this.containsKey(a,t[n][e])||a.push({text:t[n][e],value:t[n][r]});return a},t.prototype.transformToSimpleList=function(t){for(var e=[],r=0;r<t.length;r++)for(var a=0;a<t[r].length;a++){var i=t[r][a];-1===e.indexOf(i)&&e.push(i)}return n.a.map(e,function(t){return{text:t}})},t.prototype.findColIndex=function(t,e){for(var r=0;r<t.length;r++)if(t[r].text===e)return r;return-1},t.prototype.containsKey=function(t,e){for(var r=0;r<t.length;r++)if(t[r].text===e)return!0;return!1},t.prototype.transformAnnotationResponse=function(t,e){for(var r=e.data.results[t.annotation.name].tables[0],a=-1,n=-1,i=-1,s=0;s<r.columns.length;s++)"time"===r.columns[s].text?a=s:"text"===r.columns[s].text?n=s:"tags"===r.columns[s].text&&(i=s);if(-1===a)return this.$q.reject({message:"Missing mandatory time column in annotation query."});var o=[];for(s=0;s<r.rows.length;s++){var u=r.rows[s];o.push({annotation:t.annotation,time:Math.floor(u[a]),title:u[-1],text:u[n],tags:u[i]?u[i].trim().split(/\s*,\s*/):[]})}return o},t}(),o=function(){function t(t,e,r){this.target=t,this.templateSrv=e,this.scopedVars=r,t.format=t.format||"time_series",t.timeColumn=t.timeColumn||"time",t.metricColumn=t.metricColumn||"none",t.group=t.group||[],t.where=t.where||[{type:"macro",name:"$__timeFilter",params:[]}],t.select=t.select||[[{type:"column",params:["value"]}]],"rawQuery"in this.target||(t.rawQuery="rawSql"in t),this.interpolateQueryStr=this.interpolateQueryStr.bind(this)}return t.$inject=["target","templateSrv","scopedVars"],t.prototype.unquoteIdentifier=function(t){return'"'===t[0]&&'"'===t[t.length-1]?t.substring(1,t.length-1).replace(/""/g,'"'):t},t.prototype.quoteIdentifier=function(t){return'"'+String(t).replace(/"/g,'""')+'"'},t.prototype.quoteLiteral=function(t){return"'"+String(t).replace(/'/g,"''")+"'"},t.prototype.escapeLiteral=function(t){return String(t).replace(/'/g,"''")},t.prototype.hasTimeGroup=function(){return n.a.find(this.target.group,function(t){return"time"===t.type})},t.prototype.hasMetricColumn=function(){return"none"!==this.target.metricColumn},t.prototype.interpolateQueryStr=function(t,e,r){return e.multi||e.includeAll?"string"==typeof t?this.quoteLiteral(t):n.a.map(t,this.quoteLiteral).join(","):this.escapeLiteral(t)},t.prototype.render=function(t){var e=this.target;return this.target.rawQuery||"table"in this.target?(e.rawQuery||(e.rawSql=this.buildQuery()),t?this.templateSrv.replace(e.rawSql,this.scopedVars,this.interpolateQueryStr):e.rawSql):""},t.prototype.hasUnixEpochTimecolumn=function(){return["int4","int8","float4","float8","numeric"].indexOf(this.target.timeColumnType)>-1},t.prototype.buildTimeColumn=function(t){void 0===t&&(t=!0);var e,r=this.hasTimeGroup(),a="$__timeGroup";if(r){var n=void 0;n=r.params.length>1&&"none"!==r.params[1]?r.params.join(","):r.params[0],this.hasUnixEpochTimecolumn()&&(a="$__unixEpochGroup"),t&&(a+="Alias"),e=a+"("+this.target.timeColumn+","+n+")"}else e=this.target.timeColumn,t&&(e+=' AS "time"');return e},t.prototype.buildMetricColumn=function(){return this.hasMetricColumn()?this.target.metricColumn+" AS metric":""},t.prototype.buildValueColumns=function(){var t,e,r="";try{for(var a=i.i(this.target.select),n=a.next();!n.done;n=a.next()){var s=n.value;r+=",\n  "+this.buildValueColumn(s)}}catch(e){t={error:e}}finally{try{n&&!n.done&&(e=a.return)&&e.call(a)}finally{if(t)throw t.error}}return r},t.prototype.buildValueColumn=function(t){var e="";e=n.a.find(t,function(t){return"column"===t.type}).params[0];var r=n.a.find(t,function(t){return"aggregate"===t.type||"percentile"===t.type}),a=n.a.find(t,function(t){return"window"===t.type||"moving_window"===t.type});if(r){var i=r.params[0];switch(r.type){case"aggregate":e="first"===i||"last"===i?i+"("+e+","+this.target.timeColumn+")":i+"("+e+")";break;case"percentile":e=i+"("+r.params[1]+") WITHIN GROUP (ORDER BY "+e+")"}}if(a){var s=[];this.hasMetricColumn()&&s.push("PARTITION BY "+this.target.metricColumn),s.push("ORDER BY "+this.buildTimeColumn(!1));var o=s.join(" "),u=void 0,l=void 0;switch(a.type){case"window":switch(a.params[0]){case"delta":e=(u=e)+" - "+(l="lag("+u+") OVER ("+o+")");break;case"increase":e="(CASE WHEN "+(u=e)+" >= "+(l="lag("+u+") OVER ("+o+")")+" THEN "+u+" - "+l,e+=" WHEN "+l+" IS NULL THEN NULL ELSE "+u+" END)";break;case"rate":var m=this.target.timeColumn;r&&(m="min("+m+")"),e="(CASE WHEN "+(u=e)+" >= "+(l="lag("+u+") OVER ("+o+")")+" THEN "+u+" - "+l,e+=" WHEN "+l+" IS NULL THEN NULL ELSE "+u+" END)",e+="/extract(epoch from "+m+" - lag("+m+") OVER ("+o+"))";break;default:e=a.params[0]+"("+e+") OVER ("+o+")"}break;case"moving_window":e=a.params[0]+"("+e+") OVER ("+o+" ROWS "+a.params[1]+" PRECEDING)"}}var p=n.a.find(t,function(t){return"alias"===t.type});return p&&(e+=" AS "+this.quoteIdentifier(p.params[0])),e},t.prototype.buildWhereClause=function(){var t=this,e="",r=n.a.map(this.target.where,function(e,r){switch(e.type){case"macro":return e.name+"("+t.target.timeColumn+")";case"expression":return e.params.join(" ")}});return r.length>0&&(e="\nWHERE\n  "+r.join(" AND\n  ")),e},t.prototype.buildGroupClause=function(){for(var t="",e="",r=0;r<this.target.group.length;r++){var a=this.target.group[r];r>0&&(e+=", "),"time"===a.type?e+="1":e+=a.params[0]}return e.length&&(t="\nGROUP BY "+e,this.hasMetricColumn()&&(t+=",2")),t},t.prototype.buildQuery=function(){var t="SELECT";return t+="\n  "+this.buildTimeColumn(),this.hasMetricColumn()&&(t+=",\n  "+this.buildMetricColumn()),t+=this.buildValueColumns(),t+="\nFROM "+this.target.table,t+=this.buildWhereClause(),t+=this.buildGroupClause(),t+="\nORDER BY 1",this.hasMetricColumn()&&(t+=",2"),t},t}(),u=function(){function t(t,e,r,a,i){var u=this;this.backendSrv=e,this.$q=r,this.templateSrv=a,this.timeSrv=i,this.interpolateVariable=function(t,e){return"string"==typeof t?e.multi||e.includeAll?u.queryModel.quoteLiteral(t):t:"number"==typeof t?t:n.a.map(t,function(t){return u.queryModel.quoteLiteral(t)}).join(",")},this.name=t.name,this.id=t.id,this.jsonData=t.jsonData,this.responseParser=new s(this.$q),this.queryModel=new o({}),this.interval=(t.jsonData||{}).timeInterval||"1m"}return t.$inject=["instanceSettings","backendSrv","$q","templateSrv","timeSrv"],t.prototype.query=function(t){var e=this,r=n.a.filter(t.targets,function(t){return!0!==t.hide}).map(function(r){var a=new o(r,e.templateSrv,t.scopedVars);return{refId:r.refId,intervalMs:t.intervalMs,maxDataPoints:t.maxDataPoints,datasourceId:e.id,rawSql:a.render(e.interpolateVariable),format:r.format}});return 0===r.length?this.$q.when({data:[]}):this.backendSrv.datasourceRequest({url:"/api/tsdb/query",method:"POST",data:{from:t.range.from.valueOf().toString(),to:t.range.to.valueOf().toString(),queries:r}}).then(this.responseParser.processQueryResult)},t.prototype.annotationQuery=function(t){var e=this;if(!t.annotation.rawQuery)return this.$q.reject({message:"Query missing in annotation definition"});var r={refId:t.annotation.name,datasourceId:this.id,rawSql:this.templateSrv.replace(t.annotation.rawQuery,t.scopedVars,this.interpolateVariable),format:"table"};return this.backendSrv.datasourceRequest({url:"/api/tsdb/query",method:"POST",data:{from:t.range.from.valueOf().toString(),to:t.range.to.valueOf().toString(),queries:[r]}}).then(function(r){return e.responseParser.transformAnnotationResponse(t,r)})},t.prototype.metricFindQuery=function(t,e){var r=this,a="tempvar";e&&e.variable&&e.variable.name&&(a=e.variable.name);var n={refId:a,datasourceId:this.id,rawSql:this.templateSrv.replace(t,{},this.interpolateVariable),format:"table"},i=this.timeSrv.timeRange(),s={queries:[n],from:i.from.valueOf().toString(),to:i.to.valueOf().toString()};return this.backendSrv.datasourceRequest({url:"/api/tsdb/query",method:"POST",data:s}).then(function(t){return r.responseParser.parseMetricFindQueryResult(a,t)})},t.prototype.getVersion=function(){return this.metricFindQuery("SELECT current_setting('server_version_num')::int/100",{})},t.prototype.getTimescaleDBVersion=function(){return this.metricFindQuery("SELECT extversion FROM pg_extension WHERE extname = 'timescaledb'",{})},t.prototype.testDatasource=function(){return this.metricFindQuery("SELECT 1",{}).then(function(t){return{status:"success",message:"Database Connection OK"}}).catch(function(t){return console.log(t),t.data&&t.data.message?{status:"error",message:t.data.message}:{status:"error",message:t.status}})},t.prototype.targetContainsTemplate=function(t){var e="";t.rawQuery?e=t.rawSql:e=new o(t).buildQuery();return e=e.replace("$__",""),this.templateSrv.variableExists(e)},t}(),l=r("Xmxp"),m=function(){function t(t,e){this.target=t,this.queryModel=e}return t.prototype.getOperators=function(t){switch(t){case"float4":case"float8":return["=","!=","<","<=",">",">="];case"text":case"varchar":case"char":return["=","!=","<","<=",">",">=","IN","NOT IN","LIKE","NOT LIKE","~","~*","!~","!~*"];default:return["=","!=","<","<=",">",">=","IN","NOT IN"]}},t.prototype.quoteIdentAsLiteral=function(t){return this.queryModel.quoteLiteral(this.queryModel.unquoteIdentifier(t))},t.prototype.findMetricTable=function(){var t="\nSELECT\n\tquote_ident(table_name) as table_name,\n\t( SELECT\n\t    quote_ident(column_name) as column_name\n\t  FROM information_schema.columns c\n    WHERE\n      c.table_schema = t.table_schema AND\n      c.table_name = t.table_name AND\n      udt_name IN ('timestamptz','timestamp')\n    ORDER BY ordinal_position LIMIT 1\n  ) AS time_column,\n  ( SELECT\n      quote_ident(column_name) AS column_name\n    FROM information_schema.columns c\n    WHERE\n      c.table_schema = t.table_schema AND\n      c.table_name = t.table_name AND\n      udt_name='float8'\n    ORDER BY ordinal_position LIMIT 1\n  ) AS value_column\nFROM information_schema.tables t\nWHERE ";return t+=this.buildSchemaConstraint(),t+=" AND\n  EXISTS\n  ( SELECT 1\n    FROM information_schema.columns c\n    WHERE\n      c.table_schema = t.table_schema AND\n      c.table_name = t.table_name AND\n      udt_name IN ('timestamptz','timestamp')\n  ) AND\n  EXISTS\n  ( SELECT 1\n    FROM information_schema.columns c\n    WHERE\n      c.table_schema = t.table_schema AND\n      c.table_name = t.table_name AND\n      udt_name='float8'\n  )\nLIMIT 1\n;"},t.prototype.buildSchemaConstraint=function(){return"\ntable_schema IN (\n  SELECT\n    CASE WHEN trim(s[i]) = '\"$user\"' THEN user ELSE trim(s[i]) END\n  FROM\n    generate_series(\n      array_lower(string_to_array(current_setting('search_path'),','),1),\n      array_upper(string_to_array(current_setting('search_path'),','),1)\n    ) as i,\n    string_to_array(current_setting('search_path'),',') s\n)"},t.prototype.buildTableConstraint=function(t){var e="";if(t.includes(".")){var r=t.split(".");return e="table_schema = "+this.quoteIdentAsLiteral(r[0]),e+=" AND table_name = "+this.quoteIdentAsLiteral(r[1])}return e=this.buildSchemaConstraint(),e+=" AND table_name = "+this.quoteIdentAsLiteral(t)},t.prototype.buildTableQuery=function(){var t="SELECT quote_ident(table_name) FROM information_schema.tables WHERE ";return t+=this.buildSchemaConstraint(),t+=" ORDER BY table_name"},t.prototype.buildColumnQuery=function(t){var e="SELECT quote_ident(column_name) FROM information_schema.columns WHERE ";switch(e+=this.buildTableConstraint(this.target.table),t){case"time":e+=" AND data_type IN ('timestamp without time zone','timestamp with time zone','bigint','integer','double precision','real')";break;case"metric":e+=" AND data_type IN ('text','character','character varying')";break;case"value":e+=" AND data_type IN ('bigint','integer','double precision','real')",e+=" AND column_name <> "+this.quoteIdentAsLiteral(this.target.timeColumn);break;case"group":e+=" AND data_type IN ('text','character','character varying')"}return e+=" ORDER BY column_name"},t.prototype.buildValueQuery=function(t){var e="SELECT DISTINCT quote_literal("+t+")";return e+=" FROM "+this.target.table,e+=" WHERE $__timeFilter("+this.target.timeColumn+")",e+=" AND "+t+" IS NOT NULL",e+=" ORDER BY 1 LIMIT 100"},t.prototype.buildDatatypeQuery=function(t){var e="SELECT udt_name FROM information_schema.columns WHERE ";return e+=this.buildTableConstraint(this.target.table),e+=" AND column_name = "+this.quoteIdentAsLiteral(t)},t.prototype.buildAggregateQuery=function(){return"INNER JOIN pg_proc ON pg_aggregate.aggfnoid = pg_proc.oid ","INNER JOIN pg_type ON pg_type.oid=pg_proc.prorettype ","WHERE pronargs=1 AND typname IN ('float8') AND aggkind='n' ORDER BY 1","SELECT DISTINCT proname FROM pg_aggregate INNER JOIN pg_proc ON pg_aggregate.aggfnoid = pg_proc.oid INNER JOIN pg_type ON pg_type.oid=pg_proc.prorettype WHERE pronargs=1 AND typname IN ('float8') AND aggkind='n' ORDER BY 1"},t}(),p=r("LzXI"),c=r("XXK+"),h=[];function d(t){h[t.type]=new c.b(t)}d({type:"column",style:"label",params:[{type:"column",dynamicLookup:!0}],defaultParams:["value"]}),d({type:"expression",style:"expression",label:"Expr:",params:[{name:"left",type:"string",dynamicLookup:!0},{name:"op",type:"string",dynamicLookup:!0},{name:"right",type:"string",dynamicLookup:!0}],defaultParams:["value","=","value"]}),d({type:"macro",style:"label",label:"Macro:",params:[],defaultParams:[]}),d({type:"aggregate",style:"label",params:[{name:"name",type:"string",options:["avg","count","min","max","sum","stddev","variance"]}],defaultParams:["avg"]}),d({type:"percentile",label:"Aggregate:",style:"label",params:[{name:"name",type:"string",options:["percentile_cont","percentile_disc"]},{name:"fraction",type:"number",options:["0.5","0.75","0.9","0.95","0.99"]}],defaultParams:["percentile_cont","0.95"]}),d({type:"alias",style:"label",params:[{name:"name",type:"string",quote:"double"}],defaultParams:["alias"]}),d({type:"time",style:"function",label:"time",params:[{name:"interval",type:"interval",options:["$__interval","1s","10s","1m","5m","10m","15m","1h"]},{name:"fill",type:"string",options:["none","NULL","previous","0"]}],defaultParams:["$__interval","none"]}),d({type:"window",style:"label",params:[{name:"function",type:"string",options:["delta","increase","rate","sum"]}],defaultParams:["increase"]}),d({type:"moving_window",style:"label",label:"Moving Window:",params:[{name:"function",type:"string",options:["avg"]},{name:"window_size",type:"number",options:["3","5","7","10","20"]}],defaultParams:["avg","5"]});var g={create:function(t){var e=h[t.type];return e?new c.a(t,e):null}},f="SELECT\n  $__time(time_column),\n  value1\nFROM\n  metric_table\nWHERE\n  $__timeFilter(time_column)\n",y=function(t){function e(e,r,a,n,i){var s=t.call(this,e,r)||this;return s.templateSrv=a,s.$q=n,s.uiSegmentSrv=i,s.target=s.target,s.queryModel=new o(s.target,a,s.panel.scopedVars),s.metaBuilder=new m(s.target,s.queryModel),s.updateProjection(),s.formats=[{text:"Time series",value:"time_series"},{text:"Table",value:"table"}],s.target.rawSql||("table"===s.panelCtrl.panel.type?(s.target.format="table",s.target.rawSql="SELECT 1",s.target.rawQuery=!0):(s.target.rawSql=f,s.datasource.metricFindQuery(s.metaBuilder.findMetricTable()).then(function(t){if(t.length>0){s.target.table=t[0].text;var e=s.uiSegmentSrv.newSegment(s.target.table);s.tableSegment.html=e.html,s.tableSegment.value=e.value,s.target.timeColumn=t[1].text,e=s.uiSegmentSrv.newSegment(s.target.timeColumn),s.timeColumnSegment.html=e.html,s.timeColumnSegment.value=e.value,s.target.timeColumnType="timestamp",s.target.select=[[{type:"column",params:[t[2].text]}]],s.updateProjection(),s.updateRawSqlAndRefresh()}}))),s.target.table?s.tableSegment=i.newSegment(s.target.table):s.tableSegment=i.newSegment({value:"select table",fake:!0}),s.timeColumnSegment=i.newSegment(s.target.timeColumn),s.metricColumnSegment=i.newSegment(s.target.metricColumn),s.buildSelectMenu(),s.whereAdd=s.uiSegmentSrv.newPlusButton(),s.groupAdd=s.uiSegmentSrv.newPlusButton(),s.panelCtrl.events.on("data-received",s.onDataReceived.bind(s),e),s.panelCtrl.events.on("data-error",s.onDataError.bind(s),e),s}return e.$inject=["$scope","$injector","templateSrv","$q","uiSegmentSrv"],i.c(e,t),e.prototype.updateRawSqlAndRefresh=function(){this.target.rawQuery||(this.target.rawSql=this.queryModel.buildQuery()),this.panelCtrl.refresh()},e.prototype.updateProjection=function(){this.selectParts=n.a.map(this.target.select,function(t){return n.a.map(t,g.create).filter(function(t){return t})}),this.whereParts=n.a.map(this.target.where,g.create).filter(function(t){return t}),this.groupParts=n.a.map(this.target.group,g.create).filter(function(t){return t})},e.prototype.updatePersistedParts=function(){this.target.select=n.a.map(this.selectParts,function(t){return n.a.map(t,function(t){return{type:t.def.type,datatype:t.datatype,params:t.params}})}),this.target.where=n.a.map(this.whereParts,function(t){return{type:t.def.type,datatype:t.datatype,name:t.name,params:t.params}}),this.target.group=n.a.map(this.groupParts,function(t){return{type:t.def.type,datatype:t.datatype,params:t.params}})},e.prototype.buildSelectMenu=function(){this.selectMenu=[];var t={text:"Aggregate Functions",value:"aggregate",submenu:[{text:"Average",value:"avg"},{text:"Count",value:"count"},{text:"Maximum",value:"max"},{text:"Minimum",value:"min"},{text:"Sum",value:"sum"},{text:"Standard deviation",value:"stddev"},{text:"Variance",value:"variance"}]};if(!0===this.datasource.jsonData.timescaledb&&(t.submenu.push({text:"First",value:"first"}),t.submenu.push({text:"Last",value:"last"})),this.selectMenu.push(t),this.datasource.jsonData.postgresVersion>=904){this.selectMenu.push({text:"Ordered-Set Aggregate Functions",value:"percentile",submenu:[{text:"Percentile (continuous)",value:"percentile_cont"},{text:"Percentile (discrete)",value:"percentile_disc"}]})}this.selectMenu.push({text:"Window Functions",value:"window",submenu:[{text:"Delta",value:"delta"},{text:"Increase",value:"increase"},{text:"Rate",value:"rate"},{text:"Sum",value:"sum"},{text:"Moving Average",value:"avg",type:"moving_window"}]}),this.selectMenu.push({text:"Alias",value:"alias"}),this.selectMenu.push({text:"Column",value:"column"})},e.prototype.toggleEditorMode=function(){var t=this;this.target.rawQuery?l.b.emit("confirm-modal",{title:"Warning",text2:"Switching to query builder may overwrite your raw SQL.",icon:"fa-exclamation",yesText:"Switch",onConfirm:function(){t.target.rawQuery=!t.target.rawQuery}}):this.target.rawQuery=!this.target.rawQuery},e.prototype.resetPlusButton=function(t){var e=this.uiSegmentSrv.newPlusButton();t.html=e.html,t.value=e.value},e.prototype.getTableSegments=function(){return this.datasource.metricFindQuery(this.metaBuilder.buildTableQuery()).then(this.transformToSegments({})).catch(this.handleQueryError.bind(this))},e.prototype.tableChanged=function(){var t=this;this.target.table=this.tableSegment.value,this.target.where=[],this.target.group=[],this.updateProjection();var e=this.uiSegmentSrv.newSegment("none");this.metricColumnSegment.html=e.html,this.metricColumnSegment.value=e.value,this.target.metricColumn="none";var r=this.datasource.metricFindQuery(this.metaBuilder.buildColumnQuery("time")).then(function(e){if(e.length>0&&!n.a.find(e,function(e){return e.text===t.target.timeColumn})){var r=t.uiSegmentSrv.newSegment(e[0].text);t.timeColumnSegment.html=r.html,t.timeColumnSegment.value=r.value}return t.timeColumnChanged(!1)}),a=this.datasource.metricFindQuery(this.metaBuilder.buildColumnQuery("value")).then(function(e){e.length>0&&(t.target.select=[[{type:"column",params:[e[0].text]}]],t.updateProjection())});this.$q.all([r,a]).then(function(){t.updateRawSqlAndRefresh()})},e.prototype.getTimeColumnSegments=function(){return this.datasource.metricFindQuery(this.metaBuilder.buildColumnQuery("time")).then(this.transformToSegments({})).catch(this.handleQueryError.bind(this))},e.prototype.timeColumnChanged=function(t){var e=this;return this.target.timeColumn=this.timeColumnSegment.value,this.datasource.metricFindQuery(this.metaBuilder.buildDatatypeQuery(this.target.timeColumn)).then(function(r){if(1===r.length){e.target.timeColumnType!==r[0].text&&(e.target.timeColumnType=r[0].text);var a=void 0;a=e.queryModel.hasUnixEpochTimecolumn()?g.create({type:"macro",name:"$__unixEpochFilter",params:[]}):g.create({type:"macro",name:"$__timeFilter",params:[]}),e.whereParts.length>=1&&"macro"===e.whereParts[0].def.type?e.whereParts[0]=a:e.whereParts.splice(0,0,a)}e.updatePersistedParts(),!1!==t&&e.updateRawSqlAndRefresh()})},e.prototype.getMetricColumnSegments=function(){return this.datasource.metricFindQuery(this.metaBuilder.buildColumnQuery("metric")).then(this.transformToSegments({addNone:!0})).catch(this.handleQueryError.bind(this))},e.prototype.metricColumnChanged=function(){this.target.metricColumn=this.metricColumnSegment.value,this.updateRawSqlAndRefresh()},e.prototype.onDataReceived=function(t){this.lastQueryMeta=null,this.lastQueryError=null,console.log("postgres query data received",t);var e=n.a.find(t,{refId:this.target.refId});e&&(this.lastQueryMeta=e.meta)},e.prototype.onDataError=function(t){if(t.data&&t.data.results){var e=t.data.results[this.target.refId];e&&(this.lastQueryMeta=e.meta,this.lastQueryError=e.error)}},e.prototype.transformToSegments=function(t){var e=this;return function(r){var a,s,o=n.a.map(r,function(t){return e.uiSegmentSrv.newSegment({value:t.text,expandable:t.expandable})});if(t.addTemplateVars)try{for(var u=i.i(e.templateSrv.variables),l=u.next();!l.done;l=u.next()){var m=l.value,p=void 0;p="$"+m.name,t.templateQuoter&&!1===m.multi&&(p=t.templateQuoter(p)),o.unshift(e.uiSegmentSrv.newSegment({type:"template",value:p,expandable:!0}))}}catch(t){a={error:t}}finally{try{l&&!l.done&&(s=u.return)&&s.call(u)}finally{if(a)throw a.error}}return t.addNone&&o.unshift(e.uiSegmentSrv.newSegment({type:"template",value:"none",expandable:!0})),o}},e.prototype.findAggregateIndex=function(t){return n.a.findIndex(t,function(t){return"aggregate"===t.def.type||"percentile"===t.def.type})},e.prototype.findWindowIndex=function(t){return n.a.findIndex(t,function(t){return"window"===t.def.type||"moving_window"===t.def.type})},e.prototype.addSelectPart=function(t,e,r){var a=e.value;r&&r.type&&(a=r.type);var i=g.create({type:a});r&&(i.params[0]=r.value);var s=!1;switch(a){case"column":var o=n.a.map(t,function(t){return g.create({type:t.def.type,params:n.a.clone(t.params)})});this.selectParts.push(o);break;case"percentile":case"aggregate":0===this.target.group.length&&this.addGroup("time","$__interval");var u=this.findAggregateIndex(t);-1!==u?t[u]=i:t.splice(1,0,i),n.a.find(t,function(t){return"alias"===t.def.type})||(s=!0);break;case"moving_window":case"window":var l=this.findWindowIndex(t);if(-1!==l)t[l]=i;else{var m=this.findAggregateIndex(t);-1!==m?t.splice(m+1,0,i):t.splice(1,0,i)}n.a.find(t,function(t){return"alias"===t.def.type})||(s=!0);break;case"alias":s=!0}s&&(i=g.create({type:"alias",params:[t[0].params[0].replace(/"/g,"")]}),"alias"===t[t.length-1].def.type?t[t.length-1]=i:t.push(i)),this.updatePersistedParts(),this.updateRawSqlAndRefresh()},e.prototype.removeSelectPart=function(t,e){if("column"===e.def.type){if(this.selectParts.length>1){var r=n.a.indexOf(this.selectParts,t);this.selectParts.splice(r,1)}}else{var a=n.a.indexOf(t,e);t.splice(a,1)}this.updatePersistedParts()},e.prototype.handleSelectPartEvent=function(t,e,r){switch(r.name){case"get-param-options":switch(e.def.type){case"aggregate":return this.datasource.metricFindQuery(this.metaBuilder.buildAggregateQuery()).then(this.transformToSegments({})).catch(this.handleQueryError.bind(this));case"column":return this.datasource.metricFindQuery(this.metaBuilder.buildColumnQuery("value")).then(this.transformToSegments({})).catch(this.handleQueryError.bind(this))}case"part-param-changed":this.updatePersistedParts(),this.updateRawSqlAndRefresh();break;case"action":this.removeSelectPart(t,e),this.updateRawSqlAndRefresh();break;case"get-part-actions":return this.$q.when([{text:"Remove",value:"remove-part"}])}},e.prototype.handleGroupPartEvent=function(t,e,r){switch(r.name){case"get-param-options":return this.datasource.metricFindQuery(this.metaBuilder.buildColumnQuery()).then(this.transformToSegments({})).catch(this.handleQueryError.bind(this));case"part-param-changed":this.updatePersistedParts(),this.updateRawSqlAndRefresh();break;case"action":this.removeGroup(t,e),this.updateRawSqlAndRefresh();break;case"get-part-actions":return this.$q.when([{text:"Remove",value:"remove-part"}])}},e.prototype.addGroup=function(t,e){var r,a,n=[e];"time"===t&&(n=["$__interval","none"]);var s=g.create({type:t,params:n});"time"===t?this.groupParts.splice(0,0,s):this.groupParts.push(s);try{for(var o=i.i(this.selectParts),u=o.next();!u.done;u=o.next()){var l=u.value;if(!l.some(function(t){return"aggregate"===t.def.type})){var m=g.create({type:"aggregate",params:["avg"]});if(l.splice(1,0,m),!l.some(function(t){return"alias"===t.def.type})){var p=g.create({type:"alias",params:[l[0].part.params[0]]});l.push(p)}}}}catch(t){r={error:t}}finally{try{u&&!u.done&&(a=o.return)&&a.call(o)}finally{if(r)throw r.error}}this.updatePersistedParts()},e.prototype.removeGroup=function(t,e){"time"===t.def.type&&(this.selectParts=n.a.map(this.selectParts,function(t){return n.a.filter(t,function(t){return"aggregate"!==t.def.type&&"percentile"!==t.def.type})})),this.groupParts.splice(e,1),this.updatePersistedParts()},e.prototype.handleWherePartEvent=function(t,e,r,a){var n=this;switch(r.name){case"get-param-options":switch(r.param.name){case"left":return this.datasource.metricFindQuery(this.metaBuilder.buildColumnQuery()).then(this.transformToSegments({})).catch(this.handleQueryError.bind(this));case"right":return["int4","int8","float4","float8","timestamp","timestamptz"].indexOf(e.datatype)>-1?this.$q.when([]):this.datasource.metricFindQuery(this.metaBuilder.buildValueQuery(e.params[0])).then(this.transformToSegments({addTemplateVars:!0,templateQuoter:function(t){return n.queryModel.quoteLiteral(t)}})).catch(this.handleQueryError.bind(this));case"op":return this.$q.when(this.uiSegmentSrv.newOperators(this.metaBuilder.getOperators(e.datatype)));default:return this.$q.when([])}case"part-param-changed":this.updatePersistedParts(),this.datasource.metricFindQuery(this.metaBuilder.buildDatatypeQuery(e.params[0])).then(function(t){1===t.length&&(e.datatype=t[0].text)}),this.updateRawSqlAndRefresh();break;case"action":t.splice(a,1),this.updatePersistedParts(),this.updateRawSqlAndRefresh();break;case"get-part-actions":return this.$q.when([{text:"Remove",value:"remove-part"}])}},e.prototype.getWhereOptions=function(){var t=[];return this.queryModel.hasUnixEpochTimecolumn()?t.push(this.uiSegmentSrv.newSegment({type:"macro",value:"$__unixEpochFilter"})):t.push(this.uiSegmentSrv.newSegment({type:"macro",value:"$__timeFilter"})),t.push(this.uiSegmentSrv.newSegment({type:"expression",value:"Expression"})),this.$q.when(t)},e.prototype.addWhereAction=function(t,e){switch(this.whereAdd.type){case"macro":var r=g.create({type:"macro",name:this.whereAdd.value,params:[]});this.whereParts.length>=1&&"macro"===this.whereParts[0].def.type?this.whereParts[0]=r:this.whereParts.splice(0,0,r);break;default:this.whereParts.push(g.create({type:"expression",params:["value","=","value"]}))}this.updatePersistedParts(),this.resetPlusButton(this.whereAdd),this.updateRawSqlAndRefresh()},e.prototype.getGroupOptions=function(){var t=this;return this.datasource.metricFindQuery(this.metaBuilder.buildColumnQuery("group")).then(function(e){var r,a,n=[];t.queryModel.hasTimeGroup()||n.push(t.uiSegmentSrv.newSegment({type:"time",value:"time($__interval,none)"}));try{for(var s=i.i(e),o=s.next();!o.done;o=s.next()){var u=o.value;n.push(t.uiSegmentSrv.newSegment({type:"column",value:u.text}))}}catch(t){r={error:t}}finally{try{o&&!o.done&&(a=s.return)&&a.call(s)}finally{if(r)throw r.error}}return n}).catch(this.handleQueryError.bind(this))},e.prototype.addGroupAction=function(){this.groupAdd.value,this.addGroup(this.groupAdd.type,this.groupAdd.value),this.resetPlusButton(this.groupAdd),this.updateRawSqlAndRefresh()},e.prototype.handleQueryError=function(t){return this.error=t.message||"Failed to issue metric query",[]},e.templateUrl="partials/query.editor.html",e}(p.QueryCtrl),v=r("QjE0"),b=function(){function t(t,e){this.postgresVersions=[{name:"9.3",value:903},{name:"9.4",value:904},{name:"9.5",value:905},{name:"9.6",value:906},{name:"10",value:1e3}],this.datasourceSrv=e,this.current.jsonData.sslmode=this.current.jsonData.sslmode||"verify-full",this.current.jsonData.postgresVersion=this.current.jsonData.postgresVersion||903,this.showTimescaleDBHelp=!1,this.autoDetectFeatures(),this.onPasswordReset=Object(v.c)(this,v.a.Password),this.onPasswordChange=Object(v.b)(this,v.a.Password)}return t.$inject=["$scope","datasourceSrv"],t.prototype.autoDetectFeatures=function(){var t=this;this.current.id&&this.datasourceSrv.loadDatasource(this.current.name).then(function(e){return e.getVersion().then(function(r){(r=Number(r[0].text))>=906&&e.getTimescaleDBVersion().then(function(e){1===e.length&&(t.current.jsonData.timescaledb=!0)});var a=Math.trunc(r/100),i=r%100,s=String(a);r<1e3&&(s=String(a)+"."+String(i)),n.a.find(t.postgresVersions,function(t){return t.value===r})||t.postgresVersions.push({name:s,value:r}),t.current.jsonData.postgresVersion=r})})},t.prototype.toggleTimescaleDBHelp=function(){this.showTimescaleDBHelp=!this.showTimescaleDBHelp},t.templateUrl="partials/config.html",t}();r.d(e,"AnnotationsQueryCtrl",function(){return w}),r.d(e,"PostgresDatasource",function(){return u}),r.d(e,"Datasource",function(){return u}),r.d(e,"QueryCtrl",function(){return y}),r.d(e,"ConfigCtrl",function(){return b});var S="SELECT\n  extract(epoch from time_column) AS time,\n  text_column as text,\n  tags_column as tags\nFROM\n  metric_table\nWHERE\n  $__timeFilter(time_column)\n",w=function(){function t(){this.annotation.rawQuery=this.annotation.rawQuery||S}return t.templateUrl="partials/annotations.editor.html",t}()},"XXK+":function(t,e,r){"use strict";r.d(e,"b",function(){return i}),r.d(e,"a",function(){return s});var a=r("LvDl"),n=r.n(a),i=function(){return function(t){this.type=t.type,t.label?this.label=t.label:this.label=this.type[0].toUpperCase()+this.type.substring(1)+":",this.style=t.style,"function"===this.style?(this.wrapOpen="(",this.wrapClose=")",this.separator=", "):(this.wrapOpen=" ",this.wrapClose=" ",this.separator=" "),this.params=t.params,this.defaultParams=t.defaultParams}}(),s=function(){function t(t,e){if(this.part=t,this.def=e,!this.def)throw{message:"Could not find sql part "+t.type};this.datatype=t.datatype,t.name?(this.name=t.name,this.label=e.label+" "+t.name):(this.name="",this.label=e.label),t.params=t.params||n.a.clone(this.def.defaultParams),this.params=t.params}return t.prototype.updateParam=function(t,e){""===t&&this.def.params[e].optional?this.params.splice(e,1):this.params[e]=t,this.part.params=this.params},t}()}}]);
//# sourceMappingURL=postgresPlugin.3932bda029d2299a9d96.js.map