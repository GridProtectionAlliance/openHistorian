(window.webpackJsonp=window.webpackJsonp||[]).push([[30],{nKVo:function(e,t,a){"use strict";b.$inject=["$compile"],k.$inject=["$compile","templateSrv"],a.r(t);var r=a("LvDl"),n=a.n(r),i=a("Obii"),s=/^(\d+)(?:\.(\d+))?(?:\.(\d+))?(?:-([0-9A-Za-z\.]+))?/,o=function(){function e(e){var t=s.exec(e);t&&(this.major=Number(t[1]),this.minor=Number(t[2]||0),this.patch=Number(t[3]||0),this.meta=t[4])}return e.prototype.isGtOrEq=function(t){for(var a=new e(t),r=0;r<this.comparable.length;++r){if(this.comparable[r]>a.comparable[r])return!0;if(this.comparable[r]<a.comparable[r])return!1}return!0},e.prototype.isValid=function(){return n.a.isNumber(this.major)},Object.defineProperty(e.prototype,"comparable",{get:function(){return[this.major,this.minor,this.patch]},enumerable:!0,configurable:!0}),e}();function u(e,t){return new o(e).isGtOrEq(t)}var m={};function p(e){e.params=e.params||[],e.defaultParams=e.defaultParams||[],m[e.name]=e,e.shortName&&(m[e.shortName]=e)}var l=[{name:"other",type:"value_or_series",optional:!0,multiple:!0}];function c(e,t){return!e.version||u(t,e.version)}p({name:"scaleToSeconds",category:"Transform",params:[{name:"seconds",type:"int"}],defaultParams:[1]}),p({name:"perSecond",category:"Transform",params:[{name:"max value",type:"int",optional:!0}],defaultParams:[]}),p({name:"holtWintersForecast",category:"Calculate"}),p({name:"holtWintersConfidenceBands",category:"Calculate",params:[{name:"delta",type:"int"}],defaultParams:[3]}),p({name:"holtWintersAberration",category:"Calculate",params:[{name:"delta",type:"int"}],defaultParams:[3]}),p({name:"nPercentile",category:"Calculate",params:[{name:"Nth percentile",type:"int"}],defaultParams:[95]}),p({name:"diffSeries",params:l,defaultParams:["#A"],category:"Combine"}),p({name:"stddevSeries",params:l,defaultParams:[""],category:"Combine"}),p({name:"divideSeries",params:l,defaultParams:["#A"],category:"Combine"}),p({name:"multiplySeries",params:l,defaultParams:["#A"],category:"Combine"}),p({name:"asPercent",params:l,defaultParams:["#A"],category:"Combine"}),p({name:"group",params:l,defaultParams:["#A","#B"],category:"Combine"}),p({name:"sumSeries",shortName:"sum",category:"Combine",params:l,defaultParams:[""]}),p({name:"averageSeries",shortName:"avg",category:"Combine",params:l,defaultParams:[""]}),p({name:"rangeOfSeries",category:"Combine"}),p({name:"percentileOfSeries",category:"Combine",params:[{name:"n",type:"int"},{name:"interpolate",type:"boolean",options:["true","false"]}],defaultParams:[95,"false"]}),p({name:"sumSeriesWithWildcards",category:"Combine",params:[{name:"node",type:"int",multiple:!0}],defaultParams:[3]}),p({name:"maxSeries",shortName:"max",category:"Combine"}),p({name:"minSeries",shortName:"min",category:"Combine"}),p({name:"averageSeriesWithWildcards",category:"Combine",params:[{name:"node",type:"int",multiple:!0}],defaultParams:[3]}),p({name:"alias",category:"Alias",params:[{name:"alias",type:"string"}],defaultParams:["alias"]}),p({name:"aliasSub",category:"Alias",params:[{name:"search",type:"string"},{name:"replace",type:"string"}],defaultParams:["","\\1"]}),p({name:"consolidateBy",category:"Special",params:[{name:"function",type:"string",options:["sum","average","min","max"]}],defaultParams:["max"]}),p({name:"cumulative",category:"Special",params:[],defaultParams:[]}),p({name:"groupByNode",category:"Combine",params:[{name:"node",type:"int",options:[0,1,2,3,4,5,6,7,8,9,10,12]},{name:"function",type:"string",options:["sum","avg","maxSeries"]}],defaultParams:[3,"sum"]}),p({name:"aliasByNode",category:"Alias",params:[{name:"node",type:"int",options:[0,1,2,3,4,5,6,7,8,9,10,12],multiple:!0}],defaultParams:[3]}),p({name:"substr",category:"Special",params:[{name:"start",type:"int",options:[-6,-5,-4,-3,-2,-1,0,1,2,3,4,5,6,7,8,9,10,12]},{name:"stop",type:"int",options:[-6,-5,-4,-3,-2,-1,0,1,2,3,4,5,6,7,8,9,10,12]}],defaultParams:[0,0]}),p({name:"sortByName",category:"Sorting",params:[{name:"natural",type:"boolean",options:["true","false"],optional:!0}],defaultParams:["false"]}),p({name:"sortByMaxima",category:"Sorting"}),p({name:"sortByMinima",category:"Sorting"}),p({name:"sortByTotal",category:"Sorting"}),p({name:"aliasByMetric",category:"Alias"}),p({name:"randomWalk",fake:!0,category:"Special",params:[{name:"name",type:"string"}],defaultParams:["randomWalk"]}),p({name:"countSeries",category:"Combine"}),p({name:"constantLine",category:"Special",params:[{name:"value",type:"int"}],defaultParams:[10]}),p({name:"cactiStyle",category:"Special"}),p({name:"keepLastValue",category:"Transform",params:[{name:"n",type:"int"}],defaultParams:[100]}),p({name:"changed",category:"Special",params:[],defaultParams:[]}),p({name:"scale",category:"Transform",params:[{name:"factor",type:"int"}],defaultParams:[1]}),p({name:"offset",category:"Transform",params:[{name:"amount",type:"int"}],defaultParams:[10]}),p({name:"transformNull",category:"Transform",params:[{name:"amount",type:"int"}],defaultParams:[0]}),p({name:"integral",category:"Transform"}),p({name:"derivative",category:"Transform"}),p({name:"nonNegativeDerivative",category:"Transform",params:[{name:"max value or 0",type:"int",optional:!0}],defaultParams:[""]}),p({name:"timeShift",category:"Transform",params:[{name:"amount",type:"select",options:["1h","6h","12h","1d","2d","7d","14d","30d"]}],defaultParams:["1d"]}),p({name:"timeStack",category:"Transform",params:[{name:"timeShiftUnit",type:"select",options:["1h","6h","12h","1d","2d","7d","14d","30d"]},{name:"timeShiftStart",type:"int"},{name:"timeShiftEnd",type:"int"}],defaultParams:["1d",0,7]}),p({name:"summarize",category:"Transform",params:[{name:"interval",type:"string"},{name:"func",type:"select",options:["sum","avg","min","max","last"]},{name:"alignToFrom",type:"boolean",optional:!0,options:["false","true"]}],defaultParams:["1h","sum","false"]}),p({name:"smartSummarize",category:"Transform",params:[{name:"interval",type:"string"},{name:"func",type:"select",options:["sum","avg","min","max","last"]}],defaultParams:["1h","sum"]}),p({name:"absolute",category:"Transform"}),p({name:"hitcount",category:"Transform",params:[{name:"interval",type:"string"}],defaultParams:["10s"]}),p({name:"log",category:"Transform",params:[{name:"base",type:"int"}],defaultParams:["10"]}),p({name:"averageAbove",category:"Filter Series",params:[{name:"n",type:"int"}],defaultParams:[25]}),p({name:"averageBelow",category:"Filter Series",params:[{name:"n",type:"int"}],defaultParams:[25]}),p({name:"currentAbove",category:"Filter Series",params:[{name:"n",type:"int"}],defaultParams:[25]}),p({name:"currentBelow",category:"Filter Series",params:[{name:"n",type:"int"}],defaultParams:[25]}),p({name:"maximumAbove",category:"Filter Series",params:[{name:"value",type:"int"}],defaultParams:[0]}),p({name:"maximumBelow",category:"Filter Series",params:[{name:"value",type:"int"}],defaultParams:[0]}),p({name:"minimumAbove",category:"Filter Series",params:[{name:"value",type:"int"}],defaultParams:[0]}),p({name:"minimumBelow",category:"Filter Series",params:[{name:"value",type:"int"}],defaultParams:[0]}),p({name:"limit",category:"Filter Series",params:[{name:"n",type:"int"}],defaultParams:[5]}),p({name:"mostDeviant",category:"Filter Series",params:[{name:"n",type:"int"}],defaultParams:[10]}),p({name:"exclude",category:"Filter Series",params:[{name:"exclude",type:"string"}],defaultParams:["exclude"]}),p({name:"highestCurrent",category:"Filter Series",params:[{name:"count",type:"int"}],defaultParams:[5]}),p({name:"highestMax",category:"Filter Series",params:[{name:"count",type:"int"}],defaultParams:[5]}),p({name:"lowestCurrent",category:"Filter Series",params:[{name:"count",type:"int"}],defaultParams:[5]}),p({name:"movingAverage",category:"Calculate",params:[{name:"windowSize",type:"int_or_interval",options:["5","7","10","5min","10min","30min","1hour"]}],defaultParams:[10]}),p({name:"movingMedian",category:"Calculate",params:[{name:"windowSize",type:"int_or_interval",options:["5","7","10","5min","10min","30min","1hour"]}],defaultParams:["5"]}),p({name:"stdev",category:"Calculate",params:[{name:"n",type:"int"},{name:"tolerance",type:"int"}],defaultParams:[5,.1]}),p({name:"highestAverage",category:"Filter Series",params:[{name:"count",type:"int"}],defaultParams:[5]}),p({name:"lowestAverage",category:"Filter Series",params:[{name:"count",type:"int"}],defaultParams:[5]}),p({name:"removeAbovePercentile",category:"Filter Data",params:[{name:"n",type:"int"}],defaultParams:[5]}),p({name:"removeAboveValue",category:"Filter Data",params:[{name:"n",type:"int"}],defaultParams:[5]}),p({name:"removeBelowPercentile",category:"Filter Data",params:[{name:"n",type:"int"}],defaultParams:[5]}),p({name:"removeBelowValue",category:"Filter Data",params:[{name:"n",type:"int"}],defaultParams:[5]}),p({name:"useSeriesAbove",category:"Filter Series",params:[{name:"value",type:"int"},{name:"search",type:"string"},{name:"replace",type:"string"}],defaultParams:[0,"search","replace"]}),p({name:"aggregateLine",category:"Calculate",params:[{name:"func",type:"select",options:["sum","avg","min","max","last"]}],defaultParams:["avg"],version:"1.0"}),p({name:"averageOutsidePercentile",category:"Filter Series",params:[{name:"n",type:"int"}],defaultParams:[95],version:"1.0"}),p({name:"delay",category:"Transform",params:[{name:"steps",type:"int"}],defaultParams:[1],version:"1.0"}),p({name:"exponentialMovingAverage",category:"Calculate",params:[{name:"windowSize",type:"int_or_interval",options:["5","7","10","5min","10min","30min","1hour"]}],defaultParams:[10],version:"1.0"}),p({name:"fallbackSeries",category:"Special",params:[{name:"fallback",type:"string"}],defaultParams:["constantLine(0)"],version:"1.0"}),p({name:"grep",category:"Filter Series",params:[{name:"grep",type:"string"}],defaultParams:["grep"],version:"1.0"}),p({name:"groupByNodes",category:"Combine",params:[{name:"function",type:"string",options:["sum","avg","maxSeries"]},{name:"node",type:"int",options:[0,1,2,3,4,5,6,7,8,9,10,12],multiple:!0}],defaultParams:["sum",3],version:"1.0"}),p({name:"integralByInterval",category:"Transform",params:[{name:"intervalUnit",type:"select",options:["1h","6h","12h","1d","2d","7d","14d","30d"]}],defaultParams:["1d"],version:"1.0"}),p({name:"interpolate",category:"Transform",params:[{name:"limit",type:"int",optional:!0}],defaultParams:[],version:"1.0"}),p({name:"invert",category:"Transform",version:"1.0"}),p({name:"isNonNull",category:"Combine",version:"1.0"}),p({name:"linearRegression",category:"Calculate",params:[{name:"startSourceAt",type:"select",options:["-1h","-6h","-12h","-1d","-2d","-7d","-14d","-30d"],optional:!0},{name:"endSourceAt",type:"select",options:["-1h","-6h","-12h","-1d","-2d","-7d","-14d","-30d"],optional:!0}],defaultParams:[],version:"1.0"}),p({name:"mapSeries",shortName:"map",params:[{name:"node",type:"int"}],defaultParams:[3],category:"Combine",version:"1.0"}),p({name:"movingMin",category:"Calculate",params:[{name:"windowSize",type:"int_or_interval",options:["5","7","10","5min","10min","30min","1hour"]}],defaultParams:[10],version:"1.0"}),p({name:"movingMax",category:"Calculate",params:[{name:"windowSize",type:"int_or_interval",options:["5","7","10","5min","10min","30min","1hour"]}],defaultParams:[10],version:"1.0"}),p({name:"movingSum",category:"Calculate",params:[{name:"windowSize",type:"int_or_interval",options:["5","7","10","5min","10min","30min","1hour"]}],defaultParams:[10],version:"1.0"}),p({name:"multiplySeriesWithWildcards",category:"Combine",params:[{name:"position",type:"int",options:[0,1,2,3,4,5,6,7,8,9,10,12],multiple:!0}],defaultParams:[2],version:"1.0"}),p({name:"offsetToZero",category:"Transform",version:"1.0"}),p({name:"pow",category:"Transform",params:[{name:"factor",type:"int"}],defaultParams:[10],version:"1.0"}),p({name:"powSeries",category:"Transform",params:l,defaultParams:[""],version:"1.0"}),p({name:"reduceSeries",shortName:"reduce",params:[{name:"function",type:"string",options:["asPercent","diffSeries","divideSeries"]},{name:"reduceNode",type:"int",options:[0,1,2,3,4,5,6,7,8,9,10,11,12,13]},{name:"reduceMatchers",type:"string",multiple:!0}],defaultParams:["asPercent",2,"used_bytes"],category:"Combine",version:"1.0"}),p({name:"removeBetweenPercentile",category:"Filter Series",params:[{name:"n",type:"int"}],defaultParams:[95],version:"1.0"}),p({name:"removeEmptySeries",category:"Filter Series",version:"1.0"}),p({name:"squareRoot",category:"Transform",version:"1.0"}),p({name:"timeSlice",category:"Transform",params:[{name:"startSliceAt",type:"select",options:["-1h","-6h","-12h","-1d","-2d","-7d","-14d","-30d"]},{name:"endSliceAt",type:"select",options:["-1h","-6h","-12h","-1d","-2d","-7d","-14d","-30d"],optional:!0}],defaultParams:["-1h"],version:"1.0"}),p({name:"weightedAverage",category:"Combine",params:[{name:"other",type:"value_or_series",optional:!0},{name:"node",type:"int",options:[0,1,2,3,4,5,6,7,8,9,10,12]}],defaultParams:["#A",4],version:"1.0"}),p({name:"seriesByTag",category:"Special",params:[{name:"tagExpression",type:"string",multiple:!0}],version:"1.1"}),p({name:"groupByTags",category:"Combine",params:[{name:"function",type:"string",options:["sum","avg","maxSeries"]},{name:"tag",type:"string",multiple:!0}],defaultParams:["sum","tag"],version:"1.1"}),p({name:"aliasByTags",category:"Alias",params:[{name:"tag",type:"string",multiple:!0}],defaultParams:["tag"],version:"1.1"});var h=function(){function e(e,t){this.def=e,this.params=[],t&&t.withDefaultParams&&(this.params=e.defaultParams.slice(0)),this.updateText()}return e.prototype.render=function(e,t){for(var a=this,r=this.def.name+"(",i=n.a.map(this.params,function(e,r){var i;if(r<a.def.params.length?i=a.def.params[r].type:n.a.get(n.a.last(a.def.params),"multiple")&&(i=n.a.get(n.a.last(a.def.params),"type")),n.a.includes(["value_or_series","boolean","int","float","node"],i))return e;var s=n.a.isString(e)?t(e):e;return n.a.includes(["int_or_interval","node_or_tag"],i)&&n.a.isFinite(+s)?n.a.toString(e):"'"+e+"'"});""===i[i.length-1];)i.pop();return e&&i.unshift(e),r+i.join(", ")+")"},e.prototype._hasMultipleParamsInString=function(e,t){return-1!==e.indexOf(",")&&(!(!this.def.params[t+1]||!this.def.params[t+1].optional)||!!(t+1>=this.def.params.length&&n.a.get(n.a.last(this.def.params),"multiple")))},e.prototype.updateParam=function(e,t){var a=this;this._hasMultipleParamsInString(e,t)?n.a.each(e.split(","),function(e,r){a.updateParam(e.trim(),t+r)}):(""===e&&(t>=this.def.params.length||this.def.params[t].optional)?this.params.splice(t,1):this.params[t]=e,this.updateText())},e.prototype.updateText=function(){if(0!==this.params.length){var e=this.def.name+"(";e+=this.params.join(", "),e+=")",this.text=e}else this.text=this.def.name+"()"},e}();function f(e,t){if(!(t||m)[e])throw{message:"Method not found "+e};return(t||m)[e]}var g={createFuncInstance:function(e,t,a){return n.a.isString(e)&&(e=f(e,a)),new h(e,t)},getFuncDef:f,getFuncDefs:function(e,t){var a={};return n.a.forEach(t||m,function(t){c(t,e)&&(a[t.name]=n.a.assign({},t,{params:n.a.filter(t.params,function(t){return c(t,e)})}))}),a},parseFuncDefs:function(e){var t={};return n.a.forEach(e||{},function(e,a){if("Graph"!==e.group){var r=e.description;r&&(r=r.replace(/:py:func:`(.+)( <[^>]*>)?`/g,"``$1``").replace(/.. seealso:: /g,"See also: ").replace(/.. code-block *:: *none/g,".. code-block::"));var i={name:e.name,description:r,category:e.group,params:[],defaultParams:[],fake:!1};/^seriesLists?$/.test(n.a.get(e,"params[0].type",""))?e.params[0].multiple?e.params[0].required=!1:e.params.shift():i.fake=!0,n.a.forEach(e.params,function(e){var t={name:e.name,type:"string",optional:!e.required,multiple:!!e.multiple,options:void 0};void 0!==e.default?i.defaultParams.push(n.a.toString(e.default)):e.suggestions?i.defaultParams.push(n.a.toString(e.suggestions[0])):i.defaultParams.push(""),"boolean"===e.type?(t.type="boolean",t.options=["true","false"]):"integer"===e.type?t.type="int":"float"===e.type?t.type="float":"node"===e.type?(t.type="node",t.options=["0","1","2","3","4","5","6","7","8","9","10","11","12"]):"nodeOrTag"===e.type?(t.type="node_or_tag",t.options=["name","0","1","2","3","4","5","6","7","8","9","10","11","12"]):"intOrInterval"===e.type?t.type="int_or_interval":"seriesList"===e.type&&(t.type="value_or_series"),e.options?t.options=n.a.map(e.options,n.a.toString):e.suggestions&&(t.options=n.a.map(e.suggestions,n.a.toString)),i.params.push(t)}),t[a]=i}}),t}},d=function(){function e(e,t,a,r){this.$q=t,this.backendSrv=a,this.templateSrv=r,this.funcDefs=null,this.funcDefsPromise=null,this.basicAuth=e.basicAuth,this.url=e.url,this.name=e.name,this.graphiteVersion=e.jsonData.graphiteVersion||"0.9",this.supportsTags=u(this.graphiteVersion,"1.1"),this.cacheTimeout=e.cacheTimeout,this.withCredentials=e.withCredentials,this.funcDefs=null,this.funcDefsPromise=null,this._seriesRefLetters="ABCDEFGHIJKLMNOPQRSTUVWXYZ"}return e.$inject=["instanceSettings","$q","backendSrv","templateSrv"],e.prototype.getQueryOptionsInfo=function(){return{maxDataPoints:!0,cacheTimeout:!0,links:[{text:"Help",url:"http://docs.grafana.org/features/datasources/graphite/#using-graphite-in-grafana"}]}},e.prototype.query=function(e){var t={from:this.translateTime(e.rangeRaw.from,!1,e.timezone),until:this.translateTime(e.rangeRaw.to,!0,e.timezone),targets:e.targets,format:e.format,cacheTimeout:e.cacheTimeout||this.cacheTimeout,maxDataPoints:e.maxDataPoints},a=this.buildGraphiteParams(t,e.scopedVars);if(0===a.length)return this.$q.when({data:[]});var r={method:"POST",url:"/render",data:a.join("&"),headers:{"Content-Type":"application/x-www-form-urlencoded"}};return this.addTracingHeaders(r,e),e.panelId&&(r.requestId=this.name+".panelId."+e.panelId),this.doGraphiteRequest(r).then(this.convertDataPointsToMs)},e.prototype.addTracingHeaders=function(e,t){!this.url.match(/^http/)&&(e.headers["X-Dashboard-Id"]=t.dashboardId,e.headers["X-Panel-Id"]=t.panelId)},e.prototype.convertDataPointsToMs=function(e){if(!e||!e.data)return[];for(var t=0;t<e.data.length;t++)for(var a=e.data[t],r=0;r<a.datapoints.length;r++)a.datapoints[r][1]*=1e3;return e},e.prototype.parseTags=function(e){var t=[];return 1===(t=e.split(",")).length&&""===(t=e.split(" "))[0]&&(t=[]),t},e.prototype.annotationQuery=function(e){var t=this;if(e.annotation.target){var a=this.templateSrv.replace(e.annotation.target,{},"glob"),r={rangeRaw:e.rangeRaw,targets:[{target:a}],format:"json",maxDataPoints:100};return this.query(r).then(function(t){for(var a=[],r=0;r<t.data.length;r++)for(var n=t.data[r],i=0;i<n.datapoints.length;i++){var s=n.datapoints[i];s[0]&&a.push({annotation:e.annotation,time:s[1],title:n.target})}return a})}var i=this.templateSrv.replace(e.annotation.tags);return this.events({range:e.rangeRaw,tags:i}).then(function(a){for(var r=[],i=0;i<a.data.length;i++){var s=a.data[i],o=s.tags;n.a.isString(s.tags)&&(o=t.parseTags(s.tags)),r.push({annotation:e.annotation,time:1e3*s.when,title:s.what,tags:o,text:s.data})}return r})},e.prototype.events=function(e){try{var t="";return e.tags&&(t="&tags="+e.tags),this.doGraphiteRequest({method:"GET",url:"/events/get_data?from="+this.translateTime(e.range.from,!1,e.timezone)+"&until="+this.translateTime(e.range.to,!0,e.timezone)+t})}catch(e){return this.$q.reject(e)}},e.prototype.targetContainsTemplate=function(e){return this.templateSrv.variableExists(e.target)},e.prototype.translateTime=function(e,t,a){if(n.a.isString(e)){if("now"===e)return"now";if(e.indexOf("now-")>=0&&-1===e.indexOf("/"))return e=(e=(e=e.substring(3)).replace("m","min")).replace("M","mon");e=i.dateMath.parse(e,t,a)}return t?e.get("s")&&e.add(1,"s"):!1===t&&e.get("s")&&e.subtract(1,"s"),e.unix()},e.prototype.metricFindQuery=function(e,t){var a=t||{},r=this.templateSrv.replace(e),i=r.match(/^tag_values\(([^,]+)((, *[^,]+)*)\)$/);if(i){for(var s=[],o=(u=/, *([^,]+)/g).exec(i[2]);null!==o;)s.push(o[1]),o=u.exec(i[2]);return a.limit=1e4,this.getTagValuesAutoComplete(s,i[1],void 0,a)}if(i=r.match(/^tags\(([^,]*)((, *[^,]+)*)\)$/)){s=[];if(i[1]){s.push(i[1]);var u;for(o=(u=/, *([^,]+)/g).exec(i[2]);null!==o;)s.push(o[1]),o=u.exec(i[2])}return a.limit=1e4,this.getTagsAutoComplete(s,void 0,a)}var m={method:"POST",url:"/metrics/find",params:{},data:"query="+r,headers:{"Content-Type":"application/x-www-form-urlencoded"},requestId:a.requestId};return a.range&&(m.params.from=this.translateTime(a.range.from,!1,a.timezone),m.params.until=this.translateTime(a.range.to,!0,a.timezone)),this.doGraphiteRequest(m).then(function(e){return n.a.map(e.data,function(e){return{text:e.text,expandable:!!e.expandable}})})},e.prototype.getTags=function(e){var t=e||{},a={method:"GET",url:"/tags",requestId:t.requestId};return t.range&&(a.params.from=this.translateTime(t.range.from,!1,t.timezone),a.params.until=this.translateTime(t.range.to,!0,t.timezone)),this.doGraphiteRequest(a).then(function(e){return n.a.map(e.data,function(e){return{text:e.tag,id:e.id}})})},e.prototype.getTagValues=function(e,t){var a=t||{},r={method:"GET",url:"/tags/"+this.templateSrv.replace(e),requestId:a.requestId};return a.range&&(r.params.from=this.translateTime(a.range.from,!1,a.timezone),r.params.until=this.translateTime(a.range.to,!0,a.timezone)),this.doGraphiteRequest(r).then(function(e){return e.data&&e.data.values?n.a.map(e.data.values,function(e){return{text:e.value,id:e.id}}):[]})},e.prototype.getTagsAutoComplete=function(e,t,a){var r=this,i=a||{},s={method:"GET",url:"/tags/autoComplete/tags",params:{expr:n.a.map(e,function(e){return r.templateSrv.replace((e||"").trim())})},requestId:i.requestId};return t&&(s.params.tagPrefix=t),i.limit&&(s.params.limit=i.limit),i.range&&(s.params.from=this.translateTime(i.range.from,!1,i.timezone),s.params.until=this.translateTime(i.range.to,!0,i.timezone)),this.doGraphiteRequest(s).then(function(e){return e.data?n.a.map(e.data,function(e){return{text:e}}):[]})},e.prototype.getTagValuesAutoComplete=function(e,t,a,r){var i=this,s=r||{},o={method:"GET",url:"/tags/autoComplete/values",params:{expr:n.a.map(e,function(e){return i.templateSrv.replace((e||"").trim())}),tag:this.templateSrv.replace((t||"").trim())},requestId:s.requestId};return a&&(o.params.valuePrefix=a),s.limit&&(o.params.limit=s.limit),s.range&&(o.params.from=this.translateTime(s.range.from,!1,s.timezone),o.params.until=this.translateTime(s.range.to,!0,s.timezone)),this.doGraphiteRequest(o).then(function(e){return e.data?n.a.map(e.data,function(e){return{text:e}}):[]})},e.prototype.getVersion=function(e){var t={method:"GET",url:"/version",requestId:(e||{}).requestId};return this.doGraphiteRequest(t).then(function(e){return e.data&&new o(e.data).isValid()?e.data:""}).catch(function(){return""})},e.prototype.createFuncInstance=function(e,t){return g.createFuncInstance(e,t,this.funcDefs)},e.prototype.getFuncDef=function(e){return g.getFuncDef(e,this.funcDefs)},e.prototype.waitForFuncDefsLoaded=function(){return this.getFuncDefs()},e.prototype.getFuncDefs=function(){var e=this;if(null!==this.funcDefsPromise)return this.funcDefsPromise;if(!u(this.graphiteVersion,"1.1"))return this.funcDefs=g.getFuncDefs(this.graphiteVersion),this.funcDefsPromise=Promise.resolve(this.funcDefs),this.funcDefsPromise;return this.funcDefsPromise=this.doGraphiteRequest({method:"GET",url:"/functions"}).then(function(t){return 200!==t.status||"object"!=typeof t.data?e.funcDefs=g.getFuncDefs(e.graphiteVersion):e.funcDefs=g.parseFuncDefs(t.data),e.funcDefs}).catch(function(t){return console.log("Fetching graphite functions error",t),e.funcDefs=g.getFuncDefs(e.graphiteVersion),e.funcDefs}),this.funcDefsPromise},e.prototype.testDatasource=function(){return this.query({panelId:3,rangeRaw:{from:"now-1h",to:"now"},targets:[{target:"constantLine(100)"}],maxDataPoints:300}).then(function(){return{status:"success",message:"Data source is working"}})},e.prototype.doGraphiteRequest=function(e){return(this.basicAuth||this.withCredentials)&&(e.withCredentials=!0),this.basicAuth&&(e.headers=e.headers||{},e.headers.Authorization=this.basicAuth),e.url=this.url+e.url,e.inspect={type:"graphite"},this.backendSrv.datasourceRequest(e)},e.prototype.buildGraphiteParams=function(e,t){var a,r,i,s=["from","until","rawData","format","maxDataPoints","cacheTimeout"],o=[],u={},m=/\#([A-Z])/g,p=/'(\d+)m'/gi,l=!1;function c(e){return e.replace("m","min").replace("M","mon")}for(e.format="json",i=0;i<e.targets.length;i++)(a=e.targets[i]).target&&(a.refId||(a.refId=this._seriesRefLetters[i]),r=(r=this.templateSrv.replace(a.target,t)).replace(p,c),u[a.refId]=r);function h(e,t){return u[t]||e}for(i=0;i<e.targets.length;i++)(a=e.targets[i]).target&&(r=(r=u[a.refId]).replace(m,h),u[a.refId]=r,a.hide||(l=!0,o.push("target="+encodeURIComponent(r))));return n.a.each(e,function(e,t){-1!==n.a.indexOf(s,t)&&e&&o.push(t+"="+encodeURIComponent(e))}),l?o:[]},e}();var y=a("mrSG"),v=a("+2Rf"),S=a.n(v),T=a("XI+/"),P=a.n(T),x=a("txxJ");function b(e){return{link:function(t,r){var i,s=this,o=t.ctrl,u=S()('<input type="text" class="gf-form-input" spellcheck="false" style="display:none"></input>'),m=S()('<a class="gf-form-label query-part dropdown-toggle" tabindex="1" gf-dropdown="functionMenu" data-toggle="dropdown"><i class="fa fa-plus"></i></a>');u.appendTo(r),m.appendTo(r),o.datasource.getFuncDefs().then(function(a){var i=n.a.map(a,"name").sort();t.functionMenu=function(e){var t={};return n.a.forEach(e,function(e){e.category&&(t[e.category]||(t[e.category]=[]),t[e.category].push({text:e.name,click:"ctrl.addFunction('"+e.name+"')"}))}),n.a.sortBy(n.a.map(t,function(e,t){return{text:t,submenu:n.a.sortBy(e,"text")}}),"text")}(a),u.attr("data-provide","typeahead"),u.typeahead({source:i,minLength:1,items:10,updater:function(e){var a=o.datasource.getFuncDef(e);return a||(e=e.toLowerCase(),a=n.a.find(i,function(t){return 0===t.toLowerCase().indexOf(e)}))?(t.$apply(function(){o.addFunction(a)}),u.trigger("blur"),""):""}}),m.click(function(){m.hide(),u.show(),u.focus()}),u.keyup(function(){r.toggleClass("open",""===u.val())}),u.blur(function(){setTimeout(function(){u.val(""),u.hide(),m.show(),r.removeClass("open")},200)}),e(r.contents())(t)});var p=function(){i&&(i.destroy(),i=null)};S()(r).on("mouseenter","ul.dropdown-menu li",function(){return y.b(s,void 0,void 0,function(){var e,t,r,n;return y.d(this,function(s){switch(s.label){case 0:p();try{e=o.datasource.getFuncDef(S()("a",this).text())}catch(e){}return e&&e.description?((t=e.description).length>500&&(t=t.substring(0,497)+"..."),r=document.createElement("div"),[4,a.e(42).then(a.t.bind(null,"fQim",7))]):[3,2];case 1:n=s.sent().default,r.innerHTML="<h4>"+e.name+"</h4>"+n(t),i=new P.a({target:this,content:r,classes:"drop-popover",openOn:"always",tetherOptions:{attachment:"bottom left",targetAttachment:"bottom right"}}),s.label=2;case 2:return[2]}})})}).on("mouseout","ul.dropdown-menu li",function(){p()}),t.$on("$destroy",p)}}}function k(e,t){var a='<input type="text" style="display:none" class="input-small tight-form-func-param"></input>';return{restrict:"A",link:function(r,i){var s=S()('\n    <function-editor\n      func="func"\n      onRemove="ctrl.handleRemoveFunction"\n      onMoveLeft="ctrl.handleMoveLeft"\n      onMoveRight="ctrl.handleMoveRight"\n    /><span>(</span>\n  '),o=r.ctrl,u=r.func,m=!1,p=0,l=null;function c(e){var t=S()(this),a=t.prev(".comma"),r=t.next();r.val(u.params[e]),a.removeClass("query-part__last"),t.hide(),r.show(),r.focus(),r.select();var n=r.data("typeahead");n&&(r.val(""),n.lookup())}function h(e){return e<u.def.params.length?u.def.params[e]:n.a.last(u.def.params).multiple?n.a.assign({},n.a.last(u.def.params),{optional:!0}):{}}function f(e,a){var n=S()(e);clearTimeout(l),l=null;var i=n.prev(),s=i.prev(".comma"),c=n.val();(""!==c||h(a).optional)&&(u.updateParam(c,a),i.html(c?t.highlightVariablesAsHtml(c):"&nbsp;")),p!==u.params.length&&(m||(m=!0,setTimeout(function(){T(),m=!1},200))),r.$apply(function(){o.targetChanged()}),i.hasClass("query-part__last")&&""===c?s.addClass("query-part__last"):i.removeClass("query-part__last"),n.hide(),i.show()}function g(e){var t=this;l=setTimeout(function(){f(t,e)},200)}function d(e,t){13===t.which&&S()(this).blur()}function y(){this.style.width=8*(3+this.value.length)+"px"}function v(){s.appendTo(i);for(var o=n.a.clone(u.def.params),m=n.a.last(u.def.params);u.params.length>=o.length&&m&&m.multiple;)o.push(n.a.assign({},m,{optional:!0}));n.a.each(o,function(e,r){if(e.optional&&u.params.length<r)return!1;var s=t.highlightVariablesAsHtml(u.params[r]),o=null!=s,m=r>=u.params.length-1&&e.optional&&!o;m&&e.multiple&&(s="+"),r>0&&S()('<span class="comma'+(m?" query-part__last":"")+'">, </span>').appendTo(i);var l=S()('<a ng-click="" class="graphite-func-param-link'+(m?" query-part__last":"")+'">'+(o?s:"&nbsp;")+"</a>"),v=S()(a);return v.attr("placeholder",e.name),p++,l.appendTo(i),v.appendTo(i),v.blur(n.a.partial(g,r)),v.keyup(y),v.keypress(n.a.partial(d,r)),l.click(n.a.partial(c,r)),e.options&&function(e,t){e.attr("data-provide","typeahead");var a=h(t).options;"int"===h(t).type&&(a=n.a.map(a,function(e){return e.toString()})),e.typeahead({source:a,minLength:0,items:20,updater:function(a){return e.val(a),f(e[0],t),a}}),e.data("typeahead").lookup=function(){return this.query=this.$element.val()||"",this.process(this.source)}}(v,r),!0}),S()("<span>)</span>").appendTo(i),e(i.contents())(r)}function T(){i.children().remove(),v(),r.func.added&&(r.func.added=!1,setTimeout(function(){i.find(".graphite-func-param-link").first().click()},10))}o.handleRemoveFunction=function(e){o.removeFunction(e)},o.handleMoveLeft=function(e){o.moveFunction(e,-1)},o.handleMoveRight=function(e){o.moveFunction(e,1)},T()}}}x.c.directive("graphiteAddFunc",b),x.c.directive("graphiteFuncEditor",k);for(var w=[170,170,181,181,186,186,192,214,216,246,248,705,710,721,736,740,748,748,750,750,880,884,886,887,890,893,902,902,904,906,908,908,910,929,931,1013,1015,1153,1162,1319,1329,1366,1369,1369,1377,1415,1488,1514,1520,1522,1568,1610,1646,1647,1649,1747,1749,1749,1765,1766,1774,1775,1786,1788,1791,1791,1808,1808,1810,1839,1869,1957,1969,1969,1994,2026,2036,2037,2042,2042,2048,2069,2074,2074,2084,2084,2088,2088,2112,2136,2308,2361,2365,2365,2384,2384,2392,2401,2417,2423,2425,2431,2437,2444,2447,2448,2451,2472,2474,2480,2482,2482,2486,2489,2493,2493,2510,2510,2524,2525,2527,2529,2544,2545,2565,2570,2575,2576,2579,2600,2602,2608,2610,2611,2613,2614,2616,2617,2649,2652,2654,2654,2674,2676,2693,2701,2703,2705,2707,2728,2730,2736,2738,2739,2741,2745,2749,2749,2768,2768,2784,2785,2821,2828,2831,2832,2835,2856,2858,2864,2866,2867,2869,2873,2877,2877,2908,2909,2911,2913,2929,2929,2947,2947,2949,2954,2958,2960,2962,2965,2969,2970,2972,2972,2974,2975,2979,2980,2984,2986,2990,3001,3024,3024,3077,3084,3086,3088,3090,3112,3114,3123,3125,3129,3133,3133,3160,3161,3168,3169,3205,3212,3214,3216,3218,3240,3242,3251,3253,3257,3261,3261,3294,3294,3296,3297,3313,3314,3333,3340,3342,3344,3346,3386,3389,3389,3406,3406,3424,3425,3450,3455,3461,3478,3482,3505,3507,3515,3517,3517,3520,3526,3585,3632,3634,3635,3648,3654,3713,3714,3716,3716,3719,3720,3722,3722,3725,3725,3732,3735,3737,3743,3745,3747,3749,3749,3751,3751,3754,3755,3757,3760,3762,3763,3773,3773,3776,3780,3782,3782,3804,3805,3840,3840,3904,3911,3913,3948,3976,3980,4096,4138,4159,4159,4176,4181,4186,4189,4193,4193,4197,4198,4206,4208,4213,4225,4238,4238,4256,4293,4304,4346,4348,4348,4352,4680,4682,4685,4688,4694,4696,4696,4698,4701,4704,4744,4746,4749,4752,4784,4786,4789,4792,4798,4800,4800,4802,4805,4808,4822,4824,4880,4882,4885,4888,4954,4992,5007,5024,5108,5121,5740,5743,5759,5761,5786,5792,5866,5870,5872,5888,5900,5902,5905,5920,5937,5952,5969,5984,5996,5998,6e3,6016,6067,6103,6103,6108,6108,6176,6263,6272,6312,6314,6314,6320,6389,6400,6428,6480,6509,6512,6516,6528,6571,6593,6599,6656,6678,6688,6740,6823,6823,6917,6963,6981,6987,7043,7072,7086,7087,7104,7141,7168,7203,7245,7247,7258,7293,7401,7404,7406,7409,7424,7615,7680,7957,7960,7965,7968,8005,8008,8013,8016,8023,8025,8025,8027,8027,8029,8029,8031,8061,8064,8116,8118,8124,8126,8126,8130,8132,8134,8140,8144,8147,8150,8155,8160,8172,8178,8180,8182,8188,8305,8305,8319,8319,8336,8348,8450,8450,8455,8455,8458,8467,8469,8469,8473,8477,8484,8484,8486,8486,8488,8488,8490,8493,8495,8505,8508,8511,8517,8521,8526,8526,8544,8584,11264,11310,11312,11358,11360,11492,11499,11502,11520,11557,11568,11621,11631,11631,11648,11670,11680,11686,11688,11694,11696,11702,11704,11710,11712,11718,11720,11726,11728,11734,11736,11742,11823,11823,12293,12295,12321,12329,12337,12341,12344,12348,12353,12438,12445,12447,12449,12538,12540,12543,12549,12589,12593,12686,12704,12730,12784,12799,13312,13312,19893,19893,19968,19968,40907,40907,40960,42124,42192,42237,42240,42508,42512,42527,42538,42539,42560,42606,42623,42647,42656,42735,42775,42783,42786,42888,42891,42894,42896,42897,42912,42921,43002,43009,43011,43013,43015,43018,43020,43042,43072,43123,43138,43187,43250,43255,43259,43259,43274,43301,43312,43334,43360,43388,43396,43442,43471,43471,43520,43560,43584,43586,43588,43595,43616,43638,43642,43642,43648,43695,43697,43697,43701,43702,43705,43709,43712,43712,43714,43714,43739,43741,43777,43782,43785,43790,43793,43798,43808,43814,43816,43822,43968,44002,44032,44032,55203,55203,55216,55238,55243,55291,63744,64045,64048,64109,64112,64217,64256,64262,64275,64279,64285,64285,64287,64296,64298,64310,64312,64316,64318,64318,64320,64321,64323,64324,64326,64433,64467,64829,64848,64911,64914,64967,65008,65019,65136,65140,65142,65276,65313,65338,65345,65370,65382,65470,65474,65479,65482,65487,65490,65495,65498,65500,65536,65547,65549,65574,65576,65594,65596,65597,65599,65613,65616,65629,65664,65786,65856,65908,66176,66204,66208,66256,66304,66334,66352,66378,66432,66461,66464,66499,66504,66511,66513,66517,66560,66717,67584,67589,67592,67592,67594,67637,67639,67640,67644,67644,67647,67669,67840,67861,67872,67897,68096,68096,68112,68115,68117,68119,68121,68147,68192,68220,68352,68405,68416,68437,68448,68466,68608,68680,69635,69687,69763,69807,73728,74606,74752,74850,77824,78894,92160,92728,110592,110593,119808,119892,119894,119964,119966,119967,119970,119970,119973,119974,119977,119980,119982,119993,119995,119995,119997,120003,120005,120069,120071,120074,120077,120084,120086,120092,120094,120121,120123,120126,120128,120132,120134,120134,120138,120144,120146,120485,120488,120512,120514,120538,120540,120570,120572,120596,120598,120628,120630,120654,120656,120686,120688,120712,120714,120744,120746,120770,120772,120779,131072,131072,173782,173782,173824,173824,177972,177972,177984,177984,178205,178205,194560,195101],C=[],F=0;F<128;F++)C[F]=F>=48&&F<=57||36===F||126===F||124===F||F>=65&&F<=90||95===F||45===F||42===F||58===F||91===F||93===F||63===F||37===F||35===F||61===F||F>=97&&F<=122;var q=C,M=function(){function e(e){this.input=e,this.char=1,this.from=1}return e.prototype.peek=function(e){return this.input.charAt(e||0)},e.prototype.skip=function(e){e=e||1,this.char+=e,this.input=this.input.slice(e)},e.prototype.tokenize=function(){for(var e=[],t=this.next();t;)e.push(t),t=this.next();return e},e.prototype.next=function(){if(this.from=this.char,/\s/.test(this.peek())){for(;/\s/.test(this.peek());)this.from+=1,this.skip();if(""===this.peek())return null}var e=this.scanStringLiteral();return e||((e=this.scanPunctuator()||this.scanNumericLiteral()||this.scanIdentifier()||this.scanTemplateSequence())?(this.skip(e.value.length),e):null)},e.prototype.scanTemplateSequence=function(){return"["===this.peek()&&"["===this.peek(1)?{type:"templateStart",value:"[[",pos:this.char}:"]"===this.peek()&&"]"===this.peek(1)?{type:"templateEnd",value:"[[",pos:this.char}:null},e.prototype.scanIdentifier=function(){var e,t,a="",r=0;function i(e){for(var t=0;t<w.length;){if(e<w[t++])return!1;if(e<=w[t++])return!0}return!1}function s(e){return/^[0-9a-fA-F]$/.test(e)}var o=n.a.bind(function(){if(r+=1,"u"!==this.peek(r))return null;var e=this.peek(r+1),t=this.peek(r+2),a=this.peek(r+3),n=this.peek(r+4);return s(e)&&s(t)&&s(a)&&s(n)&&i(parseInt(e+t+a+n,16))?(r+=5,"\\u"+e+t+a+n):null},this),u=n.a.bind(function(){var e=this.peek(r),t=e.charCodeAt(0);return"*"===e?(r+=1,e):92===t?o():t<128?C[t]?(r+=1,e):null:i(t)?(r+=1,e):null},this),m=n.a.bind(function(){var e=this.peek(r),t=e.charCodeAt(0);return 92===t?o():t<128?q[t]?(r+=1,e):null:i(t)?(r+=1,e):null},this);if(null===(t=u()))return null;for(a=t;null!==(t=m());)a+=t;switch(a){case"true":case"false":e="bool";break;default:e="identifier"}return{type:e,value:a,pos:this.char}},e.prototype.scanNumericLiteral=function(){var e,t=0,a="",r=this.input.length,n=this.peek(t);function i(e){return/^[0-9]$/.test(e)}function s(e){return/^[0-7]$/.test(e)}function o(e){return"$"===e||"_"===e||"\\"===e||e>="a"&&e<="z"||e>="A"&&e<="Z"}if("-"===n&&(a+=n,t+=1,n=this.peek(t)),"."!==n&&!i(n))return null;if("."!==n){if(a+=this.peek(t),t+=1,n=this.peek(t),"0"===a){if("x"===n||"X"===n){for(t+=1,a+=n;t<r&&(n=this.peek(t),/^[0-9a-fA-F]$/.test(n));)a+=n,t+=1;return a.length<=2?{type:"number",value:a,isMalformed:!0,pos:this.char}:t<r&&o(n=this.peek(t))?null:{type:"number",value:a,base:16,isMalformed:!1,pos:this.char}}if(s(n)){for(t+=1,a+=n,e=!1;t<r;){if(i(n=this.peek(t))&&(e=!0),!s(n)){if(!this.isPunctuator(n))return null;break}a+=n,t+=1}return t<r&&o(n=this.peek(t))?null:{type:"number",value:a,base:8,isMalformed:e}}i(n)&&(t+=1,a+=n)}for(;t<r&&i(n=this.peek(t));)a+=n,t+=1}if("."===n)for(a+=n,t+=1;t<r&&i(n=this.peek(t));)a+=n,t+=1;if("e"===n||"E"===n){if(a+=n,t+=1,"+"!==(n=this.peek(t))&&"-"!==n||(a+=this.peek(t),t+=1),!i(n=this.peek(t)))return null;for(a+=n,t+=1;t<r&&i(n=this.peek(t));)a+=n,t+=1}return t<r&&(n=this.peek(t),!this.isPunctuator(n))?null:{type:"number",value:a,base:10,pos:this.char,isMalformed:!isFinite(+a)}},e.prototype.isPunctuator=function(e){switch(e){case".":case"(":case")":case",":case"{":case"}":return!0}return!1},e.prototype.scanPunctuator=function(){var e=this.peek();return this.isPunctuator(e)?{type:e,value:e,pos:this.char}:null},e.prototype.scanStringLiteral=function(){var e=this.peek();if('"'!==e&&"'"!==e)return null;var t="";for(this.skip();this.peek()!==e;){if(""===this.peek())return{type:"string",value:t,isUnclosed:!0,quote:e,pos:this.char};t+=this.peek(),this.skip(1)}return this.skip(),{type:"string",value:t,isUnclosed:!1,quote:e,pos:this.char}},e}(),D=function(){function e(e){this.expression=e,this.lexer=new M(e),this.tokens=this.lexer.tokenize(),this.index=0}return e.prototype.getAst=function(){return this.start()},e.prototype.start=function(){try{return this.functionCall()||this.metricExpression()}catch(e){return{type:"error",message:e.message,pos:e.pos}}},e.prototype.curlyBraceSegment=function(){if(this.match("identifier","{")||this.match("{")){for(var e="";!this.match("")&&!this.match("}");)e+=this.consumeToken().value;return this.match("}")||this.errorMark("Expected closing '}'"),e+=this.consumeToken().value,this.match("identifier")&&(e+=this.consumeToken().value),{type:"segment",value:e}}return null},e.prototype.metricSegment=function(){var e=this.curlyBraceSegment();if(e)return e;if(this.match("identifier")||this.match("number")){var t=this.consumeToken().value.split(".");return 2===t.length&&(this.tokens.splice(this.index,0,{type:"."}),this.tokens.splice(this.index+1,0,{type:"number",value:t[1]})),{type:"segment",value:t[0]}}this.match("templateStart")||this.errorMark("Expected metric identifier"),this.consumeToken(),this.match("identifier")||this.errorMark("Expected identifier after templateStart");var a={type:"template",value:this.consumeToken().value};return this.match("templateEnd")||this.errorMark("Expected templateEnd"),this.consumeToken(),a},e.prototype.metricExpression=function(){if(!(this.match("templateStart")||this.match("identifier")||this.match("number")||this.match("{")))return null;var e={type:"metric",segments:[]};for(e.segments.push(this.metricSegment());this.match(".");){this.consumeToken();var t=this.metricSegment();t||this.errorMark("Expected metric identifier"),e.segments.push(t)}return e},e.prototype.functionCall=function(){if(!this.match("identifier","("))return null;var e={type:"function",name:this.consumeToken().value};return this.consumeToken(),e.params=this.functionParameters(),this.match(")")||this.errorMark("Expected closing parenthesis"),this.consumeToken(),e},e.prototype.boolExpression=function(){return this.match("bool")?{type:"bool",value:"true"===this.consumeToken().value}:null},e.prototype.functionParameters=function(){if(this.match(")")||this.match(""))return[];var e=this.functionCall()||this.numericLiteral()||this.seriesRefExpression()||this.boolExpression()||this.metricExpression()||this.stringLiteral();return this.match(",")?(this.consumeToken(),[e].concat(this.functionParameters())):[e]},e.prototype.seriesRefExpression=function(){return this.match("identifier")&&this.tokens[this.index].value.match(/\#[A-Z]/)?{type:"series-ref",value:this.consumeToken().value}:null},e.prototype.numericLiteral=function(){return this.match("number")?{type:"number",value:parseFloat(this.consumeToken().value)}:null},e.prototype.stringLiteral=function(){if(!this.match("string"))return null;var e=this.consumeToken();if(e.isUnclosed)throw{message:"Unclosed string parameter",pos:e.pos};return{type:"string",value:e.value}},e.prototype.errorMark=function(e){var t=this.tokens[this.index];throw{message:e+" instead found "+(t?t.type:"end of string"),pos:t?t.pos:this.lexer.char}},e.prototype.consumeToken=function(){return this.index++,this.tokens[this.index-1]},e.prototype.matchToken=function(e,t){var a=this.tokens[this.index+t];return void 0===a&&""===e||a&&a.type===e},e.prototype.match=function(e,t){return this.matchToken(e,0)&&(!t||this.matchToken(t,1))},e}(),A=function(){function e(e,t,a,r){this.datasource=e,this.target=t,this.templateSrv=a,this.scopedVars=r,this.parseTarget(),this.removeTagValue="-- remove tag --"}return e.$inject=["datasource","target","templateSrv","scopedVars"],e.prototype.parseTarget=function(){if(this.functions=[],this.segments=[],this.tags=[],this.seriesByTagUsed=!1,this.error=null,!this.target.textEditor){var e=new D(this.target.target).getAst();if(null!==e){if("error"===e.type)return this.error=e.message+" at position: "+e.pos,void(this.target.textEditor=!0);try{this.parseTargetRecursive(e,null)}catch(e){console.log("error parsing target:",e.message),this.error=e.message,this.target.textEditor=!0}this.checkOtherSegmentsIndex=this.segments.length-1}else this.checkOtherSegmentsIndex=0}},e.prototype.getSegmentPathUpTo=function(e){var t=this.segments.slice(0,e);return n.a.reduce(t,function(e,t){return e?e+"."+t.value:t.value},"")},e.prototype.parseTargetRecursive=function(e,t){var a=this;if(null===e)return null;switch(e.type){case"function":var r=this.datasource.createFuncInstance(e.name,{withDefaultParams:!1});n.a.each(e.params,function(e){a.parseTargetRecursive(e,r)}),r.updateText(),this.functions.push(r),"seriesByTag"!==r.def.name||this.seriesByTagUsed||(this.seriesByTagUsed=!0,r.hidden=!0,this.tags=this.splitSeriesByTagParams(r));break;case"series-ref":this.segments.length>0||this.getSeriesByTagFuncIndex()>=0?this.addFunctionParameter(t,e.value):this.segments.push(e);break;case"bool":case"string":case"number":this.addFunctionParameter(t,e.value);break;case"metric":this.segments.length||this.tags.length?this.addFunctionParameter(t,n.a.join(n.a.map(e.segments,"value"),".")):this.segments=e.segments}},e.prototype.updateSegmentValue=function(e,t){this.segments[t].value=e.value},e.prototype.addSelectMetricSegment=function(){this.segments.push({value:"select metric"})},e.prototype.addFunction=function(e){this.functions.push(e)},e.prototype.addFunctionParameter=function(e,t){if(e.params.length>=e.def.params.length&&!n.a.get(n.a.last(e.def.params),"multiple",!1))throw{message:"too many parameters for function "+e.def.name};e.params.push(t)},e.prototype.removeFunction=function(e){this.functions=n.a.without(this.functions,e)},e.prototype.moveFunction=function(e,t){var a=this.functions.indexOf(e);n.a.move(this.functions,a,a+t)},e.prototype.updateModelTarget=function(e){var t,a,r=this;if(!this.target.textEditor){var i=this.getSegmentPathUpTo(this.segments.length).replace(/\.select metric$/,"");this.target.target=n.a.reduce(this.functions,function(e,t){return t.render(e,function(e){return r.templateSrv.replace(e,r.scopedVars)})},i)}this.updateRenderedTarget(this.target,e);try{for(var s=y.i(e||[]),o=s.next();!o.done;o=s.next()){var u=o.value;u.refId!==this.target.refId&&this.updateRenderedTarget(u,e)}}catch(e){t={error:e}}finally{try{o&&!o.done&&(a=s.return)&&a.call(s)}finally{if(t)throw t.error}}},e.prototype.updateRenderedTarget=function(e,t){var a=n.a.keyBy(t,"refId");delete a[e.refId];var r=/\#([A-Z])/g,i=e.target;for(n.a.each(a,function(e,t){!function(e,t){var a=0;n.a.each(e,function(e,n){if(n!==t){var i=r.exec(e.target),s=i&&i.length?i.length-1:0;a+=s}}),e[t].refCount=a}(a,t)});i.match(r);){var s=i.replace(r,function(e,t){var r=a[t];return r?(0===r.refCount&&delete a[t],r.refCount--,r.target):e});if(s===i)break;i=s}delete e.targetFull,e.target!==i&&(e.targetFull=i)},e.prototype.splitSeriesByTagParams=function(e){var t=/([^\!=~]+)(\!?=~?)(.*)/;return n.a.flatten(n.a.map(e.params,function(e){var a=t.exec(e);if(a){var r=a.slice(1);if(3===r.length)return{key:r[0],operator:r[1],value:r[2]}}return[]}))},e.prototype.getSeriesByTagFuncIndex=function(){return n.a.findIndex(this.functions,function(e){return"seriesByTag"===e.def.name})},e.prototype.getSeriesByTagFunc=function(){var e=this.getSeriesByTagFuncIndex();return e>=0?this.functions[e]:void 0},e.prototype.addTag=function(e){var t=I(e);this.getSeriesByTagFunc().params.push(t),this.tags.push(e)},e.prototype.removeTag=function(e){this.getSeriesByTagFunc().params.splice(e,1),this.tags.splice(e,1)},e.prototype.updateTag=function(e,t){if(this.error=null,e.key!==this.removeTagValue){var a=I(e);this.getSeriesByTagFunc().params[t]=a,this.tags[t]=e}else this.removeTag(t)},e.prototype.renderTagExpressions=function(e){return void 0===e&&(e=-1),n.a.compact(n.a.map(this.tags,function(t,a){if(a!==e)return t.key+t.operator+t.value}))},e}();function I(e){return e.key+e.operator+e.value}var B=a("LzXI"),E=a("Xmxp"),_=["=","!=","=~","!=~"],V="tag: ",R=function(e){function t(t,a,r,n,i){var s=e.call(this,t,a)||this;return s.uiSegmentSrv=r,s.templateSrv=n,s.supportsTags=s.datasource.supportsTags,s.paused=!1,s.target.target=s.target.target||"",s.datasource.waitForFuncDefsLoaded().then(function(){s.queryModel=new A(s.datasource,s.target,n),s.buildSegments()}),s.removeTagValue="-- remove tag --",s}return t.$inject=["$scope","$injector","uiSegmentSrv","templateSrv","$timeout"],y.c(t,e),t.prototype.parseTarget=function(){this.queryModel.parseTarget(),this.buildSegments()},t.prototype.toggleEditorMode=function(){this.target.textEditor=!this.target.textEditor,this.parseTarget()},t.prototype.buildSegments=function(){var e=this;this.segments=n.a.map(this.queryModel.segments,function(t){return e.uiSegmentSrv.newSegment(t)});var t=this.queryModel.checkOtherSegmentsIndex||0;this.checkOtherSegments(t),this.queryModel.seriesByTagUsed&&this.fixTagSegments()},t.prototype.addSelectMetricSegment=function(){this.queryModel.addSelectMetricSegment(),this.segments.push(this.uiSegmentSrv.newSelectMetric())},t.prototype.checkOtherSegments=function(e){var t=this;if(1!==this.queryModel.segments.length||"series-ref"!==this.queryModel.segments[0].type){if(0!==e){var a=this.queryModel.getSegmentPathUpTo(e+1);return""===a?Promise.resolve():this.datasource.metricFindQuery(a).then(function(r){if(0===r.length)""!==a&&(t.queryModel.segments=t.queryModel.segments.splice(0,e),t.segments=t.segments.splice(0,e),t.addSelectMetricSegment());else if(r[0].expandable){if(t.segments.length!==e)return t.checkOtherSegments(e+1);t.addSelectMetricSegment()}}).catch(function(e){E.b.emit("alert-error",["Error",e])})}this.addSelectMetricSegment()}},t.prototype.setSegmentFocus=function(e){n.a.each(this.segments,function(t,a){t.focus=e===a})},t.prototype.getAltSegments=function(e,t){var a=this,r=t&&t.length>0?"*"+t+"*":"*";e>0&&(r=this.queryModel.getSegmentPathUpTo(e)+"."+r);var i={range:this.panelCtrl.range,requestId:"get-alt-segments"};return this.datasource.metricFindQuery(r,i).then(function(r){var i=n.a.map(r,function(e){return a.uiSegmentSrv.newSegment({value:e.text,expandable:e.expandable})});return e>0&&0===i.length?i:(0===e&&n.a.eachRight(a.panelCtrl.panel.targets,function(e){e.refId!==a.queryModel.target.refId&&i.unshift(a.uiSegmentSrv.newSegment({type:"series-ref",value:"#"+e.refId,expandable:!1}))}),n.a.eachRight(a.templateSrv.variables,function(e){i.unshift(a.uiSegmentSrv.newSegment({type:"template",value:"$"+e.name,expandable:!0}))}),i.unshift(a.uiSegmentSrv.newSegment("*")),a.supportsTags&&0===e?(a.removeTaggedEntry(i),a.addAltTagSegments(t,i)):i)}).catch(function(e){return[]})},t.prototype.addAltTagSegments=function(e,t){return this.getTagsAsSegments(e).then(function(e){return e=n.a.map(e,function(e){return e.value=V+e.value,e}),t.concat.apply(t,y.h(e))})},t.prototype.removeTaggedEntry=function(e){e=n.a.remove(e,function(e){return"_tagged"===e.value})},t.prototype.segmentValueChanged=function(e,t){var a=this;if(this.error=null,this.queryModel.updateSegmentValue(e,t),this.queryModel.functions.length>0&&this.queryModel.functions[0].def.fake&&(this.queryModel.functions=[]),"tag"===e.type){var r=e.value.replace(V,"");return this.pause(),void this.addSeriesByTagFunc(r)}if(e.expandable)return this.checkOtherSegments(t+1).then(function(){a.setSegmentFocus(t+1),a.targetChanged()});this.spliceSegments(t+1),this.setSegmentFocus(t+1),this.targetChanged()},t.prototype.spliceSegments=function(e){this.segments=this.segments.splice(0,e),this.queryModel.segments=this.queryModel.segments.splice(0,e)},t.prototype.emptySegments=function(){this.queryModel.segments=[],this.segments=[]},t.prototype.targetTextChanged=function(){this.updateModelTarget(),this.refresh()},t.prototype.updateModelTarget=function(){this.queryModel.updateModelTarget(this.panelCtrl.panel.targets)},t.prototype.targetChanged=function(){if(!this.queryModel.error){var e=this.queryModel.target.target;this.updateModelTarget(),this.queryModel.target===e||this.paused||this.panelCtrl.refresh()}},t.prototype.addFunction=function(e){var t=this.datasource.createFuncInstance(e,{withDefaultParams:!0});t.added=!0,this.queryModel.addFunction(t),this.smartlyHandleNewAliasByNode(t),1===this.segments.length&&this.segments[0].fake&&this.emptySegments(),!t.params.length&&t.added&&this.targetChanged(),"seriesByTag"===t.def.name&&this.parseTarget()},t.prototype.removeFunction=function(e){this.queryModel.removeFunction(e),this.targetChanged()},t.prototype.moveFunction=function(e,t){this.queryModel.moveFunction(e,t),this.targetChanged()},t.prototype.addSeriesByTagFunc=function(e){var t=this.datasource.createFuncInstance("seriesByTag",{withDefaultParams:!1}),a=e+"=";t.params=[a],this.queryModel.addFunction(t),t.added=!0,this.emptySegments(),this.targetChanged(),this.parseTarget()},t.prototype.smartlyHandleNewAliasByNode=function(e){if("aliasByNode"===e.def.name)for(var t=0;t<this.segments.length;t++)if(this.segments[t].value.indexOf("*")>=0)return e.params[0]=t,e.added=!1,void this.targetChanged()},t.prototype.getAllTags=function(){var e=this;return this.datasource.getTags().then(function(t){var a=n.a.map(t,"text");return a.splice(0,0,e.removeTagValue),$(a)})},t.prototype.getTags=function(e,t){var a=this,r=this.queryModel.renderTagExpressions(e);return this.datasource.getTagsAutoComplete(r,t).then(function(e){var t=n.a.map(e,"text");return t.splice(0,0,a.removeTagValue),$(t)})},t.prototype.getTagsAsSegments=function(e){var t=this,a=this.queryModel.renderTagExpressions();return this.datasource.getTagsAutoComplete(a,e).then(function(e){return n.a.map(e,function(e){return t.uiSegmentSrv.newSegment({value:e.text,type:"tag",expandable:!1})})})},t.prototype.getTagOperators=function(){return $(_)},t.prototype.getAllTagValues=function(e){var t=e.key;return this.datasource.getTagValues(t).then(function(e){return $(n.a.map(e,"text"))})},t.prototype.getTagValues=function(e,t,a){var r=this,i=this.queryModel.renderTagExpressions(t),s=e.key;return this.datasource.getTagValuesAutoComplete(i,s,a).then(function(e){var t=n.a.map(e,"text");return n.a.eachRight(r.templateSrv.variables,function(e){t.push("${"+e.name+":regex}")}),$(t)})},t.prototype.tagChanged=function(e,t){this.queryModel.updateTag(e,t),this.targetChanged()},t.prototype.addNewTag=function(e){var t={key:e.value,operator:"=",value:""};this.queryModel.addTag(t),this.targetChanged(),this.fixTagSegments()},t.prototype.removeTag=function(e){this.queryModel.removeTag(e),this.targetChanged()},t.prototype.fixTagSegments=function(){this.addTagSegments=[this.uiSegmentSrv.newPlusButton()]},t.prototype.showDelimiter=function(e){return e!==this.queryModel.tags.length-1},t.prototype.pause=function(){this.paused=!0},t.prototype.unpause=function(){this.paused=!1,this.panelCtrl.refresh()},t.prototype.getCollapsedText=function(){return this.target.target},t.templateUrl="partials/query.editor.html",t}(B.QueryCtrl);function $(e){return n.a.map(e,function(e){return{text:e,value:e}})}var N=function(){function e(e,t){this.graphiteVersions=[{name:"0.9.x",value:"0.9"},{name:"1.0.x",value:"1.0"},{name:"1.1.x",value:"1.1"}],this.datasourceSrv=t,this.current.jsonData=this.current.jsonData||{},this.current.jsonData.graphiteVersion=this.current.jsonData.graphiteVersion||"0.9",this.autoDetectGraphiteVersion()}return e.$inject=["$scope","datasourceSrv"],e.prototype.autoDetectGraphiteVersion=function(){var e=this;this.current.id&&this.datasourceSrv.loadDatasource(this.current.name).then(function(e){return e.getVersion()}).then(function(t){e.graphiteVersions.push({name:t,value:t}),e.current.jsonData.graphiteVersion=t})},e.templateUrl="public/app/plugins/datasource/graphite/partials/config.html",e}();a.d(t,"AnnotationsQueryCtrl",function(){return L}),a.d(t,"Datasource",function(){return d}),a.d(t,"QueryCtrl",function(){return R}),a.d(t,"ConfigCtrl",function(){return N});var L=function(){function e(){}return e.templateUrl="partials/annotations.editor.html",e}()}}]);
//# sourceMappingURL=graphitePlugin.3932bda029d2299a9d96.js.map