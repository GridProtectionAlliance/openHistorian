"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[285],{30249:(b,R,e)=>{e.d(R,{o:()=>o});var t=e(74848),g=e(96540),M=e(85200),c=e(1173),P=e(11261),f=e(90708),L=e(67266),T=e(81297),D=e(16895),r=e(40458);function d(m,s,a=[]){for(const n of a)if(typeof n=="function"){if(!n(m,s))return!1}else if(s[n]!==m[n])return!1;return!0}const p={x:M.sJ.get(c.Ct.firstTimeField).get({}),y:M.sJ.get(c.Ct.byTypes).get(new Set([P.PU.number,P.PU.enum]))};class o extends g.Component{constructor(s){super(s),this.getTimeRange=()=>this.props.timeRange;let a=this.prepState(s);a.alignedData=a.config.prepData([a.alignedFrame]),this.state=a,this.plotInstance=g.createRef()}prepState(s,a=!0){let n=null;const{frames:u,fields:l=p,preparePlotFrame:A,replaceVariables:j,dataLinkPostProcessor:O}=s,U=A??r.m,N=u.some(I=>I.fields.some(F=>(F.config.links?.length??0)>0)),h=U(u,{...l,y:N?()=>!0:l.y},s.timeRange);if((0,D.uY)("GraphNG",!1,"data aligned",h),h){let I=h;if(N){const Q=Array.isArray(this.props.timeZone)?this.props.timeZone[0]:this.props.timeZone;let $=u.map((E,S)=>({...E,fields:h.fields.filter((K,G)=>G===0||K.state?.origin?.frameIndex===S),length:h.length}));$.forEach((E,S)=>{E.fields.forEach(K=>{K.getLinks=(0,f._M)(E,K,{...K.state?.scopedVars,__dataContext:{value:{data:$,field:K,frame:E,frameIndex:S}}},j,Q,O)})}),I={...h,fields:h.fields.filter((E,S)=>S===0||l.y(E,h,[h]))}}let F=this.state?.config;a&&(F=s.prepConfig(I,this.props.frames,this.getTimeRange),(0,D.uY)("GraphNG",!1,"config prepared",F)),n={alignedFrame:I,config:F},(0,D.uY)("GraphNG",!1,"data prepared",n.alignedData)}return n}componentDidUpdate(s){const{frames:a,structureRev:n,timeZone:u,cursorSync:l,propsToDiff:A}=this.props,j=!d(s,this.props,A);if(a!==s.frames||j||u!==s.timeZone||l!==s.cursorSync){let O=this.prepState(this.props,!1);O&&((this.state.config===void 0||u!==s.timeZone||l!==s.cursorSync||n!==s.structureRev||!n||j)&&(O.config=this.props.prepConfig(O.alignedFrame,this.props.frames,this.getTimeRange),(0,D.uY)("GraphNG",!1,"config recreated",O.config)),O.alignedData=O.config.prepData([O.alignedFrame]),this.setState(O))}}render(){const{width:s,height:a,children:n,renderLegend:u}=this.props,{config:l,alignedFrame:A,alignedData:j}=this.state;return l?(0,t.jsx)(L.KU,{width:s,height:a,legend:u(l),children:(O,U)=>(0,t.jsx)(T.Z,{config:l,data:j,width:O,height:U,plotRef:N=>this.plotInstance.current=N,children:n?n(l,A):null})}):null}}},40458:(b,R,e)=>{e.d(R,{m:()=>D});var t=e(11261),g=e(73060),M=e(46294);function c(r,d,p){let o,m;for(let s=0;s<d.length;s++)if(d[s]==null)m==null&&o!=null&&(m=s);else{if(m!=null&&o!=null){if(r[s]-o<p)for(;m<s;)d[m++]=void 0;m=null}o=r[s]}return d}var P=e(52622);function f(r){return r.type===t.PU.number&&r.config.custom?.drawStyle===P.GR.Bars&&!r.config.custom?.hideFrom?.viz}function L(r,d){return r.fields.find(p=>d!=null?p.name===d:p.type===t.PU.time)}function T(r,d){const p=L(r,d);let o=p?.values;for(let m=0;m<r.fields.length;m++){let s=r.fields[m];if(s===p||f(s))continue;let a=s.config.custom?.spanNulls;typeof a=="number"&&a!==-1&&o&&(s.values=c(o,s.values,a))}return r}function D(r,d,p){let o;e:for(let n of r)for(let u of n.fields)if(d.x(u,n,r)){o=u;break e}r=r.map(n=>o?.state?.nullThresholdApplied?n:(0,M.M)({frame:n,refFieldName:o.name,refFieldPseudoMin:p?.from.valueOf(),refFieldPseudoMax:p?.to.valueOf()}));let m=r.reduce((n,u)=>n+u.fields.reduce((l,A)=>l+(f(A)?1:0),0),0),s=1/0;m>1&&r.forEach(n=>{if(!n.fields.some(f))return;const u=o.values;for(let l=0;l<u.length;l++)l>0&&(s=Math.min(s,u[l]-u[l-1]))});let a=(0,g.Fd)({frames:r,joinBy:d.x,keep:d.y,keepOriginIndices:!0,keepDisplayNames:!0,nullMode:n=>{if(f(n))return g.WO;let u=n.config.custom?.spanNulls;return u===!0?g.RC:u===-1?g.WO:g.JI}});return a?(a=T(a,o.name),s!==1/0&&(a.fields.forEach((n,u)=>{let l=n.values;if(u===0){let A=l[l.length-1];l.push(A+s,A+2*s)}else f(n)?l.push(null,null):l.push(void 0,void 0)}),a.length+=2),a):null}},82389:(b,R,e)=>{e.d(R,{I:()=>d});var t=e(74848),g=e(96540),M=e(24293),c=e(11261),P=e(52622),f=e(67266),L=e(96516),T=e(30249),D=e(28895);const r=["rowHeight","colWidth","showValue","mergeValues","alignValue","tooltip","paginationRev"];class d extends g.Component{constructor(){super(...arguments),this.getValueColor=(o,m,s)=>{const a=this.props.frames[o]?.fields[m];if(a?.display){const n=a.display(s);if(n.color)return n.color}return M.F},this.prepConfig=(o,m,s)=>(0,D.iE)({frame:o,getTimeRange:s,allFrames:this.props.frames,...this.props,timeZones:Array.isArray(this.props.timeZone)?this.props.timeZone:[this.props.timeZone],rowHeight:o.fields.length>2?this.props.rowHeight:1,getValueColor:this.getValueColor,hoverMulti:this.props.tooltip?.mode===P.$N.Multi}),this.renderLegend=o=>{const{legend:m,legendItems:s}=this.props;return!o||!s||!m||m.showLegend===!1?null:(0,t.jsx)(f.KU.Legend,{placement:m.placement,children:(0,t.jsx)(L.t,{placement:m.placement,items:s,displayMode:m.displayMode,readonly:!0})})}}render(){return(0,t.jsx)(T.o,{...this.props,fields:{x:o=>o.type===c.PU.time,y:o=>o.type===c.PU.number||o.type===c.PU.boolean||o.type===c.PU.string||o.type===c.PU.enum},prepConfig:this.prepConfig,propsToDiff:r,renderLegend:this.renderLegend})}}},29333:(b,R,e)=>{e.d(R,{U:()=>g});var t=e(49962);const g=t.H.injectEndpoints({endpoints:M=>({getRuleHistory:M.query({query:({ruleUid:c,from:P,to:f,limit:L=100})=>({url:"/api/v1/rules/history",params:{ruleUID:c,from:P,to:f,limit:L}})})})})},95584:(b,R,e)=>{e.d(R,{A:()=>D});var t=e(74848),g=e(96540),M=e(70713),c=e(52622),P=e(40845),f=e(82389),L=e(28895);const T=r=>r,D=(0,g.memo)(({frames:r,timeRange:d})=>{const p=(0,P.$j)();return(0,t.jsx)(M.Ay,{disableHeight:!0,children:({width:o})=>(0,t.jsx)(f.I,{frames:r,timeRange:d,timeZone:"browser",mode:L.pm.Changes,height:18*r.length+50,width:o,showValue:c.yL.Never,theme:p,rowHeight:.8,legend:{calcs:[],displayMode:c.lm.List,placement:"bottom",showLegend:!0},legendItems:[{label:"Normal",color:p.colors.success.main,yAxis:1},{label:"Pending",color:p.colors.warning.main,yAxis:1},{label:"Firing",color:p.colors.error.main,yAxis:1},{label:"No Data",color:p.colors.info.main,yAxis:1},{label:"Mixed",color:p.colors.text.secondary,yAxis:1}],replaceVariables:T})})});D.displayName="LogTimelineViewer"},285:(b,R,e)=>{e.r(R),e.d(R,{default:()=>ce,getStyles:()=>te,useFrameSubset:()=>q});var t=e(74848),g=e(32196),M=e(2543),c=e(96540),P=e(49785),f=e(47232),L=e(40845),T=e(42418),D=e(67061),r=e(56034),d=e(14578),p=e(55852),o=e(88575),m=e(60029),s=e(10354),a=e(29333),n=e(98164),u=e(69087),l=e(35108),A=e(72095),j=e(72724),O=e(64149),U=e(8406),N=e(30423),h=e(70026);function I(i){const y=i.reduce((x,v)=>{const B=x.get(v.timestamp);return B?B.push(v):x.set(v.timestamp,[v]),x},new Map);return new Map([...y].sort((x,v)=>v[0]-x[0]))}const F=(0,c.memo)(({records:i,commonLabels:y,onLabelClick:x,onRecordsRendered:v})=>{const B=(0,L.of)(S),V=I(i),C=new Map;return(0,c.useEffect)(()=>{v&&v(C)}),(0,t.jsx)("ul",{className:B.logsScrollable,"aria-label":"State history by timestamp",children:Array.from(V.entries()).map(([W,z])=>(0,t.jsxs)("li",{id:W.toString(10),"data-testid":W,ref:_=>_&&C.set(W,_),className:B.listItemWrapper,children:[(0,t.jsx)($,{time:W}),(0,t.jsx)("div",{className:B.logsContainer,children:z.map(({line:_})=>(0,t.jsxs)(c.Fragment,{children:[(0,t.jsx)(N.C,{state:_.previous,size:"sm",muted:!0}),(0,t.jsx)(d.I,{name:"arrow-right",size:"sm"}),(0,t.jsx)(N.C,{state:_.current}),(0,t.jsx)(D.B,{children:_.values&&(0,t.jsx)(E,{record:_.values})}),(0,t.jsx)("div",{children:_.labels&&(0,t.jsx)(O.L,{tags:(0,h.$)(Object.entries(_.labels),y).map(([J,Y])=>`${J}=${Y}`),onClick:x})})]},(0,M.uniqueId)()))})]},W))})});F.displayName="LogRecordViewerByTimestamp";function Q({records:i,commonLabels:y}){const x=useStyles2(S),v=groupBy(i,B=>JSON.stringify(B.line.labels));return jsx(Fragment,{children:Object.entries(v).map(([B,V])=>jsxs(Stack,{direction:"column",children:[jsx("h4",{children:jsx(TagList,{tags:omitLabels(Object.entries(V[0].line.labels??{}),y).map(([C,W])=>`${C}=${W}`)})}),jsx("div",{className:x.logsContainer,children:V.map(({line:C,timestamp:W})=>jsxs("div",{children:[jsx(AlertStateTag,{state:C.previous,size:"sm",muted:!0}),jsx(Icon,{name:"arrow-right",size:"sm"}),jsx(AlertStateTag,{state:C.current}),jsx(Stack,{children:C.values&&jsx(E,{record:C.values})}),jsx("div",{children:dateTimeFormat(W)})]},uniqueId()))})]},B))})}const $=({time:i})=>{const y=new Date(i),x=(0,L.of)(S);return(0,t.jsx)("div",{className:x.timestampWrapper,children:(0,t.jsxs)(D.B,{alignItems:"center",gap:1,children:[(0,t.jsx)(d.I,{name:"clock-nine",size:"sm"}),(0,t.jsx)("span",{className:x.timestampText,children:(0,j.LE)(y)}),(0,t.jsxs)("small",{children:["(",(0,A.B)(y)," ago)"]})]})})},E=(0,c.memo)(({record:i})=>{const y=Object.entries(i);return(0,t.jsx)(t.Fragment,{children:y.map(([x,v])=>(0,t.jsx)(U.J,{label:x,value:v},x))})});E.displayName="AlertInstanceValues";const S=i=>({logsContainer:(0,g.css)({display:"grid",gridTemplateColumns:"max-content max-content max-content auto max-content",gap:i.spacing(2,1),alignItems:"center"}),logsScrollable:(0,g.css)({height:"500px",overflow:"scroll",flex:1}),timestampWrapper:(0,g.css)({color:i.colors.text.secondary}),timestampText:(0,g.css)({color:i.colors.text.primary,fontSize:i.typography.bodySmall.fontSize,fontWeight:i.typography.fontWeightBold}),listItemWrapper:(0,g.css)({background:"transparent",outline:"1px solid transparent",padding:`${i.spacing(1)} ${i.spacing(1.5)}`,[i.transitions.handleMotion("no-preference","reduce")]:{transition:"background 150ms, outline 150ms"}})});var K=e(95584),G=e(14084);const re=10*1e3,oe=12,le=({ruleUID:i})=>{const y=(0,L.of)(te),[x,v]=(0,c.useState)(""),B=(0,c.useRef)(new Map),{getValues:V,setValue:C,register:W,handleSubmit:z}=(0,P.mN)({defaultValues:{query:""}}),{useGetRuleHistoryQuery:_}=a.U,J=(0,c.useMemo)(()=>ie(),[]),{currentData:Y,isLoading:me,isError:de,error:se}=_({ruleUid:i,from:J.from.unix(),to:J.to.unix(),limit:250},{refetchOnFocus:!0,refetchOnReconnect:!0,pollingInterval:re}),{dataFrames:X,historyRecords:ue,commonLabels:w,totalRecordsCount:k}=(0,G.mW)(Y,x),{frameSubset:Z,frameTimeRange:ge}=q(X),fe=(0,c.useCallback)(H=>{const ae=(0,n.EU)(V("query"),H);v(ae),C("query",ae)},[v,C,V]),ne=(0,c.useCallback)(()=>{v(""),C("query","")},[v,C]);if(me)return(0,t.jsx)("div",{children:"Loading..."});if(de)return(0,t.jsx)(T.F,{title:"Error fetching the state history",severity:"error",children:se instanceof Error?se.message:"Unable to fetch alert state history"});const pe=Z.length<X.length,he=k>0?`No matches were found for the given filters among the ${k} instances`:"No state transitions have occurred in the last 30 days";return(0,t.jsxs)("div",{className:y.fullSize,children:[(0,t.jsxs)("form",{onSubmit:z(H=>v(H.query)),children:[(0,t.jsx)(ee,{...W("query"),showClearFilterSuffix:!!x,onClearFilterClick:ne}),(0,t.jsx)("input",{type:"submit",hidden:!0})]}),!(0,M.isEmpty)(w)&&(0,t.jsx)("div",{className:y.commonLabels,children:(0,t.jsxs)(D.B,{gap:1,alignItems:"center",children:[(0,t.jsx)("strong",{children:"Common labels"}),(0,t.jsx)(r.m,{content:"Common labels are the ones attached to all of the alert instances",children:(0,t.jsx)(d.I,{name:"info-circle"})}),(0,t.jsx)(u.m,{labels:(0,M.fromPairs)(w),size:"sm"})]})}),(0,M.isEmpty)(Z)?(0,t.jsx)(t.Fragment,{children:(0,t.jsxs)("div",{className:y.emptyState,children:[he,k>0&&(0,t.jsx)(p.$n,{variant:"secondary",type:"button",onClick:ne,children:"Clear filters"})]})}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("div",{className:y.graphWrapper,children:(0,t.jsx)(K.A,{frames:Z,timeRange:ge})}),pe&&(0,t.jsx)("div",{className:y.moreInstancesWarning,children:(0,t.jsxs)(D.B,{direction:"row",alignItems:"center",gap:1,children:[(0,t.jsx)(d.I,{name:"exclamation-triangle",size:"sm"}),(0,t.jsx)("small",{children:`Only showing ${Z.length} out of ${X.length} instances. Click on the labels to narrow down the results`})]})}),(0,t.jsx)(F,{records:ue,commonLabels:w,onRecordsRendered:H=>B.current=H,onLabelClick:fe})]})]})};function q(i){return(0,c.useMemo)(()=>{const y=(0,M.take)(i,oe),x=(0,M.sortBy)((0,M.uniq)(y.flatMap(z=>z.fields[0].values))),v=Math.min(...x),B=Math.max(...x),V=(0,f.KQ)(v),C=(0,f.KQ)(B);return{frameSubset:y,frameSubsetTimestamps:x,frameTimeRange:{from:V,to:C,raw:{from:V,to:C}}}},[i])}const ee=c.forwardRef(({showClearFilterSuffix:i,onClearFilterClick:y,...x},v)=>(0,t.jsx)(o.D,{label:(0,t.jsx)(m.J,{htmlFor:"instancesSearchInput",children:(0,t.jsxs)(D.B,{gap:.5,children:[(0,t.jsx)("span",{children:"Filter instances"}),(0,t.jsx)(l.B,{content:(0,t.jsxs)(t.Fragment,{children:["Use label matcher expression (like ",(0,t.jsx)("code",{children:"{foo=bar}"}),") or click on an instance label to filter instances"]}),children:(0,t.jsx)(d.I,{name:"info-circle",size:"sm"})})]})}),children:(0,t.jsx)(s.p,{id:"instancesSearchInput",prefix:(0,t.jsx)(d.I,{name:"search"}),suffix:i&&(0,t.jsx)(p.$n,{fill:"text",icon:"times",size:"sm",onClick:y,children:"Clear"}),placeholder:"Filter instances",ref:v,...x})}));ee.displayName="SearchFieldInput";function ie(){const i=(0,f.KQ)().subtract(30,"days"),y=(0,f.KQ)();return{from:i,to:y,raw:{from:i,to:y}}}const te=i=>({fullSize:(0,g.css)({minWidth:"100%",height:"100%",display:"flex",flexDirection:"column"}),graphWrapper:(0,g.css)({padding:`${i.spacing()} 0`}),emptyState:(0,g.css)({color:i.colors.text.secondary,display:"flex",flexDirection:"column",gap:i.spacing(2),alignItems:"center",margin:"auto auto"}),moreInstancesWarning:(0,g.css)({color:i.colors.warning.text,padding:i.spacing()}),commonLabels:(0,g.css)({display:"grid",gridTemplateColumns:"max-content auto"}),highlightedLogRecord:(0,g.css)({background:`${i.colors.primary.transparent} !important`,outline:`1px solid ${i.colors.primary.shade} !important`})}),ce=le},70026:(b,R,e)=>{e.d(R,{$:()=>M,Q:()=>c});var t=e(2543),g=e.n(t);function M(P,f){return P.filter(L=>!f.find(T=>JSON.stringify(T)===JSON.stringify(L)))}function c(P){const f=P.flatMap(T=>T);return(0,t.uniqBy)(f.filter(T=>f.filter(r=>(0,t.isEqual)(T,r)).length===Object.keys(P).length),T=>JSON.stringify(T))}},14084:(b,R,e)=>{e.d(R,{PA:()=>m,bF:()=>o,mW:()=>p});var t=e(2543),g=e.n(t),M=e(96540),c=e(11261),P=e(57875),f=e(48241),L=e(73134),T=e(40845),D=e(98164),r=e(32642),d=e(70026);function p(a,n){const u=(0,T.$j)();return(0,M.useMemo)(()=>{const l=a?.data?.values[0]??[],A=o(l)?l:[],j=a?.data?.values[1]??[],O=A.reduce((E,S,K)=>{const G=j[K];return m(G)&&E.push({timestamp:S,line:G}),E},[]),U=(0,t.groupBy)(O,E=>JSON.stringify(E.line.labels)),h=Object.keys(U).map(E=>Object.entries(JSON.parse(E))),I=(0,d.Q)(h),F=n?(0,r.Zc)(n):[],$=Object.entries(U).filter(([E])=>{const S=JSON.parse(E);return(0,D.Av)(S,F)}).map(([E,S])=>s(E,S,I,u));return{historyRecords:O.filter(({line:E})=>E.labels&&(0,D.Av)(E.labels,F)),dataFrames:$,commonLabels:I,totalRecordsCount:O.length}},[a,n,u])}function o(a){return a.every(n=>typeof n=="number")}function m(a){return typeof a=="object"&&a!==null&&"current"in a&&"previous"in a}function s(a,n,u,l){const A=Object.entries(JSON.parse(a)),j={name:"time",type:c.PU.time,values:[...n.map(h=>h.timestamp),Date.now()],config:{displayName:"Time",custom:{fillOpacity:100}}},O=j.values.map((h,I)=>I);O.sort((0,f.i)(j));const U=[...n.map(h=>h.line.current),n.at(-1)?.line.current],N={fields:[{...j,values:j.values.map((h,I)=>j.values[O[I]])},{name:"State",type:c.PU.string,values:U.map((h,I)=>U[O[I]]),config:{displayName:(0,d.$)(A,u).map(([h,I])=>`${h}=${I}`).join(", "),color:{mode:"thresholds"},custom:{fillOpacity:100},mappings:[{type:L.dM.ValueToText,options:{Alerting:{color:l.colors.error.main},Pending:{color:l.colors.warning.main},Normal:{color:l.colors.success.main},NoData:{color:l.colors.info.main}}}],thresholds:{mode:L.Ol.Absolute,steps:[]}}}],length:j.values.length,name:a};return N.fields.forEach(h=>{h.display=(0,P.J)({field:h,theme:l})}),N}}}]);

//# sourceMappingURL=285.3c441f00004559629139.js.map