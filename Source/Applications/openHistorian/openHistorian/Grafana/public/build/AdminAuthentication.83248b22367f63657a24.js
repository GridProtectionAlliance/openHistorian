"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[5592],{35339:(ie,S,t)=>{t.d(S,{F:()=>X});var e=t(74848),u=t(32196),C=t(96540),g=t(24180),w=t(54148),R=t(37390),P=t(55852);const X=({confirmRedirect:T,onDiscard:y,onLocationChange:p})=>{const[c,r]=(0,C.useState)(!1),[O,F]=(0,C.useState)(null),[v,G]=(0,C.useState)(!1);(0,C.useEffect)(()=>{const K=W=>{T&&(W.preventDefault(),W.returnValue="")};return window.addEventListener("beforeunload",K),()=>{window.removeEventListener("beforeunload",K)}},[T]);const de=K=>{const W=window.location.pathname,ce=K.pathname;if(W===ce)return!0;const Q=p?.(K);let $=T&&!v;return Q!==void 0&&($=$&&Q),$?(r(!0),F(K),!1):(Q&&y(),!0)},ue=()=>{r(!1),F(null)},N=()=>{r(!1),G(!0),y()};return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(g.XG,{when:!0,message:de}),O&&v&&(0,e.jsx)(w.C5,{replace:!0,to:O}),(0,e.jsx)(M,{isOpen:c,onDiscard:N,onBackToForm:ue})]})},M=({onDiscard:T,onBackToForm:y,isOpen:p})=>(0,e.jsxs)(R.a,{isOpen:p,title:"Leave page?",onDismiss:y,icon:"exclamation-triangle",className:(0,u.css)({width:"500px"}),children:[(0,e.jsx)("h5",{children:"Changes that you made may not be saved."}),(0,e.jsxs)(R.a.ButtonRow,{children:[(0,e.jsx)(P.$n,{variant:"secondary",onClick:y,fill:"outline",children:"Continue editing"}),(0,e.jsx)(P.$n,{variant:"destructive",onClick:T,children:"Discard unsaved changes"})]})]})},51332:(ie,S,t)=>{t.r(S),t.d(S,{AuthConfigPageUnconnected:()=>Ae,default:()=>ee});var e=t(74848),u=t(96540),C=t(71468),g=t(61268),w=t(14110),R=t(72109),P=t(27746),X=t(71259),M=t(21780),T=t(2913),y=t(32196),p=t(40845),c=t(87978),r=t(94753),O=t(15292),F=t(55852),v=t(3169),G=t(60610);const de=o=>({allowInsecureEmail:o.authConfig.settings?.auth?.oauth_allow_insecure_email_lookup.toLowerCase()==="true"}),ue={loadSettings:G.M5,saveSettings:G.DZ},W=(0,C.connect)(de,ue)(({allowInsecureEmail:o,loadSettings:D,onClose:L,saveSettings:I})=>{const k=(0,v._2)(),H=async()=>{try{await I({updates:{auth:{oauth_allow_insecure_email_lookup:""+!o}}}),await D(!1),k.success("Settings saved")}catch{k.error("Failed to save settings")}},te=async()=>{try{await I({removals:{auth:["oauth_allow_insecure_email_lookup"]}}),await D(!1),k.success("Settings saved")}catch{k.error("Failed to save settings")}},J=(0,e.jsxs)(e.Fragment,{children:["Configure auth settings. Find out more in our"," ",(0,e.jsx)(R.Y,{external:!0,href:"https://grafana.com/docs/grafana/next/setup-grafana/configure-security/configure-authentication/#settings",children:"documentation"}),"."]}),oe=(0,p.of)(ce);return(0,e.jsxs)(c._,{title:"Auth Settings",subtitle:J,size:"md",onClose:L,children:[(0,e.jsxs)("div",{className:oe.advancedAuth,children:[(0,e.jsx)(r.E,{variant:"h4",children:"Advanced Auth"}),(0,e.jsx)(r.E,{variant:"h5",children:"Enable insecure email lookup"}),(0,e.jsx)(r.E,{variant:"body",color:"secondary",children:"Allow users to use the same email address to log into Grafana with different identity providers."}),(0,e.jsx)(O.d,{value:o,onChange:H})]}),(0,e.jsx)(F.$n,{size:"md",variant:"secondary",className:oe.button,onClick:te,tooltip:"This action will disregard any saved changes and load the configuration from the configuration file.",children:"Reset"})]})}),ce=o=>({advancedAuth:(0,y.css)({display:"flex",flexDirection:"column",gap:o.spacing(1)}),button:(0,y.css)({marginTop:o.spacing(2)})});var Q=t(67061),$=t(14578);const Pe=()=>{const o=(0,p.of)(pe);return(0,e.jsxs)("div",{className:o.container,children:[(0,e.jsxs)(Q.B,{gap:1,alignItems:"center",children:[(0,e.jsx)($.I,{name:"cog"}),(0,e.jsx)(r.E,{children:"Configuration required"})]}),(0,e.jsx)(r.E,{variant:"bodySmall",color:"secondary",children:"You have no authentication configuration created at the moment."}),(0,e.jsx)(R.Y,{href:"https://grafana.com/docs/grafana/latest/auth/overview/",external:!0,children:"Refer to the documentation on how to configure authentication"})]})},pe=o=>({container:(0,y.css)({display:"flex",flexDirection:"column",gap:o.spacing(2),backgroundColor:o.colors.background.secondary,borderRadius:o.shape.radius.default,padding:o.spacing(3),width:"max-content",margin:o.spacing(3,"auto")})}),Ie=Pe;var Te=t(8887),q=t(10860),ye=t(39938),he=t(7250),ve=t(5328);function xe({providerId:o,enabled:D,configPath:L,authType:I,onClick:k}){const H=(0,ve.h)({configPath:L,id:o}),[te,J]=he.L[o]||["lock",o.toUpperCase()];return(0,e.jsxs)(q.Z,{href:H,onClick:k,children:[(0,e.jsx)(q.Z.Heading,{children:J}),(0,e.jsx)(q.Z.Meta,{children:I}),(0,Te.n6)(te)&&(0,e.jsx)(q.Z.Figure,{children:(0,e.jsx)($.I,{name:te,size:"xxxl"})}),(0,e.jsx)(q.Z.Actions,{children:(0,e.jsx)(ye.E,{text:D?"Enabled":"Not enabled",color:D?"green":"blue"})})]})}var re=t(73399);function be(o){const{isLoading:D,providerStatuses:L,providers:I}=o.authConfig;return{isLoading:D,providerStatuses:L,providers:I}}const _={loadSettings:G.M5},De=(0,C.connect)(be,_),Ae=({providerStatuses:o,isLoading:D,loadSettings:L,providers:I})=>{(0,u.useEffect)(()=>{L()},[L]);const[k,H]=(0,u.useState)(!1),J=(0,re.getRegisteredAuthProviders)().filter(f=>!o[f.id]?.hide),oe=(f,B)=>{(0,w.rR)("authentication_ui_provider_clicked",{provider:f,enabled:B})};I=I.filter(f=>f.provider!=="saml"),I=I.map(f=>f.provider==="ldap"?{...f,settings:{...f.settings,type:"LDAP"}}:f);const ne=J.length?[...J.map(f=>({provider:f.id,settings:{...o[f.id],configPath:f.configPath,type:f.type}})),...I]:I;return(0,e.jsx)(M.YW,{navId:"authentication",subTitle:(0,e.jsxs)(e.Fragment,{children:["Manage your auth settings and configure single sign-on. Find out more in our"," ",(0,e.jsx)(R.Y,{external:!0,href:"https://grafana.com/docs/grafana/next/setup-grafana/configure-security/configure-authentication",children:"documentation"}),"."]}),actions:T.$W.buildInfo.edition!==g.r.OpenSource&&(0,e.jsx)(P.I,{icon:"cog",variant:"canvas",onClick:()=>H(!0),children:"Auth settings"}),children:(0,e.jsx)(M.YW.Contents,{isLoading:D,children:ne.length?(0,e.jsxs)(X.x,{gap:3,minColumnWidth:34,children:[ne.filter(({provider:f})=>!["grafana_com"].includes(f)).map(({provider:f,settings:B})=>(0,e.jsx)(xe,{authType:B.type||"OAuth",providerId:f,enabled:B.enabled,onClick:()=>oe(f,B.enabled),configPath:B.configPath},f)),k&&(0,e.jsx)(W,{onClose:()=>H(!1)})]}):(0,e.jsx)(Ie,{})})})},ee=De(Ae)},71703:(ie,S,t)=>{t.r(S),t.d(S,{ProviderConfigPage:()=>Le,default:()=>Fe});var e=t(74848),u=t(96540),C=t(54148),g=t(67061),w=t(94753),R=t(39938),P=t(21780),X=t(64915),M=t(31678),T=t(49785),y=t(26272),p=t(3591),c=t(17172),r=t(14110),O=t(39601),F=t(38138),v=t(88575),G=t(15292),de=t(57418),ue=t(90613),N=t(55852),K=t(83122),W=t(29158),ce=t(96374),Q=t(35339),$=t(32196),Pe=t(40845),pe=t(10354),Ie=t(9226),Te=t(90182),q=t(10880),ye=t(8227),he=t(32264),ve=t(72109),xe=t(10096),re=t(8484),be=t(37390),_=t(5328);const De=({isOpen:a,onClose:n,onSuccess:i,isLoading:s})=>{const{handleSubmit:h,register:x,formState:{errors:d}}=(0,T.mN)({mode:"onBlur",defaultValues:{url:""}}),b=j=>j===""?"Please enter the .well-known/openid-configuration endpoint for your IdP":(0,_.K)(j)?!0:"Please enter a valid URL";return(0,e.jsx)(be.a,{title:"OpenID Connect Discovery URL",onDismiss:n,onClickBackdrop:n,isOpen:a,children:(0,e.jsxs)("form",{onSubmit:j=>(j.stopPropagation(),h(i)(j)),children:[(0,e.jsx)(v.D,{label:"The .well-known/openid-configuration endpoint for your IdP",invalid:!!d.url,error:d.url?.message,htmlFor:"url",children:(0,e.jsx)(pe.p,{...x("url",{validate:b}),width:80,id:"url"})}),(0,e.jsxs)(be.a.ButtonRow,{children:[(0,e.jsx)(N.$n,{type:"submit",variant:"primary",disabled:s,children:s?(0,e.jsx)(re.x6,{i18nKey:"oauth.form.server-discovery-modal-loading",children:"Loading..."}):(0,e.jsx)(re.x6,{i18nKey:"oauth.form.server-discovery-modal-submit",children:"Submit"})}),(0,e.jsx)(N.$n,{type:"button",variant:"secondary",onClick:n,children:(0,e.jsx)(re.x6,{i18nKey:"oauth.form.server-discovery-modal-close",children:"Close"})})]})]})})},Ae=({setValue:a})=>{const n=(0,p.J7)(),[i,s]=(0,u.useState)(!1),[h,x]=(0,u.useState)(!1),d=()=>s(!1),b=async j=>{x(!0);try{const ae="/.well-known/openid-configuration",le=new URL(j.url);le.pathname.includes(ae)||(j.url=le.origin+ae);const E=await(0,c.AI)().get(j.url);if(!E.token_endpoint||!E.authorization_endpoint){n.publish({type:y.r1.alertWarning.name,payload:["The URL provided is not a valid .well-known/openid-configuration endpoint"]});return}a("tokenUrl",E.token_endpoint),a("authUrl",E.authorization_endpoint),E.userinfo_endpoint&&a("apiUrl",E.userinfo_endpoint),n.publish({type:y.r1.alertSuccess.name,payload:["OpenID Connect Discovery URL has been successfully fetched."]})}catch{n.publish({type:y.r1.alertWarning.name,payload:["Failed to fetch URL or invalid content"]})}finally{d(),x(!1)}};return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(N.$n,{type:"button",variant:"secondary",onClick:()=>{s(!0)},children:(0,e.jsx)(re.x6,{i18nKey:"oauth.form.server-discovery-action-button",children:"Enter OpenID Connect Discovery URL"})}),(0,e.jsx)(De,{isOpen:i,onClose:d,onSuccess:b,isLoading:h})]})};function ee(a){return Array.isArray(a)&&a.every(n=>typeof n=="object"&&n!==null&&"value"in n)}const o={azuread:[{name:"General settings",id:"general",fields:["name","clientId","clientSecret","scopes","authUrl","tokenUrl","allowSignUp","autoLogin","signoutRedirectUrl"]},{name:"User mapping",id:"user",fields:["roleAttributeStrict","orgMapping","allowAssignGrafanaAdmin","skipOrgRoleSync"]},{name:"Extra security measures",id:"extra",fields:["allowedOrganizations","allowedDomains","allowedGroups","forceUseGraphApi","usePkce","useRefreshToken","tlsSkipVerifyInsecure","tlsClientCert","tlsClientKey","tlsClientCa"]}],generic_oauth:[{name:"General settings",id:"general",fields:["name","clientId","clientSecret","authStyle","scopes","serverDiscoveryUrl","authUrl","tokenUrl","apiUrl","allowSignUp","autoLogin","signoutRedirectUrl"]},{name:"User mapping",id:"user",fields:["nameAttributePath","loginAttributePath","emailAttributeName","emailAttributePath","idTokenAttributeName","roleAttributePath","roleAttributeStrict","orgMapping","orgAttributePath","allowAssignGrafanaAdmin","skipOrgRoleSync"]},{name:"Extra security measures",id:"extra",fields:["allowedOrganizations","allowedDomains","defineAllowedGroups",{name:"allowedGroups",dependsOn:"defineAllowedGroups"},{name:"groupsAttributePath",dependsOn:"defineAllowedGroups"},"defineAllowedTeamsIds",{name:"teamIds",dependsOn:"defineAllowedTeamsIds"},{name:"teamsUrl",dependsOn:"defineAllowedTeamsIds"},{name:"teamIdsAttributePath",dependsOn:"defineAllowedTeamsIds"},"usePkce","useRefreshToken","tlsSkipVerifyInsecure","tlsClientCert","tlsClientKey","tlsClientCa"]}],google:[{name:"General settings",id:"general",fields:["name","clientId","clientSecret","scopes","allowSignUp","autoLogin","signoutRedirectUrl"]},{name:"User mapping",id:"user",fields:["roleAttributePath","roleAttributeStrict","orgMapping","allowAssignGrafanaAdmin","skipOrgRoleSync"]},{name:"Extra security measures",id:"extra",fields:["validateHd","hostedDomain","allowedDomains","allowedGroups","usePkce","useRefreshToken","tlsSkipVerifyInsecure","tlsClientCert","tlsClientKey","tlsClientCa"]}],github:[{name:"General settings",id:"general",fields:["name","clientId","clientSecret","scopes","allowSignUp","autoLogin","signoutRedirectUrl"]},{name:"User mapping",id:"user",fields:["roleAttributePath","roleAttributeStrict","orgMapping","allowAssignGrafanaAdmin","skipOrgRoleSync"]},{name:"Extra security measures",id:"extra",fields:["allowedOrganizations","allowedDomains","teamIds","usePkce","useRefreshToken","tlsSkipVerifyInsecure","tlsClientCert","tlsClientKey","tlsClientCa"]}],gitlab:[{name:"General settings",id:"general",fields:["name","clientId","clientSecret","scopes","allowSignUp","autoLogin","signoutRedirectUrl"]},{name:"User mapping",id:"user",fields:["roleAttributePath","roleAttributeStrict","orgMapping","allowAssignGrafanaAdmin","skipOrgRoleSync"]},{name:"Extra security measures",id:"extra",fields:["allowedDomains","allowedGroups","usePkce","useRefreshToken","tlsSkipVerifyInsecure","tlsClientCert","tlsClientKey","tlsClientCa"]}],okta:[{name:"General settings",id:"general",fields:["name","clientId","clientSecret","scopes","authUrl","tokenUrl","apiUrl","allowSignUp","autoLogin","signoutRedirectUrl"]},{name:"User mapping",id:"user",fields:["roleAttributePath","roleAttributeStrict","orgMapping","orgAttributePath","allowAssignGrafanaAdmin","skipOrgRoleSync"]},{name:"Extra security measures",id:"extra",fields:["allowedDomains","allowedGroups","usePkce","useRefreshToken","tlsSkipVerifyInsecure","tlsClientCert","tlsClientKey","tlsClientCa"]}]};function D(a){return{clientId:{label:"Client Id",type:"text",description:"The client Id of your OAuth2 app.",validation:{required:!0,message:"This field is required"}},clientSecret:{label:"Client secret",type:"secret",description:"The client secret of your OAuth2 app."},allowedOrganizations:{label:"Allowed organizations",type:"select",description:`List of comma- or space-separated organizations. The user should be a member 
of at least one organization to log in.`,multi:!0,allowCustomValue:!0,options:[],placeholder:"Enter organizations (my-team, myteam...) and press Enter to add"},allowedDomains:{label:"Allowed domains",type:"select",description:`List of comma- or space-separated domains. The user should belong to at least 
one domain to log in.`,multi:!0,allowCustomValue:!0,options:[]},authUrl:{label:"Auth URL",type:"text",description:"The authorization endpoint of your OAuth2 provider.",validation:{required:!0,validate:n=>(0,_.K)(n),message:"This field is required and must be a valid URL."}},authStyle:{label:"Auth style",type:"select",description:"It determines how client_id and client_secret are sent to Oauth2 provider. Default is AutoDetect.",multi:!1,options:[{value:"AutoDetect",label:"AutoDetect"},{value:"InParams",label:"InParams"},{value:"InHeader",label:"InHeader"}],defaultValue:{value:"AutoDetect",label:"AutoDetect"}},tokenUrl:{label:"Token URL",type:"text",description:"The token endpoint of your OAuth2 provider.",validation:{required:!0,validate:n=>(0,_.K)(n),message:"This field is required and must be a valid URL."}},scopes:{label:"Scopes",type:"select",description:"List of comma- or space-separated OAuth2 scopes.",multi:!0,allowCustomValue:!0,options:[]},allowedGroups:{label:"Allowed groups",type:"select",description:(0,e.jsxs)(e.Fragment,{children:["List of comma- or space-separated groups. The user should be a member of at least one group to log in."," ",a==="generic_oauth"&&"If you configure allowed_groups, you must also configure groups_attribute_path."]}),multi:!0,allowCustomValue:!0,options:[],validation:a==="azuread"?{validate:n=>typeof n=="string"?(0,ye.A)(n):ee(n)?n.every(i=>i?.value&&(0,ye.A)(i.value)):!0,message:"Allowed groups must be Object Ids."}:void 0},apiUrl:{label:"API URL",type:"text",description:(0,e.jsxs)(e.Fragment,{children:["The user information endpoint of your OAuth2 provider. Information returned by this endpoint must be compatible with"," ",(0,e.jsx)(ve.Y,{href:"https://connect2id.com/products/server/docs/api/userinfo",external:!0,variant:"bodySmall",children:"OpenID UserInfo"}),"."]}),validation:{required:!1,validate:n=>typeof n!="string"?!1:n.length?(0,_.K)(n):!0,message:"This field must be a valid URL if set."}},roleAttributePath:{label:"Role attribute path",description:"JMESPath expression to use for Grafana role lookup.",type:"text",validation:{required:!1}},name:{label:"Display name",description:'Will be displayed on the login page as "Sign in with ...". Helpful if you use more than one identity providers or SSO protocols.',type:"text"},allowSignUp:{label:"Allow sign up",description:"If not enabled, only existing Grafana users can log in using OAuth.",type:"switch"},autoLogin:{label:"Auto login",description:"Log in automatically, skipping the login screen.",type:"switch"},signoutRedirectUrl:{label:"Sign out redirect URL",description:"The URL to redirect the user to after signing out from Grafana.",type:"text",validation:{required:!1}},emailAttributeName:{label:"Email attribute name",description:"Name of the key to use for user email lookup within the attributes map of OAuth2 ID token.",type:"text"},emailAttributePath:{label:"Email attribute path",description:"JMESPath expression to use for user email lookup from the user information.",type:"text"},nameAttributePath:{label:"Name attribute path",description:`JMESPath expression to use for user name lookup from the user ID token. 
This name will be used as the user\u2019s display name.`,type:"text"},loginAttributePath:{label:"Login attribute path",description:"JMESPath expression to use for user login lookup from the user ID token.",type:"text"},idTokenAttributeName:{label:"ID token attribute name",description:"The name of the key used to extract the ID token from the returned OAuth2 token.",type:"text"},roleAttributeStrict:{label:"Role attribute strict mode",description:"If enabled, denies user login if the Grafana role cannot be extracted using Role attribute path.",type:"switch"},allowAssignGrafanaAdmin:{label:"Allow assign Grafana admin",description:"If enabled, it will automatically sync the Grafana server administrator role.",type:"switch",hidden:!xe.TP.isGrafanaAdmin},skipOrgRoleSync:{label:"Skip organization role sync",description:"Prevent synchronizing users\u2019 organization roles from your IdP.",type:"switch"},orgMapping:{label:"Organization mapping",description:I(a),type:"select",hidden:!xe.TP.isGrafanaAdmin,multi:!0,allowCustomValue:!0,options:[],placeholder:"Enter mappings (my-team:1:Viewer...) and press Enter to add"},orgAttributePath:{label:"Organization attribute path",description:"JMESPath expression to use for organization lookup.",type:"text",hidden:!["generic_oauth","okta"].includes(a)},defineAllowedGroups:{label:"Define allowed groups",type:"switch"},defineAllowedTeamsIds:{label:"Define allowed teams ids",type:"switch"},forceUseGraphApi:{label:"Force use Graph API",description:"If enabled, Grafana will fetch the users' groups using the Microsoft Graph API.",type:"checkbox"},usePkce:{label:"Use PKCE",description:(0,e.jsxs)(e.Fragment,{children:["If enabled, Grafana will use"," ",(0,e.jsx)(ve.Y,{external:!0,variant:"bodySmall",href:"https://datatracker.ietf.org/doc/html/rfc7636",children:"Proof Key for Code Exchange (PKCE)"})," ","with the OAuth2 Authorization Code Grant."]}),type:"checkbox"},useRefreshToken:{label:"Use refresh token",description:"If enabled, Grafana will fetch a new access token using the refresh token provided by the OAuth2 provider.",type:"checkbox"},tlsClientCa:{label:"TLS client ca",description:"The file path to the trusted certificate authority list. Is not applicable on Grafana Cloud.",type:"text",hidden:!he.$.localFileSystemAvailable},tlsClientCert:{label:"TLS client cert",description:"The file path to the certificate. Is not applicable on Grafana Cloud.",type:"text",hidden:!he.$.localFileSystemAvailable},tlsClientKey:{label:"TLS client key",description:"The file path to the key. Is not applicable on Grafana Cloud.",type:"text",hidden:!he.$.localFileSystemAvailable},tlsSkipVerifyInsecure:{label:"TLS skip verify",description:`If enabled, the client accepts any certificate presented by the server and any host 
name in that certificate. You should only use this for testing, because this mode leaves 
SSL/TLS susceptible to man-in-the-middle attacks.`,type:"switch"},groupsAttributePath:{label:"Groups attribute path",description:`JMESPath expression to use for user group lookup. If you configure allowed_groups, 
you must also configure groups_attribute_path.`,type:"text"},teamsUrl:{label:"Teams URL",description:(0,e.jsxs)(e.Fragment,{children:["The URL used to query for Team Ids. If not set, the default value is /teams."," ",a==="generic_oauth"&&"If you configure teams_url, you must also configure team_ids_attribute_path."]}),type:"text",validation:{validate:(n,i)=>{let s=!0;return i.teamIds.length&&(s=!!n),typeof n=="string"&&n.length&&(s=(0,_.K)(n)),s},message:"This field must be set if Team Ids are configured and must be a valid URL."}},teamIdsAttributePath:{label:"Team Ids attribute path",description:"The JMESPath expression to use for Grafana Team Id lookup within the results returned by the teams_url endpoint.",type:"text",validation:{validate:(n,i)=>i.teamIds.length?!!n:!0,message:"This field must be set if Team Ids are configured."}},teamIds:{label:"Team Ids",type:"select",description:(0,e.jsxs)(e.Fragment,{children:[a==="github"?"Integer":"String"," list of Team Ids. If set, the user must be a member of one of the given teams to log in."," ",a==="generic_oauth"&&"If you configure team_ids, you must also configure teams_url and team_ids_attribute_path."]}),multi:!0,allowCustomValue:!0,options:[],placeholder:"Enter Team Ids and press Enter to add",validation:a==="github"?{validate:n=>typeof n=="string"?L(n):ee(n)?n.every(i=>i?.value&&L(i.value)):!0,message:"Team Ids must be numbers."}:void 0},hostedDomain:{label:"Hosted domain",description:"The domain under which Grafana is hosted and accessible.",type:"text"},validateHd:{label:"Validate hosted domain",description:"If enabled, Grafana will match the Hosted Domain retrieved from the Google ID Token against the Allowed Domains list specified by the user.",type:"checkbox"},serverDiscoveryUrl:{label:"OpenID Connect Discovery URL",description:"The .well-known/openid-configuration endpoint for your IdP. The info extracted from this URL will be used to populate the Auth URL, Token URL and API URL fields.",type:"custom",content:n=>(0,e.jsx)(Ae,{setValue:n})}}}function L(a){return/^-?\d+$/.test(a)}function I(a){switch(a){case"azuread":return'List of "<GroupID>:<OrgIdOrName>:<Role>" mappings.';case"github":return'List of "<GitHubTeamName>:<OrgIdOrName>:<Role>" mappings.';case"gitlab":return'List of "<GitlabGroupName>:<OrgIdOrName>:<Role>';case"google":return'List of "<GoogleGroupName>:<OrgIdOrName>:<Role>';default:return'List of "<ExternalName>:<OrgIdOrName>:<Role>" mappings.'}}const k=({field:a,register:n,errors:i,watch:s,setValue:h,control:x,unregister:d,secretConfigured:b,provider:j})=>{const[ae,le]=(0,u.useState)(b),E=typeof a!="string",l=E?a.name:a,se=E?s(a.dependsOn):null,m=D(j)[l],je=(0,Pe.$j)();if((0,u.useEffect)(()=>{E&&(se||d(l))},[d,l,se,E]),!a)return console.log("missing field:",l),null;if(m.hidden||E&&!s(a.dependsOn))return null;const V={label:m.label,required:!!m.validation?.required,invalid:!!i[l],error:m.validation?.message,description:m.description,defaultValue:m.defaultValue?.value};switch(m.type){case"text":return(0,e.jsx)(v.D,{...V,children:(0,e.jsx)(pe.p,{...n(l,m.validation),type:m.type,id:l,autoComplete:"off"})},l);case"secret":return(0,e.jsx)(v.D,{...V,htmlFor:l,children:(0,e.jsx)(T.xI,{name:l,control:x,rules:m.validation,render:({field:{ref:Ee,value:z,...ge}})=>(0,e.jsx)(Ie.L4,{...ge,autoComplete:"off",id:l,value:typeof z=="string"?z:"",isConfigured:ae,onReset:()=>{le(!1),h(l,"")}})})},l);case"select":const fe=s(l);let me=m.options;return m.options?.length||(me=ee(fe)?fe:[]),(0,e.jsx)(v.D,{...V,htmlFor:l,children:(0,e.jsx)(T.xI,{rules:m.validation,name:l,control:x,render:({field:{ref:Ee,onChange:z,...ge},fieldState:{invalid:Oe}})=>(0,e.jsx)(Te.l6,{...ge,placeholder:m.placeholder,isMulti:m.multi,invalid:Oe,inputId:l,options:me,allowCustomValue:!!m.allowCustomValue,defaultValue:m.defaultValue,onChange:z,onCreateOption:Ce=>{const Y={value:Ce,label:Ce};z([...me||[],Y])}})})},l);case"switch":return(0,e.jsx)(v.D,{...V,children:(0,e.jsx)(G.d,{...n(l),id:l})},l);case"checkbox":return(0,e.jsx)(q.S,{...n(l),id:l,...V,className:(0,$.css)({marginBottom:je.spacing(2)})},l);case"custom":return(0,e.jsx)(v.D,{...V,children:m.content?m.content(h):(0,e.jsx)(e.Fragment,{})},l);default:return console.error(`Unknown field type: ${m.type}`),null}},H={allowAssignGrafanaAdmin:!1,allowSignUp:!1,allowedDomains:[],allowedGroups:[],allowedOrganizations:[],apiUrl:"",authStyle:"",authUrl:"",autoLogin:!1,clientId:"",clientSecret:"",emailAttributeName:"",emailAttributePath:"",emptyScopes:!1,enabled:!1,extra:{},groupsAttributePath:"",hostedDomain:"",icon:"shield",name:"",roleAttributePath:"",roleAttributeStrict:!1,scopes:[],signoutRedirectUrl:"",skipOrgRoleSync:!1,teamIds:[],teamIdsAttributePath:"",teamsUrl:"",tlsClientCa:"",tlsClientCert:"",tlsClientKey:"",tlsSkipVerify:!1,tokenUrl:"",type:"",usePkce:!1,useRefreshToken:!1},te=a=>a?.length?Array.isArray(a)?a.map(n=>({label:n,value:n})):a.startsWith("[")&&a.endsWith("]")?JSON.parse(a).map(n=>({label:n,value:n})):a.split(/[\s,]/).map(n=>({label:n,value:n})):[];function J(a){if(!a)return H;const n=ne(a.provider),i=B(D(a.provider),n),s={...a.settings};for(const h of i)s[h]=te(s[h]);return s}const oe=a=>a.length<=1?a.map(({value:n})=>n).join(","):JSON.stringify(a.map(({value:n})=>n)),ne=a=>{const n=o[a],i=["enabled"];return Object.values(n).reduce((s,h)=>[...s,...h.fields.map(x=>typeof x=="string"?x:x.name)],i)};function f(a,n){let i=a;const s=ne(n),h=B(D(n),s),x=Object.keys(i).filter(d=>s.includes(d)).reduce((d,b)=>({...d,[b]:i[b]}),{});for(const d of h){const b=i[d];b&&(ee(b)?x[d]=oe(b):ee([b])&&(x[d]=b.value))}return x}function B(a,n){return Object.entries(a).filter(([i,s])=>n.includes(i)&&s.type==="select").map(([i])=>i)}const Se=(0,p.J7)(),Me=({config:a,provider:n,isLoading:i})=>{const{register:s,handleSubmit:h,control:x,reset:d,watch:b,setValue:j,unregister:ae,formState:{errors:le,dirtyFields:E,isSubmitted:l}}=(0,T.mN)({defaultValues:J(a),mode:"onSubmit",reValidateMode:"onChange"}),[se,m]=(0,u.useState)(!1),[je,V]=(0,u.useState)(!1),fe=l&&!je,me=o[n],[Ee,z]=(0,u.useState)(!1),ge=(0,e.jsx)(F.W,{children:(0,e.jsx)(F.W.Item,{label:"Reset to default values",icon:"history-alt",onClick:()=>{z(!0)}})}),Oe=async A=>{m(!0),V(!1);const Z=f(A,n);try{await(0,c.AI)().put(`/api/v1/sso-settings/${n}`,{id:a?.id,provider:a?.provider,settings:{...Z}},{showErrorAlert:!1}),(0,r.rR)("grafana_authentication_ssosettings_saved",{provider:n,enabled:Z.enabled}),Se.publish({type:y.r1.alertSuccess.name,payload:["Settings saved"]}),d(A),setTimeout(()=>{O.Ny.push("/admin/authentication")},300)}catch(U){let Ue="";(0,c.NF)(U)?Ue=U.data.message:U instanceof Error&&(Ue=U.message),Se.publish({type:y.r1.alertError.name,payload:[Ue]}),V(!0),m(!1)}},Ce=async()=>{try{await(0,c.AI)().delete(`/api/v1/sso-settings/${n}`,void 0,{showSuccessAlert:!1}),(0,r.rR)("grafana_authentication_ssosettings_removed",{provider:n}),Se.publish({type:y.r1.alertSuccess.name,payload:["Settings reset to defaults"]}),setTimeout(()=>{O.Ny.push("/admin/authentication")})}catch(A){let Z="";(0,c.NF)(A)?Z=A.data.message:A instanceof Error&&(Z=A.message),Se.publish({type:y.r1.alertError.name,payload:[Z]})}},Y=a?.settings.enabled,we=A=>{(0,r.rR)("grafana_authentication_ssosettings_save_attempt",{provider:n,enabled:A?!Y:Y}),A&&j("enabled",!Y)};return(0,e.jsxs)(P.YW.Contents,{isLoading:i,children:[(0,e.jsxs)("form",{onSubmit:h(Oe),style:{maxWidth:"600px"},children:[(0,e.jsx)(Q.F,{confirmRedirect:!!Object.keys(E).length&&!fe,onDiscard:()=>{(0,r.rR)("grafana_authentication_ssosettings_abandoned",{provider:n}),d()}}),(0,e.jsx)(v.D,{label:"Enabled",hidden:!0,children:(0,e.jsx)(G.d,{...s("enabled"),id:"enabled",label:"Enabled"})}),(0,e.jsx)(g.B,{gap:2,direction:"column",children:me.filter(A=>!A.hidden).map((A,Z)=>(0,e.jsx)(de.M,{label:A.name,isOpen:Z===0,children:A.fields.filter(U=>typeof U!="string"?!U.hidden:!0).map(U=>(0,e.jsx)(k,{field:U,control:x,errors:le,setValue:j,register:s,watch:b,unregister:ae,provider:n,secretConfigured:!!a?.settings.clientSecret},typeof U=="string"?U:U.name))},A.name))}),(0,e.jsx)(ue.a,{display:"flex",gap:2,marginTop:5,children:(0,e.jsxs)(g.B,{alignItems:"center",gap:2,children:[(0,e.jsx)(N.$n,{type:"submit",disabled:se,onClick:()=>we(!0),variant:Y?"secondary":void 0,children:se?Y?"Disabling...":"Saving...":Y?"Disable":"Save and enable"}),(0,e.jsx)(N.$n,{type:"submit",disabled:se,variant:"secondary",onClick:()=>we(!1),children:se?"Saving...":"Save"}),(0,e.jsx)(N.z9,{href:"/admin/authentication",variant:"secondary",children:"Discard"}),(0,e.jsx)(K.m,{overlay:ge,placement:"bottom-start",children:(0,e.jsx)(W.K,{tooltip:"More actions",title:"More actions",tooltipPlacement:"top",size:"md",variant:"secondary",name:"ellipsis-v",hidden:a?.source==="system"})})]})})]}),Ee&&(0,e.jsx)(ce.u,{isOpen:!0,icon:"trash-alt",title:"Reset",body:(0,e.jsxs)(g.B,{direction:"column",gap:3,children:[(0,e.jsx)("span",{children:"Are you sure you want to reset this configuration?"}),(0,e.jsx)("small",{children:"After resetting these settings Grafana will use the provider configuration from the system (config file/environment variables) if any."})]}),confirmText:"Reset",onDismiss:()=>z(!1),onConfirm:async()=>{await Ce(),z(!1)}})]})};var Re=t(7250),Ge=t(60610);const ke=a=>{if(!a)return{text:"Authentication",subTitle:"Configure authentication providers",icon:"shield",id:"authentication"};const n=Re.L[a.provider][1]||a.provider.toUpperCase();return{text:n||"",subTitle:`To configure ${n} OAuth2 you must register your application with ${n}. The provider will generate a Client ID and Client Secret for you to use.`,icon:a.settings.icon||"shield",id:a.provider}},Le=()=>{const a=(0,M.useDispatch)(),{isLoading:n,providers:i}=(0,M.useSelector)(d=>d.authConfig),{provider:s=""}=(0,C.g)(),h=i.find(d=>d.provider===s);if((0,u.useEffect)(()=>{a((0,Ge.TD)(s))},[a,s]),!h||!h.provider||!Re.L[h.provider])return(0,e.jsx)(X.H,{});const x=ke(h);return(0,e.jsx)(P.YW,{navId:"authentication",pageNav:x,renderTitle:d=>(0,e.jsxs)(g.B,{gap:2,alignItems:"center",children:[(0,e.jsx)(w.E,{variant:"h1",children:d}),(0,e.jsx)(R.E,{text:h.settings.enabled?"Enabled":"Not enabled",color:h.settings.enabled?"green":"blue",icon:h.settings.enabled?"check":void 0})]}),children:(0,e.jsx)(Me,{config:h,isLoading:n,provider:s})})},Fe=Le},7250:(ie,S,t)=>{t.d(S,{L:()=>u,o:()=>e});const e="admin/authentication/",u={github:["github","GitHub"],gitlab:["gitlab","GitLab"],google:["google","Google"],generic_oauth:["lock","Generic OAuth"],grafana_com:["grafana","Grafana.com"],azuread:["microsoft","Azure AD"],okta:["okta","Okta"]}},60610:(ie,S,t)=>{t.d(S,{DZ:()=>y,M5:()=>X,TD:()=>M});var e=t(75505),u=t(17172),C=t(32264),g=t(10096),w=t(31678),R=t(73399),P=t(20604);function X(p=!0){return async c=>{if(g.TP.hasPermission(w.AccessControlAction.SettingsRead)){p&&c((0,P.sr)()),c(M());const r=await(0,u.AI)().get("/api/admin/settings");return c((0,P.jA)(r)),await c(T()),p&&c((0,P.MH)()),r}}}function M(p=""){return async c=>{if(!C.$.featureToggles.ssoSettingsApi)return[];const r=await(0,u.AI)().get(`/api/v1/sso-settings${p?`/${p}`:""}`);return c((0,P.Oy)(p?[r]:r)),r}}function T(){return async p=>{const c=(0,R.getRegisteredAuthProviders)(),r={},O=[];for(const v of c)O.push((0,R.getAuthProviderStatus)(v.id));const F=await Promise.all(O);for(let v=0;v<c.length;v++){const G=c[v];r[G.id]=F[v]}p((0,P.TO)(r))}}function y(p){return async c=>{if(g.TP.hasPermission(w.AccessControlAction.SettingsWrite))try{return await(0,e.s)((0,u.AI)().fetch({url:"/api/admin/settings",method:"PUT",data:p,showSuccessAlert:!1,showErrorAlert:!1})),c((0,P.SH)()),!0}catch(r){if(console.log(r),(0,u.NF)(r)){r.isHandled=!0;const O={message:r.data?.message,errors:r.data?.errors};return c((0,P.Nh)(O)),!1}}return!1}}},5328:(ie,S,t)=>{t.d(S,{K:()=>C,h:()=>u});var e=t(7250);function u(g){return e.o+(g.configPath||g.id)}const C=g=>{if(typeof g!="string")return!1;try{return new URL(g).protocol.includes("http")}catch{return!1}}},8227:(ie,S,t)=>{t.d(S,{A:()=>C});const e=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function u(g){return typeof g=="string"&&e.test(g)}const C=u}}]);

//# sourceMappingURL=AdminAuthentication.83248b22367f63657a24.js.map