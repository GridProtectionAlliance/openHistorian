"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[3082],{10106:(e,t,i)=>{i.r(t),i.d(t,{ApiKeysPageUnconnected:()=>ae,default:()=>re});var s,n=i(68404),a=i(18745),r=i(43215),o=i(90923),c=i(3490),l=i(5831),d=i(28436),u=i(69371),h=i(78837),p=i(98163),y=i(8674),g=i(78647),m=i(47570),x=i(21169),f=i(36636),j=i(45916);const A=e=>{let{onHideApiKeys:t}=e;const[i,a]=(0,n.useState)(!1),r=(0,c.useStyles2)(v);return(0,j.jsxs)(c.Alert,{title:"API keys were migrated to Grafana service accounts. This tab is deprecated.",severity:"info",children:[(0,j.jsx)("div",{className:r.text,children:"We have migrated API keys into Grafana service accounts. All API keys are safe and continue working as they used to, you can find them inside the respective service account."}),(0,j.jsxs)("div",{className:r.actionRow,children:[(0,j.jsx)(c.Button,{className:r.actionButton,onClick:()=>a(!0),children:"Hide API keys page forever"}),(0,j.jsx)(c.ConfirmModal,{title:"Hide API Keys page forever",isOpen:i,body:"Are you sure you want to hide API keys page forever and use service accounts from now on?",confirmText:"Yes, hide API keys page.",onConfirm:t,onDismiss:()=>a(!1)}),s||(s=(0,j.jsx)("a",{href:"org/serviceaccounts",children:"View service accounts page"}))]})]})},v=e=>({text:f.css`
    margin-bottom: ${e.spacing(2)};
  `,actionRow:f.css`
    display: flex;
    align-items: center;
  `,actionButton:f.css`
    margin-right: ${e.spacing(2)};
  `}),b=e=>{let{searchQuery:t,disabled:i,onAddClick:s,onSearchChange:n}=e;return(0,j.jsxs)("div",{className:"page-action-bar",children:[(0,j.jsx)("div",{className:"gf-form gf-form--grow",children:(0,j.jsx)(c.FilterInput,{placeholder:"Search keys",value:t,onChange:n})}),(0,j.jsx)(c.Button,{className:"pull-right",onClick:s,disabled:i,children:"Add API key"})]})};var k,w;function K(e){let{onDismiss:t,apiKey:i,rootPath:s}=e;const a=(0,c.useStyles2)(I),r=(0,n.useCallback)((()=>i),[i]);return(0,j.jsxs)(c.Modal,{title:"API Key Created",onDismiss:t,onClickBackdrop:t,isOpen:!0,children:[(0,j.jsx)(c.Field,{label:"Key",children:(0,j.jsx)(c.Input,{id:"Key",value:i,readOnly:!0,addonAfter:(0,j.jsx)(c.ClipboardButton,{icon:"copy",variant:"primary",getText:r,children:"Copy"})})}),k||(k=(0,j.jsx)(c.Alert,{severity:"info",title:"You will only be able to view this key here once!",children:"It is not stored in this form, so be sure to copy it now."})),w||(w=(0,j.jsx)("p",{className:"text-muted",children:"You can authenticate a request using the Authorization HTTP header, example:"})),(0,j.jsxs)("pre",{className:a.small,children:['curl -H "Authorization: Bearer ',i,'" ',s,"/api/dashboards/home"]})]})}function I(e){return{label:f.css`
      padding: ${e.spacing(1)};
      background-color: ${e.colors.background.secondary};
      border-radius: ${e.shape.borderRadius()};
    `,small:f.css`
      font-size: ${e.typography.bodySmall.fontSize};
      font-weight: ${e.typography.bodySmall.fontWeight};
    `}}const C=e=>{let{children:t}=e;const[i,s]=(0,n.useState)(!1),a=(0,n.useCallback)((()=>{s(!i)}),[i]);return t({isAdding:i,toggleIsAdding:a})};var P,S,N=i(6347),M=i(72779);const{Input:T}=c.LegacyForms,E=Object.keys(m.B5).map((e=>({label:e,value:e})));function B(e){if(!e)return!0;try{return r.rangeUtil.intervalToSeconds(e),!0}catch{}return!1}const D={[c.EventsWithValidation.onBlur]:[{rule:B,errorMessage:"Not a valid duration"}]},F=e=>{let{show:t,onClose:i,onKeyAdded:s,disabled:a}=e;const[r,o]=(0,n.useState)(""),[l,d]=(0,n.useState)(m.B5.Viewer),[u,h]=(0,n.useState)("");(0,n.useEffect)((()=>{o(""),d(m.B5.Viewer),h("")}),[t]);return(0,j.jsx)(M.s,{in:t,children:(0,j.jsxs)("div",{className:"gf-form-inline cta-form",children:[(0,j.jsx)(N.P,{onClick:i}),(0,j.jsxs)("form",{className:"gf-form-group",onSubmit:e=>{e.preventDefault(),B(u)&&(s({name:r,role:l,secondsToLive:u}),i())},children:[P||(P=(0,j.jsx)("h5",{children:"Add API Key"})),(0,j.jsxs)("div",{className:"gf-form-inline",children:[(0,j.jsxs)("div",{className:"gf-form max-width-21",children:[S||(S=(0,j.jsx)("span",{className:"gf-form-label",children:"Key name"})),(0,j.jsx)(T,{type:"text",className:"gf-form-input",value:r,placeholder:"Name",onChange:e=>{o(e.currentTarget.value)}})]}),(0,j.jsx)("div",{className:"gf-form",children:(0,j.jsx)(c.InlineField,{label:"Role",children:(0,j.jsx)(c.Select,{inputId:"role-select",value:l,onChange:e=>{d(e.value)},options:E})})}),(0,j.jsx)("div",{className:"gf-form max-width-21",children:(0,j.jsx)(c.InlineField,{tooltip:"The API key life duration. For example, 1d if your key is going to last for one day. Supported units are: s,m,h,d,w,M,y",label:"Time to live",children:(0,j.jsx)(T,{id:"time-to-live-input",type:"text",placeholder:"1d",validationEvents:D,value:u,onChange:e=>{h(e.currentTarget.value)}})})}),(0,j.jsx)("div",{className:"gf-form",children:(0,j.jsx)(c.Button,{type:"submit",disabled:a,children:"Add"})})]})]})]})})};var $,R,Q;const Z=e=>{let{apiKeys:t,timeZone:i,onDelete:s,onMigrate:n}=e;const a=(0,c.useTheme2)(),r=O(a);return(0,j.jsxs)("table",{className:"filter-table",children:[(0,j.jsx)("thead",{children:(0,j.jsxs)("tr",{children:[$||($=(0,j.jsx)("th",{children:"Name"})),R||(R=(0,j.jsx)("th",{children:"Role"})),Q||(Q=(0,j.jsx)("th",{children:"Expires"})),(0,j.jsx)("th",{style:{width:"34px"}})]})}),t.length>0?(0,j.jsx)("tbody",{children:t.map((e=>{const t=Boolean(e.expiration&&Date.now()>new Date(e.expiration).getTime());return(0,j.jsxs)("tr",{className:r.tableRow(t),children:[(0,j.jsx)("td",{children:e.name}),(0,j.jsx)("td",{children:e.role}),(0,j.jsxs)("td",{children:[H(e.expiration,i),t&&(0,j.jsx)("span",{className:r.tooltipContainer,children:(0,j.jsx)(c.Tooltip,{content:"This API key has expired.",children:(0,j.jsx)(c.Icon,{name:"exclamation-triangle"})})})]}),(0,j.jsx)("td",{children:(0,j.jsxs)(c.HorizontalGroup,{justify:"flex-end",children:[(0,j.jsx)(c.Button,{size:"sm",onClick:()=>n(e),children:"Migrate to service account"}),(0,j.jsx)(c.DeleteButton,{"aria-label":"Delete API key",size:"sm",onConfirm:()=>s(e),disabled:!p.Vt.hasPermissionInMetadata(m.bW.ActionAPIKeysDelete,e)})]})})]},e.id)}))}):null]})};function H(e,t){return e?(0,r.dateTimeFormat)(e,{timeZone:t}):"No expiration date"}const O=e=>({tableRow:t=>f.css`
    color: ${t?e.colors.text.secondary:e.colors.text.primary};
  `,tooltipContainer:f.css`
    margin-left: ${e.spacing(1)};
  `});var z;const V=e=>{let{onMigrate:t,disabled:i}=e;const[s,a]=(0,n.useState)(!1),r=(0,c.useStyles2)(L),o=z||(z=(0,j.jsx)("a",{className:"external-link",href:"https://grafana.com/docs/grafana/latest/administration/api-keys/#migrate-api-keys-to-grafana-service-accounts/",target:"_blank",rel:"noopener noreferrer",children:"here."})),l=(0,j.jsxs)("span",{children:["Are you sure you want to migrate all API keys to service accounts? Find out more ",o]});return(0,j.jsxs)(c.Alert,{title:"Switch from API keys to service accounts",severity:"info",children:[(0,j.jsx)("div",{className:r.text,children:"Each API key will be automatically migrated into a service account with a token. The service account will be created with the same permission as the API Key and current API Keys will continue to work as they were."}),(0,j.jsxs)("div",{className:r.actionRow,children:[(0,j.jsx)(c.Button,{className:r.actionButton,onClick:()=>a(!0),children:"Migrate to service accounts now"}),(0,j.jsx)(c.ConfirmModal,{title:"Migrate API keys to service accounts",isOpen:s,body:l,confirmText:"Yes, migrate now",onConfirm:t,onDismiss:()=>a(!1)})]})]})},L=e=>({text:f.css`
    margin-bottom: ${e.spacing(2)};
  `,actionRow:f.css`
    display: flex;
    align-items: center;
  `,actionButton:f.css`
    margin-right: ${e.spacing(2)};
  `});var W=i(28659),Y=i(17421),G=i(89847),U=i(88467);function q(){return async e=>{e((0,U.dF)());const[t,i]=await Promise.all([(0,W.i)().get("/api/auth/keys?includeExpired=false&accesscontrol=true"),(0,W.i)().get("/api/auth/keys?includeExpired=true&accesscontrol=true")]);e((0,U.iK)({keys:t,keysIncludingExpired:i}))}}function _(){return async e=>{const t=await(0,W.i)().get("/api/serviceaccounts/migrationstatus");e((0,U.cB)(!(null==t||!t.migrated)))}}const J=e=>e.includeExpired?e.keysIncludingExpired.length:e.keys.length,X=e=>{const t=RegExp(e.searchQuery,"i");return(e.includeExpired?e.keysIncludingExpired:e.keys).filter((e=>t.test(e.name)||t.test(e.role)))},ee=e=>e.includeExpired,te=e=>0===e.keys.length&&e.keysIncludingExpired.length>0;function ie(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}const se={loadApiKeys:q,deleteApiKey:function(e){return async t=>{(0,W.i)().delete(`/api/auth/keys/${e}`).then((()=>t(q())))}},migrateApiKey:function(e){return async t=>{try{await(0,W.i)().post(`/api/serviceaccounts/migrate/${e}`)}finally{t(q())}}},migrateAll:function(){return async e=>{try{await(0,W.i)().post("/api/serviceaccounts/migrate"),Y.Z.set(G.t,!0)}finally{e(_()),e(q())}}},setSearchQuery:U.ql,toggleIncludeExpired:function(){return e=>{e((0,U.j4)())}},addApiKey:function(e,t){return async i=>{const s=await(0,W.i)().post("/api/auth/keys",e);i((0,U.ql)("")),i(q()),t(s.key)}},getApiKeysMigrationStatus:_,hideApiKeys:function(){return async e=>{await(0,W.i)().post("/api/serviceaccounts/hideApiKeys")}}},ne=(0,a.connect)((function(e){const t=p.Vt.hasAccess(m.bW.ActionAPIKeysCreate,!0);return{navModel:(0,y.h)(e.navIndex,"apikeys"),apiKeys:X(e.apiKeys),searchQuery:e.apiKeys.searchQuery,apiKeysCount:J(e.apiKeys),hasFetched:e.apiKeys.hasFetched,timeZone:(0,g.Z)(e.user),includeExpired:ee(e.apiKeys),includeExpiredDisabled:te(e.apiKeys),canCreate:t,apiKeysMigrated:e.apiKeys.apiKeysMigrated}}),se);class ae extends n.PureComponent{constructor(e){super(e),ie(this,"onDeleteApiKey",(e=>{this.props.deleteApiKey(e.id)})),ie(this,"onMigrateAll",(()=>{this.props.migrateAll()})),ie(this,"onMigrateApiKey",(e=>{this.props.migrateApiKey(e.id)})),ie(this,"onSearchQueryChange",(e=>{this.props.setSearchQuery(e)})),ie(this,"onIncludeExpiredChange",(e=>{this.props.toggleIncludeExpired()})),ie(this,"onAddApiKey",(e=>{const t=e=>{const t=window.location.origin+h.ZP.appSubUrl;l.Z.publish(new x.Dn({props:{apiKey:e,rootPath:t},component:K}))},i=e.secondsToLive;try{const s=i?r.rangeUtil.intervalToSeconds(i):null,n=Object.assign({},e,{secondsToLive:s});this.props.addApiKey(n,t),this.setState((e=>Object.assign({},e,{isAdding:!1})))}catch(e){console.error(e)}})),ie(this,"onHideApiKeys",(async()=>{try{await this.props.hideApiKeys();let e="/org/serviceaccounts";o.locationService.push(e),window.location.reload()}catch(e){console.error(e)}}))}componentDidMount(){this.fetchApiKeys(),this.props.getApiKeysMigrationStatus()}async fetchApiKeys(){await this.props.loadApiKeys()}render(){const{hasFetched:e,navModel:t,apiKeysCount:i,apiKeys:s,searchQuery:n,timeZone:a,includeExpired:r,includeExpiredDisabled:o,canCreate:l,apiKeysMigrated:h}=this.props;return e?(0,j.jsx)(u.T,{navModel:t,children:(0,j.jsx)(u.T.Contents,{isLoading:!1,children:(0,j.jsx)(C,{children:e=>{let{isAdding:t,toggleIsAdding:u}=e;const p=!t&&0===i&&!h,y=i>0;return(0,j.jsxs)(j.Fragment,{children:[!h&&(0,j.jsx)(V,{onMigrate:this.onMigrateAll}),h&&(0,j.jsx)(A,{onHideApiKeys:this.onHideApiKeys}),p?(0,j.jsx)(d.Z,{title:"You haven't added any API keys yet.",buttonIcon:"key-skeleton-alt",onClick:u,buttonTitle:"New API key",proTip:"Remember, you can provide view-only API access to other applications.",buttonDisabled:!l}):null,y?(0,j.jsx)(b,{searchQuery:n,disabled:t||!l,onAddClick:u,onSearchChange:this.onSearchQueryChange}):null,(0,j.jsx)(F,{show:t,onClose:u,onKeyAdded:this.onAddApiKey,disabled:!l}),y?(0,j.jsxs)(c.VerticalGroup,{children:[(0,j.jsx)(c.InlineField,{disabled:o,label:"Include expired keys",children:(0,j.jsx)(c.InlineSwitch,{id:"showExpired",value:r,onChange:this.onIncludeExpiredChange})}),(0,j.jsx)(Z,{apiKeys:s,timeZone:a,onMigrate:this.onMigrateApiKey,onDelete:this.onDeleteApiKey})]}):null]})}})})}):(0,j.jsx)(u.T,{navModel:t,children:(0,j.jsx)(u.T.Contents,{isLoading:!0})})}}const re=ne(ae)}}]);
//# sourceMappingURL=ApiKeysPage.617916b08ac4590b3b38.js.map