"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[6196],{41285:(U,S,a)=>{a.d(S,{P:()=>ce});var n=a(9892),t=a(68404),P=a(19677),C=a(24015),M=a(54291),y=a(26418),p=a(72648),W=a(95093),m=a(31403),s=a(6554),B=a(39904),R=a(81764),I=a(9903),b=a(91720),z=a(53217),T=a(85361),H=a(41959),h=a(85511);const A=t.memo(({def:e,operation:r})=>{const o=(0,p.wW)(F),[l,c]=(0,t.useState)(!1),{getTooltipProps:v,setTooltipRef:x,setTriggerRef:O,visible:E}=(0,T.O)({placement:"top",visible:l,offset:[0,16],onVisibleChange:c,interactive:!0,trigger:["click"]});return t.createElement(t.Fragment,null,t.createElement(m.zx,{title:"Click to show description",ref:O,icon:"info-circle",size:"sm",variant:"secondary",fill:"text"}),E&&t.createElement(h.h_,null,t.createElement("div",{ref:x,...v(),className:o.docBox},t.createElement("div",{className:o.docBoxHeader},t.createElement("span",null,e.renderer(r,e,"<expr>")),t.createElement(y.FlexItem,{grow:1}),t.createElement(m.zx,{icon:"times",onClick:()=>c(!1),fill:"text",variant:"secondary",title:"Remove operation"})),t.createElement("div",{className:o.docBoxBody,dangerouslySetInnerHTML:{__html:Z(e,r)}}))))});A.displayName="OperationDocs";const F=e=>({docBox:(0,n.css)({overflow:"hidden",background:e.colors.background.primary,border:`1px solid ${e.colors.border.strong}`,boxShadow:e.shadows.z3,maxWidth:"600px",padding:e.spacing(1),borderRadius:e.shape.borderRadius(),zIndex:e.zIndex.tooltip}),docBoxHeader:(0,n.css)({fontSize:e.typography.h5.fontSize,fontFamily:e.typography.fontFamilyMonospace,paddingBottom:e.spacing(1),display:"flex",alignItems:"center"}),docBoxBody:(0,n.css)({marginBottom:e.spacing(-1),color:e.colors.text.secondary}),signature:(0,n.css)({fontSize:e.typography.bodySmall.fontSize,fontFamily:e.typography.fontFamilyMonospace}),dropdown:(0,n.css)({opacity:0,color:e.colors.text.secondary})});function Z(e,r){return(0,H.a)(e.explainHandler?e.explainHandler(r,e):e.documentation??"no docs")}const G=t.memo(({operation:e,def:r,index:o,onChange:l,onRemove:c,queryModeller:v,dragHandleProps:x})=>{const O=(0,p.wW)(j),[E,$]=(0,t.useState)({}),f=()=>{if(E.isOpen)$({...E,isOpen:!1});else{const N=v.getAlternativeOperations(r.alternativesKey).map(L=>({label:L.name,value:L}));$({isOpen:!0,alternatives:N})}};return t.createElement("div",{className:O.header},!E.isOpen&&t.createElement(t.Fragment,null,t.createElement("div",{...x},r.name??r.id),t.createElement(y.FlexItem,{grow:1}),t.createElement("div",{className:`${O.operationHeaderButtons} operation-header-show-on-hover`},t.createElement(m.zx,{icon:"angle-down",size:"sm",onClick:f,fill:"text",variant:"secondary",title:"Click to view alternative operations"}),t.createElement(A,{def:r,operation:e}),t.createElement(m.zx,{icon:"times",size:"sm",onClick:()=>c(o),fill:"text",variant:"secondary",title:"Remove operation"}))),E.isOpen&&t.createElement("div",{className:O.selectWrapper},t.createElement(z.Ph,{autoFocus:!0,openMenuOnFocus:!0,placeholder:"Replace with",options:E.alternatives,isOpen:!0,onCloseMenu:f,onChange:N=>{if(N.value){const L=v.getOperationDef(N.value.id),K=[...L.defaultParams];for(let w=0;w<Math.min(e.params.length,K.length);w++)L.params[w].type===r.params[w].type&&(K[w]=e.params[w]);const g={...e,params:K,id:N.value.id};l(o,r.changeTypeHandler?r.changeTypeHandler(g,L):g)}}})))});G.displayName="OperationHeader";const j=e=>({header:(0,n.css)({borderBottom:`1px solid ${e.colors.border.medium}`,padding:e.spacing(.5,.5,.5,1),display:"flex",alignItems:"center","&:hover .operation-header-show-on-hover":(0,n.css)({opacity:1})}),operationHeaderButtons:(0,n.css)({opacity:0,transition:e.transitions.create(["opacity"],{duration:e.transitions.duration.short})}),selectWrapper:(0,n.css)({paddingRight:e.spacing(2)})});var X=a(63134),Y=a(68668),q=a(58255),Q=a(8373);function ee(e){if(e.editor)return e.editor;if(e.options)return ne;switch(e.type){case"boolean":return ae;case"number":case"string":default:return te}}function te(e){return t.createElement(Y.H,{id:(0,Q.i1)(e.operationIndex,e.index),defaultValue:e.value?.toString(),minWidth:e.paramDef.minWidth,placeholder:e.paramDef.placeholder,title:e.paramDef.description,maxWidth:(e.paramDef.minWidth||20)*3,onCommitChange:r=>{e.onChange(e.index,r.currentTarget.value),e.paramDef.runQueryOnEnter&&r.type==="keydown"&&e.onRunQuery()}})}function ae(e){return t.createElement(q.X,{id:(0,Q.i1)(e.operationIndex,e.index),value:e.value,onChange:r=>e.onChange(e.index,r.currentTarget.checked)})}function ne({paramDef:e,value:r,index:o,operationIndex:l,onChange:c}){const v=(0,p.wW)(re);let x=e.options;x[0]?.label||(x=e.options.map(E=>({label:E.toString(),value:E})));let O=x.find(E=>E.value===r)??(0,X.E)(r);return!r&&e.optional?t.createElement("div",{className:v.optionalParam},t.createElement(m.zx,{size:"sm",variant:"secondary",title:`Add ${e.name}`,icon:"plus",onClick:()=>c(o,x[0].value)},e.name)):t.createElement(y.Stack,{gap:.5,direction:"row",alignItems:"center",wrap:!1},t.createElement(z.Ph,{id:(0,Q.i1)(l,o),value:O,options:x,placeholder:e.placeholder,allowCustomValue:!0,onChange:E=>c(o,E.value),width:e.minWidth||"auto"}),e.optional&&t.createElement(m.zx,{"data-testid":`operations.${o}.remove-param`,size:"sm",fill:"text",icon:"times",variant:"secondary",title:`Remove ${e.name}`,onClick:()=>c(o,"")}))}const re=e=>({optionalParam:(0,n.css)({marginTop:e.spacing(1)})});function se({operation:e,index:r,onRemove:o,onChange:l,onRunQuery:c,queryModeller:v,query:x,datasource:O,flash:E,highlight:$}){const f=v.getOperationDef(e.id),N=oe(E),L=e.id===b.B5.LabelFilter&&(0,I.ZO)(e,x.operations),K=(0,p.l4)(),g=ie(K,L);if(!f)return t.createElement("span",null,"Operation ",e.id," not found");const w=(i,D)=>{const V={...e,params:[...e.params]};V.params[i]=D,k(f,V,r,i,l)},J=()=>{const i={...e,params:[...e.params,""]};k(f,i,r,e.params.length,l)},u=i=>{const D={...e,params:[...e.params.slice(0,i),...e.params.slice(i+1)]};k(f,D,r,i,l)},d=[];for(let i=0;i<e.params.length;i++){const D=f.params[Math.min(f.params.length-1,i)],V=ee(D);d.push(t.createElement("div",{className:g.paramRow,key:`${i}-1`},!D.hideName&&t.createElement("div",{className:g.paramName},t.createElement("label",{htmlFor:(0,Q.i1)(r,i)},D.name),D.description&&t.createElement(s.u,{placement:"top",content:D.description,theme:"info"},t.createElement(B.J,{name:"info-circle",size:"sm",className:g.infoIcon}))),t.createElement("div",{className:g.paramValue},t.createElement(y.Stack,{gap:.5,direction:"row",alignItems:"center",wrap:!1},t.createElement(V,{index:i,paramDef:D,value:e.params[i],operation:e,operationIndex:r,onChange:w,onRunQuery:c,query:x,datasource:O}),D.restParam&&(e.params.length>f.params.length||D.optional)&&t.createElement(m.zx,{"data-testid":`operations.${r}.remove-rest-param`,size:"sm",fill:"text",icon:"times",variant:"secondary",title:`Remove ${D.name}`,onClick:()=>u(i)})))))}let _;if(f.params.length>0){const i=f.params[f.params.length-1];i.restParam&&(_=le(i,J,r,e.params.length,g))}const ue=i=>{if(!i)return L?!0:void 0};return t.createElement(P._l,{draggableId:`operation-${r}`,index:r},(i,D)=>t.createElement(R._,{error:"You have conflicting label filters",invalid:ue(D.isDragging),className:(0,n.cx)(g.error,g.cardWrapper)},t.createElement("div",{className:(0,n.cx)(g.card,(N||$)&&g.cardHighlight,L&&g.cardError),ref:i.innerRef,...i.draggableProps,"data-testid":`operations.${r}.wrapper`},t.createElement(G,{operation:e,dragHandleProps:i.dragHandleProps,def:f,index:r,onChange:l,onRemove:o,queryModeller:v}),t.createElement("div",{className:g.body},d),_,r<x.operations.length-1&&t.createElement("div",{className:g.arrow},t.createElement("div",{className:g.arrowLine}),t.createElement("div",{className:g.arrowArrow})))))}function oe(e){const[r,o]=(0,t.useState)(!0);return(0,t.useEffect)(()=>{let l;return e?l=setTimeout(()=>{o(!1)},1e3):o(!0),()=>clearTimeout(l)},[e]),r&&e}function le(e,r,o,l,c){return t.createElement("div",{className:c.restParam,key:`${l}-2`},t.createElement(m.zx,{size:"sm",icon:"plus",title:`Add ${e.name}`,variant:"secondary",onClick:r,"data-testid":`operations.${o}.add-rest-param`},e.name))}function k(e,r,o,l,c){e.paramChangedHandler?c(o,e.paramChangedHandler(l,r,e)):c(o,r)}const ie=(e,r)=>({cardWrapper:(0,n.css)({alignItems:"stretch"}),error:(0,n.css)({marginBottom:e.spacing(1)}),card:(0,n.css)({background:e.colors.background.primary,border:`1px solid ${e.colors.border.medium}`,display:"flex",flexDirection:"column",cursor:"grab",borderRadius:e.shape.borderRadius(1),position:"relative",transition:"all 0.5s ease-in 0s",height:r?"auto":"100%"}),cardError:(0,n.css)({boxShadow:`0px 0px 4px 0px ${e.colors.warning.main}`,border:`1px solid ${e.colors.warning.main}`}),cardHighlight:(0,n.css)({boxShadow:`0px 0px 4px 0px ${e.colors.primary.border}`,border:`1px solid ${e.colors.primary.border}`}),infoIcon:(0,n.css)({marginLeft:e.spacing(.5),color:e.colors.text.secondary,":hover":{color:e.colors.text.primary}}),body:(0,n.css)({margin:e.spacing(1,1,.5,1),display:"table"}),paramRow:(0,n.css)({label:"paramRow",display:"table-row",verticalAlign:"middle"}),paramName:(0,n.css)({display:"table-cell",padding:e.spacing(0,1,0,0),fontSize:e.typography.bodySmall.fontSize,fontWeight:e.typography.fontWeightMedium,verticalAlign:"middle",height:"32px"}),paramValue:(0,n.css)({label:"paramValue",display:"table-cell",verticalAlign:"middle"}),restParam:(0,n.css)({padding:e.spacing(0,1,1,1)}),arrow:(0,n.css)({position:"absolute",top:"0",right:"-18px",display:"flex"}),arrowLine:(0,n.css)({height:"2px",width:"8px",backgroundColor:e.colors.border.strong,position:"relative",top:"14px"}),arrowArrow:(0,n.css)({width:0,height:0,borderTop:"5px solid transparent",borderBottom:"5px solid transparent",borderLeft:`7px solid ${e.colors.border.strong}`,position:"relative",top:"10px"})});function ce({query:e,datasource:r,queryModeller:o,onChange:l,onRunQuery:c,highlightedOp:v}){const x=(0,p.wW)(me),{operations:O}=e,E=de(O),[$,f]=(0,t.useState)(!1),N=(u,d)=>{const _=[...O];_.splice(u,1,d),l({...e,operations:_})},L=u=>{const d=[...O.slice(0,u),...O.slice(u+1)];l({...e,operations:d})},K=o.getCategories().map(u=>({value:u,label:u,items:o.getOperationsForCategory(u).map(d=>({value:d.id,label:d.name,isLeaf:!0}))})),g=u=>{const d=o.getOperationDef(u);d&&(l(d.addOperationHandler(d,e,o)),f(!1))},w=u=>{if(!u.destination)return;const d=[...O],_=d[u.source.index];d.splice(u.source.index,1),d.splice(u.destination.index,0,_),l({...e,operations:d})},J=()=>{f(!1)};return t.createElement(y.Stack,{gap:1,direction:"column"},t.createElement(y.Stack,{gap:1},O.length>0&&t.createElement(P.Z5,{onDragEnd:w},t.createElement(P.bK,{droppableId:"sortable-field-mappings",direction:"horizontal"},u=>t.createElement("div",{className:x.operationList,ref:u.innerRef,...u.droppableProps},O.map((d,_)=>t.createElement(se,{key:d.id+JSON.stringify(d.params)+_,queryModeller:o,index:_,operation:d,query:e,datasource:r,onChange:N,onRemove:L,onRunQuery:c,flash:E[_],highlight:v===d})),u.placeholder))),t.createElement("div",{className:x.addButton},$?t.createElement(W.v,{options:K,onSelect:g,onBlur:J,autoFocus:!0,alwaysOpen:!0,hideActiveLevelLabel:!0,placeholder:"Search"}):t.createElement(m.zx,{icon:"plus",variant:"secondary",onClick:()=>f(!0),title:"Add operation"},"Operations"))))}function de(e){const r=(0,C.Z)(),o=(0,M.Z)(e);if(!r())return e.map(()=>!1);if(!o)return e.map(()=>!0);let l=[];if(o.length-1===e.length&&e.every(c=>o.includes(c)))return e.map(()=>!1);if(o.length+1===e.length&&o.every(c=>e.includes(c))){const c=e.find(v=>!o.includes(v));l=e.map(v=>v===c)}else l=e.map((c,v)=>!pe(c.id,o[v]?.id));return l}function pe(e,r){return e===r||`__${e}_by`===r||e===`__${r}_by`}const me=e=>({heading:(0,n.css)({label:"heading",fontSize:12,fontWeight:e.typography.fontWeightMedium,marginBottom:0}),operationList:(0,n.css)({label:"operationList",display:"flex",flexWrap:"wrap",gap:e.spacing(2)}),addButton:(0,n.css)({label:"addButton",width:126,paddingBottom:e.spacing(1)})})},73250:(U,S,a)=>{a.d(S,{B:()=>M});var n=a(9892),t=a(68404),P=a(26418),C=a(72648);function M({children:p}){const W=(0,C.wW)(y);return t.createElement("div",{className:W.root},t.createElement(P.Stack,{gap:1},p))}const y=p=>({root:(0,n.css)({padding:p.spacing(1,1,0,1),backgroundColor:p.colors.background.secondary,borderRadius:p.shape.borderRadius(1)})})},75765:(U,S,a)=>{a.d(S,{L:()=>p});var n=a(9892),t=a(68404),P=a(41818),C=a(72648),M=a(6554),y=a(31403);const p=({datasource:m,query:s,onChange:B,data:R,queryModeller:I,buildVisualQueryFromString:b})=>{const[z,T]=(0,t.useState)([]),H=(0,C.wW)(W);return(0,t.useEffect)(()=>{const h={expr:I.renderQuery(s),refId:""},A=m.getQueryHints(h,R?.series||[]).filter(F=>F.fix?.action);T(A)},[m,s,R,I]),t.createElement(t.Fragment,null,z.length>0&&t.createElement("div",{className:H.container},z.map(h=>t.createElement(M.u,{content:`${h.label} ${h.fix?.label}`,key:h.type},t.createElement(y.zx,{onClick:()=>{if((0,P.ff)("grafana_query_builder_hints_clicked",{hint:h.type,datasourceType:m.type}),h?.fix?.action){const A={expr:I.renderQuery(s),refId:""},F=m.modifyQuery(A,h.fix.action),Z=b(F.expr);return B(Z.query)}},fill:"outline",size:"sm",className:H.hint},"hint: ",h.fix?.title||h.fix?.action?.type.toLowerCase().replace("_"," "))))))};p.displayName="QueryBuilderHints";const W=m=>({container:n.css`
      display: flex;
      align-items: start;
    `,hint:n.css`
      margin-right: ${m.spacing(1)};
    `})},92611:(U,S,a)=>{a.d(S,{k:()=>M});var n=a(68404),t=a(2594),P=a(58079);const C=[{label:"Builder",value:P.c.Builder},{label:"Code",value:P.c.Code}];function M({mode:y,onChange:p}){return n.createElement("div",{"data-testid":"QueryEditorModeToggle"},n.createElement(t.S,{options:C,size:"sm",value:y,onChange:p}))}},61458:(U,S,a)=>{a.d(S,{n:()=>W});var n=a(9892),t=a(82897),P=a.n(t),C=a(68404),M=a(26418),y=a(72648),p=a(8944);function W({label:s,...B}){const R=s.replace(" ","-"),I=(0,C.useRef)((0,t.uniqueId)(`switch-${R}`)),b=(0,y.wW)(m);return C.createElement(M.Stack,{gap:1},C.createElement("label",{htmlFor:I.current,className:b.switchLabel},s),C.createElement(p.r,{...B,id:I.current}))}const m=s=>({switchLabel:(0,n.css)({color:s.colors.text.secondary,cursor:"pointer",fontSize:s.typography.bodySmall.fontSize,"&:hover":{color:s.colors.text.primary}})})},38435:(U,S,a)=>{a.d(S,{d:()=>W});var n=a(9892),t=a(68404),P=a(86253),C=a(20112),M=a(26418),y=a(72648),p=a(39904);function W({title:s,children:B,collapsedInfo:R,queryStats:I}){const[b,z]=(0,P.Z)(!1),T=(0,y.wW)(m),H=()=>{const{text:h,suffix:A}=(0,C.Cf)("bytes")(I.bytes,1);return h+A};return t.createElement("div",{className:T.wrapper},t.createElement(M.Stack,{gap:0,direction:"column"},t.createElement("div",{className:T.header,onClick:z,title:"Click to edit options"},t.createElement("div",{className:T.toggle},t.createElement(p.J,{name:b?"angle-down":"angle-right"})),t.createElement("h6",{className:T.title},s),!b&&t.createElement("div",{className:T.description},R.map((h,A)=>t.createElement("span",{key:A},h)))),b&&t.createElement("div",{className:T.body},B)),I&&t.createElement("p",{className:T.stats},"This query will process approximately ",H(),"."))}const m=s=>({wrapper:(0,n.css)({width:"100%",display:"flex",justifyContent:"space-between",alignItems:"baseline"}),switchLabel:(0,n.css)({color:s.colors.text.secondary,cursor:"pointer",fontSize:s.typography.bodySmall.fontSize,"&:hover":{color:s.colors.text.primary}}),header:(0,n.css)({display:"flex",cursor:"pointer",alignItems:"baseline",color:s.colors.text.primary,"&:hover":{background:s.colors.emphasize(s.colors.background.primary,.03)}}),title:(0,n.css)({flexGrow:1,overflow:"hidden",fontSize:s.typography.bodySmall.fontSize,fontWeight:s.typography.fontWeightMedium,margin:0}),description:(0,n.css)({color:s.colors.text.secondary,fontSize:s.typography.bodySmall.fontSize,paddingLeft:s.spacing(2),gap:s.spacing(2),display:"flex"}),body:(0,n.css)({display:"flex",paddingTop:s.spacing(2),gap:s.spacing(2),flexWrap:"wrap"}),toggle:(0,n.css)({color:s.colors.text.secondary,marginRight:`${s.spacing(1)}`}),stats:(0,n.css)({margin:"0px",color:s.colors.text.secondary,fontSize:s.typography.bodySmall.fontSize})})},89290:(U,S,a)=>{a.d(S,{P5:()=>m,ar:()=>P,iS:()=>M});var n=a(68404),t=a(58379);const P="PrometheusQueryEditorExplainDefault",C="PrometheusQueryEditorRawQueryDefault",M="LokiQueryEditorExplainDefault",y="LokiQueryEditorRawQueryDefault";function p(s,B=!1){const R=t.Z.get(s);return R===void 0?B:Boolean(parseInt(R,10))}function W(s,B){t.Z.set(s,B?"1":"0")}function m(s,B=!1){const[R,I]=(0,n.useState)(p(s,B)),b=(0,n.useCallback)(z=>{W(s,z),I(z)},[s]);return{flag:R,setFlag:b}}}}]);

//# sourceMappingURL=6196.4c777004ed5665a4f501.js.map