"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[7885],{41671:(e,a,r)=>{r.d(a,{ZQ:()=>A,mV:()=>x,f1:()=>j,$M:()=>N});var t=r(43215),o=r(90923),s=r(36537),n=r(5831),i=r(58257),d=r(28659),l=r(54819),c=r(17421),u=r(36103),h=r(22305),b=r(75478),p=r(67706),g=r(5970),f=r(47570),v=r(70930),m=r(57358),w=r(36586),S=r(41169);var D=r(86380);const y=function(e){let a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return e.forEach((e=>{e.panels?y(e.panels,a):e.targets&&e.targets.forEach((e=>{var r;null!==(r=e.datasource)&&void 0!==r&&r.type&&(a[e.datasource.type]?a[e.datasource.type].push(e):a[e.datasource.type]=[e])}))})),a};function x(e){return async(a,r)=>{var x,N;a((0,D.sf)());const T=await async function(e,a,r){const s=c.Z.getObject(I);if(s)return j(),s;try{switch(e.routeName){case f.vq.Home:{const e=await d.ae.get("/api/dashboards/home");if(e.redirectUri){const a=t.locationUtil.stripBaseFromUrl(e.redirectUri);return o.locationService.replace(a),null}return e.meta.canSave=!1,e.meta.canShare=!1,e.meta.canStar=!1,e}case f.vq.Public:return await u.pD.loadDashboard("public",e.urlSlug,e.accessToken);case f.vq.Normal:{const a=await u.pD.loadDashboard(e.urlType,e.urlSlug,e.urlUid);if(e.fixUrl&&a.meta.url){const e=t.locationUtil.stripBaseFromUrl(a.meta.url),r=o.locationService.getLocation().pathname;e!==r&&(o.locationService.replace(Object.assign({},o.locationService.getLocation(),{pathname:e})),console.log("not correct url correcting",e,r))}return a}case f.vq.New:return A(e.urlFolderId,e.panelType);case f.vq.Path:{var n;const a=null!==(n=e.urlSlug)&&void 0!==n?n:"";return await u.pD.loadDashboard(f.vq.Path,a,a)}default:throw{message:"Unknown route "+e.routeName}}}catch(e){return(0,o.isFetchError)(e)&&e.cancelled||(a((0,D.jA)({message:"Failed to fetch dashboard",error:e})),console.error(e)),null}}(e,a);if(!T)return;let U;a((0,D.Nv)());try{U=new S.f(T.dashboard,T.meta)}catch(e){return a((0,D.jA)({message:"Failed create dashboard model",error:e})),void console.error(e)}const k=r(),C=o.locationService.getSearchObject();C.orgId||o.locationService.partial({orgId:k.user.orgId},!0);const O=(0,b.$t)();(0,h.h4)().setCurrent(U),O.init(U);const E=(0,g.mn)(null!==(x=e.urlUid)&&void 0!==x?x:U.uid);await a((0,m.LX)(E,U));if((0,v.Tl)({dashboard:U,timeSrv:O}).run({dashboard:U,range:O.timeRange()}),(0,w.cp)(r())===E&&r().dashboard.initPhase===f.bG.Services){try{U.processRepeats(),C.autofitpanels&&U.autoFitPanels(window.innerHeight,C.kiosk),l.K.setupDashboardBindings(U)}catch(e){e instanceof Error&&a((0,s.$l)((0,i.t_)("Dashboard init failed",e))),console.error(e)}e.routeName!==f.vq.New?(!function(e){const a={dashboardId:e.id,dashboardName:e.title,dashboardUid:e.uid,folderName:e.meta.folderTitle,eventName:o.MetaAnalyticsEventName.DashboardView};(0,o.reportMetaAnalytics)(a)}(U),p.H.watch(U.uid)):p.H.leave(),""!==U.weekStart?(0,t.setWeekStart)(U.weekStart):(0,t.setWeekStart)(o.config.bootData.user.weekStart),n.Z.publish(new t.DashboardLoadedEvent({dashboardId:U.uid,orgId:k.user.orgId,userId:null===(N=k.user.user)||void 0===N?void 0:N.id,grafanaVersion:o.config.buildInfo.version,queries:y(U.panels)})),a((0,D.dS)(U))}}}function A(e,a){const r={meta:{canStar:!1,canShare:!1,canDelete:!1,isNew:!0,folderId:0},dashboard:{title:"New dashboard",panels:[{type:null!=a?a:"add-panel",gridPos:{x:0,y:0,w:12,h:9},title:"Panel Title"}]}};return e&&(r.meta.folderId=parseInt(e,10)),r}const I="DASHBOARD_FROM_LS_KEY";function N(e){c.Z.setObject(I,e)}function j(){c.Z.delete(I)}},77885:(e,a,r)=>{r.r(a),r.d(a,{AddToDashboard:()=>j});var t=r(68404),o=r(18745),s=r(3490),n=r(16479),i=r(82897),d=r(80916),l=r(43215),c=r(90923),u=r(49248),h=r(61959),b=r(41671),p=r(47570),g=r(28659);let f;async function v(e){var a;const r=function(e,a){for(const{refId:r}of e.filter(m)){const e=w(r);if(a.graphFrames.some(e))return"timeseries";if(a.logsFrames.some(e))return"logs";if(a.nodeGraphFrames.some(e))return"nodeGraph";if(a.traceFrames.some(e))return"traces"}return"table"}(e.queries,e.queryResponse),t={targets:e.queries,type:r,title:"New Panel",gridPos:{x:0,y:0,w:12,h:8},datasource:e.datasource};let o;if(e.dashboardUid)try{o=await g.ae.getDashboardByUid(e.dashboardUid)}catch(e){throw f.FETCH_DASHBOARD}else o=function(){const e=(0,b.ZQ)();return e.dashboard.panels=[],e}();o.dashboard.panels=[t,...null!==(a=o.dashboard.panels)&&void 0!==a?a:[]];try{(0,b.$M)(o)}catch{throw f.SET_DASHBOARD_LS}}!function(e){e.FETCH_DASHBOARD="fetch-dashboard",e.SET_DASHBOARD_LS="set-dashboard-ls-error"}(f||(f={}));const m=e=>!e.hide,w=e=>a=>a.refId===e;var S=r(45916);const D=["ref"],y=["ref","value","onChange"];function x(e,a){if(null==e)return{};var r,t,o={},s=Object.keys(e);for(t=0;t<s.length;t++)r=s[t],a.indexOf(r)>=0||(o[r]=e[r]);return o}var A,I;!function(e){e.NewDashboard="new-dashboard",e.ExistingDashboard="existing-dashboard"}(A||(A={})),function(e){e.UNKNOWN="unknown-error",e.NAVIGATION="navigation-error"}(I||(I={}));const N=e=>{let{onClose:a,exploreId:g}=e;const m=(0,o.useSelector)((0,n.F)(g)),[w,N]=(0,t.useState)(),{handleSubmit:j,control:T,formState:{errors:U},watch:k}=(0,d.cI)({defaultValues:{saveTarget:A.NewDashboard}}),C=h.Vt.hasAccess(p.bW.DashboardsCreate,h.Vt.isEditor),O=h.Vt.hasAccess(p.bW.DashboardsWrite,h.Vt.isEditor),E=[];C&&E.push({label:"New dashboard",value:A.NewDashboard}),O&&E.push({label:"Existing dashboard",value:A.ExistingDashboard});const F=E.length>1?k("saveTarget"):E[0].value,q=`Add panel to ${E.length>1?"dashboard":E[0].label.toLowerCase()}`,B=async(e,t)=>{N(void 0);const o=t.saveTarget===A.ExistingDashboard?t.dashboardUid:void 0;(0,c.reportInteraction)("e2d_submit",{newTab:e,saveTarget:t.saveTarget,queries:m.queries.length});try{var s;await v({dashboardUid:o,datasource:null===(s=m.datasourceInstance)||void 0===s?void 0:s.getRef(),queries:m.queries,queryResponse:m.queryResponse})}catch(e){switch(e){case f.FETCH_DASHBOARD:N({error:e,message:"Could not fetch dashboard information. Please try again."});break;case f.SET_DASHBOARD_LS:N({error:e,message:"Could not add panel to dashboard. Please try again."});break;default:N({error:I.UNKNOWN,message:"Something went wrong. Please try again."})}return}const n=function(e){return e?`d/${e}`:"dashboard/new"}(o);if(!e)return a(),void c.locationService.push(l.locationUtil.stripBaseFromUrl(n));if(!!!r.g.open(c.config.appUrl+n,"_blank"))return N({error:I.NAVIGATION,message:"Could not navigate to the selected dashboard. Please try again."}),void(0,b.f1)();a()};return(0,t.useEffect)((()=>{(0,c.reportInteraction)("e2d_open")}),[]),(0,S.jsx)(s.Modal,{title:q,onDismiss:a,isOpen:!0,children:(0,S.jsxs)("form",{children:[E.length>1&&(0,S.jsx)(s.InputControl,{control:T,render:e=>{let{}=e,a=x(e.field,D);return(0,S.jsx)(s.Field,{label:"Target dashboard",description:"Choose where to add the panel.",children:(0,S.jsx)(s.RadioButtonGroup,Object.assign({options:E},a,{id:"e2d-save-target"}))})},name:"saveTarget"}),F===A.ExistingDashboard&&(0,S.jsx)(s.InputControl,{render:e=>{var a;let{field:{onChange:r}}=e,t=x(e.field,y);return(0,S.jsx)(s.Field,{label:"Dashboard",description:"Select in which dashboard the panel will be created.",error:null===(a=U.dashboardUid)||void 0===a?void 0:a.message,invalid:!!U.dashboardUid,children:(0,S.jsx)(u.o,Object.assign({},t,{inputId:"e2d-dashboard-picker",defaultOptions:!0,onChange:e=>r(null==e?void 0:e.uid)}))})},control:T,name:"dashboardUid",shouldUnregister:!0,rules:{required:{value:!0,message:"This field is required."}}}),w&&(0,S.jsx)(s.Alert,{severity:"error",title:"Error adding the panel",children:w.message}),(0,S.jsxs)(s.Modal.ButtonRow,{children:[(0,S.jsx)(s.Button,{type:"reset",onClick:a,fill:"outline",variant:"secondary",children:"Cancel"}),(0,S.jsx)(s.Button,{type:"submit",variant:"secondary",onClick:j((0,i.partial)(B,!0)),icon:"external-link-alt",children:"Open in new tab"}),(0,S.jsx)(s.Button,{type:"submit",variant:"primary",onClick:j((0,i.partial)(B,!1)),icon:"apps",children:"Open dashboard"})]})]})})},j=e=>{var a,r;let{exploreId:i}=e;const[d,l]=(0,t.useState)(!1),c=(0,n.F)(i),u=!(null===(a=(0,o.useSelector)(c))||void 0===a||null===(r=a.queries)||void 0===r||!r.length);return(0,S.jsxs)(S.Fragment,{children:[(0,S.jsx)(s.ToolbarButton,{icon:"apps",onClick:()=>l(!0),"aria-label":"Add to dashboard",disabled:!u,children:"Add to dashboard"}),d&&(0,S.jsx)(N,{onClose:()=>l(!1),exploreId:i})]})}}}]);
//# sourceMappingURL=7885.e541243cdcad9d7bc79e.js.map