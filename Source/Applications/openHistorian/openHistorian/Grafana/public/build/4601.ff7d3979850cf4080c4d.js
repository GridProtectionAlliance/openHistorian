"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[4601],{14601:(fi,ke,m)=>{m.r(ke),m.d(ke,{plugin:()=>pi});var Ae=m(7238),Yt=m(55294),Kt=m(82378),h=m(9892),a=m(68404),me=m(69311),Le=m(45253),j=m(72648),Re=m(69659),pe=m(77117),f=m(81764),b=m(46967);const Jt=t=>(e,s)=>{const n={};for(const i in t)n[i]=t[i](e[i],s);return n},fe=(t,e,s)=>(0,a.useCallback)(i=>{t(s(e,i))},[t,e,s]),Qe=(0,a.createContext)(void 0),T=()=>{const t=(0,a.useContext)(Qe);if(!t)throw new Error("Use DispatchContext first.");return t},We=t=>({name:t,pipelineAgg:""}),ze=t=>`var${Math.max(0,...t.map(e=>parseInt(e.name.match("^var(\\d+)$")?.[1]||"0",10)))+1}`,He=t=>t.settings?.model==="ewma",he=t=>t.settings?.model==="holt",ne=t=>t.settings?.model==="holt_winters",Zt=t=>["holt","ewma","holt_winters"].includes(t.settings?.model||""),Q=t=>E[t.type].requiresField,Y=t=>E[t.type].isPipelineAgg,ie=t=>E[t.type].supportsMultipleBucketPaths,Xt=t=>E[t.type].supportsMissing,ye=t=>E[t.type].hasSettings,es=t=>E[t.type].hasMeta,je=t=>E[t.type].supportsInlineScript,ts=["count","avg","sum","min","max","extended_stats","percentiles","cardinality","raw_document","raw_data","logs","moving_avg","moving_fn","derivative","serial_diff","cumulative_sum","bucket_script","rate","top_metrics"],ss=t=>ts.includes(t),E={count:{label:"Count",requiresField:!1,isPipelineAgg:!1,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!1,hasMeta:!1,supportsInlineScript:!1,defaults:{}},avg:{label:"Average",requiresField:!0,supportsInlineScript:!0,supportsMissing:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,hasMeta:!1,defaults:{}},sum:{label:"Sum",requiresField:!0,supportsInlineScript:!0,supportsMissing:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,hasMeta:!1,defaults:{}},max:{label:"Max",requiresField:!0,supportsInlineScript:!0,supportsMissing:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,hasMeta:!1,defaults:{}},min:{label:"Min",requiresField:!0,supportsInlineScript:!0,supportsMissing:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,hasMeta:!1,defaults:{}},extended_stats:{label:"Extended Stats",requiresField:!0,supportsMissing:!0,supportsInlineScript:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,hasMeta:!0,defaults:{meta:{std_deviation_bounds_lower:!0,std_deviation_bounds_upper:!0}}},percentiles:{label:"Percentiles",requiresField:!0,supportsMissing:!0,supportsInlineScript:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,hasMeta:!1,defaults:{settings:{percents:["25","50","75","95","99"]}}},cardinality:{label:"Unique Count",requiresField:!0,supportsMissing:!0,isPipelineAgg:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{}},moving_avg:{label:"Moving Average",requiresField:!0,isPipelineAgg:!0,versionRange:"<8.0.0",supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{settings:{model:"simple",window:"5"}}},moving_fn:{label:"Moving Function",requiresField:!0,isPipelineAgg:!0,supportsMultipleBucketPaths:!1,supportsInlineScript:!1,supportsMissing:!1,hasMeta:!1,hasSettings:!0,defaults:{}},derivative:{label:"Derivative",requiresField:!0,isPipelineAgg:!0,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{}},serial_diff:{label:"Serial Difference",requiresField:!0,isPipelineAgg:!0,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{settings:{lag:"1"}}},cumulative_sum:{label:"Cumulative Sum",requiresField:!0,isPipelineAgg:!0,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{}},bucket_script:{label:"Bucket Script",requiresField:!1,isPipelineAgg:!0,supportsMissing:!1,supportsMultipleBucketPaths:!0,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{pipelineVariables:[We(ze([]))]}},raw_document:{label:"Raw Document (deprecated)",requiresField:!1,isSingleMetric:!0,isPipelineAgg:!1,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{settings:{size:"500"}}},raw_data:{label:"Raw Data",requiresField:!1,isSingleMetric:!0,isPipelineAgg:!1,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{settings:{size:"500"}}},logs:{label:"Logs",requiresField:!1,isPipelineAgg:!1,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,isSingleMetric:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{settings:{limit:"500"}}},top_metrics:{label:"Top Metrics",requiresField:!1,isPipelineAgg:!1,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!1,hasMeta:!1,defaults:{settings:{order:"desc"}}},rate:{label:"Rate",requiresField:!0,isPipelineAgg:!1,supportsMissing:!1,supportsMultipleBucketPaths:!1,hasSettings:!0,supportsInlineScript:!0,hasMeta:!1,defaults:{}}},ns={moving_avg:[{label:"window",default:5},{label:"model",default:"simple"},{label:"predict"},{label:"minimize",default:!1}],moving_fn:[{label:"window",default:5},{label:"script"}],derivative:[{label:"unit"}],serial_diff:[{label:"lag"}],cumulative_sum:[{label:"format"}],bucket_script:[]},qe=(t,e)=>{const s=e.filter(n=>ie(n)?n.pipelineVariables?.some(i=>i.pipelineAgg===t.id):Q(n)&&t.id===n.field);return[...s,...s.flatMap(n=>qe(n,e))]},ve=[{label:"Avg",value:"avg"},{label:"Min",value:"min"},{label:"Max",value:"max"},{label:"Sum",value:"sum"},{label:"Count",value:"count"},{label:"Std Dev",value:"std_deviation"},{label:"Std Dev Upper",value:"std_deviation_bounds_upper"},{label:"Std Dev Lower",value:"std_deviation_bounds_lower"}],is=[{label:"Simple",value:"simple"},{label:"Linear",value:"linear"},{label:"Exponentially Weighted",value:"ewma"},{label:"Holt Linear",value:"holt"},{label:"Holt Winters",value:"holt_winters"}],ae={pre:"@HIGHLIGHT@",post:"@/HIGHLIGHT@"};function re(t="1"){return{type:"count",id:t}}function le(t="1"){return{type:"date_histogram",id:t,settings:{interval:"auto"}}}const Ue=(t,e)=>t.find(s=>s.id===e);function be(t,e){return!!t?.metrics?.some(s=>s.type===e)}function as(t){return t in ns}function rs(t){return!!E[t].supportsMultipleBucketPaths}var Ee=m(5048);const z=t=>Q(t)?`${E[t.type].label} ${t.field}`:E[t.type].label,Se=t=>Object.entries(t).reduce((e,[s,n])=>{if(n==null)return{...e};if(Array.isArray(n)&&n.length===0)return{...e};if(typeof n=="string"&&n.length===0)return{...e};if(!Array.isArray(n)&&typeof n=="object"){const i=Se(n);return Object.keys(i).length===0?{...e}:{...e,[s]:i}}return{...e,[s]:n}},{}),Ge=t=>{const e=t.match(/^(\d+)/);return e?e[1]:void 0},K=t=>(typeof t.settings?.script=="object"?t.settings?.script?.inline:t.settings?.script)||"",Ye=t=>!!(0,Ee.gte)(t,"7.10.0"),Ke="Support for Elasticsearch versions after their end-of-life (currently versions < 7.10) was removed. Using unsupported version of Elasticsearch may lead to unexpected and incorrect results.";var S=m(62992);const Je=(0,S.PH)("@metrics/add"),Ze=(0,S.PH)("@metrics/remove"),Xe=(0,S.PH)("@metrics/toggle_visibility"),Fe=(0,S.PH)("@metrics/change_field"),Me=(0,S.PH)("@metrics/change_type"),et=(0,S.PH)("@metrics/change_attr"),x=(0,S.PH)("@metrics/change_setting"),tt=(0,S.PH)("@metrics/change_meta"),J=(0,S.PH)("init"),st=(0,S.PH)("change_query"),nt=(0,S.PH)("change_alias_pattern"),ls=(t,e)=>st.match(e)?e.payload:J.match(e)?t||"":t,os=(t,e)=>nt.match(e)?e.payload:J.match(e)?t||"":t;var xe=m(38306);const it=()=>({label:"",query:"*"}),F={terms:{label:"Terms",requiresField:!0,defaultSettings:{min_doc_count:"1",size:"10",order:"desc",orderBy:"_term"}},filters:{label:"Filters",requiresField:!1,defaultSettings:{filters:[it()]}},geohash_grid:{label:"Geo Hash Grid",requiresField:!0,defaultSettings:{precision:"3"}},date_histogram:{label:"Date Histogram",requiresField:!0,defaultSettings:{interval:"auto",min_doc_count:"0",trimEdges:"0",timeZone:xe.RQ.utc}},histogram:{label:"Histogram",requiresField:!0,defaultSettings:{interval:"1000",min_doc_count:"0"}},nested:{label:"Nested (experimental)",requiresField:!0,defaultSettings:{}}},at=[{label:"Term value",value:"_term"},{label:"Doc Count",value:"_count"}],Ie=[{label:"Top",value:"desc"},{label:"Bottom",value:"asc"}],cs=[{label:"No limit",value:"0"},{label:"1",value:"1"},{label:"2",value:"2"},{label:"3",value:"3"},{label:"5",value:"5"},{label:"10",value:"10"},{label:"15",value:"15"},{label:"20",value:"20"}],rt=(0,S.PH)("@bucketAggs/add"),lt=(0,S.PH)("@bucketAggs/remove"),ot=(0,S.PH)("@bucketAggs/change_type"),ct=(0,S.PH)("@bucketAggs/change_field"),w=(0,S.PH)("@bucketAggs/change_setting"),us=t=>(e,s)=>{if(rt.match(s)){const n={id:s.payload,type:"terms",settings:F.terms.defaultSettings},i=e[e.length-1];return i?.type==="date_histogram"?[...e.slice(0,e.length-1),n,i]:[...e,n]}return lt.match(s)?e.filter(n=>n.id!==s.payload):ot.match(s)?e.map(n=>n.id!==s.payload.id?n:{id:n.id,type:s.payload.newType,settings:F[s.payload.newType].defaultSettings}):ct.match(s)?e.map(n=>n.id!==s.payload.id?n:{...n,field:s.payload.newField}):Me.match(s)?E[s.payload.type].isSingleMetric?[]:e.length===0?[{...le("2"),field:t}]:e:w.match(s)?e.map(n=>{if(n.id!==s.payload.bucketAgg.id)return n;const i=Se({...n.settings,[s.payload.settingName]:s.payload.newValue});return{...n,settings:{...i}}}):J.match(s)?e?.length||0>0?e:[{...le("2"),field:t}]:e},ds=(t,e)=>{if(Je.match(e))return[...t,re(e.payload)];if(Ze.match(e)){const s=t.find(r=>r.id===e.payload),n=[s,...qe(s,t)],i=t.filter(r=>!n.some(l=>l.id===r.id));return i.length===0?[re("1")]:i}return Me.match(e)?t.filter(s=>E[e.payload.type].isSingleMetric?s.id===e.payload.id:!0).map(s=>s.id!==e.payload.id?s:{id:s.id,type:e.payload.type,...E[e.payload.type].defaults}):Fe.match(e)?t.map(s=>{if(s.id!==e.payload.id)return s;const n={...s,field:e.payload.field};return Y(s)?{...n,pipelineAgg:e.payload.field}:n}):Xe.match(e)?t.map(s=>s.id!==e.payload?s:{...s,hide:!s.hide}):x.match(e)?t.map(s=>{if(s.id!==e.payload.metric.id)return s;if(ye(s)){const n=Se({...s.settings,[e.payload.settingName]:e.payload.newValue});return{...s,settings:{...n}}}return s}):tt.match(e)?t.map(s=>s.id!==e.payload.metric.id?s:es(s)?{...s,meta:{...s.meta,[e.payload.meta]:e.payload.newValue}}:s):et.match(e)?t.map(s=>s.id!==e.payload.metric.id?s:{...s,[e.payload.attribute]:e.payload.newValue}):J.match(e)?t?.length||0>0?t:[re("1")]:t},ut=(0,a.createContext)(void 0),dt=(0,a.createContext)(void 0),gt=(0,a.createContext)(void 0),gs=({children:t,onChange:e,onRunQuery:s,query:n,datasource:i,range:r})=>{const l=(0,a.useCallback)(p=>{e(p),s()},[e,s]),u=Jt({query:ls,alias:os,metrics:ds,bucketAggs:us(i.timeField)}),c=fe(p=>l({...n,...p,timeField:i.timeField}),n,u),o=!n.metrics||!n.bucketAggs||n.query===void 0,[d,g]=(0,a.useState)(o);return(0,a.useEffect)(()=>{d&&(c(J()),g(!1))},[d,c]),o?null:a.createElement(ut.Provider,{value:i},a.createElement(dt.Provider,{value:n},a.createElement(gt.Provider,{value:r},a.createElement(Qe.Provider,{value:c},t))))},we=t=>()=>{const e=(0,a.useContext)(t);if(!e)throw new Error("use ElasticsearchProvider first.");return e},H=we(dt),mt=we(ut),ms=we(gt),pt=t=>t.id,ps=t=>parseInt(t,10),fs=()=>{const{metrics:t,bucketAggs:e}=H();return(0,a.useMemo)(()=>(Math.max(...[...t?.map(pt)||["0"],...e?.map(pt)||["0"]].map(ps))+1).toString(),[t,e])};var ft=m(39904);const hs=h.css`
  clip: rect(0 0 0 0);
  clip-path: inset(50%);
  height: 1px;
  overflow: hidden;
  position: absolute;
  white-space: nowrap;
  width: 1px;
`,oe=({iconName:t,onClick:e,className:s,label:n,...i})=>a.createElement("button",{className:(0,h.cx)("gf-form-label gf-form-label--btn query-part",s),onClick:e,...i},a.createElement("span",{className:hs},n),a.createElement(ft.J,{name:t,"aria-hidden":"true"}));var y=m(82897),ys=m(11543),ce=m(62157),ht=m(8180);const yt=({children:t,label:e,onRemoveClick:s,onHideClick:n,hidden:i=!1})=>{const r=(0,j.wW)(vs);return a.createElement(ys.Z,null,a.createElement(ce.m,null,a.createElement(pe.W,{width:17,as:"div"},a.createElement("span",null,e),a.createElement("span",{className:r.iconWrapper},n&&a.createElement(ht.h,{name:i?"eye-slash":"eye",onClick:n,size:"sm","aria-pressed":i,"aria-label":"hide metric",className:r.icon,type:"button"}),a.createElement(ht.h,{name:"trash-alt",size:"sm",className:r.icon,onClick:s||y.noop,disabled:!s,"aria-label":"remove metric",type:"button"})))),t)},vs=t=>({iconWrapper:h.css`
      display: flex;
    `,icon:h.css`
      color: ${t.colors.text.secondary};
      margin-left: ${t.spacing(.25)};
    `});var vt=m(70044),ue=m(68118),A=m(65583);const bt=t=>F[t.type].requiresField,bs=["date_histogram","histogram","terms","filters","geohash_grid","nested"],Es=t=>bs.includes(t),Ss=t=>{if(ss(t))switch(t){case"cardinality":return[];case"top_metrics":return["number"];default:return["number"]}if(Es(t))switch(t){case"date_histogram":return["date"];case"geohash_grid":return["geo_point"];case"histogram":return["number"];default:return[]}return[]},Fs=({text:t})=>({label:t,value:t}),de=t=>{const e=mt(),s=ms(),n=Array.isArray(t)?t:Ss(t);let i;return async r=>(i||(i=await(0,A.n)(e.getFields(n,s))),i.filter(({text:l})=>r===void 0||l.includes(r)).map(Fs))},q=h.css`
  min-width: 150px;
`,Ms=(t,e)=>({wrapper:h.css`
      max-width: 500px;
      display: flex;
      flex-direction: column;
    `,settingsWrapper:h.css`
      padding-top: ${t.spacing(.5)};
    `,icon:h.css`
      margin-right: ${t.spacing(.5)};
    `,button:h.css`
      justify-content: start;
      ${e&&h.css`
        color: ${t.colors.text.disabled};
      `}
    `}),Et=({label:t,children:e,hidden:s=!1})=>{const[n,i]=(0,a.useState)(!1),r=(0,j.l4)(),l=Ms(r,s);return a.createElement(ce.m,null,a.createElement("div",{className:(0,h.cx)(l.wrapper)},a.createElement("button",{className:(0,h.cx)("gf-form-label query-part",l.button,q),onClick:()=>i(!n),"aria-expanded":n,type:"button"},a.createElement(ft.J,{name:n?"angle-down":"angle-right","aria-hidden":"true",className:l.icon}),t),n&&a.createElement("div",{className:l.settingsWrapper},e)))};var k=m(53217),xs=m(52566);const Is=t=>({value:e})=>e===t,ws=(t,e)=>e===void 0||t.some(Is(e))?t:[...t,{value:e,label:e}],St=({options:t,value:e,onChange:s})=>{const[n,i]=(0,a.useState)(ws(t,e)),r=l=>i([...n,{value:l,label:l}]);return{onCreateOption:l=>{r(l),s({value:l})},onChange:s,allowCustomValue:!0,options:n,value:e}},Ps=[{label:"auto",value:"auto"},{label:"10s",value:"10s"},{label:"1m",value:"1m"},{label:"5m",value:"5m"},{label:"10m",value:"10m"},{label:"20m",value:"20m"},{label:"1h",value:"1h"},{label:"1d",value:"1d"}],Ts=t=>({value:e})=>e===t,Cs=(t,e,s)=>!s.some(Ts(t))&&t.trim().length>0,Ds=(t,e)=>t.value?.startsWith(e)||!1,Ns=({bucketAgg:t})=>{const e=T(),{current:s}=(0,a.useRef)((0,y.uniqueId)("es-date_histogram-")),n=({value:i})=>e(w({bucketAgg:t,settingName:"interval",newValue:i}));return a.createElement(a.Fragment,null,a.createElement(f._,{label:"Interval",...N},a.createElement(k.Ph,{inputId:(0,y.uniqueId)("es-date_histogram-interval"),isValidNewOption:Cs,filterOption:Ds,...St({options:Ps,value:t.settings?.interval||F.date_histogram.defaultSettings?.interval,onChange:n})})),a.createElement(f._,{label:"Min Doc Count",...N},a.createElement(b.I,{id:`${s}-min_doc_count`,onBlur:i=>e(w({bucketAgg:t,settingName:"min_doc_count",newValue:i.target.value})),defaultValue:t.settings?.min_doc_count||F.date_histogram.defaultSettings?.min_doc_count})),a.createElement(f._,{label:"Trim Edges",...N,tooltip:"Trim the edges on the timeseries datapoints"},a.createElement(b.I,{id:`${s}-trime_edges`,onBlur:i=>e(w({bucketAgg:t,settingName:"trimEdges",newValue:i.target.value})),defaultValue:t.settings?.trimEdges||F.date_histogram.defaultSettings?.trimEdges})),a.createElement(f._,{label:"Offset",...N,tooltip:"Change the start value of each bucket by the specified positive (+) or negative offset (-) duration, such as 1h for an hour, or 1d for a day"},a.createElement(b.I,{id:`${s}-offset`,onBlur:i=>e(w({bucketAgg:t,settingName:"offset",newValue:i.target.value})),defaultValue:t.settings?.offset||F.date_histogram.defaultSettings?.offset})),a.createElement(f._,{label:"Timezone",...N},a.createElement(xs.O,{value:t.settings?.timeZone||F.date_histogram.defaultSettings?.timeZone,includeInternal:[xe.RQ.utc],onChange:i=>{e(w({bucketAgg:t,settingName:"timeZone",newValue:i}))}})))},Ft=({index:t,onAdd:e,onRemove:s,elements:n})=>a.createElement("div",{className:h.css`
        display: flex;
      `},t===0&&a.createElement(oe,{iconName:"plus",onClick:e,label:"add"}),n.length>=2&&a.createElement(oe,{iconName:"minus",onClick:s,label:"remove"})),Pe=(0,S.PH)("@bucketAggregations/filter/add"),Mt=(0,S.PH)("@bucketAggregations/filter/remove"),Te=(0,S.PH)("@bucketAggregations/filter/change"),_s=(t=[],e)=>Pe.match(e)?[...t,it()]:Mt.match(e)?t.slice(0,e.payload).concat(t.slice(e.payload+1)):Te.match(e)?t.map((s,n)=>n!==e.payload.index?s:e.payload.filter):t,Vs=({bucketAgg:t})=>{const{current:e}=(0,a.useRef)((0,y.uniqueId)("es-filters-")),s=T(),n=fe(i=>s(w({bucketAgg:t,settingName:"filters",newValue:i})),t.settings?.filters,_s);return(0,a.useEffect)(()=>{t.settings?.filters?.length||n(Pe())},[n,t.settings?.filters?.length]),a.createElement(a.Fragment,null,a.createElement("div",{className:h.css`
          display: flex;
          flex-direction: column;
        `},t.settings?.filters.map((i,r)=>a.createElement("div",{key:r,className:h.css`
              display: flex;
            `},a.createElement(f._,{label:"Query",labelWidth:8},a.createElement("div",{className:h.css`
                  width: 150px;
                `},a.createElement(Re.q,{placeholder:"Lucene Query",portalOrigin:"elasticsearch",onBlur:()=>{},onChange:l=>n(Te({index:r,filter:{...i,query:l}})),query:i.query}))),a.createElement(f._,{label:"Label",labelWidth:8},a.createElement(b.I,{width:16,id:`${e}-label-${r}`,placeholder:"Label",onBlur:l=>n(Te({index:r,filter:{...i,label:l.target.value}})),defaultValue:i.label})),a.createElement(Ft,{index:r,elements:t.settings?.filters||[],onAdd:()=>n(Pe()),onRemove:()=>n(Mt(r))})))))},$s=({bucketAgg:t})=>{const{metrics:e}=H(),s=As(e),{current:n}=(0,a.useRef)((0,y.uniqueId)("es-terms-")),i=T();return a.createElement(a.Fragment,null,a.createElement(f._,{label:"Order",...N},a.createElement(k.Ph,{inputId:`${n}-order`,onChange:r=>i(w({bucketAgg:t,settingName:"order",newValue:r.value})),options:Ie,value:t.settings?.order||F.terms.defaultSettings?.order})),a.createElement(f._,{label:"Size",...N},a.createElement(k.Ph,{inputId:`${n}-size`,...St({options:cs,value:t.settings?.size||F.terms.defaultSettings?.size,onChange({value:r}){i(w({bucketAgg:t,settingName:"size",newValue:r}))}})})),a.createElement(f._,{label:"Min Doc Count",...N},a.createElement(b.I,{id:`${n}-min_doc_count`,onBlur:r=>i(w({bucketAgg:t,settingName:"min_doc_count",newValue:r.target.value})),defaultValue:t.settings?.min_doc_count||F.terms.defaultSettings?.min_doc_count})),a.createElement(f._,{label:"Order By",...N},a.createElement(k.Ph,{inputId:`${n}-order_by`,onChange:r=>i(w({bucketAgg:t,settingName:"orderBy",newValue:r.value})),options:s,value:t.settings?.orderBy||F.terms.defaultSettings?.orderBy})),a.createElement(f._,{label:"Missing",...N},a.createElement(b.I,{id:`${n}-missing`,onBlur:r=>i(w({bucketAgg:t,settingName:"missing",newValue:r.target.value})),defaultValue:t.settings?.missing||F.terms.defaultSettings?.missing})))};function Os(t){return t.meta?Object.keys(t.meta).filter(s=>t.meta?.[s]).map(s=>{let n=s;return s==="std_deviation_bounds_lower"&&(n="std_lower"),s==="std_deviation_bounds_upper"&&(n="std_upper"),{label:`${z(t)} (${n})`,value:`${t.id}[${n}]`}}):[]}function Bs(t){return t.settings?.percents?t.settings.percents.map(e=>{const s=/^\d+\.\d+/.test(`${e}`)?e:`${e}.0`;return{label:`${z(t)} (${e})`,value:`${t.id}[${s}]`}}):[]}function ks(t){return t.type!=="top_metrics"&&!Y(t)}const As=(t=[])=>{const e=t.filter(ks).flatMap(s=>s.type==="extended_stats"?Os(s):s.type==="percentiles"?Bs(s):{label:z(s),value:s.id});return[...at,...e]},xt=t=>e=>e.value===t,Ls=t=>{const{metrics:e}=H();switch(t.type){case"terms":{const s=t.settings?.order||"desc",n=t.settings?.size||"10",i=parseInt(t.settings?.min_doc_count||"0",10),r=t.settings?.orderBy||"_term";let l="";n!=="0"&&(l=`${Ie.find(xt(s))?.label} ${n}, `),i>0&&(l+=`Min Doc Count: ${i}, `),l+="Order by: ";const u=at.find(xt(r));if(u)l+=u.label;else{const c=e?.find(o=>o.id===Ge(r));c?l+=z(c):l+="metric not found"}return n==="0"&&(l+=` (${s})`),l}case"histogram":{const s=t.settings?.interval||1e3,n=t.settings?.min_doc_count||1;return`Interval: ${s}${n>0?`, Min Doc Count: ${n}`:""}`}case"filters":return`Filter Queries (${(t.settings?.filters||F.filters.defaultSettings?.filters).length})`;case"geohash_grid":return`Precision: ${Math.max(Math.min(parseInt(t.settings?.precision||"5",10),12),1)}`;case"date_histogram":{const s=t.settings?.interval||"auto",n=t.settings?.min_doc_count||0,i=t.settings?.trimEdges||0;let r=`Interval: ${s}`;return n>0&&(r+=`, Min Doc Count: ${n}`),i>0&&(r+=`, Trim edges: ${i}`),r}default:return"Settings"}},N={labelWidth:16},Rs=({bucketAgg:t})=>{const{current:e}=(0,a.useRef)((0,y.uniqueId)("es-setting-")),s=T(),n=Ls(t);return a.createElement(Et,{label:n},t.type==="terms"&&a.createElement($s,{bucketAgg:t}),t.type==="date_histogram"&&a.createElement(Ns,{bucketAgg:t}),t.type==="filters"&&a.createElement(Vs,{bucketAgg:t}),t.type==="geohash_grid"&&a.createElement(f._,{label:"Precision",...N},a.createElement(b.I,{id:`${e}-geohash_grid-precision`,onBlur:i=>s(w({bucketAgg:t,settingName:"precision",newValue:i.target.value})),defaultValue:t.settings?.precision||F[t.type].defaultSettings?.precision})),t.type==="histogram"&&a.createElement(a.Fragment,null,a.createElement(f._,{label:"Interval",...N},a.createElement(b.I,{id:`${e}-histogram-interval`,onBlur:i=>s(w({bucketAgg:t,settingName:"interval",newValue:i.target.value})),defaultValue:t.settings?.interval||F[t.type].defaultSettings?.interval})),a.createElement(f._,{label:"Min Doc Count",...N},a.createElement(b.I,{id:`${e}-histogram-min_doc_count`,onBlur:i=>s(w({bucketAgg:t,settingName:"min_doc_count",newValue:i.target.value})),defaultValue:t.settings?.min_doc_count||F[t.type].defaultSettings?.min_doc_count}))))},Qs=Object.entries(F).map(([t,{label:e}])=>({label:e,value:t})),Ws=t=>({label:F[t.type].label,value:t.type}),zs=({value:t})=>{const e=T(),s=de(t.type);return a.createElement(a.Fragment,null,a.createElement(ce.m,null,a.createElement(vt.X,{className:q,options:Qs,onChange:n=>e(ot({id:t.id,newType:n.value})),value:Ws(t)}),bt(t)&&a.createElement(ue.V,{className:q,loadOptions:s,onChange:n=>e(ct({id:t.id,newField:n.value})),placeholder:"Select Field",value:t.field})),a.createElement(Rs,{bucketAgg:t}))},Hs=({nextId:t})=>{const e=T(),{bucketAggs:s}=H(),n=s?.length||0;return a.createElement(a.Fragment,null,s.map((i,r)=>a.createElement(yt,{key:`${i.type}-${i.id}`,label:r===0?"Group By":"Then By",onRemoveClick:n>1&&(()=>e(lt(i.id)))},a.createElement(zs,{value:i}),r===0&&a.createElement(oe,{iconName:"plus",onClick:()=>e(rt(t)),label:"add"}))))},js=h.css`
  white-space: nowrap;
`,It=t=>({label:z(t),value:t}),qs=t=>t.map(It),wt=({options:t,onChange:e,className:s,value:n})=>{const i=t.find(r=>r.id===n);return a.createElement(vt.X,{className:(0,h.cx)(s,js),options:qs(t),onChange:e,placeholder:"Select Metric",value:i?It(i):void 0})};var Z=m(8944);function C({label:t,settingName:e,metric:s,placeholder:n,tooltip:i}){const r=T(),[l]=(0,a.useState)((0,y.uniqueId)("es-field-id-"));let c=s.settings?.[e]||"";return e==="script"&&(c=K(s)),a.createElement(f._,{label:t,labelWidth:16,tooltip:i},a.createElement(b.I,{id:l,placeholder:n,onBlur:o=>r(x({metric:s,settingName:e,newValue:o.target.value})),defaultValue:c}))}const Ce=(0,S.PH)("@pipelineVariables/add"),Pt=(0,S.PH)("@pipelineVariables/remove"),Tt=(0,S.PH)("@pipelineVariables/rename"),Ct=(0,S.PH)("@pipelineVariables/change_metric"),Us=(t=[],e)=>Ce.match(e)?[...t,We(ze(t))]:Pt.match(e)?t.slice(0,e.payload).concat(t.slice(e.payload+1)):Tt.match(e)?t.map((s,n)=>n!==e.payload.index?s:{...s,name:e.payload.newName}):Ct.match(e)?t.map((s,n)=>n!==e.payload.index?s:{...s,pipelineAgg:e.payload.newMetric}):t,Gs=({value:t,previousMetrics:e})=>{const s=T(),n=fe(i=>s(et({metric:t,attribute:"pipelineVariables",newValue:i})),t.pipelineVariables,Us);return(0,a.useEffect)(()=>{t.pipelineVariables?.length||n(Ce())},[n,t.pipelineVariables?.length]),a.createElement(a.Fragment,null,a.createElement("div",{className:h.css`
          display: flex;
        `},a.createElement(pe.W,{width:16},"Variables"),a.createElement("div",{className:h.css`
            display: grid;
            grid-template-columns: 1fr auto;
            row-gap: 4px;
            margin-bottom: 4px;
          `},t.pipelineVariables.map((i,r)=>a.createElement(a.Fragment,{key:(0,y.uniqueId)("es-bs-")},a.createElement("div",{className:h.css`
                  display: grid;
                  column-gap: 4px;
                  grid-template-columns: auto auto;
                `},a.createElement(b.I,{"aria-label":"Variable name",defaultValue:i.name,placeholder:"Variable Name",onBlur:l=>n(Tt({newName:l.target.value,index:r}))}),a.createElement(wt,{onChange:l=>n(Ct({newMetric:l.value.id,index:r})),options:e,value:i.pipelineAgg})),a.createElement(Ft,{index:r,elements:t.pipelineVariables||[],onAdd:()=>n(Ce()),onRemove:()=>n(Pt(r))}))))),a.createElement(C,{label:"Script",metric:t,settingName:"script",tooltip:"Elasticsearch v5.0 and above: Scripting language is Painless. Use params.<var> to reference a variable. Elasticsearch pre-v5.0: Scripting language is per default Groovy if not changed. For Groovy use <var> to reference a variable.",placeholder:"params.var1 / params.var2"}))},Ys=({metric:t})=>{const e=T(),{current:s}=(0,a.useRef)((0,y.uniqueId)("es-moving-avg-"));return a.createElement(a.Fragment,null,a.createElement(f._,{label:"Model",labelWidth:16},a.createElement(k.Ph,{inputId:`${s}-model`,onChange:n=>e(x({metric:t,settingName:"model",newValue:n.value})),options:is,value:t.settings?.model})),a.createElement(C,{label:"Window",settingName:"window",metric:t,placeholder:"5"}),a.createElement(C,{label:"Predict",settingName:"predict",metric:t}),(He(t)||he(t)||ne(t))&&a.createElement(f._,{label:"Alpha",labelWidth:16},a.createElement(b.I,{id:`${s}-alpha`,onBlur:n=>e(x({metric:t,settingName:"settings",newValue:{...t.settings?.settings,alpha:n.target.value}})),defaultValue:t.settings?.settings?.alpha})),(he(t)||ne(t))&&a.createElement(f._,{label:"Beta",labelWidth:16},a.createElement(b.I,{id:`${s}-beta`,onBlur:n=>e(x({metric:t,settingName:"settings",newValue:{...t.settings?.settings,beta:n.target.value}})),defaultValue:t.settings?.settings?.beta})),ne(t)&&a.createElement(a.Fragment,null,a.createElement(f._,{label:"Gamma",labelWidth:16},a.createElement(b.I,{id:`${s}-gamma`,onBlur:n=>e(x({metric:t,settingName:"settings",newValue:{...t.settings?.settings,gamma:n.target.value}})),defaultValue:t.settings?.settings?.gamma})),a.createElement(f._,{label:"Period",labelWidth:16},a.createElement(b.I,{id:`${s}-period`,onBlur:n=>e(x({metric:t,settingName:"settings",newValue:{...t.settings?.settings,period:n.target.value}})),defaultValue:t.settings?.settings?.period})),a.createElement(f._,{label:"Pad",labelWidth:16},a.createElement(Z.x,{id:`${s}-pad`,onChange:n=>e(x({metric:t,settingName:"settings",newValue:{...t.settings?.settings,pad:n.target.checked}})),checked:!!t.settings?.settings?.pad}))),(He(t)||he(t)||ne(t))&&a.createElement(f._,{label:"Minimize",labelWidth:16},a.createElement(Z.x,{id:`${s}-minimize`,onChange:n=>e(x({metric:t,settingName:"minimize",newValue:n.target.checked})),checked:!!t.settings?.minimize})))},Ks=t=>({value:t,label:t}),Js=({metric:t})=>{const e=T(),s=de(["number","date"]),n=de(t.type);return a.createElement(a.Fragment,null,a.createElement(f._,{label:"Metrics",labelWidth:16},a.createElement(k.M8,{onChange:i=>e(x({metric:t,settingName:"metrics",newValue:i.map(r=>r.value)})),loadOptions:n,value:t.settings?.metrics?.map(Ks),closeMenuOnSelect:!1,defaultOptions:!0})),a.createElement(f._,{label:"Order",labelWidth:16},a.createElement(k.Ph,{onChange:i=>e(x({metric:t,settingName:"order",newValue:i.value})),options:Ie,value:t.settings?.order})),a.createElement(f._,{label:"Order By",labelWidth:16,className:h.css`
          & > div {
            width: 100%;
          }
        `},a.createElement(ue.V,{className:h.css`
            margin-right: 0;
          `,loadOptions:s,onChange:i=>e(x({metric:t,settingName:"orderBy",newValue:i.value})),placeholder:"Select Field",value:t.settings?.orderBy})))},Zs=t=>e=>e.value===t,Xs=t=>{switch(t.type){case"cardinality":return`Precision threshold: ${t.settings?.precision_threshold||""}`;case"percentiles":return t.settings?.percents&&t.settings?.percents?.length>=1?`Values: ${t.settings?.percents}`:"Percents: Default";case"extended_stats":{const e=Object.entries(t.meta||{}).map(([s,n])=>n&&ve.find(Zs(s))?.label).filter(Boolean);return`Stats: ${e.length>0?e.join(", "):"None selected"}`}case"raw_document":case"raw_data":return`Size: ${t.settings?.size||500}`;default:return"Options"}},X={labelWidth:16},en=({metric:t,previousMetrics:e})=>{const{current:s}=(0,a.useRef)((0,y.uniqueId)("es-setting-")),n=T(),i=Xs(t),r=H(),l=[{value:"second",label:"Second"},{value:"minute",label:"Minute"},{value:"hour",label:"Hour"},{value:"day",label:"Day"},{value:"week",label:"Week"},{value:"month",label:"Month"},{value:"quarter",label:"Quarter"},{value:"Year",label:"Year"}],u=[{value:"sum",label:"Sum"},{value:"value_count",label:"Value count"}];return a.createElement(Et,{label:i,hidden:t.hide},t.type==="derivative"&&a.createElement(C,{label:"Unit",metric:t,settingName:"unit"}),t.type==="serial_diff"&&a.createElement(C,{label:"Lag",metric:t,settingName:"lag",placeholder:"1"}),t.type==="cumulative_sum"&&a.createElement(C,{label:"Format",metric:t,settingName:"format"}),t.type==="moving_avg"&&a.createElement(Ys,{metric:t}),t.type==="moving_fn"&&a.createElement(a.Fragment,null,a.createElement(C,{label:"Window",metric:t,settingName:"window"}),a.createElement(C,{label:"Script",metric:t,settingName:"script"}),a.createElement(C,{label:"Shift",metric:t,settingName:"shift"})),t.type==="top_metrics"&&a.createElement(Js,{metric:t}),t.type==="bucket_script"&&a.createElement(Gs,{value:t,previousMetrics:e}),(t.type==="raw_data"||t.type==="raw_document")&&a.createElement(f._,{label:"Size",...X},a.createElement(b.I,{id:`ES-query-${r.refId}_metric-${t.id}-size`,onBlur:c=>n(x({metric:t,settingName:"size",newValue:c.target.value})),defaultValue:t.settings?.size??E.raw_data.defaults.settings?.size})),t.type==="logs"&&a.createElement(C,{label:"Limit",metric:t,settingName:"limit",placeholder:"500"}),t.type==="cardinality"&&a.createElement(C,{label:"Precision Threshold",metric:t,settingName:"precision_threshold"}),t.type==="extended_stats"&&a.createElement(a.Fragment,null,ve.map(c=>a.createElement(tn,{key:c.value,stat:c,onChange:o=>n(tt({metric:t,meta:c.value,newValue:o})),value:t.meta?.[c.value]!==void 0?!!t.meta?.[c.value]:!!E.extended_stats.defaults.meta?.[c.value]})),a.createElement(C,{label:"Sigma",metric:t,settingName:"sigma",placeholder:"3"})),t.type==="percentiles"&&a.createElement(f._,{label:"Percentiles",...X},a.createElement(b.I,{id:`${s}-percentiles-percents`,onBlur:c=>n(x({metric:t,settingName:"percents",newValue:c.target.value.split(",").filter(Boolean)})),defaultValue:t.settings?.percents||E.percentiles.defaults.settings?.percents,placeholder:"1,5,25,50,75,95,99"})),t.type==="rate"&&a.createElement(a.Fragment,null,a.createElement(f._,{label:"Unit",...X,"data-testid":"unit-select"},a.createElement(k.Ph,{id:`ES-query-${r.refId}_metric-${t.id}-unit`,onChange:c=>n(x({metric:t,settingName:"unit",newValue:c.value})),options:l,value:t.settings?.unit})),a.createElement(f._,{label:"Mode",...X,"data-testid":"mode-select"},a.createElement(k.Ph,{id:`ES-query-${r.refId}_metric-${t.id}-mode`,onChange:c=>n(x({metric:t,settingName:"mode",newValue:c.value})),options:u,value:t.settings?.unit}))),je(t)&&a.createElement(C,{label:"Script",metric:t,settingName:"script",placeholder:"_value * 1"}),Xt(t)&&a.createElement(C,{label:"Missing",metric:t,settingName:"missing",tooltip:`The missing parameter defines how documents that are missing a value should be treated. By default
            they will be ignored but it is also possible to treat them as if they had a value`}))},tn=({stat:t,onChange:e,value:s})=>{const[n]=(0,a.useState)((0,y.uniqueId)("es-field-id-"));return a.createElement(f._,{label:t.label,...X,key:t.value},a.createElement(Z.x,{id:n,onChange:i=>e(i.target.checked),value:s}))},sn=(t,e)=>({color:e&&h.css`
        &,
        &:hover,
        label,
        a {
          color: ${e?t.colors.text.disabled:t.colors.text.primary};
        }
      `}),nn=t=>({label:E[t.type].label,value:t.type}),an=t=>!E[t.type].isPipelineAgg,rn=(t,e)=>{const s=t.some(an);return Object.entries(E).filter(([n,{versionRange:i="*"}])=>e!=null?(0,Ee.satisfies)(e,i):!0).filter(([n,i])=>s||!i.isPipelineAgg).map(([n,{label:i}])=>({label:i,value:n}))},ln=({value:t})=>{const e=sn((0,j.l4)(),!!t.hide),s=mt(),n=H(),i=T(),r=de(t.type),l=async o=>{const d=await s.getDatabaseVersion();return rn(o,d)},u=(0,a.useCallback)(async()=>{const o=await r();return je(t)?[{label:"None"},...o]:o},[r,t]),c=n.metrics.slice(0,n.metrics.findIndex(o=>o.id===t.id));return a.createElement(a.Fragment,null,a.createElement(ce.m,null,a.createElement(ue.V,{className:(0,h.cx)(e.color,q),loadOptions:()=>l(c),onChange:o=>i(Me({id:t.id,type:o.value})),value:nn(t)}),Q(t)&&!Y(t)&&a.createElement(ue.V,{className:(0,h.cx)(e.color,q),loadOptions:u,onChange:o=>i(Fe({id:t.id,field:o.value})),placeholder:"Select Field",value:t.field}),Y(t)&&!ie(t)&&a.createElement(wt,{className:(0,h.cx)(e.color,q),onChange:o=>i(Fe({id:t.id,field:o.value?.id})),options:c,value:t.field})),ye(t)&&a.createElement(en,{metric:t,previousMetrics:c}))},on=({nextId:t})=>{const e=T(),{metrics:s}=H(),n=s?.length||0;return a.createElement(a.Fragment,null,s?.map((i,r)=>a.createElement(yt,{key:`${i.type}-${i.id}`,label:`Metric (${i.id})`,hidden:i.hide,onHideClick:()=>e(Xe(i.id)),onRemoveClick:n>1&&(()=>e(Ze(i.id)))},a.createElement(ln,{value:i}),!E[i.type].isSingleMetric&&r===0&&a.createElement(oe,{iconName:"plus",onClick:()=>e(Je(t)),label:"add"}))))};function cn(t){const[e,s]=(0,a.useState)(null);return(0,a.useEffect)(()=>{let n=!1;return t.getDatabaseVersion().then(i=>{n||s(i)},i=>{console.log(i)}),()=>{n=!0}},[t]),e}const un=({query:t,onChange:e,onRunQuery:s,datasource:n,range:i})=>{const r=cn(n),l=r!=null&&!Ye(r);return a.createElement(gs,{datasource:n,onChange:e,onRunQuery:s,query:t,range:i||(0,me.JK)()},l&&a.createElement(Le.b,{title:Ke}),a.createElement(dn,{value:t}))},Dt=t=>({root:h.css`
    display: flex;
  `,queryFieldWrapper:h.css`
    flex-grow: 1;
    margin: 0 ${t.spacing(.5)} ${t.spacing(.5)} 0;
  `}),Nt=({value:t,onChange:e})=>{const s=(0,j.wW)(Dt);return a.createElement("div",{className:s.queryFieldWrapper},a.createElement(Re.q,{query:t,onBlur:()=>{},onChange:e,placeholder:"Lucene Query",portalOrigin:"elasticsearch"}))},dn=({value:t})=>{const e=T(),s=fs(),n=(0,j.wW)(Dt),i=t?.bucketAggs?.slice(-1)[0]?.type==="date_histogram",r=t.metrics?.every(l=>!E[l.type].isSingleMetric);return a.createElement(a.Fragment,null,a.createElement("div",{className:n.root},a.createElement(pe.W,{width:17},"Query"),a.createElement(Nt,{onChange:l=>e(st(l)),value:t?.query}),a.createElement(f._,{label:"Alias",labelWidth:15,disabled:!i,tooltip:"Aliasing only works for timeseries queries (when the last group is 'Date Histogram'). For all other query types this field is ignored."},a.createElement(b.I,{id:`ES-query-${t.refId}_alias`,placeholder:"Alias Pattern",onBlur:l=>e(nt(l.currentTarget.value)),defaultValue:t.alias}))),a.createElement(on,{nextId:s}),r&&a.createElement(Hs,{nextId:s}))};var gn=m(4761),mn=m(12006),pn=m(12580),_t=m(47694),fn=m(89029),hn=m(28151),Vt=m(31403),yn=m(54291),vn=m(53117),bn=m(14835),En=m(7804),Sn=m(35919);const{FormField:De,Switch:Fn}=bn.LegacyForms,Mn=(0,En.B)(()=>({firstRow:h.css`
    display: flex;
  `,nameField:h.css`
    flex: 2;
  `,regexField:h.css`
    flex: 3;
  `,row:h.css`
    display: flex;
    align-items: baseline;
  `,urlField:h.css`
    flex: 1;
  `,urlDisplayLabelField:h.css`
    flex: 1;
  `})),xn=t=>{const{value:e,onChange:s,onDelete:n,suggestions:i,className:r}=t,l=Mn(),[u,c]=In(e.datasourceUid),o=d=>g=>{s({...e,[d]:g.currentTarget.value})};return a.createElement("div",{className:r},a.createElement("div",{className:l.firstRow+" gf-form"},a.createElement(De,{className:l.nameField,labelWidth:6,inputWidth:null,label:"Field",type:"text",value:e.field,tooltip:"Can be exact field name or a regex pattern that will match on the field name.",onChange:o("field")}),a.createElement(Vt.zx,{variant:"destructive",title:"Remove field",icon:"times",onClick:d=>{d.preventDefault(),n()}})),a.createElement("div",{className:"gf-form"},a.createElement(De,{label:u?"Query":"URL",labelWidth:6,inputEl:a.createElement(Sn.v,{placeholder:u?"${__value.raw}":"http://example.com/${__value.raw}",value:e.url||"",onChange:d=>s({...e,url:d}),suggestions:i}),className:l.urlField}),a.createElement(De,{className:l.urlDisplayLabelField,inputWidth:null,label:"URL Label",type:"text",value:e.urlDisplayLabel,onChange:o("urlDisplayLabel"),tooltip:"Use to override the button label."})),a.createElement("div",{className:l.row},a.createElement(Fn,{labelClass:"width-6",label:"Internal link",checked:u,onChange:()=>{u&&s({...e,datasourceUid:void 0}),c(!u)}}),u&&a.createElement(vn.q,{tracing:!0,onChange:d=>{s({...e,datasourceUid:d.uid})},current:e.datasourceUid})))};function In(t){const[e,s]=(0,a.useState)(!!t),n=(0,yn.Z)(t);return(0,a.useEffect)(()=>{!n&&t&&!e&&s(!0),n&&!t&&e&&s(!1)},[n,t,e]),[e,s]}const wn=t=>({infoText:h.css`
      padding-bottom: ${t.spacing(2)};
      color: ${t.colors.text.secondary};
    `,dataLink:h.css`
      margin-bottom: ${t.spacing(1)};
    `}),Pn=t=>{const{value:e,onChange:s}=t,n=(0,j.wW)(wn);return a.createElement(a.Fragment,null,a.createElement("h3",{className:"page-heading"},"Data links"),a.createElement("div",{className:n.infoText},"Add links to existing fields. Links will be shown in log row details next to the field value."),e&&e.length>0&&a.createElement("div",{className:"gf-form-group"},e.map((i,r)=>a.createElement(xn,{className:n.dataLink,key:r,value:i,onChange:l=>{const u=[...e];u.splice(r,1,l),s(u)},onDelete:()=>{const l=[...e];l.splice(r,1),s(l)},suggestions:[{value:fn.W.valueRaw,label:"Raw value",documentation:"Raw value of the field",origin:hn.L8.Value}]}))),a.createElement(Vt.zx,{type:"button",variant:"secondary",className:h.css`
          margin-right: 10px;
        `,icon:"plus",onClick:i=>{i.preventDefault();const r=[...e||[],{field:"",url:""}];s(r)}},"Add"))};var $t=m(13393);const Ne=[{label:"No pattern",value:"none"},{label:"Hourly",value:"Hourly",example:"[logstash-]YYYY.MM.DD.HH"},{label:"Daily",value:"Daily",example:"[logstash-]YYYY.MM.DD"},{label:"Weekly",value:"Weekly",example:"[logstash-]GGGG.WW"},{label:"Monthly",value:"Monthly",example:"[logstash-]YYYY.MM"},{label:"Yearly",value:"Yearly",example:"[logstash-]YYYY"}],Tn=({value:t,onChange:e})=>a.createElement(a.Fragment,null,a.createElement($t.C,{label:"Elasticsearch details"},a.createElement(f._,{label:"Index name",labelWidth:26},a.createElement(b.I,{id:"es_config_indexName",value:t.database||"",onChange:Cn("database",t,e),width:24,placeholder:"es-index-name",required:!0})),a.createElement(f._,{label:"Pattern",labelWidth:26},a.createElement(k.Ph,{inputId:"es_config_indexPattern",value:Ne.find(s=>s.value===(t.jsonData.interval===void 0?"none":t.jsonData.interval)),options:Ne,onChange:Dn(t,e),width:24})),a.createElement(f._,{label:"Time field name",labelWidth:26},a.createElement(b.I,{id:"es_config_timeField",value:t.jsonData.timeField||"",onChange:_e("timeField",t,e),width:24,placeholder:"@timestamp",required:!0})),a.createElement(f._,{label:"Max concurrent Shard Requests",labelWidth:26},a.createElement(b.I,{id:"es_config_shardRequests",value:t.jsonData.maxConcurrentShardRequests||"",onChange:_e("maxConcurrentShardRequests",t,e),width:24})),a.createElement(f._,{label:"Min time interval",labelWidth:26,tooltip:a.createElement(a.Fragment,null,"A lower limit for the auto group by time interval. Recommended to be set to write frequency, for example"," ",a.createElement("code",null,"1m")," if your data is written every minute."),error:"Value is not valid, you can use number with time unit specifier: y, M, w, d, h, m, s",invalid:!!t.jsonData.timeInterval&&!/^\d+(ms|[Mwdhmsy])$/.test(t.jsonData.timeInterval)},a.createElement(b.I,{id:"es_config_minTimeInterval",value:t.jsonData.timeInterval||"",onChange:_e("timeInterval",t,e),width:24,placeholder:"10s"})),a.createElement(f._,{label:"X-Pack enabled",labelWidth:26},a.createElement(Z.x,{id:"es_config_xpackEnabled",value:t.jsonData.xpack||!1,onChange:Ot("xpack",t,e)})),t.jsonData.xpack&&a.createElement(f._,{label:"Include Frozen Indices",labelWidth:26},a.createElement(Z.x,{id:"es_config_frozenIndices",value:t.jsonData.includeFrozen??!1,onChange:Ot("includeFrozen",t,e)})))),Cn=(t,e,s)=>n=>{s({...e,[t]:n.currentTarget.value})},_e=(t,e,s)=>n=>{s({...e,jsonData:{...e.jsonData,[t]:n.currentTarget.value}})},Ot=(t,e,s)=>n=>{s({...e,jsonData:{...e.jsonData,[t]:n.currentTarget.checked}})},Dn=(t,e)=>s=>{const{database:n}=t,i=s.value==="none"?void 0:s.value;if(!n||n.length===0||n.startsWith("[logstash-]")){let r="";if(i!==void 0){const l=Ne.find(u=>u.value===i);l&&(r=l.example??"")}e({...t,database:r,jsonData:{...t.jsonData,interval:i}})}else e({...t,jsonData:{...t.jsonData,interval:i}})};function Nn(){return 5}const _n=t=>{const{value:e,onChange:s}=t,n=i=>r=>{s({...e,[i]:r.currentTarget.value})};return a.createElement($t.C,{label:"Logs"},a.createElement(f._,{label:"Message field name",labelWidth:22},a.createElement(b.I,{id:"es_logs-config_logMessageField",value:e.logMessageField,onChange:n("logMessageField"),placeholder:"_source",width:24})),a.createElement(f._,{label:"Level field name",labelWidth:22},a.createElement(b.I,{id:"es_logs-config_logLevelField",value:e.logLevelField,onChange:n("logLevelField"),width:24})))},Bt=t=>({...t,jsonData:{...t.jsonData,timeField:t.jsonData.timeField||"@timestamp",maxConcurrentShardRequests:t.jsonData.maxConcurrentShardRequests||Nn(),logMessageField:t.jsonData.logMessageField||"",logLevelField:t.jsonData.logLevelField||"",includeFrozen:t.jsonData.includeFrozen??!1}}),Vn=t=>!!t.jsonData.timeField&&!!t.jsonData.maxConcurrentShardRequests&&t.jsonData.logMessageField!==void 0&&t.jsonData.logLevelField!==void 0,$n=t=>{const e=(0,a.useRef)(t.options.access==="direct"),{options:s,onOptionsChange:n}=t,i=Bt(s);return(0,a.useEffect)(()=>{Vn(s)||n(Bt(s))},[]),a.createElement(a.Fragment,null,i.access==="direct"&&a.createElement(Le.b,{title:"Error",severity:"error"},"Browser access mode in the Elasticsearch datasource is no longer available. Switch to server access mode."),a.createElement(mn.E,{defaultUrl:"http://localhost:9200",dataSourceConfig:i,showAccessOptions:e.current,onChange:n,sigV4AuthToggleEnabled:_t.vc.sigV4AuthEnabled,renderSigV4Editor:a.createElement(gn.IW,{...t})}),_t.vc.featureToggles.secureSocksDatasourceProxy&&a.createElement(pn.i,{options:i,onOptionsChange:n}),a.createElement(Tn,{value:i,onChange:n}),a.createElement(_n,{value:i.jsonData,onChange:r=>n({...i,jsonData:r})}),a.createElement(Pn,{value:i.jsonData.dataLinks,onChange:r=>{n({...i,jsonData:{...i.jsonData,dataLinks:r}})}}))};var Ve=m(85850),On=m(97212),U=m(59980),G=m(9471),$e=m(59724),kt=m(39859),Bn=m(89027),kn=m(29933),An=m(31129),At=m(71735),L=m(46519),ee=m(90595),Oe=m(40400),Ln=m(22069),Rn=m(54899),Lt=m(35645),Qn=m(86647),Wn=m(37959),zn=m(19349),Hn=m(58155),jn=m(81042),Be=m(16911),W=m(14582),qn=m(38685),Un=m(2932),Rt=m(37219),Gn=m(40229);const Qt=`${ae.pre}([^@]+)${ae.post}`;class Wt{constructor(e,s){this.targets=e,this.response=s,this.processResponseToSeries=()=>{const n=[];for(let i=0;i<this.response.responses.length;i++){const r=this.response.responses[i],l=this.targets[i];if(r.error)throw this.getErrorFromElasticResponse(this.response,r.error);if(r.hits&&r.hits.hits.length>0&&this.processHits(r.hits,n,l),r.aggregations){const u=r.aggregations,c=this.targets[i],o=[],d=new Rt.Z;d.refId=c.refId,this.processBuckets(u,c,o,d,{},0),this.trimDatapoints(o,c),this.nameSeries(o,c);for(let g=0;g<o.length;g++)n.push(o[g]);d.rows.length>0&&n.push(d)}}return{data:n}},this.targets=e,this.response=s}processMetrics(e,s,n,i){let r;for(let l=0;l<s.metrics.length;l++){const u=s.metrics[l];if(!u.hide)switch(u.type){case"count":{r={datapoints:[],metric:"count",props:i,refId:s.refId};for(let c=0;c<e.buckets.length;c++){const o=e.buckets[c],d=o.doc_count;r.datapoints.push([d,o.key])}n.push(r);break}case"percentiles":{if(e.buckets.length===0)break;const o=e.buckets[0][u.id].values;for(const d in o){r={datapoints:[],metric:"p"+d,props:i,field:u.field,refId:s.refId};for(let g=0;g<e.buckets.length;g++){const p=e.buckets[g],v=p[u.id].values;r.datapoints.push([v[d],p.key])}n.push(r)}break}case"extended_stats":{for(const c in u.meta)if(u.meta[c]){r={datapoints:[],metric:c,props:i,field:u.field,refId:s.refId};for(let o=0;o<e.buckets.length;o++){const d=e.buckets[o],g=d[u.id];g.std_deviation_bounds_upper=g.std_deviation_bounds.upper,g.std_deviation_bounds_lower=g.std_deviation_bounds.lower,r.datapoints.push([g[c],d.key])}n.push(r)}break}case"top_metrics":{if(u.settings?.metrics?.length)for(const c of u.settings?.metrics){r={datapoints:[],metric:u.type,props:i,refId:s.refId,field:c};for(let o=0;o<e.buckets.length;o++){const d=e.buckets[o],p=d[u.id].top.map(I=>I.metrics[c]?I.metrics[c]:null),v=[p[p.length-1],d.key];r.datapoints.push(v)}n.push(r)}break}default:{r={datapoints:[],metric:u.type,metricId:u.id,props:i,refId:s.refId},Q(u)&&(r.field=u.field);for(let c=0;c<e.buckets.length;c++){const o=e.buckets[c],d=o[u.id];d!==void 0&&(d.normalized_value?r.datapoints.push([d.normalized_value,o.key]):r.datapoints.push([d.value,o.key]))}n.push(r);break}}}}processAggregationDocs(e,s,n,i,r){if(i.columns.length===0){for(const c of(0,y.keys)(r))i.addColumn({text:c,filterable:!0});i.addColumn({text:s.field,filterable:!0})}const l=(c,o,d)=>{i.addColumn({text:o}),c.push(d)},u=(0,y.isArray)(e.buckets)?e.buckets:[e.buckets];for(const c of u){const o=[];for(const d of(0,y.values)(r))o.push(d);o.push(c.key);for(const d of n.metrics||[])switch(d.type){case"count":{l(o,this.getMetricName(d.type),c.doc_count);break}case"extended_stats":{for(const g in d.meta){if(!d.meta[g])continue;const p=c[d.id];p.std_deviation_bounds_upper=p.std_deviation_bounds.upper,p.std_deviation_bounds_lower=p.std_deviation_bounds.lower,l(o,this.getMetricName(g),p[g])}break}case"percentiles":{const g=c[d.id].values;for(const p in g)l(o,`p${p} ${d.field}`,g[p]);break}case"top_metrics":{const g=this.getMetricName(d.type);if(d.settings?.metrics)for(const p of d.settings.metrics){const v=d.settings.metrics.length>1?`${g} ${p}`:g,I=c[d.id];l(o,v,I.top[0].metrics[p])}break}default:{let g=this.getMetricName(d.type);(0,y.filter)(n.metrics,{type:d.type}).length>1&&(Q(d)&&(g+=" "+d.field),d.type==="bucket_script"&&(g=K(d))),l(o,g,c[d.id].value);break}}i.rows.push(o)}}processBuckets(e,s,n,i,r,l){let u,c,o,d;const g=s.bucketAggs.length-1;for(d in e)if(c=(0,y.find)(s.bucketAggs,{id:d}),o=e[d],!!c){if(c.type==="nested"){this.processBuckets(o,s,n,i,r,l+1);continue}if(l===g)c.type==="date_histogram"?this.processMetrics(o,s,n,r):this.processAggregationDocs(o,c,s,i,r);else for(const p in o.buckets)u=o.buckets[p],r=(0,y.clone)(r),u.key!==void 0?r[c.field]=u.key:r.filter=p,u.key_as_string&&(r[c.field]=u.key_as_string),this.processBuckets(u,s,n,i,r,l+1)}}getMetricName(e){const s=Object.entries(E).filter(([i])=>i===e).map(([i,r])=>r)[0];if(s)return s.label;const n=ve.find(i=>i.value===e);return n?n.label:e}getSeriesName(e,s,n){let i=this.getMetricName(e.metric);if(s.alias){const u=/\{\{([\s\S]+?)\}\}/g;return s.alias.replace(u,(c,o,d)=>{const g=o||d;return g.indexOf("term ")===0?e.props[g.substring(5)]:e.props[g]!==void 0?e.props[g]:g==="metric"?i:g==="field"?e.field||"":c})}if(as(e.metric))if(e.metric&&rs(e.metric)){const u=(0,y.find)(s.metrics,{id:e.metricId});if(u&&u.settings.script){i=K(u);for(const c of u.pipelineVariables){const o=(0,y.find)(s.metrics,{id:c.pipelineAgg});o&&(i=i.replace("params."+c.name,z(o)))}}else i="Unset"}else{const u=(0,y.find)(s.metrics,{id:e.field});u?i+=" "+z(u):i="Unset"}else e.field&&(i+=" "+e.field);if((0,y.keys)(e.props).length===0)return i;let l="";for(const u in e.props)l+=e.props[u]+" ";return n?l.trim()+" "+i:l.trim()}nameSeries(e,s){const n=(0,y.uniq)((0,y.map)(e,"metric")).length,i=(s.metrics?.filter(r=>r.type==="top_metrics")).some(r=>(r?.settings?.metrics?.length||0)>1);for(let r=0;r<e.length;r++){const l=e[r];l.target=this.getSeriesName(l,s,n>1||i)}}processHits(e,s,n){const i=typeof e.total=="number"?e.total:e.total.value,r={target:n.refId,type:"docs",refId:n.refId,datapoints:[],total:i,filterable:!0};let l,u,c,o;for(o=0;o<e.hits.length;o++){if(u=e.hits[o],c={_id:u._id,_type:u._type,_index:u._index,sort:u.sort,highlight:u.highlight},u._source)for(l in u._source)c[l]=u._source[l];for(l in u.fields)c[l]=u.fields[l];r.datapoints.push(c)}s.push(r)}trimDatapoints(e,s){const n=(0,y.find)(s.bucketAggs,{type:"date_histogram"});if(n&&n.settings&&n.settings.trimEdges){const r=n.settings.trimEdges;for(const l in e){const u=e[l];u.datapoints.length>r*2&&(u.datapoints=u.datapoints.slice(r,u.datapoints.length-r))}}}getErrorFromElasticResponse(e,s){const n={};return n.data=JSON.stringify(s,null,4),s.root_cause&&s.root_cause.length>0&&s.root_cause[0].reason?n.message=s.root_cause[0].reason:n.message=s.reason||"Unknown elastic error response",e.$$config&&(n.config=e.$$config),n}getTimeSeries(){if(this.targets.some(s=>be(s,"raw_data")))return this.processResponseToDataFrames(!1);const e=this.processResponseToSeries();return{...e,data:e.data.map(s=>(0,Be.g0)(s))}}getLogs(e,s){return this.processResponseToDataFrames(!0,e,s)}processResponseToDataFrames(e,s,n){const i=[];for(let r=0;r<this.response.responses.length;r++){const l=this.response.responses[r];if(l.error)throw this.getErrorFromElasticResponse(this.response,l.error);if(l.hits){const{propNames:u,docs:c}=Yn(l.hits.hits),o=c.length?zt(u.map(Kn(c)),e,this.targets[0].timeField,s,n):zt([],e);e&&Ht(o,"logs");for(const g of c){if(n&&(g.level=g[n]),g.highlight){const p=new RegExp(Qt,"g"),v=new RegExp(Qt),I=Object.keys(g.highlight).flatMap(R=>g.highlight[R].flatMap($=>{const M=$.match(p);return M?M.map(D=>{const P=D.match(v);return P&&P[1]||null}):[]})).filter(y.identity),_=o.meta?.searchWords?(0,y.uniq)([...o.meta.searchWords,...I]):[...I];o.meta=o.meta?{...o.meta,searchWords:_}:{searchWords:_}}o.add(g)}const d=this.targets[r];o.refId=d.refId,i.push(o)}if(l.aggregations){const u=l.aggregations,c=this.targets[r],o=[],d=new Rt.Z;if(this.processBuckets(u,c,o,d,{},0),this.trimDatapoints(o,c),this.nameSeries(o,c),d.rows.length>0){const g=(0,Be.g0)(d);g.refId=c.refId,i.push(g)}for(let g=0;g<o.length;g++){let p=(0,Be.g0)(o[g]);e&&Ht(p,"graph"),p.refId=c.refId,i.push(p)}}}for(let r of i)for(let l of r.fields)l.type===W.fS.time&&typeof l.values.get(0)!="number"&&(l.values=(0,Un.p8)(l,{destinationType:W.fS.time}).values);return{data:i}}}const Yn=t=>{const e=[];let s=[];for(const n of t){const i=n._source?(0,Gn.default)(n._source):{},r={_id:n._id,_type:n._type,_index:n._index,sort:n.sort,highlight:n.highlight,_source:{...i},...i};for(const l of Object.keys(r))s.indexOf(l)===-1&&s.push(l);e.push(r)}return s.sort(),{docs:e,propNames:s}},zt=(t,e,s,n,i)=>{const r=new qn.v({fields:[]});if(s&&r.addField({config:{filterable:!0},name:s,type:W.fS.time}),n){const u=r.addField({name:n,type:W.fS.string});r.setParser(u,c=>c||"")}if(i){const u=r.addField({name:"level",type:W.fS.string});r.setParser(u,c=>c||"")}const l=r.fields.map(u=>u.name);for(const[u,c]of t){if(l.includes(u)||!e&&u==="_source")continue;const o=r.addField({config:{filterable:!0},name:u,type:c});r.setParser(o,d=>d||"")}return r},Ht=(t,e)=>{let s=t;s.meta?s.meta.preferredVisualisationType=e:s.meta={preferredVisualisationType:e}},Kn=t=>e=>[e,Jn(t.find(s=>s[e]!==void 0)?.[e])],Jn=t=>{switch(typeof t){case"number":return W.fS.number;case"string":return W.fS.string;default:return W.fS.other}},Zn={Hourly:{startOf:"hour",amount:"hours"},Daily:{startOf:"day",amount:"days"},Weekly:{startOf:"isoWeek",amount:"weeks"},Monthly:{startOf:"month",amount:"months"},Yearly:{startOf:"year",amount:"years"}};class Xn{constructor(e,s){this.pattern=e,this.interval=s,this.dateLocale="en"}getIndexForToday(){return this.interval?(0,L.zh)().locale(this.dateLocale).format(this.pattern):this.pattern}getIndexList(e,s){if(!this.interval)return this.pattern;const i=Zn[this.interval],r=(0,L.CQ)(e||(0,L.CQ)(s).add(-7,i.amount)).utc().startOf(i.startOf),l=(0,L.CQ)(s||(0,L.CQ)(e).add(7,i.amount)).utc().startOf(i.startOf).valueOf(),u=[];for(;r.valueOf()<=l;)u.push(r.locale(this.dateLocale).format(this.pattern)),r.add(1,i.amount);return u}}var ge=m(62163);class ei extends Ae.iL{constructor(e,s){super(),this.datasource=e,Object.assign(this,s)}importFromAbstractQuery(e){return{metrics:[{id:"1",type:"logs"}],query:this.getElasticsearchQuery(e.labelMatchers),refId:e.refId}}getElasticsearchQuery(e){return e.map(s=>{switch(s.operator){case ge.K2.Equal:return s.name+':"'+s.value+'"';case ge.K2.NotEqual:return"-"+s.name+':"'+s.value+'"';case ge.K2.EqualRegEx:return s.name+":/"+s.value+"/";case ge.K2.NotEqualRegEx:return"-"+s.name+":/"+s.value+"/"}}).join(" AND ")}}class ti{constructor(e){this.timeField=e.timeField}getRangeFilter(){const e={};return e[this.timeField]={gte:"$timeFrom",lte:"$timeTo",format:"epoch_millis"},e}buildTermsAgg(e,s,n){if(s.terms={field:e.field},!e.settings)return s;const i=e.settings?.size?parseInt(e.settings.size,10):500;if(s.terms.size=i===0?500:i,e.settings.orderBy!==void 0){s.terms.order={},e.settings.orderBy==="_term"?s.terms.order._key=e.settings.order:s.terms.order[e.settings.orderBy]=e.settings.order;const r=Ge(e.settings.orderBy);if(r){for(let l of n.metrics||[])if(l.id===r){l.type==="count"?s.terms.order={_count:e.settings.order}:Q(l)&&(s.aggs={},s.aggs[l.id]={[l.type]:{field:l.field}});break}}}return e.settings.min_doc_count!==void 0&&(s.terms.min_doc_count=parseInt(e.settings.min_doc_count,10),isNaN(s.terms.min_doc_count)&&(s.terms.min_doc_count=e.settings.min_doc_count)),e.settings.missing&&(s.terms.missing=e.settings.missing),s}getDateHistogramAgg(e){const s={},n=e.settings||{};s.field=e.field||this.timeField,s.min_doc_count=n.min_doc_count||0,s.extended_bounds={min:"$timeFrom",max:"$timeTo"},s.format="epoch_millis",n.timeZone&&n.timeZone!==xe.RQ.utc&&(s.time_zone=n.timeZone),n.offset!==""&&(s.offset=n.offset);const i=n.interval==="auto"?"${__interval_ms}ms":n.interval;return s.fixed_interval=i,s}getHistogramAgg(e){const s={},n=e.settings||{};return s.interval=n.interval,s.field=e.field,s.min_doc_count=n.min_doc_count||0,s}getFiltersAgg(e){const s={};for(let{query:n,label:i}of e.settings?.filters||[])s[i||n]={query_string:{query:n,analyze_wildcard:!0}};return s}documentQuery(e,s){return e.size=s,e.sort=[{[this.timeField]:{order:"desc",unmapped_type:"boolean"}},{_doc:{order:"desc"}}],e.script_fields={},e}build(e){e.metrics=e.metrics||[re()],e.bucketAggs=e.bucketAggs||[le()],e.timeField=this.timeField;let s,n,i,r,l;const u={size:0,query:{bool:{filter:[{range:this.getRangeFilter()}]}}};if(e.query&&e.query!==""&&(u.query.bool.filter=[...u.query.bool.filter,{query_string:{analyze_wildcard:!0,query:e.query}}]),e.bucketAggs.length===0&&(s=e.metrics[0],!s||!(s.type==="raw_document"||s.type==="raw_data")))throw{message:"Invalid query"};if(e.metrics?.[0]?.type==="raw_document"||e.metrics?.[0]?.type==="raw_data"){s=e.metrics[0];const c=s.settings?.size?parseInt(s.settings.size,10):500;return this.documentQuery(u,c||500)}for(l=u,n=0;n<e.bucketAggs.length;n++){const c=e.bucketAggs[n],o={};switch(c.type){case"date_histogram":{o.date_histogram=this.getDateHistogramAgg(c);break}case"histogram":{o.histogram=this.getHistogramAgg(c);break}case"filters":{o.filters={filters:this.getFiltersAgg(c)};break}case"terms":{this.buildTermsAgg(c,o,e);break}case"geohash_grid":{o.geohash_grid={field:c.field,precision:c.settings?.precision};break}case"nested":{o.nested={path:c.field};break}}l.aggs=l.aggs||{},l.aggs[c.id]=o,l=o}for(l.aggs={},n=0;n<e.metrics.length;n++){if(s=e.metrics[n],s.type==="count")continue;const c={};let o={};if(Y(s))if(ie(s))if(s.pipelineVariables){for(o={buckets_path:{}},i=0;i<s.pipelineVariables.length;i++)if(r=s.pipelineVariables[i],r.name&&r.pipelineAgg&&/^\d*$/.test(r.pipelineAgg)){const d=Ue(e.metrics,r.pipelineAgg);d&&(d.type==="count"?o.buckets_path[r.name]="_count":o.buckets_path[r.name]=r.pipelineAgg)}}else continue;else if(s.field&&/^\d*$/.test(s.field)){const d=Ue(e.metrics,s.field);d&&(d.type==="count"?o={buckets_path:"_count"}:o={buckets_path:s.field})}else continue;else Q(s)&&(o={field:s.field});if(ye(s))switch(Object.entries(s.settings||{}).filter(([d,g])=>g!==null).forEach(([d,g])=>{o[d]=d==="script"?this.buildScript(K(s)):g}),s.type){case"moving_avg":o={...o,...o?.window!==void 0&&{window:this.toNumber(o.window)},...o?.predict!==void 0&&{predict:this.toNumber(o.predict)},...Zt(s)&&{settings:{...o.settings,...Object.fromEntries(Object.entries(o.settings||{}).filter(([d])=>["alpha","beta","gamma","period"].includes(d)).filter(([d,g])=>g!==void 0).map(([d,g])=>[d,this.toNumber(g)]))}}};break;case"serial_diff":o={...o,...o.lag!==void 0&&{lag:this.toNumber(o.lag)}};break;case"top_metrics":o={metrics:s.settings?.metrics?.map(d=>({field:d})),size:1},s.settings?.orderBy&&(o.sort=[{[s.settings?.orderBy]:s.settings?.order}]);break}c[s.type]=o,l.aggs[s.id]=c}return u}buildScript(e){return e}toNumber(e){const s=parseFloat(`${e}`);return isNaN(s)?e:s}getTermsQuery(e){const s={size:0,query:{bool:{filter:[{range:this.getRangeFilter()}]}}};e.query&&s.query.bool.filter.push({query_string:{analyze_wildcard:!0,query:e.query}});let n=500;e.size&&(n=e.size),s.aggs={1:{terms:{field:e.field,size:n,order:{}}}};const{orderBy:i="key",order:r=i==="doc_count"?"desc":"asc"}=e;if(["asc","desc"].indexOf(r)<0)throw{message:`Invalid query sort order ${r}`};switch(i){case"key":case"term":const l="_key";s.aggs[1].terms.order[l]=r;break;case"doc_count":s.aggs[1].terms.order._count=r;break;default:throw{message:`Invalid query sort type ${i}`}}return s}getLogsQuery(e,s){let n={size:0,query:{bool:{filter:[{range:this.getRangeFilter()}]}}};return e.query&&n.query.bool.filter.push({query_string:{analyze_wildcard:!0,query:e.query}}),n=this.documentQuery(n,s),{...n,aggs:this.build(e).aggs,highlight:{fields:{"*":{}},pre_tags:[ae.pre],post_tags:[ae.post],fragment_size:2147483647}}}}var te=m(26418);function si(t){const e=t.annotation,s=t.onAnnotationChange;return a.createElement(a.Fragment,null,a.createElement("div",{className:"gf-form-group"},a.createElement(Nt,{value:e.target?.query,onChange:n=>{const r={...e.target??{refId:"annotation_query"},query:n};s({...e,target:r})}})),a.createElement("div",{className:"gf-form-group"},a.createElement("h6",null,"Field mappings"),a.createElement(te.EditorRow,null,a.createElement(te.EditorField,{label:"Time"},a.createElement(b.I,{type:"text",placeholder:"@timestamp",value:e.timeField,onChange:n=>{s({...e,timeField:n.currentTarget.value})}})),a.createElement(te.EditorField,{label:"Time End"},a.createElement(b.I,{type:"text",value:e.timeEndField,onChange:n=>{s({...e,timeEndField:n.currentTarget.value})}})),a.createElement(te.EditorField,{label:"Text"},a.createElement(b.I,{type:"text",value:e.textField,onChange:n=>{s({...e,textField:n.currentTarget.value})}})),a.createElement(te.EditorField,{label:"Tags"},a.createElement(b.I,{type:"text",placeholder:"tags",value:e.tagsField,onChange:n=>{s({...e,tagsField:n.currentTarget.value})}})))))}var jt=m(41818),ni=m(92624),ii=m(31886);const ai=({payload:{dashboardId:t,orgId:e,grafanaVersion:s,queries:n}})=>{try{const i=n[ii.id].filter(v=>!v.hide);if(!i?.length)return;const r=i.filter(li),l=i.filter(v=>!!v.query),u=i.filter(v=>se(v)==="logs"),c=i.filter(v=>se(v)==="metric"),o=i.filter(v=>se(v)==="raw_data"),d=i.filter(v=>se(v)==="raw_document"),g=i.filter(ri),p={grafana_version:s,dashboard_id:t,org_id:e,queries_count:i.length,logs_queries_count:u.length,metric_queries_count:c.length,raw_data_queries_count:o.length,raw_document_queries_count:d.length,queries_with_template_variables_count:r.length,queries_with_changed_line_limit_count:g.length,queries_with_lucene_query_count:l.length};(0,jt.ff)("grafana_elasticsearch_dashboard_loaded",p)}catch(i){console.error("error in elasticsearch tracking handler",i)}},se=t=>!t.metrics||!t.metrics.length?void 0:["logs","raw_data","raw_document"].includes(t.metrics[0].type)?t.metrics[0].type:"metric",qt=t=>{if(t.metrics?.[0]?.type!=="logs")return;const e=t.metrics?.[0].settings?.limit;return e?parseInt(e,10):void 0},ri=t=>{const e=qt(t);return e!==void 0&&e!==500},li=t=>ni.J7.test(t.query??""),oi=t=>!!t.startsWith(Gt);function Ut(t,e,s){const{targets:n,app:i}=e;if(!(i===Oe.zj.Dashboard||i===Oe.zj.PanelViewer))for(const r of n){if(oi(r.refId))return;(0,jt.ff)("grafana_elasticsearch_query_executed",{app:i,grafana_version:Lt.v.buildInfo.version,with_lucene_query:!!r.query,query_type:se(r),line_limit:qt(r),alias:r.alias,has_error:t.error!==void 0,has_data:t.data.some(l=>l.length>0),simultaneously_sent_query_count:n.length,time_range_from:e?.range?.from?.toISOString(),time_range_to:e?.range?.to?.toISOString(),time_taken:Date.now()-s.getTime()})}}const Gt="log-volume-",ci=["_index","_type","_id","_source","_size","_field_names","_ignored","_routing","_meta"];class ui extends Ln.CK{constructor(e,s=(0,Hn.J)()){super(e),this.templateSrv=s,this.getLogRowContext=async(i,r)=>{const u=i.dataFrame.fields.find(B=>B.name==="sort")?.values.get(i.rowIndex)||[i.timeEpochMs],c=r?.direction==="FORWARD"?"asc":"desc",o=r?.direction==="FORWARD"?this.getQueryHeader("query_then_fetch",(0,L.CQ)(i.timeEpochMs)):this.getQueryHeader("query_then_fetch",void 0,(0,L.CQ)(i.timeEpochMs)),d=r?.limit??10,g=JSON.stringify({size:d,query:{bool:{filter:[{range:{[this.timeField]:{[r?.direction==="FORWARD"?"gte":"lte"]:i.timeEpochMs,format:"epoch_millis"}}}]}},sort:[{[this.timeField]:c},{_doc:c}],search_after:u}),p=[o,g].join(`
`)+`
`,v=this.getMultiSearchUrl(),I=await(0,A.n)(this.post(v,p)),_=[{refId:`${i.dataFrame.refId}`,metrics:[{type:"logs",id:"1"}]}],$=new Wt(_,mi(I,c)).getLogs(this.logMessageField,this.logLevelField),M=(0,y.first)($.data);if(!M)return{data:[]};const D=M.fields.find(B=>B.name===this.timeField),P=M.fields.find(B=>B.name===this.logMessageField);return D&&P?{data:[{...M,fields:[...M.fields,{...D,name:"ts"},{...P,name:"line"}]}]}:$},this.basicAuth=e.basicAuth,this.withCredentials=e.withCredentials,this.url=e.url,this.name=e.name,this.index=e.database??"",this.isProxyAccess=e.access==="proxy";const n=e.jsonData||{};this.timeField=n.timeField,this.xpack=Boolean(n.xpack),this.indexPattern=new Xn(this.index,n.interval),this.interval=n.timeInterval,this.maxConcurrentShardRequests=n.maxConcurrentShardRequests,this.queryBuilder=new ti({timeField:this.timeField}),this.logMessageField=n.logMessageField||"",this.logLevelField=n.logLevelField||"",this.dataLinks=n.dataLinks||[],this.includeFrozen=n.includeFrozen??!1,this.databaseVersion=null,this.annotations={QueryEditor:si},this.logMessageField===""&&(this.logMessageField=void 0),this.logLevelField===""&&(this.logLevelField=void 0),this.languageProvider=new ei(this),this.timeSrv=(0,zn.$t)()}request(e,s,n,i){if(!this.isProxyAccess){const l=new Error("Browser access mode in the Elasticsearch datasource is no longer available. Switch to server access mode.");return(0,Ve._)(()=>l)}const r={url:this.url+"/"+s,method:e,data:n,headers:i};return(this.basicAuth||this.withCredentials)&&(r.withCredentials=!0),this.basicAuth&&(r.headers={Authorization:this.basicAuth}),(0,Rn.i)().fetch(r).pipe((0,G.U)(l=>(l.data.$$config=l.config,l.data)),(0,$e.K)(l=>{if(l.data){const u=l.data.error?.reason??l.data.message??"Unknown error";return(0,Ve._)({message:"Elasticsearch error: "+u,error:l.data.error})}return(0,Ve._)(l)}))}async importFromAbstractQueries(e){return e.map(s=>this.languageProvider.importFromAbstractQuery(s))}get(e,s=(0,me.JK)()){let n=this.indexPattern.getIndexList(s.from,s.to);Array.isArray(n)||(n=[this.indexPattern.getIndexForToday()]);const i=n.map(r=>r+e);return this.requestAllIndices(i)}requestAllIndices(e){const n=e.length;return(0,On.R)({initialState:0,condition:i=>i<Math.min(n,7),iterate:i=>i+1}).pipe((0,kt.z)(i=>this.request("GET",e[n-i-1]).pipe((0,$e.K)(r=>(0,U.of)({err:r})))),(0,Bn.n)(i=>i?.err?.status===404),(0,kn.T)(()=>"Could not find an available index for this time range."),(0,An.P)(),(0,G.U)(i=>{if(i.err)throw i.err;return i}))}post(e,s){return this.request("POST",e,s,{"Content-Type":"application/x-ndjson"})}annotationQuery(e){const s=e.annotation,n=s.timeField||"@timestamp",i=s.timeEndField||null,r=s.query??s.target?.query,l=s.tagsField||"tags",u=s.textField||null,c=[],o={};if(o[n]={from:e.range.from.valueOf(),to:e.range.to.valueOf(),format:"epoch_millis"},c.push({range:o}),i){const _={};_[i]={from:e.range.from.valueOf(),to:e.range.to.valueOf(),format:"epoch_millis"},c.push({range:_})}const d=this.interpolateLuceneQuery(r),g={bool:{filter:[{bool:{should:c,minimum_should_match:1}}]}};d&&g.bool.filter.push({query_string:{query:d}});const p={query:g,size:1e4},v={search_type:"query_then_fetch",ignore_unavailable:!0};s.index?v.index=s.index:v.index=this.indexPattern.getIndexList(e.range.from,e.range.to);const I=JSON.stringify(v)+`
`+JSON.stringify(p)+`
`;return(0,A.n)(this.post("_msearch",I).pipe((0,G.U)(_=>{const R=[],$=_.responses[0].hits.hits,M=(D,P)=>{if(!P)return;const B=P.split(".");let O=D;for(let V=0;V<B.length;V++)if(O=O[B[V]],!O)return console.log("could not find field in annotation: ",P),"";return O};for(let D=0;D<$.length;D++){const P=$[D]._source;let B=M(P,n);if(typeof $[D].fields<"u"){const V=$[D].fields;((0,y.isString)(V[n])||(0,y.isNumber)(V[n]))&&(B=V[n])}const O={annotation:s,time:(0,L.zh)(B).valueOf(),text:M(P,u),tags:M(P,l)};if(i){const V=M(P,i);V&&(O.timeEnd=(0,L.zh)(V).valueOf())}if(s.titleField){const V=M(P,s.titleField);V&&(O.text=V+`
`+O.text)}typeof O.tags=="string"&&(O.tags=O.tags.split(",")),R.push(O)}return R})))}interpolateLuceneQuery(e,s){return this.templateSrv.replace(e,s,"lucene")}interpolateVariablesInQueries(e,s){return e.map(n=>this.applyTemplateVariables(n,s))}async testDatasource(){const e=await this.getDatabaseVersion(!1),n=(e!=null?Ye(e):!0)?"":`WARNING: ${Ke} `;return(0,A.n)(this.getFields(["date"]).pipe((0,kt.z)(i=>(0,y.find)(i,{text:this.timeField})?(0,U.of)({status:"success",message:`${n}Index OK. Time field name OK`}):(0,U.of)({status:"error",message:"No date field named "+this.timeField+" found"})),(0,$e.K)(i=>(console.error(i),i.message?(0,U.of)({status:"error",message:i.message}):(0,U.of)({status:"error",message:i.status})))))}getQueryHeader(e,s,n){const i={search_type:e,ignore_unavailable:!0,index:this.indexPattern.getIndexList(s,n)};return JSON.stringify(i)}getQueryDisplayText(e){const s=e.metrics,n=e.bucketAggs;let i="";return e.query&&(i+="Query: "+e.query+", "),i+="Metrics: ",i+=s?.reduce((r,l)=>{let c=E[l.type].label+"(";return Q(l)&&(c+=l.field),ie(l)&&(c+=K(l).replace(new RegExp("params.","g"),"")),c+="), ",`${r} ${c}`},""),i+=n?.reduce((r,l,u)=>{const c=F[l.type];let o="";return u===0&&(o+=" Group by: "),o+=c.label+"(",bt(l)&&(o+=l.field),`${r} ${o}), `},""),e.alias&&(i+="Alias: "+e.alias),i}showContextToggle(){return!0}getDataProvider(e,s){if(this.getSupportedSupplementaryQueryTypes().includes(e))switch(e){case ee.v8.LogsVolume:return this.getLogsVolumeDataProvider(s);default:return}}getSupportedSupplementaryQueryTypes(){return[ee.v8.LogsVolume]}getSupplementaryQuery(e,s){if(!this.getSupportedSupplementaryQueryTypes().includes(e))return;let n=!1;switch(e){case ee.v8.LogsVolume:if(n=s.metrics?.length===1&&s.metrics[0].type==="logs",!n)return;const i=[],r=this.timeField??"@timestamp";return this.logLevelField&&i.push({id:"2",type:"terms",settings:{min_doc_count:"0",size:"0",order:"desc",orderBy:"_count",missing:ee.in.unknown},field:this.logLevelField}),i.push({id:"3",type:"date_histogram",settings:{interval:"auto",min_doc_count:"0",trimEdges:"0"},field:r}),{refId:`${Gt}${s.refId}`,query:s.query,metrics:[{type:"count",id:"1"}],timeField:r,bucketAggs:i};default:return}}getLogsVolumeDataProvider(e){const s=(0,y.cloneDeep)(e),n=s.targets.map(i=>this.getSupplementaryQuery(ee.v8.LogsVolume,i)).filter(i=>!!i);if(n.length)return(0,Wn.Bz)(this,{...s,targets:n},{range:e.range,targets:e.targets,extractLevel:i=>(0,jn.jx)(i.name||"")})}query(e){const{elasticsearchBackendMigration:s,disableElasticsearchBackendExploreQuery:n}=Lt.v.featureToggles;if(e.app===Oe.zj.Explore&&!n||s){const p=new Date;return super.query(e).pipe((0,At.b)(v=>Ut(v,e,p)))}let r="";const l=this.interpolateVariablesInQueries((0,y.cloneDeep)(e.targets),e.scopedVars),u=[];let c=l.some(p=>be(p,"logs"));const o=[];for(const p of l){if(p.hide)continue;let v;if(be(p,"logs")){p.bucketAggs=[le()];const $=p.metrics?.find(D=>D.type==="logs"),M=$.settings?.limit?parseInt($.settings?.limit,10):500;o.push(M),p.metrics=[],v=this.queryBuilder.getLogsQuery(p,M)}else o.push(),p.alias&&(p.alias=this.interpolateLuceneQuery(p.alias,e.scopedVars)),v=this.queryBuilder.build(p);const I=JSON.stringify(v),_="query_then_fetch",R=this.getQueryHeader(_,e.range.from,e.range.to);r+=R+`
`,r+=I+`
`,u.push(p)}if(u.length===0)return(0,U.of)({data:[]});r=r.replace(/"\$timeFrom"/g,e.range.from.valueOf().toString()),r=r.replace(/"\$timeTo"/g,e.range.to.valueOf().toString()),r=this.templateSrv.replace(r,e.scopedVars);const d=this.getMultiSearchUrl(),g=new Date;return this.post(d,r).pipe((0,G.U)(p=>{const v=new Wt(u,p);if(c){const I=v.getLogs(this.logMessageField,this.logLevelField);return I.data.forEach((_,R)=>{di(_,this.dataLinks,o[R])}),I}return v.getTimeSeries()}),(0,At.b)(p=>Ut(p,e,g)))}isMetadataField(e){return ci.includes(e)}getFields(e,s){const n={float:"number",double:"number",integer:"number",long:"number",date:"date",date_nanos:"date",string:"string",text:"string",scaled_float:"number",nested:"nested",histogram:"number"};return this.get("/_mapping",s).pipe((0,G.U)(i=>{const r=(o,d)=>this.isMetadataField(d)?!1:!e||e.length===0?!0:e.includes(o.type)||e.includes(n[o.type]),l=[],u={};function c(o){for(const d in o){const g=o[d];if((0,y.isObject)(g.properties)&&(l.push(d),c(g.properties)),(0,y.isObject)(g.fields)&&(l.push(d),c(g.fields)),(0,y.isString)(g.type)){const p=l.concat(d).join(".");r(g,d)&&(u[p]={text:p,type:g.type})}}l.pop()}for(const o in i){const d=i[o];if(d&&d.mappings){const p=d.mappings.properties;c(p)}}return(0,y.map)(u,o=>o)}))}getTerms(e,s=(0,me.JK)()){const n="query_then_fetch",i=this.getQueryHeader(n,s.from,s.to);let r=JSON.stringify(this.queryBuilder.getTermsQuery(e));r=r.replace(/\$timeFrom/g,s.from.valueOf().toString()),r=r.replace(/\$timeTo/g,s.to.valueOf().toString()),r=i+`
`+r+`
`;const l=this.getMultiSearchUrl();return this.post(l,r).pipe((0,G.U)(u=>{if(!u.responses[0].aggregations)return[];const c=u.responses[0].aggregations[1].buckets;return(0,y.map)(c,o=>({text:o.key_as_string||o.key,value:o.key}))}))}getMultiSearchUrl(){const e=new URLSearchParams;return this.maxConcurrentShardRequests&&e.append("max_concurrent_shard_requests",`${this.maxConcurrentShardRequests}`),this.xpack&&this.includeFrozen&&e.append("ignore_throttled","false"),("_msearch?"+e.toString()).replace(/\?$/,"")}metricFindQuery(e,s){const n=s?.range,i=JSON.parse(e);if(e){if(i.find==="fields")return i.type=this.interpolateLuceneQuery(i.type),(0,A.n)(this.getFields(i.type,n));if(i.find==="terms")return i.field=this.interpolateLuceneQuery(i.field),i.query=this.interpolateLuceneQuery(i.query),(0,A.n)(this.getTerms(i,n))}return Promise.resolve([])}getTagKeys(){return(0,A.n)(this.getFields())}getTagValues(e){const s=this.timeSrv.timeRange();return(0,A.n)(this.getTerms({field:e.key},s))}targetContainsTemplate(e){if(this.templateSrv.containsTemplate(e.query)||this.templateSrv.containsTemplate(e.alias))return!0;for(const s of e.bucketAggs)if(this.templateSrv.containsTemplate(s.field)||this.objectContainsTemplate(s.settings))return!0;for(const s of e.metrics)if(this.templateSrv.containsTemplate(s.field)||this.objectContainsTemplate(s.settings)||this.objectContainsTemplate(s.meta))return!0;return!1}isPrimitive(e){return!!(e==null||["string","number","boolean"].some(s=>s==="boolean"))}objectContainsTemplate(e){if(!e)return!1;for(const s of Object.keys(e))if(this.isPrimitive(e[s])){if(this.templateSrv.containsTemplate(e[s]))return!0}else if(Array.isArray(e[s])){for(const n of e[s])if(this.objectContainsTemplate(n))return!0}else if(this.objectContainsTemplate(e[s]))return!0;return!1}modifyQuery(e,s){if(!s.options)return e;let n=e.query??"";switch(s.type){case"ADD_FILTER":{n.length>0&&(n+=" AND "),n+=`${s.options.key}:"${s.options.value}"`;break}case"ADD_FILTER_OUT":{n.length>0&&(n+=" AND "),n+=`-${s.options.key}:"${s.options.value}"`;break}}return{...e,query:n}}addAdHocFilters(e){const s=this.templateSrv.getAdhocFilters(this.name);if(s.length===0)return e;const n=s.map(r=>{const{key:l,operator:u,value:c}=r;if(!(!l||!c))switch(u){case"=":return`${l}:"${c}"`;case"!=":return`-${l}:"${c}"`;case"=~":return`${l}:/${c}/`;case"!~":return`-${l}:/${c}/`;case">":return`${l}:>${c}`;case"<":return`${l}:<${c}`}});return[e,...n].filter(r=>r).join(" AND ")}applyTemplateVariables(e,s){const n=l=>l.type==="filters"?{...l,settings:{...l.settings,filters:l.settings?.filters?.map(u=>({...u,query:this.interpolateLuceneQuery(u.query,s)||"*"}))}}:l,i={...e,datasource:this.getRef(),query:this.addAdHocFilters(this.interpolateLuceneQuery(e.query||"",s)),bucketAggs:e.bucketAggs?.map(n)};return JSON.parse(this.templateSrv.replace(JSON.stringify(i),s))}getDatabaseVersionUncached(){return(0,A.n)(this.request("GET","/")).then(e=>{const s=e?.version?.number;if(typeof s!="string")return null;try{return new Ee.SemVer(s)}catch(n){return console.error(n),null}},e=>(console.error(e),null))}async getDatabaseVersion(e=!0){if(e){const n=this.databaseVersion;if(n!=null)return n}const s=await this.getDatabaseVersionUncached();return this.databaseVersion=s,s}}function di(t,e,s){if(s&&(t.meta={...t.meta,limit:s}),!!e.length)for(const n of t.fields){const i=e.filter(r=>new RegExp(r.field).test(n.name));i.length!==0&&(n.config=n.config||{},n.config.links=[...(n.config.links,i.map(gi))])}}function gi(t){const e=(0,Qn.F)();if(t.datasourceUid){const s=e.getInstanceSettings(t.datasourceUid);return{title:t.urlDisplayLabel||"",url:"",internal:{query:{query:t.url},datasourceUid:t.datasourceUid,datasourceName:s?.name??"Data source not found"}}}else return{title:t.urlDisplayLabel||"",url:t.url}}function mi(t,e){if(e==="desc")return t;const s=t.responses[0];return{...t,responses:[{...s,hits:{...s.hits,hits:s.hits.hits.reverse()}}]}}const pi=new Ae.hf(ui).setQueryEditor(un).setConfigEditor($n);(0,Kt.N$)().subscribe(Yt.Pl,ai)}}]);

//# sourceMappingURL=4601.ff7d3979850cf4080c4d.js.map