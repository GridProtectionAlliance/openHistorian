{"version":3,"sources":["webpack:///./public/app/features/datasources/utils/passwordHandlers.ts","webpack:///./public/app/plugins/datasource/mssql/response_parser.ts","webpack:///./public/app/plugins/datasource/mssql/datasource.ts","webpack:///./public/app/plugins/datasource/mssql/query_ctrl.ts","webpack:///./public/app/plugins/datasource/mssql/config_ctrl.ts","webpack:///./public/app/plugins/datasource/mssql/module.ts"],"names":["PasswordFieldEnum","__webpack_require__","d","__webpack_exports__","createResetHandler","createChangeHandler","ctrl","field","event","preventDefault","current","secureJsonFields","secureJsonData","currentTarget","value","ResponseParser","prototype","processQueryResult","res","data","results","key","queryRes","series","_c","e_1","Object","tslib_es6","_d","next","done","push","target","name","datapoints","points","refId","meta","tables","_e","e_2","_f","table","type","parseMetricFindQueryResult","length","rowCount","columns","rows","textColIndex","this","findColIndex","valueColIndex","transformToKeyValueList","transformToSimpleList","i","containsKey","text","j","indexOf","lodash_default","a","map","colName","transformAnnotationResponse","options","annotation","timeColumnIndex","timeEndColumnIndex","textColumnIndex","tagsColumnIndex","Promise","reject","message","list","row","timeEnd","Math","floor","undefined","time","tags","trim","split","datasource_MssqlDatasource","MssqlDatasource","instanceSettings","backendSrv","templateSrv","timeSrv","id","responseParser","response_parser","interval","jsonData","timeInterval","$inject","interpolateVariable","variable","multi","includeAll","replace","val","join","interpolateVariablesInQueries","queries","scopedVars","_this","expandedQueries","query","datasource","rawSql","filter","targets","item","hide","intervalMs","maxDataPoints","datasourceId","format","resolve","datasourceRequest","url","method","from","range","valueOf","toString","to","then","annotationQuery","rawQuery","metricFindQuery","optionalOptions","interpolatedQuery","timeRange","testDatasource","status","catch","err","console","log","targetContainsTemplate","variableExists","defaultQuery","query_ctrl_MssqlQueryCtrl","_super","MssqlQueryCtrl","$scope","$injector","call","alias","formats","panelCtrl","panel","events","on","src","dataError","onDataError","bind","onDataReceived","dataList","lastQueryMeta","lastQueryError","anySeriesFromQuery","find","error","templateUrl","config_ctrl_MssqlConfigCtrl","MssqlConfigCtrl","encrypt","onPasswordReset","passwordHandlers","Password","onPasswordChange","MssqlAnnotationsQueryCtrl","module_defaultQuery"],"mappings":"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","file":"mssqlPlugin.4d0490a94b199a11f40c.js","sourcesContent":["/**\n * Set of handlers for secure password field in Angular components. They handle backward compatibility with\n * passwords stored in plain text fields.\n */\n\nimport { SyntheticEvent } from 'react';\n\nexport enum PasswordFieldEnum {\n  Password = 'password',\n  BasicAuthPassword = 'basicAuthPassword',\n}\n\n/**\n * Basic shape for settings controllers in at the moment mostly angular datasource plugins.\n */\nexport type Ctrl = {\n  current: {\n    secureJsonFields: {\n      [key: string]: boolean;\n    };\n    secureJsonData?: {\n      [key: string]: string;\n    };\n    password?: string;\n    basicAuthPassword?: string;\n  };\n};\n\nexport const createResetHandler = (ctrl: Ctrl, field: PasswordFieldEnum) => (\n  event: SyntheticEvent<HTMLInputElement>\n) => {\n  event.preventDefault();\n  // Reset also normal plain text password to remove it and only save it in secureJsonData.\n  ctrl.current[field] = null;\n  ctrl.current.secureJsonFields[field] = false;\n  ctrl.current.secureJsonData = ctrl.current.secureJsonData || {};\n  ctrl.current.secureJsonData[field] = '';\n};\n\nexport const createChangeHandler = (ctrl: any, field: PasswordFieldEnum) => (\n  event: SyntheticEvent<HTMLInputElement>\n) => {\n  ctrl.current.secureJsonData = ctrl.current.secureJsonData || {};\n  ctrl.current.secureJsonData[field] = event.currentTarget.value;\n};\n","import _ from 'lodash';\n\nexport default class ResponseParser {\n  processQueryResult(res: any) {\n    const data: any[] = [];\n\n    if (!res.data.results) {\n      return { data };\n    }\n\n    for (const key in res.data.results) {\n      const queryRes = res.data.results[key];\n\n      if (queryRes.series) {\n        for (const series of queryRes.series) {\n          data.push({\n            target: series.name,\n            datapoints: series.points,\n            refId: queryRes.refId,\n            meta: queryRes.meta,\n          });\n        }\n      }\n\n      if (queryRes.tables) {\n        for (const table of queryRes.tables) {\n          table.type = 'table';\n          table.refId = queryRes.refId;\n          table.meta = queryRes.meta;\n          data.push(table);\n        }\n      }\n    }\n\n    return { data: data };\n  }\n\n  parseMetricFindQueryResult(refId: string, results: any) {\n    if (!results || results.data.length === 0 || results.data.results[refId].meta.rowCount === 0) {\n      return [];\n    }\n\n    const columns = results.data.results[refId].tables[0].columns;\n    const rows = results.data.results[refId].tables[0].rows;\n    const textColIndex = this.findColIndex(columns, '__text');\n    const valueColIndex = this.findColIndex(columns, '__value');\n\n    if (columns.length === 2 && textColIndex !== -1 && valueColIndex !== -1) {\n      return this.transformToKeyValueList(rows, textColIndex, valueColIndex);\n    }\n\n    return this.transformToSimpleList(rows);\n  }\n\n  transformToKeyValueList(rows: any, textColIndex: number, valueColIndex: number) {\n    const res = [];\n\n    for (let i = 0; i < rows.length; i++) {\n      if (!this.containsKey(res, rows[i][textColIndex])) {\n        res.push({ text: rows[i][textColIndex], value: rows[i][valueColIndex] });\n      }\n    }\n\n    return res;\n  }\n\n  transformToSimpleList(rows: any) {\n    const res = [];\n\n    for (let i = 0; i < rows.length; i++) {\n      for (let j = 0; j < rows[i].length; j++) {\n        const value = rows[i][j];\n        if (res.indexOf(value) === -1) {\n          res.push(value);\n        }\n      }\n    }\n\n    return _.map(res, value => {\n      return { text: value };\n    });\n  }\n\n  findColIndex(columns: any[], colName: string) {\n    for (let i = 0; i < columns.length; i++) {\n      if (columns[i].text === colName) {\n        return i;\n      }\n    }\n\n    return -1;\n  }\n\n  containsKey(res: any[], key: any) {\n    for (let i = 0; i < res.length; i++) {\n      if (res[i].text === key) {\n        return true;\n      }\n    }\n    return false;\n  }\n\n  transformAnnotationResponse(options: any, data: any) {\n    const table = data.data.results[options.annotation.name].tables[0];\n\n    let timeColumnIndex = -1;\n    let timeEndColumnIndex = -1;\n    let textColumnIndex = -1;\n    let tagsColumnIndex = -1;\n\n    for (let i = 0; i < table.columns.length; i++) {\n      if (table.columns[i].text === 'time') {\n        timeColumnIndex = i;\n      } else if (table.columns[i].text === 'timeend') {\n        timeEndColumnIndex = i;\n      } else if (table.columns[i].text === 'text') {\n        textColumnIndex = i;\n      } else if (table.columns[i].text === 'tags') {\n        tagsColumnIndex = i;\n      }\n    }\n\n    if (timeColumnIndex === -1) {\n      return Promise.reject({ message: 'Missing mandatory time column (with time column alias) in annotation query.' });\n    }\n\n    const list = [];\n    for (let i = 0; i < table.rows.length; i++) {\n      const row = table.rows[i];\n      const timeEnd =\n        timeEndColumnIndex !== -1 && row[timeEndColumnIndex] ? Math.floor(row[timeEndColumnIndex]) : undefined;\n      list.push({\n        annotation: options.annotation,\n        time: Math.floor(row[timeColumnIndex]),\n        timeEnd,\n        text: row[textColumnIndex],\n        tags: row[tagsColumnIndex] ? row[tagsColumnIndex].trim().split(/\\s*,\\s*/) : [],\n      });\n    }\n\n    return list;\n  }\n}\n","import _ from 'lodash';\nimport ResponseParser from './response_parser';\nimport { BackendSrv } from 'app/core/services/backend_srv';\nimport { ScopedVars } from '@grafana/data';\nimport { TemplateSrv } from 'app/features/templating/template_srv';\nimport { TimeSrv } from 'app/features/dashboard/services/TimeSrv';\n//Types\nimport { MssqlQueryForInterpolation } from './types';\n\nexport class MssqlDatasource {\n  id: any;\n  name: any;\n  responseParser: ResponseParser;\n  interval: string;\n\n  /** @ngInject */\n  constructor(\n    instanceSettings: any,\n    private backendSrv: BackendSrv,\n    private templateSrv: TemplateSrv,\n    private timeSrv: TimeSrv\n  ) {\n    this.name = instanceSettings.name;\n    this.id = instanceSettings.id;\n    this.responseParser = new ResponseParser();\n    this.interval = (instanceSettings.jsonData || {}).timeInterval || '1m';\n  }\n\n  interpolateVariable(value: any, variable: any) {\n    if (typeof value === 'string') {\n      if (variable.multi || variable.includeAll) {\n        return \"'\" + value.replace(/'/g, `''`) + \"'\";\n      } else {\n        return value;\n      }\n    }\n\n    if (typeof value === 'number') {\n      return value;\n    }\n\n    const quotedValues = _.map(value, val => {\n      if (typeof value === 'number') {\n        return value;\n      }\n\n      return \"'\" + val.replace(/'/g, `''`) + \"'\";\n    });\n    return quotedValues.join(',');\n  }\n\n  interpolateVariablesInQueries(\n    queries: MssqlQueryForInterpolation[],\n    scopedVars: ScopedVars\n  ): MssqlQueryForInterpolation[] {\n    let expandedQueries = queries;\n    if (queries && queries.length > 0) {\n      expandedQueries = queries.map(query => {\n        const expandedQuery = {\n          ...query,\n          datasource: this.name,\n          rawSql: this.templateSrv.replace(query.rawSql, scopedVars, this.interpolateVariable),\n        };\n        return expandedQuery;\n      });\n    }\n    return expandedQueries;\n  }\n\n  query(options: any) {\n    const queries = _.filter(options.targets, item => {\n      return item.hide !== true;\n    }).map(item => {\n      return {\n        refId: item.refId,\n        intervalMs: options.intervalMs,\n        maxDataPoints: options.maxDataPoints,\n        datasourceId: this.id,\n        rawSql: this.templateSrv.replace(item.rawSql, options.scopedVars, this.interpolateVariable),\n        format: item.format,\n      };\n    });\n\n    if (queries.length === 0) {\n      return Promise.resolve({ data: [] });\n    }\n\n    return this.backendSrv\n      .datasourceRequest({\n        url: '/api/tsdb/query',\n        method: 'POST',\n        data: {\n          from: options.range.from.valueOf().toString(),\n          to: options.range.to.valueOf().toString(),\n          queries: queries,\n        },\n      })\n      .then(this.responseParser.processQueryResult);\n  }\n\n  annotationQuery(options: any) {\n    if (!options.annotation.rawQuery) {\n      return Promise.reject({ message: 'Query missing in annotation definition' });\n    }\n\n    const query = {\n      refId: options.annotation.name,\n      datasourceId: this.id,\n      rawSql: this.templateSrv.replace(options.annotation.rawQuery, options.scopedVars, this.interpolateVariable),\n      format: 'table',\n    };\n\n    return this.backendSrv\n      .datasourceRequest({\n        url: '/api/tsdb/query',\n        method: 'POST',\n        data: {\n          from: options.range.from.valueOf().toString(),\n          to: options.range.to.valueOf().toString(),\n          queries: [query],\n        },\n      })\n      .then((data: any) => this.responseParser.transformAnnotationResponse(options, data));\n  }\n\n  metricFindQuery(query: string, optionalOptions: { variable: { name: string } }) {\n    let refId = 'tempvar';\n    if (optionalOptions && optionalOptions.variable && optionalOptions.variable.name) {\n      refId = optionalOptions.variable.name;\n    }\n\n    const interpolatedQuery = {\n      refId: refId,\n      datasourceId: this.id,\n      rawSql: this.templateSrv.replace(query, {}, this.interpolateVariable),\n      format: 'table',\n    };\n\n    const range = this.timeSrv.timeRange();\n    const data = {\n      queries: [interpolatedQuery],\n      from: range.from.valueOf().toString(),\n      to: range.to.valueOf().toString(),\n    };\n\n    return this.backendSrv\n      .datasourceRequest({\n        url: '/api/tsdb/query',\n        method: 'POST',\n        data: data,\n      })\n      .then((data: any) => this.responseParser.parseMetricFindQueryResult(refId, data));\n  }\n\n  testDatasource() {\n    return this.backendSrv\n      .datasourceRequest({\n        url: '/api/tsdb/query',\n        method: 'POST',\n        data: {\n          from: '5m',\n          to: 'now',\n          queries: [\n            {\n              refId: 'A',\n              intervalMs: 1,\n              maxDataPoints: 1,\n              datasourceId: this.id,\n              rawSql: 'SELECT 1',\n              format: 'table',\n            },\n          ],\n        },\n      })\n      .then((res: any) => {\n        return { status: 'success', message: 'Database Connection OK' };\n      })\n      .catch((err: any) => {\n        console.log(err);\n        if (err.data && err.data.message) {\n          return { status: 'error', message: err.data.message };\n        } else {\n          return { status: 'error', message: err.status };\n        }\n      });\n  }\n\n  targetContainsTemplate(target: any) {\n    const rawSql = target.rawSql.replace('$__', '');\n    return this.templateSrv.variableExists(rawSql);\n  }\n}\n","import _ from 'lodash';\nimport { QueryCtrl } from 'app/plugins/sdk';\nimport { auto } from 'angular';\nimport { PanelEvents } from '@grafana/data';\n\nexport interface MssqlQuery {\n  refId: string;\n  format: string;\n  alias: string;\n  rawSql: string;\n}\n\nexport interface QueryMeta {\n  sql: string;\n}\n\nconst defaultQuery = `SELECT\n  $__timeEpoch(<time_column>),\n  <value column> as value,\n  <series name column> as metric\nFROM\n  <table name>\nWHERE\n  $__timeFilter(time_column)\nORDER BY\n  <time_column> ASC`;\n\nexport class MssqlQueryCtrl extends QueryCtrl {\n  static templateUrl = 'partials/query.editor.html';\n\n  showLastQuerySQL: boolean;\n  formats: any[];\n  target: MssqlQuery;\n  lastQueryMeta: QueryMeta;\n  lastQueryError: string;\n  showHelp: boolean;\n\n  /** @ngInject */\n  constructor($scope: any, $injector: auto.IInjectorService) {\n    super($scope, $injector);\n\n    this.target.format = this.target.format || 'time_series';\n    this.target.alias = '';\n    this.formats = [\n      { text: 'Time series', value: 'time_series' },\n      { text: 'Table', value: 'table' },\n    ];\n\n    if (!this.target.rawSql) {\n      // special handling when in table panel\n      if (this.panelCtrl.panel.type === 'table') {\n        this.target.format = 'table';\n        this.target.rawSql = 'SELECT 1';\n      } else {\n        this.target.rawSql = defaultQuery;\n      }\n    }\n\n    this.panelCtrl.events.on(PanelEvents.dataReceived, this.onDataReceived.bind(this), $scope);\n    this.panelCtrl.events.on(PanelEvents.dataError, this.onDataError.bind(this), $scope);\n  }\n\n  onDataReceived(dataList: any) {\n    this.lastQueryMeta = null;\n    this.lastQueryError = null;\n\n    const anySeriesFromQuery: any = _.find(dataList, { refId: this.target.refId });\n    if (anySeriesFromQuery) {\n      this.lastQueryMeta = anySeriesFromQuery.meta;\n    }\n  }\n\n  onDataError(err: any) {\n    if (err.data && err.data.results) {\n      const queryRes = err.data.results[this.target.refId];\n      if (queryRes) {\n        this.lastQueryMeta = queryRes.meta;\n        this.lastQueryError = queryRes.error;\n      }\n    }\n  }\n}\n","import {\n  createChangeHandler,\n  createResetHandler,\n  PasswordFieldEnum,\n} from '../../../features/datasources/utils/passwordHandlers';\n\nexport class MssqlConfigCtrl {\n  static templateUrl = 'partials/config.html';\n\n  current: any;\n  onPasswordReset: ReturnType<typeof createResetHandler>;\n  onPasswordChange: ReturnType<typeof createChangeHandler>;\n\n  /** @ngInject */\n  constructor($scope: any) {\n    this.current.jsonData.encrypt = this.current.jsonData.encrypt || 'false';\n    this.onPasswordReset = createResetHandler(this, PasswordFieldEnum.Password);\n    this.onPasswordChange = createChangeHandler(this, PasswordFieldEnum.Password);\n  }\n}\n","import { MssqlDatasource } from './datasource';\nimport { MssqlQueryCtrl } from './query_ctrl';\nimport { MssqlConfigCtrl } from './config_ctrl';\n\nconst defaultQuery = `SELECT\n    <time_column> as time,\n    <text_column> as text,\n    <tags_column> as tags\n  FROM\n    <table name>\n  WHERE\n    $__timeFilter(time_column)\n  ORDER BY\n    <time_column> ASC`;\n\nclass MssqlAnnotationsQueryCtrl {\n  static templateUrl = 'partials/annotations.editor.html';\n\n  annotation: any;\n\n  /** @ngInject */\n  constructor() {\n    this.annotation.rawQuery = this.annotation.rawQuery || defaultQuery;\n  }\n}\n\nexport {\n  MssqlDatasource,\n  MssqlDatasource as Datasource,\n  MssqlQueryCtrl as QueryCtrl,\n  MssqlConfigCtrl as ConfigCtrl,\n  MssqlAnnotationsQueryCtrl as AnnotationsQueryCtrl,\n};\n"],"sourceRoot":""}