"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[747],{24989:(Rt,_,u)=>{u.r(_),u.d(_,{plugin:()=>At});var tt=u(40187),e=u(74848),ct=u(32264),dt=u(91409),x=u(96540),ut=u(84167),G=u(88575),B=u(90182),L=u(10354);const W=[{label:"<=2.1",value:1},{label:"==2.2",value:2},{label:"==2.3",value:3}],H=[{label:"second",value:1},{label:"millisecond",value:2}],gt=a=>{const{onChange:t,value:s}=a,r=(0,x.useId)();return(0,e.jsx)(e.Fragment,{children:(0,e.jsxs)(ut.n,{label:"OpenTSDB settings",children:[(0,e.jsx)(G.D,{htmlFor:`select-version-${r}`,label:"Version",children:(0,e.jsx)(B.l6,{inputId:`select-version-${r}`,options:W,value:W.find(n=>n.value===s.jsonData.tsdbVersion)??W[0],onChange:et("tsdbVersion",s,t),width:20})}),(0,e.jsx)(G.D,{htmlFor:`select-resolution-${r}`,label:"Resolution",children:(0,e.jsx)(B.l6,{inputId:`select-resolution-${r}`,options:H,value:H.find(n=>n.value===s.jsonData.tsdbResolution)??H[0],onChange:et("tsdbResolution",s,t),width:20})}),(0,e.jsx)(G.D,{htmlFor:`lookup-input-${r}`,label:"Lookup limit",children:(0,e.jsx)(L.p,{id:`lookup-input-${r}`,type:"number",value:s.jsonData.lookupLimit??1e3,onChange:pt("lookupLimit",s,t),width:20})})]})})},et=(a,t,s)=>r=>{s({...t,jsonData:{...t.jsonData,[a]:r.value}})},pt=(a,t,s)=>r=>{s({...t,jsonData:{...t.jsonData,[a]:r.currentTarget.value}})},ht=a=>{const{options:t,onOptionsChange:s}=a;return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(dt.t,{defaultUrl:"http://localhost:4242",dataSourceConfig:t,onChange:s,secureSocksDSProxyEnabled:ct.$.secureSocksDSProxyEnabled}),(0,e.jsx)(gt,{value:t,onChange:s})]})};var st=u(32196),at=u(80997),U=u(40845),h=u(67061),b=u(50877),j=u(38894),F=u(76892),z=u(15292);function mt({query:a,onChange:t,onRunQuery:s,aggregators:r,fillPolicies:n,tsdbVersion:c}){const l=r.map(o=>(0,b.z)(o)),i=n.map(o=>(0,b.z)(o));return(0,e.jsxs)(h.B,{gap:.5,alignItems:"flex-start","data-testid":rt.section,children:[(0,e.jsxs)(h.B,{gap:0,children:[(0,e.jsx)(j.I,{className:"query-keyword",width:8,tooltip:(0,e.jsxs)("div",{children:["Leave interval blank for auto or for example use ",(0,e.jsx)("code",{children:"1m"})]}),children:"Down sample"}),(0,e.jsx)(L.p,{width:25,"data-testid":rt.interval,placeholder:"interval",value:a.downsampleInterval??"",onChange:o=>{const d=o.currentTarget.value;t({...a,downsampleInterval:d})},onBlur:()=>s()})]}),(0,e.jsxs)(h.B,{gap:0,children:[(0,e.jsx)(j.I,{width:"auto",className:"query-keyword",children:"Aggregator"}),(0,e.jsx)(B.l6,{value:a.downsampleAggregator?(0,b.z)(a.downsampleAggregator):void 0,options:l,onChange:({value:o})=>{o&&(t({...a,downsampleAggregator:o}),s())}})]}),c>=2&&(0,e.jsxs)(h.B,{gap:0,alignItems:"flex-start",children:[(0,e.jsx)(F.c,{className:"width-6 query-keyword",children:"Fill"}),(0,e.jsx)(B.l6,{inputId:"opentsdb-fillpolicy-select",value:a.downsampleFillPolicy?(0,b.z)(a.downsampleFillPolicy):void 0,options:i,onChange:({value:o})=>{o&&(t({...a,downsampleFillPolicy:o}),s())}})]}),(0,e.jsxs)(h.B,{gap:0,children:[(0,e.jsx)(j.I,{className:"query-keyword",children:"Disable downsampling"}),(0,e.jsx)(z.K,{value:a.disableDownsampling??!1,onChange:()=>{const o=a.disableDownsampling??!1;t({...a,disableDownsampling:!o}),s()}})]}),(0,e.jsx)(h.B,{gap:0,grow:1,children:(0,e.jsx)(F.c,{children:" "})})]})}const rt={section:"opentsdb-downsample",interval:"downsample-interval"};var ft=u(76459),J=u.n(ft),g=u(2543),it=u(55852),k=u(14578);function xt({query:a,onChange:t,onRunQuery:s,suggestTagKeys:r,filterTypes:n,suggestTagValues:c}){const l=(0,U.of)(it.my),[i,o]=(0,x.useState)(),[d,v]=(0,x.useState)(),[f,C]=(0,x.useState)(!1),[y,w]=(0,x.useState)("iliteral_or"),[S,D]=(0,x.useState)(""),[T,N]=(0,x.useState)(""),[K,V]=(0,x.useState)(!1),[E,Y]=(0,x.useState)(""),Z=n.map(p=>(0,b.z)(p));function m(){C(!f)}function M(){if(a.tags&&(0,g.size)(a.tags)>0){Y("Please remove tags to use filters, tags and filters are mutually exclusive.");return}if(!f){C(!0);return}const p={type:y,tagk:S,filter:T,groupBy:K};a.filters=a.filters?a.filters.concat([p]):[p],w("literal_or"),D(""),N(""),V(!1),t(a),s(),m()}function P(p){a.filters?.splice(p,1),t(a),s()}function Kt(p,O){P(O),D(p.tagk),N(p.filter),w(p.type),V(p.groupBy),M()}const Mt=" ",Nt=(0,x.useCallback)((p,O)=>{const q=p.value??"";return O.split(Mt).reduce((Lt,zt)=>Lt&&q.toLowerCase().includes(zt.toLowerCase()),!0)},[]),Pt=J()(p=>c(p),350);return(0,e.jsxs)(h.B,{gap:0,"data-testid":Q.section,children:[(0,e.jsx)(j.I,{className:"query-keyword",width:8,tooltip:(0,e.jsx)("div",{children:"Filters does not work with tags, either of the two will work but not both."}),children:"Filters"}),a.filters&&a.filters.map((p,O)=>(0,e.jsxs)(j.I,{width:"auto","data-testid":Q.list+O,children:[p.tagk," = ",p.type,"(",p.filter,"), groupBy = ",""+p.groupBy,(0,e.jsx)("button",{type:"button",className:l,onClick:()=>Kt(p,O),children:(0,e.jsx)(k.I,{name:"pen"})}),(0,e.jsx)("button",{type:"button",className:l,onClick:()=>P(O),"data-testid":Q.remove,children:(0,e.jsx)(k.I,{name:"times"})})]},O)),!f&&(0,e.jsx)(j.I,{width:2,children:(0,e.jsx)("button",{type:"button",className:l,onClick:m,"aria-label":"Add filter",children:(0,e.jsx)(k.I,{name:"plus"})})}),f&&(0,e.jsxs)(h.B,{gap:.5,alignItems:"center",children:[(0,e.jsx)(h.B,{gap:0,children:(0,e.jsx)(B.l6,{inputId:"opentsdb-suggested-tagk-select",value:S?(0,b.z)(S):void 0,placeholder:"key",allowCustomValue:!0,filterOption:Nt,onOpenMenu:async()=>{v(!0);const O=(await r(a)).map(q=>(0,b.z)(q));o(O),v(!1)},isLoading:d,options:i,onChange:({value:p})=>{p&&D(p)}})}),(0,e.jsxs)(h.B,{gap:0,children:[(0,e.jsx)(F.c,{className:"width-4 query-keyword",children:"Type"}),(0,e.jsx)(B.l6,{inputId:"opentsdb-aggregator-select",value:y?(0,b.z)(y):void 0,options:Z,onChange:({value:p})=>{p&&w(p)}})]}),(0,e.jsx)(h.B,{gap:0,children:(0,e.jsx)(B.DW,{inputId:"opentsdb-suggested-tagv-select",value:T?(0,b.z)(T):void 0,placeholder:"filter",allowCustomValue:!0,loadOptions:Pt,defaultOptions:[],onChange:({value:p})=>{p&&N(p)}})}),(0,e.jsx)(j.I,{width:5,className:"query-keyword",children:"Group by"}),(0,e.jsx)(z.K,{value:K,onChange:()=>{V(!K)}}),(0,e.jsxs)(h.B,{gap:0,children:[E&&(0,e.jsx)(F.c,{title:E,"data-testid":Q.error,children:(0,e.jsx)(k.I,{name:"exclamation-triangle",color:"rgb(229, 189, 28)"})}),(0,e.jsxs)(j.I,{width:5.5,children:[(0,e.jsx)("button",{type:"button",className:l,onClick:M,children:"add filter"}),(0,e.jsx)("button",{type:"button",className:l,onClick:m,children:(0,e.jsx)(k.I,{name:"times"})})]})]})]}),(0,e.jsx)(h.B,{gap:0,grow:1,children:(0,e.jsx)(F.c,{children:" "})})]})}const Q={section:"opentsdb-filter",list:"opentsdb-filter-list",error:"opentsdb-filter-error",remove:"opentsdb-filter-remove"};function vt({query:a,onChange:t,onRunQuery:s,suggestMetrics:r,aggregators:n}){const c=n.map(i=>(0,b.z)(i)),l=J()(i=>r(i),350);return(0,e.jsxs)(h.B,{gap:.5,alignItems:"flex-start","data-testid":nt.section,children:[(0,e.jsxs)(h.B,{gap:0,children:[(0,e.jsx)(j.I,{width:8,className:"query-keyword",children:"Metric"}),(0,e.jsx)(B.DW,{width:25,inputId:"opentsdb-metric-select",value:a.metric?(0,b.z)(a.metric):void 0,placeholder:"Metric name",allowCustomValue:!0,loadOptions:l,defaultOptions:[],onChange:({value:i})=>{i&&(t({...a,metric:i}),s())}})]}),(0,e.jsxs)(h.B,{gap:0,alignItems:"flex-start",children:[(0,e.jsx)(j.I,{width:"auto",className:"query-keyword",children:"Aggregator"}),(0,e.jsx)(B.l6,{inputId:"opentsdb-aggregator-select",value:a.aggregator?(0,b.z)(a.aggregator):void 0,options:c,onChange:({value:i})=>{i&&(t({...a,aggregator:i}),s())}})]}),(0,e.jsxs)(h.B,{gap:0,children:[(0,e.jsx)(j.I,{className:"query-keyword",width:6,tooltip:(0,e.jsx)("div",{children:"Use patterns like $tag_tagname to replace part of the alias for a tag value"}),children:"Alias"}),(0,e.jsx)(L.p,{"data-testid":nt.alias,placeholder:"series alias",value:a.alias??"",onChange:i=>{const o=i.currentTarget.value;t({...a,alias:o})},onBlur:()=>s()})]}),(0,e.jsx)(h.B,{gap:0,grow:1,children:(0,e.jsx)(F.c,{children:" "})})]})}const nt={section:"opentsdb-metricsection",alias:"metric-alias"};function jt({query:a,onChange:t,onRunQuery:s,tsdbVersion:r}){return(0,e.jsxs)(h.B,{gap:0,"data-testid":R.section,children:[(0,e.jsx)(j.I,{className:"query-keyword",width:8,children:"Rate"}),(0,e.jsx)(z.K,{"data-testid":R.shouldComputeRate,value:a.shouldComputeRate??!1,onChange:()=>{const n=a.shouldComputeRate??!1;t({...a,shouldComputeRate:!n}),s()}}),a.shouldComputeRate&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(j.I,{className:"query-keyword",width:"auto",children:"Counter"}),(0,e.jsx)(z.K,{"data-testid":R.isCounter,value:a.isCounter??!1,onChange:()=>{const n=a.isCounter??!1;t({...a,isCounter:!n}),s()}})]}),a.shouldComputeRate&&a.isCounter&&(0,e.jsxs)(h.B,{gap:0,children:[(0,e.jsx)(F.c,{width:"auto",className:"query-keyword",children:"Counter max"}),(0,e.jsx)(L.p,{"data-testid":R.counterMax,placeholder:"max value",value:a.counterMax??"",onChange:n=>{const c=n.currentTarget.value;t({...a,counterMax:c})},onBlur:()=>s()}),(0,e.jsx)(F.c,{width:"auto",className:"query-keyword",children:"Reset value"}),(0,e.jsx)(L.p,{"data-testid":R.counterResetValue,placeholder:"reset value",value:a.counterResetValue??"",onChange:n=>{const c=n.currentTarget.value;t({...a,counterResetValue:c})},onBlur:()=>s()})]}),r>2&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(j.I,{className:"query-keyword",width:"auto",children:"Explicit tags"}),(0,e.jsx)(z.K,{"data-testid":R.explicitTags,value:a.explicitTags??!1,onChange:()=>{const n=a.explicitTags??!1;t({...a,explicitTags:!n}),s()}})]}),(0,e.jsx)(h.B,{gap:0,grow:1,children:(0,e.jsx)(F.c,{children:" "})})]})}const R={section:"opentsdb-rate",shouldComputeRate:"opentsdb-shouldComputeRate",isCounter:"opentsdb-is-counter",counterMax:"opentsdb-counter-max",counterResetValue:"opentsdb-counter-reset-value",explicitTags:"opentsdb-explicit-tags"};function Tt({query:a,onChange:t,onRunQuery:s,suggestTagKeys:r,suggestTagValues:n,tsdbVersion:c}){const l=(0,U.of)(it.my),[i,o]=(0,x.useState)(),[d,v]=(0,x.useState)(),[f,C]=(0,x.useState)(!1),[y,w]=(0,x.useState)(""),[S,D]=(0,x.useState)(""),[T,N]=(0,x.useState)("");function K(){C(!f)}function V(){if(a.filters&&(0,g.size)(a.filters)>0){N("Please remove filters to use tags, tags and filters are mutually exclusive.");return}if(!f){C(!0);return}if(a.tags&&(0,g.has)(a.tags,y)){const m="Duplicate tag key '"+y+"'.";N(m);return}a.tags||(a.tags={}),a.tags[y]=S,w(""),D(""),t(a),s(),K()}function E(m){delete a.tags[m],t(a),s()}function Y(m,M){E(m),w(m),D(M),V()}const Z=J()(m=>n(m),350);return(0,e.jsxs)(h.B,{gap:0,"data-testid":$.section,children:[(0,e.jsx)(j.I,{className:"query-keyword",width:8,tooltip:c>=2?(0,e.jsx)("div",{children:"Please use filters, tags are deprecated in opentsdb 2.2"}):void 0,children:"Tags"}),a.tags&&Object.keys(a.tags).map((m,M)=>{const P=a.tags[m];return(0,e.jsxs)(j.I,{width:"auto","data-testid":$.list+M,children:[m,"=",P,(0,e.jsx)("button",{type:"button",className:l,onClick:()=>Y(m,P),children:(0,e.jsx)(k.I,{name:"pen"})}),(0,e.jsx)("button",{type:"button",className:l,onClick:()=>E(m),"data-testid":$.remove,children:(0,e.jsx)(k.I,{name:"times"})})]},M)}),!f&&(0,e.jsx)(j.I,{width:2,children:(0,e.jsx)("button",{type:"button",className:l,onClick:K,"aria-label":"Add tag",children:(0,e.jsx)(k.I,{name:"plus"})})}),f&&(0,e.jsxs)(h.B,{gap:.5,alignItems:"center",children:[(0,e.jsx)(h.B,{gap:0,children:(0,e.jsx)(B.l6,{inputId:"opentsdb-suggested-tagk-select",value:y?(0,b.z)(""+y):void 0,placeholder:"key",allowCustomValue:!0,onOpenMenu:async()=>{v(!0);const M=(await r(a)).map(P=>(0,b.z)(P));o(M),v(!1)},isLoading:d,options:i,onChange:({value:m})=>{m&&w(m)}})}),(0,e.jsx)(h.B,{gap:0,children:(0,e.jsx)(B.DW,{inputId:"opentsdb-suggested-tagv-select",value:S?(0,b.z)(S):void 0,placeholder:"value",allowCustomValue:!0,loadOptions:Z,defaultOptions:[],onChange:({value:m})=>{m&&D(m)}})}),(0,e.jsxs)(h.B,{gap:0,children:[T&&(0,e.jsx)(F.c,{title:T,"data-testid":$.error,children:(0,e.jsx)(k.I,{name:"exclamation-triangle",color:"rgb(229, 189, 28)"})}),(0,e.jsxs)(j.I,{width:5.5,children:[(0,e.jsx)("button",{type:"button",className:l,onClick:V,children:"add tag"}),(0,e.jsx)("button",{type:"button",className:l,onClick:K,children:(0,e.jsx)(k.I,{name:"times"})})]})]})]}),(0,e.jsx)(h.B,{gap:0,grow:1,children:(0,e.jsx)(F.c,{children:" "})})]})}const $={section:"opentsdb-tag",list:"opentsdb-tag-list",error:"opentsdb-tag-error",remove:"opentsdb-tag-remove"};function bt({datasource:a,onRunQuery:t,onChange:s,query:r,range:n,queries:c}){const l=(0,U.of)(yt),[i,o]=(0,x.useState)(["avg","sum","min","max","dev","zimsum","mimmin","mimmax"]),d=["none","nan","null","zero"],[v,f]=(0,x.useState)(["wildcard","iliteral_or","not_iliteral_or","not_literal_or","iwildcard","literal_or","regexp"]),C=a.tsdbVersion;r.aggregator||(r.aggregator="sum"),r.downsampleAggregator||(r.downsampleAggregator="avg"),r.downsampleFillPolicy||(r.downsampleFillPolicy="none"),(0,x.useEffect)(()=>{a.getAggregators().then(T=>{T.length!==0&&o(T)})},[a]),(0,x.useEffect)(()=>{a.getFilterTypes().then(T=>{T.length!==0&&f(T)})},[a]);async function y(T){return a.metricFindQuery(`metrics(${T})`).then(D)}async function w(T){return a.metricFindQuery(`suggest_tagv(${T})`).then(D)}async function S(T){return a.suggestTagKeys(T)}function D(T){const N=a.getVariables().map(V=>({value:at.sQ.escapeHtml(V),description:V})),K=T.map(V=>({value:at.sQ.escapeHtml(V.text),description:V.text}));return N.concat(K)}return(0,e.jsx)("div",{className:l.container,"data-testid":wt.editor,children:(0,e.jsxs)(h.B,{gap:.5,direction:"column",grow:1,children:[(0,e.jsx)(vt,{query:r,onChange:s,onRunQuery:t,suggestMetrics:y,aggregators:i}),(0,e.jsx)(mt,{query:r,onChange:s,onRunQuery:t,aggregators:i,fillPolicies:d,tsdbVersion:C}),C>=2&&(0,e.jsx)(xt,{query:r,onChange:s,onRunQuery:t,filterTypes:v,suggestTagValues:w,suggestTagKeys:S}),(0,e.jsx)(Tt,{query:r,onChange:s,onRunQuery:t,suggestTagValues:w,suggestTagKeys:S,tsdbVersion:C}),(0,e.jsx)(jt,{query:r,onChange:s,onRunQuery:t,tsdbVersion:C})]})})}function yt(a){return{container:(0,st.css)`
      display: flex;
    `,toggleButton:(0,st.css)`
      margin-left: ${a.spacing(.5)};
    `}}const wt={editor:"opentsdb-editor"};var It=u(88483),Ct=u(44240),X=u(62467),A=u(75505),St=u(66847),I=u(81160),ot=u(14236),Vt=u(85858),lt=u(17172),Bt=u(23989);const Ft=a=>{const{query:t,onChange:s}=a,[r,n]=(0,x.useState)(t.target??""),[c,l]=(0,x.useState)(t.isGlobal??!1),i=(d,v)=>{s({...t,[d]:v,fromAnnotations:!0})},o=d=>{d=!d,l(d),i("isGlobal",d)};return(0,e.jsxs)("div",{className:"gf-form-group",children:[(0,e.jsxs)("div",{className:"gf-form",children:[(0,e.jsx)(j.I,{width:12,children:"OpenTSDB metrics query"}),(0,e.jsx)(L.p,{value:r,onChange:d=>n(d.currentTarget.value??""),onBlur:()=>i("target",r),placeholder:"events.eventname"})]}),(0,e.jsxs)("div",{className:"gf-form",children:[(0,e.jsx)(j.I,{width:12,children:"Show Global Annotations?"}),(0,e.jsx)(z.K,{value:c,onChange:d=>o(c)})]})]})},Ot=a=>({fromAnnotations:!0,target:a.target??"",name:a.name??"",isGlobal:a.isGlobal??!1}),kt=a=>{const t=a.target&&typeof a.target!="string"?a.target:Ot(a);return a.target=t,a};class Dt extends tt.mA{constructor(t,s=(0,Bt.w)()){super(t),this.templateSrv=s,this.type="opentsdb",this.url=t.url,this.name=t.name,this.withCredentials=t.withCredentials,this.basicAuth=t.basicAuth,t.jsonData=t.jsonData||{},this.tsdbVersion=t.jsonData.tsdbVersion||1,this.tsdbResolution=t.jsonData.tsdbResolution||1,this.lookupLimit=t.jsonData.lookupLimit||1e3,this.tagKeys={},this.aggregatorsPromise=null,this.filterTypesPromise=null,this.annotations={QueryEditor:Ft,prepareAnnotation:kt}}query(t){if(t.targets.some(i=>i.fromAnnotations)){const i=[];for(const o of t.targets)o.target&&i.push(new It.c(d=>{this.annotationEvent(t,o).then(v=>d.next({data:[(0,ot.Vc)(v)]})).catch(v=>d.next({data:[(0,ot.Vc)([])]})).finally(()=>d.complete())}));return(0,Ct.h)(...i)}const s=this.convertToTSDBTime(t.range.raw.from,!1,t.timezone),r=this.convertToTSDBTime(t.range.raw.to,!0,t.timezone),n=[];(0,g.each)(t.targets,i=>{i.metric&&n.push(this.convertTargetToQuery(i,t,this.tsdbVersion))});const c=(0,g.compact)(n);if((0,g.isEmpty)(c))return(0,X.of)({data:[]});const l={};return(0,g.each)(c,i=>{i.filters&&i.filters.length>0?(0,g.each)(i.filters,o=>{l[o.tagk]=!0}):(0,g.each)(i.tags,(o,d)=>{l[d]=!0})}),t.targets=(0,g.filter)(t.targets,i=>i.hide!==!0),this.performTimeSeriesQuery(c,s,r).pipe((0,St.W)(i=>{throw i?.data?.error?.message||"Error performing time series query."}),(0,I.T)(i=>{const o=this.mapMetricsToTargets(i.data,t,this.tsdbVersion);return{data:(0,g.map)(i.data,(v,f)=>(f=o[f],f===-1&&(f=0),this._saveTagKeys(v),this.transformMetricData(v,l,t.targets[f],t,this.tsdbResolution)))}}))}annotationEvent(t,s){const r=this.convertToTSDBTime(t.range.raw.from,!1,t.timezone),n=this.convertToTSDBTime(t.range.raw.to,!0,t.timezone),c=[],l=[];c.push({aggregator:"sum",metric:s.target});const i=(0,g.compact)(c);return(0,A.s)(this.performTimeSeriesQuery(i,r,n).pipe((0,I.T)(o=>{if(o.data[0]){let d=o.data[0].annotations;s.isGlobal&&(d=o.data[0].globalAnnotations),d&&(0,g.each)(d,v=>{const f={text:v.description,time:Math.floor(v.startTime)*1e3,annotation:s};l.push(f)})}return l})))}targetContainsTemplate(t){if(t.filters&&t.filters.length>0){for(let s=0;s<t.filters.length;s++)if(this.templateSrv.containsTemplate(t.filters[s].filter))return!0}if(t.tags&&Object.keys(t.tags).length>0){for(const s in t.tags)if(this.templateSrv.containsTemplate(t.tags[s]))return!0}return!1}performTimeSeriesQuery(t,s,r){let n=!1;this.tsdbResolution===2&&(n=!0);const c={start:s,queries:t,msResolution:n,globalAnnotations:!0};this.tsdbVersion===3&&(c.showQuery=!0),r&&(c.end=r);const l={method:"POST",url:this.url+"/api/query",data:c};return this._addCredentialOptions(l),(0,lt.AI)().fetch(l)}suggestTagKeys(t){const s=t.metric??"";return Promise.resolve(this.tagKeys[s]||[])}_saveTagKeys(t){const s=Object.keys(t.tags);(0,g.each)(t.aggregateTags,r=>{s.push(r)}),this.tagKeys[t.metric]=s}_performSuggestQuery(t,s){return this._get("/api/suggest",{type:s,q:t,max:this.lookupLimit}).pipe((0,I.T)(r=>r.data))}_performMetricKeyValueLookup(t,s){if(!t||!s)return(0,X.of)([]);const r=s.split(",").map(i=>i.trim()),n=r[0];let c=n+"=*";r.length>1&&(c+=","+r.splice(1).join(","));const l=t+"{"+c+"}";return this._get("/api/search/lookup",{m:l,limit:this.lookupLimit}).pipe((0,I.T)(i=>{i=i.data.results;const o=[];return(0,g.each)(i,d=>{o.indexOf(d.tags[n])===-1&&o.push(d.tags[n])}),o}))}_performMetricKeyLookup(t){return t?this._get("/api/search/lookup",{m:t,limit:1e3}).pipe((0,I.T)(s=>{s=s.data.results;const r=[];return(0,g.each)(s,n=>{(0,g.each)(n.tags,(c,l)=>{r.indexOf(l)===-1&&r.push(l)})}),r})):(0,X.of)([])}_get(t,s){const r={method:"GET",url:this.url+t,params:s};return this._addCredentialOptions(r),(0,lt.AI)().fetch(r)}_addCredentialOptions(t){(this.basicAuth||this.withCredentials)&&(t.withCredentials=!0),this.basicAuth&&(t.headers={Authorization:this.basicAuth})}metricFindQuery(t){if(!t)return Promise.resolve([]);let s;try{s=this.templateSrv.replace(t,{},"distributed")}catch(w){return Promise.reject(w)}const r=w=>(0,g.map)(w,S=>({text:S})),n=/metrics\((.*)\)/,c=/tag_names\((.*)\)/,l=/tag_values\((.*?),\s?(.*)\)/,i=/suggest_tagk\((.*)\)/,o=/suggest_tagv\((.*)\)/,d=s.match(n);if(d)return(0,A.s)(this._performSuggestQuery(d[1],"metrics").pipe((0,I.T)(r)));const v=s.match(c);if(v)return(0,A.s)(this._performMetricKeyLookup(v[1]).pipe((0,I.T)(r)));const f=s.match(l);if(f)return(0,A.s)(this._performMetricKeyValueLookup(f[1],f[2]).pipe((0,I.T)(r)));const C=s.match(i);if(C)return(0,A.s)(this._performSuggestQuery(C[1],"tagk").pipe((0,I.T)(r)));const y=s.match(o);return y?(0,A.s)(this._performSuggestQuery(y[1],"tagv").pipe((0,I.T)(r))):Promise.resolve([])}testDatasource(){return(0,A.s)(this._performSuggestQuery("cpu","metrics").pipe((0,I.T)(()=>({status:"success",message:"Data source is working"}))))}getAggregators(){return this.aggregatorsPromise?this.aggregatorsPromise:(this.aggregatorsPromise=(0,A.s)(this._get("/api/aggregators").pipe((0,I.T)(t=>t.data&&(0,g.isArray)(t.data)?t.data.sort():[]))),this.aggregatorsPromise)}getFilterTypes(){return this.filterTypesPromise?this.filterTypesPromise:(this.filterTypesPromise=(0,A.s)(this._get("/api/config/filters").pipe((0,I.T)(t=>t.data?Object.keys(t.data).sort():[]))),this.filterTypesPromise)}transformMetricData(t,s,r,n,c){const l=this.createMetricLabel(t,r,s,n),i=[];return(0,g.each)(t.dps,(o,d)=>{c===2?i.push([o,d*1]):i.push([o,d*1e3])}),{target:l,datapoints:i}}createMetricLabel(t,s,r,n){if(s.alias){const i=(0,g.clone)(n.scopedVars||{});return(0,g.each)(t.tags,(o,d)=>{i["tag_"+d]={value:o}}),this.templateSrv.replace(s.alias,i)}let c=t.metric;const l=[];return(0,g.isEmpty)(t.tags)||(0,g.each)((0,g.toPairs)(t.tags),i=>{(0,g.has)(r,i[0])&&l.push(i[0]+"="+i[1])}),(0,g.isEmpty)(l)||(c+="{"+l.join(", ")+"}"),c}convertTargetToQuery(t,s,r){if(!t.metric||t.hide)return null;const n=this.interpolateVariablesInQuery(t,s.scopedVars);if(t.shouldComputeRate&&(n.rate=!0,n.rateOptions={counter:!!t.isCounter},t.counterMax&&t.counterMax.length&&(n.rateOptions.counterMax=parseInt(t.counterMax,10)),t.counterResetValue&&t.counterResetValue.length&&(n.rateOptions.resetValue=parseInt(t.counterResetValue,10)),r>=2&&(n.rateOptions.dropResets=!n.rateOptions.counterMax&&(!n.rateOptions.ResetValue||n.rateOptions.ResetValue===0))),!t.disableDownsampling){let c=this.templateSrv.replace(t.downsampleInterval||s.interval);c.match(/\.[0-9]+s/)&&(c=parseFloat(c)*1e3+"ms"),n.downsample=c+"-"+t.downsampleAggregator,t.downsampleFillPolicy&&t.downsampleFillPolicy!=="none"&&(n.downsample+="-"+t.downsampleFillPolicy)}return t.explicitTags&&(n.explicitTags=!0),n}interpolateVariablesInFilters(t,s){t.filters=t.filters?.map(r=>(r.tagk=this.templateSrv.replace(r.tagk,s,"pipe"),r.filter=this.templateSrv.replace(r.filter,s,"pipe"),r))}getVariables(){return this.templateSrv.getVariables().map(t=>`$${t.name}`)}mapMetricsToTargets(t,s,r){let n,c;return(0,g.map)(t,l=>r===3?l.query.index:(0,g.findIndex)(s.targets,i=>i.filters&&i.filters.length>0?i.metric===l.metric:i.metric===l.metric&&(0,g.every)(i.tags,(o,d)=>(n=this.templateSrv.replace(o,s.scopedVars,"pipe"),c=n.split("|"),(0,g.includes)(c,l.tags[d])||n==="*"))))}interpolateVariablesInQueries(t,s){return t.length?t.map(r=>this.interpolateVariablesInQuery(r,s)):t}interpolateVariablesInQuery(t,s){const r=(0,g.cloneDeep)(t);if(r.metric=this.templateSrv.replace(t.metric,s,"pipe"),r.aggregator="avg",t.aggregator&&(r.aggregator=this.templateSrv.replace(t.aggregator)),r.filters&&r.filters.length>0)this.interpolateVariablesInFilters(r,s);else if(r.tags)for(const n in r.tags)r.tags[n]=this.templateSrv.replace(r.tags[n],s,"pipe");return r}convertToTSDBTime(t,s,r){return t==="now"?null:Vt.parse(t,s,r)?.valueOf()??null}}const At=new tt.tD(Dt).setQueryEditor(bt).setConfigEditor(ht)}}]);

//# sourceMappingURL=opentsdbPlugin.13757a43402806666939.js.map