{"version":3,"file":"lokiPlugin.42ec79751200c868325e.js","mappings":"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","sources":["webpack://grafana/./public/app/plugins/datasource/loki/components/LokiCheatSheet.tsx","webpack://grafana/./public/app/plugins/datasource/loki/querybuilder/types.ts","webpack://grafana/./public/app/plugins/datasource/loki/querybuilder/binaryScalarOperations.ts","webpack://grafana/./public/app/plugins/datasource/loki/getDerivedFields.ts","webpack://grafana/./public/app/plugins/datasource/loki/makeTableFrames.ts","webpack://grafana/./.yarn/__virtual__/@grafana-lezer-logql-virtual-4170501549/3/opt/drone/yarncache/@grafana-lezer-logql-npm-0.0.19-8d29b942e0-897756b37b.zip/node_modules/@grafana/lezer-logql/index.es.js","webpack://grafana/./public/app/plugins/datasource/loki/types.ts","webpack://grafana/./public/app/plugins/datasource/loki/query_utils.ts","webpack://grafana/./public/app/plugins/datasource/loki/backendResultTransformer.ts","webpack://grafana/./public/app/plugins/datasource/loki/responseUtils.ts","webpack://grafana/./public/app/plugins/datasource/loki/components/LokiOptionFields.tsx","webpack://grafana/./public/app/plugins/datasource/loki/components/AnnotationsQueryEditor.tsx","webpack://grafana/./public/app/plugins/datasource/loki/language_provider.ts","webpack://grafana/../../opt/drone/yarncache/rxjs-npm-7.5.6-8372315abc-fc05f01364.zip/node_modules/rxjs/dist/esm5/internal/observable/dom/WebSocketSubject.js","webpack://grafana/../../opt/drone/yarncache/uuid-npm-8.3.2-eca0baba53-5575a8a75c.zip/node_modules/uuid/dist/esm-browser/parse.js","webpack://grafana/../../opt/drone/yarncache/uuid-npm-8.3.2-eca0baba53-5575a8a75c.zip/node_modules/uuid/dist/esm-browser/sha1.js","webpack://grafana/../../opt/drone/yarncache/uuid-npm-8.3.2-eca0baba53-5575a8a75c.zip/node_modules/uuid/dist/esm-browser/v5.js","webpack://grafana/../../opt/drone/yarncache/uuid-npm-8.3.2-eca0baba53-5575a8a75c.zip/node_modules/uuid/dist/esm-browser/v35.js","webpack://grafana/./public/app/plugins/datasource/loki/live_streams_result_transformer.ts","webpack://grafana/./public/app/plugins/datasource/loki/live_streams.ts","webpack://grafana/../../opt/drone/yarncache/rxjs-npm-7.5.6-8372315abc-fc05f01364.zip/node_modules/rxjs/dist/esm5/internal/observable/dom/webSocket.js","webpack://grafana/./public/app/plugins/datasource/loki/querybuilder/parsing.ts","webpack://grafana/./public/app/plugins/datasource/loki/modifyQuery.ts","webpack://grafana/./public/app/plugins/datasource/loki/queryHints.ts","webpack://grafana/./public/app/plugins/datasource/loki/sortDataFrame.ts","webpack://grafana/./public/app/plugins/datasource/loki/streaming.ts","webpack://grafana/./public/app/plugins/datasource/loki/datasource.ts","webpack://grafana/./public/app/plugins/datasource/loki/querybuilder/components/UnwrapParamEditor.tsx","webpack://grafana/./public/app/plugins/datasource/loki/querybuilder/operations.ts","webpack://grafana/./public/app/plugins/datasource/loki/querybuilder/LokiQueryModeller.ts","webpack://grafana/./public/app/plugins/datasource/loki/querybuilder/state.ts","webpack://grafana/./public/app/plugins/datasource/loki/querybuilder/components/NestedQuery.tsx","webpack://grafana/./public/app/plugins/datasource/loki/querybuilder/components/NestedQueryList.tsx","webpack://grafana/./public/app/plugins/datasource/loki/querybuilder/components/LokiQueryBuilder.tsx","webpack://grafana/./public/app/plugins/datasource/loki/querybuilder/components/QueryPreview.tsx","webpack://grafana/./public/app/plugins/datasource/loki/querybuilder/components/LokiQueryBuilderContainer.tsx","webpack://grafana/./public/app/plugins/datasource/loki/querybuilder/components/LokiQueryBuilderOptions.tsx","webpack://grafana/./public/app/plugins/datasource/loki/components/LokiQueryEditor.tsx","webpack://grafana/./public/app/plugins/datasource/loki/querybuilder/components/LokiQueryBuilderExplained.tsx","webpack://grafana/./public/app/plugins/datasource/loki/querybuilder/components/LokiQueryCodeEditor.tsx","webpack://grafana/./public/app/plugins/datasource/loki/querybuilder/components/LokiQueryEditorSelector.tsx","webpack://grafana/./public/app/plugins/datasource/loki/components/LokiExploreQueryEditor.tsx","webpack://grafana/./public/app/plugins/datasource/loki/components/LokiQueryEditorForAlerting.tsx","webpack://grafana/./public/app/plugins/datasource/loki/components/LokiQueryEditorByApp.tsx","webpack://grafana/./public/app/plugins/datasource/loki/configuration/DebugSection.tsx","webpack://grafana/./public/app/plugins/datasource/loki/configuration/DerivedField.tsx","webpack://grafana/./public/app/plugins/datasource/loki/configuration/DerivedFields.tsx","webpack://grafana/./public/app/plugins/datasource/loki/configuration/MaxLinesField.tsx","webpack://grafana/./public/app/plugins/datasource/loki/configuration/ConfigEditor.tsx","webpack://grafana/./public/app/plugins/datasource/loki/module.ts"],"sourcesContent":["import { shuffle } from 'lodash';\nimport React, { PureComponent } from 'react';\n\nimport { QueryEditorHelpProps } from '@grafana/data';\nimport { reportInteraction } from '@grafana/runtime';\n\nimport LokiLanguageProvider from '../language_provider';\nimport { LokiQuery } from '../types';\n\nconst DEFAULT_EXAMPLES = ['{job=\"default/prometheus\"}'];\nconst PREFERRED_LABELS = ['job', 'app', 'k8s_app'];\nconst EXAMPLES_LIMIT = 5;\n\nconst LOGQL_EXAMPLES = [\n  {\n    title: 'Log pipeline',\n    expression: '{job=\"mysql\"} |= \"metrics\" | logfmt | duration > 10s',\n    label:\n      'This query targets the MySQL job, filters out logs that don’t contain the word \"metrics\" and parses each log line to extract more labels and filters with them.',\n  },\n  {\n    title: 'Count over time',\n    expression: 'count_over_time({job=\"mysql\"}[5m])',\n    label: 'This query counts all the log lines within the last five minutes for the MySQL job.',\n  },\n  {\n    title: 'Rate',\n    expression: 'rate(({job=\"mysql\"} |= \"error\" != \"timeout\")[10s])',\n    label:\n      'This query gets the per-second rate of all non-timeout errors within the last ten seconds for the MySQL job.',\n  },\n  {\n    title: 'Aggregate, count, and group',\n    expression: 'sum(count_over_time({job=\"mysql\"}[5m])) by (level)',\n    label: 'Get the count of logs during the last five minutes, grouping by level.',\n  },\n];\n\nexport default class LokiCheatSheet extends PureComponent<QueryEditorHelpProps<LokiQuery>, { userExamples: string[] }> {\n  declare userLabelTimer: NodeJS.Timeout;\n  state = {\n    userExamples: [],\n  };\n\n  componentDidMount() {\n    this.scheduleUserLabelChecking();\n    reportInteraction('grafana_loki_cheatsheet_opened', {});\n  }\n\n  componentWillUnmount() {\n    clearTimeout(this.userLabelTimer);\n  }\n\n  scheduleUserLabelChecking() {\n    this.userLabelTimer = setTimeout(this.checkUserLabels, 1000);\n  }\n\n  checkUserLabels = async () => {\n    // Set example from user labels\n    const provider: LokiLanguageProvider = this.props.datasource?.languageProvider;\n    if (provider.started) {\n      const labels = provider.getLabelKeys() || [];\n      const preferredLabel = PREFERRED_LABELS.find((l) => labels.includes(l));\n      if (preferredLabel) {\n        const values = await provider.getLabelValues(preferredLabel);\n        const userExamples = shuffle(values)\n          .slice(0, EXAMPLES_LIMIT)\n          .map((value) => `{${preferredLabel}=\"${value}\"}`);\n        this.setState({ userExamples });\n      }\n    } else {\n      this.scheduleUserLabelChecking();\n    }\n  };\n\n  renderExpression(expr: string) {\n    const { onClickExample } = this.props;\n    const onClick = (query: LokiQuery) => {\n      onClickExample(query);\n      reportInteraction('grafana_loki_cheatsheet_example_clicked', {});\n    };\n\n    return (\n      <div className=\"cheat-sheet-item__example\" key={expr} onClick={(e) => onClick({ refId: 'A', expr })}>\n        <code>{expr}</code>\n      </div>\n    );\n  }\n\n  render() {\n    const { userExamples } = this.state;\n    const hasUserExamples = userExamples.length > 0;\n\n    return (\n      <div>\n        <h2>Loki Cheat Sheet</h2>\n        <div className=\"cheat-sheet-item\">\n          <div className=\"cheat-sheet-item__title\">See your logs</div>\n          <div className=\"cheat-sheet-item__label\">\n            Start by selecting a log stream from the Log browser, or alternatively you can write a stream selector into\n            the query field.\n          </div>\n          {hasUserExamples ? (\n            <div>\n              <div className=\"cheat-sheet-item__label\">Here are some example streams from your logs:</div>\n              {userExamples.map((example) => this.renderExpression(example))}\n            </div>\n          ) : (\n            <div>\n              <div className=\"cheat-sheet-item__label\">Here is an example of a log stream:</div>\n              {this.renderExpression(DEFAULT_EXAMPLES[0])}\n            </div>\n          )}\n        </div>\n        <div className=\"cheat-sheet-item\">\n          <div className=\"cheat-sheet-item__title\">Combine stream selectors</div>\n          {this.renderExpression('{app=\"cassandra\",namespace=\"prod\"}')}\n          <div className=\"cheat-sheet-item__label\">Returns all log lines from streams that have both labels.</div>\n        </div>\n\n        <div className=\"cheat-sheet-item\">\n          <div className=\"cheat-sheet-item__title\">Filtering for search terms.</div>\n          {this.renderExpression('{app=\"cassandra\"} |~ \"(duration|latency)s*(=|is|of)s*[d.]+\"')}\n          {this.renderExpression('{app=\"cassandra\"} |= \"exact match\"')}\n          {this.renderExpression('{app=\"cassandra\"} != \"do not match\"')}\n          <div className=\"cheat-sheet-item__label\">\n            <a href=\"https://grafana.com/docs/loki/latest/logql/#log-pipeline\" target=\"logql\">\n              LogQL\n            </a>{' '}\n            supports exact and regular expression filters.\n          </div>\n        </div>\n        {LOGQL_EXAMPLES.map((item) => (\n          <div className=\"cheat-sheet-item\" key={item.expression}>\n            <div className=\"cheat-sheet-item__title\">{item.title}</div>\n            {this.renderExpression(item.expression)}\n            <div className=\"cheat-sheet-item__label\">{item.label}</div>\n          </div>\n        ))}\n      </div>\n    );\n  }\n}\n","import { VisualQueryBinary } from '../../prometheus/querybuilder/shared/LokiAndPromQueryModellerBase';\nimport { QueryBuilderLabelFilter, QueryBuilderOperation } from '../../prometheus/querybuilder/shared/types';\n\n/**\n * Visual query model\n */\nexport interface LokiVisualQuery {\n  labels: QueryBuilderLabelFilter[];\n  operations: QueryBuilderOperation[];\n  binaryQueries?: LokiVisualQueryBinary[];\n}\n\nexport type LokiVisualQueryBinary = VisualQueryBinary<LokiVisualQuery>;\n\nexport interface LokiQueryPattern {\n  name: string;\n  operations: QueryBuilderOperation[];\n}\n\nexport enum LokiVisualQueryOperationCategory {\n  Aggregations = 'Aggregations',\n  RangeFunctions = 'Range functions',\n  Functions = 'Functions',\n  Formats = 'Formats',\n  LineFilters = 'Line filters',\n  LabelFilters = 'Label filters',\n  BinaryOps = 'Binary operations',\n}\n\nexport enum LokiOperationId {\n  Json = 'json',\n  Logfmt = 'logfmt',\n  Regexp = 'regexp',\n  Pattern = 'pattern',\n  Unpack = 'unpack',\n  LineFormat = 'line_format',\n  LabelFormat = 'label_format',\n  Rate = 'rate',\n  CountOverTime = 'count_over_time',\n  SumOverTime = 'sum_over_time',\n  AvgOverTime = 'avg_over_time',\n  MaxOverTime = 'max_over_time',\n  MinOverTime = 'min_over_time',\n  FirstOverTime = 'first_over_time',\n  LastOverTime = 'last_over_time',\n  StdvarOverTime = 'stdvar_over_time',\n  StddevOverTime = 'stddev_over_time',\n  QuantileOverTime = 'quantile_over_time',\n  BytesRate = 'bytes_rate',\n  BytesOverTime = 'bytes_over_time',\n  AbsentOverTime = 'absent_over_time',\n  Sum = 'sum',\n  Avg = 'avg',\n  Min = 'min',\n  Max = 'max',\n  Stddev = 'stddev',\n  Stdvar = 'stdvar',\n  Count = 'count',\n  TopK = 'topk',\n  BottomK = 'bottomk',\n  LineContains = '__line_contains',\n  LineContainsNot = '__line_contains_not',\n  LineMatchesRegex = '__line_matches_regex',\n  LineMatchesRegexNot = '__line_matches_regex_not',\n  LineFilterIpMatches = '__line_filter_ip_matches',\n  LabelFilter = '__label_filter',\n  LabelFilterNoErrors = '__label_filter_no_errors',\n  LabelFilterIpMatches = '__label_filter_ip_marches',\n  Unwrap = 'unwrap',\n  // Binary ops\n  Addition = '__addition',\n  Subtraction = '__subtraction',\n  MultiplyBy = '__multiply_by',\n  DivideBy = '__divide_by',\n  Modulo = '__modulo',\n  Exponent = '__exponent',\n  NestedQuery = '__nested_query',\n  EqualTo = '__equal_to',\n  NotEqualTo = '__not_equal_to',\n  GreaterThan = '__greater_than',\n  LessThan = '__less_than',\n  GreaterOrEqual = '__greater_or_equal',\n  LessOrEqual = '__less_or_equal',\n}\n\nexport enum LokiOperationOrder {\n  LineFilters = 1,\n  LineFormats = 2,\n  LabelFilters = 3,\n  Unwrap = 4,\n  NoErrors = 5,\n  RangeVectorFunction = 5,\n  Last = 6,\n}\n","import { defaultAddOperationHandler } from '../../prometheus/querybuilder/shared/operationUtils';\nimport {\n  QueryBuilderOperation,\n  QueryBuilderOperationDef,\n  QueryBuilderOperationParamDef,\n} from '../../prometheus/querybuilder/shared/types';\n\nimport { LokiOperationId, LokiVisualQueryOperationCategory } from './types';\n\nexport const binaryScalarDefs = [\n  {\n    id: LokiOperationId.Addition,\n    name: 'Add scalar',\n    sign: '+',\n  },\n  {\n    id: LokiOperationId.Subtraction,\n    name: 'Subtract scalar',\n    sign: '-',\n  },\n  {\n    id: LokiOperationId.MultiplyBy,\n    name: 'Multiply by scalar',\n    sign: '*',\n  },\n  {\n    id: LokiOperationId.DivideBy,\n    name: 'Divide by scalar',\n    sign: '/',\n  },\n  {\n    id: LokiOperationId.Modulo,\n    name: 'Modulo by scalar',\n    sign: '%',\n  },\n  {\n    id: LokiOperationId.Exponent,\n    name: 'Exponent',\n    sign: '^',\n  },\n  {\n    id: LokiOperationId.EqualTo,\n    name: 'Equal to',\n    sign: '==',\n    comparison: true,\n  },\n  {\n    id: LokiOperationId.NotEqualTo,\n    name: 'Not equal to',\n    sign: '!=',\n    comparison: true,\n  },\n  {\n    id: LokiOperationId.GreaterThan,\n    name: 'Greater than',\n    sign: '>',\n    comparison: true,\n  },\n  {\n    id: LokiOperationId.LessThan,\n    name: 'Less than',\n    sign: '<',\n    comparison: true,\n  },\n  {\n    id: LokiOperationId.GreaterOrEqual,\n    name: 'Greater or equal to',\n    sign: '>=',\n    comparison: true,\n  },\n  {\n    id: LokiOperationId.LessOrEqual,\n    name: 'Less or equal to',\n    sign: '<=',\n    comparison: true,\n  },\n];\n\n// Not sure about this one. It could also be a more generic 'Simple math operation' where user specifies\n// both the operator and the operand in a single input\nexport const binaryScalarOperations: QueryBuilderOperationDef[] = binaryScalarDefs.map((opDef) => {\n  const params: QueryBuilderOperationParamDef[] = [{ name: 'Value', type: 'number' }];\n  const defaultParams: any[] = [2];\n  if (opDef.comparison) {\n    params.unshift({\n      name: 'Bool',\n      type: 'boolean',\n      description: 'If checked comparison will return 0 or 1 for the value rather than filtering.',\n    });\n    defaultParams.unshift(false);\n  }\n\n  return {\n    id: opDef.id,\n    name: opDef.name,\n    params,\n    defaultParams,\n    alternativesKey: 'binary scalar operations',\n    category: LokiVisualQueryOperationCategory.BinaryOps,\n    renderer: getSimpleBinaryRenderer(opDef.sign),\n    addOperationHandler: defaultAddOperationHandler,\n  };\n});\n\nfunction getSimpleBinaryRenderer(operator: string) {\n  return function binaryRenderer(model: QueryBuilderOperation, def: QueryBuilderOperationDef, innerExpr: string) {\n    let param = model.params[0];\n    let bool = '';\n    if (model.params.length === 2) {\n      param = model.params[1];\n      bool = model.params[0] ? ' bool' : '';\n    }\n\n    return `${innerExpr} ${operator}${bool} ${param}`;\n  };\n}\n","import { groupBy } from 'lodash';\n\nimport { FieldType, DataFrame, ArrayVector, DataLink, Field } from '@grafana/data';\nimport { getDataSourceSrv } from '@grafana/runtime';\n\nimport { DerivedFieldConfig } from './types';\n\nexport function getDerivedFields(dataFrame: DataFrame, derivedFieldConfigs: DerivedFieldConfig[]): Field[] {\n  if (!derivedFieldConfigs.length) {\n    return [];\n  }\n  const derivedFieldsGrouped = groupBy(derivedFieldConfigs, 'name');\n\n  const newFields = Object.values(derivedFieldsGrouped).map(fieldFromDerivedFieldConfig);\n\n  // line-field is the first string-field\n  // NOTE: we should create some common log-frame-extra-string-field code somewhere\n  const lineField = dataFrame.fields.find((f) => f.type === FieldType.string);\n\n  if (lineField === undefined) {\n    // if this is happening, something went wrong, let's raise an error\n    throw new Error('invalid logs-dataframe, string-field missing');\n  }\n\n  lineField.values.toArray().forEach((line) => {\n    for (const field of newFields) {\n      const logMatch = line.match(derivedFieldsGrouped[field.name][0].matcherRegex);\n      field.values.add(logMatch && logMatch[1]);\n    }\n  });\n\n  return newFields;\n}\n\n/**\n * Transform derivedField config into dataframe field with config that contains link.\n */\nfunction fieldFromDerivedFieldConfig(derivedFieldConfigs: DerivedFieldConfig[]): Field<any, ArrayVector> {\n  const dataSourceSrv = getDataSourceSrv();\n\n  const dataLinks = derivedFieldConfigs.reduce((acc, derivedFieldConfig) => {\n    // Having field.datasourceUid means it is an internal link.\n    if (derivedFieldConfig.datasourceUid) {\n      const dsSettings = dataSourceSrv.getInstanceSettings(derivedFieldConfig.datasourceUid);\n\n      acc.push({\n        // Will be filled out later\n        title: derivedFieldConfig.urlDisplayLabel || '',\n        url: '',\n        // This is hardcoded for Jaeger or Zipkin not way right now to specify datasource specific query object\n        internal: {\n          query: { query: derivedFieldConfig.url },\n          datasourceUid: derivedFieldConfig.datasourceUid,\n          datasourceName: dsSettings?.name ?? 'Data source not found',\n        },\n      });\n    } else if (derivedFieldConfig.url) {\n      acc.push({\n        // We do not know what title to give here so we count on presentation layer to create a title from metadata.\n        title: derivedFieldConfig.urlDisplayLabel || '',\n        // This is hardcoded for Jaeger or Zipkin not way right now to specify datasource specific query object\n        url: derivedFieldConfig.url,\n      });\n    }\n    return acc;\n  }, [] as DataLink[]);\n\n  return {\n    name: derivedFieldConfigs[0].name,\n    type: FieldType.string,\n    config: {\n      links: dataLinks,\n    },\n    // We are adding values later on\n    values: new ArrayVector<string>([]),\n  };\n}\n","import { groupBy } from 'lodash';\n\nimport { DataFrame, Field, FieldType, ArrayVector } from '@grafana/data';\n\nexport function makeTableFrames(instantMetricFrames: DataFrame[]): DataFrame[] {\n  // first we remove frames that have no refId\n  // (we will group them by refId, so we need it to be set)\n  const framesWithRefId = instantMetricFrames.filter((f) => f.refId !== undefined);\n\n  const framesByRefId = groupBy(framesWithRefId, (frame) => frame.refId);\n\n  return Object.entries(framesByRefId).map(([refId, frames]) => makeTableFrame(frames, refId));\n}\n\ntype NumberField = Field<number, ArrayVector<number>>;\ntype StringField = Field<string, ArrayVector<string>>;\n\nfunction makeTableFrame(instantMetricFrames: DataFrame[], refId: string): DataFrame {\n  const tableTimeField: NumberField = { name: 'Time', config: {}, values: new ArrayVector(), type: FieldType.time };\n  const tableValueField: NumberField = {\n    name: `Value #${refId}`,\n    config: {},\n    values: new ArrayVector(),\n    type: FieldType.number,\n  };\n\n  // Sort metric labels, create columns for them and record their index\n  const allLabelNames = new Set(\n    instantMetricFrames.map((frame) => frame.fields.map((field) => Object.keys(field.labels ?? {})).flat()).flat()\n  );\n\n  const sortedLabelNames = Array.from(allLabelNames).sort();\n\n  const labelFields: StringField[] = sortedLabelNames.map((labelName) => ({\n    name: labelName,\n    config: { filterable: true },\n    values: new ArrayVector(),\n    type: FieldType.string,\n  }));\n\n  instantMetricFrames.forEach((frame) => {\n    const timeField = frame.fields.find((field) => field.type === FieldType.time);\n    const valueField = frame.fields.find((field) => field.type === FieldType.number);\n    if (timeField == null || valueField == null) {\n      return;\n    }\n\n    const timeArray = timeField.values.toArray();\n    const valueArray = valueField.values.toArray();\n\n    for (let x of timeArray) {\n      tableTimeField.values.add(x);\n    }\n\n    for (let x of valueArray) {\n      tableValueField.values.add(x);\n    }\n\n    const labels = valueField.labels ?? {};\n\n    for (let f of labelFields) {\n      const text = labels[f.name] ?? '';\n      // we insert the labels as many times as we have values\n      for (let i = 0; i < valueArray.length; i++) {\n        f.values.add(text);\n      }\n    }\n  });\n\n  return {\n    fields: [tableTimeField, ...labelFields, tableValueField],\n    refId,\n    meta: { preferredVisualisationType: 'table' },\n    length: tableTimeField.values.length,\n  };\n}\n","import { LRParser } from '@lezer/lr';\n\n// This file was generated by lezer-generator. You probably shouldn't edit it.\nconst Json$1 = 1,\n  Logfmt$1 = 2,\n  Unpack$1 = 3,\n  Pattern$1 = 4,\n  Regexp$1 = 5,\n  Unwrap$1 = 6,\n  Ip$1 = 7,\n  LabelFormat$1 = 8,\n  LineFormat$1 = 9,\n  LabelReplace$1 = 10,\n  Offset$1 = 11,\n  Bool$1 = 12,\n  On$1 = 13,\n  Ignoring$1 = 14,\n  GroupLeft$1 = 15,\n  GroupRight$1 = 16,\n  By$1 = 17,\n  Without$1 = 18,\n  And$1 = 19,\n  Or$1 = 20,\n  Unless$1 = 21,\n  Sum$1 = 22,\n  Avg$1 = 23,\n  Count$1 = 24,\n  Max$1 = 25,\n  Min$1 = 26,\n  Stddev$1 = 27,\n  Stdvar$1 = 28,\n  Bottomk$1 = 29,\n  Topk$1 = 30;\n\nconst keywordTokens = {\n    json: Json$1,\n    logfmt : Logfmt$1,\n    unpack: Unpack$1,\n    pattern : Pattern$1,\n    regexp : Regexp$1,\n    ip : Ip$1,\n    label_format : LabelFormat$1,\n    line_format : LineFormat$1,\n    label_replace: LabelReplace$1,\n    offset: Offset$1,\n    bool: Bool$1,\n    on: On$1,\n    ignoring: Ignoring$1,\n    group_left: GroupLeft$1,\n    group_right: GroupRight$1,\n    unwrap: Unwrap$1,\n};\n\nconst specializeIdentifier = (value, stack) => {\n    return keywordTokens[value.toLowerCase()] || -1;\n};\n\n\nconst contextualKeywordTokens = {\n    by: By$1,\n    without: Without$1,\n    and: And$1,\n    or: Or$1,\n    unless: Unless$1,\n    sum: Sum$1,\n    avg: Avg$1,\n    count: Count$1,\n    max: Max$1,\n    min: Min$1,\n    stddev: Stddev$1,\n    stdvar: Stdvar$1,\n    bottomk: Bottomk$1,\n    topk: Topk$1\n};\n\nconst extendIdentifier = (value, stack) => {\n    return contextualKeywordTokens[value.toLowerCase()] || -1;\n};\n\n// This file was generated by lezer-generator. You probably shouldn't edit it.\nconst spec_Identifier = {__proto__:null,count_over_time:255, rate:257, bytes_over_time:259, bytes_rate:261, avg_over_time:263, sum_over_time:265, min_over_time:267, max_over_time:269, stddev_over_time:271, stdvar_over_time:273, quantile_over_time:275, first_over_time:277, last_over_time:279, absent_over_time:281, bytes:287, duration:289, duration_seconds:291};\nconst parser = LRParser.deserialize({\n  version: 13,\n  states: \"ASOYQPOOO#VQPO'#DPO$fQPO'#DOOYQPO'#DOOOQO'#D{'#D{O$sQPO'#DzOOQO'#Eg'#EgO$xQPO'#EfQ%TQPOOOOQO'#Eu'#EuO&UQPO'#EuO&ZQPO'#EvOOQO'#Dy'#DyOOQO'#C}'#C}OOQO'#D|'#D|OOQO'#D}'#D}OOQO'#EO'#EOOOQO'#EP'#EPOOQO'#EQ'#EQOOQO'#ER'#EROOQO'#ES'#ESOOQO'#ET'#ETOOQO'#EU'#EUOOQO'#EV'#EVOOQO'#EW'#EWOOQO'#EX'#EXOOQO'#EY'#EYOOQO'#EZ'#EZO&`QPO'#DROOQO'#DQ'#DQO&nQPO,59kOOQO'#D^'#D^O&vQPO'#D]OOQO'#D['#D[O'OQPO'#DZO(iQPO'#DZOOQO'#DY'#DYO*bQPO,59jO+pQPO,59jO+wQPO,5:eO,OQPO,5:fO,ZQPO'#EdO.YQPO,5;QO.aQPO,5;QO.fQPO,5;SO.fQPO,5;SO.fQPO,5;SO.fQPO,5;SO.fQPO,5;SO.fQPO,5;SOOQO,5;a,5;aOYQPO,5;bO0lQPO,59mO0qQPO1G/VOOQO1G/V1G/VOOQO'#Da'#DaOOQO,59w,59wO0yQPO,59wOOQO,59v,59vO1OQPO'#DRO1mQPO'#DcOOQO'#Dc'#DcO3ZQPO'#DcOOQO'#Di'#DiOOQO'#Dg'#DgO)OQPO'#DgO3`QPO,59uO4yQPO'#DuO5OQPO'#DvOOQO,59u,59uOOQO,59t,59tOOQO1G/U1G/UOOQO1G0P1G0PO5TQPO'#E[O,RQPO'#E[O5iQPO1G0QO5nQPO1G0QO5sQPO,5;OO5{QPO1G0lO7WQPO1G0lO7_QPO1G0lO7fQPO'#EjO9hQPO'#EiO9rQPO'#EiOYQPO1G0nOYQPO1G0nOYQPO1G0nOYQPO1G0nOYQPO1G0nOYQPO1G0nO9|QPO1G0|OOQO1G/X1G/XOOQO1G/W1G/WOOQO7+$q7+$qO:TQPO1G/cO:YQPO,59mO:`QPO,5:UO:kQPO'#DfOOQO'#De'#DeO:pQPO,5:OOOQO,59},59}O<ZQPO,5:RO)OQPO,5:RO)OQPO,5:ROOQO,5:a,5:aO<iQPO'#DxOOQO'#Dw'#DwO<nQPO,5:bO>XQPO'#DZO5TQPO,5:vO>`QPO'#E]O>eQPO,5:vO?OQPO,5:vO?YQPO,5:vO?aQPO,5:vO?fQPO7+%lO,RQPO7+%lOOQO'#Ee'#EeO@vQPO1G0jOOQO1G0j1G0jOAOQPO7+&WOYQPO7+&WOB`QPO7+&WOBgQPO7+&WOBnQQO'#EkOOQO,5;U,5;UODpQPO,5;TODwQPO,5;TOFYQPO7+&YOFaQPO7+&YOOQO7+&Y7+&YOFnQPO7+&YOFuQPO7+&YOGzQPO7+&YOH[QPO7+&hOHaQPO7+$}OHfQPO1G/nOOQO1G/p1G/pOOQO1G/w1G/wOOQO1G/y1G/yOHkQPO,5:QOHpQPO,5:POOQO1G/m1G/mOHuQPO1G/mOJ`QPO,5:dO5OQPO,5:cOJhQPO,5:yO>eQPO1G0bOJvQPO1G0bOKOQPO,5:wO)OQPO,5:yOKTQPO1G0bOK[QPO'#E^OKaQPO1G0bOKTQPO1G0bOKiQPO1G0bOKpQPO1G0bO5dQPO1G0bOOQO1G0b1G0bOOQO<<IW<<IWOK{QPO<<IWOLQQPO,5;POOQO7+&U7+&UOOQO<<Ir<<IrOLVQPO<<IrOYQPO<<IrOOQO'#Em'#EmOL^QPO,5;VOOQO'#El'#ElOOQO,5;V,5;VOOQO1G0o1G0oOLfQPO1G0oONcQPO<<JSOOQO<<Hi<<HiONhQPO7+%YOOQO1G/l1G/lOOQO1G/k1G/kOOQO1G0O1G0OOOQO1G/}1G/}OOQO'#E`'#E`OOQO1G0e1G0eONmQPO1G0eOOQO'#Ea'#EaOOQO'#Eb'#EbOOQO'#Ec'#EcOOQO7+%|7+%|OOQO1G0c1G0cONrQPO1G0eO! WQPO7+%|OOQO,5:x,5:xO! `QPO7+%|O5dQPO7+%|O! gQPO7+%|O! rQPOAN>rOOQO1G0k1G0kO!#SQPOAN?^O!$dQPOAN?^O!$kQQO1G0qOOQO1G0q1G0qOOQO7+&Z7+&ZO!$sQPOAN?nO!$xQPO<<HtO!$}QPO7+&PO!%SQPO<<IhO!%[QPO<<IhO!%dQPO<<IhO!%lQPO'#E_OOQO<<Ih<<IhOOQOG24^G24^OOQOG24xG24xOOQO1G0r1G0rOOQO7+&]7+&]O!%qQPOG25YOOQOAN>`AN>`O!%vQPO<<IkOOQOAN?SAN?SO!%{QPOAN?SO!&TQPOLD*tOOQOAN?VAN?VOOQO,5:b,5:bO!&YQPO!$'N`O!&_QPO!)9CzO!&dQPO!.K9fOOQO!4//Q!4//QO5OQPO'#DvO!&iQPO'#DZO!'WQPO,59jO!'bQPO'#DOOYQPO1G0nOYQPO1G0nOYQPO1G0nOYQPO1G0nOYQPO1G0nOYQPO1G0nO.fQPO,5;SO.fQPO,5;SO.fQPO,5;SO.fQPO,5;SO.fQPO,5;SO.fQPO,5;SO!(mQPO7+&YO!(tQPO7+&YO!)RQPO7+&YO!*ZQPO7+&YO!*bQPO7+&YO!)YQPO'#Eh\",\n  stateData: \"!*o~O#mOSoOS~OYZOfUOgUOhUOiUOjUOkUOlUOmUOnUO!hXO#cYO#dYO#nPO#qRO#s^O#t_O#u`O#vaO#wbO#xcO#ydO#zeO#{fO#|gO#}hO$OiO$PjO$QkO~OvlO~OyoO{oO!RoO!SoOcrXdrXerX!_rX!arX!brX!crX!drX#crX#drX#erX#frX#grX#hrX~O!UsO#krX#rrX~P#[O#qxO~OayObyO#qzO~Oc}Od|Oe}Oy!RO!_!RO!a!RO!b!RO!c!RO!d!RO#c!OO#d!OO#e!PO#f!PO#g!PO#h!QO~O!h!SO~O#q!TO~Ow!UOy!UOz!UO{!UO~O#o!VO#p!WO~OV!XOx!YO~OyoO{oO!RoO!SoOc}Xd}Xe}X!U}X!_}X!a}X!b}X!c}X!d}X#c}X#d}X#e}X#f}X#g}X#h}X#k}X#r}X$R}X#o}X~OP!^OQ!_OR!_OS!`OT!`OW!fOX!eOv!]O#q!cO~OyoO{oO!RoO!SoOcradraera!_ra!ara!bra!cra!dra#cra#dra#era#fra#gra#hra~O!UsO#kra#rra~P)WOcqXdqXeqXyqX!_qX!aqX!bqX!cqX!dqX#cqX#dqX#eqX#fqX#gqX#hqX~O#r!iO~P*oO#r!jO~P*oO!h!nO#nPO#q!lO~O#q!oO~OYZOfUOgUOhUOiUOjUOkUOlUOmUOnUO#cYO#dYO#nPO#qRO#s^O#t_O#u`O#vaO#wbO#xcO#ydO#zeO#{fO#|gO#}hO$OiO$PjO$QkO~O!h!qO~P,`O#q!rO~O[!uO]!sO^!sOY#]Pf#]Pg#]Ph#]Pi#]Pj#]Pk#]Pl#]Pm#]Pn#]P!h#]P#c#]P#d#]P#n#]P#q#]P#s#]P#t#]P#u#]P#v#]P#w#]P#x#]P#y#]P#z#]P#{#]P#|#]P#}#]P$O#]P$P#]P$Q#]P~Ox!}O~OvlO#p#PO~O#q#QO~Ow#ROy#ROz!UO{!UO!_#SO!a#SO!b#SO!c#SO!d#SO~Ov#TOc!VXd!VXe!VXy!VX{!VX!R!VX!S!VX!U!VX!_!VX!a!VX!b!VX!c!VX!d!VX#c!VX#d!VX#e!VX#f!VX#g!VX#h!VX#k!VX#r!VX$R!VX#o!VX~Ox#WO~Oc#YOd#ZO#o#YOe}ay}a{}a!R}a!S}a!U}a!_}a!a}a!b}a!c}a!d}a#c}a#d}a#e}a#f}a#g}a#h}a#k}a#r}a$R}a~Ox#[O~Ov#]O~OyoO{oO!RoO!SoO!U#`O$R#bO~O#r#gO~O#o#hO~Ov#iO#r#kO~O#r#lO~P*oOc#iXd#iXe#iXy#iX!_#iX!a#iX!b#iX!c#iX!d#iX#c#iX#d#iX#e#iX#f#iX#g#iX#h#iX#r#iX~O#o#mO~P6SO!h#oO~P,`O#q#pO~OY#]Xf#]Xg#]Xh#]Xi#]Xj#]Xk#]Xl#]Xm#]Xn#]X!h#]X#c#]X#d#]X#n#]X#q#]X#s#]X#t#]X#u#]X#v#]X#w#]X#x#]X#y#]X#z#]X#{#]X#|#]X#}#]X$O#]X$P#]X$Q#]X~O_#rO`#rO~P7kO]!sO^!sO~P7kO#o#zO~P*oOx#{O~OV#|Ox!}O!`#}O!f$OO!h$PO~Ow$QO~O#o$ROc!Wad!Wae!Way!Wa{!Wa!R!Wa!S!Wa!U!Wa!_!Wa!a!Wa!b!Wa!c!Wa!d!Wa#c!Wa#d!Wa#e!Wa#f!Wa#g!Wa#h!Wa#k!Wa#r!Wa$R!Wa~Oc#YOd#ZO#o#YO#r$SO~Ow$UO~O#o$VOc!jad!jae!jay!ja{!ja!R!ja!S!ja!U!ja!_!ja!a!ja!b!ja!c!ja!d!ja#c!ja#d!ja#e!ja#f!ja#g!ja#h!ja#k!ja#r!ja$R!ja~OU$WO~P(iO!`$ZO~O!U$[O$R#bO~OyoO{oO!RoO!SoO!U#`O~OZ$^O#r#Oa~P>mO#r$cO~P5TO#r$dO~OayObyOc!nqd!nqe!nqy!nq!_!nq!a!nq!b!nq!c!nq!d!nq#c!nq#d!nq#e!nq#f!nq#g!nq#h!nq#k!nq#r!nq#o!nq~O#o$gO#r$hO~OayObyOc#Yqd#Yqe#Yqy#Yq!_#Yq!a#Yq!b#Yq!c#Yq!d#Yq#c#Yq#d#Yq#e#Yq#f#Yq#g#Yq#h#Yq#k#Yq#r#Yq#o#Yq~O#r$iO~P*oO#o$kO~P6SO#b$lO#r$oO~OY#]af#]ag#]ah#]ai#]aj#]ak#]al#]am#]an#]a!h#]a#c#]a#d#]a#n#]a#s#]a#t#]a#u#]a#v#]a#w#]a#x#]a#y#]a#z#]a#{#]a#|#]a#}#]a$O#]a$P#]a$Q#]a~O#q#pO~PBvO_$qO`$qO#q#]a~PBvOc}Oe}Oy!RO!_!RO!a!RO!b!RO!c!RO!d!RO#c!OO#d!OO#e#[q#f#[q#g#[q#h#[q#k#[q#r#[q~Od#[q~PEUOc#[qd#[qe#[q~PE[Od|O~PEUO#k#[q#r#[q~P%TOc#[qd#[qe#[qy#[q!_#[q!a#[q!b#[q!c#[q!d#[q#e#[q#f#[q#g#[q#h#[q~O#c!OO#d!OO#k#[q#r#[q~PGPOx$rO~O#r$sO~O#q$tO~Ox$uO~Ov#TO~Oc#YO#o#YOd!Zie!Ziy!Zi{!Zi!R!Zi!S!Zi!U!Zi!_!Zi!a!Zi!b!Zi!c!Zi!d!Zi#c!Zi#d!Zi#e!Zi#f!Zi#g!Zi#h!Zi#k!Zi#r!Zi$R!Zi~Ov$wOx$wO~Ov$zO$T$|O$U$}O$V%OO~OZ$^O#r#Oi~O$S%QO~O#r#Oi~P>mO!`%TO~O!U$[O#r#Oi~O#r%VO~P5TO!U$[O#r%VO$R#bO~O#r%XO~Ov%YO~O#r%ZO~P*oO#o%]O#r%^O~O#q#pOY#]if#]ig#]ih#]ii#]ij#]ik#]il#]im#]in#]i!h#]i#c#]i#d#]i#n#]i#s#]i#t#]i#u#]i#v#]i#w#]i#x#]i#y#]i#z#]i#{#]i#|#]i#}#]i$O#]i$P#]i$Q#]i~O#o%`O~Ox%aO~O#q%bO~Oc#YOd#ZO#o#YO!U#Ri$R#Ri#r#Ri~O!U$[O#r#Oq~O#r#Oq~P>mOZ%eO!U%fO#r#Oq~OayObyOc!n!Rd!n!Re!n!Ry!n!R!_!n!R!a!n!R!b!n!R!c!n!R!d!n!R#c!n!R#d!n!R#e!n!R#f!n!R#g!n!R#h!n!R#k!n!R#r!n!R#o!n!R~OayObyOc#Y!Rd#Y!Re#Y!Ry#Y!R!_#Y!R!a#Y!R!b#Y!R!c#Y!R!d#Y!R#c#Y!R#d#Y!R#e#Y!R#f#Y!R#g#Y!R#h#Y!R#k#Y!R#r#Y!R#o#Y!R~O#r%iO~P*oO#b$lO#r%kO~Ox%lO~O#r%mO~Ov%nO~O!U$[O#r#Oy~OZ$^O#r#Oy~O!U%fO!`%TO~OU$WO~O#o%qO~O#r%rO~O!U$[O#r#O!R~Ox%tO~O#o%uO~Ox%vO~O#r%wO~OP!^OQ!_OR!_OS!`OT!`OW%xOX!eOv!]O#q!cO~O!U%yO#ora~P)WO!U%yO#orX~P#[Oc&TOe&TOy&XO!_&XO!a&XO!b&XO!c&XO!d&XO#c&UO#d&UO#e#[q#f#[q#g#[q#h#[q#o#[q~Od#[q~P!'lOc#[qd#[qe#[q~P!'rOd&SO~P!'lOc&TOd&SOe&TOy&XO!_&XO!a&XO!b&XO!c&XO!d&XO#c&UO#d&UO#e&VO#f&VO#g&VO#h&WO~O#o#[q~P!)YO#c&UO#d&UO#o#[q~PGPO\",\n  goto: \"/]#kPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPP#l$k%S%r%uPPPPPP&U&h&x'W'iPP'xP'{'{(Q(T(Z(l(l(uPPPPPP(uP(lP'{'{)O)U)]*O*e*z*z*z*z*z*z*z*z*z*z*z*z*z*z+a+j+},Z,s,v,v,v,y-Y*O-]*O-r.h.y/S/VPPPPPPP*O*O[WORz!r#m$kQ#t!vQ#u!wS#v!x&OQ#w!yQ#x!zQ#y!{Q&Y%|Q&Z%}Q&[&PQ&]&QQ&^&RR&_!Tt]Oz!T!r!v!w!x!y!z!{#m$k%|%}&O&P&Q&RRvRjQORz!T!r!v!w!x!y!z!{#m$kS!kx#hQ#e!l]%{%|%}&O&P&Q&RRnPQmP^!bs!c#Y#Z#`$[%yR#O!VQuQQ#a!kQ$]#dQ$a#eQ%U$`R%z%{[tQ!k#d#e$`%{]!hu#a$]$a%U%zirQu!k#a#d#e$]$`$a%U%z%{hqQu!k#a#d#e$]$`$a%U%z%{R![rkpQru!k#a#d#e$]$`$a%U%z%{R!ZpV!gs#`%yR#V!^Q#U!^R$v$RU!ds#`%yQ#X!cQ$S#YQ$T#ZR%R$[_!bs!c#Y#Z#`$[%y_!as!c#Y#Z#`$[%yQ#_!fR%s%xS#^!f%xR$x$Vj]O!v!w!x!y!z!{%|%}&O&P&Q&RQwRQ!pzQ!|!TQ#n!rQ$j#mR%[$kw[ORz!T!r!v!w!x!y!z!{#m$k%|%}&O&P&Q&RwTORz!T!r!v!w!x!y!z!{#m$k%|%}&O&P&Q&RwSORz!T!r!v!w!x!y!z!{#m$k%|%}&O&P&Q&RQ!mxQ#f!lR$f#hS#d!k#eW$Y#a#c$a$bQ%P$XQ%W$cR%d%VQ$`#dQ%P$YQ%g%WR%o%dQ#c!kS$X#a$aQ$_#dQ$b#eS%S$]$`S%c%U%WR%p%eR${$WR$y$WQ{VQ$e#gQ$i#lQ%h%XR%i%ZR#j!owVORz!T!r!v!w!x!y!z!{#m$k%|%}&O&P&Q&RQ!v|Q!w}Q!x!OQ!y!PQ!z!QQ!{!RQ%|&SQ%}&TQ&O&UQ&P&VQ&Q&WR&R&Xh!t|}!O!P!Q!R&S&T&U&V&W&XR#s!uQ#q!sQ$p#rR%_$qR$m#pQ$n#pR%j%]\",\n  nodeNames: \"⚠ Json Logfmt Unpack Pattern Regexp Unwrap Ip LabelFormat LineFormat LabelReplace Offset Bool On Ignoring GroupLeft GroupRight By Without And Or Unless Sum Avg Count Max Min Stddev Stdvar Bottomk Topk LineComment LogQL Expr LogExpr Selector Matchers Matcher Identifier Eq String Neq Re Nre PipelineExpr PipelineStage LineFilters LineFilter Filter PipeExact PipeMatch FilterOp Pipe LabelParser JsonExpressionParser JsonExpressionList JsonExpression LabelFilter IpLabelFilter UnitFilter DurationFilter Gtr Duration Gte Lss Lte Eql BytesFilter Bytes NumberFilter Number LineFormatExpr LabelFormatExpr LabelsFormat LabelFormatMatcher MetricExpr RangeAggregationExpr RangeOp CountOverTime Rate BytesOverTime BytesRate AvgOverTime SumOverTime MinOverTime MaxOverTime StddevOverTime StdvarOverTime QuantileOverTime FirstOverTime LastOverTime AbsentOverTime LogRangeExpr Range OffsetExpr UnwrapExpr ConvOp BytesConv DurationConv DurationSecondsConv Grouping Labels VectorAggregationExpr VectorOp BinOpExpr BinOpModifier OnOrIgnoringModifier GroupingLabels GroupingLabelList GroupingLabel LabelName Add Sub Mul Div Mod Pow LiteralExpr LabelReplaceExpr\",\n  maxTerm: 145,\n  skippedNodes: [0,31],\n  repeatNodeCount: 0,\n  tokenData: \"3X~RvX^#ipq#iqr$^rs$qst%cuv%nxy%syz%xz{%}{|&S|}&X}!O&^!O!P&c!P!Q'c!Q!R'h!R![)O![!]0O!^!_0d!_!`0q!`!a1W!c!}1e!}#O1{#P#Q2Q#Q#R2V#R#S1e#S#T2[#T#o1e#o#p2h#p#q2m#q#r3S#y#z#i$f$g#i#BY#BZ#i$IS$I_#i$I|$JO#i$JT$JU#i$KV$KW#i&FU&FV#i~#nY#m~X^#ipq#i#y#z#i$f$g#i#BY#BZ#i$IS$I_#i$I|$JO#i$JT$JU#i$KV$KW#i&FU&FV#i~$aQ!_!`$g#r#s$l~$lOy~~$qO{~~$tUOY$qZr$qrs%Ws#O$q#O#P%]#P~$q~%]Ox~~%`PO~$q~%hQo~OY%cZ~%c~%sO#g~~%xO#q~~%}O#r~~&SO#e~~&XO#c~~&^O#o~~&cO#d~~&fP!Q![&i~&nR!h~!Q![&i!g!h&w#X#Y&w~&zR{|'T}!O'T!Q!['Z~'WP!Q!['Z~'`P!h~!Q!['Z~'hO#f~~'me!h~!O!P&i!Q![)O!g!h*c!i!j+Q!m!n+Q!o!p+Q!r!s+Q!v!w+Q#U#V*u#W#X+Z#X#Y-]#Z#[-o#[#]+r#_#`-o#a#b-x#d#e-o#g#h,z#h#i-o#k#l.Z#l#m/d#m#n.u~)Td!h~!O!P&i!Q![)O!g!h*c!i!j+Q!m!n+Q!o!p+Q!r!s+Q!v!w+Q#U#V*u#W#X+Z#X#Y-]#Z#[-o#[#]+r#_#`-o#a#b-x#d#e-o#g#h,z#h#i-o#k#l.Z#m#n.u~*fT{|'T}!O'T!Q!['Z!d!e*u#]#^*z~*zO!f~~*}P#U#V*u~+TQ!d!e*u#]#^*z~+`P!`~!Q![+c~+fS!Q![+c#[#]+r#a#b,W#g#h,z~+wP!`~!Q![+z~+}R!Q![+z#a#b,W#g#h,z~,]Q!`~!Q![,c#g#h,u~,fR!Q![,c#a#b,o#g#h,z~,rP#g#h,u~,zO!`~~-PP!`~!Q![-S~-VQ!Q![-S#a#b,o~-`T{|'T}!O'T!Q!['Z#U#V*u#]#^*z~-rQ#U#V*u#]#^*z~-}S!`~!Q![,c#U#V*u#]#^*z#g#h,u~.`P!`~!Q![.c~.fT!Q![.c#W#X+Z#[#]+r#a#b,W#g#h,z~.zP!`~!Q![.}~/QU!Q![.}#W#X+Z#[#]+r#a#b,W#g#h,z#k#l.Z~/gR!Q![/p!c!i/p#T#Z/p~/uR!h~!Q![/p!c!i/p#T#Z/pP0TTvP!Q![0O![!]0O!c!}0O#R#S0O#T#o0O~0iP!b~!_!`0l~0qO!c~~0vQw~!_!`0|#r#s1R~1RO!d~~1WOz~~1]P!_~!_!`1`~1eO!a~R1lTvP#bQ!Q![1e![!]0O!c!}1e#R#S1e#T#o1e~2QO$R~~2VO$S~~2[O#h~~2_RO#S2[#S#T%W#T~2[~2mO#n~~2rQ!U~!_!`2x#r#s2}~2}O!R~~3SO!S~~3XO#p~\",\n  tokenizers: [0, 1],\n  topRules: {\"LogQL\":[0,32]},\n  specialized: [{term: 38, get: (value, stack) => (specializeIdentifier(value) << 1)},{term: 38, get: (value, stack) => (extendIdentifier(value) << 1) | 1},{term: 38, get: value => spec_Identifier[value] || -1}],\n  tokenPrec: 0\n});\n// This file was generated by lezer-generator. You probably shouldn't edit it.\nconst Json = 1,\n  Logfmt = 2,\n  Unpack = 3,\n  Pattern = 4,\n  Regexp = 5,\n  Unwrap = 6,\n  Ip = 7,\n  LabelFormat = 8,\n  LineFormat = 9,\n  LabelReplace = 10,\n  Offset = 11,\n  Bool = 12,\n  On = 13,\n  Ignoring = 14,\n  GroupLeft = 15,\n  GroupRight = 16,\n  By = 17,\n  Without = 18,\n  And = 19,\n  Or = 20,\n  Unless = 21,\n  Sum = 22,\n  Avg = 23,\n  Count = 24,\n  Max = 25,\n  Min = 26,\n  Stddev = 27,\n  Stdvar = 28,\n  Bottomk = 29,\n  Topk = 30,\n  LineComment = 31,\n  LogQL = 32,\n  Expr = 33,\n  LogExpr = 34,\n  Selector = 35,\n  Matchers = 36,\n  Matcher = 37,\n  Identifier = 38,\n  Eq = 39,\n  String = 40,\n  Neq = 41,\n  Re = 42,\n  Nre = 43,\n  PipelineExpr = 44,\n  PipelineStage = 45,\n  LineFilters = 46,\n  LineFilter = 47,\n  Filter = 48,\n  PipeExact = 49,\n  PipeMatch = 50,\n  FilterOp = 51,\n  Pipe = 52,\n  LabelParser = 53,\n  JsonExpressionParser = 54,\n  JsonExpressionList = 55,\n  JsonExpression = 56,\n  LabelFilter = 57,\n  IpLabelFilter = 58,\n  UnitFilter = 59,\n  DurationFilter = 60,\n  Gtr = 61,\n  Duration = 62,\n  Gte = 63,\n  Lss = 64,\n  Lte = 65,\n  Eql = 66,\n  BytesFilter = 67,\n  Bytes = 68,\n  NumberFilter = 69,\n  Number = 70,\n  LineFormatExpr = 71,\n  LabelFormatExpr = 72,\n  LabelsFormat = 73,\n  LabelFormatMatcher = 74,\n  MetricExpr = 75,\n  RangeAggregationExpr = 76,\n  RangeOp = 77,\n  CountOverTime = 78,\n  Rate = 79,\n  BytesOverTime = 80,\n  BytesRate = 81,\n  AvgOverTime = 82,\n  SumOverTime = 83,\n  MinOverTime = 84,\n  MaxOverTime = 85,\n  StddevOverTime = 86,\n  StdvarOverTime = 87,\n  QuantileOverTime = 88,\n  FirstOverTime = 89,\n  LastOverTime = 90,\n  AbsentOverTime = 91,\n  LogRangeExpr = 92,\n  Range = 93,\n  OffsetExpr = 94,\n  UnwrapExpr = 95,\n  ConvOp = 96,\n  BytesConv = 97,\n  DurationConv = 98,\n  DurationSecondsConv = 99,\n  Grouping = 100,\n  Labels = 101,\n  VectorAggregationExpr = 102,\n  VectorOp = 103,\n  BinOpExpr = 104,\n  BinOpModifier = 105,\n  OnOrIgnoringModifier = 106,\n  GroupingLabels = 107,\n  GroupingLabelList = 108,\n  GroupingLabel = 109,\n  LabelName = 110,\n  Add = 111,\n  Sub = 112,\n  Mul = 113,\n  Div = 114,\n  Mod = 115,\n  Pow = 116,\n  LiteralExpr = 117,\n  LabelReplaceExpr = 118;\n\nexport { AbsentOverTime, Add, And, Avg, AvgOverTime, BinOpExpr, BinOpModifier, Bool, Bottomk, By, Bytes, BytesConv, BytesFilter, BytesOverTime, BytesRate, ConvOp, Count, CountOverTime, Div, Duration, DurationConv, DurationFilter, DurationSecondsConv, Eq, Eql, Expr, Filter, FilterOp, FirstOverTime, GroupLeft, GroupRight, Grouping, GroupingLabel, GroupingLabelList, GroupingLabels, Gte, Gtr, Identifier, Ignoring, Ip, IpLabelFilter, Json, JsonExpression, JsonExpressionList, JsonExpressionParser, LabelFilter, LabelFormat, LabelFormatExpr, LabelFormatMatcher, LabelName, LabelParser, LabelReplace, LabelReplaceExpr, Labels, LabelsFormat, LastOverTime, LineComment, LineFilter, LineFilters, LineFormat, LineFormatExpr, LiteralExpr, LogExpr, LogQL, LogRangeExpr, Logfmt, Lss, Lte, Matcher, Matchers, Max, MaxOverTime, MetricExpr, Min, MinOverTime, Mod, Mul, Neq, Nre, Number, NumberFilter, Offset, OffsetExpr, On, OnOrIgnoringModifier, Or, Pattern, Pipe, PipeExact, PipeMatch, PipelineExpr, PipelineStage, Pow, QuantileOverTime, Range, RangeAggregationExpr, RangeOp, Rate, Re, Regexp, Selector, Stddev, StddevOverTime, Stdvar, StdvarOverTime, String, Sub, Sum, SumOverTime, Topk, UnitFilter, Unless, Unpack, Unwrap, UnwrapExpr, VectorAggregationExpr, VectorOp, Without, parser };\n","import { DataQuery, DataSourceJsonData, QueryResultMeta, ScopedVars } from '@grafana/data';\n\nimport { QueryEditorMode } from '../prometheus/querybuilder/shared/types';\n\nexport interface LokiInstantQueryRequest {\n  query: string;\n  limit?: number;\n  time?: string;\n  direction?: 'BACKWARD' | 'FORWARD';\n}\n\nexport interface LokiRangeQueryRequest {\n  query: string;\n  limit?: number;\n  start?: number;\n  end?: number;\n  step?: number;\n  direction?: 'BACKWARD' | 'FORWARD';\n}\n\nexport enum LokiResultType {\n  Stream = 'streams',\n  Vector = 'vector',\n  Matrix = 'matrix',\n}\n\nexport enum LokiQueryType {\n  Range = 'range',\n  Instant = 'instant',\n  Stream = 'stream',\n}\n\nexport enum LokiQueryDirection {\n  Backward = 'backward',\n  Forward = 'forward',\n}\n\nexport interface LokiQuery extends DataQuery {\n  queryType?: LokiQueryType;\n  expr: string;\n  direction?: LokiQueryDirection;\n  legendFormat?: string;\n  maxLines?: number;\n  resolution?: number;\n  /** Used in range queries */\n  volumeQuery?: boolean;\n  /* @deprecated now use queryType */\n  range?: boolean;\n  /* @deprecated now use queryType */\n  instant?: boolean;\n  editorMode?: QueryEditorMode;\n}\n\nexport interface LokiOptions extends DataSourceJsonData {\n  maxLines?: string;\n  derivedFields?: DerivedFieldConfig[];\n  alertmanager?: string;\n  keepCookies?: string[];\n}\n\nexport interface LokiStats {\n  [component: string]: {\n    [label: string]: number;\n  };\n}\n\nexport interface LokiVectorResult {\n  metric: { [label: string]: string };\n  value: [number, string];\n}\n\nexport interface LokiVectorResponse {\n  status: string;\n  data: {\n    resultType: LokiResultType.Vector;\n    result: LokiVectorResult[];\n    stats?: LokiStats;\n  };\n}\n\nexport interface LokiMatrixResult {\n  metric: Record<string, string>;\n  values: Array<[number, string]>;\n}\n\nexport interface LokiMatrixResponse {\n  status: string;\n  data: {\n    resultType: LokiResultType.Matrix;\n    result: LokiMatrixResult[];\n    stats?: LokiStats;\n  };\n}\n\nexport interface LokiStreamResult {\n  stream: Record<string, string>;\n  values: Array<[string, string]>;\n}\n\nexport interface LokiStreamResponse {\n  status: string;\n  data: {\n    resultType: LokiResultType.Stream;\n    result: LokiStreamResult[];\n    stats?: LokiStats;\n  };\n}\n\nexport interface LokiTailResponse {\n  streams: LokiStreamResult[];\n  dropped_entries?: Array<{\n    labels: Record<string, string>;\n    timestamp: string;\n  }> | null;\n}\n\nexport type LokiResult = LokiVectorResult | LokiMatrixResult | LokiStreamResult;\nexport type LokiResponse = LokiVectorResponse | LokiMatrixResponse | LokiStreamResponse;\n\nexport interface LokiLogsStreamEntry {\n  line: string;\n  ts: string;\n}\n\nexport interface LokiExpression {\n  regexp: string;\n  query: string;\n}\n\nexport type DerivedFieldConfig = {\n  matcherRegex: string;\n  name: string;\n  url?: string;\n  urlDisplayLabel?: string;\n  datasourceUid?: string;\n};\n\nexport interface TransformerOptions {\n  legendFormat?: string;\n  query: string;\n  refId: string;\n  scopedVars: ScopedVars;\n  meta?: QueryResultMeta;\n}\n","import { escapeRegExp } from 'lodash';\n\nimport { parser } from '@grafana/lezer-logql';\n\nimport { ErrorName } from '../prometheus/querybuilder/shared/parsingUtils';\n\nimport { LokiQuery, LokiQueryType } from './types';\n\nexport function formatQuery(selector: string | undefined): string {\n  return `${selector || ''}`.trim();\n}\n\n/**\n * Returns search terms from a LogQL query.\n * E.g., `{} |= foo |=bar != baz` returns `['foo', 'bar']`.\n */\nexport function getHighlighterExpressionsFromQuery(input: string): string[] {\n  let expression = input;\n  const results = [];\n\n  // Consume filter expression from left to right\n  while (expression) {\n    const filterStart = expression.search(/\\|=|\\|~|!=|!~/);\n    // Nothing more to search\n    if (filterStart === -1) {\n      break;\n    }\n    // Drop terms for negative filters\n    const filterOperator = expression.slice(filterStart, filterStart + 2);\n    const skip = expression.slice(filterStart).search(/!=|!~/) === 0;\n    expression = expression.slice(filterStart + 2);\n    if (skip) {\n      continue;\n    }\n    // Check if there is more chained, by just looking for the next pipe-operator\n    const filterEnd = expression.search(/\\|/);\n    let filterTerm;\n    if (filterEnd === -1) {\n      filterTerm = expression.trim();\n    } else {\n      filterTerm = expression.slice(0, filterEnd).trim();\n      expression = expression.slice(filterEnd);\n    }\n\n    const quotedTerm = filterTerm.match(/\"(.*?)\"/);\n    const backtickedTerm = filterTerm.match(/`(.*?)`/);\n    const term = quotedTerm || backtickedTerm;\n\n    if (term) {\n      const unwrappedFilterTerm = term[1];\n      const regexOperator = filterOperator === '|~';\n\n      let resultTerm = '';\n\n      // Only filter expressions with |~ operator are treated as regular expressions\n      if (regexOperator) {\n        // When using backticks, Loki doesn't require to escape special characters and we can just push regular expression to highlights array\n        // When using quotes, we have extra backslash escaping and we need to replace \\\\ with \\\n        resultTerm = backtickedTerm ? unwrappedFilterTerm : unwrappedFilterTerm.replace(/\\\\\\\\/g, '\\\\');\n      } else {\n        // We need to escape this string so it is not matched as regular expression\n        resultTerm = escapeRegExp(unwrappedFilterTerm);\n      }\n\n      if (resultTerm) {\n        results.push(resultTerm);\n      }\n    } else {\n      return results;\n    }\n  }\n\n  return results;\n}\n\n// we are migrating from `.instant` and `.range` to `.queryType`\n// this function returns a new query object that:\n// - has `.queryType`\n// - does not have `.instant`\n// - does not have `.range`\nexport function getNormalizedLokiQuery(query: LokiQuery): LokiQuery {\n  //  if queryType field contains invalid data we behave as if the queryType is empty\n  const { queryType } = query;\n  const hasValidQueryType =\n    queryType === LokiQueryType.Range || queryType === LokiQueryType.Instant || queryType === LokiQueryType.Stream;\n\n  // if queryType exists, it is respected\n  if (hasValidQueryType) {\n    const { instant, range, ...rest } = query;\n    return rest;\n  }\n\n  // if no queryType, and instant===true, it's instant\n  if (query.instant === true) {\n    const { instant, range, ...rest } = query;\n    return { ...rest, queryType: LokiQueryType.Instant };\n  }\n\n  // otherwise it is range\n  const { instant, range, ...rest } = query;\n  return { ...rest, queryType: LokiQueryType.Range };\n}\n\nexport function isValidQuery(query: string): boolean {\n  let isValid = true;\n  const tree = parser.parse(query);\n  tree.iterate({\n    enter: (type): false | void => {\n      if (type.name === ErrorName) {\n        isValid = false;\n      }\n    },\n  });\n  return isValid;\n}\n\nexport function isLogsQuery(query: string): boolean {\n  let isLogsQuery = true;\n  const tree = parser.parse(query);\n  tree.iterate({\n    enter: (type): false | void => {\n      if (type.name === 'MetricExpr') {\n        isLogsQuery = false;\n      }\n    },\n  });\n  return isLogsQuery;\n}\n\nexport function isQueryWithParser(query: string): { queryWithParser: boolean; parserCount: number } {\n  let parserCount = 0;\n  const tree = parser.parse(query);\n  tree.iterate({\n    enter: (type): false | void => {\n      if (type.name === 'LabelParser' || type.name === 'JsonExpressionParser') {\n        parserCount++;\n      }\n    },\n  });\n  return { queryWithParser: parserCount > 0, parserCount };\n}\n\nexport function isQueryPipelineErrorFiltering(query: string): boolean {\n  let isQueryPipelineErrorFiltering = false;\n  const tree = parser.parse(query);\n  tree.iterate({\n    enter: (type, from, to, get): false | void => {\n      if (type.name === 'LabelFilter') {\n        const label = get().getChild('Matcher')?.getChild('Identifier');\n        if (label) {\n          const labelName = query.substring(label.from, label.to);\n          if (labelName === '__error__') {\n            isQueryPipelineErrorFiltering = true;\n          }\n        }\n      }\n    },\n  });\n\n  return isQueryPipelineErrorFiltering;\n}\n\nexport function isQueryWithLabelFormat(query: string): boolean {\n  let queryWithLabelFormat = false;\n  const tree = parser.parse(query);\n  tree.iterate({\n    enter: (type): false | void => {\n      if (type.name === 'LabelFormatExpr') {\n        queryWithLabelFormat = true;\n      }\n    },\n  });\n  return queryWithLabelFormat;\n}\n\nexport function getLogQueryFromMetricsQuery(query: string): string {\n  if (isLogsQuery(query)) {\n    return query;\n  }\n\n  const tree = parser.parse(query);\n\n  // Log query in metrics query composes of Selector & PipelineExpr\n  let selector = '';\n  tree.iterate({\n    enter: (type, from, to): false | void => {\n      if (type.name === 'Selector') {\n        selector = query.substring(from, to);\n        return false;\n      }\n    },\n  });\n\n  let pipelineExpr = '';\n  tree.iterate({\n    enter: (type, from, to): false | void => {\n      if (type.name === 'PipelineExpr') {\n        pipelineExpr = query.substring(from, to);\n        return false;\n      }\n    },\n  });\n\n  return selector + pipelineExpr;\n}\n","import { DataQueryResponse, DataFrame, isDataFrame, FieldType, QueryResultMeta, DataQueryError } from '@grafana/data';\n\nimport { getDerivedFields } from './getDerivedFields';\nimport { makeTableFrames } from './makeTableFrames';\nimport { formatQuery, getHighlighterExpressionsFromQuery } from './query_utils';\nimport { dataFrameHasLokiError } from './responseUtils';\nimport { DerivedFieldConfig, LokiQuery, LokiQueryType } from './types';\n\nfunction isMetricFrame(frame: DataFrame): boolean {\n  return frame.fields.every((field) => field.type === FieldType.time || field.type === FieldType.number);\n}\n\n// returns a new frame, with meta shallow merged with it's original meta\nfunction setFrameMeta(frame: DataFrame, meta: QueryResultMeta): DataFrame {\n  const { meta: oldMeta, ...rest } = frame;\n  // meta maybe be undefined, we need to handle that\n  const newMeta = { ...oldMeta, ...meta };\n  return {\n    ...rest,\n    meta: newMeta,\n  };\n}\n\nfunction processStreamFrame(\n  frame: DataFrame,\n  query: LokiQuery | undefined,\n  derivedFieldConfigs: DerivedFieldConfig[]\n): DataFrame {\n  const custom: Record<string, string> = {\n    ...frame.meta?.custom, // keep the original meta.custom\n    // used by logsModel\n    lokiQueryStatKey: 'Summary: total bytes processed',\n  };\n\n  if (dataFrameHasLokiError(frame)) {\n    custom.error = 'Error when parsing some of the logs';\n  }\n\n  const meta: QueryResultMeta = {\n    preferredVisualisationType: 'logs',\n    limit: query?.maxLines,\n    searchWords: query !== undefined ? getHighlighterExpressionsFromQuery(formatQuery(query.expr)) : undefined,\n    custom,\n  };\n\n  const newFrame = setFrameMeta(frame, meta);\n  const derivedFields = getDerivedFields(newFrame, derivedFieldConfigs);\n  return {\n    ...newFrame,\n    fields: [...newFrame.fields, ...derivedFields],\n  };\n}\n\nfunction processStreamsFrames(\n  frames: DataFrame[],\n  queryMap: Map<string, LokiQuery>,\n  derivedFieldConfigs: DerivedFieldConfig[]\n): DataFrame[] {\n  return frames.map((frame) => {\n    const query = frame.refId !== undefined ? queryMap.get(frame.refId) : undefined;\n    return processStreamFrame(frame, query, derivedFieldConfigs);\n  });\n}\n\nfunction processMetricInstantFrames(frames: DataFrame[]): DataFrame[] {\n  return frames.length > 0 ? makeTableFrames(frames) : [];\n}\n\nfunction processMetricRangeFrames(frames: DataFrame[]): DataFrame[] {\n  const meta: QueryResultMeta = { preferredVisualisationType: 'graph' };\n  return frames.map((frame) => setFrameMeta(frame, meta));\n}\n\n// we split the frames into 3 groups, because we will handle\n// each group slightly differently\nfunction groupFrames(\n  frames: DataFrame[],\n  queryMap: Map<string, LokiQuery>\n): {\n  streamsFrames: DataFrame[];\n  metricInstantFrames: DataFrame[];\n  metricRangeFrames: DataFrame[];\n} {\n  const streamsFrames: DataFrame[] = [];\n  const metricInstantFrames: DataFrame[] = [];\n  const metricRangeFrames: DataFrame[] = [];\n\n  frames.forEach((frame) => {\n    if (!isMetricFrame(frame)) {\n      streamsFrames.push(frame);\n    } else {\n      const isInstantFrame = frame.refId != null && queryMap.get(frame.refId)?.queryType === LokiQueryType.Instant;\n      if (isInstantFrame) {\n        metricInstantFrames.push(frame);\n      } else {\n        metricRangeFrames.push(frame);\n      }\n    }\n  });\n\n  return { streamsFrames, metricInstantFrames, metricRangeFrames };\n}\n\nfunction improveError(error: DataQueryError | undefined, queryMap: Map<string, LokiQuery>): DataQueryError | undefined {\n  // many things are optional in an error-object, we need an error-message to exist,\n  // and we need to find the loki-query, based on the refId in the error-object.\n  if (error === undefined) {\n    return error;\n  }\n\n  const { refId, message } = error;\n  if (refId === undefined || message === undefined) {\n    return error;\n  }\n\n  const query = queryMap.get(refId);\n  if (query === undefined) {\n    return error;\n  }\n\n  if (message.includes('escape') && query.expr.includes('\\\\')) {\n    return {\n      ...error,\n      message: `${message}. Make sure that all special characters are escaped with \\\\. For more information on escaping of special characters visit LogQL documentation at https://grafana.com/docs/loki/latest/logql/.`,\n    };\n  }\n\n  return error;\n}\n\nexport function transformBackendResult(\n  response: DataQueryResponse,\n  queries: LokiQuery[],\n  derivedFieldConfigs: DerivedFieldConfig[]\n): DataQueryResponse {\n  const { data, error, ...rest } = response;\n\n  // in the typescript type, data is an array of basically anything.\n  // we do know that they have to be dataframes, so we make a quick check,\n  // this way we can be sure, and also typescript is happy.\n  const dataFrames = data.map((d) => {\n    if (!isDataFrame(d)) {\n      throw new Error('transformation only supports dataframe responses');\n    }\n    return d;\n  });\n\n  const queryMap = new Map(queries.map((query) => [query.refId, query]));\n\n  const { streamsFrames, metricInstantFrames, metricRangeFrames } = groupFrames(dataFrames, queryMap);\n\n  return {\n    ...rest,\n    error: improveError(error, queryMap),\n    data: [\n      ...processMetricRangeFrames(metricRangeFrames),\n      ...processMetricInstantFrames(metricInstantFrames),\n      ...processStreamsFrames(streamsFrames, queryMap, derivedFieldConfigs),\n    ],\n  };\n}\n","import { DataFrame, FieldType, getParser, Labels, LogsParsers } from '@grafana/data';\n\nexport function dataFrameHasLokiError(frame: DataFrame): boolean {\n  const labelSets: Labels[] = frame.fields.find((f) => f.name === 'labels')?.values.toArray() ?? [];\n  return labelSets.some((labels) => labels.__error__ !== undefined);\n}\n\nexport function dataFrameHasLevelLabel(frame: DataFrame): boolean {\n  const labelSets: Labels[] = frame.fields.find((f) => f.name === 'labels')?.values.toArray() ?? [];\n  return labelSets.some((labels) => labels.level !== undefined);\n}\n\nexport function extractLogParserFromDataFrame(frame: DataFrame): { hasLogfmt: boolean; hasJSON: boolean } {\n  const lineField = frame.fields.find((field) => field.type === FieldType.string);\n  if (lineField == null) {\n    return { hasJSON: false, hasLogfmt: false };\n  }\n\n  const logLines: string[] = lineField.values.toArray();\n\n  let hasJSON = false;\n  let hasLogfmt = false;\n\n  logLines.forEach((line) => {\n    const parser = getParser(line);\n    if (parser === LogsParsers.JSON) {\n      hasJSON = true;\n    }\n    if (parser === LogsParsers.logfmt) {\n      hasLogfmt = true;\n    }\n  });\n\n  return { hasLogfmt, hasJSON };\n}\n\nexport function extractHasErrorLabelFromDataFrame(frame: DataFrame): boolean {\n  const labelField = frame.fields.find((field) => field.name === 'labels' && field.type === FieldType.other);\n  if (labelField == null) {\n    return false;\n  }\n\n  const labels: Array<{ [key: string]: string }> = labelField.values.toArray();\n  return labels.some((label) => label['__error__']);\n}\n\nexport function extractLevelLikeLabelFromDataFrame(frame: DataFrame): string | null {\n  const labelField = frame.fields.find((field) => field.name === 'labels' && field.type === FieldType.other);\n  if (labelField == null) {\n    return null;\n  }\n\n  // Depending on number of labels, this can be pretty heavy operation.\n  // Let's just look at first 2 lines If needed, we can introduce more later.\n  const labelsArray: Array<{ [key: string]: string }> = labelField.values.toArray().slice(0, 2);\n  let levelLikeLabel: string | null = null;\n\n  // Find first level-like label\n  for (let labels of labelsArray) {\n    const label = Object.keys(labels).find((label) => label === 'lvl' || label.includes('level'));\n    if (label) {\n      levelLikeLabel = label;\n      break;\n    }\n  }\n  return levelLikeLabel;\n}\n","// Libraries\nimport { css, cx } from '@emotion/css';\nimport { map } from 'lodash';\nimport React, { memo } from 'react';\n\n// Types\nimport { SelectableValue } from '@grafana/data';\nimport { config } from '@grafana/runtime';\nimport { InlineFormLabel, RadioButtonGroup, InlineField, Input, Select } from '@grafana/ui';\n\nimport { LokiQuery, LokiQueryType } from '../types';\n\nexport interface LokiOptionFieldsProps {\n  lineLimitValue: string;\n  resolution: number;\n  query: LokiQuery;\n  onChange: (value: LokiQuery) => void;\n  onRunQuery: () => void;\n  runOnBlur?: boolean;\n}\n\nexport const queryTypeOptions: Array<SelectableValue<LokiQueryType>> = [\n  { value: LokiQueryType.Range, label: 'Range', description: 'Run query over a range of time.' },\n  {\n    value: LokiQueryType.Instant,\n    label: 'Instant',\n    description: 'Run query against a single point in time. For this query, the \"To\" time is used.',\n  },\n];\n\nif (config.featureToggles.lokiLive) {\n  queryTypeOptions.push({\n    value: LokiQueryType.Stream,\n    label: 'Stream',\n    description: 'Run a query and keep sending results on an interval',\n  });\n}\n\nexport const DEFAULT_RESOLUTION: SelectableValue<number> = {\n  value: 1,\n  label: '1/1',\n};\n\nexport const RESOLUTION_OPTIONS: Array<SelectableValue<number>> = [DEFAULT_RESOLUTION].concat(\n  map([2, 3, 4, 5, 10], (value: number) => ({\n    value,\n    label: '1/' + value,\n  }))\n);\n\nexport function LokiOptionFields(props: LokiOptionFieldsProps) {\n  const { lineLimitValue, resolution, onRunQuery, runOnBlur, onChange } = props;\n  const query = props.query ?? {};\n  let queryType = query.queryType ?? (query.instant ? LokiQueryType.Instant : LokiQueryType.Range);\n\n  function onChangeQueryLimit(value: string) {\n    const nextQuery = { ...query, maxLines: preprocessMaxLines(value) };\n    onChange(nextQuery);\n  }\n\n  function onQueryTypeChange(queryType: LokiQueryType) {\n    const { instant, range, ...rest } = query;\n    onChange({ ...rest, queryType });\n  }\n\n  function onMaxLinesChange(e: React.SyntheticEvent<HTMLInputElement>) {\n    if (query.maxLines !== preprocessMaxLines(e.currentTarget.value)) {\n      onChangeQueryLimit(e.currentTarget.value);\n    }\n  }\n\n  function onReturnKeyDown(e: React.KeyboardEvent<HTMLInputElement>) {\n    if (e.key === 'Enter') {\n      onRunQuery();\n    }\n  }\n\n  function onResolutionChange(option: SelectableValue<number>) {\n    const nextQuery = { ...query, resolution: option.value };\n    onChange(nextQuery);\n  }\n\n  return (\n    <div aria-label=\"Loki extra field\" className=\"gf-form-inline\">\n      {/*Query type field*/}\n      <div\n        data-testid=\"queryTypeField\"\n        className={cx(\n          'gf-form explore-input-margin',\n          css`\n            flex-wrap: nowrap;\n          `\n        )}\n        aria-label=\"Query type field\"\n      >\n        <InlineFormLabel width=\"auto\">Query type</InlineFormLabel>\n\n        <RadioButtonGroup\n          options={queryTypeOptions}\n          value={queryType}\n          onChange={(type: LokiQueryType) => {\n            onQueryTypeChange(type);\n            if (runOnBlur) {\n              onRunQuery();\n            }\n          }}\n        />\n      </div>\n      {/*Line limit field*/}\n      <div\n        data-testid=\"lineLimitField\"\n        className={cx(\n          'gf-form',\n          css`\n            flex-wrap: nowrap;\n          `\n        )}\n        aria-label=\"Line limit field\"\n      >\n        <InlineField label=\"Line limit\" tooltip={'Upper limit for number of log lines returned by query.'}>\n          <Input\n            className=\"width-4\"\n            placeholder=\"auto\"\n            type=\"number\"\n            min={0}\n            onChange={onMaxLinesChange}\n            onKeyDown={onReturnKeyDown}\n            value={lineLimitValue}\n            onBlur={() => {\n              if (runOnBlur) {\n                onRunQuery();\n              }\n            }}\n          />\n        </InlineField>\n        <InlineField\n          label=\"Resolution\"\n          tooltip={\n            'Resolution 1/1 sets step parameter of Loki metrics range queries such that each pixel corresponds to one data point. For better performance, lower resolutions can be picked. 1/2 only retrieves a data point for every other pixel, and 1/10 retrieves one data point per 10 pixels.'\n          }\n        >\n          <Select\n            isSearchable={false}\n            onChange={onResolutionChange}\n            options={RESOLUTION_OPTIONS}\n            value={resolution}\n            aria-label=\"Select resolution\"\n          />\n        </InlineField>\n      </div>\n    </div>\n  );\n}\n\nexport default memo(LokiOptionFields);\n\nexport function preprocessMaxLines(value: string): number {\n  if (value.length === 0) {\n    // empty input - falls back to dataSource.maxLines limit\n    return NaN;\n  } else if (value.length > 0 && (isNaN(+value) || +value < 0)) {\n    // input with at least 1 character and that is either incorrect (value in the input field is not a number) or negative\n    // falls back to the limit of 0 lines\n    return 0;\n  } else {\n    // default case - correct input\n    return +value;\n  }\n}\n","// Libraries\nimport React, { memo } from 'react';\n\nimport { AnnotationQuery } from '@grafana/data';\nimport { EditorRow, EditorField } from '@grafana/experimental';\nimport { Input } from '@grafana/ui';\n\n// Types\nimport { getNormalizedLokiQuery } from '../query_utils';\nimport { LokiQuery, LokiQueryType } from '../types';\n\nimport { LokiOptionFields } from './LokiOptionFields';\nimport { LokiQueryField } from './LokiQueryField';\nimport { LokiQueryEditorProps } from './types';\n\ntype Props = LokiQueryEditorProps & {\n  annotation?: AnnotationQuery<LokiQuery>;\n  onAnnotationChange?: (annotation: AnnotationQuery<LokiQuery>) => void;\n};\n\nexport const LokiAnnotationsQueryEditor = memo(function LokiAnnotationQueryEditor(props: Props) {\n  const { annotation, onAnnotationChange } = props;\n\n  // this should never happen, but we want to keep typescript happy\n  if (annotation === undefined || onAnnotationChange === undefined) {\n    return null;\n  }\n\n  const onChangeQuery = (query: LokiQuery) => {\n    // the current version of annotations only stores an optional boolean\n    // field `instant` to handle the instant/range switch.\n    // we need to maintain compatiblity for now, so we do the same.\n    // we explicitly call `getNormalizedLokiQuery` to make sure `queryType`\n    // is set up correctly.\n    const instant = getNormalizedLokiQuery(query).queryType === LokiQueryType.Instant;\n    onAnnotationChange({\n      ...annotation,\n      expr: query.expr,\n      maxLines: query.maxLines,\n      instant,\n    });\n  };\n\n  const queryWithRefId: LokiQuery = {\n    refId: '',\n    expr: annotation.expr,\n    maxLines: annotation.maxLines,\n    instant: annotation.instant,\n    queryType: annotation.queryType,\n  };\n  return (\n    <>\n      <div className=\"gf-form-group\">\n        <LokiQueryField\n          datasource={props.datasource}\n          query={queryWithRefId}\n          onChange={onChangeQuery}\n          onRunQuery={() => {}}\n          onBlur={() => {}}\n          history={[]}\n          ExtraFieldElement={\n            <LokiOptionFields\n              lineLimitValue={queryWithRefId?.maxLines?.toString() || ''}\n              resolution={queryWithRefId.resolution || 1}\n              query={queryWithRefId}\n              onRunQuery={() => {}}\n              onChange={onChangeQuery}\n            />\n          }\n        />\n      </div>\n\n      <EditorRow>\n        <EditorField\n          label=\"Title\"\n          tooltip={\n            'Use either the name or a pattern. For example, {{instance}} is replaced with label value for the label instance.'\n          }\n        >\n          <Input\n            type=\"text\"\n            placeholder=\"alertname\"\n            value={annotation.titleFormat}\n            onChange={(event) => {\n              onAnnotationChange({\n                ...annotation,\n                titleFormat: event.currentTarget.value,\n              });\n            }}\n          />\n        </EditorField>\n        <EditorField label=\"Tags\">\n          <Input\n            type=\"text\"\n            placeholder=\"label1,label2\"\n            value={annotation.tagKeys}\n            onChange={(event) => {\n              onAnnotationChange({\n                ...annotation,\n                tagKeys: event.currentTarget.value,\n              });\n            }}\n          />\n        </EditorField>\n        <EditorField\n          label=\"Text\"\n          tooltip={\n            'Use either the name or a pattern. For example, {{instance}} is replaced with label value for the label instance.'\n          }\n        >\n          <Input\n            type=\"text\"\n            placeholder=\"instance\"\n            value={annotation.textFormat}\n            onChange={(event) => {\n              onAnnotationChange({\n                ...annotation,\n                textFormat: event.currentTarget.value,\n              });\n            }}\n          />\n        </EditorField>\n      </EditorRow>\n    </>\n  );\n});\n","import { chain, difference } from 'lodash';\nimport LRU from 'lru-cache';\nimport Prism, { Grammar } from 'prismjs';\n\nimport { dateTime, AbsoluteTimeRange, LanguageProvider, HistoryItem, AbstractQuery } from '@grafana/data';\nimport { CompletionItem, TypeaheadInput, TypeaheadOutput, CompletionItemGroup } from '@grafana/ui';\nimport {\n  extractLabelMatchers,\n  parseSelector,\n  processLabels,\n  toPromLikeExpr,\n} from 'app/plugins/datasource/prometheus/language_utils';\n\nimport { LokiDatasource } from './datasource';\nimport syntax, { FUNCTIONS, PIPE_PARSERS, PIPE_OPERATORS } from './syntax';\nimport { LokiQuery, LokiQueryType } from './types';\n\nconst DEFAULT_KEYS = ['job', 'namespace'];\nconst EMPTY_SELECTOR = '{}';\nconst HISTORY_ITEM_COUNT = 10;\nconst HISTORY_COUNT_CUTOFF = 1000 * 60 * 60 * 24; // 24h\nconst NS_IN_MS = 1000000;\n\n// When changing RATE_RANGES, check if Prometheus/PromQL ranges should be changed too\n// @see public/app/plugins/datasource/prometheus/promql.ts\nconst RATE_RANGES: CompletionItem[] = [\n  { label: '$__interval', sortValue: '$__interval' },\n  { label: '$__range', sortValue: '$__range' },\n  { label: '1m', sortValue: '00:01:00' },\n  { label: '5m', sortValue: '00:05:00' },\n  { label: '10m', sortValue: '00:10:00' },\n  { label: '30m', sortValue: '00:30:00' },\n  { label: '1h', sortValue: '01:00:00' },\n  { label: '1d', sortValue: '24:00:00' },\n];\n\nexport const LABEL_REFRESH_INTERVAL = 1000 * 30; // 30sec\n\nconst wrapLabel = (label: string) => ({ label, filterText: `\\\"${label}\\\"` });\n\nexport type LokiHistoryItem = HistoryItem<LokiQuery>;\n\ntype TypeaheadContext = {\n  history?: LokiHistoryItem[];\n  absoluteRange?: AbsoluteTimeRange;\n};\n\nexport function addHistoryMetadata(item: CompletionItem, history: LokiHistoryItem[]): CompletionItem {\n  const cutoffTs = Date.now() - HISTORY_COUNT_CUTOFF;\n  const historyForItem = history.filter((h) => h.ts > cutoffTs && h.query.expr === item.label);\n  let hint = `Queried ${historyForItem.length} times in the last 24h.`;\n  const recent = historyForItem[0];\n\n  if (recent) {\n    const lastQueried = dateTime(recent.ts).fromNow();\n    hint = `${hint} Last queried ${lastQueried}.`;\n  }\n\n  return {\n    ...item,\n    documentation: hint,\n  };\n}\n\nexport default class LokiLanguageProvider extends LanguageProvider {\n  labelKeys: string[];\n  labelFetchTs: number;\n  started = false;\n  datasource: LokiDatasource;\n  lookupsDisabled = false; // Dynamically set to true for big/slow instances\n\n  /**\n   *  Cache for labels of series. This is bit simplistic in the sense that it just counts responses each as a 1 and does\n   *  not account for different size of a response. If that is needed a `length` function can be added in the options.\n   *  10 as a max size is totally arbitrary right now.\n   */\n  private seriesCache = new LRU<string, Record<string, string[]>>({ max: 10 });\n  private labelsCache = new LRU<string, string[]>({ max: 10 });\n\n  constructor(datasource: LokiDatasource, initialValues?: any) {\n    super();\n\n    this.datasource = datasource;\n    this.labelKeys = [];\n    this.labelFetchTs = 0;\n\n    Object.assign(this, initialValues);\n  }\n\n  // Strip syntax chars\n  cleanText = (s: string) => s.replace(/[{}[\\]=\"(),!~+\\-*/^%\\|]/g, '').trim();\n\n  getSyntax(): Grammar {\n    return syntax;\n  }\n\n  request = async (url: string, params?: any): Promise<any> => {\n    try {\n      return await this.datasource.metadataRequest(url, params);\n    } catch (error) {\n      console.error(error);\n    }\n\n    return undefined;\n  };\n\n  /**\n   * Initialise the language provider by fetching set of labels. Without this initialisation the provider would return\n   * just a set of hardcoded default labels on provideCompletionItems or a recent queries from history.\n   */\n  start = () => {\n    if (!this.startTask) {\n      this.startTask = this.fetchLabels().then(() => {\n        this.started = true;\n        return [];\n      });\n    }\n\n    return this.startTask;\n  };\n\n  getLabelKeys(): string[] {\n    return this.labelKeys;\n  }\n\n  /**\n   * Return suggestions based on input that can be then plugged into a typeahead dropdown.\n   * Keep this DOM-free for testing\n   * @param input\n   * @param context Is optional in types but is required in case we are doing getLabelCompletionItems\n   * @param context.absoluteRange Required in case we are doing getLabelCompletionItems\n   * @param context.history Optional used only in getEmptyCompletionItems\n   */\n  async provideCompletionItems(input: TypeaheadInput, context?: TypeaheadContext): Promise<TypeaheadOutput> {\n    const { wrapperClasses, value, prefix, text } = input;\n    const emptyResult: TypeaheadOutput = { suggestions: [] };\n\n    if (!value) {\n      return emptyResult;\n    }\n\n    // Local text properties\n    const empty = value?.document.text.length === 0;\n    const selectedLines = value.document.getTextsAtRange(value.selection);\n    const currentLine = selectedLines.size === 1 ? selectedLines.first().getText() : null;\n\n    const nextCharacter = currentLine ? currentLine[value.selection.anchor.offset] : null;\n\n    // Syntax spans have 3 classes by default. More indicate a recognized token\n    const tokenRecognized = wrapperClasses.length > 3;\n\n    // Non-empty prefix, but not inside known token\n    const prefixUnrecognized = prefix && !tokenRecognized;\n\n    // Prevent suggestions in `function(|suffix)`\n    const noSuffix = !nextCharacter || nextCharacter === ')';\n\n    // Prefix is safe if it does not immediately follow a complete expression and has no text after it\n    const safePrefix = prefix && !text.match(/^['\"~=\\]})\\s]+$/) && noSuffix;\n\n    // About to type next operand if preceded by binary operator\n    const operatorsPattern = /[+\\-*/^%]/;\n    const isNextOperand = text.match(operatorsPattern);\n\n    // Determine candidates by CSS context\n    if (wrapperClasses.includes('context-range')) {\n      // Suggestions for metric[|]\n      return this.getRangeCompletionItems();\n    } else if (wrapperClasses.includes('context-labels')) {\n      // Suggestions for {|} and {foo=|}\n      return await this.getLabelCompletionItems(input);\n    } else if (wrapperClasses.includes('context-pipe')) {\n      return this.getPipeCompletionItem();\n    } else if (empty) {\n      // Suggestions for empty query field\n      return this.getEmptyCompletionItems(context);\n    } else if (prefixUnrecognized && noSuffix && !isNextOperand) {\n      // Show term suggestions in a couple of scenarios\n      return this.getBeginningCompletionItems(context);\n    } else if (prefixUnrecognized && safePrefix) {\n      // Show term suggestions in a couple of scenarios\n      return this.getTermCompletionItems();\n    }\n\n    return emptyResult;\n  }\n\n  getBeginningCompletionItems = (context?: TypeaheadContext): TypeaheadOutput => {\n    return {\n      suggestions: [...this.getEmptyCompletionItems(context).suggestions, ...this.getTermCompletionItems().suggestions],\n    };\n  };\n\n  getEmptyCompletionItems(context?: TypeaheadContext): TypeaheadOutput {\n    const history = context?.history;\n    const suggestions = [];\n\n    if (history?.length) {\n      const historyItems = chain(history)\n        .map((h) => h.query.expr)\n        .filter()\n        .uniq()\n        .take(HISTORY_ITEM_COUNT)\n        .map(wrapLabel)\n        .map((item) => addHistoryMetadata(item, history))\n        .value();\n\n      suggestions.push({\n        prefixMatch: true,\n        skipSort: true,\n        label: 'History',\n        items: historyItems,\n      });\n    }\n\n    return { suggestions };\n  }\n\n  getTermCompletionItems = (): TypeaheadOutput => {\n    const suggestions = [];\n\n    suggestions.push({\n      prefixMatch: true,\n      label: 'Functions',\n      items: FUNCTIONS.map((suggestion) => ({ ...suggestion, kind: 'function' })),\n    });\n\n    return { suggestions };\n  };\n\n  getPipeCompletionItem = (): TypeaheadOutput => {\n    const suggestions = [];\n\n    suggestions.push({\n      label: 'Operators',\n      items: PIPE_OPERATORS.map((suggestion) => ({ ...suggestion, kind: 'operators' })),\n    });\n\n    suggestions.push({\n      label: 'Parsers',\n      items: PIPE_PARSERS.map((suggestion) => ({ ...suggestion, kind: 'parsers' })),\n    });\n\n    return { suggestions };\n  };\n\n  getRangeCompletionItems(): TypeaheadOutput {\n    return {\n      context: 'context-range',\n      suggestions: [\n        {\n          label: 'Range vector',\n          items: [...RATE_RANGES],\n        },\n      ],\n    };\n  }\n\n  async getLabelCompletionItems({ text, wrapperClasses, labelKey, value }: TypeaheadInput): Promise<TypeaheadOutput> {\n    let context = 'context-labels';\n    const suggestions: CompletionItemGroup[] = [];\n    if (!value) {\n      return { context, suggestions: [] };\n    }\n    const line = value.anchorBlock.getText();\n    const cursorOffset = value.selection.anchor.offset;\n    const isValueStart = text.match(/^(=|=~|!=|!~)/);\n\n    // Get normalized selector\n    let selector;\n    let parsedSelector;\n    try {\n      parsedSelector = parseSelector(line, cursorOffset);\n      selector = parsedSelector.selector;\n    } catch {\n      selector = EMPTY_SELECTOR;\n    }\n\n    if (!labelKey && selector === EMPTY_SELECTOR) {\n      // start task gets all labels\n      await this.start();\n      const allLabels = this.getLabelKeys();\n      return { context, suggestions: [{ label: `Labels`, items: allLabels.map(wrapLabel) }] };\n    }\n\n    const existingKeys = parsedSelector ? parsedSelector.labelKeys : [];\n\n    let labelValues;\n    // Query labels for selector\n    if (selector) {\n      if (selector === EMPTY_SELECTOR && labelKey) {\n        const labelValuesForKey = await this.getLabelValues(labelKey);\n        labelValues = { [labelKey]: labelValuesForKey };\n      } else {\n        labelValues = await this.getSeriesLabels(selector);\n      }\n    }\n\n    if (!labelValues) {\n      console.warn(`Server did not return any values for selector = ${selector}`);\n      return { context, suggestions };\n    }\n\n    if ((text && isValueStart) || wrapperClasses.includes('attr-value')) {\n      // Label values\n      if (labelKey && labelValues[labelKey]) {\n        context = 'context-label-values';\n        suggestions.push({\n          label: `Label values for \"${labelKey}\"`,\n          // Filter to prevent previously selected values from being repeatedly suggested\n          items: labelValues[labelKey].map(wrapLabel).filter(({ filterText }) => filterText !== text),\n        });\n      }\n    } else {\n      // Label keys\n      const labelKeys = labelValues ? Object.keys(labelValues) : DEFAULT_KEYS;\n      if (labelKeys) {\n        const possibleKeys = difference(labelKeys, existingKeys);\n        if (possibleKeys.length) {\n          const newItems = possibleKeys.map((key) => ({ label: key }));\n          const newSuggestion: CompletionItemGroup = { label: `Labels`, items: newItems };\n          suggestions.push(newSuggestion);\n        }\n      }\n    }\n\n    return { context, suggestions };\n  }\n\n  importFromAbstractQuery(labelBasedQuery: AbstractQuery): LokiQuery {\n    return {\n      refId: labelBasedQuery.refId,\n      expr: toPromLikeExpr(labelBasedQuery),\n      queryType: LokiQueryType.Range,\n    };\n  }\n\n  exportToAbstractQuery(query: LokiQuery): AbstractQuery {\n    const lokiQuery = query.expr;\n    if (!lokiQuery || lokiQuery.length === 0) {\n      return { refId: query.refId, labelMatchers: [] };\n    }\n    const tokens = Prism.tokenize(lokiQuery, syntax);\n    return {\n      refId: query.refId,\n      labelMatchers: extractLabelMatchers(tokens),\n    };\n  }\n\n  async getSeriesLabels(selector: string) {\n    if (this.lookupsDisabled) {\n      return undefined;\n    }\n    try {\n      return await this.fetchSeriesLabels(selector);\n    } catch (error) {\n      // TODO: better error handling\n      console.error(error);\n      return undefined;\n    }\n  }\n\n  /**\n   * Fetches all label keys\n   */\n  async fetchLabels(): Promise<string[]> {\n    const url = 'labels';\n    const timeRange = this.datasource.getTimeRangeParams();\n    this.labelFetchTs = Date.now().valueOf();\n\n    const res = await this.request(url, timeRange);\n    if (Array.isArray(res)) {\n      const labels = res\n        .slice()\n        .sort()\n        .filter((label) => label !== '__name__');\n      this.labelKeys = labels;\n    }\n\n    return [];\n  }\n\n  async refreshLogLabels(forceRefresh?: boolean) {\n    if ((this.labelKeys && Date.now().valueOf() - this.labelFetchTs > LABEL_REFRESH_INTERVAL) || forceRefresh) {\n      await this.fetchLabels();\n    }\n  }\n\n  /**\n   * Fetch labels for a selector. This is cached by it's args but also by the global timeRange currently selected as\n   * they can change over requested time.\n   * @param name\n   */\n  fetchSeriesLabels = async (match: string): Promise<Record<string, string[]>> => {\n    const interpolatedMatch = this.datasource.interpolateString(match);\n    const url = 'series';\n    const { start, end } = this.datasource.getTimeRangeParams();\n\n    const cacheKey = this.generateCacheKey(url, start, end, interpolatedMatch);\n    let value = this.seriesCache.get(cacheKey);\n    if (!value) {\n      // Clear value when requesting new one. Empty object being truthy also makes sure we don't request twice.\n      this.seriesCache.set(cacheKey, {});\n      const params = { 'match[]': interpolatedMatch, start, end };\n      const data = await this.request(url, params);\n      const { values } = processLabels(data);\n      value = values;\n      this.seriesCache.set(cacheKey, value);\n    }\n    return value;\n  };\n\n  /**\n   * Fetch series for a selector. Use this for raw results. Use fetchSeriesLabels() to get labels.\n   * @param match\n   */\n  fetchSeries = async (match: string): Promise<Array<Record<string, string>>> => {\n    const url = 'series';\n    const { start, end } = this.datasource.getTimeRangeParams();\n    const params = { 'match[]': match, start, end };\n    return await this.request(url, params);\n  };\n\n  // Cache key is a bit different here. We round up to a minute the intervals.\n  // The rounding may seem strange but makes relative intervals like now-1h less prone to need separate request every\n  // millisecond while still actually getting all the keys for the correct interval. This still can create problems\n  // when user does not the newest values for a minute if already cached.\n  generateCacheKey(url: string, start: number, end: number, param: string): string {\n    return [url, this.roundTime(start), this.roundTime(end), param].join();\n  }\n\n  // Round nanos epoch to nearest 5 minute interval\n  roundTime(nanos: number): number {\n    return nanos ? Math.floor(nanos / NS_IN_MS / 1000 / 60 / 5) : 0;\n  }\n\n  async getLabelValues(key: string): Promise<string[]> {\n    return await this.fetchLabelValues(key);\n  }\n\n  async fetchLabelValues(key: string): Promise<string[]> {\n    const interpolatedKey = encodeURIComponent(this.datasource.interpolateString(key));\n\n    const url = `label/${interpolatedKey}/values`;\n    const rangeParams = this.datasource.getTimeRangeParams();\n    const { start, end } = rangeParams;\n\n    const cacheKey = this.generateCacheKey(url, start, end, interpolatedKey);\n    const params = { start, end };\n\n    let labelValues = this.labelsCache.get(cacheKey);\n    if (!labelValues) {\n      // Clear value when requesting new one. Empty object being truthy also makes sure we don't request twice.\n      this.labelsCache.set(cacheKey, []);\n      const res = await this.request(url, params);\n      if (Array.isArray(res)) {\n        labelValues = res.slice().sort();\n        this.labelsCache.set(cacheKey, labelValues);\n      }\n    }\n\n    return labelValues ?? [];\n  }\n}\n","import { __assign, __extends } from \"tslib\";\nimport { Subject, AnonymousSubject } from '../../Subject';\nimport { Subscriber } from '../../Subscriber';\nimport { Observable } from '../../Observable';\nimport { Subscription } from '../../Subscription';\nimport { ReplaySubject } from '../../ReplaySubject';\nvar DEFAULT_WEBSOCKET_CONFIG = {\n    url: '',\n    deserializer: function (e) { return JSON.parse(e.data); },\n    serializer: function (value) { return JSON.stringify(value); },\n};\nvar WEBSOCKETSUBJECT_INVALID_ERROR_OBJECT = 'WebSocketSubject.error must be called with an object with an error code, and an optional reason: { code: number, reason: string }';\nvar WebSocketSubject = (function (_super) {\n    __extends(WebSocketSubject, _super);\n    function WebSocketSubject(urlConfigOrSource, destination) {\n        var _this = _super.call(this) || this;\n        _this._socket = null;\n        if (urlConfigOrSource instanceof Observable) {\n            _this.destination = destination;\n            _this.source = urlConfigOrSource;\n        }\n        else {\n            var config = (_this._config = __assign({}, DEFAULT_WEBSOCKET_CONFIG));\n            _this._output = new Subject();\n            if (typeof urlConfigOrSource === 'string') {\n                config.url = urlConfigOrSource;\n            }\n            else {\n                for (var key in urlConfigOrSource) {\n                    if (urlConfigOrSource.hasOwnProperty(key)) {\n                        config[key] = urlConfigOrSource[key];\n                    }\n                }\n            }\n            if (!config.WebSocketCtor && WebSocket) {\n                config.WebSocketCtor = WebSocket;\n            }\n            else if (!config.WebSocketCtor) {\n                throw new Error('no WebSocket constructor can be found');\n            }\n            _this.destination = new ReplaySubject();\n        }\n        return _this;\n    }\n    WebSocketSubject.prototype.lift = function (operator) {\n        var sock = new WebSocketSubject(this._config, this.destination);\n        sock.operator = operator;\n        sock.source = this;\n        return sock;\n    };\n    WebSocketSubject.prototype._resetState = function () {\n        this._socket = null;\n        if (!this.source) {\n            this.destination = new ReplaySubject();\n        }\n        this._output = new Subject();\n    };\n    WebSocketSubject.prototype.multiplex = function (subMsg, unsubMsg, messageFilter) {\n        var self = this;\n        return new Observable(function (observer) {\n            try {\n                self.next(subMsg());\n            }\n            catch (err) {\n                observer.error(err);\n            }\n            var subscription = self.subscribe({\n                next: function (x) {\n                    try {\n                        if (messageFilter(x)) {\n                            observer.next(x);\n                        }\n                    }\n                    catch (err) {\n                        observer.error(err);\n                    }\n                },\n                error: function (err) { return observer.error(err); },\n                complete: function () { return observer.complete(); },\n            });\n            return function () {\n                try {\n                    self.next(unsubMsg());\n                }\n                catch (err) {\n                    observer.error(err);\n                }\n                subscription.unsubscribe();\n            };\n        });\n    };\n    WebSocketSubject.prototype._connectSocket = function () {\n        var _this = this;\n        var _a = this._config, WebSocketCtor = _a.WebSocketCtor, protocol = _a.protocol, url = _a.url, binaryType = _a.binaryType;\n        var observer = this._output;\n        var socket = null;\n        try {\n            socket = protocol ? new WebSocketCtor(url, protocol) : new WebSocketCtor(url);\n            this._socket = socket;\n            if (binaryType) {\n                this._socket.binaryType = binaryType;\n            }\n        }\n        catch (e) {\n            observer.error(e);\n            return;\n        }\n        var subscription = new Subscription(function () {\n            _this._socket = null;\n            if (socket && socket.readyState === 1) {\n                socket.close();\n            }\n        });\n        socket.onopen = function (evt) {\n            var _socket = _this._socket;\n            if (!_socket) {\n                socket.close();\n                _this._resetState();\n                return;\n            }\n            var openObserver = _this._config.openObserver;\n            if (openObserver) {\n                openObserver.next(evt);\n            }\n            var queue = _this.destination;\n            _this.destination = Subscriber.create(function (x) {\n                if (socket.readyState === 1) {\n                    try {\n                        var serializer = _this._config.serializer;\n                        socket.send(serializer(x));\n                    }\n                    catch (e) {\n                        _this.destination.error(e);\n                    }\n                }\n            }, function (err) {\n                var closingObserver = _this._config.closingObserver;\n                if (closingObserver) {\n                    closingObserver.next(undefined);\n                }\n                if (err && err.code) {\n                    socket.close(err.code, err.reason);\n                }\n                else {\n                    observer.error(new TypeError(WEBSOCKETSUBJECT_INVALID_ERROR_OBJECT));\n                }\n                _this._resetState();\n            }, function () {\n                var closingObserver = _this._config.closingObserver;\n                if (closingObserver) {\n                    closingObserver.next(undefined);\n                }\n                socket.close();\n                _this._resetState();\n            });\n            if (queue && queue instanceof ReplaySubject) {\n                subscription.add(queue.subscribe(_this.destination));\n            }\n        };\n        socket.onerror = function (e) {\n            _this._resetState();\n            observer.error(e);\n        };\n        socket.onclose = function (e) {\n            if (socket === _this._socket) {\n                _this._resetState();\n            }\n            var closeObserver = _this._config.closeObserver;\n            if (closeObserver) {\n                closeObserver.next(e);\n            }\n            if (e.wasClean) {\n                observer.complete();\n            }\n            else {\n                observer.error(e);\n            }\n        };\n        socket.onmessage = function (e) {\n            try {\n                var deserializer = _this._config.deserializer;\n                observer.next(deserializer(e));\n            }\n            catch (err) {\n                observer.error(err);\n            }\n        };\n    };\n    WebSocketSubject.prototype._subscribe = function (subscriber) {\n        var _this = this;\n        var source = this.source;\n        if (source) {\n            return source.subscribe(subscriber);\n        }\n        if (!this._socket) {\n            this._connectSocket();\n        }\n        this._output.subscribe(subscriber);\n        subscriber.add(function () {\n            var _socket = _this._socket;\n            if (_this._output.observers.length === 0) {\n                if (_socket && (_socket.readyState === 1 || _socket.readyState === 0)) {\n                    _socket.close();\n                }\n                _this._resetState();\n            }\n        });\n        return subscriber;\n    };\n    WebSocketSubject.prototype.unsubscribe = function () {\n        var _socket = this._socket;\n        if (_socket && (_socket.readyState === 1 || _socket.readyState === 0)) {\n            _socket.close();\n        }\n        this._resetState();\n        _super.prototype.unsubscribe.call(this);\n    };\n    return WebSocketSubject;\n}(AnonymousSubject));\nexport { WebSocketSubject };\n//# sourceMappingURL=WebSocketSubject.js.map","import validate from './validate.js';\n\nfunction parse(uuid) {\n  if (!validate(uuid)) {\n    throw TypeError('Invalid UUID');\n  }\n\n  var v;\n  var arr = new Uint8Array(16); // Parse ########-....-....-....-............\n\n  arr[0] = (v = parseInt(uuid.slice(0, 8), 16)) >>> 24;\n  arr[1] = v >>> 16 & 0xff;\n  arr[2] = v >>> 8 & 0xff;\n  arr[3] = v & 0xff; // Parse ........-####-....-....-............\n\n  arr[4] = (v = parseInt(uuid.slice(9, 13), 16)) >>> 8;\n  arr[5] = v & 0xff; // Parse ........-....-####-....-............\n\n  arr[6] = (v = parseInt(uuid.slice(14, 18), 16)) >>> 8;\n  arr[7] = v & 0xff; // Parse ........-....-....-####-............\n\n  arr[8] = (v = parseInt(uuid.slice(19, 23), 16)) >>> 8;\n  arr[9] = v & 0xff; // Parse ........-....-....-....-############\n  // (Use \"/\" to avoid 32-bit truncation when bit-shifting high-order bytes)\n\n  arr[10] = (v = parseInt(uuid.slice(24, 36), 16)) / 0x10000000000 & 0xff;\n  arr[11] = v / 0x100000000 & 0xff;\n  arr[12] = v >>> 24 & 0xff;\n  arr[13] = v >>> 16 & 0xff;\n  arr[14] = v >>> 8 & 0xff;\n  arr[15] = v & 0xff;\n  return arr;\n}\n\nexport default parse;","// Adapted from Chris Veness' SHA1 code at\n// http://www.movable-type.co.uk/scripts/sha1.html\nfunction f(s, x, y, z) {\n  switch (s) {\n    case 0:\n      return x & y ^ ~x & z;\n\n    case 1:\n      return x ^ y ^ z;\n\n    case 2:\n      return x & y ^ x & z ^ y & z;\n\n    case 3:\n      return x ^ y ^ z;\n  }\n}\n\nfunction ROTL(x, n) {\n  return x << n | x >>> 32 - n;\n}\n\nfunction sha1(bytes) {\n  var K = [0x5a827999, 0x6ed9eba1, 0x8f1bbcdc, 0xca62c1d6];\n  var H = [0x67452301, 0xefcdab89, 0x98badcfe, 0x10325476, 0xc3d2e1f0];\n\n  if (typeof bytes === 'string') {\n    var msg = unescape(encodeURIComponent(bytes)); // UTF8 escape\n\n    bytes = [];\n\n    for (var i = 0; i < msg.length; ++i) {\n      bytes.push(msg.charCodeAt(i));\n    }\n  } else if (!Array.isArray(bytes)) {\n    // Convert Array-like to Array\n    bytes = Array.prototype.slice.call(bytes);\n  }\n\n  bytes.push(0x80);\n  var l = bytes.length / 4 + 2;\n  var N = Math.ceil(l / 16);\n  var M = new Array(N);\n\n  for (var _i = 0; _i < N; ++_i) {\n    var arr = new Uint32Array(16);\n\n    for (var j = 0; j < 16; ++j) {\n      arr[j] = bytes[_i * 64 + j * 4] << 24 | bytes[_i * 64 + j * 4 + 1] << 16 | bytes[_i * 64 + j * 4 + 2] << 8 | bytes[_i * 64 + j * 4 + 3];\n    }\n\n    M[_i] = arr;\n  }\n\n  M[N - 1][14] = (bytes.length - 1) * 8 / Math.pow(2, 32);\n  M[N - 1][14] = Math.floor(M[N - 1][14]);\n  M[N - 1][15] = (bytes.length - 1) * 8 & 0xffffffff;\n\n  for (var _i2 = 0; _i2 < N; ++_i2) {\n    var W = new Uint32Array(80);\n\n    for (var t = 0; t < 16; ++t) {\n      W[t] = M[_i2][t];\n    }\n\n    for (var _t = 16; _t < 80; ++_t) {\n      W[_t] = ROTL(W[_t - 3] ^ W[_t - 8] ^ W[_t - 14] ^ W[_t - 16], 1);\n    }\n\n    var a = H[0];\n    var b = H[1];\n    var c = H[2];\n    var d = H[3];\n    var e = H[4];\n\n    for (var _t2 = 0; _t2 < 80; ++_t2) {\n      var s = Math.floor(_t2 / 20);\n      var T = ROTL(a, 5) + f(s, b, c, d) + e + K[s] + W[_t2] >>> 0;\n      e = d;\n      d = c;\n      c = ROTL(b, 30) >>> 0;\n      b = a;\n      a = T;\n    }\n\n    H[0] = H[0] + a >>> 0;\n    H[1] = H[1] + b >>> 0;\n    H[2] = H[2] + c >>> 0;\n    H[3] = H[3] + d >>> 0;\n    H[4] = H[4] + e >>> 0;\n  }\n\n  return [H[0] >> 24 & 0xff, H[0] >> 16 & 0xff, H[0] >> 8 & 0xff, H[0] & 0xff, H[1] >> 24 & 0xff, H[1] >> 16 & 0xff, H[1] >> 8 & 0xff, H[1] & 0xff, H[2] >> 24 & 0xff, H[2] >> 16 & 0xff, H[2] >> 8 & 0xff, H[2] & 0xff, H[3] >> 24 & 0xff, H[3] >> 16 & 0xff, H[3] >> 8 & 0xff, H[3] & 0xff, H[4] >> 24 & 0xff, H[4] >> 16 & 0xff, H[4] >> 8 & 0xff, H[4] & 0xff];\n}\n\nexport default sha1;","import v35 from './v35.js';\nimport sha1 from './sha1.js';\nvar v5 = v35('v5', 0x50, sha1);\nexport default v5;","import stringify from './stringify.js';\nimport parse from './parse.js';\n\nfunction stringToBytes(str) {\n  str = unescape(encodeURIComponent(str)); // UTF8 escape\n\n  var bytes = [];\n\n  for (var i = 0; i < str.length; ++i) {\n    bytes.push(str.charCodeAt(i));\n  }\n\n  return bytes;\n}\n\nexport var DNS = '6ba7b810-9dad-11d1-80b4-00c04fd430c8';\nexport var URL = '6ba7b811-9dad-11d1-80b4-00c04fd430c8';\nexport default function (name, version, hashfunc) {\n  function generateUUID(value, namespace, buf, offset) {\n    if (typeof value === 'string') {\n      value = stringToBytes(value);\n    }\n\n    if (typeof namespace === 'string') {\n      namespace = parse(namespace);\n    }\n\n    if (namespace.length !== 16) {\n      throw TypeError('Namespace must be array-like (16 iterable integer values, 0-255)');\n    } // Compute hash of namespace and value, Per 4.3\n    // Future: Use spread syntax when supported on all platforms, e.g. `bytes =\n    // hashfunc([...namespace, ... value])`\n\n\n    var bytes = new Uint8Array(16 + value.length);\n    bytes.set(namespace);\n    bytes.set(value, namespace.length);\n    bytes = hashfunc(bytes);\n    bytes[6] = bytes[6] & 0x0f | version;\n    bytes[8] = bytes[8] & 0x3f | 0x80;\n\n    if (buf) {\n      offset = offset || 0;\n\n      for (var i = 0; i < 16; ++i) {\n        buf[offset + i] = bytes[i];\n      }\n\n      return buf;\n    }\n\n    return stringify(bytes);\n  } // Function#name is not settable on some platforms (#270)\n\n\n  try {\n    generateUUID.name = name; // eslint-disable-next-line no-empty\n  } catch (err) {} // For CommonJS default export support\n\n\n  generateUUID.DNS = DNS;\n  generateUUID.URL = URL;\n  return generateUUID;\n}","import { v5 as uuidv5 } from 'uuid';\n\nimport { MutableDataFrame } from '@grafana/data';\n\nimport { LokiStreamResult, LokiTailResponse } from './types';\n\nconst UUID_NAMESPACE = '6ec946da-0f49-47a8-983a-1d76d17e7c92';\n\n/**\n * Transform LokiResponse data and appends it to MutableDataFrame. Used for streaming where the dataFrame can be\n * a CircularDataFrame creating a fixed size rolling buffer.\n * TODO: Probably could be unified with the logStreamToDataFrame function.\n * @param response\n * @param data Needs to have ts, line, labels, id as fields\n */\nexport function appendResponseToBufferedData(response: LokiTailResponse, data: MutableDataFrame) {\n  // Should we do anything with: response.dropped_entries?\n\n  const streams: LokiStreamResult[] = response.streams;\n  if (!streams || !streams.length) {\n    return;\n  }\n\n  const tsField = data.fields[0];\n  const lineField = data.fields[1];\n  const idField = data.fields[2];\n\n  // We are comparing used ids only within the received stream. This could be a problem if the same line + labels + nanosecond timestamp came in 2 separate batches.\n  // As this is very unlikely, and the result would only affect live-tailing css animation we have decided to not compare all received uids from data param as this would slow down processing.\n  const usedUids: { string?: number } = {};\n\n  for (const stream of streams) {\n    // Find unique labels\n    const allLabelsString = Object.entries(stream.stream)\n      .map(([key, val]) => `${key}=\"${val}\"`)\n      .sort()\n      .join('');\n\n    // Add each line\n    for (const [ts, line] of stream.values) {\n      tsField.values.add(new Date(parseInt(ts.slice(0, -6), 10)).toISOString());\n      lineField.values.add(line);\n      idField.values.add(createUid(ts, allLabelsString, line, usedUids, data.refId));\n    }\n  }\n}\n\nfunction createUid(ts: string, labelsString: string, line: string, usedUids: any, refId?: string): string {\n  // Generate id as hashed nanosecond timestamp, labels and line (this does not have to be unique)\n  let id = uuidv5(`${ts}_${labelsString}_${line}`, UUID_NAMESPACE);\n\n  // Check if generated id is unique\n  // If not and we've already used it, append it's count after it\n  if (id in usedUids) {\n    // Increase the count\n    const newCount = usedUids[id] + 1;\n    usedUids[id] = newCount;\n    // Append count to generated id to make it unique\n    id = `${id}_${newCount}`;\n  } else {\n    // If id is unique and wasn't used, add it to usedUids and start count at 0\n    usedUids[id] = 0;\n  }\n  // Return unique id\n  if (refId) {\n    return `${id}_${refId}`;\n  }\n  return id;\n}\n","import { Observable, throwError, timer } from 'rxjs';\nimport { finalize, map, retryWhen, mergeMap } from 'rxjs/operators';\nimport { webSocket } from 'rxjs/webSocket';\n\nimport { DataFrame, FieldType, KeyValue, CircularDataFrame } from '@grafana/data';\n\nimport { appendResponseToBufferedData } from './live_streams_result_transformer';\nimport { LokiTailResponse } from './types';\n\n/**\n * Maps directly to a query in the UI (refId is key)\n */\nexport interface LokiLiveTarget {\n  query: string;\n  url: string;\n  refId: string;\n  size: number;\n}\n\n/**\n * Cache of websocket streams that can be returned as observable. In case there already is a stream for particular\n * target it is returned and on subscription returns the latest dataFrame.\n */\nexport class LiveStreams {\n  private streams: KeyValue<Observable<DataFrame[]>> = {};\n\n  getStream(target: LokiLiveTarget, retryInterval = 5000): Observable<DataFrame[]> {\n    let stream = this.streams[target.url];\n\n    if (stream) {\n      return stream;\n    }\n\n    const data = new CircularDataFrame({ capacity: target.size });\n    data.addField({ name: 'Time', type: FieldType.time, config: {} });\n    data.addField({ name: 'Line', type: FieldType.string });\n    data.addField({ name: 'id', type: FieldType.string });\n    data.meta = { ...data.meta, preferredVisualisationType: 'logs' };\n    data.refId = target.refId;\n\n    stream = webSocket<LokiTailResponse>(target.url).pipe(\n      map((response: LokiTailResponse) => {\n        appendResponseToBufferedData(response, data);\n        return [data];\n      }),\n      retryWhen((attempts: Observable<any>) =>\n        attempts.pipe(\n          mergeMap((error, i) => {\n            const retryAttempt = i + 1;\n            // Code 1006 is used to indicate that a connection was closed abnormally.\n            // Added hard limit of 30 on number of retries.\n            // If connection was closed abnormally, and we wish to retry, otherwise throw error.\n            if (error.code === 1006 && retryAttempt < 30) {\n              if (retryAttempt > 10) {\n                // If more than 10 times retried, consol.warn, but keep reconnecting\n                console.warn(\n                  `Websocket connection is being disrupted. We keep reconnecting but consider starting new live tailing again. Error: ${error.reason}`\n                );\n              }\n              // Retry every 5s\n              return timer(retryInterval);\n            }\n            return throwError(error);\n          })\n        )\n      ),\n      finalize(() => {\n        delete this.streams[target.url];\n      })\n    );\n    this.streams[target.url] = stream;\n\n    return stream;\n  }\n}\n","import { WebSocketSubject } from './WebSocketSubject';\nexport function webSocket(urlConfigOrSource) {\n    return new WebSocketSubject(urlConfigOrSource);\n}\n//# sourceMappingURL=webSocket.js.map","import { SyntaxNode } from '@lezer/common';\n\nimport { parser } from '@grafana/lezer-logql';\n\nimport {\n  ErrorName,\n  getAllByType,\n  getLeftMostChild,\n  getString,\n  makeBinOp,\n  makeError,\n  replaceVariables,\n} from '../../prometheus/querybuilder/shared/parsingUtils';\nimport { QueryBuilderLabelFilter, QueryBuilderOperation } from '../../prometheus/querybuilder/shared/types';\n\nimport { binaryScalarDefs } from './binaryScalarOperations';\nimport { LokiOperationId, LokiVisualQuery, LokiVisualQueryBinary } from './types';\n\ninterface Context {\n  query: LokiVisualQuery;\n  errors: ParsingError[];\n}\n\ninterface ParsingError {\n  text: string;\n  from?: number;\n  to?: number;\n  parentType?: string;\n}\n\nexport function buildVisualQueryFromString(expr: string): Context {\n  const replacedExpr = replaceVariables(expr);\n  const tree = parser.parse(replacedExpr);\n  const node = tree.topNode;\n\n  // This will be modified in the handleExpression\n  const visQuery: LokiVisualQuery = {\n    labels: [],\n    operations: [],\n  };\n\n  const context: Context = {\n    query: visQuery,\n    errors: [],\n  };\n\n  try {\n    handleExpression(replacedExpr, node, context);\n  } catch (err) {\n    // Not ideal to log it here, but otherwise we would lose the stack trace.\n    console.error(err);\n    if (err instanceof Error) {\n      context.errors.push({\n        text: err.message,\n      });\n    }\n  }\n\n  // If we have empty query, we want to reset errors\n  if (isEmptyQuery(context.query)) {\n    context.errors = [];\n  }\n  return context;\n}\n\nexport function handleExpression(expr: string, node: SyntaxNode, context: Context) {\n  const visQuery = context.query;\n  switch (node.name) {\n    case 'Matcher': {\n      visQuery.labels.push(getLabel(expr, node));\n      const err = node.getChild(ErrorName);\n      if (err) {\n        context.errors.push(makeError(expr, err));\n      }\n      break;\n    }\n\n    case 'LineFilter': {\n      const { operation, error } = getLineFilter(expr, node);\n      if (operation) {\n        visQuery.operations.push(operation);\n      }\n      // Show error for query patterns not supported in visual query builder\n      if (error) {\n        context.errors.push(createNotSupportedError(expr, node, error));\n      }\n      break;\n    }\n\n    case 'LabelParser': {\n      visQuery.operations.push(getLabelParser(expr, node));\n      break;\n    }\n\n    case 'LabelFilter': {\n      const { operation, error } = getLabelFilter(expr, node);\n      if (operation) {\n        visQuery.operations.push(operation);\n      }\n      // Show error for query patterns not supported in visual query builder\n      if (error) {\n        context.errors.push(createNotSupportedError(expr, node, error));\n      }\n      break;\n    }\n    case 'JsonExpressionParser': {\n      visQuery.operations.push(getJsonExpressionParser(expr, node));\n      break;\n    }\n\n    case 'LineFormatExpr': {\n      visQuery.operations.push(getLineFormat(expr, node));\n      break;\n    }\n\n    case 'LabelFormatMatcher': {\n      visQuery.operations.push(getLabelFormat(expr, node));\n      break;\n    }\n\n    case 'UnwrapExpr': {\n      const { operation, error } = handleUnwrapExpr(expr, node, context);\n      if (operation) {\n        visQuery.operations.push(operation);\n      }\n      // Show error for query patterns not supported in visual query builder\n      if (error) {\n        context.errors.push(createNotSupportedError(expr, node, error));\n      }\n\n      break;\n    }\n\n    case 'RangeAggregationExpr': {\n      visQuery.operations.push(handleRangeAggregation(expr, node, context));\n      break;\n    }\n\n    case 'VectorAggregationExpr': {\n      visQuery.operations.push(handleVectorAggregation(expr, node, context));\n      break;\n    }\n\n    case 'BinOpExpr': {\n      handleBinary(expr, node, context);\n      break;\n    }\n\n    case ErrorName: {\n      if (isIntervalVariableError(node)) {\n        break;\n      }\n      context.errors.push(makeError(expr, node));\n      break;\n    }\n\n    default: {\n      // Any other nodes we just ignore and go to it's children. This should be fine as there are lot's of wrapper\n      // nodes that can be skipped.\n      // TODO: there are probably cases where we will just skip nodes we don't support and we should be able to\n      //  detect those and report back.\n      let child = node.firstChild;\n      while (child) {\n        handleExpression(expr, child, context);\n        child = child.nextSibling;\n      }\n    }\n  }\n}\n\nfunction getLabel(expr: string, node: SyntaxNode): QueryBuilderLabelFilter {\n  const labelNode = node.getChild('Identifier');\n  const label = getString(expr, labelNode);\n  const op = getString(expr, labelNode!.nextSibling);\n  const value = getString(expr, node.getChild('String')).replace(/\"/g, '');\n\n  return {\n    label,\n    op,\n    value,\n  };\n}\n\nfunction getLineFilter(expr: string, node: SyntaxNode): { operation?: QueryBuilderOperation; error?: string } {\n  const filter = getString(expr, node.getChild('Filter'));\n  const filterExpr = handleQuotes(getString(expr, node.getChild('String')));\n  const ipLineFilter = node.getChild('FilterOp')?.getChild('Ip');\n\n  if (ipLineFilter) {\n    return {\n      operation: {\n        id: LokiOperationId.LineFilterIpMatches,\n        params: [filter, filterExpr],\n      },\n    };\n  }\n  const mapFilter: any = {\n    '|=': LokiOperationId.LineContains,\n    '!=': LokiOperationId.LineContainsNot,\n    '|~': LokiOperationId.LineMatchesRegex,\n    '!~': LokiOperationId.LineMatchesRegexNot,\n  };\n\n  return {\n    operation: {\n      id: mapFilter[filter],\n      params: [filterExpr],\n    },\n  };\n}\n\nfunction getLabelParser(expr: string, node: SyntaxNode): QueryBuilderOperation {\n  const parserNode = node.firstChild;\n  const parser = getString(expr, parserNode);\n\n  const string = handleQuotes(getString(expr, node.getChild('String')));\n  const params = !!string ? [string] : [];\n  return {\n    id: parser,\n    params,\n  };\n}\n\nfunction getJsonExpressionParser(expr: string, node: SyntaxNode): QueryBuilderOperation {\n  const parserNode = node.getChild('Json');\n  const parser = getString(expr, parserNode);\n\n  const params = [...getAllByType(expr, node, 'JsonExpression')];\n  return {\n    id: parser,\n    params,\n  };\n}\n\nfunction getLabelFilter(expr: string, node: SyntaxNode): { operation?: QueryBuilderOperation; error?: string } {\n  // Check for nodes not supported in visual builder and return error\n  if (node.getChild('Or') || node.getChild('And') || node.getChild('Comma')) {\n    return {\n      error: 'Label filter with comma, \"and\", \"or\" not supported in query builder',\n    };\n  }\n  if (node.firstChild!.name === 'IpLabelFilter') {\n    const ipLabelFilter = node.firstChild;\n    const label = ipLabelFilter?.getChild('Identifier');\n    const op = label?.nextSibling;\n    const value = ipLabelFilter?.getChild('String');\n    const valueString = handleQuotes(getString(expr, value));\n\n    return {\n      operation: {\n        id: LokiOperationId.LabelFilterIpMatches,\n        params: [getString(expr, label), getString(expr, op), valueString],\n      },\n    };\n  }\n\n  const id = '__label_filter';\n  if (node.firstChild!.name === 'UnitFilter') {\n    const filter = node.firstChild!.firstChild;\n    const label = filter!.firstChild;\n    const op = label!.nextSibling;\n    const value = op!.nextSibling;\n    const valueString = handleQuotes(getString(expr, value));\n\n    return {\n      operation: {\n        id,\n        params: [getString(expr, label), getString(expr, op), valueString],\n      },\n    };\n  }\n  // In this case it is Matcher or NumberFilter\n  const filter = node.firstChild;\n  const label = filter!.firstChild;\n  const op = label!.nextSibling;\n  const value = op!.nextSibling;\n  const params = [getString(expr, label), getString(expr, op), handleQuotes(getString(expr, value))];\n\n  // Special case of pipe filtering - no errors\n  if (params.join('') === `__error__=`) {\n    return {\n      operation: {\n        id: '__label_filter_no_errors',\n        params: [],\n      },\n    };\n  }\n\n  return {\n    operation: {\n      id,\n      params,\n    },\n  };\n}\n\nfunction getLineFormat(expr: string, node: SyntaxNode): QueryBuilderOperation {\n  const id = 'line_format';\n  const string = handleQuotes(getString(expr, node.getChild('String')));\n\n  return {\n    id,\n    params: [string],\n  };\n}\n\nfunction getLabelFormat(expr: string, node: SyntaxNode): QueryBuilderOperation {\n  const id = 'label_format';\n  const renameTo = node.getChild('Identifier');\n  const op = renameTo!.nextSibling;\n  const originalLabel = op!.nextSibling;\n\n  return {\n    id,\n    params: [getString(expr, originalLabel), handleQuotes(getString(expr, renameTo))],\n  };\n}\n\nfunction handleUnwrapExpr(\n  expr: string,\n  node: SyntaxNode,\n  context: Context\n): { operation?: QueryBuilderOperation; error?: string } {\n  const unwrapExprChild = node.getChild('UnwrapExpr');\n  const labelFilterChild = node.getChild('LabelFilter');\n  const unwrapChild = node.getChild('Unwrap');\n\n  if (unwrapExprChild) {\n    handleExpression(expr, unwrapExprChild, context);\n  }\n\n  if (labelFilterChild) {\n    handleExpression(expr, labelFilterChild, context);\n  }\n\n  if (unwrapChild) {\n    if (unwrapChild.nextSibling?.type.name === 'ConvOp') {\n      const convOp = unwrapChild.nextSibling;\n      const identifier = convOp.nextSibling;\n      return {\n        operation: {\n          id: 'unwrap',\n          params: [getString(expr, identifier), getString(expr, convOp)],\n        },\n      };\n    }\n\n    return {\n      operation: {\n        id: 'unwrap',\n        params: [getString(expr, unwrapChild?.nextSibling), ''],\n      },\n    };\n  }\n\n  return {};\n}\nfunction handleRangeAggregation(expr: string, node: SyntaxNode, context: Context) {\n  const nameNode = node.getChild('RangeOp');\n  const funcName = getString(expr, nameNode);\n  const number = node.getChild('Number');\n  const logExpr = node.getChild('LogRangeExpr');\n  const params = number !== null && number !== undefined ? [getString(expr, number)] : [];\n\n  let match = getString(expr, node).match(/\\[(.+)\\]/);\n  if (match?.[1]) {\n    params.push(match[1]);\n  }\n\n  const op = {\n    id: funcName,\n    params,\n  };\n\n  if (logExpr) {\n    handleExpression(expr, logExpr, context);\n  }\n\n  return op;\n}\n\nfunction handleVectorAggregation(expr: string, node: SyntaxNode, context: Context) {\n  const nameNode = node.getChild('VectorOp');\n  let funcName = getString(expr, nameNode);\n\n  const grouping = node.getChild('Grouping');\n  const params = [];\n\n  const numberNode = node.getChild('Number');\n\n  if (numberNode) {\n    params.push(Number(getString(expr, numberNode)));\n  }\n\n  if (grouping) {\n    const byModifier = grouping.getChild(`By`);\n    if (byModifier && funcName) {\n      funcName = `__${funcName}_by`;\n    }\n\n    const withoutModifier = grouping.getChild(`Without`);\n    if (withoutModifier) {\n      funcName = `__${funcName}_without`;\n    }\n\n    params.push(...getAllByType(expr, grouping, 'Identifier'));\n  }\n\n  const metricExpr = node.getChild('MetricExpr');\n  const op: QueryBuilderOperation = { id: funcName, params };\n\n  if (metricExpr) {\n    handleExpression(expr, metricExpr, context);\n  }\n\n  return op;\n}\n\nconst operatorToOpName = binaryScalarDefs.reduce((acc, def) => {\n  acc[def.sign] = {\n    id: def.id,\n    comparison: def.comparison,\n  };\n  return acc;\n}, {} as Record<string, { id: string; comparison?: boolean }>);\n\n/**\n * Right now binary expressions can be represented in 2 way in visual query. As additional operation in case it is\n * just operation with scalar or it creates a binaryQuery when it's 2 queries.\n * @param expr\n * @param node\n * @param context\n */\nfunction handleBinary(expr: string, node: SyntaxNode, context: Context) {\n  const visQuery = context.query;\n  const left = node.firstChild!;\n  const op = getString(expr, left.nextSibling);\n  const binModifier = getBinaryModifier(expr, node.getChild('BinModifiers'));\n\n  const right = node.lastChild!;\n\n  const opDef = operatorToOpName[op];\n\n  const leftNumber = getLastChildWithSelector(left, 'MetricExpr.LiteralExpr.Number');\n  const rightNumber = getLastChildWithSelector(right, 'MetricExpr.LiteralExpr.Number');\n\n  const rightBinary = right.getChild('BinOpExpr');\n\n  if (leftNumber) {\n    // TODO: this should be already handled in case parent is binary expression as it has to be added to parent\n    //  if query starts with a number that isn't handled now.\n  } else {\n    // If this is binary we don't really know if there is a query or just chained scalars. So\n    // we have to traverse a bit deeper to know\n    handleExpression(expr, left, context);\n  }\n\n  if (rightNumber) {\n    visQuery.operations.push(makeBinOp(opDef, expr, right, !!binModifier?.isBool));\n  } else if (rightBinary) {\n    // Due to the way binary ops are parsed we can get a binary operation on the right that starts with a number which\n    // is a factor for a current binary operation. So we have to add it as an operation now.\n    const leftMostChild = getLeftMostChild(right);\n    if (leftMostChild?.name === 'Number') {\n      visQuery.operations.push(makeBinOp(opDef, expr, leftMostChild, !!binModifier?.isBool));\n    }\n\n    // If we added the first number literal as operation here we still can continue and handle the rest as the first\n    // number will be just skipped.\n    handleExpression(expr, right, context);\n  } else {\n    visQuery.binaryQueries = visQuery.binaryQueries || [];\n    const binQuery: LokiVisualQueryBinary = {\n      operator: op,\n      query: {\n        labels: [],\n        operations: [],\n      },\n    };\n    if (binModifier?.isMatcher) {\n      binQuery.vectorMatchesType = binModifier.matchType;\n      binQuery.vectorMatches = binModifier.matches;\n    }\n    visQuery.binaryQueries.push(binQuery);\n    handleExpression(expr, right, {\n      query: binQuery.query,\n      errors: context.errors,\n    });\n  }\n}\n\nfunction getBinaryModifier(\n  expr: string,\n  node: SyntaxNode | null\n):\n  | { isBool: true; isMatcher: false }\n  | { isBool: false; isMatcher: true; matches: string; matchType: 'ignoring' | 'on' }\n  | undefined {\n  if (!node) {\n    return undefined;\n  }\n  if (node.getChild('Bool')) {\n    return { isBool: true, isMatcher: false };\n  } else {\n    const matcher = node.getChild('OnOrIgnoring');\n    if (!matcher) {\n      // Not sure what this could be, maybe should be an error.\n      return undefined;\n    }\n    const labels = getString(expr, matcher.getChild('GroupingLabels')?.getChild('GroupingLabelList'));\n    return {\n      isMatcher: true,\n      isBool: false,\n      matches: labels,\n      matchType: matcher.getChild('On') ? 'on' : 'ignoring',\n    };\n  }\n}\n\nfunction isIntervalVariableError(node: SyntaxNode) {\n  return node?.parent?.name === 'Range';\n}\n\nfunction handleQuotes(string: string) {\n  if (string[0] === `\"` && string[string.length - 1] === `\"`) {\n    return string.replace(/\"/g, '').replace(/\\\\\\\\/g, '\\\\');\n  }\n  return string.replace(/`/g, '');\n}\n\n/**\n * Simple helper to traverse the syntax tree. Instead of node.getChild('foo')?.getChild('bar')?.getChild('baz') you\n * can write getChildWithSelector(node, 'foo.bar.baz')\n * @param node\n * @param selector\n */\nfunction getLastChildWithSelector(node: SyntaxNode, selector: string) {\n  let child: SyntaxNode | null = node;\n  const children = selector.split('.');\n  for (const s of children) {\n    child = child.getChild(s);\n    if (!child) {\n      return null;\n    }\n  }\n  return child;\n}\n\n/**\n * Helper function to enrich error text with information that visual query builder doesn't support that logQL\n * @param expr\n * @param node\n * @param error\n */\nfunction createNotSupportedError(expr: string, node: SyntaxNode, error: string) {\n  const err = makeError(expr, node);\n  err.text = `${error}: ${err.text}`;\n  return err;\n}\n\nfunction isEmptyQuery(query: LokiVisualQuery) {\n  if (query.labels.length === 0 && query.operations.length === 0) {\n    return true;\n  }\n  return false;\n}\n","import { sortBy } from 'lodash';\n\nimport { LineComment, parser } from '@grafana/lezer-logql';\n\nimport { QueryBuilderLabelFilter } from '../prometheus/querybuilder/shared/types';\n\nimport { LokiQueryModeller } from './querybuilder/LokiQueryModeller';\nimport { buildVisualQueryFromString } from './querybuilder/parsing';\n\ntype Position = { from: number; to: number };\n/**\n * Adds label filter to existing query. Useful for query modification for example for ad hoc filters.\n *\n * It uses LogQL parser to find instances of labels, alters them and then splices them back into the query.\n * In a case when we have parser, instead of adding new instance of label it adds label filter after the parser.\n *\n * This operates on substrings of the query with labels and operates just on those. This makes this\n * more robust and can alter even invalid queries, and preserves in general the query structure and whitespace.\n *\n * @param query\n * @param key\n * @param value\n * @param operator\n */\nexport function addLabelToQuery(query: string, key: string, operator: string, value: string): string {\n  if (!key || !value) {\n    throw new Error('Need label to add to query.');\n  }\n\n  const streamSelectorPositions = getStreamSelectorPositions(query);\n  const parserPositions = getParserPositions(query);\n  const labelFilterPositions = getLabelFilterPositions(query);\n  if (!streamSelectorPositions.length) {\n    return query;\n  }\n\n  const filter = toLabelFilter(key, value, operator);\n  // If we have label filters or parser, we want to add new label filter after the last one\n  if (labelFilterPositions.length || parserPositions.length) {\n    const positionToAdd = findLastPosition([...labelFilterPositions, ...parserPositions]);\n    return addFilterAsLabelFilter(query, [positionToAdd], filter);\n  } else {\n    return addFilterToStreamSelector(query, streamSelectorPositions, filter);\n  }\n}\n\n/**\n * Adds parser to existing query. Useful for query modification for hints.\n * It uses LogQL parser to find instances of stream selectors or line filters and adds parser after them.\n *\n * @param query\n * @param parser\n */\nexport function addParserToQuery(query: string, parser: string): string {\n  const lineFilterPositions = getLineFiltersPositions(query);\n\n  if (lineFilterPositions.length) {\n    return addParser(query, lineFilterPositions, parser);\n  } else {\n    const streamSelectorPositions = getStreamSelectorPositions(query);\n    return addParser(query, streamSelectorPositions, parser);\n  }\n}\n\n/**\n * Adds filtering for pipeline errors to existing query. Useful for query modification for hints.\n * It uses LogQL parser to find parsers and adds pipeline errors filtering after them.\n *\n * @param query\n */\nexport function addNoPipelineErrorToQuery(query: string): string {\n  const parserPositions = getParserPositions(query);\n  if (!parserPositions.length) {\n    return query;\n  }\n\n  const filter = toLabelFilter('__error__', '', '=');\n  return addFilterAsLabelFilter(query, parserPositions, filter);\n}\n\n/**\n * Adds label format to existing query. Useful for query modification for hints.\n * It uses LogQL parser to find log query and add label format at the end.\n *\n * @param query\n * @param labelFormat\n */\nexport function addLabelFormatToQuery(query: string, labelFormat: { originalLabel: string; renameTo: string }): string {\n  const logQueryPositions = getLogQueryPositions(query);\n  return addLabelFormat(query, logQueryPositions, labelFormat);\n}\n\n/**\n * Removes all comments from query.\n * It uses  LogQL parser to find all LineComments and removes them.\n */\nexport function removeCommentsFromQuery(query: string): string {\n  const lineCommentPositions = getLineCommentPositions(query);\n\n  if (!lineCommentPositions.length) {\n    return query;\n  }\n\n  let newQuery = '';\n  let prev = 0;\n\n  for (let lineCommentPosition of lineCommentPositions) {\n    const beforeComment = query.substring(prev, lineCommentPosition.from);\n    const afterComment = query.substring(lineCommentPosition.to);\n\n    newQuery += beforeComment + afterComment;\n    prev = lineCommentPosition.to;\n  }\n  return newQuery;\n}\n\n/**\n * Parse the string and get all Selector positions in the query together with parsed representation of the\n * selector.\n * @param query\n */\nfunction getStreamSelectorPositions(query: string): Position[] {\n  const tree = parser.parse(query);\n  const positions: Position[] = [];\n  tree.iterate({\n    enter: (type, from, to, get): false | void => {\n      if (type.name === 'Selector') {\n        positions.push({ from, to });\n        return false;\n      }\n    },\n  });\n  return positions;\n}\n\n/**\n * Parse the string and get all LabelParser positions in the query.\n * @param query\n */\nexport function getParserPositions(query: string): Position[] {\n  const tree = parser.parse(query);\n  const positions: Position[] = [];\n  tree.iterate({\n    enter: (type, from, to, get): false | void => {\n      if (type.name === 'LabelParser' || type.name === 'JsonExpressionParser') {\n        positions.push({ from, to });\n        return false;\n      }\n    },\n  });\n  return positions;\n}\n\n/**\n * Parse the string and get all LabelFilter positions in the query.\n * @param query\n */\nexport function getLabelFilterPositions(query: string): Position[] {\n  const tree = parser.parse(query);\n  const positions: Position[] = [];\n  tree.iterate({\n    enter: (type, from, to, get): false | void => {\n      if (type.name === 'LabelFilter') {\n        positions.push({ from, to });\n        return false;\n      }\n    },\n  });\n  return positions;\n}\n\n/**\n * Parse the string and get all Line filter positions in the query.\n * @param query\n */\nfunction getLineFiltersPositions(query: string): Position[] {\n  const tree = parser.parse(query);\n  const positions: Position[] = [];\n  tree.iterate({\n    enter: (type, from, to, get): false | void => {\n      if (type.name === 'LineFilters') {\n        positions.push({ from, to });\n        return false;\n      }\n    },\n  });\n  return positions;\n}\n\n/**\n * Parse the string and get all Log query positions in the query.\n * @param query\n */\nfunction getLogQueryPositions(query: string): Position[] {\n  const tree = parser.parse(query);\n  const positions: Position[] = [];\n  tree.iterate({\n    enter: (type, from, to, get): false | void => {\n      if (type.name === 'LogExpr') {\n        positions.push({ from, to });\n        return false;\n      }\n\n      // This is a case in metrics query\n      if (type.name === 'LogRangeExpr') {\n        // Unfortunately, LogRangeExpr includes both log and non-log (e.g. Duration/Range/...) parts of query.\n        // We get position of all log-parts within LogRangeExpr: Selector, PipelineExpr and UnwrapExpr.\n        const logPartsPositions: Position[] = [];\n        const selector = get().getChild('Selector');\n        if (selector) {\n          logPartsPositions.push({ from: selector.from, to: selector.to });\n        }\n\n        const pipeline = get().getChild('PipelineExpr');\n        if (pipeline) {\n          logPartsPositions.push({ from: pipeline.from, to: pipeline.to });\n        }\n\n        const unwrap = get().getChild('UnwrapExpr');\n        if (unwrap) {\n          logPartsPositions.push({ from: unwrap.from, to: unwrap.to });\n        }\n\n        // We sort them and then pick \"from\" from first position and \"to\" from last position.\n        const sorted = sortBy(logPartsPositions, (position) => position.to);\n        positions.push({ from: sorted[0].from, to: sorted[sorted.length - 1].to });\n        return false;\n      }\n    },\n  });\n  return positions;\n}\n\nfunction toLabelFilter(key: string, value: string, operator: string): QueryBuilderLabelFilter {\n  // We need to make sure that we convert the value back to string because it may be a number\n  return { label: key, op: operator, value };\n}\n\n/**\n * Add filter as to stream selectors\n * @param query\n * @param vectorSelectorPositions\n * @param filter\n */\nfunction addFilterToStreamSelector(\n  query: string,\n  vectorSelectorPositions: Position[],\n  filter: QueryBuilderLabelFilter\n): string {\n  const modeller = new LokiQueryModeller();\n  let newQuery = '';\n  let prev = 0;\n\n  for (let i = 0; i < vectorSelectorPositions.length; i++) {\n    // This is basically just doing splice on a string for each matched vector selector.\n\n    const match = vectorSelectorPositions[i];\n    const isLast = i === vectorSelectorPositions.length - 1;\n\n    const start = query.substring(prev, match.from);\n    const end = isLast ? query.substring(match.to) : '';\n    const matchVisQuery = buildVisualQueryFromString(query.substring(match.from, match.to));\n\n    if (!labelExists(matchVisQuery.query.labels, filter)) {\n      // We don't want to add duplicate labels.\n      matchVisQuery.query.labels.push(filter);\n    }\n    const newLabels = modeller.renderQuery(matchVisQuery.query);\n    newQuery += start + newLabels + end;\n    prev = match.to;\n  }\n  return newQuery;\n}\n\n/**\n * Add filter as label filter after the parsers\n * @param query\n * @param positionsToAddAfter\n * @param filter\n */\nfunction addFilterAsLabelFilter(\n  query: string,\n  positionsToAddAfter: Position[],\n  filter: QueryBuilderLabelFilter\n): string {\n  let newQuery = '';\n  let prev = 0;\n\n  for (let i = 0; i < positionsToAddAfter.length; i++) {\n    // This is basically just doing splice on a string for each matched vector selector.\n    const match = positionsToAddAfter[i];\n    const isLast = i === positionsToAddAfter.length - 1;\n\n    const start = query.substring(prev, match.to);\n    const end = isLast ? query.substring(match.to) : '';\n\n    const labelFilter = ` | ${filter.label}${filter.op}\\`${filter.value}\\``;\n    newQuery += start + labelFilter + end;\n    prev = match.to;\n  }\n  return newQuery;\n}\n\n/**\n * Add parser after line filter or stream selector\n * @param query\n * @param queryPartPositions\n * @param parser\n */\nfunction addParser(query: string, queryPartPositions: Position[], parser: string): string {\n  let newQuery = '';\n  let prev = 0;\n\n  for (let i = 0; i < queryPartPositions.length; i++) {\n    // Splice on a string for each matched vector selector\n    const match = queryPartPositions[i];\n    const isLast = i === queryPartPositions.length - 1;\n\n    const start = query.substring(prev, match.to);\n    const end = isLast ? query.substring(match.to) : '';\n\n    // Add parser\n    newQuery += start + ` | ${parser}` + end;\n    prev = match.to;\n  }\n  return newQuery;\n}\n\n/**\n * Add filter as label filter after the parsers\n * @param query\n * @param logQueryPositions\n * @param labelFormat\n */\nfunction addLabelFormat(\n  query: string,\n  logQueryPositions: Position[],\n  labelFormat: { originalLabel: string; renameTo: string }\n): string {\n  let newQuery = '';\n  let prev = 0;\n\n  for (let i = 0; i < logQueryPositions.length; i++) {\n    // This is basically just doing splice on a string for each matched vector selector.\n    const match = logQueryPositions[i];\n    const isLast = i === logQueryPositions.length - 1;\n\n    const start = query.substring(prev, match.to);\n    const end = isLast ? query.substring(match.to) : '';\n\n    const labelFilter = ` | label_format ${labelFormat.renameTo}=${labelFormat.originalLabel}`;\n    newQuery += start + labelFilter + end;\n    prev = match.to;\n  }\n  return newQuery;\n}\n\nfunction getLineCommentPositions(query: string): Position[] {\n  const tree = parser.parse(query);\n  const positions: Position[] = [];\n  tree.iterate({\n    enter: (type, from, to, get): false | void => {\n      if (type.id === LineComment) {\n        positions.push({ from, to });\n        return false;\n      }\n    },\n  });\n  return positions;\n}\n\n/**\n * Check if label exists in the list of labels but ignore the operator.\n * @param labels\n * @param filter\n */\nfunction labelExists(labels: QueryBuilderLabelFilter[], filter: QueryBuilderLabelFilter) {\n  return labels.find((label) => label.label === filter.label && label.value === filter.value);\n}\n\n/**\n * Return the last position based on \"to\" property\n * @param positions\n */\nfunction findLastPosition(positions: Position[]): Position {\n  return positions.reduce((prev, current) => (prev.to > current.to ? prev : current));\n}\n","import { DataFrame, QueryHint } from '@grafana/data';\n\nimport { isQueryPipelineErrorFiltering, isQueryWithLabelFormat, isQueryWithParser } from './query_utils';\nimport {\n  dataFrameHasLevelLabel,\n  extractHasErrorLabelFromDataFrame,\n  extractLevelLikeLabelFromDataFrame,\n  extractLogParserFromDataFrame,\n} from './responseUtils';\n\nexport function getQueryHints(query: string, series: DataFrame[]): QueryHint[] {\n  if (series.length === 0) {\n    return [];\n  }\n\n  const hints: QueryHint[] = [];\n  const { queryWithParser, parserCount } = isQueryWithParser(query);\n\n  if (!queryWithParser) {\n    const { hasLogfmt, hasJSON } = extractLogParserFromDataFrame(series[0]);\n    if (hasJSON) {\n      hints.push({\n        type: 'ADD_JSON_PARSER',\n        label: 'Selected log stream selector has JSON formatted logs.',\n        fix: {\n          label: 'Consider using JSON parser.',\n          action: {\n            type: 'ADD_JSON_PARSER',\n            query,\n          },\n        },\n      });\n    }\n\n    if (hasLogfmt) {\n      hints.push({\n        type: 'ADD_LOGFMT_PARSER',\n        label: 'Selected log stream selector has logfmt formatted logs.',\n        fix: {\n          label: 'Consider using logfmt parser to turn key-value pairs in your log lines to labels.',\n          action: {\n            type: 'ADD_LOGFMT_PARSER',\n            query,\n          },\n        },\n      });\n    }\n  }\n\n  if (queryWithParser) {\n    // To keep this simple, we consider pipeline error filtering hint only is query has up to 1 parser\n    if (parserCount === 1) {\n      const hasPipelineErrorFiltering = isQueryPipelineErrorFiltering(query);\n      const hasError = extractHasErrorLabelFromDataFrame(series[0]);\n      if (hasError && !hasPipelineErrorFiltering) {\n        hints.push({\n          type: 'ADD_NO_PIPELINE_ERROR',\n          label: 'Some logs in your selected log streams have parsing error.',\n          fix: {\n            label: 'Consider filtering out logs with parsing errors.',\n            action: {\n              type: 'ADD_NO_PIPELINE_ERROR',\n              query,\n            },\n          },\n        });\n      }\n    }\n  }\n\n  const queryWithLabelFormat = isQueryWithLabelFormat(query);\n  if (!queryWithLabelFormat) {\n    const hasLevel = dataFrameHasLevelLabel(series[0]);\n    const levelLikeLabel = extractLevelLikeLabelFromDataFrame(series[0]);\n\n    // Add hint only if we don't have \"level\" label and have level-like label\n    if (!hasLevel && levelLikeLabel) {\n      hints.push({\n        type: 'ADD_LEVEL_LABEL_FORMAT',\n        label: `Some logs in your selected log stream have \"${levelLikeLabel}\" label.`,\n        fix: {\n          label: `If ${levelLikeLabel} label has level values, consider using label_format to rename it to \"level\". Level label can be then visualized in log volumes.`,\n          action: {\n            type: 'ADD_LEVEL_LABEL_FORMAT',\n            query,\n            options: {\n              renameTo: 'level',\n              originalLabel: levelLikeLabel,\n            },\n          },\n        },\n      });\n    }\n  }\n\n  return hints;\n}\n","import { DataFrame, Field, SortedVector } from '@grafana/data';\n\ntype SortDirection = 'ASCENDING' | 'DESCENDING';\n\n// creates the `index` for the sorting.\n// this is needed by the `SortedVector`.\n// the index is an array of numbers, and it defines an order.\n// at every slot in the index the values is the position of\n// the sorted item.\n// for example, an index of [3,1,2] means that\n// in the dataframe, that has 3 rows, after sorting:\n// - the third row will become the first\n// - the first row will become the second\n// - the second row will become the third\nfunction makeIndex(field: Field<string>, dir: SortDirection): number[] {\n  const fieldValues: string[] = field.values.toArray();\n\n  // we first build an array which is [0,1,2,3....]\n  const index = Array(fieldValues.length);\n  for (let i = 0; i < index.length; i++) {\n    index[i] = i;\n  }\n\n  const isAsc = dir === 'ASCENDING';\n\n  index.sort((a: number, b: number): number => {\n    // we need to answer this question:\n    // in the field-used-for-sorting, how would we compare value-at-index-a to value-at-index-b?\n    const valA = fieldValues[a];\n    const valB = fieldValues[b];\n    if (valA < valB) {\n      return isAsc ? -1 : 1;\n    }\n\n    if (valA > valB) {\n      return isAsc ? 1 : -1;\n    }\n\n    return 0;\n  });\n\n  return index;\n}\n\n// sort a dataframe that is in the Loki format ascending or descending,\n// based on the nanosecond-timestamp\nexport function sortDataFrameByTime(frame: DataFrame, dir: SortDirection): DataFrame {\n  const { fields, ...rest } = frame;\n\n  // we use the approach used in @grafana/data/sortDataframe.\n  // we cannot use it directly, because our tsNs field has a type=time,\n  // so we have to build the `index` manually.\n\n  const tsNsField = fields.find((field) => field.name === 'tsNs');\n  if (tsNsField === undefined) {\n    throw new Error('missing nanosecond-timestamp field. should never happen');\n  }\n\n  const index = makeIndex(tsNsField, dir);\n\n  return {\n    ...rest,\n    fields: fields.map((field) => ({\n      ...field,\n      values: new SortedVector(field.values, index),\n    })),\n  };\n\n  return frame;\n}\n","import { map, Observable, defer, mergeMap } from 'rxjs';\n\nimport { DataFrameJSON, DataQueryRequest, DataQueryResponse, LiveChannelScope, LoadingState } from '@grafana/data';\nimport { getGrafanaLiveSrv } from '@grafana/runtime';\nimport { StreamingDataFrame } from 'app/features/live/data/StreamingDataFrame';\n\nimport { LokiDatasource } from './datasource';\nimport { LokiQuery } from './types';\n\n/**\n * Calculate a unique key for the query.  The key is used to pick a channel and should\n * be unique for each distinct query execution plan.  This key is not secure and is only picked to avoid\n * possible collisions\n */\nexport async function getLiveStreamKey(query: LokiQuery): Promise<string> {\n  const str = JSON.stringify({ expr: query.expr });\n\n  const msgUint8 = new TextEncoder().encode(str); // encode as (utf-8) Uint8Array\n  const hashBuffer = await crypto.subtle.digest('SHA-1', msgUint8); // hash the message\n  const hashArray = Array.from(new Uint8Array(hashBuffer.slice(0, 8))); // first 8 bytes\n  return hashArray.map((b) => b.toString(16).padStart(2, '0')).join('');\n}\n\n// This will get both v1 and v2 result formats\nexport function doLokiChannelStream(\n  query: LokiQuery,\n  ds: LokiDatasource,\n  options: DataQueryRequest<LokiQuery>\n): Observable<DataQueryResponse> {\n  // maximum time to keep values\n  const range = options.range;\n  const maxDelta = range.to.valueOf() - range.from.valueOf() + 1000;\n  let maxLength = options.maxDataPoints ?? 1000;\n  if (maxLength > 100) {\n    // for small buffers, keep them small\n    maxLength *= 2;\n  }\n\n  let frame: StreamingDataFrame | undefined = undefined;\n  const updateFrame = (msg: any) => {\n    if (msg?.message) {\n      const p = msg.message as DataFrameJSON;\n      if (!frame) {\n        frame = StreamingDataFrame.fromDataFrameJSON(p, {\n          maxLength,\n          maxDelta,\n          displayNameFormat: query.legendFormat,\n        });\n      } else {\n        frame.push(p);\n      }\n    }\n    return frame;\n  };\n\n  return defer(() => getLiveStreamKey(query)).pipe(\n    mergeMap((key) => {\n      return getGrafanaLiveSrv()\n        .getStream<any>({\n          scope: LiveChannelScope.DataSource,\n          namespace: ds.uid,\n          path: `tail/${key}`,\n          data: {\n            ...query,\n            timeRange: {\n              from: range.from.valueOf().toString(),\n              to: range.to.valueOf().toString(),\n            },\n          },\n        })\n        .pipe(\n          map((evt) => {\n            const frame = updateFrame(evt);\n            return {\n              data: frame ? [frame] : [],\n              state: LoadingState.Streaming,\n            };\n          })\n        );\n    })\n  );\n}\n","import { cloneDeep, map as lodashMap } from 'lodash';\nimport { lastValueFrom, merge, Observable, of, throwError } from 'rxjs';\nimport { catchError, map, switchMap } from 'rxjs/operators';\n\nimport {\n  AnnotationEvent,\n  AnnotationQueryRequest,\n  CoreApp,\n  DataFrame,\n  DataFrameView,\n  DataQueryError,\n  DataQueryRequest,\n  DataQueryResponse,\n  DataSourceInstanceSettings,\n  DataSourceWithLogsContextSupport,\n  DataSourceWithLogsVolumeSupport,\n  DataSourceWithQueryExportSupport,\n  DataSourceWithQueryImportSupport,\n  dateMath,\n  DateTime,\n  FieldCache,\n  AbstractQuery,\n  FieldType,\n  getLogLevelFromKey,\n  Labels,\n  LoadingState,\n  LogLevel,\n  LogRowModel,\n  ScopedVars,\n  TimeRange,\n  rangeUtil,\n  toUtc,\n  QueryHint,\n  getDefaultTimeRange,\n  QueryFixAction,\n} from '@grafana/data';\nimport { FetchError, config, DataSourceWithBackend } from '@grafana/runtime';\nimport { RowContextOptions } from '@grafana/ui/src/components/Logs/LogRowContextProvider';\nimport { queryLogsVolume } from 'app/core/logsModel';\nimport { convertToWebSocketUrl } from 'app/core/utils/explore';\nimport { getTimeSrv, TimeSrv } from 'app/features/dashboard/services/TimeSrv';\nimport { getTemplateSrv, TemplateSrv } from 'app/features/templating/template_srv';\n\nimport { serializeParams } from '../../../core/utils/fetch';\nimport { renderLegendFormat } from '../prometheus/legend';\nimport { replaceVariables, returnVariables } from '../prometheus/querybuilder/shared/parsingUtils';\n\nimport { transformBackendResult } from './backendResultTransformer';\nimport { LokiAnnotationsQueryEditor } from './components/AnnotationsQueryEditor';\nimport LanguageProvider from './language_provider';\nimport { escapeLabelValueInSelector } from './language_utils';\nimport { LiveStreams, LokiLiveTarget } from './live_streams';\nimport {\n  addLabelFormatToQuery,\n  addLabelToQuery,\n  addNoPipelineErrorToQuery,\n  addParserToQuery,\n  removeCommentsFromQuery,\n} from './modifyQuery';\nimport { getQueryHints } from './queryHints';\nimport { getNormalizedLokiQuery, isLogsQuery, isValidQuery } from './query_utils';\nimport { sortDataFrameByTime } from './sortDataFrame';\nimport { doLokiChannelStream } from './streaming';\nimport { LokiOptions, LokiQuery, LokiQueryDirection, LokiQueryType } from './types';\n\nexport type RangeQueryOptions = DataQueryRequest<LokiQuery> | AnnotationQueryRequest<LokiQuery>;\nexport const DEFAULT_MAX_LINES = 1000;\nexport const LOKI_ENDPOINT = '/loki/api/v1';\nconst NS_IN_MS = 1000000;\n\nfunction makeRequest(query: LokiQuery, range: TimeRange, app: CoreApp, requestId: string): DataQueryRequest<LokiQuery> {\n  const intervalInfo = rangeUtil.calculateInterval(range, 1);\n  return {\n    targets: [query],\n    requestId,\n    interval: intervalInfo.interval,\n    intervalMs: intervalInfo.intervalMs,\n    range: range,\n    scopedVars: {},\n    timezone: 'UTC',\n    app,\n    startTime: Date.now(),\n  };\n}\n\nexport class LokiDatasource\n  extends DataSourceWithBackend<LokiQuery, LokiOptions>\n  implements\n    DataSourceWithLogsContextSupport,\n    DataSourceWithLogsVolumeSupport<LokiQuery>,\n    DataSourceWithQueryImportSupport<LokiQuery>,\n    DataSourceWithQueryExportSupport<LokiQuery>\n{\n  private streams = new LiveStreams();\n  languageProvider: LanguageProvider;\n  maxLines: number;\n\n  constructor(\n    private instanceSettings: DataSourceInstanceSettings<LokiOptions>,\n    private readonly templateSrv: TemplateSrv = getTemplateSrv(),\n    private readonly timeSrv: TimeSrv = getTimeSrv()\n  ) {\n    super(instanceSettings);\n\n    this.languageProvider = new LanguageProvider(this);\n    const settingsData = instanceSettings.jsonData || {};\n    this.maxLines = parseInt(settingsData.maxLines ?? '0', 10) || DEFAULT_MAX_LINES;\n    this.annotations = {\n      QueryEditor: LokiAnnotationsQueryEditor,\n    };\n  }\n\n  getLogsVolumeDataProvider(request: DataQueryRequest<LokiQuery>): Observable<DataQueryResponse> | undefined {\n    const isQuerySuitable = (query: LokiQuery) => {\n      const normalized = getNormalizedLokiQuery(query);\n      const { expr } = normalized;\n      // it has to be a logs-producing range-query\n      return expr && isLogsQuery(expr) && normalized.queryType === LokiQueryType.Range;\n    };\n\n    const isLogsVolumeAvailable = request.targets.some(isQuerySuitable);\n\n    if (!isLogsVolumeAvailable) {\n      return undefined;\n    }\n\n    const logsVolumeRequest = cloneDeep(request);\n    logsVolumeRequest.targets = logsVolumeRequest.targets.filter(isQuerySuitable).map((target) => {\n      const query = removeCommentsFromQuery(target.expr);\n      return {\n        ...target,\n        instant: false,\n        volumeQuery: true,\n        expr: `sum by (level) (count_over_time(${query}[$__interval]))`,\n      };\n    });\n\n    return queryLogsVolume(this, logsVolumeRequest, {\n      extractLevel,\n      range: request.range,\n      targets: request.targets,\n    });\n  }\n\n  query(request: DataQueryRequest<LokiQuery>): Observable<DataQueryResponse> {\n    const queries = request.targets\n      .map(getNormalizedLokiQuery) // \"fix\" the `.queryType` prop\n      .map((q) => ({ ...q, maxLines: q.maxLines || this.maxLines })); // set maxLines if not set\n\n    const fixedRequest = {\n      ...request,\n      targets: queries,\n    };\n\n    const streamQueries = fixedRequest.targets.filter((q) => q.queryType === LokiQueryType.Stream);\n    if (config.featureToggles.lokiLive && streamQueries.length > 0 && fixedRequest.rangeRaw?.to === 'now') {\n      // this is still an in-development feature,\n      // we do not support mixing stream-queries with normal-queries for now.\n      const streamRequest = {\n        ...fixedRequest,\n        targets: streamQueries,\n      };\n      return merge(\n        ...streamQueries.map((q) =>\n          doLokiChannelStream(\n            this.applyTemplateVariables(q, request.scopedVars),\n            this, // the datasource\n            streamRequest\n          )\n        )\n      );\n    }\n\n    if (fixedRequest.liveStreaming) {\n      return this.runLiveQueryThroughBackend(fixedRequest);\n    } else {\n      return super\n        .query(fixedRequest)\n        .pipe(\n          map((response) =>\n            transformBackendResult(response, fixedRequest.targets, this.instanceSettings.jsonData.derivedFields ?? [])\n          )\n        );\n    }\n  }\n\n  runLiveQueryThroughBackend(request: DataQueryRequest<LokiQuery>): Observable<DataQueryResponse> {\n    // this only works in explore-mode, so variables don't need to be handled,\n    //  and only for logs-queries, not metric queries\n    const logsQueries = request.targets.filter((query) => query.expr !== '' && isLogsQuery(query.expr));\n\n    if (logsQueries.length === 0) {\n      return of({\n        data: [],\n        state: LoadingState.Done,\n      });\n    }\n\n    const subQueries = logsQueries.map((query) => {\n      const maxDataPoints = query.maxLines || this.maxLines;\n      // FIXME: currently we are running it through the frontend still.\n      return this.runLiveQuery(query, maxDataPoints);\n    });\n\n    return merge(...subQueries);\n  }\n\n  createLiveTarget(target: LokiQuery, maxDataPoints: number): LokiLiveTarget {\n    const query = target.expr;\n    const baseUrl = this.instanceSettings.url;\n    const params = serializeParams({ query });\n\n    return {\n      query,\n      url: convertToWebSocketUrl(`${baseUrl}/loki/api/v1/tail?${params}`),\n      refId: target.refId,\n      size: maxDataPoints,\n    };\n  }\n\n  /**\n   * Runs live queries which in this case means creating a websocket and listening on it for new logs.\n   * This returns a bit different dataFrame than runQueries as it returns single dataframe even if there are multiple\n   * Loki streams, sets only common labels on dataframe.labels and has additional dataframe.fields.labels for unique\n   * labels per row.\n   */\n  runLiveQuery = (target: LokiQuery, maxDataPoints: number): Observable<DataQueryResponse> => {\n    const liveTarget = this.createLiveTarget(target, maxDataPoints);\n\n    return this.streams.getStream(liveTarget).pipe(\n      map((data) => ({\n        data: data || [],\n        key: `loki-${liveTarget.refId}`,\n        state: LoadingState.Streaming,\n      })),\n      catchError((err: any) => {\n        return throwError(() => `Live tailing was stopped due to following error: ${err.reason}`);\n      })\n    );\n  };\n\n  getRangeScopedVars(range: TimeRange = this.timeSrv.timeRange()) {\n    const msRange = range.to.diff(range.from);\n    const sRange = Math.round(msRange / 1000);\n    return {\n      __range_ms: { text: msRange, value: msRange },\n      __range_s: { text: sRange, value: sRange },\n      __range: { text: sRange + 's', value: sRange + 's' },\n    };\n  }\n\n  interpolateVariablesInQueries(queries: LokiQuery[], scopedVars: ScopedVars): LokiQuery[] {\n    let expandedQueries = queries;\n    if (queries && queries.length) {\n      expandedQueries = queries.map((query) => ({\n        ...query,\n        datasource: this.getRef(),\n        expr: this.templateSrv.replace(query.expr, scopedVars, this.interpolateQueryExpr),\n      }));\n    }\n\n    return expandedQueries;\n  }\n\n  getQueryDisplayText(query: LokiQuery) {\n    return query.expr;\n  }\n\n  getTimeRangeParams() {\n    const timeRange = this.timeSrv.timeRange();\n    return { start: timeRange.from.valueOf() * NS_IN_MS, end: timeRange.to.valueOf() * NS_IN_MS };\n  }\n\n  async importFromAbstractQueries(abstractQueries: AbstractQuery[]): Promise<LokiQuery[]> {\n    await this.languageProvider.start();\n    const existingKeys = this.languageProvider.labelKeys;\n\n    if (existingKeys && existingKeys.length) {\n      abstractQueries = abstractQueries.map((abstractQuery) => {\n        abstractQuery.labelMatchers = abstractQuery.labelMatchers.filter((labelMatcher) => {\n          return existingKeys.includes(labelMatcher.name);\n        });\n        return abstractQuery;\n      });\n    }\n\n    return abstractQueries.map((abstractQuery) => this.languageProvider.importFromAbstractQuery(abstractQuery));\n  }\n\n  async exportToAbstractQueries(queries: LokiQuery[]): Promise<AbstractQuery[]> {\n    return queries.map((query) => this.languageProvider.exportToAbstractQuery(query));\n  }\n\n  async metadataRequest(url: string, params?: Record<string, string | number>) {\n    // url must not start with a `/`, otherwise the AJAX-request\n    // going from the browser will contain `//`, which can cause problems.\n    if (url.startsWith('/')) {\n      throw new Error(`invalid metadata request url: ${url}`);\n    }\n\n    const res = await this.getResource(url, params);\n    return res.data || [];\n  }\n\n  async metricFindQuery(query: string) {\n    if (!query) {\n      return Promise.resolve([]);\n    }\n\n    const interpolated = this.templateSrv.replace(query, {}, this.interpolateQueryExpr);\n    return await this.processMetricFindQuery(interpolated);\n  }\n\n  async processMetricFindQuery(query: string) {\n    const labelNamesRegex = /^label_names\\(\\)\\s*$/;\n    const labelValuesRegex = /^label_values\\((?:(.+),\\s*)?([a-zA-Z_][a-zA-Z0-9_]*)\\)\\s*$/;\n\n    const labelNames = query.match(labelNamesRegex);\n    if (labelNames) {\n      return await this.labelNamesQuery();\n    }\n\n    const labelValues = query.match(labelValuesRegex);\n    if (labelValues) {\n      // If we have query expr, use /series endpoint\n      if (labelValues[1]) {\n        return await this.labelValuesSeriesQuery(labelValues[1], labelValues[2]);\n      }\n      return await this.labelValuesQuery(labelValues[2]);\n    }\n\n    return Promise.resolve([]);\n  }\n\n  async labelNamesQuery() {\n    const url = 'labels';\n    const params = this.getTimeRangeParams();\n    const result = await this.metadataRequest(url, params);\n    return result.map((value: string) => ({ text: value }));\n  }\n\n  async labelValuesQuery(label: string) {\n    const params = this.getTimeRangeParams();\n    const url = `label/${label}/values`;\n    const result = await this.metadataRequest(url, params);\n    return result.map((value: string) => ({ text: value }));\n  }\n\n  async labelValuesSeriesQuery(expr: string, label: string) {\n    const timeParams = this.getTimeRangeParams();\n    const params = {\n      ...timeParams,\n      'match[]': expr,\n    };\n    const url = 'series';\n    const streams = new Set();\n    const result = await this.metadataRequest(url, params);\n    result.forEach((stream: { [key: string]: string }) => {\n      if (stream[label]) {\n        streams.add({ text: stream[label] });\n      }\n    });\n\n    return Array.from(streams);\n  }\n\n  async getDataSamples(query: LokiQuery): Promise<DataFrame[]> {\n    // Currently works only for log samples\n    if (!isValidQuery(query.expr) || !isLogsQuery(query.expr)) {\n      return [];\n    }\n\n    const lokiLogsQuery: LokiQuery = {\n      expr: query.expr,\n      queryType: LokiQueryType.Range,\n      refId: 'log-samples',\n      maxLines: 10,\n    };\n\n    // For samples, we use defaultTimeRange (now-6h/now) and limit od 10 lines so queries are small and fast\n    const timeRange = getDefaultTimeRange();\n    const request = makeRequest(lokiLogsQuery, timeRange, CoreApp.Explore, 'log-samples');\n    return await lastValueFrom(this.query(request).pipe(switchMap((res) => of(res.data))));\n  }\n\n  // By implementing getTagKeys and getTagValues we add ad-hoc filters functionality\n  async getTagKeys() {\n    return await this.labelNamesQuery();\n  }\n\n  async getTagValues(options: any = {}) {\n    return await this.labelValuesQuery(options.key);\n  }\n\n  interpolateQueryExpr(value: any, variable: any) {\n    // if no multi or include all do not regexEscape\n    if (!variable.multi && !variable.includeAll) {\n      return lokiRegularEscape(value);\n    }\n\n    if (typeof value === 'string') {\n      return lokiSpecialRegexEscape(value);\n    }\n\n    const escapedValues = lodashMap(value, lokiSpecialRegexEscape);\n    return escapedValues.join('|');\n  }\n\n  modifyQuery(query: LokiQuery, action: QueryFixAction): LokiQuery {\n    let expression = query.expr ?? '';\n    switch (action.type) {\n      case 'ADD_FILTER': {\n        if (action.options?.key && action.options?.value) {\n          expression = this.addLabelToQuery(expression, action.options.key, '=', action.options.value);\n        }\n        break;\n      }\n      case 'ADD_FILTER_OUT': {\n        if (action.options?.key && action.options?.value) {\n          expression = this.addLabelToQuery(expression, action.options.key, '!=', action.options.value);\n        }\n        break;\n      }\n      case 'ADD_LOGFMT_PARSER': {\n        expression = addParserToQuery(expression, 'logfmt');\n        break;\n      }\n      case 'ADD_JSON_PARSER': {\n        expression = addParserToQuery(expression, 'json');\n        break;\n      }\n      case 'ADD_NO_PIPELINE_ERROR': {\n        expression = addNoPipelineErrorToQuery(expression);\n        break;\n      }\n      case 'ADD_LEVEL_LABEL_FORMAT': {\n        if (action.options?.originalLabel && action.options?.renameTo) {\n          expression = addLabelFormatToQuery(expression, {\n            renameTo: action.options.renameTo,\n            originalLabel: action.options.originalLabel,\n          });\n        }\n        break;\n      }\n      default:\n        break;\n    }\n    return { ...query, expr: expression };\n  }\n\n  getTime(date: string | DateTime, roundUp: boolean) {\n    if (typeof date === 'string') {\n      date = dateMath.parse(date, roundUp)!;\n    }\n\n    return Math.ceil(date.valueOf() * 1e6);\n  }\n\n  getLogRowContext = async (row: LogRowModel, options?: RowContextOptions): Promise<{ data: DataFrame[] }> => {\n    const direction = (options && options.direction) || 'BACKWARD';\n    const limit = (options && options.limit) || 10;\n    const { query, range } = await this.prepareLogRowContextQueryTarget(row, limit, direction);\n\n    const processDataFrame = (frame: DataFrame): DataFrame => {\n      // log-row-context requires specific field-names to work, so we set them here: \"ts\", \"line\", \"id\"\n      const cache = new FieldCache(frame);\n      const timestampField = cache.getFirstFieldOfType(FieldType.time);\n      const lineField = cache.getFirstFieldOfType(FieldType.string);\n      const idField = cache.getFieldByName('id');\n\n      if (timestampField === undefined || lineField === undefined || idField === undefined) {\n        // this should never really happen, but i want to keep typescript happy\n        return { ...frame, fields: [] };\n      }\n\n      return {\n        ...frame,\n        fields: [\n          {\n            ...timestampField,\n            name: 'ts',\n          },\n          {\n            ...lineField,\n            name: 'line',\n          },\n          {\n            ...idField,\n            name: 'id',\n          },\n        ],\n      };\n    };\n\n    const processResults = (result: DataQueryResponse): DataQueryResponse => {\n      const frames: DataFrame[] = result.data;\n      const processedFrames = frames\n        .map((frame) => sortDataFrameByTime(frame, 'DESCENDING'))\n        .map((frame) => processDataFrame(frame)); // rename fields if needed\n\n      return {\n        ...result,\n        data: processedFrames,\n      };\n    };\n\n    // this can only be called from explore currently\n    const app = CoreApp.Explore;\n\n    return lastValueFrom(\n      this.query(makeRequest(query, range, app, `log-row-context-query-${direction}`)).pipe(\n        catchError((err) => {\n          const error: DataQueryError = {\n            message: 'Error during context query. Please check JS console logs.',\n            status: err.status,\n            statusText: err.statusText,\n          };\n          throw error;\n        }),\n        switchMap((res) => of(processResults(res)))\n      )\n    );\n  };\n\n  prepareLogRowContextQueryTarget = async (\n    row: LogRowModel,\n    limit: number,\n    direction: 'BACKWARD' | 'FORWARD'\n  ): Promise<{ query: LokiQuery; range: TimeRange }> => {\n    // need to await the languageProvider to be started to have all labels. This call is not blocking after it has been called once.\n    await this.languageProvider.start();\n    const labels = this.languageProvider.getLabelKeys();\n    const expr = Object.keys(row.labels)\n      .map((label: string) => {\n        if (labels.includes(label)) {\n          // escape backslashes in label as users can't escape them by themselves\n          return `${label}=\"${row.labels[label].replace(/\\\\/g, '\\\\\\\\')}\"`;\n        }\n        return '';\n      })\n      // Filter empty strings\n      .filter((label) => !!label)\n      .join(',');\n\n    const contextTimeBuffer = 2 * 60 * 60 * 1000; // 2h buffer\n\n    const queryDirection = direction === 'FORWARD' ? LokiQueryDirection.Forward : LokiQueryDirection.Backward;\n\n    const query: LokiQuery = {\n      expr: `{${expr}}`,\n      queryType: LokiQueryType.Range,\n      refId: '',\n      maxLines: limit,\n      direction: queryDirection,\n    };\n\n    const fieldCache = new FieldCache(row.dataFrame);\n    const tsField = fieldCache.getFirstFieldOfType(FieldType.time);\n    if (tsField === undefined) {\n      throw new Error('loki: dataframe missing time-field, should never happen');\n    }\n    const tsValue = tsField.values.get(row.rowIndex);\n    const timestamp = toUtc(tsValue);\n\n    const range =\n      queryDirection === LokiQueryDirection.Forward\n        ? {\n            // start param in Loki API is inclusive so we'll have to filter out the row that this request is based from\n            // and any other that were logged in the same ns but before the row. Right now these rows will be lost\n            // because the are before but came it he response that should return only rows after.\n            from: timestamp,\n            // convert to ns, we loose some precision here but it is not that important at the far points of the context\n            to: toUtc(row.timeEpochMs + contextTimeBuffer),\n          }\n        : {\n            // convert to ns, we loose some precision here but it is not that important at the far points of the context\n            from: toUtc(row.timeEpochMs - contextTimeBuffer),\n            to: timestamp,\n          };\n\n    return {\n      query,\n      range: {\n        from: range.from,\n        to: range.to,\n        raw: range,\n      },\n    };\n  };\n\n  testDatasource(): Promise<{ status: string; message: string }> {\n    // Consider only last 10 minutes otherwise request takes too long\n    const nowMs = Date.now();\n    const params = {\n      start: (nowMs - 10 * 60 * 1000) * NS_IN_MS,\n      end: nowMs * NS_IN_MS,\n    };\n\n    return this.metadataRequest('labels', params).then(\n      (values) => {\n        return values.length > 0\n          ? { status: 'success', message: 'Data source connected and labels found.' }\n          : {\n              status: 'error',\n              message:\n                'Data source connected, but no labels received. Verify that Loki and Promtail is configured properly.',\n            };\n      },\n      (err) => {\n        // we did a resource-call that failed.\n        // the only info we have, if exists, is err.data.message\n        // (when in development-mode, err.data.error exists too, but not in production-mode)\n        // things like err.status & err.statusText does not help,\n        // because those will only describe how the request between browser<>server failed\n        const info: string = err?.data?.message ?? '';\n        const infoInParentheses = info !== '' ? ` (${info})` : '';\n        const message = `Unable to fetch labels from Loki${infoInParentheses}, please check the server logs for more details`;\n        return { status: 'error', message: message };\n      }\n    );\n  }\n\n  async annotationQuery(options: any): Promise<AnnotationEvent[]> {\n    const { expr, maxLines, instant, tagKeys = '', titleFormat = '', textFormat = '' } = options.annotation;\n\n    if (!expr) {\n      return [];\n    }\n\n    const id = `annotation-${options.annotation.name}`;\n\n    const query: LokiQuery = {\n      refId: id,\n      expr,\n      maxLines,\n      instant,\n      queryType: instant ? LokiQueryType.Instant : LokiQueryType.Range,\n    };\n\n    const request = makeRequest(query, options.range, CoreApp.Dashboard, id);\n\n    const { data } = await lastValueFrom(this.query(request));\n\n    const annotations: AnnotationEvent[] = [];\n    const splitKeys: string[] = tagKeys.split(',').filter((v: string) => v !== '');\n\n    for (const frame of data) {\n      const view = new DataFrameView<{ Time: string; Line: string; labels: Labels }>(frame);\n\n      view.forEach((row) => {\n        const { labels } = row;\n\n        const maybeDuplicatedTags = Object.entries(labels)\n          .map(([key, val]) => [key, val.trim()]) // trim all label-values\n          .filter(([key, val]) => {\n            if (val === '') {\n              // remove empty\n              return false;\n            }\n\n            // if tags are specified, remove label if does not match tags\n            if (splitKeys.length && !splitKeys.includes(key)) {\n              return false;\n            }\n\n            return true;\n          })\n          .map(([key, val]) => val); // keep only the label-value\n\n        // remove duplicates\n        const tags = Array.from(new Set(maybeDuplicatedTags));\n\n        annotations.push({\n          time: new Date(row.Time).valueOf(),\n          title: renderLegendFormat(titleFormat, labels),\n          text: renderLegendFormat(textFormat, labels) || row.Line,\n          tags,\n        });\n      });\n    }\n\n    return annotations;\n  }\n\n  showContextToggle(row?: LogRowModel): boolean {\n    return (row && row.searchWords && row.searchWords.length > 0) === true;\n  }\n\n  processError(err: FetchError, target: LokiQuery) {\n    let error: DataQueryError = cloneDeep(err);\n    error.refId = target.refId;\n\n    if (error.data && err.data.message.includes('escape') && target.expr.includes('\\\\')) {\n      error.data.message = `Error: ${err.data.message}. Make sure that all special characters are escaped with \\\\. For more information on escaping of special characters visit LogQL documentation at https://grafana.com/docs/loki/latest/logql/.`;\n    }\n\n    return error;\n  }\n\n  addAdHocFilters(queryExpr: string) {\n    const adhocFilters = this.templateSrv.getAdhocFilters(this.name);\n    let expr = replaceVariables(queryExpr);\n\n    expr = adhocFilters.reduce((acc: string, filter: { key: string; operator: string; value: string }) => {\n      const { key, operator, value } = filter;\n      return this.addLabelToQuery(acc, key, operator, value);\n    }, expr);\n\n    return returnVariables(expr);\n  }\n\n  addLabelToQuery(queryExpr: string, key: string, operator: string, value: string) {\n    const escapedValue = escapeLabelValueInSelector(value, operator);\n    return addLabelToQuery(queryExpr, key, operator, escapedValue);\n  }\n\n  // Used when running queries through backend\n  filterQuery(query: LokiQuery): boolean {\n    if (query.hide || query.expr === '') {\n      return false;\n    }\n    return true;\n  }\n\n  // Used when running queries through backend\n  applyTemplateVariables(target: LokiQuery, scopedVars: ScopedVars): LokiQuery {\n    // We want to interpolate these variables on backend\n    const { __interval, __interval_ms, ...rest } = scopedVars;\n\n    const exprWithAdHoc = this.addAdHocFilters(target.expr);\n\n    return {\n      ...target,\n      legendFormat: this.templateSrv.replace(target.legendFormat, rest),\n      expr: this.templateSrv.replace(exprWithAdHoc, rest, this.interpolateQueryExpr),\n    };\n  }\n\n  interpolateString(string: string) {\n    return this.templateSrv.replace(string, undefined, this.interpolateQueryExpr);\n  }\n\n  getVariables(): string[] {\n    return this.templateSrv.getVariables().map((v) => `$${v.name}`);\n  }\n\n  getQueryHints(query: LokiQuery, result: DataFrame[]): QueryHint[] {\n    return getQueryHints(query.expr, result);\n  }\n}\n\nexport function lokiRegularEscape(value: any) {\n  if (typeof value === 'string') {\n    return value.replace(/'/g, \"\\\\\\\\'\");\n  }\n  return value;\n}\n\nexport function lokiSpecialRegexEscape(value: any) {\n  if (typeof value === 'string') {\n    return lokiRegularEscape(value.replace(/\\\\/g, '\\\\\\\\\\\\\\\\').replace(/[$^*{}\\[\\]+?.()|]/g, '\\\\\\\\$&'));\n  }\n  return value;\n}\n\nfunction extractLevel(dataFrame: DataFrame): LogLevel {\n  let valueField;\n  try {\n    valueField = new FieldCache(dataFrame).getFirstFieldOfType(FieldType.number);\n  } catch {}\n  return valueField?.labels ? getLogLevelFromLabels(valueField.labels) : LogLevel.unknown;\n}\n\nfunction getLogLevelFromLabels(labels: Labels): LogLevel {\n  const labelNames = ['level', 'lvl', 'loglevel'];\n  let levelLabel;\n  for (let labelName of labelNames) {\n    if (labelName in labels) {\n      levelLabel = labelName;\n      break;\n    }\n  }\n  return levelLabel ? getLogLevelFromKey(labels[levelLabel]) : LogLevel.unknown;\n}\n","import { isNaN } from 'lodash';\nimport React, { useState } from 'react';\n\nimport { isValidGoDuration, SelectableValue, toOption } from '@grafana/data';\nimport { Select } from '@grafana/ui';\n\nimport { getOperationParamId } from '../../../prometheus/querybuilder/shared/operationUtils';\nimport { QueryBuilderOperationParamEditorProps } from '../../../prometheus/querybuilder/shared/types';\nimport { LokiDatasource } from '../../datasource';\nimport { isBytesString } from '../../language_utils';\nimport { getLogQueryFromMetricsQuery, isValidQuery } from '../../query_utils';\nimport { lokiQueryModeller } from '../LokiQueryModeller';\nimport { LokiVisualQuery } from '../types';\n\nexport function UnwrapParamEditor({\n  onChange,\n  index,\n  operationIndex,\n  value,\n  query,\n  datasource,\n}: QueryBuilderOperationParamEditorProps) {\n  const [state, setState] = useState<{\n    options?: Array<SelectableValue<string>>;\n    isLoading?: boolean;\n  }>({});\n\n  return (\n    <Select\n      inputId={getOperationParamId(operationIndex, index)}\n      onOpenMenu={async () => {\n        // This check is always true, we do it to make typescript happy\n        if (datasource instanceof LokiDatasource) {\n          setState({ isLoading: true });\n          const options = await loadUnwrapOptions(query, datasource);\n          setState({ options, isLoading: undefined });\n        }\n      }}\n      isLoading={state.isLoading}\n      allowCustomValue\n      noOptionsMessage=\"No labels found\"\n      loadingMessage=\"Loading labels\"\n      options={state.options}\n      value={value ? toOption(value.toString()) : null}\n      onChange={(value) => {\n        if (value.value) {\n          onChange(index, value.value);\n        }\n      }}\n    />\n  );\n}\n\nasync function loadUnwrapOptions(\n  query: LokiVisualQuery,\n  datasource: LokiDatasource\n): Promise<Array<SelectableValue<string>>> {\n  const queryExpr = lokiQueryModeller.renderQuery(query);\n  const logExpr = getLogQueryFromMetricsQuery(queryExpr);\n  if (!isValidQuery(logExpr)) {\n    return [];\n  }\n\n  const samples = await datasource.getDataSamples({ expr: logExpr, refId: 'unwrap_samples' });\n  const labelsArray: Array<{ [key: string]: string }> | undefined =\n    samples[0]?.fields?.find((field) => field.name === 'labels')?.values.toArray() ?? [];\n\n  if (!labelsArray || labelsArray.length === 0) {\n    return [];\n  }\n\n  // We do this only for first label object, because we want to consider only labels that are present in all log lines\n  // possibleUnwrapLabels are labels with 1. number value OR 2. value that is valid go duration OR 3. bytes string value\n  const possibleUnwrapLabels = Object.keys(labelsArray[0]).filter((key) => {\n    const value = labelsArray[0][key];\n    if (!value) {\n      return false;\n    }\n    return !isNaN(Number(value)) || isValidGoDuration(value) || isBytesString(value);\n  });\n\n  const unwrapLabels: string[] = [];\n  for (const label of possibleUnwrapLabels) {\n    // Add only labels that are present in every line to unwrapLabels\n    if (labelsArray.every((obj) => obj[label])) {\n      unwrapLabels.push(label);\n    }\n  }\n\n  const labelOptions = unwrapLabels.map((label) => ({\n    label,\n    value: label,\n  }));\n\n  return labelOptions;\n}\n","import {\n  createAggregationOperation,\n  createAggregationOperationWithParam,\n  getPromAndLokiOperationDisplayName,\n} from '../../prometheus/querybuilder/shared/operationUtils';\nimport {\n  QueryBuilderOperation,\n  QueryBuilderOperationDef,\n  QueryBuilderOperationParamDef,\n  VisualQueryModeller,\n} from '../../prometheus/querybuilder/shared/types';\nimport { FUNCTIONS } from '../syntax';\n\nimport { binaryScalarOperations } from './binaryScalarOperations';\nimport { UnwrapParamEditor } from './components/UnwrapParamEditor';\nimport { LokiOperationId, LokiOperationOrder, LokiVisualQuery, LokiVisualQueryOperationCategory } from './types';\n\nexport function getOperationDefinitions(): QueryBuilderOperationDef[] {\n  const aggregations = [\n    LokiOperationId.Sum,\n    LokiOperationId.Min,\n    LokiOperationId.Max,\n    LokiOperationId.Avg,\n    LokiOperationId.Stddev,\n    LokiOperationId.Stdvar,\n    LokiOperationId.Count,\n  ].flatMap((opId) =>\n    createAggregationOperation(opId, {\n      addOperationHandler: addLokiOperation,\n      orderRank: LokiOperationOrder.Last,\n    })\n  );\n\n  const aggregationsWithParam = [LokiOperationId.TopK, LokiOperationId.BottomK].flatMap((opId) => {\n    return createAggregationOperationWithParam(\n      opId,\n      {\n        params: [{ name: 'K-value', type: 'number' }],\n        defaultParams: [5],\n      },\n      {\n        addOperationHandler: addLokiOperation,\n        orderRank: LokiOperationOrder.Last,\n      }\n    );\n  });\n\n  const list: QueryBuilderOperationDef[] = [\n    createRangeOperation(LokiOperationId.Rate),\n    createRangeOperation(LokiOperationId.CountOverTime),\n    createRangeOperation(LokiOperationId.SumOverTime),\n    createRangeOperation(LokiOperationId.BytesRate),\n    createRangeOperation(LokiOperationId.BytesOverTime),\n    createRangeOperation(LokiOperationId.AbsentOverTime),\n    createRangeOperation(LokiOperationId.AvgOverTime),\n    createRangeOperation(LokiOperationId.MaxOverTime),\n    createRangeOperation(LokiOperationId.MinOverTime),\n    createRangeOperation(LokiOperationId.FirstOverTime),\n    createRangeOperation(LokiOperationId.LastOverTime),\n    createRangeOperation(LokiOperationId.StdvarOverTime),\n    createRangeOperation(LokiOperationId.StddevOverTime),\n    createRangeOperation(LokiOperationId.QuantileOverTime),\n    ...aggregations,\n    ...aggregationsWithParam,\n    {\n      id: LokiOperationId.Json,\n      name: 'Json',\n      params: [\n        {\n          name: 'Expression',\n          type: 'string',\n          restParam: true,\n          optional: true,\n          minWidth: 18,\n          placeholder: 'server=\"servers[0]\"',\n          description:\n            'Using expressions with your json parser will extract only the specified json fields to labels. You can specify one or more expressions in this way. All expressions must be quoted.',\n        },\n      ],\n      defaultParams: [],\n      alternativesKey: 'format',\n      category: LokiVisualQueryOperationCategory.Formats,\n      orderRank: LokiOperationOrder.LineFormats,\n      renderer: (model, def, innerExpr) => `${innerExpr} | json ${model.params.join(', ')}`.trim(),\n      addOperationHandler: addLokiOperation,\n      explainHandler: () =>\n        `This will extract keys and values from a [json](https://grafana.com/docs/loki/latest/logql/log_queries/#json) formatted log line as labels. The extracted labels can be used in label filter expressions and used as values for a range aggregation via the unwrap operation.`,\n    },\n    {\n      id: LokiOperationId.Logfmt,\n      name: 'Logfmt',\n      params: [],\n      defaultParams: [],\n      alternativesKey: 'format',\n      category: LokiVisualQueryOperationCategory.Formats,\n      orderRank: LokiOperationOrder.LineFormats,\n      renderer: pipelineRenderer,\n      addOperationHandler: addLokiOperation,\n      explainHandler: () =>\n        `This will extract all keys and values from a [logfmt](https://grafana.com/docs/loki/latest/logql/log_queries/#logfmt) formatted log line as labels. The extracted labels can be used in label filter expressions and used as values for a range aggregation via the unwrap operation.`,\n    },\n    {\n      id: LokiOperationId.Regexp,\n      name: 'Regexp',\n      params: [\n        {\n          name: 'String',\n          type: 'string',\n          hideName: true,\n          placeholder: '<re>',\n          description: 'The regexp expression that matches the structure of a log line.',\n          minWidth: 20,\n        },\n      ],\n      defaultParams: [''],\n      alternativesKey: 'format',\n      category: LokiVisualQueryOperationCategory.Formats,\n      orderRank: LokiOperationOrder.LineFormats,\n      renderer: (model, def, innerExpr) => `${innerExpr} | regexp \\`${model.params[0]}\\``,\n      addOperationHandler: addLokiOperation,\n      explainHandler: () =>\n        `The [regexp parser](https://grafana.com/docs/loki/latest/logql/log_queries/#regular-expression) takes a single parameter | regexp \"<re>\" which is the regular expression using the Golang RE2 syntax. The regular expression must contain a least one named sub-match (e.g (?P<name>re)), each sub-match will extract a different label. The expression matches the structure of a log line. The extracted labels can be used in label filter expressions and used as values for a range aggregation via the unwrap operation.`,\n    },\n    {\n      id: LokiOperationId.Pattern,\n      name: 'Pattern',\n      params: [\n        {\n          name: 'String',\n          type: 'string',\n          hideName: true,\n          placeholder: '<pattern-expression>',\n          description: 'The expression that matches the structure of a log line.',\n          minWidth: 20,\n        },\n      ],\n      defaultParams: [''],\n      alternativesKey: 'format',\n      category: LokiVisualQueryOperationCategory.Formats,\n      orderRank: LokiOperationOrder.LineFormats,\n      renderer: (model, def, innerExpr) => `${innerExpr} | pattern \\`${model.params[0]}\\``,\n      addOperationHandler: addLokiOperation,\n      explainHandler: () =>\n        `The [pattern parser](https://grafana.com/docs/loki/latest/logql/log_queries/#pattern) allows the explicit extraction of fields from log lines by defining a pattern expression (| pattern \\`<pattern-expression>\\`). The expression matches the structure of a log line. The extracted labels can be used in label filter expressions and used as values for a range aggregation via the unwrap operation.`,\n    },\n    {\n      id: LokiOperationId.Unpack,\n      name: 'Unpack',\n      params: [],\n      defaultParams: [],\n      alternativesKey: 'format',\n      category: LokiVisualQueryOperationCategory.Formats,\n      orderRank: LokiOperationOrder.LineFormats,\n      renderer: pipelineRenderer,\n      addOperationHandler: addLokiOperation,\n      explainHandler: () =>\n        `This will extract all keys and values from a JSON log line, [unpacking](https://grafana.com/docs/loki/latest/logql/log_queries/#unpack) all embedded labels in the pack stage. The extracted labels can be used in label filter expressions and used as values for a range aggregation via the unwrap operation.`,\n    },\n    {\n      id: LokiOperationId.LineFormat,\n      name: 'Line format',\n      params: [\n        {\n          name: 'String',\n          type: 'string',\n          hideName: true,\n          placeholder: '{{.status_code}}',\n          description: 'A line template that can refer to stream labels and extracted labels.',\n          minWidth: 20,\n        },\n      ],\n      defaultParams: [''],\n      alternativesKey: 'format',\n      category: LokiVisualQueryOperationCategory.Formats,\n      orderRank: LokiOperationOrder.LineFormats,\n      renderer: (model, def, innerExpr) => `${innerExpr} | line_format \\`${model.params[0]}\\``,\n      addOperationHandler: addLokiOperation,\n      explainHandler: () =>\n        `This will replace log line using a specified template. The template can refer to stream labels and extracted labels.\n\n        Example: \\`{{.status_code}} - {{.message}}\\`\n\n        [Read the docs](https://grafana.com/docs/loki/latest/logql/log_queries/#line-format-expression) for more.\n        `,\n    },\n    {\n      id: LokiOperationId.LabelFormat,\n      name: 'Label format',\n      params: [\n        { name: 'Label', type: 'string' },\n        { name: 'Rename to', type: 'string' },\n      ],\n      defaultParams: ['', ''],\n      alternativesKey: 'format',\n      category: LokiVisualQueryOperationCategory.Formats,\n      orderRank: LokiOperationOrder.LineFormats,\n      renderer: (model, def, innerExpr) => `${innerExpr} | label_format ${model.params[1]}=${model.params[0]}`,\n      addOperationHandler: addLokiOperation,\n      explainHandler: () =>\n        `This will change name of label to desired new label. In the example below, label \"error_level\" will be renamed to \"level\".\n\n        Example: error_level=\\`level\\`\n\n        [Read the docs](https://grafana.com/docs/loki/latest/logql/log_queries/#labels-format-expression) for more.\n        `,\n    },\n\n    {\n      id: LokiOperationId.LineContains,\n      name: 'Line contains',\n      params: [\n        {\n          name: 'String',\n          type: 'string',\n          hideName: true,\n          placeholder: 'Text to find',\n          description: 'Find log lines that contains this text',\n          minWidth: 20,\n          runQueryOnEnter: true,\n        },\n      ],\n      defaultParams: [''],\n      alternativesKey: 'line filter',\n      category: LokiVisualQueryOperationCategory.LineFilters,\n      orderRank: LokiOperationOrder.LineFilters,\n      renderer: getLineFilterRenderer('|='),\n      addOperationHandler: addLokiOperation,\n      explainHandler: (op) => `Return log lines that contain string \\`${op.params[0]}\\`.`,\n    },\n    {\n      id: LokiOperationId.LineContainsNot,\n      name: 'Line does not contain',\n      params: [\n        {\n          name: 'String',\n          type: 'string',\n          hideName: true,\n          placeholder: 'Text to exclude',\n          description: 'Find log lines that does not contain this text',\n          minWidth: 26,\n          runQueryOnEnter: true,\n        },\n      ],\n      defaultParams: [''],\n      alternativesKey: 'line filter',\n      category: LokiVisualQueryOperationCategory.LineFilters,\n      orderRank: LokiOperationOrder.LineFilters,\n      renderer: getLineFilterRenderer('!='),\n      addOperationHandler: addLokiOperation,\n      explainHandler: (op) => `Return log lines that does not contain string \\`${op.params[0]}\\`.`,\n    },\n    {\n      id: LokiOperationId.LineMatchesRegex,\n      name: 'Line contains regex match',\n      params: [\n        {\n          name: 'Regex',\n          type: 'string',\n          hideName: true,\n          placeholder: 'Pattern to match',\n          description: 'Find log lines that match this regex pattern',\n          minWidth: 30,\n          runQueryOnEnter: true,\n        },\n      ],\n      defaultParams: [''],\n      alternativesKey: 'line filter',\n      category: LokiVisualQueryOperationCategory.LineFilters,\n      orderRank: LokiOperationOrder.LineFilters,\n      renderer: getLineFilterRenderer('|~'),\n      addOperationHandler: addLokiOperation,\n      explainHandler: (op) => `Return log lines that match regex \\`${op.params[0]}\\`.`,\n    },\n    {\n      id: LokiOperationId.LineMatchesRegexNot,\n      name: 'Line does not match regex',\n      params: [\n        {\n          name: 'Regex',\n          type: 'string',\n          hideName: true,\n          placeholder: 'Pattern to exclude',\n          description: 'Find log lines that does not match this regex pattern',\n          minWidth: 30,\n          runQueryOnEnter: true,\n        },\n      ],\n      defaultParams: [''],\n      alternativesKey: 'line filter',\n      category: LokiVisualQueryOperationCategory.LineFilters,\n      orderRank: LokiOperationOrder.LineFilters,\n      renderer: getLineFilterRenderer('!~'),\n      addOperationHandler: addLokiOperation,\n      explainHandler: (op) => `Return log lines that does not match regex \\`${op.params[0]}\\`.`,\n    },\n    {\n      id: LokiOperationId.LineFilterIpMatches,\n      name: 'IP line filter expression',\n      params: [\n        { name: 'Operator', type: 'string', options: ['|=', '!='] },\n        {\n          name: 'Pattern',\n          type: 'string',\n          placeholder: '<pattern>',\n          minWidth: 16,\n          runQueryOnEnter: true,\n        },\n      ],\n      defaultParams: ['|=', ''],\n      alternativesKey: 'line filter',\n      category: LokiVisualQueryOperationCategory.LineFilters,\n      orderRank: LokiOperationOrder.LineFilters,\n      renderer: (op, def, innerExpr) => `${innerExpr} ${op.params[0]} ip(\\`${op.params[1]}\\`)`,\n      addOperationHandler: addLokiOperation,\n      explainHandler: (op) => `Return log lines using IP matching of \\`${op.params[1]}\\``,\n    },\n    {\n      id: LokiOperationId.LabelFilter,\n      name: 'Label filter expression',\n      params: [\n        { name: 'Label', type: 'string' },\n        { name: 'Operator', type: 'string', options: ['=', '!=', ' =~', '!~', '>', '<', '>=', '<='] },\n        { name: 'Value', type: 'string' },\n      ],\n      defaultParams: ['', '=', ''],\n      alternativesKey: 'label filter',\n      category: LokiVisualQueryOperationCategory.LabelFilters,\n      orderRank: LokiOperationOrder.LabelFilters,\n      renderer: labelFilterRenderer,\n      addOperationHandler: addLokiOperation,\n      explainHandler: () => `Label expression filter allows filtering using original and extracted labels.`,\n    },\n    {\n      id: LokiOperationId.LabelFilterIpMatches,\n      name: 'IP label filter expression',\n      params: [\n        { name: 'Label', type: 'string' },\n        { name: 'Operator', type: 'string', options: ['=', '!='] },\n        { name: 'Value', type: 'string' },\n      ],\n      defaultParams: ['', '=', ''],\n      alternativesKey: 'label filter',\n      category: LokiVisualQueryOperationCategory.LabelFilters,\n      orderRank: LokiOperationOrder.LabelFilters,\n      renderer: (model, def, innerExpr) =>\n        `${innerExpr} | ${model.params[0]} ${model.params[1]} ip(\\`${model.params[2]}\\`)`,\n      addOperationHandler: addLokiOperation,\n      explainHandler: (op) => `Return log lines using IP matching of \\`${op.params[2]}\\` for \\`${op.params[0]}\\` label`,\n    },\n    {\n      id: LokiOperationId.LabelFilterNoErrors,\n      name: 'No pipeline errors',\n      params: [],\n      defaultParams: [],\n      alternativesKey: 'label filter',\n      category: LokiVisualQueryOperationCategory.LabelFilters,\n      orderRank: LokiOperationOrder.NoErrors,\n      renderer: (model, def, innerExpr) => `${innerExpr} | __error__=\\`\\``,\n      addOperationHandler: addLokiOperation,\n      explainHandler: () => `Filter out all formatting and parsing errors.`,\n    },\n    {\n      id: LokiOperationId.Unwrap,\n      name: 'Unwrap',\n      params: [\n        {\n          name: 'Identifier',\n          type: 'string',\n          hideName: true,\n          minWidth: 16,\n          placeholder: 'Label key',\n          editor: UnwrapParamEditor,\n        },\n        {\n          name: 'Conversion function',\n          hideName: true,\n          type: 'string',\n          options: ['duration', 'duration_seconds', 'bytes'],\n          optional: true,\n        },\n      ],\n      defaultParams: ['', ''],\n      alternativesKey: 'format',\n      category: LokiVisualQueryOperationCategory.Formats,\n      orderRank: LokiOperationOrder.Unwrap,\n      renderer: (op, def, innerExpr) =>\n        `${innerExpr} | unwrap ${op.params[1] ? `${op.params[1]}(${op.params[0]})` : op.params[0]}`,\n      addOperationHandler: addLokiOperation,\n      explainHandler: (op) => {\n        let label = String(op.params[0]).length > 0 ? op.params[0] : '<label>';\n        return `Use the extracted label \\`${label}\\` as sample values instead of log lines for the subsequent range aggregation.${\n          op.params[1]\n            ? ` Conversion function \\`${op.params[1]}\\` wrapping \\`${label}\\` will attempt to convert this label from a specific format (e.g. 3k, 500ms).`\n            : ''\n        }`;\n      },\n    },\n    ...binaryScalarOperations,\n    {\n      id: LokiOperationId.NestedQuery,\n      name: 'Binary operation with query',\n      params: [],\n      defaultParams: [],\n      category: LokiVisualQueryOperationCategory.BinaryOps,\n      renderer: (model, def, innerExpr) => innerExpr,\n      addOperationHandler: addNestedQueryHandler,\n    },\n  ];\n\n  return list;\n}\n\nfunction createRangeOperation(name: string): QueryBuilderOperationDef {\n  const params = [getRangeVectorParamDef()];\n  const defaultParams = ['$__interval'];\n  let renderer = operationWithRangeVectorRenderer;\n\n  if (name === LokiOperationId.QuantileOverTime) {\n    defaultParams.push('0.95');\n    params.push({\n      name: 'Quantile',\n      type: 'number',\n    });\n    renderer = operationWithRangeVectorRendererAndParam;\n  }\n\n  return {\n    id: name,\n    name: getPromAndLokiOperationDisplayName(name),\n    params,\n    defaultParams,\n    alternativesKey: 'range function',\n    category: LokiVisualQueryOperationCategory.RangeFunctions,\n    orderRank: LokiOperationOrder.RangeVectorFunction,\n    renderer,\n    addOperationHandler: addLokiOperation,\n    explainHandler: (op, def) => {\n      let opDocs = FUNCTIONS.find((x) => x.insertText === op.id)?.documentation ?? '';\n\n      if (op.params[0] === '$__interval') {\n        return `${opDocs} \\`$__interval\\` is variable that will be replaced with a calculated interval based on **Max data points**,  **Min interval** and query time range. You find these options you find under **Query options** at the right of the data source select dropdown.`;\n      } else {\n        return `${opDocs} The [range vector](https://grafana.com/docs/loki/latest/logql/metric_queries/#range-vector-aggregation) is set to \\`${op.params[0]}\\`.`;\n      }\n    },\n  };\n}\n\nfunction getRangeVectorParamDef(): QueryBuilderOperationParamDef {\n  return {\n    name: 'Range',\n    type: 'string',\n    options: ['$__interval', '$__range', '1m', '5m', '10m', '1h', '24h'],\n  };\n}\n\nfunction operationWithRangeVectorRenderer(\n  model: QueryBuilderOperation,\n  def: QueryBuilderOperationDef,\n  innerExpr: string\n) {\n  let rangeVector = (model.params ?? [])[0] ?? '$__interval';\n  return `${def.id}(${innerExpr} [${rangeVector}])`;\n}\n\nfunction operationWithRangeVectorRendererAndParam(\n  model: QueryBuilderOperation,\n  def: QueryBuilderOperationDef,\n  innerExpr: string\n) {\n  const params = model.params ?? [];\n  const rangeVector = params[0] ?? '$__interval';\n  const param = params[1];\n  return `${def.id}(${param}, ${innerExpr} [${rangeVector}])`;\n}\n\nfunction getLineFilterRenderer(operation: string) {\n  return function lineFilterRenderer(model: QueryBuilderOperation, def: QueryBuilderOperationDef, innerExpr: string) {\n    return `${innerExpr} ${operation} \\`${model.params[0]}\\``;\n  };\n}\n\nfunction labelFilterRenderer(model: QueryBuilderOperation, def: QueryBuilderOperationDef, innerExpr: string) {\n  if (model.params[0] === '') {\n    return innerExpr;\n  }\n\n  if (model.params[1] === '<' || model.params[1] === '>') {\n    return `${innerExpr} | ${model.params[0]} ${model.params[1]} ${model.params[2]}`;\n  }\n\n  return `${innerExpr} | ${model.params[0]} ${model.params[1]} \\`${model.params[2]}\\``;\n}\n\nfunction pipelineRenderer(model: QueryBuilderOperation, def: QueryBuilderOperationDef, innerExpr: string) {\n  return `${innerExpr} | ${model.id}`;\n}\n\nfunction isRangeVectorFunction(def: QueryBuilderOperationDef) {\n  return def.category === LokiVisualQueryOperationCategory.RangeFunctions;\n}\n\nfunction getIndexOfOrLast(\n  operations: QueryBuilderOperation[],\n  queryModeller: VisualQueryModeller,\n  condition: (def: QueryBuilderOperationDef) => boolean\n) {\n  const index = operations.findIndex((x) => {\n    const opDef = queryModeller.getOperationDef(x.id);\n    if (!opDef) {\n      return false;\n    }\n    return condition(opDef);\n  });\n\n  return index === -1 ? operations.length : index;\n}\n\nexport function addLokiOperation(\n  def: QueryBuilderOperationDef,\n  query: LokiVisualQuery,\n  modeller: VisualQueryModeller\n): LokiVisualQuery {\n  const newOperation: QueryBuilderOperation = {\n    id: def.id,\n    params: def.defaultParams,\n  };\n\n  const operations = [...query.operations];\n\n  const existingRangeVectorFunction = operations.find((x) => {\n    const opDef = modeller.getOperationDef(x.id);\n    if (!opDef) {\n      return false;\n    }\n    return isRangeVectorFunction(opDef);\n  });\n\n  switch (def.category) {\n    case LokiVisualQueryOperationCategory.Aggregations:\n    case LokiVisualQueryOperationCategory.Functions:\n      // If we are adding a function but we have not range vector function yet add one\n      if (!existingRangeVectorFunction) {\n        const placeToInsert = getIndexOfOrLast(\n          operations,\n          modeller,\n          (def) => def.category === LokiVisualQueryOperationCategory.Functions\n        );\n        operations.splice(placeToInsert, 0, { id: LokiOperationId.Rate, params: ['$__interval'] });\n      }\n      operations.push(newOperation);\n      break;\n    case LokiVisualQueryOperationCategory.RangeFunctions:\n      // If adding a range function and range function is already added replace it\n      if (existingRangeVectorFunction) {\n        const index = operations.indexOf(existingRangeVectorFunction);\n        operations[index] = newOperation;\n        break;\n      }\n\n    // Add range functions after any formats, line filters and label filters\n    default:\n      const placeToInsert = getIndexOfOrLast(\n        operations,\n        modeller,\n        (x) => (def.orderRank ?? 100) < (x.orderRank ?? 100)\n      );\n      operations.splice(placeToInsert, 0, newOperation);\n      break;\n  }\n\n  return {\n    ...query,\n    operations,\n  };\n}\n\nfunction addNestedQueryHandler(def: QueryBuilderOperationDef, query: LokiVisualQuery): LokiVisualQuery {\n  return {\n    ...query,\n    binaryQueries: [\n      ...(query.binaryQueries ?? []),\n      {\n        operator: '/',\n        query,\n      },\n    ],\n  };\n}\n","import { LokiAndPromQueryModellerBase } from '../../prometheus/querybuilder/shared/LokiAndPromQueryModellerBase';\nimport { QueryBuilderLabelFilter } from '../../prometheus/querybuilder/shared/types';\n\nimport { getOperationDefinitions } from './operations';\nimport { LokiOperationId, LokiQueryPattern, LokiVisualQueryOperationCategory } from './types';\n\nexport class LokiQueryModeller extends LokiAndPromQueryModellerBase {\n  constructor() {\n    super(getOperationDefinitions);\n\n    this.setOperationCategories([\n      LokiVisualQueryOperationCategory.Aggregations,\n      LokiVisualQueryOperationCategory.RangeFunctions,\n      LokiVisualQueryOperationCategory.Formats,\n      LokiVisualQueryOperationCategory.BinaryOps,\n      LokiVisualQueryOperationCategory.LabelFilters,\n      LokiVisualQueryOperationCategory.LineFilters,\n    ]);\n  }\n\n  renderLabels(labels: QueryBuilderLabelFilter[]) {\n    if (labels.length === 0) {\n      return '{}';\n    }\n\n    return super.renderLabels(labels);\n  }\n\n  getQueryPatterns(): LokiQueryPattern[] {\n    return [\n      {\n        name: 'Log query with parsing',\n        // {} | logfmt | __error__=``\n        operations: [\n          { id: LokiOperationId.Logfmt, params: [] },\n          { id: LokiOperationId.LabelFilterNoErrors, params: [] },\n        ],\n      },\n      {\n        name: 'Log query with filtering and parsing',\n        // {} |= `` | logfmt | __error__=``\n        operations: [\n          { id: LokiOperationId.LineContains, params: [''] },\n          { id: LokiOperationId.Logfmt, params: [] },\n          { id: LokiOperationId.LabelFilterNoErrors, params: [] },\n        ],\n      },\n      {\n        name: 'Log query with parsing and label filter',\n        // {} |= `` | logfmt | __error__=`` | label=`value`\n        operations: [\n          { id: LokiOperationId.LineContains, params: [''] },\n          { id: LokiOperationId.Logfmt, params: [] },\n          { id: LokiOperationId.LabelFilterNoErrors, params: [] },\n          { id: LokiOperationId.LabelFilter, params: ['label', '=', 'value'] },\n        ],\n      },\n      {\n        name: 'Log query with parsing of nested json',\n        // {} |= `` | json | line_format `{{ .message}}` | json\n        operations: [\n          { id: LokiOperationId.LineContains, params: [''] },\n          { id: LokiOperationId.Json, params: [] },\n          { id: LokiOperationId.LabelFilterNoErrors, params: [] },\n          { id: LokiOperationId.LineFormat, params: ['{{.message}}'] },\n          { id: LokiOperationId.Json, params: [] },\n          { id: LokiOperationId.LabelFilterNoErrors, params: [] },\n        ],\n      },\n      {\n        name: 'Log query with reformatted log line',\n        // {} |= `` | logfmt | line_format `{{.message}}`\n        operations: [\n          { id: LokiOperationId.LineContains, params: [''] },\n          { id: LokiOperationId.Logfmt, params: [] },\n          { id: LokiOperationId.LabelFilterNoErrors, params: [] },\n          { id: LokiOperationId.LineFormat, params: ['{{.message}}'] },\n        ],\n      },\n      {\n        name: 'Log query with mapped log level',\n        // {} |= `` | logfmt | label_format level=lvl\n        operations: [\n          { id: LokiOperationId.LineContains, params: [''] },\n          { id: LokiOperationId.Logfmt, params: [] },\n          { id: LokiOperationId.LabelFilterNoErrors, params: [] },\n          { id: LokiOperationId.LabelFormat, params: ['lvl', 'level'] },\n        ],\n      },\n      {\n        name: 'Metrics query on value inside log line',\n        // sum(sum_over_time({ | logfmt | __error__=`` | unwrap | __error__=`` [$__interval]))\n        operations: [\n          { id: LokiOperationId.LineContains, params: [''] },\n          { id: LokiOperationId.Logfmt, params: [] },\n          { id: LokiOperationId.LabelFilterNoErrors, params: [] },\n          { id: LokiOperationId.Unwrap, params: [''] },\n          { id: LokiOperationId.LabelFilterNoErrors, params: [] },\n          { id: LokiOperationId.SumOverTime, params: ['$__interval'] },\n          { id: LokiOperationId.Sum, params: [] },\n        ],\n      },\n      {\n        name: 'Metrics query for total requests per label of streams',\n        // sum by() (count_over_time({}[$__interval)\n        operations: [\n          { id: LokiOperationId.LineContains, params: [''] },\n          { id: LokiOperationId.CountOverTime, params: ['$__interval'] },\n          { id: LokiOperationId.Sum, params: [] },\n        ],\n      },\n      {\n        name: 'Metrics query for total requests per parsed label or label of streams',\n        // sum by() (count_over_time({}| logfmt | __error__=`` [$__interval))\n        operations: [\n          { id: LokiOperationId.LineContains, params: [''] },\n          { id: LokiOperationId.Logfmt, params: [] },\n          { id: LokiOperationId.LabelFilterNoErrors, params: [] },\n          { id: LokiOperationId.CountOverTime, params: ['$__interval'] },\n          { id: LokiOperationId.Sum, params: [] },\n        ],\n      },\n      {\n        name: 'Metrics query for bytes used by log stream',\n        // bytes_over_time({}[$__interval])\n        operations: [\n          { id: LokiOperationId.LineContains, params: [''] },\n          { id: LokiOperationId.BytesOverTime, params: ['$__interval'] },\n        ],\n      },\n      {\n        name: 'Metrics query for count of log lines per stream',\n        // count_over_time({}[$__interval])\n        operations: [\n          { id: LokiOperationId.LineContains, params: [''] },\n          { id: LokiOperationId.CountOverTime, params: ['$__interval'] },\n        ],\n      },\n      {\n        name: 'Metrics query for top n results by label or parsed label',\n        // topk(10, sum by () (count_over_time({} | logfmt | __error__=`` [$__interval])))\n        operations: [\n          { id: LokiOperationId.Logfmt, params: [] },\n          { id: LokiOperationId.LabelFilterNoErrors, params: [] },\n          { id: LokiOperationId.CountOverTime, params: ['$__interval'] },\n          { id: LokiOperationId.Sum, params: [] },\n          { id: LokiOperationId.TopK, params: [10] },\n        ],\n      },\n      {\n        name: 'Metrics query for extracted quantile',\n        // quantile_over_time(0.5,{} | logfmt | unwrap latency[$__interval]) by ()\n        operations: [\n          { id: LokiOperationId.Logfmt, params: [] },\n          { id: LokiOperationId.LabelFilterNoErrors, params: [] },\n          { id: LokiOperationId.Unwrap, params: ['latency'] },\n          { id: LokiOperationId.LabelFilterNoErrors, params: [] },\n          { id: LokiOperationId.QuantileOverTime, params: [0.5, '$__interval'] },\n          { id: LokiOperationId.Sum, params: [] },\n        ],\n      },\n    ];\n  }\n}\n\nexport const lokiQueryModeller = new LokiQueryModeller();\n","import store from 'app/core/store';\n\nimport { QueryEditorMode } from '../../prometheus/querybuilder/shared/types';\nimport { LokiQuery, LokiQueryType } from '../types';\n\nconst queryEditorModeDefaultLocalStorageKey = 'LokiQueryEditorModeDefault';\n\nexport function changeEditorMode(query: LokiQuery, editorMode: QueryEditorMode, onChange: (query: LokiQuery) => void) {\n  // If empty query store new mode as default\n  if (query.expr === '') {\n    store.set(queryEditorModeDefaultLocalStorageKey, editorMode);\n  }\n\n  onChange({ ...query, editorMode });\n}\n\nexport function getDefaultEditorMode(expr: string) {\n  // If we already have an expression default to code view\n  if (expr != null && expr !== '') {\n    return QueryEditorMode.Code;\n  }\n\n  const value = store.get(queryEditorModeDefaultLocalStorageKey) as QueryEditorMode;\n  switch (value) {\n    case QueryEditorMode.Builder:\n    case QueryEditorMode.Code:\n      return value;\n    default:\n      return QueryEditorMode.Builder;\n  }\n}\n\n/**\n * Returns query with defaults, and boolean true/false depending on change was required\n */\nexport function getQueryWithDefaults(query: LokiQuery): LokiQuery {\n  // If no expr (ie new query) then default to builder\n  let result = query;\n\n  if (!query.editorMode) {\n    result = { ...query, editorMode: getDefaultEditorMode(query.expr) };\n  }\n\n  if (query.expr == null) {\n    result = { ...result, expr: '' };\n  }\n\n  if (query.queryType == null) {\n    // Default to range query\n    result = { ...result, queryType: LokiQueryType.Range };\n  }\n\n  return result;\n}\n","import { css } from '@emotion/css';\nimport React from 'react';\n\nimport { GrafanaTheme2, toOption } from '@grafana/data';\nimport { EditorRows, FlexItem } from '@grafana/experimental';\nimport { AutoSizeInput, IconButton, Select, useStyles2 } from '@grafana/ui';\n\nimport { LokiDatasource } from '../../datasource';\nimport { binaryScalarDefs } from '../binaryScalarOperations';\nimport { LokiVisualQueryBinary } from '../types';\n\nimport { LokiQueryBuilder } from './LokiQueryBuilder';\n\nexport interface Props {\n  nestedQuery: LokiVisualQueryBinary;\n  datasource: LokiDatasource;\n  index: number;\n  showExplain: boolean;\n  onChange: (index: number, update: LokiVisualQueryBinary) => void;\n  onRemove: (index: number) => void;\n  onRunQuery: () => void;\n}\n\nexport const NestedQuery = React.memo<Props>(\n  ({ nestedQuery, index, datasource, onChange, onRemove, onRunQuery, showExplain }) => {\n    const styles = useStyles2(getStyles);\n\n    return (\n      <div className={styles.card}>\n        <div className={styles.header}>\n          <div className={styles.name}>Operator</div>\n          <Select\n            width=\"auto\"\n            options={operators}\n            value={toOption(nestedQuery.operator)}\n            onChange={(value) => {\n              onChange(index, {\n                ...nestedQuery,\n                operator: value.value!,\n              });\n            }}\n          />\n          <div className={styles.name}>Vector matches</div>\n          <div className={styles.vectorMatchWrapper}>\n            <Select<LokiVisualQueryBinary['vectorMatchesType']>\n              width=\"auto\"\n              value={nestedQuery.vectorMatchesType || 'on'}\n              allowCustomValue\n              options={[\n                { value: 'on', label: 'on' },\n                { value: 'ignoring', label: 'ignoring' },\n              ]}\n              onChange={(val) => {\n                onChange(index, {\n                  ...nestedQuery,\n                  vectorMatchesType: val.value,\n                });\n              }}\n            />\n            <AutoSizeInput\n              className={styles.vectorMatchInput}\n              minWidth={20}\n              defaultValue={nestedQuery.vectorMatches}\n              onCommitChange={(evt) => {\n                onChange(index, {\n                  ...nestedQuery,\n                  vectorMatches: evt.currentTarget.value,\n                  vectorMatchesType: nestedQuery.vectorMatchesType || 'on',\n                });\n              }}\n            />\n          </div>\n          <FlexItem grow={1} />\n          <IconButton name=\"times\" size=\"sm\" onClick={() => onRemove(index)} />\n        </div>\n        <div className={styles.body}>\n          <EditorRows>\n            <LokiQueryBuilder\n              showExplain={showExplain}\n              query={nestedQuery.query}\n              datasource={datasource}\n              onRunQuery={onRunQuery}\n              onChange={(update) => {\n                onChange(index, { ...nestedQuery, query: update });\n              }}\n            />\n          </EditorRows>\n        </div>\n      </div>\n    );\n  }\n);\n\nconst operators = binaryScalarDefs.map((def) => ({ label: def.sign, value: def.sign }));\n\nNestedQuery.displayName = 'NestedQuery';\n\nconst getStyles = (theme: GrafanaTheme2) => {\n  return {\n    card: css({\n      label: 'card',\n      display: 'flex',\n      flexDirection: 'column',\n      gap: theme.spacing(0.5),\n    }),\n    header: css({\n      label: 'header',\n      padding: theme.spacing(0.5, 0.5, 0.5, 1),\n      gap: theme.spacing(1),\n      display: 'flex',\n      alignItems: 'center',\n    }),\n    name: css({\n      label: 'name',\n      whiteSpace: 'nowrap',\n    }),\n    body: css({\n      label: 'body',\n      paddingLeft: theme.spacing(2),\n    }),\n    vectorMatchInput: css({\n      label: 'vectorMatchInput',\n      marginLeft: -1,\n    }),\n    vectorMatchWrapper: css({\n      label: 'vectorMatchWrapper',\n      display: 'flex',\n    }),\n  };\n};\n","import React from 'react';\n\nimport { Stack } from '@grafana/experimental';\n\nimport { LokiDatasource } from '../../datasource';\nimport { LokiVisualQuery, LokiVisualQueryBinary } from '../types';\n\nimport { NestedQuery } from './NestedQuery';\n\nexport interface Props {\n  query: LokiVisualQuery;\n  datasource: LokiDatasource;\n  showExplain: boolean;\n  onChange: (query: LokiVisualQuery) => void;\n  onRunQuery: () => void;\n}\n\nexport function NestedQueryList({ query, datasource, onChange, onRunQuery, showExplain }: Props) {\n  const nestedQueries = query.binaryQueries ?? [];\n\n  const onNestedQueryUpdate = (index: number, update: LokiVisualQueryBinary) => {\n    const updatedList = [...nestedQueries];\n    updatedList.splice(index, 1, update);\n    onChange({ ...query, binaryQueries: updatedList });\n  };\n\n  const onRemove = (index: number) => {\n    const updatedList = [...nestedQueries.slice(0, index), ...nestedQueries.slice(index + 1)];\n    onChange({ ...query, binaryQueries: updatedList });\n  };\n\n  return (\n    <Stack direction=\"column\" gap={1}>\n      {nestedQueries.map((nestedQuery, index) => (\n        <NestedQuery\n          key={index.toString()}\n          nestedQuery={nestedQuery}\n          index={index}\n          onChange={onNestedQueryUpdate}\n          datasource={datasource}\n          onRemove={onRemove}\n          onRunQuery={onRunQuery}\n          showExplain={showExplain}\n        />\n      ))}\n    </Stack>\n  );\n}\n","import React, { useEffect, useMemo, useState } from 'react';\n\nimport { DataSourceApi, getDefaultTimeRange, LoadingState, PanelData, SelectableValue } from '@grafana/data';\nimport { EditorRow } from '@grafana/experimental';\nimport { LabelFilters } from 'app/plugins/datasource/prometheus/querybuilder/shared/LabelFilters';\nimport { OperationExplainedBox } from 'app/plugins/datasource/prometheus/querybuilder/shared/OperationExplainedBox';\nimport { OperationList } from 'app/plugins/datasource/prometheus/querybuilder/shared/OperationList';\nimport { OperationListExplained } from 'app/plugins/datasource/prometheus/querybuilder/shared/OperationListExplained';\nimport { OperationsEditorRow } from 'app/plugins/datasource/prometheus/querybuilder/shared/OperationsEditorRow';\nimport { QueryBuilderHints } from 'app/plugins/datasource/prometheus/querybuilder/shared/QueryBuilderHints';\nimport { RawQuery } from 'app/plugins/datasource/prometheus/querybuilder/shared/RawQuery';\nimport {\n  QueryBuilderLabelFilter,\n  QueryBuilderOperation,\n} from 'app/plugins/datasource/prometheus/querybuilder/shared/types';\n\nimport { LokiDatasource } from '../../datasource';\nimport { escapeLabelValueInSelector } from '../../language_utils';\nimport logqlGrammar from '../../syntax';\nimport { lokiQueryModeller } from '../LokiQueryModeller';\nimport { buildVisualQueryFromString } from '../parsing';\nimport { LokiOperationId, LokiVisualQuery } from '../types';\n\nimport { NestedQueryList } from './NestedQueryList';\n\nexport interface Props {\n  query: LokiVisualQuery;\n  datasource: LokiDatasource;\n  showExplain: boolean;\n  onChange: (update: LokiVisualQuery) => void;\n  onRunQuery: () => void;\n}\n\nexport const LokiQueryBuilder = React.memo<Props>(({ datasource, query, onChange, onRunQuery, showExplain }) => {\n  const [sampleData, setSampleData] = useState<PanelData>();\n  const [highlightedOp, setHighlightedOp] = useState<QueryBuilderOperation | undefined>(undefined);\n\n  const onChangeLabels = (labels: QueryBuilderLabelFilter[]) => {\n    onChange({ ...query, labels });\n  };\n\n  const withTemplateVariableOptions = async (optionsPromise: Promise<string[]>): Promise<SelectableValue[]> => {\n    const options = await optionsPromise;\n    return [...datasource.getVariables(), ...options].map((value) => ({ label: value, value }));\n  };\n\n  const onGetLabelNames = async (forLabel: Partial<QueryBuilderLabelFilter>): Promise<any> => {\n    const labelsToConsider = query.labels.filter((x) => x !== forLabel);\n\n    if (labelsToConsider.length === 0) {\n      await datasource.languageProvider.refreshLogLabels();\n      return datasource.languageProvider.getLabelKeys();\n    }\n\n    const expr = lokiQueryModeller.renderLabels(labelsToConsider);\n    const series = await datasource.languageProvider.fetchSeriesLabels(expr);\n    return Object.keys(series).sort();\n  };\n\n  const onGetLabelValues = async (forLabel: Partial<QueryBuilderLabelFilter>) => {\n    if (!forLabel.label) {\n      return [];\n    }\n\n    let values;\n    const labelsToConsider = query.labels.filter((x) => x !== forLabel);\n    if (labelsToConsider.length === 0) {\n      values = await datasource.languageProvider.fetchLabelValues(forLabel.label);\n    } else {\n      const expr = lokiQueryModeller.renderLabels(labelsToConsider);\n      const result = await datasource.languageProvider.fetchSeriesLabels(expr);\n      values = result[datasource.interpolateString(forLabel.label)];\n    }\n\n    return values ? values.map((v) => escapeLabelValueInSelector(v, forLabel.op)) : []; // Escape values in return\n  };\n\n  const labelFilterError: string | undefined = useMemo(() => {\n    const { labels, operations: op } = query;\n    if (!labels.length && op.length) {\n      // We don't want to show error for initial state with empty line contains operation\n      if (op.length === 1 && op[0].id === LokiOperationId.LineContains && op[0].params[0] === '') {\n        return undefined;\n      }\n      return 'You need to specify at least 1 label filter (stream selector)';\n    }\n    return undefined;\n  }, [query]);\n\n  useEffect(() => {\n    const onGetSampleData = async () => {\n      const lokiQuery = { expr: lokiQueryModeller.renderQuery(query), refId: 'data-samples' };\n      const series = await datasource.getDataSamples(lokiQuery);\n      const sampleData = { series, state: LoadingState.Done, timeRange: getDefaultTimeRange() };\n      setSampleData(sampleData);\n    };\n\n    onGetSampleData().catch(console.error);\n  }, [datasource, query]);\n\n  const lang = { grammar: logqlGrammar, name: 'logql' };\n  return (\n    <>\n      <EditorRow>\n        <LabelFilters\n          onGetLabelNames={(forLabel: Partial<QueryBuilderLabelFilter>) =>\n            withTemplateVariableOptions(onGetLabelNames(forLabel))\n          }\n          onGetLabelValues={(forLabel: Partial<QueryBuilderLabelFilter>) =>\n            withTemplateVariableOptions(onGetLabelValues(forLabel))\n          }\n          labelsFilters={query.labels}\n          onChange={onChangeLabels}\n          error={labelFilterError}\n        />\n      </EditorRow>\n      {showExplain && (\n        <OperationExplainedBox\n          stepNumber={1}\n          title={<RawQuery query={`${lokiQueryModeller.renderLabels(query.labels)}`} lang={lang} />}\n        >\n          Fetch all log lines matching label filters.\n        </OperationExplainedBox>\n      )}\n      <OperationsEditorRow>\n        <OperationList\n          queryModeller={lokiQueryModeller}\n          query={query}\n          onChange={onChange}\n          onRunQuery={onRunQuery}\n          datasource={datasource as DataSourceApi}\n          highlightedOp={highlightedOp}\n        />\n        <QueryBuilderHints<LokiVisualQuery>\n          datasource={datasource}\n          query={query}\n          onChange={onChange}\n          data={sampleData}\n          queryModeller={lokiQueryModeller}\n          buildVisualQueryFromString={buildVisualQueryFromString}\n        />\n      </OperationsEditorRow>\n      {showExplain && (\n        <OperationListExplained<LokiVisualQuery>\n          stepNumber={2}\n          queryModeller={lokiQueryModeller}\n          query={query}\n          lang={lang}\n          onMouseEnter={(op) => {\n            setHighlightedOp(op);\n          }}\n          onMouseLeave={() => {\n            setHighlightedOp(undefined);\n          }}\n        />\n      )}\n      {query.binaryQueries && query.binaryQueries.length > 0 && (\n        <NestedQueryList\n          query={query}\n          datasource={datasource}\n          onChange={onChange}\n          onRunQuery={onRunQuery}\n          showExplain={showExplain}\n        />\n      )}\n    </>\n  );\n});\n\nLokiQueryBuilder.displayName = 'LokiQueryBuilder';\n","import React from 'react';\n\nimport { EditorField, EditorFieldGroup, EditorRow } from '@grafana/experimental';\n\nimport { RawQuery } from '../../../prometheus/querybuilder/shared/RawQuery';\nimport { lokiGrammar } from '../../syntax';\n\nexport interface Props {\n  query: string;\n}\n\nexport function QueryPreview({ query }: Props) {\n  return (\n    <EditorRow>\n      <EditorFieldGroup>\n        <EditorField label=\"Raw query\">\n          <RawQuery query={query} lang={{ grammar: lokiGrammar, name: 'lokiql' }} />\n        </EditorField>\n      </EditorFieldGroup>\n    </EditorRow>\n  );\n}\n","import { createSlice, PayloadAction } from '@reduxjs/toolkit';\nimport React, { useEffect, useReducer } from 'react';\n\nimport { LokiDatasource } from '../../datasource';\nimport { LokiQuery } from '../../types';\nimport { lokiQueryModeller } from '../LokiQueryModeller';\nimport { buildVisualQueryFromString } from '../parsing';\nimport { LokiVisualQuery } from '../types';\n\nimport { LokiQueryBuilder } from './LokiQueryBuilder';\nimport { QueryPreview } from './QueryPreview';\n\nexport interface Props {\n  query: LokiQuery;\n  datasource: LokiDatasource;\n  onChange: (update: LokiQuery) => void;\n  onRunQuery: () => void;\n  showRawQuery: boolean;\n  showExplain: boolean;\n}\n\nexport interface State {\n  visQuery?: LokiVisualQuery;\n  expr: string;\n}\n\n/**\n * This component is here just to contain the translation logic between string query and the visual query builder model.\n */\nexport function LokiQueryBuilderContainer(props: Props) {\n  const { query, onChange, onRunQuery, datasource, showRawQuery, showExplain } = props;\n  const [state, dispatch] = useReducer(stateSlice.reducer, {\n    expr: query.expr,\n    // Use initial visual query only if query.expr is empty string\n    visQuery:\n      query.expr === ''\n        ? {\n            labels: [],\n            operations: [{ id: '__line_contains', params: [''] }],\n          }\n        : undefined,\n  });\n\n  // Only rebuild visual query if expr changes from outside\n  useEffect(() => {\n    dispatch(exprChanged(query.expr));\n  }, [query.expr]);\n\n  const onVisQueryChange = (visQuery: LokiVisualQuery) => {\n    const expr = lokiQueryModeller.renderQuery(visQuery);\n    dispatch(visualQueryChange({ visQuery, expr }));\n    onChange({ ...props.query, expr: expr });\n  };\n\n  if (!state.visQuery) {\n    return null;\n  }\n\n  return (\n    <>\n      <LokiQueryBuilder\n        query={state.visQuery}\n        datasource={datasource}\n        onChange={onVisQueryChange}\n        onRunQuery={onRunQuery}\n        showExplain={showExplain}\n      />\n      {showRawQuery && <QueryPreview query={query.expr} />}\n    </>\n  );\n}\n\nconst stateSlice = createSlice({\n  name: 'loki-builder-container',\n  initialState: { expr: '' } as State,\n  reducers: {\n    visualQueryChange: (state, action: PayloadAction<{ visQuery: LokiVisualQuery; expr: string }>) => {\n      state.expr = action.payload.expr;\n      state.visQuery = action.payload.visQuery;\n    },\n    exprChanged: (state, action: PayloadAction<string>) => {\n      if (!state.visQuery || state.expr !== action.payload) {\n        state.expr = action.payload;\n        const parseResult = buildVisualQueryFromString(action.payload);\n        state.visQuery = parseResult.query;\n      }\n    },\n  },\n});\n\nconst { visualQueryChange, exprChanged } = stateSlice.actions;\n","import React from 'react';\n\nimport { CoreApp, SelectableValue } from '@grafana/data';\nimport { EditorRow, EditorField } from '@grafana/experimental';\nimport { reportInteraction } from '@grafana/runtime';\nimport { RadioButtonGroup, Select, AutoSizeInput } from '@grafana/ui';\nimport { QueryOptionGroup } from 'app/plugins/datasource/prometheus/querybuilder/shared/QueryOptionGroup';\n\nimport { preprocessMaxLines, queryTypeOptions, RESOLUTION_OPTIONS } from '../../components/LokiOptionFields';\nimport { isLogsQuery } from '../../query_utils';\nimport { LokiQuery, LokiQueryType } from '../../types';\n\nexport interface Props {\n  query: LokiQuery;\n  onChange: (update: LokiQuery) => void;\n  onRunQuery: () => void;\n  app?: CoreApp;\n}\n\nexport const LokiQueryBuilderOptions = React.memo<Props>(({ app, query, onChange, onRunQuery }) => {\n  const onQueryTypeChange = (value: LokiQueryType) => {\n    onChange({ ...query, queryType: value });\n    onRunQuery();\n  };\n\n  const onResolutionChange = (option: SelectableValue<number>) => {\n    reportInteraction('grafana_loki_resolution_clicked', {\n      app,\n      resolution: option.value,\n    });\n    onChange({ ...query, resolution: option.value });\n    onRunQuery();\n  };\n\n  const onLegendFormatChanged = (evt: React.FormEvent<HTMLInputElement>) => {\n    onChange({ ...query, legendFormat: evt.currentTarget.value });\n    onRunQuery();\n  };\n\n  function onMaxLinesChange(e: React.SyntheticEvent<HTMLInputElement>) {\n    const newMaxLines = preprocessMaxLines(e.currentTarget.value);\n    if (query.maxLines !== newMaxLines) {\n      onChange({ ...query, maxLines: newMaxLines });\n      onRunQuery();\n    }\n  }\n\n  let queryType = query.queryType ?? (query.instant ? LokiQueryType.Instant : LokiQueryType.Range);\n  let showMaxLines = isLogsQuery(query.expr);\n\n  return (\n    <EditorRow>\n      <QueryOptionGroup title=\"Options\" collapsedInfo={getCollapsedInfo(query, queryType, showMaxLines)}>\n        <EditorField\n          label=\"Legend\"\n          tooltip=\"Series name override or template. Ex. {{hostname}} will be replaced with label value for hostname.\"\n        >\n          <AutoSizeInput\n            placeholder=\"{{label}}\"\n            id=\"loki-query-editor-legend-format\"\n            type=\"string\"\n            minWidth={14}\n            defaultValue={query.legendFormat}\n            onCommitChange={onLegendFormatChanged}\n          />\n        </EditorField>\n        <EditorField label=\"Type\">\n          <RadioButtonGroup options={queryTypeOptions} value={queryType} onChange={onQueryTypeChange} />\n        </EditorField>\n        {showMaxLines && (\n          <EditorField label=\"Line limit\" tooltip=\"Upper limit for number of log lines returned by query.\">\n            <AutoSizeInput\n              className=\"width-4\"\n              placeholder=\"auto\"\n              type=\"number\"\n              min={0}\n              defaultValue={query.maxLines?.toString() ?? ''}\n              onCommitChange={onMaxLinesChange}\n            />\n          </EditorField>\n        )}\n        <EditorField label=\"Resolution\">\n          <Select\n            isSearchable={false}\n            onChange={onResolutionChange}\n            options={RESOLUTION_OPTIONS}\n            value={query.resolution || 1}\n            aria-label=\"Select resolution\"\n          />\n        </EditorField>\n      </QueryOptionGroup>\n    </EditorRow>\n  );\n});\n\nfunction getCollapsedInfo(query: LokiQuery, queryType: LokiQueryType, showMaxLines: boolean): string[] {\n  const queryTypeLabel = queryTypeOptions.find((x) => x.value === queryType);\n  const resolutionLabel = RESOLUTION_OPTIONS.find((x) => x.value === (query.resolution ?? 1));\n\n  const items: string[] = [];\n\n  if (query.legendFormat) {\n    items.push(`Legend: ${query.legendFormat}`);\n  }\n\n  if (query.resolution) {\n    items.push(`Resolution: ${resolutionLabel?.label}`);\n  }\n\n  items.push(`Type: ${queryTypeLabel?.label}`);\n\n  if (showMaxLines && query.maxLines) {\n    items.push(`Line limit: ${query.maxLines}`);\n  }\n\n  return items;\n}\n\nLokiQueryBuilderOptions.displayName = 'LokiQueryBuilderOptions';\n","// Libraries\nimport React from 'react';\n\n// Types\nimport { InlineFormLabel } from '@grafana/ui';\n\nimport { LokiOptionFields } from './LokiOptionFields';\nimport { LokiQueryField } from './LokiQueryField';\nimport { LokiQueryEditorProps } from './types';\n\nexport function LokiQueryEditor(props: LokiQueryEditorProps) {\n  const { query, data, datasource, onChange, onRunQuery, range } = props;\n\n  const onLegendChange = (e: React.SyntheticEvent<HTMLInputElement>) => {\n    const nextQuery = { ...query, legendFormat: e.currentTarget.value };\n    onChange(nextQuery);\n  };\n\n  const legendField = (\n    <div className=\"gf-form-inline\">\n      <div className=\"gf-form\">\n        <InlineFormLabel\n          width={6}\n          tooltip=\"Controls the name of the time series, using name or pattern. For example\n        {{hostname}} will be replaced with label value for the label hostname. The legend only applies to metric queries.\"\n        >\n          Legend\n        </InlineFormLabel>\n        <input\n          type=\"text\"\n          className=\"gf-form-input\"\n          placeholder=\"legend format\"\n          value={query.legendFormat || ''}\n          onChange={onLegendChange}\n          onBlur={onRunQuery}\n        />\n      </div>\n    </div>\n  );\n\n  return (\n    <LokiQueryField\n      datasource={datasource}\n      query={query}\n      onChange={onChange}\n      onRunQuery={onRunQuery}\n      onBlur={onRunQuery}\n      history={[]}\n      data={data}\n      data-testid={testIds.editor}\n      range={range}\n      ExtraFieldElement={\n        <>\n          <LokiOptionFields\n            lineLimitValue={query?.maxLines?.toString() || ''}\n            resolution={query?.resolution || 1}\n            query={query}\n            onRunQuery={onRunQuery}\n            onChange={onChange}\n            runOnBlur={true}\n          />\n          {legendField}\n        </>\n      }\n    />\n  );\n}\n\nexport const testIds = {\n  editor: 'loki-editor',\n};\n","import React from 'react';\n\nimport { Stack } from '@grafana/experimental';\nimport { OperationExplainedBox } from 'app/plugins/datasource/prometheus/querybuilder/shared/OperationExplainedBox';\nimport { OperationListExplained } from 'app/plugins/datasource/prometheus/querybuilder/shared/OperationListExplained';\nimport { RawQuery } from 'app/plugins/datasource/prometheus/querybuilder/shared/RawQuery';\n\nimport { lokiGrammar } from '../../syntax';\nimport { lokiQueryModeller } from '../LokiQueryModeller';\nimport { buildVisualQueryFromString } from '../parsing';\nimport { LokiVisualQuery } from '../types';\n\nexport interface Props {\n  query: string;\n}\n\nexport const LokiQueryBuilderExplained = React.memo<Props>(({ query }) => {\n  const visQuery = buildVisualQueryFromString(query || '').query;\n  const lang = { grammar: lokiGrammar, name: 'lokiql' };\n\n  return (\n    <Stack gap={0} direction=\"column\">\n      <OperationExplainedBox\n        stepNumber={1}\n        title={<RawQuery query={`${lokiQueryModeller.renderLabels(visQuery.labels)}`} lang={lang} />}\n      >\n        Fetch all log lines matching label filters.\n      </OperationExplainedBox>\n      <OperationListExplained<LokiVisualQuery>\n        stepNumber={2}\n        queryModeller={lokiQueryModeller}\n        query={visQuery}\n        lang={lang}\n      />\n    </Stack>\n  );\n});\n\nLokiQueryBuilderExplained.displayName = 'LokiQueryBuilderExplained';\n","import { css } from '@emotion/css';\nimport React from 'react';\n\nimport { CoreApp, GrafanaTheme2 } from '@grafana/data';\nimport { useStyles2 } from '@grafana/ui';\n\nimport { testIds } from '../../components/LokiQueryEditor';\nimport { LokiQueryField } from '../../components/LokiQueryField';\nimport { LokiQueryEditorProps } from '../../components/types';\n\nimport { LokiQueryBuilderExplained } from './LokiQueryBuilderExplained';\n\ntype Props = LokiQueryEditorProps & {\n  showExplain: boolean;\n};\n\nexport function LokiQueryCodeEditor({ query, datasource, range, onRunQuery, onChange, data, app, showExplain }: Props) {\n  const styles = useStyles2(getStyles);\n\n  // the inner QueryField works like this when a blur event happens:\n  // - if it has an onBlur prop, it calls it\n  // - else it calls onRunQuery (some extra conditions apply)\n  //\n  // we want it to not do anything when a blur event happens in explore mode,\n  // so we set an empty-function in such case. otherwise we set `undefined`,\n  // which will cause it to run the query when blur happens.\n  const onBlur = app === CoreApp.Explore ? () => undefined : undefined;\n\n  return (\n    <div className={styles.wrapper}>\n      <LokiQueryField\n        datasource={datasource}\n        query={query}\n        range={range}\n        onRunQuery={onRunQuery}\n        onChange={onChange}\n        onBlur={onBlur}\n        history={[]}\n        data={data}\n        data-testid={testIds.editor}\n        app={app}\n      />\n      {showExplain && <LokiQueryBuilderExplained query={query.expr} />}\n    </div>\n  );\n}\n\nconst getStyles = (theme: GrafanaTheme2) => {\n  return {\n    wrapper: css`\n      .gf-form {\n        margin-bottom: 0.5;\n      }\n    `,\n  };\n};\n","import React, { SyntheticEvent, useCallback, useEffect, useState } from 'react';\n\nimport { CoreApp, LoadingState, SelectableValue } from '@grafana/data';\nimport { selectors } from '@grafana/e2e-selectors';\nimport { EditorHeader, EditorRows, FlexItem, InlineSelect, Space } from '@grafana/experimental';\nimport { reportInteraction } from '@grafana/runtime';\nimport { Button, ConfirmModal } from '@grafana/ui';\nimport { FeedbackLink } from 'app/plugins/datasource/prometheus/querybuilder/shared/FeedbackLink';\nimport { QueryEditorModeToggle } from 'app/plugins/datasource/prometheus/querybuilder/shared/QueryEditorModeToggle';\nimport { QueryHeaderSwitch } from 'app/plugins/datasource/prometheus/querybuilder/shared/QueryHeaderSwitch';\nimport { QueryEditorMode } from 'app/plugins/datasource/prometheus/querybuilder/shared/types';\n\nimport {\n  lokiQueryEditorExplainKey,\n  lokiQueryEditorRawQueryKey,\n  useFlag,\n} from '../../../prometheus/querybuilder/shared/hooks/useFlag';\nimport { LokiQueryEditorProps } from '../../components/types';\nimport { LokiQuery } from '../../types';\nimport { lokiQueryModeller } from '../LokiQueryModeller';\nimport { buildVisualQueryFromString } from '../parsing';\nimport { changeEditorMode, getQueryWithDefaults } from '../state';\nimport { LokiQueryPattern } from '../types';\n\nimport { LokiQueryBuilderContainer } from './LokiQueryBuilderContainer';\nimport { LokiQueryBuilderOptions } from './LokiQueryBuilderOptions';\nimport { LokiQueryCodeEditor } from './LokiQueryCodeEditor';\n\nexport const LokiQueryEditorSelector = React.memo<LokiQueryEditorProps>((props) => {\n  const { onChange, onRunQuery, data, app } = props;\n  const [parseModalOpen, setParseModalOpen] = useState(false);\n  const [dataIsStale, setDataIsStale] = useState(false);\n  const { flag: explain, setFlag: setExplain } = useFlag(lokiQueryEditorExplainKey);\n  const { flag: rawQuery, setFlag: setRawQuery } = useFlag(lokiQueryEditorRawQueryKey, true);\n\n  const query = getQueryWithDefaults(props.query);\n  // This should be filled in from the defaults by now.\n  const editorMode = query.editorMode!;\n\n  const onExplainChange = (event: SyntheticEvent<HTMLInputElement>) => {\n    setExplain(event.currentTarget.checked);\n  };\n\n  const onEditorModeChange = useCallback(\n    (newEditorMode: QueryEditorMode) => {\n      reportInteraction('grafana_loki_editor_mode_clicked', {\n        newEditor: newEditorMode,\n        previousEditor: query.editorMode ?? '',\n        newQuery: !query.expr,\n        app: app ?? '',\n      });\n\n      if (newEditorMode === QueryEditorMode.Builder) {\n        const result = buildVisualQueryFromString(query.expr || '');\n        // If there are errors, give user a chance to decide if they want to go to builder as that can loose some data.\n        if (result.errors.length) {\n          setParseModalOpen(true);\n          return;\n        }\n      }\n      changeEditorMode(query, newEditorMode, onChange);\n    },\n    [onChange, query, app]\n  );\n\n  useEffect(() => {\n    setDataIsStale(false);\n  }, [data]);\n\n  const onChangeInternal = (query: LokiQuery) => {\n    setDataIsStale(true);\n    onChange(query);\n  };\n\n  const onQueryPreviewChange = (event: SyntheticEvent<HTMLInputElement>) => {\n    const isEnabled = event.currentTarget.checked;\n    setRawQuery(isEnabled);\n  };\n\n  return (\n    <>\n      <ConfirmModal\n        isOpen={parseModalOpen}\n        title=\"Query parsing\"\n        body=\"There were errors while trying to parse the query. Continuing to visual builder may loose some parts of the query.\"\n        confirmText=\"Continue\"\n        onConfirm={() => {\n          onChange({ ...query, editorMode: QueryEditorMode.Builder });\n          setParseModalOpen(false);\n        }}\n        onDismiss={() => setParseModalOpen(false)}\n      />\n      <EditorHeader>\n        <InlineSelect\n          value={null}\n          placeholder=\"Query patterns\"\n          aria-label={selectors.components.QueryBuilder.queryPatterns}\n          allowCustomValue\n          onChange={({ value }: SelectableValue<LokiQueryPattern>) => {\n            const result = buildVisualQueryFromString(query.expr || '');\n            result.query.operations = value?.operations!;\n            onChange({\n              ...query,\n              expr: lokiQueryModeller.renderQuery(result.query),\n            });\n          }}\n          options={lokiQueryModeller.getQueryPatterns().map((x) => ({ label: x.name, value: x }))}\n        />\n        <QueryHeaderSwitch label=\"Explain\" value={explain} onChange={onExplainChange} />\n        {editorMode === QueryEditorMode.Builder && (\n          <>\n            <QueryHeaderSwitch label=\"Raw query\" value={rawQuery} onChange={onQueryPreviewChange} />\n            <FeedbackLink feedbackUrl=\"https://github.com/grafana/grafana/discussions/50785\" />\n          </>\n        )}\n        <FlexItem grow={1} />\n        {app !== CoreApp.Explore && (\n          <Button\n            variant={dataIsStale ? 'primary' : 'secondary'}\n            size=\"sm\"\n            onClick={onRunQuery}\n            icon={data?.state === LoadingState.Loading ? 'fa fa-spinner' : undefined}\n            disabled={data?.state === LoadingState.Loading}\n          >\n            Run queries\n          </Button>\n        )}\n        <QueryEditorModeToggle mode={editorMode!} onChange={onEditorModeChange} />\n      </EditorHeader>\n      <Space v={0.5} />\n      <EditorRows>\n        {editorMode === QueryEditorMode.Code && (\n          <LokiQueryCodeEditor {...props} query={query} onChange={onChangeInternal} showExplain={explain} />\n        )}\n        {editorMode === QueryEditorMode.Builder && (\n          <LokiQueryBuilderContainer\n            datasource={props.datasource}\n            query={query}\n            onChange={onChangeInternal}\n            onRunQuery={props.onRunQuery}\n            showRawQuery={rawQuery}\n            showExplain={explain}\n          />\n        )}\n        <LokiQueryBuilderOptions query={query} onChange={onChange} onRunQuery={onRunQuery} app={app} />\n      </EditorRows>\n    </>\n  );\n});\n\nLokiQueryEditorSelector.displayName = 'LokiQueryEditorSelector';\n","// Libraries\nimport React, { memo } from 'react';\n\n// Types\nimport { QueryEditorProps } from '@grafana/data';\n\nimport { LokiDatasource } from '../datasource';\nimport { LokiQuery, LokiOptions } from '../types';\n\nimport { LokiOptionFields } from './LokiOptionFields';\nimport { LokiQueryField } from './LokiQueryField';\n\ntype Props = QueryEditorProps<LokiDatasource, LokiQuery, LokiOptions>;\n\nexport const LokiExploreQueryEditor = memo((props: Props) => {\n  const { query, data, datasource, history, onChange, onRunQuery, range } = props;\n\n  return (\n    <LokiQueryField\n      datasource={datasource}\n      query={query}\n      onChange={onChange}\n      onBlur={() => {}}\n      onRunQuery={onRunQuery}\n      history={history}\n      data={data}\n      range={range}\n      data-testid={testIds.editor}\n      ExtraFieldElement={\n        <LokiOptionFields\n          lineLimitValue={query?.maxLines?.toString() || ''}\n          resolution={query.resolution || 1}\n          query={query}\n          onRunQuery={onRunQuery}\n          onChange={onChange}\n        />\n      }\n    />\n  );\n});\n\nLokiExploreQueryEditor.displayName = 'LokiExploreQueryEditor';\n\nexport const testIds = {\n  editor: 'loki-editor-explore',\n};\n","import React from 'react';\n\nimport { LokiQueryField } from './LokiQueryField';\nimport { LokiQueryEditorProps } from './types';\n\nexport function LokiQueryEditorForAlerting(props: LokiQueryEditorProps) {\n  const { query, data, datasource, onChange, onRunQuery } = props;\n\n  return (\n    <LokiQueryField\n      datasource={datasource}\n      query={query}\n      onChange={onChange}\n      onRunQuery={onRunQuery}\n      onBlur={onRunQuery}\n      history={[]}\n      data={data}\n      placeholder=\"Enter a Loki query\"\n      data-testid={testIds.editor}\n    />\n  );\n}\n\nexport const testIds = {\n  editor: 'loki-editor-cloud-alerting',\n};\n","import React, { memo } from 'react';\n\nimport { CoreApp } from '@grafana/data';\nimport { config } from '@grafana/runtime';\n\nimport { LokiQueryEditorSelector } from '../querybuilder/components/LokiQueryEditorSelector';\n\nimport { LokiExploreQueryEditor } from './LokiExploreQueryEditor';\nimport { LokiQueryEditor } from './LokiQueryEditor';\nimport { LokiQueryEditorForAlerting } from './LokiQueryEditorForAlerting';\nimport { LokiQueryEditorProps } from './types';\n\nexport function LokiQueryEditorByApp(props: LokiQueryEditorProps) {\n  const { app } = props;\n\n  switch (app) {\n    case CoreApp.CloudAlerting:\n      return <LokiQueryEditorForAlerting {...props} />;\n    case CoreApp.Explore:\n      if (config.featureToggles.lokiQueryBuilder) {\n        return <LokiQueryEditorSelector {...props} />;\n      }\n      return <LokiExploreQueryEditor {...props} />;\n    default:\n      if (config.featureToggles.lokiQueryBuilder) {\n        return <LokiQueryEditorSelector {...props} />;\n      }\n      return <LokiQueryEditor {...props} />;\n  }\n}\n\nexport default memo(LokiQueryEditorByApp);\n","import { css } from '@emotion/css';\nimport cx from 'classnames';\nimport React, { useState } from 'react';\n\nimport { ArrayVector, Field, FieldType, LinkModel } from '@grafana/data';\nimport { LegacyForms } from '@grafana/ui';\n\nimport { getFieldLinksForExplore } from '../../../../features/explore/utils/links';\nimport { DerivedFieldConfig } from '../types';\n\nconst { FormField } = LegacyForms;\n\ntype Props = {\n  derivedFields?: DerivedFieldConfig[];\n  className?: string;\n};\nexport const DebugSection = (props: Props) => {\n  const { derivedFields, className } = props;\n  const [debugText, setDebugText] = useState('');\n\n  let debugFields: DebugField[] = [];\n  if (debugText && derivedFields) {\n    debugFields = makeDebugFields(derivedFields, debugText);\n  }\n\n  return (\n    <div className={className}>\n      <FormField\n        labelWidth={12}\n        label={'Debug log message'}\n        inputEl={\n          <textarea\n            placeholder={'Paste an example log line here to test the regular expressions of your derived fields'}\n            className={cx(\n              'gf-form-input gf-form-textarea',\n              css`\n                width: 100%;\n              `\n            )}\n            value={debugText}\n            onChange={(event) => setDebugText(event.currentTarget.value)}\n          />\n        }\n      />\n      {!!debugFields.length && <DebugFields fields={debugFields} />}\n    </div>\n  );\n};\n\ntype DebugFieldItemProps = {\n  fields: DebugField[];\n};\nconst DebugFields = ({ fields }: DebugFieldItemProps) => {\n  return (\n    <table className={'filter-table'}>\n      <thead>\n        <tr>\n          <th>Name</th>\n          <th>Value</th>\n          <th>Url</th>\n        </tr>\n      </thead>\n      <tbody>\n        {fields.map((field) => {\n          let value: any = field.value;\n          if (field.error) {\n            value = field.error.message;\n          } else if (field.href) {\n            value = <a href={field.href}>{value}</a>;\n          }\n          return (\n            <tr key={`${field.name}=${field.value}`}>\n              <td>{field.name}</td>\n              <td>{value}</td>\n              <td>{field.href ? <a href={field.href}>{field.href}</a> : ''}</td>\n            </tr>\n          );\n        })}\n      </tbody>\n    </table>\n  );\n};\n\ntype DebugField = {\n  name: string;\n  error?: any;\n  value?: string;\n  href?: string;\n};\n\nfunction makeDebugFields(derivedFields: DerivedFieldConfig[], debugText: string): DebugField[] {\n  return derivedFields\n    .filter((field) => field.name && field.matcherRegex)\n    .map((field) => {\n      try {\n        const testMatch = debugText.match(field.matcherRegex);\n        const value = testMatch && testMatch[1];\n        let link: LinkModel<Field> | null = null;\n\n        if (field.url && value) {\n          link = getFieldLinksForExplore({\n            field: {\n              name: '',\n              type: FieldType.string,\n              values: new ArrayVector([value]),\n              config: {\n                links: [{ title: '', url: field.url }],\n              },\n            },\n            rowIndex: 0,\n            range: {} as any,\n          })[0];\n        }\n\n        return {\n          name: field.name,\n          value: value || '<no match>',\n          href: link && link.href,\n        } as DebugField;\n      } catch (error) {\n        return {\n          name: field.name,\n          error,\n        } as DebugField;\n      }\n    });\n}\n","import { css } from '@emotion/css';\nimport React, { useEffect, useState } from 'react';\nimport { usePrevious } from 'react-use';\n\nimport { VariableSuggestion } from '@grafana/data';\nimport { DataSourcePicker } from '@grafana/runtime';\nimport { Button, DataLinkInput, stylesFactory, LegacyForms } from '@grafana/ui';\n\nimport { DerivedFieldConfig } from '../types';\n\nconst { Switch, FormField } = LegacyForms;\n\nconst getStyles = stylesFactory(() => ({\n  row: css`\n    display: flex;\n    align-items: baseline;\n  `,\n  nameField: css`\n    flex: 2;\n  `,\n  regexField: css`\n    flex: 3;\n  `,\n  urlField: css`\n    flex: 1;\n  `,\n  urlDisplayLabelField: css`\n    flex: 1;\n  `,\n}));\n\ntype Props = {\n  value: DerivedFieldConfig;\n  onChange: (value: DerivedFieldConfig) => void;\n  onDelete: () => void;\n  suggestions: VariableSuggestion[];\n  className?: string;\n};\nexport const DerivedField = (props: Props) => {\n  const { value, onChange, onDelete, suggestions, className } = props;\n  const styles = getStyles();\n  const [showInternalLink, setShowInternalLink] = useState(!!value.datasourceUid);\n  const previousUid = usePrevious(value.datasourceUid);\n\n  // Force internal link visibility change if uid changed outside of this component.\n  useEffect(() => {\n    if (!previousUid && value.datasourceUid && !showInternalLink) {\n      setShowInternalLink(true);\n    }\n    if (previousUid && !value.datasourceUid && showInternalLink) {\n      setShowInternalLink(false);\n    }\n  }, [previousUid, value.datasourceUid, showInternalLink]);\n\n  const handleChange = (field: keyof typeof value) => (event: React.ChangeEvent<HTMLInputElement>) => {\n    onChange({\n      ...value,\n      [field]: event.currentTarget.value,\n    });\n  };\n\n  return (\n    <div className={className}>\n      <div className={styles.row}>\n        <FormField\n          className={styles.nameField}\n          labelWidth={5}\n          // A bit of a hack to prevent using default value for the width from FormField\n          inputWidth={null}\n          label=\"Name\"\n          type=\"text\"\n          value={value.name}\n          onChange={handleChange('name')}\n        />\n        <FormField\n          className={styles.regexField}\n          inputWidth={null}\n          label=\"Regex\"\n          type=\"text\"\n          value={value.matcherRegex}\n          onChange={handleChange('matcherRegex')}\n          tooltip={\n            'Use to parse and capture some part of the log message. You can use the captured groups in the template.'\n          }\n        />\n        <Button\n          variant=\"destructive\"\n          title=\"Remove field\"\n          icon=\"times\"\n          onClick={(event) => {\n            event.preventDefault();\n            onDelete();\n          }}\n          className={css`\n            margin-left: 8px;\n          `}\n        />\n      </div>\n\n      <div className={styles.row}>\n        <FormField\n          label={showInternalLink ? 'Query' : 'URL'}\n          inputEl={\n            <DataLinkInput\n              placeholder={showInternalLink ? '${__value.raw}' : 'http://example.com/${__value.raw}'}\n              value={value.url || ''}\n              onChange={(newValue) =>\n                onChange({\n                  ...value,\n                  url: newValue,\n                })\n              }\n              suggestions={suggestions}\n            />\n          }\n          className={styles.urlField}\n        />\n        <FormField\n          className={styles.urlDisplayLabelField}\n          inputWidth={null}\n          label=\"URL Label\"\n          type=\"text\"\n          value={value.urlDisplayLabel}\n          onChange={handleChange('urlDisplayLabel')}\n          tooltip={'Use to override the button label when this derived field is found in a log.'}\n        />\n      </div>\n\n      <div className={styles.row}>\n        <Switch\n          label=\"Internal link\"\n          checked={showInternalLink}\n          onChange={() => {\n            if (showInternalLink) {\n              onChange({\n                ...value,\n                datasourceUid: undefined,\n              });\n            }\n            setShowInternalLink(!showInternalLink);\n          }}\n        />\n\n        {showInternalLink && (\n          <DataSourcePicker\n            tracing={true}\n            onChange={(ds) =>\n              onChange({\n                ...value,\n                datasourceUid: ds.uid,\n              })\n            }\n            current={value.datasourceUid}\n          />\n        )}\n      </div>\n    </div>\n  );\n};\n","import { css } from '@emotion/css';\nimport React, { useState } from 'react';\n\nimport { GrafanaTheme2, VariableOrigin, DataLinkBuiltInVars } from '@grafana/data';\nimport { Button, useTheme2 } from '@grafana/ui';\n\nimport { DerivedFieldConfig } from '../types';\n\nimport { DebugSection } from './DebugSection';\nimport { DerivedField } from './DerivedField';\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  infoText: css`\n    padding-bottom: ${theme.spacing(2)};\n    color: ${theme.colors.text.secondary};\n  `,\n  derivedField: css`\n    margin-bottom: ${theme.spacing(1)};\n  `,\n});\n\ntype Props = {\n  value?: DerivedFieldConfig[];\n  onChange: (value: DerivedFieldConfig[]) => void;\n};\n\nexport const DerivedFields = (props: Props) => {\n  const { value, onChange } = props;\n  const theme = useTheme2();\n  const styles = getStyles(theme);\n\n  const [showDebug, setShowDebug] = useState(false);\n\n  return (\n    <>\n      <h3 className=\"page-heading\">Derived fields</h3>\n\n      <div className={styles.infoText}>\n        Derived fields can be used to extract new fields from a log message and create a link from its value.\n      </div>\n\n      <div className=\"gf-form-group\">\n        {value &&\n          value.map((field, index) => {\n            return (\n              <DerivedField\n                className={styles.derivedField}\n                key={index}\n                value={field}\n                onChange={(newField) => {\n                  const newDerivedFields = [...value];\n                  newDerivedFields.splice(index, 1, newField);\n                  onChange(newDerivedFields);\n                }}\n                onDelete={() => {\n                  const newDerivedFields = [...value];\n                  newDerivedFields.splice(index, 1);\n                  onChange(newDerivedFields);\n                }}\n                suggestions={[\n                  {\n                    value: DataLinkBuiltInVars.valueRaw,\n                    label: 'Raw value',\n                    documentation: 'Exact string captured by the regular expression',\n                    origin: VariableOrigin.Value,\n                  },\n                ]}\n              />\n            );\n          })}\n        <div>\n          <Button\n            variant=\"secondary\"\n            className={css`\n              margin-right: 10px;\n            `}\n            icon=\"plus\"\n            onClick={(event) => {\n              event.preventDefault();\n              const newDerivedFields = [...(value || []), { name: '', matcherRegex: '' }];\n              onChange(newDerivedFields);\n            }}\n          >\n            Add\n          </Button>\n\n          {value && value.length > 0 && (\n            <Button variant=\"secondary\" type=\"button\" onClick={() => setShowDebug(!showDebug)}>\n              {showDebug ? 'Hide example log message' : 'Show example log message'}\n            </Button>\n          )}\n        </div>\n      </div>\n\n      {showDebug && (\n        <div className=\"gf-form-group\">\n          <DebugSection\n            className={css`\n              margin-bottom: 10px;\n            `}\n            derivedFields={value}\n          />\n        </div>\n      )}\n    </>\n  );\n};\n","import React from 'react';\n\nimport { LegacyForms } from '@grafana/ui';\nconst { FormField } = LegacyForms;\n\ntype Props = {\n  value: string;\n  onChange: (value: string) => void;\n};\n\nexport const MaxLinesField = (props: Props) => {\n  const { value, onChange } = props;\n  return (\n    <FormField\n      label=\"Maximum lines\"\n      labelWidth={11}\n      inputWidth={20}\n      inputEl={\n        <input\n          type=\"number\"\n          className=\"gf-form-input width-8 gf-form-input--has-help-icon\"\n          value={value}\n          onChange={(event) => onChange(event.currentTarget.value)}\n          spellCheck={false}\n          placeholder=\"1000\"\n        />\n      }\n      tooltip={\n        <>\n          Loki queries must contain a limit of the maximum number of lines returned (default: 1000). Increase this limit\n          to have a bigger result set for ad-hoc analysis. Decrease this limit if your browser becomes sluggish when\n          displaying the log results.\n        </>\n      }\n    />\n  );\n};\n","import React from 'react';\n\nimport { DataSourcePluginOptionsEditorProps, DataSourceSettings } from '@grafana/data';\nimport { AlertingSettings, DataSourceHttpSettings } from '@grafana/ui';\nimport { getAllAlertmanagerDataSources } from 'app/features/alerting/unified/utils/alertmanager';\n\nimport { LokiOptions } from '../types';\n\nimport { DerivedFields } from './DerivedFields';\nimport { MaxLinesField } from './MaxLinesField';\n\nexport type Props = DataSourcePluginOptionsEditorProps<LokiOptions>;\n\nconst makeJsonUpdater =\n  <T extends any>(field: keyof LokiOptions) =>\n  (options: DataSourceSettings<LokiOptions>, value: T): DataSourceSettings<LokiOptions> => {\n    return {\n      ...options,\n      jsonData: {\n        ...options.jsonData,\n        [field]: value,\n      },\n    };\n  };\n\nconst setMaxLines = makeJsonUpdater('maxLines');\nconst setDerivedFields = makeJsonUpdater('derivedFields');\n\nexport const ConfigEditor = (props: Props) => {\n  const { options, onOptionsChange } = props;\n  const alertmanagers = getAllAlertmanagerDataSources();\n\n  return (\n    <>\n      <DataSourceHttpSettings\n        defaultUrl={'http://localhost:3100'}\n        dataSourceConfig={options}\n        showAccessOptions={false}\n        onChange={onOptionsChange}\n      />\n\n      <AlertingSettings<LokiOptions>\n        alertmanagerDataSources={alertmanagers}\n        options={options}\n        onOptionsChange={onOptionsChange}\n      />\n\n      <div className=\"gf-form-group\">\n        <div className=\"gf-form-inline\">\n          <div className=\"gf-form\">\n            <MaxLinesField\n              value={options.jsonData.maxLines || ''}\n              onChange={(value) => onOptionsChange(setMaxLines(options, value))}\n            />\n          </div>\n        </div>\n      </div>\n\n      <DerivedFields\n        value={options.jsonData.derivedFields}\n        onChange={(value) => onOptionsChange(setDerivedFields(options, value))}\n      />\n    </>\n  );\n};\n","import { DataSourcePlugin } from '@grafana/data';\n\nimport LokiCheatSheet from './components/LokiCheatSheet';\nimport LokiQueryEditorByApp from './components/LokiQueryEditorByApp';\nimport { ConfigEditor } from './configuration/ConfigEditor';\nimport { LokiDatasource } from './datasource';\n\nexport const plugin = new DataSourcePlugin(LokiDatasource)\n  .setQueryEditor(LokiQueryEditorByApp)\n  .setConfigEditor(ConfigEditor)\n  .setQueryEditorHelp(LokiCheatSheet);\n"],"names":["DEFAULT_EXAMPLES","PREFERRED_LABELS","LOGQL_EXAMPLES","title","expression","label","LokiCheatSheet","PureComponent","userExamples","async","provider","this","props","datasource","languageProvider","started","labels","getLabelKeys","preferredLabel","find","l","includes","values","getLabelValues","shuffle","slice","map","value","setState","scheduleUserLabelChecking","componentDidMount","reportInteraction","componentWillUnmount","clearTimeout","userLabelTimer","setTimeout","checkUserLabels","renderExpression","expr","onClickExample","className","onClick","e","refId","render","state","hasUserExamples","length","example","href","target","item","LokiVisualQueryOperationCategory","LokiOperationId","LokiOperationOrder","binaryScalarDefs","id","Addition","name","sign","Subtraction","MultiplyBy","DivideBy","Modulo","Exponent","EqualTo","comparison","NotEqualTo","GreaterThan","LessThan","GreaterOrEqual","LessOrEqual","binaryScalarOperations","opDef","params","type","defaultParams","unshift","description","alternativesKey","category","BinaryOps","renderer","operator","model","def","innerExpr","param","bool","addOperationHandler","defaultAddOperationHandler","fieldFromDerivedFieldConfig","derivedFieldConfigs","dataSourceSrv","getDataSourceSrv","dataLinks","reduce","acc","derivedFieldConfig","datasourceUid","dsSettings","getInstanceSettings","push","urlDisplayLabel","url","internal","query","datasourceName","FieldType","config","links","ArrayVector","makeTableFrames","instantMetricFrames","framesWithRefId","filter","f","undefined","framesByRefId","groupBy","frame","Object","entries","frames","tableTimeField","tableValueField","allLabelNames","Set","fields","field","keys","flat","labelFields","Array","from","sort","labelName","filterable","forEach","timeField","valueField","timeArray","toArray","valueArray","x","add","text","i","meta","preferredVisualisationType","makeTableFrame","keywordTokens","json","logfmt","unpack","pattern","regexp","ip","label_format","line_format","label_replace","offset","on","ignoring","group_left","group_right","unwrap","contextualKeywordTokens","by","without","and","or","unless","sum","avg","count","max","min","stddev","stdvar","bottomk","topk","spec_Identifier","__proto__","count_over_time","rate","bytes_over_time","bytes_rate","avg_over_time","sum_over_time","min_over_time","max_over_time","stddev_over_time","stdvar_over_time","quantile_over_time","first_over_time","last_over_time","absent_over_time","bytes","duration","duration_seconds","parser","version","states","stateData","goto","nodeNames","maxTerm","skippedNodes","repeatNodeCount","tokenData","tokenizers","topRules","specialized","term","get","stack","toLowerCase","specializeIdentifier","extendIdentifier","tokenPrec","LokiResultType","LokiQueryType","LokiQueryDirection","getHighlighterExpressionsFromQuery","input","results","filterStart","search","filterOperator","skip","filterEnd","filterTerm","trim","quotedTerm","match","backtickedTerm","unwrappedFilterTerm","resultTerm","replace","escapeRegExp","getNormalizedLokiQuery","queryType","Range","Instant","Stream","instant","rest","isValidQuery","isValid","parse","iterate","enter","ErrorName","isLogsQuery","setFrameMeta","oldMeta","newMeta","processStreamFrame","custom","lokiQueryStatKey","labelSets","some","__error__","dataFrameHasLokiError","error","selector","newFrame","limit","maxLines","searchWords","derivedFields","dataFrame","derivedFieldsGrouped","newFields","lineField","Error","line","logMatch","matcherRegex","getDerivedFields","processStreamsFrames","queryMap","processMetricRangeFrames","groupFrames","streamsFrames","metricInstantFrames","metricRangeFrames","every","isMetricFrame","improveError","message","queryTypeOptions","RESOLUTION_OPTIONS","concat","LokiOptionFields","lineLimitValue","resolution","onRunQuery","runOnBlur","onChange","onQueryTypeChange","cx","css","InlineFormLabel","width","RadioButtonGroup","options","InlineField","tooltip","Input","placeholder","preprocessMaxLines","currentTarget","nextQuery","onChangeQueryLimit","onKeyDown","key","onBlur","Select","isSearchable","option","NaN","isNaN","LokiAnnotationsQueryEditor","memo","annotation","onAnnotationChange","onChangeQuery","queryWithRefId","LokiQueryField","history","ExtraFieldElement","toString","EditorRow","EditorField","titleFormat","event","tagKeys","textFormat","DEFAULT_KEYS","EMPTY_SELECTOR","RATE_RANGES","sortValue","wrapLabel","filterText","LokiLanguageProvider","LanguageProvider","constructor","initialValues","super","LRU","s","metadataRequest","console","startTask","fetchLabels","then","context","suggestions","getEmptyCompletionItems","getTermCompletionItems","prefixMatch","items","FUNCTIONS","suggestion","kind","PIPE_OPERATORS","PIPE_PARSERS","interpolatedMatch","interpolateString","start","end","getTimeRangeParams","cacheKey","generateCacheKey","seriesCache","set","data","request","processLabels","labelKeys","labelFetchTs","assign","getSyntax","syntax","wrapperClasses","prefix","emptyResult","empty","document","selectedLines","getTextsAtRange","selection","currentLine","size","first","getText","nextCharacter","anchor","tokenRecognized","prefixUnrecognized","noSuffix","safePrefix","isNextOperand","getRangeCompletionItems","getLabelCompletionItems","getPipeCompletionItem","getBeginningCompletionItems","historyItems","chain","h","uniq","take","cutoffTs","Date","now","historyForItem","ts","hint","recent","dateTime","fromNow","documentation","addHistoryMetadata","skipSort","labelKey","anchorBlock","cursorOffset","isValueStart","parsedSelector","parseSelector","existingKeys","labelValues","getSeriesLabels","warn","possibleKeys","difference","newSuggestion","importFromAbstractQuery","labelBasedQuery","toPromLikeExpr","exportToAbstractQuery","lokiQuery","labelMatchers","tokens","Prism","extractLabelMatchers","lookupsDisabled","fetchSeriesLabels","timeRange","valueOf","res","isArray","forceRefresh","roundTime","join","nanos","Math","floor","fetchLabelValues","interpolatedKey","encodeURIComponent","rangeParams","labelsCache","DEFAULT_WEBSOCKET_CONFIG","deserializer","JSON","serializer","stringify","WebSocketSubject","_super","urlConfigOrSource","destination","_this","call","_socket","Observable","source","_config","__assign","_output","Subject","hasOwnProperty","WebSocketCtor","WebSocket","ReplaySubject","__extends","prototype","lift","sock","_resetState","multiplex","subMsg","unsubMsg","messageFilter","self","observer","next","err","subscription","subscribe","complete","unsubscribe","_connectSocket","_a","protocol","binaryType","socket","Subscription","readyState","close","onopen","evt","openObserver","queue","Subscriber","send","closingObserver","code","reason","TypeError","onerror","onclose","closeObserver","wasClean","onmessage","_subscribe","subscriber","observers","uuid","validate","v","arr","Uint8Array","parseInt","y","z","ROTL","n","hashfunc","generateUUID","namespace","buf","str","unescape","charCodeAt","stringToBytes","DNS","URL","v35","K","H","msg","N","ceil","M","_i","Uint32Array","j","pow","_i2","W","t","_t","a","b","c","d","_t2","T","createUid","labelsString","usedUids","uuidv5","newCount","LiveStreams","getStream","retryInterval","stream","streams","CircularDataFrame","capacity","addField","pipe","response","tsField","idField","allLabelsString","val","toISOString","appendResponseToBufferedData","retryWhen","attempts","mergeMap","retryAttempt","timer","throwError","finalize","buildVisualQueryFromString","replacedExpr","replaceVariables","node","topNode","operations","errors","handleExpression","isEmptyQuery","visQuery","labelNode","getChild","getString","op","nextSibling","getLabel","makeError","operation","filterExpr","handleQuotes","LineFilterIpMatches","LineContains","LineContainsNot","LineMatchesRegex","LineMatchesRegexNot","getLineFilter","createNotSupportedError","parserNode","firstChild","string","getLabelParser","ipLabelFilter","valueString","LabelFilterIpMatches","getLabelFilter","getAllByType","getJsonExpressionParser","getLineFormat","renameTo","originalLabel","getLabelFormat","unwrapExprChild","labelFilterChild","unwrapChild","convOp","identifier","handleUnwrapExpr","nameNode","funcName","number","logExpr","handleRangeAggregation","grouping","numberNode","Number","metricExpr","handleVectorAggregation","left","binModifier","isBool","isMatcher","matcher","matches","matchType","getBinaryModifier","right","lastChild","operatorToOpName","leftNumber","getLastChildWithSelector","rightNumber","rightBinary","makeBinOp","leftMostChild","getLeftMostChild","binaryQueries","binQuery","vectorMatchesType","vectorMatches","handleBinary","parent","isIntervalVariableError","child","children","split","addLabelToQuery","streamSelectorPositions","getStreamSelectorPositions","parserPositions","getParserPositions","labelFilterPositions","tree","positions","to","getLabelFilterPositions","toLabelFilter","addFilterAsLabelFilter","prev","current","vectorSelectorPositions","modeller","LokiQueryModeller","newQuery","isLast","substring","matchVisQuery","labelExists","renderQuery","addFilterToStreamSelector","addParserToQuery","lineFilterPositions","getLineFiltersPositions","addParser","addLabelFormatToQuery","labelFormat","logQueryPositions","logPartsPositions","pipeline","sorted","sortBy","position","getLogQueryPositions","addLabelFormat","removeCommentsFromQuery","lineCommentPositions","getLineCommentPositions","lineCommentPosition","positionsToAddAfter","queryPartPositions","getQueryHints","series","hints","queryWithParser","parserCount","isQueryWithParser","hasLogfmt","hasJSON","logLines","getParser","LogsParsers","extractLogParserFromDataFrame","fix","action","hasPipelineErrorFiltering","isQueryPipelineErrorFiltering","labelField","extractHasErrorLabelFromDataFrame","queryWithLabelFormat","isQueryWithLabelFormat","hasLevel","level","dataFrameHasLevelLabel","levelLikeLabel","labelsArray","extractLevelLikeLabelFromDataFrame","sortDataFrameByTime","dir","tsNsField","index","fieldValues","isAsc","valA","valB","makeIndex","SortedVector","doLokiChannelStream","ds","range","maxDelta","maxLength","maxDataPoints","updateFrame","p","StreamingDataFrame","displayNameFormat","legendFormat","defer","msgUint8","TextEncoder","encode","hashBuffer","crypto","subtle","digest","padStart","getLiveStreamKey","getGrafanaLiveSrv","scope","LiveChannelScope","uid","path","LoadingState","NS_IN_MS","makeRequest","app","requestId","intervalInfo","rangeUtil","targets","interval","intervalMs","scopedVars","timezone","startTime","LokiDatasource","DataSourceWithBackend","instanceSettings","templateSrv","getTemplateSrv","timeSrv","getTimeSrv","liveTarget","createLiveTarget","catchError","row","direction","prepareLogRowContextQueryTarget","processResults","result","processedFrames","cache","FieldCache","timestampField","getFirstFieldOfType","getFieldByName","processDataFrame","CoreApp","lastValueFrom","status","statusText","switchMap","of","contextTimeBuffer","queryDirection","Forward","Backward","tsValue","rowIndex","timestamp","toUtc","timeEpochMs","raw","settingsData","jsonData","annotations","QueryEditor","getLogsVolumeDataProvider","isQuerySuitable","normalized","logsVolumeRequest","cloneDeep","volumeQuery","queryLogsVolume","extractLevel","queries","q","fixedRequest","streamQueries","rangeRaw","streamRequest","merge","applyTemplateVariables","liveStreaming","runLiveQueryThroughBackend","dataFrames","isDataFrame","Map","transformBackendResult","logsQueries","subQueries","runLiveQuery","baseUrl","serializeParams","convertToWebSocketUrl","getRangeScopedVars","msRange","diff","sRange","round","__range_ms","__range_s","__range","interpolateVariablesInQueries","expandedQueries","getRef","interpolateQueryExpr","getQueryDisplayText","abstractQueries","abstractQuery","labelMatcher","startsWith","getResource","Promise","resolve","interpolated","processMetricFindQuery","labelNamesQuery","labelValuesSeriesQuery","labelValuesQuery","timeParams","getDefaultTimeRange","variable","multi","includeAll","lokiRegularEscape","lokiSpecialRegexEscape","lodashMap","modifyQuery","addNoPipelineErrorToQuery","getTime","date","roundUp","dateMath","testDatasource","nowMs","info","splitKeys","DataFrameView","maybeDuplicatedTags","tags","time","Time","renderLegendFormat","Line","showContextToggle","processError","addAdHocFilters","queryExpr","adhocFilters","getAdhocFilters","returnVariables","escapeLabelValueInSelector","filterQuery","hide","exprWithAdHoc","getVariables","labelNames","levelLabel","getLogLevelFromKey","LogLevel","getLogLevelFromLabels","UnwrapParamEditor","operationIndex","useState","inputId","getOperationParamId","onOpenMenu","isLoading","pipelineExpr","getLogQueryFromMetricsQuery","lokiQueryModeller","samples","getDataSamples","possibleUnwrapLabels","isValidGoDuration","isBytesString","unwrapLabels","obj","loadUnwrapOptions","allowCustomValue","noOptionsMessage","loadingMessage","toOption","getOperationDefinitions","aggregations","Sum","Min","Max","Avg","Stddev","Stdvar","Count","flatMap","opId","createAggregationOperation","addLokiOperation","orderRank","Last","aggregationsWithParam","TopK","BottomK","createAggregationOperationWithParam","createRangeOperation","Rate","CountOverTime","SumOverTime","BytesRate","BytesOverTime","AbsentOverTime","AvgOverTime","MaxOverTime","MinOverTime","FirstOverTime","LastOverTime","StdvarOverTime","StddevOverTime","QuantileOverTime","Json","restParam","optional","minWidth","Formats","LineFormats","explainHandler","Logfmt","pipelineRenderer","Regexp","hideName","Pattern","Unpack","LineFormat","LabelFormat","runQueryOnEnter","LineFilters","getLineFilterRenderer","LabelFilter","LabelFilters","labelFilterRenderer","LabelFilterNoErrors","NoErrors","Unwrap","editor","String","NestedQuery","addNestedQueryHandler","operationWithRangeVectorRenderer","operationWithRangeVectorRendererAndParam","getPromAndLokiOperationDisplayName","RangeFunctions","RangeVectorFunction","opDocs","insertText","rangeVector","getIndexOfOrLast","queryModeller","condition","findIndex","getOperationDef","newOperation","existingRangeVectorFunction","isRangeVectorFunction","Aggregations","Functions","placeToInsert","splice","indexOf","LokiAndPromQueryModellerBase","setOperationCategories","renderLabels","getQueryPatterns","queryEditorModeDefaultLocalStorageKey","getDefaultEditorMode","QueryEditorMode","store","React","nestedQuery","onRemove","showExplain","styles","useStyles2","getStyles","card","header","operators","vectorMatchWrapper","AutoSizeInput","vectorMatchInput","defaultValue","onCommitChange","FlexItem","grow","IconButton","body","EditorRows","LokiQueryBuilder","update","displayName","theme","display","flexDirection","gap","spacing","padding","alignItems","whiteSpace","paddingLeft","marginLeft","NestedQueryList","nestedQueries","onNestedQueryUpdate","updatedList","Stack","sampleData","setSampleData","highlightedOp","setHighlightedOp","withTemplateVariableOptions","optionsPromise","labelFilterError","useMemo","useEffect","onGetSampleData","catch","lang","grammar","logqlGrammar","onGetLabelNames","forLabel","labelsToConsider","refreshLogLabels","onGetLabelValues","labelsFilters","OperationExplainedBox","stepNumber","RawQuery","OperationsEditorRow","OperationList","QueryBuilderHints","OperationListExplained","onMouseEnter","onMouseLeave","QueryPreview","EditorFieldGroup","lokiGrammar","LokiQueryBuilderContainer","showRawQuery","dispatch","useReducer","stateSlice","reducer","exprChanged","visualQueryChange","createSlice","initialState","reducers","payload","parseResult","actions","LokiQueryBuilderOptions","showMaxLines","QueryOptionGroup","collapsedInfo","getCollapsedInfo","newMaxLines","queryTypeLabel","resolutionLabel","LokiQueryEditor","legendField","testIds","LokiQueryBuilderExplained","LokiQueryCodeEditor","wrapper","LokiQueryEditorSelector","parseModalOpen","setParseModalOpen","dataIsStale","setDataIsStale","flag","explain","setFlag","setExplain","useFlag","lokiQueryEditorExplainKey","rawQuery","setRawQuery","lokiQueryEditorRawQueryKey","editorMode","getQueryWithDefaults","onEditorModeChange","useCallback","newEditorMode","newEditor","previousEditor","changeEditorMode","onChangeInternal","ConfirmModal","isOpen","confirmText","onConfirm","onDismiss","EditorHeader","InlineSelect","selectors","QueryHeaderSwitch","checked","isEnabled","FeedbackLink","feedbackUrl","Button","variant","icon","disabled","QueryEditorModeToggle","mode","Space","LokiExploreQueryEditor","LokiQueryEditorForAlerting","LokiQueryEditorByApp","FormField","LegacyForms","DebugSection","debugText","setDebugText","debugFields","testMatch","link","getFieldLinksForExplore","makeDebugFields","labelWidth","inputEl","DebugFields","Switch","stylesFactory","nameField","regexField","urlField","urlDisplayLabelField","DerivedField","onDelete","showInternalLink","setShowInternalLink","previousUid","usePrevious","handleChange","inputWidth","preventDefault","DataLinkInput","newValue","DataSourcePicker","tracing","DerivedFields","infoText","colors","secondary","derivedField","useTheme2","showDebug","setShowDebug","newField","newDerivedFields","DataLinkBuiltInVars","origin","VariableOrigin","MaxLinesField","spellCheck","makeJsonUpdater","setMaxLines","setDerivedFields","plugin","DataSourcePlugin","setQueryEditor","setConfigEditor","onOptionsChange","alertmanagers","getAllAlertmanagerDataSources","DataSourceHttpSettings","defaultUrl","dataSourceConfig","showAccessOptions","AlertingSettings","alertmanagerDataSources","setQueryEditorHelp"],"sourceRoot":""}