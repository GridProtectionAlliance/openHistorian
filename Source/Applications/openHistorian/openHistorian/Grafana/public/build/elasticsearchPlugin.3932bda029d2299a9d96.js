(window.webpackJsonp=window.webpackJsonp||[]).push([[26],{EnIS:function(e,t,r){"use strict";r.r(t);var i=r("kDLi"),n=r("mrSG"),a=r("KHwQ"),s=r.n(a),o=r("LvDl"),l=r.n(o),u=r("wEtz"),g=[{text:"Count",value:"count",requiresField:!1},{text:"Average",value:"avg",requiresField:!0,supportsInlineScript:!0,supportsMissing:!0},{text:"Sum",value:"sum",requiresField:!0,supportsInlineScript:!0,supportsMissing:!0},{text:"Max",value:"max",requiresField:!0,supportsInlineScript:!0,supportsMissing:!0},{text:"Min",value:"min",requiresField:!0,supportsInlineScript:!0,supportsMissing:!0},{text:"Extended Stats",value:"extended_stats",requiresField:!0,supportsMissing:!0,supportsInlineScript:!0},{text:"Percentiles",value:"percentiles",requiresField:!0,supportsMissing:!0,supportsInlineScript:!0},{text:"Unique Count",value:"cardinality",requiresField:!0,supportsMissing:!0},{text:"Moving Average",value:"moving_avg",requiresField:!1,isPipelineAgg:!0,minVersion:2},{text:"Derivative",value:"derivative",requiresField:!1,isPipelineAgg:!0,minVersion:2},{text:"Bucket Script",value:"bucket_script",requiresField:!1,isPipelineAgg:!0,supportsMultipleBucketPaths:!0,minVersion:2},{text:"Raw Document",value:"raw_document",requiresField:!1}],c=[{text:"Terms",value:"terms",requiresField:!0},{text:"Filters",value:"filters"},{text:"Geo Hash Grid",value:"geohash_grid",requiresField:!0},{text:"Date Histogram",value:"date_histogram",requiresField:!0},{text:"Histogram",value:"histogram",requiresField:!0}],d=[{text:"Doc Count",value:"_count"},{text:"Term value",value:"_term"}],p=[{text:"Top",value:"desc"},{text:"Bottom",value:"asc"}],f=[{text:"No limit",value:"0"},{text:"1",value:"1"},{text:"2",value:"2"},{text:"3",value:"3"},{text:"5",value:"5"},{text:"10",value:"10"},{text:"15",value:"15"},{text:"20",value:"20"}],h=[{text:"Avg",value:"avg"},{text:"Min",value:"min"},{text:"Max",value:"max"},{text:"Sum",value:"sum"},{text:"Count",value:"count"},{text:"Std Dev",value:"std_deviation"},{text:"Std Dev Upper",value:"std_deviation_bounds_upper"},{text:"Std Dev Lower",value:"std_deviation_bounds_lower"}],m=[{text:"auto",value:"auto"},{text:"10s",value:"10s"},{text:"1m",value:"1m"},{text:"5m",value:"5m"},{text:"10m",value:"10m"},{text:"20m",value:"20m"},{text:"1h",value:"1h"},{text:"1d",value:"1d"}],v=[{text:"Simple",value:"simple"},{text:"Linear",value:"linear"},{text:"Exponentially Weighted",value:"ewma"},{text:"Holt Linear",value:"holt"},{text:"Holt Winters",value:"holt_winters"}],y={moving_avg:[{text:"window",default:5},{text:"model",default:"simple"},{text:"predict",default:void 0},{text:"minimize",default:!1}],derivative:[{text:"unit",default:void 0}],bucket_script:[]},x={simple:[],linear:[],ewma:[{text:"Alpha",value:"alpha",default:void 0}],holt:[{text:"Alpha",value:"alpha",default:void 0},{text:"Beta",value:"beta",default:void 0}],holt_winters:[{text:"Alpha",value:"alpha",default:void 0},{text:"Beta",value:"beta",default:void 0},{text:"Gamma",value:"gamma",default:void 0},{text:"Period",value:"period",default:void 0},{text:"Pad",value:"pad",default:void 0,isCheckbox:!0}]};function _(e){return l.a.filter(g,function(t){return!t.minVersion||t.minVersion<=e})}function b(e){if(e){var t=y[e];return null!=t}return!1}function k(e){return!!e&&void 0!==g.find(function(t){return t.value===e&&t.supportsMultipleBucketPaths})}function q(e,t){var r=[];return t?(l.a.each(x[e],function(e){e.isCheckbox||r.push(e)}),r):x[e]}function F(e){var t=l.a.find(g,{value:e.type});return t.requiresField||b(e.type)?t.text+" "+e.field:t.text}var S=function(e,t){return l.a.find(e,{id:t})},w=r("iZOS"),A=r("Obii"),O=function(){function e(e,t){this.targets=e,this.response=t,this.targets=e,this.response=t}return e.prototype.processMetrics=function(e,t,r,i){var n,a,s,o,l,u;for(a=0;a<t.metrics.length;a++)if(!(n=t.metrics[a]).hide)switch(n.type){case"count":for(o={datapoints:[],metric:"count",props:i},s=0;s<e.buckets.length;s++)u=(l=e.buckets[s]).doc_count,o.datapoints.push([u,l.key]);r.push(o);break;case"percentiles":if(0===e.buckets.length)break;var g=e.buckets[0][n.id].values;for(var c in g){for(o={datapoints:[],metric:"p"+c,props:i,field:n.field},s=0;s<e.buckets.length;s++){var d=(l=e.buckets[s])[n.id].values;o.datapoints.push([d[c],l.key])}r.push(o)}break;case"extended_stats":for(var p in n.meta)if(n.meta[p]){for(o={datapoints:[],metric:p,props:i,field:n.field},s=0;s<e.buckets.length;s++){var f=(l=e.buckets[s])[n.id];f.std_deviation_bounds_upper=f.std_deviation_bounds.upper,f.std_deviation_bounds_lower=f.std_deviation_bounds.lower,o.datapoints.push([f[p],l.key])}r.push(o)}break;default:for(o={datapoints:[],metric:n.type,field:n.field,metricId:n.id,props:i},s=0;s<e.buckets.length;s++)void 0!==(u=(l=e.buckets[s])[n.id])&&(u.normalized_value?o.datapoints.push([u.normalized_value,l.key]):o.datapoints.push([u.value,l.key]));r.push(o)}},e.prototype.processAggregationDocs=function(e,t,r,i,a){var s,o,u,g,c,d,p,f;if(0===i.columns.length){try{for(var h=n.i(l.a.keys(a)),m=h.next();!m.done;m=h.next()){var v=m.value;i.addColumn({text:v,filterable:!0})}}catch(e){s={error:e}}finally{try{m&&!m.done&&(o=h.return)&&o.call(h)}finally{if(s)throw s.error}}i.addColumn({text:t.field,filterable:!0})}var y=function(e,t,r){i.addColumn({text:t}),e.push(r)};try{for(var x=n.i(e.buckets),_=x.next();!_.done;_=x.next()){var b=_.value,k=[];try{for(var q=(c=void 0,n.i(l.a.values(a))),F=q.next();!F.done;F=q.next()){var S=F.value;k.push(S)}}catch(e){c={error:e}}finally{try{F&&!F.done&&(d=q.return)&&d.call(q)}finally{if(c)throw c.error}}k.push(b.key);try{for(var w=(p=void 0,n.i(r.metrics)),A=w.next();!A.done;A=w.next()){var O=A.value;switch(O.type){case"count":y(k,this.getMetricName(O.type),b.doc_count);break;case"extended_stats":for(var C in O.meta)if(O.meta[C]){var T=b[O.id];T.std_deviation_bounds_upper=T.std_deviation_bounds.upper,T.std_deviation_bounds_lower=T.std_deviation_bounds.lower,y(k,this.getMetricName(C),T[C])}break;case"percentiles":var M=b[O.id].values;for(var D in M)y(k,"p"+D+" "+O.field,M[D]);break;default:var V=this.getMetricName(O.type);l.a.filter(r.metrics,{type:O.type}).length>1&&(V+=" "+O.field),y(k,V,b[O.id].value)}}}catch(e){p={error:e}}finally{try{A&&!A.done&&(f=w.return)&&f.call(w)}finally{if(p)throw p.error}}i.rows.push(k)}}catch(e){u={error:e}}finally{try{_&&!_.done&&(g=x.return)&&g.call(x)}finally{if(u)throw u.error}}},e.prototype.processBuckets=function(e,t,r,i,n,a){var s,o,u,g,c=t.bucketAggs.length-1;for(g in e)if(o=l.a.find(t.bucketAggs,{id:g}),u=e[g],o)if(a===c)"date_histogram"===o.type?this.processMetrics(u,t,r,n):this.processAggregationDocs(u,o,t,i,n);else for(var d in u.buckets)s=u.buckets[d],n=l.a.clone(n),void 0!==s.key?n[o.field]=s.key:n.filter=d,s.key_as_string&&(n[o.field]=s.key_as_string),this.processBuckets(s,t,r,i,n,a+1)},e.prototype.getMetricName=function(e){var t=l.a.find(g,{value:e});return t||(t=l.a.find(h,{value:e})),t?t.text:e},e.prototype.getSeriesName=function(e,t,r){var i,a,s=this.getMetricName(e.metric);if(t.alias){return t.alias.replace(/\{\{([\s\S]+?)\}\}/g,function(t,r,i){var n=r||i;return 0===n.indexOf("term ")?e.props[n.substring(5)]:void 0!==e.props[n]?e.props[n]:"metric"===n?s:"field"===n?e.field||"":t})}if(e.field&&b(e.metric))if(e.metric&&k(e.metric)){var o=l.a.find(t.metrics,{id:e.metricId});if(o&&o.settings.script){s=o.settings.script;try{for(var u=n.i(o.pipelineVariables),g=u.next();!g.done;g=u.next()){var c=g.value;(d=l.a.find(t.metrics,{id:c.pipelineAgg}))&&(s=s.replace("params."+c.name,F(d)))}}catch(e){i={error:e}}finally{try{g&&!g.done&&(a=u.return)&&a.call(u)}finally{if(i)throw i.error}}}else s="Unset"}else{var d;(d=l.a.find(t.metrics,{id:e.field}))?s+=" "+F(d):s="Unset"}else e.field&&(s+=" "+e.field);if(0===l.a.keys(e.props).length)return s;var p="";for(var f in e.props)p+=e.props[f]+" ";return 1===r?p.trim():p.trim()+" "+s},e.prototype.nameSeries=function(e,t){for(var r=l.a.uniq(l.a.map(e,"metric")).length,i=0;i<e.length;i++){var n=e[i];n.target=this.getSeriesName(n,t,r)}},e.prototype.processHits=function(e,t){var r,i,n,a,s={target:"docs",type:"docs",datapoints:[],total:"number"==typeof e.total?e.total:e.total.value,filterable:!0};for(a=0;a<e.hits.length;a++){if(n={_id:(i=e.hits[a])._id,_type:i._type,_index:i._index},i._source)for(r in i._source)n[r]=i._source[r];for(r in i.fields)n[r]=i.fields[r];s.datapoints.push(n)}t.push(s)},e.prototype.trimDatapoints=function(e,t){var r=l.a.find(t.bucketAggs,{type:"date_histogram"});if(r&&r.settings&&r.settings.trimEdges){var i=r.settings.trimEdges;for(var n in e){var a=e[n];a.datapoints.length>2*i&&(a.datapoints=a.datapoints.slice(i,a.datapoints.length-i))}}},e.prototype.getErrorFromElasticResponse=function(e,t){var r={};return r.data=JSON.stringify(t,null,4),t.root_cause&&t.root_cause.length>0&&t.root_cause[0].reason?r.message=t.root_cause[0].reason:r.message=t.reason||"Unkown elastic error response",e.$$config&&(r.config=e.$$config),r},e.prototype.getTimeSeries=function(){for(var e=[],t=0;t<this.response.responses.length;t++){var r=this.response.responses[t];if(r.error)throw this.getErrorFromElasticResponse(this.response,r.error);if(r.hits&&r.hits.hits.length>0&&this.processHits(r.hits,e),r.aggregations){var i=r.aggregations,n=this.targets[t],a=[],s=new w.a;this.processBuckets(i,n,a,s,{},0),this.trimDatapoints(a,n),this.nameSeries(a,n);for(var o=0;o<a.length;o++)e.push(a[o]);s.rows.length>0&&e.push(s)}}return{data:e}},e.prototype.getLogs=function(e,t){for(var r,i,a,s,o=[],l=[],g=0;g<this.response.responses.length;g++){var c=this.response.responses[g];if(c.error)throw this.getErrorFromElasticResponse(this.response,c.error);var d=c.hits,p=[],f=void 0,h=void 0,m=void 0,v=void 0;for(v=0;v<d.hits.length;v++){var y=(h=d.hits[v])._source?Object(u.default)(h._source,null):{};for(f in(m={})[this.targets[0].timeField]=null,m=n.a({},m,{_id:h._id,_type:h._type,_index:h._index},y),h.fields)-1===p.indexOf(f)&&p.push(f),m[f]=h.fields[f];for(f in m)-1===p.indexOf(f)&&p.push(f);m._source=n.a({},y),l.push(m)}if(l.length>0){p=p.sort(),(D=new A.MutableDataFrame({fields:[]})).addField({name:this.targets[0].timeField,type:A.FieldType.time}).parse=function(e){return e[0]||""},e?D.addField({name:e,type:A.FieldType.string}).parse=function(e){return e||""}:D.addField({name:"_source",type:A.FieldType.string}).parse=function(e){return JSON.stringify(e,null,2)},t&&(D.addField({name:"level",type:A.FieldType.string}).parse=function(e){return e||""});try{for(var x=(r=void 0,n.i(p)),_=x.next();!_.done;_=x.next()){var b=_.value;b!==this.targets[0].timeField&&"_source"!==b&&(D.addField({name:b,type:A.FieldType.string}).parse=function(e){return e||""})}}catch(e){r={error:e}}finally{try{_&&!_.done&&(i=x.return)&&i.call(x)}finally{if(r)throw r.error}}try{for(var k=(a=void 0,n.i(l)),q=k.next();!q.done;q=k.next()){var F=q.value;D.add(F)}}catch(e){a={error:e}}finally{try{q&&!q.done&&(s=k.return)&&s.call(k)}finally{if(a)throw a.error}}o.push(D)}if(c.aggregations){var S=c.aggregations,O=this.targets[g],C=[],T=new w.a;this.processBuckets(S,O,C,T,{},0),this.trimDatapoints(C,O),this.nameSeries(C,O);for(var M=0;M<C.length;M++){var D;(D=Object(A.toDataFrame)(C[M])).labels={},o.push(D)}}}return{data:o}},e}(),C={Hourly:{startOf:"hour",amount:"hours"},Daily:{startOf:"day",amount:"days"},Weekly:{startOf:"isoWeek",amount:"weeks"},Monthly:{startOf:"month",amount:"months"},Yearly:{startOf:"year",amount:"years"}},T=function(){function e(e,t){this.pattern=e,this.interval=t}return e.prototype.getIndexForToday=function(){return this.interval?Object(A.toUtc)().format(this.pattern):this.pattern},e.prototype.getIndexList=function(e,t){if(!this.interval)return this.pattern;for(var r=C[this.interval],i=Object(A.dateTime)(e).utc().startOf(r.startOf),n=Object(A.dateTime)(t).utc().startOf(r.startOf).valueOf(),a=[];i.valueOf()<=n;)a.push(i.format(this.pattern)),i.add(1,r.amount);return a},e}(),M=function(){function e(e){this.timeField=e.timeField,this.esVersion=e.esVersion}return e.prototype.getRangeFilter=function(){var e={};return e[this.timeField]={gte:"$timeFrom",lte:"$timeTo",format:"epoch_millis"},e},e.prototype.buildTermsAgg=function(e,t,r){var i,n,a;if(t.terms={field:e.field},!e.settings)return t;if(t.terms.size=0===parseInt(e.settings.size,10)?500:parseInt(e.settings.size,10),void 0!==e.settings.orderBy&&(t.terms.order={},"_term"===e.settings.orderBy&&this.esVersion>=60?t.terms.order._key=e.settings.order:t.terms.order[e.settings.orderBy]=e.settings.order,i=parseInt(e.settings.orderBy,10),!isNaN(i)))for(a=0;a<r.metrics.length;a++)if((n=r.metrics[a]).id===e.settings.orderBy){t.aggs={},t.aggs[n.id]={},t.aggs[n.id][n.type]={field:n.field};break}return void 0!==e.settings.min_doc_count&&(t.terms.min_doc_count=parseInt(e.settings.min_doc_count,10)),e.settings.missing&&(t.terms.missing=e.settings.missing),t},e.prototype.getDateHistogramAgg=function(e){var t={},r=e.settings||{};return t.interval=r.interval,t.field=this.timeField,t.min_doc_count=r.min_doc_count||0,t.extended_bounds={min:"$timeFrom",max:"$timeTo"},t.format="epoch_millis",""!==r.offset&&(t.offset=r.offset),"auto"===t.interval&&(t.interval="$__interval"),r.missing&&(t.missing=r.missing),t},e.prototype.getHistogramAgg=function(e){var t={},r=e.settings||{};return t.interval=r.interval,t.field=e.field,t.min_doc_count=r.min_doc_count||0,r.missing&&(t.missing=r.missing),t},e.prototype.getFiltersAgg=function(e){for(var t={},r=0;r<e.settings.filters.length;r++){var i=e.settings.filters[r].query,n=e.settings.filters[r].label;t[n=""===n||void 0===n?i:n]={query_string:{query:i,analyze_wildcard:!0}}}return t},e.prototype.documentQuery=function(e,t){return e.size=t,e.sort={},e.sort[this.timeField]={order:"desc",unmapped_type:"boolean"},this.esVersion<5&&(e.fields=["*","_source"]),e.script_fields={},this.esVersion<5?e.fielddata_fields=[this.timeField]:e.docvalue_fields=[this.timeField],e},e.prototype.addAdhocFilters=function(e,t){var r,i,n,a;if(t)for(r=0;r<t.length;r++)switch((n={})[(i=t[r]).key]=i.value,(a={})[i.key]={query:i.value},i.operator){case"=":e.query.bool.must||(e.query.bool.must=[]),e.query.bool.must.push({match_phrase:a});break;case"!=":e.query.bool.must_not||(e.query.bool.must_not=[]),e.query.bool.must_not.push({match_phrase:a});break;case"<":n[i.key]={lt:i.value},e.query.bool.filter.push({range:n});break;case">":n[i.key]={gt:i.value},e.query.bool.filter.push({range:n});break;case"=~":e.query.bool.filter.push({regexp:n});break;case"!~":e.query.bool.filter.push({bool:{must_not:{regexp:n}}})}},e.prototype.build=function(e,t,r){var i,n,a,s,o;e.metrics=e.metrics||[{type:"count",id:"1"}],e.bucketAggs=e.bucketAggs||[{type:"date_histogram",id:"2",settings:{interval:"auto"}}],e.timeField=this.timeField;var l={size:0,query:{bool:{filter:[{range:this.getRangeFilter()},{query_string:{analyze_wildcard:!0,query:r}}]}}};if(this.addAdhocFilters(l,t),0===e.bucketAggs.length){if(!(o=e.metrics[0])||"raw_document"!==o.type)throw{message:"Invalid query"};var u=o.settings&&o.settings.size||500;return this.documentQuery(l,u)}for(s=l,i=0;i<e.bucketAggs.length;i++){var g=e.bucketAggs[i],c={};switch(g.type){case"date_histogram":c.date_histogram=this.getDateHistogramAgg(g);break;case"histogram":c.histogram=this.getHistogramAgg(g);break;case"filters":c.filters={filters:this.getFiltersAgg(g)};break;case"terms":this.buildTermsAgg(g,c,e);break;case"geohash_grid":c.geohash_grid={field:g.field,precision:g.settings.precision}}s.aggs=s.aggs||{},s.aggs[g.id]=c,s=c}for(s.aggs={},i=0;i<e.metrics.length;i++)if("count"!==(o=e.metrics[i]).type){var d={},p=null;if(b(o.type))if(k(o.type)){if(!o.pipelineVariables)continue;for(p={buckets_path:{}},n=0;n<o.pipelineVariables.length;n++){if((a=o.pipelineVariables[n]).name&&a.pipelineAgg&&/^\d*$/.test(a.pipelineAgg))(f=S(e.metrics,a.pipelineAgg))&&("count"===f.type?p.buckets_path[a.name]="_count":p.buckets_path[a.name]=a.pipelineAgg)}}else{if(!o.pipelineAgg||!/^\d*$/.test(o.pipelineAgg))continue;var f;(f=S(e.metrics,o.pipelineAgg))&&(p="count"===f.type?{buckets_path:"_count"}:{buckets_path:o.pipelineAgg})}else p={field:o.field};for(var h in o.settings)o.settings.hasOwnProperty(h)&&null!==o.settings[h]&&(p[h]=o.settings[h]);d[o.type]=p,s.aggs[o.id]=d}return l},e.prototype.getTermsQuery=function(e){var t={size:0,query:{bool:{filter:[{range:this.getRangeFilter()}]}}};e.query&&t.query.bool.filter.push({query_string:{analyze_wildcard:!0,query:e.query}});var r=500;e.size&&(r=e.size),t.aggs={1:{terms:{field:e.field,size:r,order:{}}}};var i=e.orderBy,n=void 0===i?"key":i,a=e.order,s=void 0===a?"doc_count"===n?"desc":"asc":a;if(["asc","desc"].indexOf(s)<0)throw{message:"Invalid query sort order "+s};switch(n){case"key":case"term":var o=this.esVersion>=60?"_key":"_term";t.aggs[1].terms.order[o]=s;break;case"doc_count":t.aggs[1].terms.order._count=s;break;default:throw{message:"Invalid query sort type "+n}}return t},e.prototype.getLogsQuery=function(e,t){var r={size:0,query:{bool:{filter:[{range:this.getRangeFilter()}]}}};return e.query&&r.query.bool.filter.push({query_string:{analyze_wildcard:!0,query:e.query}}),r=this.documentQuery(r,500),n.a({},r,{aggs:this.build(e,null,t).aggs})},e}(),D=function(e){function t(t,r,i,n,a){var s=e.call(this,t)||this;s.$q=r,s.backendSrv=i,s.templateSrv=n,s.timeSrv=a,s.basicAuth=t.basicAuth,s.withCredentials=t.withCredentials,s.url=t.url,s.name=t.name,s.index=t.database;var o=t.jsonData||{};return s.timeField=o.timeField,s.esVersion=o.esVersion,s.indexPattern=new T(s.index,o.interval),s.interval=o.timeInterval,s.maxConcurrentShardRequests=o.maxConcurrentShardRequests,s.queryBuilder=new M({timeField:s.timeField,esVersion:s.esVersion}),s.logMessageField=o.logMessageField||"",s.logLevelField=o.logLevelField||"",""===s.logMessageField&&(s.logMessageField=null),""===s.logLevelField&&(s.logLevelField=null),s}return t.$inject=["instanceSettings","$q","backendSrv","templateSrv","timeSrv"],n.c(t,e),t.prototype.request=function(e,t,r){var i={url:this.url+"/"+t,method:e,data:r};return(this.basicAuth||this.withCredentials)&&(i.withCredentials=!0),this.basicAuth&&(i.headers={Authorization:this.basicAuth}),this.backendSrv.datasourceRequest(i)},t.prototype.get=function(e){var t=this.timeSrv.timeRange(),r=this.indexPattern.getIndexList(t.from.valueOf(),t.to.valueOf());return l.a.isArray(r)&&r.length?this.request("GET",r[0]+e).then(function(e){return e.data.$$config=e.config,e.data}):this.request("GET",this.indexPattern.getIndexForToday()+e).then(function(e){return e.data.$$config=e.config,e.data})},t.prototype.post=function(e,t){return this.request("POST",e,t).then(function(e){return e.data.$$config=e.config,e.data}).catch(function(e){if(e.data&&e.data.error)throw{message:"Elasticsearch error: "+e.data.error.reason,error:e.data.error};throw e})},t.prototype.annotationQuery=function(e){var t=e.annotation,r=t.timeField||"@timestamp",i=t.query||"*",n=t.tagsField||"tags",a=t.textField||null,o={};o[r]={from:e.range.from.valueOf(),to:e.range.to.valueOf(),format:"epoch_millis"};var u={query:{bool:{filter:[{range:o},{query_string:{query:this.templateSrv.replace(i,{},"lucene")}}]}},size:1e4};this.esVersion<5&&(u.fields=[r,"_source"]);var g={search_type:"query_then_fetch",ignore_unavailable:!0};t.index?g.index=t.index:g.index=this.indexPattern.getIndexList(e.range.from,e.range.to);var c=s.a.toJson(g)+"\n"+s.a.toJson(u)+"\n";return this.post("_msearch",c).then(function(e){for(var i=[],s=e.responses[0].hits.hits,o=function(e,t){if(t){for(var r=t.split("."),i=e,n=0;n<r.length;n++)if(!(i=i[r[n]]))return console.log("could not find field in annotation: ",t),"";return i}},u=0;u<s.length;u++){var g=s[u]._source,c=o(g,r);if(void 0!==s[u].fields){var d=s[u].fields;(l.a.isString(d[r])||l.a.isNumber(d[r]))&&(c=d[r])}var p={annotation:t,time:Object(A.toUtc)(c).valueOf(),text:o(g,a),tags:o(g,n)};if(t.titleField){var f=o(g,t.titleField);f&&(p.text=f+"\n"+p.text)}"string"==typeof p.tags&&(p.tags=p.tags.split(",")),i.push(p)}return i})},t.prototype.testDatasource=function(){var e=this;return this.getFields({type:"date"}).then(function(t){return l.a.find(t,{text:e.timeField})?{status:"success",message:"Index OK. Time field name OK."}:{status:"error",message:"No date field named "+e.timeField+" found"}},function(e){if(console.log(e),e.data&&e.data.error){var t=s.a.toJson(e.data.error);return e.data.error.reason&&(t=e.data.error.reason),{status:"error",message:t}}return{status:"error",message:e.status}})},t.prototype.getQueryHeader=function(e,t,r){var i={search_type:e,ignore_unavailable:!0,index:this.indexPattern.getIndexList(t,r)};return this.esVersion>=56&&this.esVersion<70&&(i.max_concurrent_shard_requests=this.maxConcurrentShardRequests),s.a.toJson(i)},t.prototype.query=function(e){var t,r,i=this,a="",o=l.a.cloneDeep(e.targets),u=[],g=this.templateSrv.getAdhocFilters(this.name);try{for(var c=n.i(o),d=c.next();!d.done;d=c.next()){var p=d.value;if(!p.hide){var f=this.templateSrv.replace(p.query,e.scopedVars,"lucene");f&&""!==f||(f="*");var h=void 0;p.isLogsQuery?(p.bucketAggs=[{type:"date_histogram",id:"2",settings:{interval:"auto"}}],p.metrics=[{type:"count",id:"1"}],h=this.queryBuilder.getLogsQuery(p,f)):(p.alias&&(p.alias=this.templateSrv.replace(p.alias,e.scopedVars,"lucene")),h=this.queryBuilder.build(p,g,f));var m=s.a.toJson(h),v=0===h.size&&this.esVersion<5?"count":"query_then_fetch";a+=this.getQueryHeader(v,e.range.from,e.range.to)+"\n",a+=m+"\n",u.push(p)}}}catch(e){t={error:e}}finally{try{d&&!d.done&&(r=c.return)&&r.call(c)}finally{if(t)throw t.error}}if(0===u.length)return Promise.resolve({data:[]});a=(a=a.replace(/\$timeFrom/g,e.range.from.valueOf().toString())).replace(/\$timeTo/g,e.range.to.valueOf().toString()),a=this.templateSrv.replace(a,e.scopedVars);var y=this.getMultiSearchUrl();return this.post(y,a).then(function(e){var t=new O(u,e);return u.some(function(e){return e.isLogsQuery})?t.getLogs(i.logMessageField,i.logLevelField):t.getTimeSeries()})},t.prototype.getFields=function(e){var t=this.esVersion;return this.get("/_mapping").then(function(r){var i={float:"number",double:"number",integer:"number",long:"number",date:"date",string:"string",text:"string",scaled_float:"number",nested:"nested"};function n(e,t,r){return"_"!==t[0]&&(!r.type||(r.type===e.type||r.type===i[e.type]))}var a=[],s={};function o(t){for(var r in t){var i=t[r];if(l.a.isObject(i.properties)&&(a.push(r),o(i.properties)),l.a.isObject(i.fields)&&(a.push(r),o(i.fields)),l.a.isString(i.type)){var u=a.concat(r).join(".");n(i,r,e)&&(s[u]={text:u,type:i.type})}}a.pop()}for(var u in r){var g=r[u];if(g&&g.mappings){var c=g.mappings;if(t<70)for(var d in c){o(c[d].properties)}else o(c.properties)}}return l.a.map(s,function(e){return e})})},t.prototype.getTerms=function(e){var t=this.timeSrv.timeRange(),r=this.esVersion>=5?"query_then_fetch":"count",i=this.getQueryHeader(r,t.from,t.to),n=s.a.toJson(this.queryBuilder.getTermsQuery(e));n=i+"\n"+(n=(n=n.replace(/\$timeFrom/g,t.from.valueOf().toString())).replace(/\$timeTo/g,t.to.valueOf().toString()))+"\n";var a=this.getMultiSearchUrl();return this.post(a,n).then(function(e){if(!e.responses[0].aggregations)return[];var t=e.responses[0].aggregations[1].buckets;return l.a.map(t,function(e){return{text:e.key_as_string||e.key,value:e.key}})})},t.prototype.getMultiSearchUrl=function(){return this.esVersion>=70&&this.maxConcurrentShardRequests?"_msearch?max_concurrent_shard_requests="+this.maxConcurrentShardRequests:"_msearch"},t.prototype.metricFindQuery=function(e){return(e=s.a.fromJson(e))?"fields"===e.find?(e.field=this.templateSrv.replace(e.field,{},"lucene"),this.getFields(e)):"terms"===e.find?(e.field=this.templateSrv.replace(e.field,{},"lucene"),e.query=this.templateSrv.replace(e.query||"*",{},"lucene"),this.getTerms(e)):void 0:this.$q.when([])},t.prototype.getTagKeys=function(){return this.getFields({})},t.prototype.getTagValues=function(e){return this.getTerms({field:e.key,query:"*"})},t.prototype.targetContainsTemplate=function(e){var t,r,i,a;if(this.templateSrv.variableExists(e.query)||this.templateSrv.variableExists(e.alias))return!0;try{for(var s=n.i(e.bucketAggs),o=s.next();!o.done;o=s.next()){var l=o.value;if(this.templateSrv.variableExists(l.field)||this.objectContainsTemplate(l.settings))return!0}}catch(e){t={error:e}}finally{try{o&&!o.done&&(r=s.return)&&r.call(s)}finally{if(t)throw t.error}}try{for(var u=n.i(e.metrics),g=u.next();!g.done;g=u.next()){var c=g.value;if(this.templateSrv.variableExists(c.field)||this.objectContainsTemplate(c.settings)||this.objectContainsTemplate(c.meta))return!0}}catch(e){i={error:e}}finally{try{g&&!g.done&&(a=u.return)&&a.call(u)}finally{if(i)throw i.error}}return!1},t.prototype.isPrimitive=function(e){return null==e||!!["string","number","boolean"].some(function(e){return e===typeof!0})},t.prototype.objectContainsTemplate=function(e){var t,r,i,a;if(!e)return!1;try{for(var s=n.i(Object.keys(e)),o=s.next();!o.done;o=s.next()){var l=o.value;if(this.isPrimitive(e[l])){if(this.templateSrv.variableExists(e[l]))return!0}else if(Array.isArray(e[l]))try{for(var u=(i=void 0,n.i(e[l])),g=u.next();!g.done;g=u.next()){var c=g.value;if(this.objectContainsTemplate(c))return!0}}catch(e){i={error:e}}finally{try{g&&!g.done&&(a=u.return)&&a.call(u)}finally{if(i)throw i.error}}else if(this.objectContainsTemplate(e[l]))return!0}}catch(e){t={error:e}}finally{try{o&&!o.done&&(r=s.return)&&r.call(s)}finally{if(t)throw t.error}}return!1},t}(i.DataSourceApi);var V=r("txxJ"),E=function(){function e(e,t,r,i){var n=e.target.bucketAggs;e.orderByOptions=[],e.getBucketAggTypes=function(){return c},e.getOrderOptions=function(){return p},e.getSizeOptions=function(){return f},i.onAppEvent("elastic-query-updated",function(){e.validateModel()},e),e.init=function(){e.agg=n[e.index],e.validateModel()},e.onChangeInternal=function(){e.onChange()},e.onTypeChanged=function(){switch(e.agg.settings={},e.showOptions=!1,e.agg.type){case"date_histogram":case"histogram":case"terms":delete e.agg.query,e.agg.field="select field";break;case"filters":delete e.agg.field,e.agg.query="*";break;case"geohash_grid":e.agg.settings.precision=3}e.validateModel(),e.onChange()},e.validateModel=function(){e.index=l.a.indexOf(n,e.agg),e.isFirst=0===e.index,e.bucketAggCount=n.length;var t,r="",i=e.agg.settings||{};switch(e.agg.type){case"terms":i.order=i.order||"desc",i.size=i.size||"10",i.min_doc_count=i.min_doc_count||1,i.orderBy=i.orderBy||"_term","0"!==i.size&&(t=i.order,r=l.a.find(p,{value:t}).text+" "+i.size+", "),i.min_doc_count>0&&(r+="Min Doc Count: "+i.min_doc_count+", "),r+="Order by: "+function(e,t){var r=l.a.find(d,{value:e});if(r)return r.text;var i=l.a.find(t.metrics,{id:e});return i?F(i):"metric not found"}(i.orderBy,e.target),"0"===i.size&&(r+=" ("+i.order+")");break;case"filters":i.filters=i.filters||[{query:"*"}],(r=l.a.reduce(i.filters,function(e,t,r){return e+="Q"+(r+1)+"  = "+t.query+" "},"")).length>50&&(r=r.substr(0,50)+"..."),r="Filter Queries ("+i.filters.length+")";break;case"date_histogram":i.interval=i.interval||"auto",i.min_doc_count=i.min_doc_count||0,e.agg.field=e.target.timeField,r="Interval: "+i.interval,i.min_doc_count>0&&(r+=", Min Doc Count: "+i.min_doc_count),(void 0===i.trimEdges||i.trimEdges<0)&&(i.trimEdges=0),i.trimEdges&&i.trimEdges>0&&(r+=", Trim edges: "+i.trimEdges);break;case"histogram":i.interval=i.interval||1e3,i.min_doc_count=l.a.defaultTo(i.min_doc_count,1),r="Interval: "+i.interval,i.min_doc_count>0&&(r+=", Min Doc Count: "+i.min_doc_count);break;case"geohash_grid":i.precision=Math.max(Math.min(i.precision,7),1),r="Precision: "+i.precision}return e.settingsLinkText=r,e.agg.settings=i,!0},e.addFiltersQuery=function(){e.agg.settings.filters.push({query:"*"})},e.removeFiltersQuery=function(t){e.agg.settings.filters=l.a.without(e.agg.settings.filters,t)},e.toggleOptions=function(){e.showOptions=!e.showOptions},e.getOrderByOptions=function(){return t=e.target,r=[],l.a.each(t.metrics,function(e){"count"!==e.type&&r.push({text:F(e),value:e.id})}),d.concat(r);var t,r},e.getFieldsInternal=function(){return"date_histogram"===e.agg.type?e.getFields({$fieldType:"date"}):e.getFields()},e.getIntervalOptions=function(){return r.when(t.transformToSegments(!0,"interval")(m))},e.addBucketAgg=function(){var t=n[n.length-1],r=n.length-1;t&&"date_histogram"===t.type&&(r-=1);var i=l.a.reduce(e.target.bucketAggs.concat(e.target.metrics),function(e,t){return parseInt(t.id,10)>e?parseInt(t.id,10):e},0);n.splice(r,0,{type:"terms",field:"select field",id:(i+1).toString(),fake:!0}),e.onChange()},e.removeBucketAgg=function(){n.splice(e.index,1),e.onChange()},e.init()}return e.$inject=["$scope","uiSegmentSrv","$q","$rootScope"],e}();V.c.directive("elasticBucketAgg",function(){return{templateUrl:"public/app/plugins/datasource/elasticsearch/partials/bucket_agg.html",controller:E,restrict:"E",scope:{target:"=",index:"=",onChange:"&",getFields:"&"}}});var $=function(){function e(e,t,r,i){var n=e.target.metrics;e.metricAggTypes=_(e.esVersion),e.extendedStats=h,e.pipelineAggOptions=[],e.modelSettingsValues={},e.init=function(){e.agg=n[e.index],e.validateModel(),e.updatePipelineAggOptions()},e.updatePipelineAggOptions=function(){var t,r;e.pipelineAggOptions=(t=e.target,r=[],l.a.each(t.metrics,function(e){b(e.type)||r.push({text:F(e),value:e.id})}),r)},i.onAppEvent("elastic-query-updated",function(){e.index=l.a.indexOf(n,e.agg),e.updatePipelineAggOptions(),e.validateModel()},e),e.validateModel=function(){if(e.isFirst=0===e.index,e.isSingle=1===n.length,e.settingsLinkText="",e.variablesLinkText="",e.aggDef=l.a.find(e.metricAggTypes,{value:e.agg.type}),b(e.agg.type)){k(e.agg.type)?(e.variablesLinkText="Options",e.agg.settings.script&&(e.variablesLinkText="Script: "+e.agg.settings.script.replace(new RegExp("params.","g"),""))):(e.agg.pipelineAgg=e.agg.pipelineAgg||"select metric",e.agg.field=e.agg.pipelineAgg);var t=b((r=e.agg).type)?y[r.type]:[];t.length>0&&(l.a.each(t,function(t){e.agg.settings[t.text]=e.agg.settings[t.text]||t.default}),e.settingsLinkText="Options")}else e.agg.field||(e.agg.field="select field");var r;switch(e.agg.type){case"cardinality":var i=e.agg.settings.precision_threshold||"";e.settingsLinkText="Precision threshold: "+i;break;case"percentiles":e.agg.settings.percents=e.agg.settings.percents||[25,50,75,95,99],e.settingsLinkText="Values: "+e.agg.settings.percents.join(",");break;case"extended_stats":0===l.a.keys(e.agg.meta).length&&(e.agg.meta.std_deviation_bounds_lower=!0,e.agg.meta.std_deviation_bounds_upper=!0);var a=l.a.reduce(e.agg.meta,function(t,r,i){if(r){var n=l.a.find(e.extendedStats,{value:i});t.push(n.text)}return t},[]);e.settingsLinkText="Stats: "+a.join(", ");break;case"moving_avg":e.movingAvgModelTypes=v,e.modelSettings=q(e.agg.settings.model,!0),e.updateMovingAvgModelSettings();break;case"raw_document":e.agg.settings.size=e.agg.settings.size||500,e.settingsLinkText="Size: "+e.agg.settings.size,e.target.metrics.splice(0,e.target.metrics.length,e.agg),e.target.bucketAggs=[]}if(e.aggDef.supportsInlineScript){var s=e.agg.inlineScript;s?e.agg.settings.script={inline:s}:delete e.agg.settings.script,""===e.settingsLinkText&&(e.settingsLinkText="Options")}},e.toggleOptions=function(){e.showOptions=!e.showOptions,e.updatePipelineAggOptions()},e.toggleVariables=function(){e.showVariables=!e.showVariables},e.onChangeInternal=function(){e.onChange()},e.updateMovingAvgModelSettings=function(){for(var t=[],r=q(e.agg.settings.model,!1),i=0;i<r.length;i++)t.push(r[i].value);for(var n in e.agg.settings.settings)null!==e.agg.settings.settings[n]&&-1!==t.indexOf(n)||delete e.agg.settings.settings[n]},e.onChangeClearInternal=function(){delete e.agg.settings.minimize,e.onChange()},e.onTypeChange=function(){e.agg.settings={},e.agg.meta={},e.showOptions=!1,0===e.target.bucketAggs.length&&"raw_document"!==e.agg.type&&(e.target.bucketAggs=[{type:"date_histogram",id:"2",settings:{interval:"auto"}}]),e.showVariables=k(e.agg.type),e.updatePipelineAggOptions(),e.onChange()},e.getFieldsInternal=function(){return"cardinality"===e.agg.type?e.getFields():e.getFields({$fieldType:"number"})},e.addMetricAgg=function(){var t=n.length,r=l.a.reduce(e.target.bucketAggs.concat(e.target.metrics),function(e,t){return parseInt(t.id,10)>e?parseInt(t.id,10):e},0);n.splice(t,0,{type:"count",field:"select field",id:(r+1).toString()}),e.onChange()},e.removeMetricAgg=function(){n.splice(e.index,1),e.onChange()},e.toggleShowMetric=function(){e.agg.hide=!e.agg.hide,e.agg.hide||delete e.agg.hide,e.onChange()},e.init()}return e.$inject=["$scope","uiSegmentSrv","$q","$rootScope"],e}();V.c.directive("elasticMetricAgg",function(){return{templateUrl:"public/app/plugins/datasource/elasticsearch/partials/metric_agg.html",controller:$,restrict:"E",scope:{target:"=",index:"=",onChange:"&",getFields:"&",esVersion:"="}}});var L=function(e){return{name:"var"+e,pipelineAgg:"select metric"}},j=function(){function e(e){e.variables=e.variables||[L(1)],e.onChangeInternal=function(){e.onChange()},e.add=function(){e.variables.push(L(e.variables.length+1)),e.onChange()},e.remove=function(t){e.variables.splice(t,1),e.onChange()}}return e.$inject=["$scope"],e}();V.c.directive("elasticPipelineVariables",function(){return{templateUrl:"public/app/plugins/datasource/elasticsearch/partials/pipeline_variables.html",controller:"ElasticPipelineVariablesCtrl",restrict:"E",scope:{onChange:"&",variables:"=",options:"="}}}),V.c.controller("ElasticPipelineVariablesCtrl",j);var I=function(e){function t(t,r,i,n){var a=e.call(this,t,r)||this;if(a.$rootScope=i,a.uiSegmentSrv=n,a.esVersion=a.datasource.esVersion,a.target=a.target||{},a.target.metrics=a.target.metrics||[{type:"count",id:"1"}],a.target.bucketAggs=a.target.bucketAggs||[{type:"date_histogram",id:"2",settings:{interval:"auto"}}],0===a.target.bucketAggs.length){var s=a.target.metrics[0];s&&"raw_document"===s.type||(a.target.bucketAggs=[{type:"date_histogram",id:"2",settings:{interval:"auto"}}]),a.refresh()}return a.queryUpdated(),a}return t.$inject=["$scope","$injector","$rootScope","uiSegmentSrv"],n.c(t,e),t.prototype.getFields=function(e){var t=s.a.toJson({find:"fields",type:e});return this.datasource.metricFindQuery(t).then(this.uiSegmentSrv.transformToSegments(!1)).catch(this.handleQueryError.bind(this))},t.prototype.queryUpdated=function(){var e=s.a.toJson(this.datasource.queryBuilder.build(this.target),!0);this.rawQueryOld&&e!==this.rawQueryOld&&this.refresh(),this.rawQueryOld=e,this.$rootScope.appEvent("elastic-query-updated")},t.prototype.getCollapsedText=function(){var e=this.target.metrics,t=this.target.bucketAggs,r=_(this.esVersion),i=c,n="";return this.target.query&&(n+="Query: "+this.target.query+", "),n+="Metrics: ",l.a.each(e,function(e,t){var i=l.a.find(r,{value:e.type});n+=i.text+"(",i.requiresField&&(n+=e.field),i.supportsMultipleBucketPaths&&(n+=e.settings.script.replace(new RegExp("params.","g"),"")),n+="), "}),l.a.each(t,function(e,t){0===t&&(n+=" Group by: ");var r=l.a.find(i,{value:e.type});n+=r.text+"(",r.requiresField&&(n+=e.field),n+="), "}),this.target.alias&&(n+="Alias: "+this.target.alias),n},t.prototype.handleQueryError=function(e){return this.error=e.message||"Failed to issue metric query",[]},t.templateUrl="partials/query.editor.html",t}(r("LzXI").QueryCtrl),Q=function(){function e(e){this.indexPatternTypes=[{name:"No pattern",value:void 0},{name:"Hourly",value:"Hourly",example:"[logstash-]YYYY.MM.DD.HH"},{name:"Daily",value:"Daily",example:"[logstash-]YYYY.MM.DD"},{name:"Weekly",value:"Weekly",example:"[logstash-]GGGG.WW"},{name:"Monthly",value:"Monthly",example:"[logstash-]YYYY.MM"},{name:"Yearly",value:"Yearly",example:"[logstash-]YYYY"}],this.esVersions=[{name:"2.x",value:2},{name:"5.x",value:5},{name:"5.6+",value:56},{name:"6.0+",value:60},{name:"7.0+",value:70}],this.current.jsonData.timeField=this.current.jsonData.timeField||"@timestamp",this.current.jsonData.esVersion=this.current.jsonData.esVersion||5;var t=this.current.jsonData.esVersion>=70?5:256;this.current.jsonData.maxConcurrentShardRequests=this.current.jsonData.maxConcurrentShardRequests||t,this.current.jsonData.logMessageField=this.current.jsonData.logMessageField||"",this.current.jsonData.logLevelField=this.current.jsonData.logLevelField||""}return e.$inject=["$scope"],e.prototype.indexPatternTypeChanged=function(){if(!this.current.database||0===this.current.database.length||this.current.database.startsWith("[logstash-]")){var e=l.a.find(this.indexPatternTypes,{value:this.current.jsonData.interval});this.current.database=e.example||"es-index-name"}},e.prototype.versionChanged=function(){this.current.jsonData.maxConcurrentShardRequests=function(e){if(5===e.maxConcurrentShardRequests&&e.esVersion<70)return 256;if(256===e.maxConcurrentShardRequests&&e.esVersion>=70)return 5;var t=e.esVersion>=70?5:256;return e.maxConcurrentShardRequests||t}(this.current.jsonData)},e.templateUrl="public/app/plugins/datasource/elasticsearch/partials/config.html",e}(),P=r("q1tI"),z=r.n(P),B=r("Y1OJ"),R=function(e){function t(t,r){var a=e.call(this,t,r)||this;return a.onChangeQuery=function(e,t){var r=a.props,i=r.query,s=r.onChange,o=r.onRunQuery;s&&(s(n.a({},i,{query:e,isLogsQuery:!0})),t&&o&&o())},a.plugins=[Object(i.SlatePrism)({onlyIn:function(e){return"code_block"===e.type},getSyntax:function(e){return"lucene"}})],a.state={syntaxLoaded:!1},a}return n.c(t,e),t.prototype.componentDidMount=function(){this.props.query.isLogsQuery||this.onChangeQuery("",!0)},t.prototype.componentWillUnmount=function(){},t.prototype.componentDidUpdate=function(e){this.props.query.isLogsQuery||this.onChangeQuery("",!0)},t.prototype.render=function(){var e=this.props,t=e.queryResponse,r=e.query,i=this.state.syntaxLoaded;return z.a.createElement(z.a.Fragment,null,z.a.createElement("div",{className:"gf-form-inline gf-form-inline--nowrap"},z.a.createElement("div",{className:"gf-form gf-form--grow flex-shrink-1"},z.a.createElement(B.a,{additionalPlugins:this.plugins,initialQuery:r.query,onChange:this.onChangeQuery,onRunQuery:this.props.onRunQuery,placeholder:"Enter a Lucene query",portalOrigin:"elasticsearch",syntaxLoaded:i}))),t&&t.error?z.a.createElement("div",{className:"prom-query-field-info text-error"},t.error.message):null)},t}(z.a.PureComponent);r.d(t,"plugin",function(){return U});var H=function(){function e(){}return e.templateUrl="partials/annotations.editor.html",e}(),U=new i.DataSourcePlugin(D).setQueryCtrl(I).setConfigCtrl(Q).setExploreLogsQueryField(R).setAnnotationQueryCtrl(H)}}]);
//# sourceMappingURL=elasticsearchPlugin.3932bda029d2299a9d96.js.map