"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[7680],{18673:(e,a,r)=>{r.r(a),r.d(a,{default:()=>Q});var n,t=r(68404),s=r(40256),l=r(36636),i=r(18745),o=r(3490),c=r(82498),d=r(1698),u=r(33899),g=r(83809),m=r(19462),h=r(8455),x=r(50489),p=r(45916);function f(){var e;const a=(0,i.useDispatch)(),r=(0,d.k)("notification"),[s,l]=(0,c.k)(r),[f,j]=(0,t.useState)(!1),{loading:y}=(0,u._)((e=>e.deleteAMConfig)),{loading:A}=(0,u._)((e=>e.saveAMConfig)),b=!!s&&(0,m.RY)(s),C=(0,o.useStyles2)(v),S=(0,u._)((e=>e.amConfigs)),{result:N,loading:$,error:I}=s&&S[s]||h.oq;(0,t.useEffect)((()=>{s&&a((0,g.Yh)(s))}),[s,a]);const w=()=>{s&&a((0,g.Nc)(s)),j(!1)},k=(0,t.useMemo)((()=>({configJSON:N?JSON.stringify(N,null,2):""})),[N]),T=y||$||A;return(0,p.jsxs)("div",{className:C.container,children:[(0,p.jsx)(x.P,{current:s,onChange:l,dataSources:r}),I&&!T&&(0,p.jsx)(o.Alert,{severity:"error",title:"Error loading Alertmanager configuration",children:I.message||"Unknown error."}),y&&s!==m.GC&&(n||(n=(0,p.jsx)(o.Alert,{severity:"info",title:"Resetting Alertmanager configuration",children:"It might take a while..."}))),s&&N&&(0,p.jsx)(o.Form,{defaultValues:k,onSubmit:e=>{s&&N&&a((0,g.mM)({newConfig:JSON.parse(e.configJSON),oldConfig:N,alertManagerSourceName:s,successMessage:"Alertmanager configuration updated.",refetch:!0}))},children:a=>{var r;let{register:n,errors:t}=a;return(0,p.jsxs)(p.Fragment,{children:[!b&&(0,p.jsx)(o.Field,{disabled:T,label:"Configuration",invalid:!!t.configJSON,error:null===(r=t.configJSON)||void 0===r?void 0:r.message,children:(0,p.jsx)(o.TextArea,Object.assign({},n("configJSON",{required:{value:!0,message:"Required."},validate:e=>{try{return JSON.parse(e),!0}catch(e){return e instanceof Error?e.message:"Invalid JSON."}}}),{id:"configuration",rows:25}))}),b&&(0,p.jsx)(o.Field,{label:"Configuration",children:(0,p.jsx)("pre",{"data-testid":"readonly-config",children:k.configJSON})}),!b&&(0,p.jsxs)(o.HorizontalGroup,{children:[e||(e=(0,p.jsx)(o.Button,{type:"submit",variant:"primary",disabled:T,children:"Save"})),(0,p.jsx)(o.Button,{type:"button",disabled:T,variant:"destructive",onClick:()=>j(!0),children:"Reset configuration"})]}),!!f&&(0,p.jsx)(o.ConfirmModal,{isOpen:!0,title:"Reset Alertmanager configuration",body:`Are you sure you want to reset configuration ${s===m.GC?"for the Grafana Alertmanager":`for "${s}"`}? Contact points and notification policies will be reset to their defaults.`,confirmText:"Yes, reset configuration",onConfirm:w,onDismiss:()=>j(!1)})]})}},k.configJSON)]})}const v=e=>({container:l.css`
    margin-bottom: ${e.spacing(4)};
  `});var j=r(28436),y=r(4643),A=r(10331),b=r(82897);const C=/\/api\/v[1|2]\/alerts/i;function S(){const e=(0,m.aM)().filter((e=>e.jsonData.handleGrafanaManagedAlerts)),a=(0,i.useSelector)((e=>(0,b.keyBy)(e.dataSources.dataSources.filter((e=>"alertmanager"===e.type)),(e=>e.uid)))),r=(0,u._)((e=>{var a;return null===(a=e.externalAlertmanagers.discoveredAlertmanagers.result)||void 0===a?void 0:a.data})),n=(0,b.countBy)(null==r?void 0:r.droppedAlertManagers,(e=>e.url)),t=(0,b.countBy)(null==r?void 0:r.activeAlertManagers,(e=>e.url));return e.map((e=>{var r,s;const l=a[e.uid];if(!l)return{dataSource:e,status:"pending"};const i=function(e){if(!new RegExp("^[^:]*://").test(e.url))return`http://${e.url}`;return e.url}(l),o=`${i}/api/v2/alerts`,c=null!==(r=n[o])&&void 0!==r?r:0,d=null!==(s=t[o])&&void 0!==s?s:0,u=c+d>1,g=c>0?"dropped":d>0?"active":"pending";return{dataSource:e,url:l.url,status:g,statusInconclusive:u}}))}var N,$;const I=e=>{let{alertmanagers:a,onChangeAlertmanagerConfig:r,onClose:n}=e;const s=(0,o.useStyles2)(w),l=(0,t.useMemo)((()=>({alertmanagers:a})),[a]),i=(0,p.jsxs)("div",{className:s.modalTitle,children:[(0,p.jsx)(o.Icon,{name:"bell",className:s.modalIcon}),N||(N=(0,p.jsx)("h3",{children:"Add Alertmanager"}))]}),c=e=>{r(e.alertmanagers.map((e=>e.url.replace(/\/$/,"").replace(/\/api\/v[1|2]\/alerts/i,"")))),n()};return(0,p.jsxs)(o.Modal,{title:i,isOpen:!0,onDismiss:n,className:s.modal,children:[(0,p.jsx)("div",{className:s.description,children:"We use a service discovery method to find existing Alertmanagers for a given URL."}),(0,p.jsx)(o.Form,{onSubmit:c,defaultValues:l,children:e=>{let{register:a,control:r,errors:n}=e;return(0,p.jsxs)("div",{children:[(0,p.jsx)(o.FieldArray,{control:r,name:"alertmanagers",children:e=>{let{fields:r,append:t,remove:l}=e;return(0,p.jsxs)("div",{className:s.fieldArray,children:[(0,p.jsx)("div",{className:s.bold,children:"Source url"}),(0,p.jsx)("div",{className:s.muted,children:"Authentication can be done via URL (e.g. user:password@myalertmanager.com) and only the Alertmanager v2 API is supported. The suffix is added internally, there is no need to specify it."}),r.map(((e,r)=>{var t;return(0,p.jsx)(o.Field,{invalid:!(null==n||null===(t=n.alertmanagers)||void 0===t||!t[r]),error:"Field is required",children:(0,p.jsx)(o.Input,Object.assign({className:s.input,defaultValue:e.url},a(`alertmanagers.${r}.url`,{required:!0}),{placeholder:"http://localhost:9093",addonAfter:(0,p.jsx)(o.Button,{"aria-label":"Remove alertmanager",type:"button",onClick:()=>l(r),variant:"destructive",className:s.destroyInputRow,children:$||($=(0,p.jsx)(o.Icon,{name:"trash-alt"}))})}))},`${e.id}-${r}`)})),(0,p.jsx)(o.Button,{type:"button",variant:"secondary",onClick:()=>t({url:""}),children:"Add URL"})]})}}),(0,p.jsx)("div",{children:(0,p.jsx)(o.Button,{type:"submit",onSubmit:()=>c,children:"Add Alertmanagers"})})]})}})]})};const w=e=>{const a=l.css`
    color: ${e.colors.text.secondary};
  `;return{description:(0,l.cx)(l.css`
        margin-bottom: ${e.spacing(2)};
      `,a),muted:a,bold:l.css`
      font-weight: ${e.typography.fontWeightBold};
    `,modal:l.css``,modalIcon:(0,l.cx)(a,l.css`
        margin-right: ${e.spacing(1)};
      `),modalTitle:l.css`
      display: flex;
    `,input:l.css`
      margin-bottom: ${e.spacing(1)};
      margin-right: ${e.spacing(1)};
    `,inputRow:l.css`
      display: flex;
    `,destroyInputRow:l.css`
      padding: ${e.spacing(1)};
    `,fieldArray:l.css`
      margin-bottom: ${e.spacing(4)};
    `}};var k,T,G,R,E,M=r(39357);function O(e){let{alertmanagers:a,inactive:r}=e;const n=(0,o.useStyles2)(U);return(0,p.jsxs)(p.Fragment,{children:[k||(k=(0,p.jsx)("h5",{children:"Alertmanagers data sources"})),(0,p.jsxs)("div",{className:n.muted,children:["Alertmanager data sources support a configuration setting that allows you to choose to send Grafana-managed alerts to that Alertmanager. ",T||(T=(0,p.jsx)("br",{})),"Below, you can see the list of all Alertmanager data sources that have this setting enabled."]}),0===a.length&&(0,p.jsx)(o.CallToActionCard,{message:G||(G=(0,p.jsxs)("div",{children:["There are no Alertmanager data sources configured to receive Grafana-managed alerts. ",(0,p.jsx)("br",{}),"You can change this by selecting Receive Grafana Alerts in a data source configuration."]})),callToActionElement:R||(R=(0,p.jsx)(o.LinkButton,{href:"/datasources",children:"Go to data sources"})),className:n.externalDsCTA}),a.length>0&&(0,p.jsx)("div",{className:n.externalDs,children:a.map((e=>(0,p.jsx)(B,{alertmanager:e,inactive:r},e.dataSource.uid)))})]})}function B(e){let{alertmanager:a,inactive:r}=e;const n=(0,o.useStyles2)(U),{dataSource:t,status:s,statusInconclusive:l,url:i}=a;return(0,p.jsxs)(o.Card,{children:[(0,p.jsxs)(o.Card.Heading,{className:n.externalHeading,children:[t.name," ",l&&(0,p.jsx)(o.Tooltip,{content:"Multiple Alertmangers have the same URL configured. The state might be inconclusive.",children:(0,p.jsx)(o.Icon,{name:"exclamation-triangle",size:"md",className:n.externalWarningIcon})})]}),(0,p.jsx)(o.Card.Figure,{children:(0,p.jsx)("img",{src:"public/app/plugins/datasource/alertmanager/img/logo.svg",alt:"",height:"40px",width:"40px",style:{objectFit:"contain"}})}),(0,p.jsx)(o.Card.Tags,{children:r?E||(E=(0,p.jsx)(o.Badge,{text:"Inactive",color:"red",tooltip:"Grafana is configured to send alerts to the built-in internal Alertmanager only. External Alertmanagers do not receive any alerts."})):(0,p.jsx)(o.Badge,{text:(0,b.capitalize)(s),color:"dropped"===s?"red":"active"===s?"green":"orange"})}),(0,p.jsx)(o.Card.Meta,{children:i}),(0,p.jsx)(o.Card.Actions,{children:(0,p.jsx)(o.LinkButton,{href:(0,M.__)(t),size:"sm",variant:"secondary",children:"Go to datasouce"})})]})}const U=e=>({muted:l.css`
    color: ${e.colors.text.secondary};
  `,externalHeading:l.css`
    justify-content: flex-start;
  `,externalWarningIcon:l.css`
    margin: ${e.spacing(0,1)};
    fill: ${e.colors.warning.main};
  `,externalDs:l.css`
    display: grid;
    gap: ${e.spacing(1)};
    padding: ${e.spacing(2,0)};
  `,externalDsCTA:l.css`
    margin: ${e.spacing(2,0)};
  `});var F,J,D,L,z,Y,_,q,H;const Z=[{value:A.TE.Internal,label:"Only Internal"},{value:A.TE.External,label:"Only External"},{value:A.TE.All,label:"Both internal and external"}],W=()=>{var e;const a=(0,o.useStyles2)(V),r=(0,i.useDispatch)(),[n,s]=(0,t.useState)({open:!1,payload:[{url:""}]}),[c,d]=(0,t.useState)({open:!1,index:0}),u=function(){const e=(0,i.useSelector)((e=>{var a;return null===(a=e.unifiedAlerting.externalAlertmanagers.discoveredAlertmanagers.result)||void 0===a?void 0:a.data})),a=(0,i.useSelector)((e=>{var a;return null===(a=e.unifiedAlerting.externalAlertmanagers.alertmanagerConfig.result)||void 0===a?void 0:a.alertmanagers}));if(!e||!a)return[];const r=[],n=e.droppedAlertManagers.map((e=>({url:e.url.replace(C,""),status:"dropped",actualUrl:e.url})));for(const n of a)if(0===e.activeAlertManagers.length)r.push({url:n,status:"pending",actualUrl:""});else{const a=e.activeAlertManagers.find((e=>e.url===`${n}/api/v2/alerts`));a?r.push({url:a.url.replace(C,""),status:"active",actualUrl:a.url}):r.push({url:n,status:"pending",actualUrl:""})}return[...r,...n]}(),m=S(),h=(0,i.useSelector)((e=>{var a;return null===(a=e.unifiedAlerting.externalAlertmanagers.alertmanagerConfig.result)||void 0===a?void 0:a.alertmanagersChoice})),x=(0,o.useTheme2)();(0,t.useEffect)((()=>{r((0,g.zy)()),r((0,g.wE)()),r((0,y.bZ)());const e=setInterval((()=>r((0,g.zy)())),5e3);return()=>{clearInterval(e)}}),[r]);const f=(0,t.useCallback)((e=>{const a=(null!=u?u:[]).filter(((a,r)=>r!==e)).map((e=>e.url));r((0,g.sx)({alertmanagers:a,alertmanagersChoice:null!=h?h:A.TE.All})),d({open:!1,index:0})}),[u,r,h]),v=(0,t.useCallback)((()=>{const e=u?[...u]:[{url:""}];s((a=>Object.assign({},a,{open:!0,payload:e})))}),[s,u]),b=(0,t.useCallback)((()=>{s((e=>{const a=u?[...u,{url:""}]:[{url:""}];return Object.assign({},e,{open:!0,payload:a})}))}),[u]),N=(0,t.useCallback)((()=>{s((e=>Object.assign({},e,{open:!1})))}),[s]),$=e=>{switch(e){case"active":return x.colors.success.main;case"pending":return x.colors.warning.main;default:return x.colors.error.main}},w=0===(null==u?void 0:u.length),k=0===(null==m?void 0:m.length),T=!(w&&k);return(0,p.jsxs)("div",{children:[F||(F=(0,p.jsx)("h4",{children:"External Alertmanagers"})),J||(J=(0,p.jsxs)(o.Alert,{title:"External Alertmanager changes",severity:"info",children:["The way you configure external Alertmanagers has changed.",(0,p.jsx)("br",{}),"You can now use configured Alertmanager data sources as receivers of your Grafana-managed alerts.",(0,p.jsx)("br",{}),"For more information, refer to our documentation."]})),(0,p.jsx)(O,{alertmanagers:m,inactive:h===A.TE.Internal}),T&&(0,p.jsx)("div",{className:a.amChoice,children:(0,p.jsx)(o.Field,{label:"Send alerts to",description:"Configures how the Grafana alert rule evaluation engine Alertmanager handles your alerts. Internal (Grafana built-in Alertmanager), External (All Alertmanagers configured above), or both.",children:(0,p.jsx)(o.RadioButtonGroup,{options:Z,value:h,onChange:e=>(e=>{r((0,g.sx)({alertmanagers:u.map((e=>e.url)),alertmanagersChoice:e}))})(e)})})}),D||(D=(0,p.jsx)("h5",{children:"Alertmanagers by URL"})),L||(L=(0,p.jsxs)(o.Alert,{severity:"warning",title:"Deprecation Notice",children:["The URL-based configuration of Alertmanagers is deprecated and will be removed in Grafana 9.2.0.",(0,p.jsx)("br",{}),"Use Alertmanager data sources to configure your external Alertmanagers."]})),(0,p.jsx)("div",{className:a.muted,children:"You can have your Grafana managed alerts be delivered to one or many external Alertmanager(s) in addition to the internal Alertmanager by specifying their URLs below."}),(0,p.jsx)("div",{className:a.actions,children:!w&&(0,p.jsx)(o.Button,{type:"button",onClick:b,children:"Add Alertmanager"})}),w?(0,p.jsx)(j.Z,{title:"You have not added any external alertmanagers",onClick:b,buttonTitle:"Add Alertmanager",buttonIcon:"bell-slash"}):(0,p.jsx)(p.Fragment,{children:(0,p.jsxs)("table",{className:(0,l.cx)("filter-table form-inline filter-table--hover",a.table),children:[(0,p.jsx)("thead",{children:(0,p.jsxs)("tr",{children:[z||(z=(0,p.jsx)("th",{children:"Url"})),Y||(Y=(0,p.jsx)("th",{children:"Status"})),(0,p.jsx)("th",{style:{width:"2%"},children:"Action"})]})}),(0,p.jsx)("tbody",{children:null==u?void 0:u.map(((r,n)=>(0,p.jsxs)("tr",{children:[(0,p.jsxs)("td",{children:[(0,p.jsx)("span",{className:a.url,children:r.url}),r.actualUrl?(0,p.jsx)(o.Tooltip,{content:`Discovered ${r.actualUrl} from ${r.url}`,theme:"info",children:_||(_=(0,p.jsx)(o.Icon,{name:"info-circle"}))}):null]}),(0,p.jsx)("td",{children:(0,p.jsx)(o.Icon,{name:"heart",style:{color:$(r.status)},title:r.status})}),(0,p.jsx)("td",{children:(0,p.jsxs)(o.HorizontalGroup,{children:[e||(e=(0,p.jsx)(o.Button,{variant:"secondary",type:"button",onClick:v,"aria-label":"Edit alertmanager",children:q||(q=(0,p.jsx)(o.Icon,{name:"pen"}))})),(0,p.jsx)(o.Button,{variant:"destructive","aria-label":"Remove alertmanager",type:"button",onClick:()=>d({open:!0,index:n}),children:H||(H=(0,p.jsx)(o.Icon,{name:"trash-alt"}))})]})})]},n)))})]})}),(0,p.jsx)(o.ConfirmModal,{isOpen:c.open,title:"Remove Alertmanager",body:"Are you sure you want to remove this Alertmanager",confirmText:"Remove",onConfirm:()=>f(c.index),onDismiss:()=>d({open:!1,index:0})}),n.open&&(0,p.jsx)(I,{onClose:N,alertmanagers:n.payload,onChangeAlertmanagerConfig:e=>{r((0,g.sx)({alertmanagers:e,alertmanagersChoice:null!=h?h:A.TE.All}))}})]})},V=e=>({url:l.css`
    margin-right: ${e.spacing(1)};
  `,muted:l.css`
    color: ${e.colors.text.secondary};
  `,actions:l.css`
    margin-top: ${e.spacing(2)};
    display: flex;
    justify-content: flex-end;
  `,table:l.css`
    margin-bottom: ${e.spacing(2)};
  `,amChoice:l.css`
    margin-bottom: ${e.spacing(4)};
  `});var P,K;function Q(){const e=(0,d.k)("notification"),[a]=(0,c.k)(e),r=a===m.GC;return(0,p.jsxs)(s.J,{pageId:"alerting-admin",children:[P||(P=(0,p.jsx)(f,{"test-id":"admin-alertmanagerconfig"})),r&&(K||(K=(0,p.jsx)(W,{"test-id":"admin-externalalertmanagers"})))]})}},40256:(e,a,r)=>{r.d(a,{J:()=>i});r(68404);var n=r(18745),t=r(69371),s=r(8674),l=r(45916);const i=e=>{let{children:a,pageId:r,isLoading:i}=e;const o=(0,s.h)((0,n.useSelector)((e=>e.navIndex)),r);return(0,l.jsx)(t.T,{navModel:o,children:(0,l.jsx)(t.T.Contents,{isLoading:i,children:a})})}},82498:(e,a,r)=>{r.d(a,{k:()=>o});var n=r(68404),t=r(26011),s=r(17421),l=r(85464),i=r(19462);function o(e){const[a,r]=(0,t.K)(),o=function(e){return(0,n.useCallback)((a=>e.map((e=>e.name)).includes(a)),[e])}(e),c=(0,n.useCallback)((e=>{o(e)&&(e===i.GC?(s.Z.delete(l.de),r({[l.c4]:null})):(s.Z.set(l.de,e),r({[l.c4]:e})))}),[r,o]),d=a[l.c4];if(d&&"string"==typeof d)return o(d)?[d,c]:[void 0,c];const u=s.Z.get(l.de);return u&&"string"==typeof u&&o(u)?(c(u),[u,c]):o(i.GC)?[i.GC,c]:[void 0,c]}},1698:(e,a,r)=>{r.d(a,{k:()=>s});var n=r(68404),t=r(19462);function s(e){return(0,n.useMemo)((()=>(0,t.LE)(e)),[e])}}}]);
//# sourceMappingURL=AlertingAdmin.11fc716e24f84cc0be07.js.map