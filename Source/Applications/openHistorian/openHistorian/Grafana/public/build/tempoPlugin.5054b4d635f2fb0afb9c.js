"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[4156],{86396:(e,a,t)=>{t.r(a),t.d(a,{plugin:()=>Te});var r,n=t(43215),i=t(68404),s=t(45916);var o=t(36636),l=t(66049),u=t(90923),c=t(3490),d=t(11410),p=t(50539),h=t.n(p),g=t(36537),v=t(58257),m=t(56340);function f(e,a,t){return a in e?Object.defineProperty(e,a,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[a]=t,e}class y extends n.LanguageProvider{constructor(e,a){var t;super(),t=this,f(this,"datasource",void 0),f(this,"tags",void 0),f(this,"request",(async function(e){let a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const r=await t.datasource.metadataRequest(e,a);return null==r?void 0:r.data})),f(this,"start",(async()=>(await this.fetchTags(),[]))),f(this,"provideCompletionItems",(async function(e){let{prefix:a,text:r,value:n,labelKey:i,wrapperClasses:s}=e;const o={suggestions:[]};if(!n)return o;const l=n.endText.getText(),u="="===l[l.indexOf(r)-1];return u||"="===r?t.getTagValueCompletionItems(n):t.getTagsCompletionItems()})),f(this,"getTagsCompletionItems",(()=>{const{tags:e}=this,a=[];return null!=e&&e.length&&a.push({label:"Tag",items:e.map((e=>({label:e})))}),{suggestions:a}})),this.datasource=e,Object.assign(this,a)}async fetchTags(){const e=await this.request("/api/search/tags",[]);this.tags=e.tagNames}async getTagValueCompletionItems(e){var a;const t=e.endText.getText().split(" ");let r=null!==(a=t[t.length-1])&&void 0!==a?a:"";r=r.split("=")[0];const n=await this.request(`/api/search/tag/${r}/values`,[]),i=[];return n&&n.tagValues&&i.push({label:"Tag Values",items:n.tagValues.map((e=>({label:e})))}),{suggestions:i}}async getOptions(e){const a=await this.request(`/api/search/tag/${e}/values`);let t=[];return a&&a.tagValues&&(t=a.tagValues.map((e=>({value:e,label:e})))),t}}const x="tempo",b="e.g. 1.2s, 100ms",j=[(0,c.BracesPlugin)(),(0,c.SlatePrism)({onlyIn:e=>"block"===e.object&&"code_block"===e.type,getSyntax:()=>x})];h().languages.tempo={key:{pattern:/[^\s]+(?==)/,alias:"attr-name"},operator:/[=]/,value:[{pattern:/"(.+)"/},{pattern:/[^\s]+/}]};const D=e=>{let{datasource:a,query:t,onChange:r,onBlur:o,onRunQuery:l}=e;const d=(0,c.useStyles2)(S),p=(0,i.useMemo)((()=>new y(a)),[a]),[h,f]=(0,i.useState)(!1),[x,D]=(0,i.useState)(),[T,_]=(0,i.useState)(),[w,k]=(0,i.useState)(null),[O,I]=(0,i.useState)({}),[N,q]=(0,i.useState)({serviceName:!1,spanName:!1}),C=(0,i.useCallback)((async function(e){let a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";const t="serviceName"===e?"service.name":"name";q((a=>Object.assign({},a,{[e]:!0})));try{const r=await p.getOptions(t);return r.filter((e=>!!e.value&&(0,c.fuzzyMatch)(e.value,a).found))}catch(e){return(0,u.isFetchError)(e)&&404===(null==e?void 0:e.status)?k(e):e instanceof Error&&(0,m.WI)((0,g.$l)((0,v.t_)("Error",e))),[]}finally{q((a=>Object.assign({},a,{[e]:!1})))}}),[p]);(0,i.useEffect)((()=>{(async()=>{try{const[e,a]=await Promise.all([C("serviceName"),C("spanName")]);t.serviceName&&(0,u.getTemplateSrv)().containsTemplate(t.serviceName)&&e.push((0,n.toOption)(t.serviceName)),D(e),t.spanName&&(0,u.getTemplateSrv)().containsTemplate(t.spanName)&&a.push((0,n.toOption)(t.spanName)),_(a)}catch(e){(0,u.isFetchError)(e)&&404===(null==e?void 0:e.status)?k(e):e instanceof Error&&(0,m.WI)((0,g.$l)((0,v.t_)("Error",e)))}})()}),[p,C,t.serviceName,t.spanName]),(0,i.useEffect)((()=>{(async()=>{try{await p.start(),f(!0)}catch(e){e instanceof Error&&(0,m.WI)((0,g.$l)((0,v.t_)("Error",e)))}})()}),[p]);const $=e=>{"Enter"===e.key&&(e.shiftKey||e.ctrlKey)&&l()},Q=(0,u.getTemplateSrv)();return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("div",{className:d.container,children:[(0,s.jsx)(c.InlineFieldRow,{children:(0,s.jsx)(c.InlineField,{label:"Service Name",labelWidth:14,grow:!0,children:(0,s.jsx)(c.Select,{inputId:"service",options:x,onOpenMenu:()=>{C("serviceName")},isLoading:N.serviceName,value:(null==x?void 0:x.find((e=>(null==e?void 0:e.value)===t.serviceName)))||void 0,onChange:e=>{r(Object.assign({},t,{serviceName:(null==e?void 0:e.value)||void 0}))},placeholder:"Select a service",isClearable:!0,onKeyDown:$,"aria-label":"select-service-name",allowCustomValue:!0})})}),(0,s.jsx)(c.InlineFieldRow,{children:(0,s.jsx)(c.InlineField,{label:"Span Name",labelWidth:14,grow:!0,children:(0,s.jsx)(c.Select,{inputId:"spanName",options:T,onOpenMenu:()=>{C("spanName")},isLoading:N.spanName,value:(null==T?void 0:T.find((e=>(null==e?void 0:e.value)===t.spanName)))||void 0,onChange:e=>{r(Object.assign({},t,{spanName:(null==e?void 0:e.value)||void 0}))},placeholder:"Select a span",isClearable:!0,onKeyDown:$,"aria-label":"select-span-name",allowCustomValue:!0})})}),(0,s.jsx)(c.InlineFieldRow,{children:(0,s.jsx)(c.InlineField,{label:"Tags",labelWidth:14,grow:!0,tooltip:"Values should be in the logfmt format.",children:(0,s.jsx)(c.QueryField,{additionalPlugins:j,query:t.search,onTypeahead:async e=>await p.provideCompletionItems(e),onBlur:o,onChange:e=>{r(Object.assign({},t,{search:e}))},placeholder:"http.status_code=200 error=true",cleanText:e=>{const a=e.split(/\s+(?=([^"]*"[^"]*")*[^"]*$)/g);return a.length>1?a[a.length-1]:e},onRunQuery:l,syntaxLoaded:h,portalOrigin:"tempo"})})}),(0,s.jsx)(c.InlineFieldRow,{children:(0,s.jsx)(c.InlineField,{label:"Min Duration",invalid:!!O.minDuration,labelWidth:14,grow:!0,children:(0,s.jsx)(c.Input,{id:"minDuration",value:t.minDuration||"",placeholder:b,onBlur:()=>{var e;const a=Q.replace(null!==(e=t.minDuration)&&void 0!==e?e:"");t.minDuration&&!(0,n.isValidGoDuration)(a)?I(Object.assign({},O,{minDuration:!0})):I(Object.assign({},O,{minDuration:!1}))},onChange:e=>r(Object.assign({},t,{minDuration:e.currentTarget.value})),onKeyDown:$})})}),(0,s.jsx)(c.InlineFieldRow,{children:(0,s.jsx)(c.InlineField,{label:"Max Duration",invalid:!!O.maxDuration,labelWidth:14,grow:!0,children:(0,s.jsx)(c.Input,{id:"maxDuration",value:t.maxDuration||"",placeholder:b,onBlur:()=>{var e;const a=Q.replace(null!==(e=t.maxDuration)&&void 0!==e?e:"");t.maxDuration&&!(0,n.isValidGoDuration)(a)?I(Object.assign({},O,{maxDuration:!0})):I(Object.assign({},O,{maxDuration:!1}))},onChange:e=>r(Object.assign({},t,{maxDuration:e.currentTarget.value})),onKeyDown:$})})}),(0,s.jsx)(c.InlineFieldRow,{children:(0,s.jsx)(c.InlineField,{label:"Limit",invalid:!!O.limit,labelWidth:14,grow:!0,tooltip:"Maximum numbers of returned results",children:(0,s.jsx)(c.Input,{id:"limit",value:t.limit||"",type:"number",onChange:e=>{let a=e.currentTarget.value?parseInt(e.currentTarget.value,10):void 0;a&&(!Number.isInteger(a)||a<=0)?I(Object.assign({},O,{limit:!0})):I(Object.assign({},O,{limit:!1})),r(Object.assign({},t,{limit:e.currentTarget.value?parseInt(e.currentTarget.value,10):void 0}))},onKeyDown:$})})})]}),w?(0,s.jsxs)(c.Alert,{title:"Unable to connect to Tempo search",severity:"info",className:d.alert,children:["Please ensure that Tempo is configured with search enabled. If you would like to hide this tab, you can configure it in the ",(0,s.jsx)("a",{href:`/datasources/edit/${a.uid}`,children:"datasource settings"}),"."]}):null]})},S=e=>({container:o.css`
    max-width: 500px;
  `,alert:o.css`
    max-width: 75ch;
    margin-top: ${e.spacing(2)};
  `});var T,_,w,k=t(34366);async function O(e){if(!e)return;const a=(0,u.getDataSourceSrv)();try{return await a.get(e)}catch(e){return void console.error("Failed to load data source",e)}}function I(e){let{graphDatasourceUid:a,query:t,onChange:r}=e;const n=(0,c.useStyles2)(q),o=(0,l.Z)((()=>O(a)),[a]),[d,p]=(0,i.useState)(void 0);if((0,i.useEffect)((()=>{!o.loading&&o.value&&async function(e){const a=await e.getTagKeys({series:["traces_service_graph_request_server_seconds_sum","traces_service_graph_request_total","traces_service_graph_request_failed_total"]});p(Boolean(a.length))}(o.value)}),[o]),o.loading)return null;const h=o.value;if(!a)return T||(T=(0,s.jsx)("div",{className:"text-warning",children:"Please set up a service graph datasource in the datasource settings."}));if(a&&!h)return _||(_=(0,s.jsx)("div",{className:"text-warning",children:"Service graph datasource is configured but the data source no longer exists. Please configure existing data source to use the service graph functionality."}));const g=function(e){let a,t=[];const r=/([\w_]+)(=|!=|<|>|=~|!~)"(.*?)"/g;for(;null!==(a=r.exec(e));)t.push({key:a[1],operator:a[2],value:a[3],condition:""});return t}(t.serviceMapQuery||"");return(0,s.jsxs)("div",{children:[(0,s.jsx)(c.InlineFieldRow,{children:(0,s.jsx)(c.InlineField,{label:"Filter",labelWidth:14,grow:!0,children:(0,s.jsx)(k.F,{datasource:{uid:a},filters:g,getTagKeysOptions:{series:u.config.featureToggles.tempoApmTable?["traces_service_graph_request_total","traces_spanmetrics_calls_total"]:["traces_service_graph_request_total"]},addFilter:e=>{r(Object.assign({},t,{serviceMapQuery:N([...g,e])}))},removeFilter:e=>{const a=[...g];a.splice(e,1),r(Object.assign({},t,{serviceMapQuery:N(a)}))},changeFilter:(e,a)=>{const n=[...g];n.splice(e,1,a),r(Object.assign({},t,{serviceMapQuery:N(n)}))}})})}),!1===d?(0,s.jsxs)(c.Alert,{title:"No service graph data found",severity:"info",className:n.alert,children:["Please ensure that service graph metrics are set up correctly according to the"," ",w||(w=(0,s.jsx)("a",{target:"_blank",rel:"noreferrer noopener",href:"https://grafana.com/docs/tempo/next/grafana-agent/service-graphs/",children:"Tempo documentation"})),"."]}):null]})}function N(e){return`{${e.map((e=>`${e.key}${e.operator}"${e.value}"`)).join(",")}}`}const q=e=>({alert:o.css`
    max-width: 75ch;
    margin-top: ${e.spacing(2)};
  `});var C,$;function Q(e,a,t){return a in e?Object.defineProperty(e,a,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[a]=t,e}class F extends i.PureComponent{constructor(e){super(e),Q(this,"onChangeLinkedQuery",(e=>{const{query:a,onChange:t}=this.props;t(Object.assign({},a,{linkedQuery:Object.assign({},e,{refId:"linked"})}))})),Q(this,"onRunLinkedQuery",(()=>{this.props.onRunQuery()})),Q(this,"onClearResults",(()=>{const{onChange:e,query:a,onRunQuery:t}=this.props;e(Object.assign({},a,{queryType:"clear"})),t()}))}async componentDidMount(){this.props.query.queryType||this.props.onChange(Object.assign({},this.props.query,{queryType:"traceId"}))}render(){var e,a;const{query:t,onChange:r,datasource:n,app:i}=this.props,l=n.getLokiSearchDS(),d=null===(e=n.serviceMap)||void 0===e?void 0:e.datasourceUid,p=[{value:"traceId",label:"TraceID"},{value:"upload",label:"JSON file"},{value:"serviceMap",label:"Service Graph"}];var h;(null!=n&&null!==(a=n.search)&&void 0!==a&&a.hide||p.unshift({value:"nativeSearch",label:"Search"}),l)&&(null!=n&&null!==(h=n.search)&&void 0!==h&&h.hide?p.unshift({value:"search",label:"Search"}):p.push({value:"search",label:"Loki Search"}));return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(c.InlineFieldRow,{children:(0,s.jsx)(c.InlineField,{label:"Query type",children:(0,s.jsx)(c.RadioButtonGroup,{options:p,value:t.queryType,onChange:e=>{var a;(0,u.reportInteraction)("grafana_traces_query_type_changed",{datasourceType:"tempo",app:null!=i?i:"",newQueryType:e,previousQueryType:null!==(a=t.queryType)&&void 0!==a?a:""}),this.onClearResults(),r(Object.assign({},t,{queryType:e}))},size:"md"})})}),"search"===t.queryType&&(0,s.jsx)(R,{logsDatasourceUid:l,query:t,onRunQuery:this.onRunLinkedQuery,onChange:this.onChangeLinkedQuery}),"nativeSearch"===t.queryType&&(0,s.jsx)(D,{datasource:this.props.datasource,query:t,onChange:r,onBlur:this.props.onBlur,onRunQuery:this.props.onRunQuery}),"upload"===t.queryType&&(0,s.jsx)("div",{className:(0,o.css)({padding:this.props.theme.spacing(2)}),children:(0,s.jsx)(c.FileDropzone,{options:{multiple:!1},onLoad:e=>{this.props.datasource.uploadedJson=e,this.props.onRunQuery()}})}),"traceId"===t.queryType&&(0,s.jsx)(c.InlineFieldRow,{children:(0,s.jsx)(c.InlineField,{label:"Trace ID",labelWidth:14,grow:!0,children:(0,s.jsx)(c.QueryField,{query:t.query,onChange:e=>{r(Object.assign({},t,{query:e,queryType:"traceId",linkedQuery:void 0}))},onBlur:this.props.onBlur,onRunQuery:this.props.onRunQuery,placeholder:"Enter a Trace ID (run with Shift+Enter)",portalOrigin:"tempo"})})}),"serviceMap"===t.queryType&&(0,s.jsx)(I,{graphDatasourceUid:d,query:t,onChange:r})]})}}function R(e){let{logsDatasourceUid:a,onChange:t,onRunQuery:r,query:n}=e;const i=(0,l.Z)((()=>O(a)),[a]);if(i.loading)return null;const o=i.value;var u;return o?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(c.InlineLabel,{children:["Tempo uses ",o.name," to find traces."]}),(0,s.jsx)(d.n,{datasource:o,onChange:t,onRunQuery:r,query:null!==(u=n.linkedQuery)&&void 0!==u?u:{refId:"linked"},history:[]})]}):a?a&&!o?$||($=(0,s.jsx)("div",{className:"text-warning",children:"Loki search datasource is configured but the data source no longer exists. Please configure existing data source to use the search."})):null:C||(C=(0,s.jsx)("div",{className:"text-warning",children:"Please set up a Loki search datasource in the datasource settings."}))}const L=(0,c.withTheme2)(F);var M,U=t(11723),P=t(28239),E=t(4319),B=t(67211);function V(e){var a,t,r,i;let{options:l,onOptionsChange:d}=e;const p=(0,c.useStyles)(G),h=!1!==(null===(a=l.jsonData.tracesToLogs)||void 0===a?void 0:a.lokiSearch)?null===(t=l.jsonData.tracesToLogs)||void 0===t?void 0:t.datasourceUid:void 0;return h&&void 0===l.jsonData.lokiSearch&&(0,n.updateDatasourcePluginJsonDataOption)({onOptionsChange:d,options:l},"lokiSearch",{datasourceUid:h}),(0,s.jsxs)("div",{className:(0,o.css)({width:"100%"}),children:[M||(M=(0,s.jsx)("h3",{className:"page-heading",children:"Loki Search"})),(0,s.jsx)("div",{className:p.infoText,children:"Select a Loki datasource to search for traces. Derived fields must be configured in the Loki data source."}),(0,s.jsxs)(c.InlineFieldRow,{className:p.row,children:[(0,s.jsx)(c.InlineField,{tooltip:"The Loki data source with the service graph data",label:"Data source",labelWidth:26,children:(0,s.jsx)(u.DataSourcePicker,{inputId:"loki-search-data-source-picker",pluginId:"loki",current:null===(r=l.jsonData.lokiSearch)||void 0===r?void 0:r.datasourceUid,noDefault:!0,width:40,onChange:e=>(0,n.updateDatasourcePluginJsonDataOption)({onOptionsChange:d,options:l},"lokiSearch",{datasourceUid:e.uid})})}),null!==(i=l.jsonData.lokiSearch)&&void 0!==i&&i.datasourceUid?(0,s.jsx)(c.Button,{type:"button",variant:"secondary",size:"sm",fill:"text",onClick:()=>{(0,n.updateDatasourcePluginJsonDataOption)({onOptionsChange:d,options:l},"lokiSearch",{datasourceUid:void 0})},children:"Clear"}):null]})]})}const G=e=>({infoText:o.css`
    label: infoText;
    padding-bottom: ${e.spacing.md};
    color: ${e.colors.textSemiWeak};
  `,row:o.css`
    label: row;
    align-items: baseline;
  `});var W;function J(e){var a;let{options:t,onOptionsChange:r}=e;const i=(0,c.useStyles)(A);return(0,s.jsxs)("div",{className:i.container,children:[W||(W=(0,s.jsx)("h3",{className:"page-heading",children:"Search"})),(0,s.jsx)(c.InlineFieldRow,{className:i.row,children:(0,s.jsx)(c.InlineField,{tooltip:"Removes the Search tab from the Tempo query editor.",label:"Hide search",labelWidth:26,children:(0,s.jsx)(c.InlineSwitch,{id:"hideSearch",value:null===(a=t.jsonData.search)||void 0===a?void 0:a.hide,onChange:e=>(0,n.updateDatasourcePluginJsonDataOption)({onOptionsChange:r,options:t},"search",Object.assign({},t.jsonData.search,{hide:e.currentTarget.checked}))})})})]})}const A=e=>({container:o.css`
    label: container;
    width: 100%;
  `,row:o.css`
    label: row;
    align-items: baseline;
  `});var K;function z(e){var a,t;let{options:r,onOptionsChange:i}=e;const l=(0,c.useStyles)(H);return(0,s.jsxs)("div",{className:(0,o.css)({width:"100%"}),children:[K||(K=(0,s.jsx)("h3",{className:"page-heading",children:"Service Graph"})),(0,s.jsx)("div",{className:l.infoText,children:"To allow querying service graph data you have to select a Prometheus instance where the data is stored."}),(0,s.jsxs)(c.InlineFieldRow,{className:l.row,children:[(0,s.jsx)(c.InlineField,{tooltip:"The Prometheus data source with the service graph data",label:"Data source",labelWidth:26,children:(0,s.jsx)(u.DataSourcePicker,{inputId:"service-graph-data-source-picker",pluginId:"prometheus",current:null===(a=r.jsonData.serviceMap)||void 0===a?void 0:a.datasourceUid,noDefault:!0,width:40,onChange:e=>(0,n.updateDatasourcePluginJsonDataOption)({onOptionsChange:i,options:r},"serviceMap",{datasourceUid:e.uid})})}),null!==(t=r.jsonData.serviceMap)&&void 0!==t&&t.datasourceUid?(0,s.jsx)(c.Button,{type:"button",variant:"secondary",size:"sm",fill:"text",onClick:()=>{(0,n.updateDatasourcePluginJsonDataOption)({onOptionsChange:i,options:r},"serviceMap",{datasourceUid:void 0})},children:"Clear"}):null]})]})}const H=e=>({infoText:o.css`
    label: infoText;
    padding-bottom: ${e.spacing.md};
    color: ${e.colors.textSemiWeak};
  `,row:o.css`
    label: row;
    align-items: baseline;
  `});var Z=t(82897),Y=t(71808),X=t(94396),ee=t(86558),ae=t(3321),te=t(54119),re=t(71114),ne=t(35778),ie=t(14444),se=t(76747),oe=t(48762),le=t(25857),ue=t(67436),ce=t(59465),de=t(68876);function pe(e,a,t){return a in e?Object.defineProperty(e,a,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[a]=t,e}class he extends u.DataSourceWithBackend{constructor(e){let a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,u.getTemplateSrv)();super(e),pe(this,"tracesToLogs",void 0),pe(this,"serviceMap",void 0),pe(this,"search",void 0),pe(this,"nodeGraph",void 0),pe(this,"lokiSearch",void 0),pe(this,"uploadedJson",null),pe(this,"spanBar",void 0),pe(this,"getLokiSearchDS",(()=>{var e,a,t,r;const n=!1!==(null===(e=this.tracesToLogs)||void 0===e?void 0:e.lokiSearch)&&void 0===this.lokiSearch?null===(a=this.tracesToLogs)||void 0===a?void 0:a.datasourceUid:void 0;return null!==(t=null===(r=this.lokiSearch)||void 0===r?void 0:r.datasourceUid)&&void 0!==t?t:n})),this.instanceSettings=e,this.templateSrv=a,this.tracesToLogs=e.jsonData.tracesToLogs,this.serviceMap=e.jsonData.serviceMap,this.search=e.jsonData.search,this.nodeGraph=e.jsonData.nodeGraph,this.lokiSearch=e.jsonData.lokiSearch}query(e){var a,t,r,i,s,o;const l=[],c=e.targets.filter((e=>!e.hide)),d=(0,Z.groupBy)(c,(e=>e.queryType||"traceId"));if(d.clear)return(0,Y.of)({data:[],state:n.LoadingState.Done});const p=this.getLokiSearchDS();if(p&&(null===(a=d.search)||void 0===a?void 0:a.length)>0){var h,g,v;(0,u.reportInteraction)("grafana_traces_loki_search_queried",{datasourceType:"tempo",app:null!==(h=e.app)&&void 0!==h?h:"",linkedQueryExpr:null!==(g=null===(v=d.search[0].linkedQuery)||void 0===v?void 0:v.expr)&&void 0!==g?g:""});const a=(0,ue.ak)();l.push((0,X.D)(a.get(p)).pipe((0,re.z)((a=>{var t;const r=Object.assign({},e,{targets:d.search.map((e=>e.linkedQuery))}),n=(null===(t=a.instanceSettings.jsonData.derivedFields)||void 0===t?void 0:t.filter((e=>e.datasourceUid===this.uid&&e.matcherRegex)).map((e=>e.matcherRegex)))||[];return n&&0!==n.length?a.query(r).pipe((0,ne.U)((e=>e.error?e:(0,de.RY)(e,this.uid,this.name,n)))):(0,ee._)((()=>new Error("No Loki datasource configured for search. Set up Derived Fields for traces in a Loki datasource settings and link it to this Tempo datasource.")))}))))}if(null!==(t=d.nativeSearch)&&void 0!==t&&t.length)try{var m,f,y,x,b;(0,u.reportInteraction)("grafana_traces_search_queried",{datasourceType:"tempo",app:null!==(m=e.app)&&void 0!==m?m:"",serviceName:null!==(f=d.nativeSearch[0].serviceName)&&void 0!==f?f:"",spanName:null!==(y=d.nativeSearch[0].spanName)&&void 0!==y?y:"",resultLimit:null!==(x=d.nativeSearch[0].limit)&&void 0!==x?x:"",search:null!==(b=d.nativeSearch[0].search)&&void 0!==b?b:""});const a={startTime:e.range.from.unix(),endTime:e.range.to.unix()},t=this.applyVariables(d.nativeSearch[0],e.scopedVars),r=this.buildSearchQuery(t,a);l.push(this._request("/api/search",r).pipe((0,ne.U)((e=>({data:[(0,de.n4)(e.data.traces,this.instanceSettings)]}))),(0,ie.K)((e=>(0,Y.of)({error:{message:e.data.message},data:[]})))))}catch(e){return(0,Y.of)({error:{message:e instanceof Error?e.message:"Unknown error occurred"},data:[]})}if(null!==(r=d.upload)&&void 0!==r&&r.length)if(this.uploadedJson){var j;(0,u.reportInteraction)("grafana_traces_json_file_uploaded",{datasourceType:"tempo",app:null!==(j=e.app)&&void 0!==j?j:""});const a=JSON.parse(this.uploadedJson),t=a.batches,r=Array.isArray(a)&&a.some((e=>{var a;return"nodeGraph"===(null==e||null===(a=e.meta)||void 0===a?void 0:a.preferredVisualisationType)}));var D;if(t)l.push((0,Y.of)((0,de.IM)(a.batches,null===(D=this.nodeGraph)||void 0===D?void 0:D.enabled)));else r?l.push((0,Y.of)({data:a,state:n.LoadingState.Done})):l.push((0,Y.of)({error:{message:"Unable to parse uploaded data."},data:[]}))}else l.push((0,Y.of)({data:[],state:n.LoadingState.Done}));if(null!==(i=this.serviceMap)&&void 0!==i&&i.datasourceUid&&(null===(s=d.serviceMap)||void 0===s?void 0:s.length)>0){var S,T;(0,u.reportInteraction)("grafana_traces_service_graph_queried",{datasourceType:"tempo",app:null!==(S=e.app)&&void 0!==S?S:"",serviceMapQuery:null!==(T=d.serviceMap[0].serviceMapQuery)&&void 0!==T?T:""});const a=this.serviceMap.datasourceUid,t=this.uid;u.config.featureToggles.tempoApmTable?l.push(ve(e,a,t).pipe((0,se.b)((r=>function(e,a,t){const r=xe(e);return r.targets=Se([be(ce.rB,ce.T1,e)]),ge(r,t).pipe((0,oe.q)(),(0,ne.U)((e=>{var t,r;const i=e.find((e=>!!e.error));if(i)throw new Error(i.error.message);return{data:[null!==(t=null===(r=e[0])||void 0===r?void 0:r.data)&&void 0!==t?t:[],a.data[0],a.data[1]],state:n.LoadingState.Done}})))}(e,r,a).pipe((0,se.b)((r=>function(e,a,t,r){var i,s,o;let l=[],u="",c=[];const d=null!==(i=null===(s=a.data[0][0])||void 0===s||null===(o=s.fields[1])||void 0===o?void 0:o.values.toArray())&&void 0!==i?i:[];d.length>0&&(u=be(ce.$C,'span_name=~"'+d.join("|")+'"',e),l.push(u),d.map((a=>{const t=be(ce.vO,'span_name=~"'+a+'"',e);c.push(t),l.push(t)})));const p=xe(e);return p.targets=Se(l),ge(p,t).pipe((0,oe.q)(),(0,ne.U)((i=>{const s=i.find((e=>!!e.error));if(s)throw new Error(s.error.message);const o=function(e,a,t,r,i,s,o){var l,u,c,d;let p={fields:[]};const h=null===(l=a.data[0])||void 0===l?void 0:l.filter((a=>a.refId===be(ce.rB,ce.T1,e))),g=t.data.filter((e=>e.refId===r)),v=t.data.filter((e=>i.includes(e.refId)));h.length>0&&(null===(u=h[0].fields)||void 0===u?void 0:u.length)>2&&(p.fields.push(Object.assign({},h[0].fields[1],{name:"Name",config:{filterable:!1}})),p.fields.push(Object.assign({},h[0].fields[2],{name:"Rate",config:{links:[me("Rate",je(be(ce.rB,'span_name="${__data.fields[0]}"',e)),s,!1)],decimals:2}})),p.fields.push(Object.assign({},h[0].fields[2],{name:" ",labels:null,config:{color:{mode:"continuous-BlPu"},custom:{displayMode:"lcd-gauge"},decimals:3}})));if(g.length>0&&(null===(c=g[0].fields)||void 0===c?void 0:c.length)>2){var m,f,y,x;const a=null!==(m=null===(f=g[0].fields[1])||void 0===f?void 0:f.values.toArray())&&void 0!==m?m:[],t=null!==(y=null===(x=g[0].fields[2])||void 0===x?void 0:x.values.toArray())&&void 0!==y?y:[];let r={};a.map(((e,a)=>{r[e]={value:t[a]}}));const n=De(Object.assign({},h),r);p.fields.push(Object.assign({},g[0].fields[2],{name:"Error Rate",values:n,config:{links:[me("Error Rate",je(be(ce.$C,'span_name="${__data.fields[0]}"',e)),s,!1)],decimals:2}})),p.fields.push(Object.assign({},g[0].fields[2],{name:"  ",values:n,labels:null,config:{color:{mode:"continuous-RdYlGr"},custom:{displayMode:"lcd-gauge"},decimals:3}}))}if(v.length>0&&(null===(d=v[0].fields)||void 0===d?void 0:d.length)>1){let a={};v.map((e=>{var t,r;const n=null!==(t=e.refId)&&void 0!==t&&t.includes('span_name=~"')?'span_name=~"':'span_name="',i=null===(r=e.refId)||void 0===r?void 0:r.split(n)[1].split('"}')[0];a[i]={value:e.fields[1].values.toArray()[0]}})),p.fields.push(Object.assign({},v[0].fields[1],{name:"Duration (p90)",values:De(Object.assign({},h),a),config:{links:[me("Duration",je(be(ce.vO,'span_name="${__data.fields[0]}"',e)),s,!1)],unit:"s"}}))}p.fields.length>0&&p.fields[0].values&&p.fields.push({name:"Links",type:n.FieldType.string,values:p.fields[0].values.map((()=>"Tempo")),config:{links:[ye("Tempo","","${__data.fields[0]}",o)]}});return p}(e,a,i[0],u,c,t,r);return 0===o.fields.length?{data:[a.data[1],a.data[2]],state:n.LoadingState.Done}:{data:[o,a.data[1],a.data[2]],state:n.LoadingState.Done}})))}(e,r,a,t)))))))):l.push(ve(e,a,t))}var _,w;(null===(o=d.traceId)||void 0===o?void 0:o.length)>0&&((0,u.reportInteraction)("grafana_traces_traceID_queried",{datasourceType:"tempo",app:null!==(_=e.app)&&void 0!==_?_:"",query:null!==(w=d.traceId[0].query)&&void 0!==w?w:""}),l.push(this.handleTraceIdQuery(e,d.traceId)));return(0,ae.T)(...l)}applyTemplateVariables(e,a){return this.applyVariables(e,a)}interpolateVariablesInQueries(e,a){return e&&0!==e.length?e.map((e=>Object.assign({},e,{datasource:this.getRef()},this.applyVariables(e,a)))):[]}applyVariables(e,a){var t,r,n,i,s,o;const l=Object.assign({},e);var u,c;e.linkedQuery&&(l.linkedQuery=Object.assign({},e.linkedQuery,{expr:this.templateSrv.replace(null!==(u=null===(c=e.linkedQuery)||void 0===c?void 0:c.expr)&&void 0!==u?u:"",a)}));return Object.assign({},l,{query:this.templateSrv.replace(null!==(t=e.query)&&void 0!==t?t:"",a),serviceName:this.templateSrv.replace(null!==(r=e.serviceName)&&void 0!==r?r:"",a),spanName:this.templateSrv.replace(null!==(n=e.spanName)&&void 0!==n?n:"",a),search:this.templateSrv.replace(null!==(i=e.search)&&void 0!==i?i:"",a),minDuration:this.templateSrv.replace(null!==(s=e.minDuration)&&void 0!==s?s:"",a),maxDuration:this.templateSrv.replace(null!==(o=e.maxDuration)&&void 0!==o?o:"",a)})}handleTraceIdQuery(e,a){const t=a.filter((e=>e.query)).map((e=>Object.assign({},e,{query:e.query.trim()})));if(!t.length)return te.E;const r=Object.assign({},e,{targets:t});return super.query(r).pipe((0,ne.U)((e=>{var a;return e.error?e:(0,de.Jk)(e,null===(a=this.nodeGraph)||void 0===a?void 0:a.enabled)})))}async metadataRequest(e){let a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return await this._request(e,a,{method:"GET",hideFromInspector:!0}).toPromise()}_request(e,a,t){const r=a?(0,le.tW)(a):"",n=`${this.instanceSettings.url}${e}${r.length?`?${r}`:""}`,i=Object.assign({},t,{url:n});return(0,u.getBackendSrv)().fetch(i)}async testDatasource(){const e={headers:{},method:"GET",url:`${this.instanceSettings.url}/api/echo`},a=await(0,u.getBackendSrv)().fetch(e).toPromise();if(null!=a&&a.ok)return{status:"success",message:"Data source is working"}}getQueryDisplayText(e){if("nativeSearch"===e.queryType){let a=[];for(const t of["serviceName","spanName","search","minDuration","maxDuration","limit"])e.hasOwnProperty(t)&&e[t]&&a.push(`${(0,Z.startCase)(t)}: ${e[t]}`);return a.join(", ")}return e.query}buildSearchQuery(e,a){var t;let r=null!==(t=e.search)&&void 0!==t?t:"",i=(0,Z.pick)(e,["minDuration","maxDuration","limit"]);if(i=(0,Z.pickBy)(i,Z.identity),e.serviceName&&(r+=` service.name="${e.serviceName}"`),e.spanName&&(r+=` name="${e.spanName}"`),i.limit||(i.limit=20),i.minDuration){var s;if(i.minDuration=this.templateSrv.replace(null!==(s=i.minDuration)&&void 0!==s?s:""),!(0,n.isValidGoDuration)(i.minDuration))throw new Error("Please enter a valid min duration.");i.minDuration=i.minDuration.replace(/\s/g,"")}if(i.maxDuration){var o;if(i.maxDuration=this.templateSrv.replace(null!==(o=i.maxDuration)&&void 0!==o?o:""),!(0,n.isValidGoDuration)(i.maxDuration))throw new Error("Please enter a valid max duration.");i.maxDuration=i.maxDuration.replace(/\s/g,"")}if(!Number.isInteger(i.limit)||i.limit<=0)throw new Error("Please enter a valid limit.");let l=Object.assign({tags:r},i);return a&&(l.start=a.startTime,l.end=a.endTime),l}async getServiceGraphLabels(){return(await(0,ue.ak)().get(this.serviceMap.datasourceUid)).getTagKeys()}async getServiceGraphLabelValues(e){return(await(0,ue.ak)().get(this.serviceMap.datasourceUid)).getTagValues({key:e})}}function ge(e,a){return(0,X.D)((0,ue.ak)().get(a)).pipe((0,re.z)((a=>a.query(e))))}function ve(e,a,t){return ge(xe(e),a).pipe((0,oe.q)(),(0,ne.U)((r=>{const i=r.find((e=>!!e.error));if(i)throw new Error(i.error.message);const{nodes:s,edges:o}=(0,ce.BC)(r,e.range);return s.fields[0].config=fe(a,t,"__data.fields.id","__data.fields[0]"),o.fields[0].config=fe(a,t,"__data.fields.target","__data.fields.target","__data.fields.source"),{data:[s,o],state:n.LoadingState.Done}})))}function me(e,a,t,r){var n,i;return{url:"",title:e,internal:{query:{expr:a,range:!r,exemplar:!r,instant:r},datasourceUid:t,datasourceName:null!==(n=null===(i=(0,ue.ak)().getDataSourceSettingsByUid(t))||void 0===i?void 0:i.name)&&void 0!==n?n:""}}}function fe(e,a,t,r,n){return n=n?`client="\${${n}}",`:"",{links:[me("Request rate",`sum by (client, server)(rate(${ce.Yt}{${n}server="\${${t}}"}[$__rate_interval]))`,e,!1),me("Request histogram",`histogram_quantile(0.9, sum(rate(${ce.NZ}{${n}server="\${${t}}"}[$__rate_interval])) by (le, client, server))`,e,!1),me("Failed request rate",`sum by (client, server)(rate(${ce.yf}{${n}server="\${${t}}"}[$__rate_interval]))`,e,!1),ye("View traces",`\${${r}}`,"",a)]}}function ye(e,a,t,r){var n,i;let s={queryType:"nativeSearch"};return""!==a&&(s.serviceName=a),""!==t&&(s.spanName=t),{url:"",title:e,internal:{query:s,datasourceUid:r,datasourceName:null!==(n=null===(i=(0,ue.ak)().getDataSourceSettingsByUid(r))||void 0===i?void 0:i.name)&&void 0!==n?n:""}}}function xe(e){return Object.assign({},e,{targets:ce.t3.map((a=>({refId:a,expr:`rate(${a}${e.targets[0].serviceMapQuery||""}[$__range])`,instant:!0})))})}function be(e,a,t){var r,n,i;let s=null!==(r=null===(n=t.targets[0])||void 0===n||null===(i=n.serviceMapQuery)||void 0===i?void 0:i.replace("{","").replace("}",""))&&void 0!==r?r:"";s=s.replace("client","service").replace("server","service");const o=s.includes("span_name")?e.params.concat(s):e.params.concat(s).concat(a).filter((e=>e));return e.expr.replace("{}","{"+o.join(",")+"}")}function je(e){return(e=e.replace("topk(5, ","").replace(" by (span_name))","")).replace("__range","__rate_interval")}function De(e,a){var t,r,n;const i=null!==(t=null===(r=e[0])||void 0===r||null===(n=r.fields[1])||void 0===n?void 0:n.values.toArray())&&void 0!==t?t:[];let s=[];for(let e=0;e<i.length;e++)Object.keys(a).includes(i[e])?s.push(a[i[e]].value):s.push("0");return s}function Se(e){return e.map((e=>({refId:e,expr:e,instant:!0})))}const Te=new n.DataSourcePlugin(he).setQueryEditor(L).setConfigEditor((e=>{let{options:a,onOptionsChange:t}=e;return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(c.DataSourceHttpSettings,{defaultUrl:"http://tempo",dataSourceConfig:a,showAccessOptions:!1,onChange:t}),(0,s.jsx)("div",{className:"gf-form-group",children:(0,s.jsx)(E.Z,{options:a,onOptionsChange:t})}),u.config.featureToggles.traceToMetrics?(0,s.jsx)("div",{className:"gf-form-group",children:(0,s.jsx)(B.F,{options:a,onOptionsChange:t})}):null,(0,s.jsx)("div",{className:"gf-form-group",children:(0,s.jsx)(z,{options:a,onOptionsChange:t})}),(0,s.jsx)("div",{className:"gf-form-group",children:(0,s.jsx)(J,{options:a,onOptionsChange:t})}),(0,s.jsx)("div",{className:"gf-form-group",children:(0,s.jsx)(P.n,{options:a,onOptionsChange:t})}),(0,s.jsx)("div",{className:"gf-form-group",children:(0,s.jsx)(V,{options:a,onOptionsChange:t})}),(0,s.jsx)("div",{className:"gf-form-group",children:(0,s.jsx)(U.e6,{options:a,onOptionsChange:t})})]})})).setQueryEditorHelp((function(){return r||(r=(0,s.jsxs)("div",{children:[(0,s.jsx)("h2",{id:"tempo-cheat-sheet",children:"Tempo Cheat Sheet"}),(0,s.jsx)("p",{children:"Tempo is a trace id lookup store. Enter a trace id in the above field and hit “Run Query” to retrieve your trace. Tempo is generally paired with other datasources such as Loki or Prometheus to find traces."}),(0,s.jsxs)("p",{children:["Here are some"," ",(0,s.jsx)("a",{href:"https://grafana.com/docs/tempo/latest/guides/instrumentation/",target:"blank",children:"instrumentation examples"})," ","to get you started with trace discovery through logs and metrics (exemplars)."]})]}))}))}}]);
//# sourceMappingURL=tempoPlugin.5054b4d635f2fb0afb9c.js.map