"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[3090],{4782:(el,Pe,s)=>{s.r(Pe),s.d(Pe,{plugin:()=>_e});var ie=s(11261),me=s(28240),Fe=s(65158),ye=s(32264),Oe=s(89654),Ae=s(22680),Se=s(41706),P=s(74848),ve=s(96540),Te=s(57875),je=s(97152),we=s(73134),G=s(52622),De=s(79041),Ie=s(40845),Ne=s(23117),$e=s(68268),ge=s(38761),ke=s(95168),de=s(2913),Be=s(22731),Re=s(62567),We=s(86889),Le=s(7874),Ue=s(59965),Me=s(73060),He=s(63577),ze=s(82915),g=(l=>(l.Candles="candles",l.CandlesVolume="candles+volume",l.Volume="volume",l))(g||{}),re=(l=>(l.Candles="candles",l.OHLCBars="ohlcbars",l))(re||{}),B=(l=>(l.CloseClose="close-close",l.OpenClose="open-close",l))(B||{});const pe={down:"red",flat:"gray",up:"green"},K={...{candleStyle:"candles",colorStrategy:"open-close",colors:{down:"red",up:"green",flat:"gray"},fields:{},includeAllFields:!1,mode:"candles+volume"},legend:{displayMode:G.lm.List,showLegend:!0,placement:"bottom",calcs:[]},tooltip:{mode:G.$N.Multi,sort:G.xB.None}},Q={open:{key:"open",name:"Open",defaults:["open","o"],description:"Value at the start of the period"},high:{key:"high",name:"High",defaults:["high","h","max"],description:"Maximum value within the period"},low:{key:"low",name:"Low",defaults:["low","l","min"],description:"Minimum value within the period"},close:{key:"close",name:"Close",defaults:["close","c"],description:"Value at the end of the period"},volume:{key:"volume",name:"Volume",defaults:["volume","v"],description:"Sample count within the period"}};function Ee(l,i,r){const t=(0,He.findField)(l,r[i.key]);if(!t)for(const f of l.fields){const M=(0,me.Ct)(f,l).toLowerCase();if(i.defaults.includes(M)||i.defaults.includes(f.name))return f}return t}function xe(l,i,r,t){if(!l?.length)return null;const f=i.fields??{},M=l.length===1?(0,Me.Yj)(l[0],l[0].fields.findIndex(o=>o.type===ie.PU.time)):(0,Me.Fd)({frames:l});if(!M?.length)return null;const e={aligned:M,frame:M,names:{}},R=(0,ze.B_)([M],r,t);if(!R)return null;const m=e.frame=R[0],W=m.fields.findIndex(o=>o.type===ie.PU.time);if(W<0)return null;const c=new Set;for(const o of Object.values(Q)){const p=Ee(m,o,f);p&&(e[o.key]=p,c.add(p))}if(!e.open&&!e.close&&(e.open=m.fields.find(o=>o.type===ie.PU.number),e.open&&c.add(e.open)),e.open&&!e.close&&!f.close){const o=e.open.values.slice(1);o.push(o[o.length-1]),e.close={...e.open,values:o,name:"Next open",state:void 0},c.add(e.close),m.fields.push(e.close),e.autoOpenClose=!0}if(e.close&&!e.open&&!f.open){const o=e.close.values.slice();o.unshift(o[0]),o.length=m.length,e.open={...e.close,values:o,name:"Previous close",state:void 0},c.add(e.open),m.fields.push(e.open),e.autoOpenClose=!0}!e.high&&!f.high&&(e.high=e.open),!e.low&&!f.low&&(e.low=e.open),i.mode===g.Volume?(e.high&&(e.high!==e.open&&c.delete(e.high),e.high=void 0),e.low&&(e.low!==e.open&&c.delete(e.low),e.low=void 0)):i.mode===g.Candles&&e.volume&&(c.delete(e.volume),e.volume=void 0);for(const o of Object.values(Q)){const p=e[o.key];p&&(e.names[o.key]=(0,me.Ct)(p,e.frame))}const J=m.fields[W],A=[J];i.includeAllFields?A.push(...m.fields.filter(o=>o!==J)):A.push(...c),e.frame={...e.frame,fields:A};for(let o=0;o<e.frame.fields.length;o++){const p=e.frame.fields[o];p.state={...p.state,seriesIndex:o-1,origin:{fieldIndex:o,frameIndex:0}}}return e}var Ke=s(23596);const{alpha:Ce}=Ke.MV;function Qe(l){let{mode:i,candleStyle:r,fields:t,colorStrategy:f,upColor:M,downColor:e,flatColor:R,volumeAlpha:m,flatAsUp:W=!0}=l;const c=i!==g.Volume&&t.high!=null&&t.low!=null,J=c&&r===re.Candles,A=i!==g.Candles&&t.volume!=null;function o(n,V,y,T,I){return n>0?y:n<0?T:I?y:V}let p=0,fe=t.open,ue=t.high,ce=t.low,te=t.close,C=t.volume;return n=>{let V,y,T,I,Y,Z;c&&(T=new Path2D,y=new Path2D,V=new Path2D),A&&(I=new Path2D,Y=new Path2D,Z=new Path2D);let oe=new Path2D,a=n.ctx,S=n.data[p],F=n.data[fe],N=n.data[te],L=c?n.data[ue]:null,ne=c?n.data[ce]:null,X=A?n.data[C]:null,U=C!=null?Math.round(n.valToPos(0,n.series[C].scale,!0)):null,[O,b]=n.series[0].idxs,w=n.data[0],q=F,se=n.bbox.width;if(w.length>1){let d=null;for(let h=0,u=1/0;h<w.length;h++)if(q[h]!==void 0){if(d!=null){let x=Math.abs(w[h]-w[d]);x<u&&(u=x,se=Math.abs(n.valToPos(w[h],"x",!0)-n.valToPos(w[d],"x",!0)))}d=h}}let H=Math.round(.6*se),z=2,j=2;H<=12&&(z=j=1);let D=Math.floor(H/2);for(let d=O;d<=b;d++){let h=Math.round(n.valToPos(S[d],"x",!0)),u=d===O?0:Math.sign(N[d]-N[d-1]),x=Math.sign(N[d]-F[d]);if(A&&Z&&Y&&I){let v=o(f===B.CloseClose?u:x,Z,Y,I,d===O&&B.CloseClose?!1:W),$=Math.round(n.valToPos(X[d],n.series[C].scale,!0));v.rect(h-D,$,H,U-$)}if(c&&T&&y&&V){let v=o(f===B.CloseClose?u:x,T,y,V,d===O&&B.CloseClose?!1:W),$=Math.round(n.valToPos(L[d],n.series[ue].scale,!0)),ae=Math.round(n.valToPos(ne[d],n.series[ce].scale,!0));v.rect(h-Math.floor(z/2),$,z,ae-$);let _=Math.round(n.valToPos(F[d],n.series[fe].scale,!0)),k=Math.round(n.valToPos(N[d],n.series[te].scale,!0));if(J){let ee=Math.min(_,k),he=Math.max(_,k),E=Math.max(1,he-ee);v.rect(h-D,ee,H,E),f===B.CloseClose&&x>=0&&E>j*2&&oe.rect(h-D+j,ee+j,H-j*2,E-j*2)}else v.rect(h-D,_,D,z),v.rect(h,k,D,z)}}a.save(),a.rect(n.bbox.left,n.bbox.top,n.bbox.width,n.bbox.height),a.clip(),A&&Z&&Y&&I&&(a.fillStyle=Ce(M,m),a.fill(Y),a.fillStyle=Ce(e,m),a.fill(I),a.fillStyle=Ce(R,m),a.fill(Z)),c&&T&&y&&V&&(a.fillStyle=M,a.fill(y),a.fillStyle=e,a.fill(V),a.fillStyle=R,a.fill(T),a.globalCompositeOperation="destination-out",a.fill(oe)),a.restore()}}const Ye=({data:l,id:i,timeRange:r,timeZone:t,width:f,height:M,options:e,fieldConfig:R,onChangeTimeRange:m,replaceVariables:W})=>{const{sync:c,eventsScope:J,canAddAnnotations:A,onThresholdsChange:o,canEditThresholds:p,showThresholds:fe,dataLinkPostProcessor:ue,eventBus:ce}=(0,De.d2)(),te=(0,Ie.$j)(),C=(0,ve.useMemo)(()=>xe(l.series,e,te,r),[l.series,e,te,r]),[n,V]=(0,ve.useState)(null),y=c?.()??we.yV.Off,{renderers:T,tweakScale:I,tweakAxis:Y,shouldRenderPrice:Z}=(0,ve.useMemo)(()=>{let a=(u,x)=>u,S=(u,x)=>u,F={renderers:[],tweakScale:a,tweakAxis:S,shouldRenderPrice:!1};if(!C)return F;const N=C.names;if(!Object.keys(N).length)return F;const{mode:L,candleStyle:ne,colorStrategy:X}=e,U={...pe,...e.colors};let{open:O,high:b,low:w,close:q,volume:se}=N;if(O==null||q==null)return F;let H=.5,z=-1,j=!1;if(se!=null&&L!==g.Candles){let u=C.volume;if(u!=null){j=!0;let{fillOpacity:x}=u.config.custom;x&&(H=x/100),L!==g.Volume&&(u.config={...u.config},u.config.unit="short",u.display=(0,Te.J)({field:u,theme:de.$W.theme2}),S=(v,$)=>{if($.name===C.volume?.name){let ae=(_,k)=>{let ee=[],he=_.series[z].max;for(let E=0;E<k.length&&(ee.push(k[E]),!(he&&k[E]>he));E++);return ee};v.space=20,v.filter=ae,v.ticks={...v.ticks,filter:ae}}return v},a=(v,$)=>($.name===C.volume?.name&&(v.range=(ae,_,k)=>[0,k*7]),v))}}let D=L!==g.Volume&&b!=null&&w!=null;if(!D&&!j)return F;let d={},h=[];return D?d={open:O,high:b,low:w,close:q}:h.push(O,q),j&&(d.volume=se,d.open=O,d.close=q),{shouldRenderPrice:D,renderers:[{fieldMap:d,indicesOnly:h,init:(u,x)=>{z=x.volume,u.addHook("drawAxes",Qe({mode:L,fields:x,upColor:de.$W.theme2.visualization.getColorByName(U.up),downColor:de.$W.theme2.visualization.getColorByName(U.down),flatColor:de.$W.theme2.visualization.getColorByName(U.flat),volumeAlpha:H,colorStrategy:X,candleStyle:ne,flatAsUp:!0}))}}],tweakScale:a,tweakAxis:S}},[e,l.structureRev,l.series.length]);if(!C)return(0,P.jsx)(je.a,{panelId:i,fieldConfig:R,data:l,needsTimeField:!0,needsNumberField:!0});if(Z)for(let a in T[0].fieldMap){let S=C[a];S.config={...S.config,custom:{...S.config.custom,hideFrom:{legend:!0,tooltip:!1,viz:!1}}}}const oe=!!A?.();return(0,P.jsx)(ke.Z,{frames:[C.frame],structureRev:l.structureRev,timeRange:r,timeZone:t,width:f,height:M,legend:e.legend,renderers:T,tweakAxis:Y,tweakScale:I,options:e,replaceVariables:W,dataLinkPostProcessor:ue,cursorSync:y,children:(a,S)=>(0,P.jsxs)(P.Fragment,{children:[(0,P.jsx)(Ne.Z,{config:a}),y!==we.yV.Off&&(0,P.jsx)($e.K,{config:a,eventBus:ce,frame:S}),e.tooltip.mode!==G.$N.None&&(0,P.jsx)(ge.xl,{config:a,hoverMode:e.tooltip.mode===G.$N.Single?ge.b3.xOne:ge.b3.xAll,queryZoom:m,clientZoom:!0,syncMode:y,syncScope:J,render:(F,N,L,ne=!1,X,U,O)=>{if(oe&&U!=null){V(U),X();return}const b=()=>{let w=F.posToVal(F.cursor.left,"x");V({from:w,to:w}),X()};return(0,P.jsx)(Be.k,{series:S,dataIdxs:N,seriesIdx:L,mode:O?G.$N.Multi:e.tooltip.mode,sortOrder:e.tooltip.sort,isPinned:ne,annotate:oe?b:void 0,maxHeight:e.tooltip.maxHeight,replaceVariables:W})},maxWidth:e.tooltip.maxWidth}),(0,P.jsx)(Re.W,{annotations:l.annotations??[],config:a,timeZone:t,newRange:n,setNewRange:V}),(0,P.jsx)(Le.U,{config:a,onChangeTimeRange:m}),l.annotations&&(0,P.jsx)(We.z,{config:a,exemplars:l.annotations,timeZone:t}),(p&&o||fe)&&(0,P.jsx)(Ue.p,{config:a,fieldConfig:R,onThresholdsChange:p?o:void 0})]})})};var Ve=s(47070),Ze=s(38824);class Ge{getSuggestionsForData(i){const{dataSummary:r}=i;if(!i.data?.series||!r.hasData||r.timeFieldCount<1||r.numberFieldCount<2||r.numberFieldCount>10)return;const t=xe(i.data.series,K,ye.$.theme2);if(!t||t.open===t.high&&t.open===t.low)return;i.getListAppender({name:"",pluginId:"candlestick",options:{},fieldConfig:{defaults:{custom:{}},overrides:[]}}).append({name:Ze.m.Candlestick,options:K,fieldConfig:{defaults:{},overrides:[]},score:t.autoOpenClose?Ve.nQ.Good:Ve.nQ.Best})}}const Je=[{label:"Candles",value:g.Candles},{label:"Volume",value:g.Volume},{label:"Both",value:g.CandlesVolume}],Xe=[{label:"Candles",value:re.Candles},{label:"OHLC Bars",value:re.OHLCBars}],be=[{label:"Since Open",value:B.OpenClose},{label:"Since Prior Close",value:B.CloseClose}],qe=l=>l.type===ie.PU.number;function le(l,i,r){let t="Auto ";if(r){const f=r[i.key];f?.config?(t+="= "+(0,me.Ct)(f),f===r?.open&&i.key!=="open"&&(t+=` (${i.defaults.join(",")})`)):t+=`(${i.defaults.join(",")})`}l.addFieldNamePicker({path:`fields.${i.key}`,name:i.name,description:i.description,settings:{filter:qe,placeholderText:t}})}const _e=new Fe.m(Ye).useFieldConfig((0,Se.V)(Se.S)).setPanelOptions((l,i)=>{const r=i.options??K,t=xe(i.data,r,ye.$.theme2);l.addRadio({path:"mode",name:"Mode",description:"",defaultValue:K.mode,settings:{options:Je}}).addRadio({path:"candleStyle",name:"Candle style",description:"",defaultValue:K.candleStyle,settings:{options:Xe},showIf:f=>f.mode!==g.Volume}).addRadio({path:"colorStrategy",name:"Color strategy",description:"",defaultValue:K.colorStrategy,settings:{options:be}}).addColorPicker({path:"colors.up",name:"Up color",defaultValue:pe.up}).addColorPicker({path:"colors.down",name:"Down color",defaultValue:pe.down}),le(l,Q.open,t),r.mode!==g.Volume&&(le(l,Q.high,t),le(l,Q.low,t)),le(l,Q.close,t),r.mode!==g.Candles&&le(l,Q.volume,t),l.addRadio({path:"includeAllFields",name:"Additional fields",description:"Use standard timeseries options to configure any fields not mapped above",defaultValue:K.includeAllFields,settings:{options:[{label:"Ignore",value:!1},{label:"Include",value:!0}]}}),Oe.D(l,!1,!0,r),Ae.H(l)}).setDataSupport({annotations:!0,alertStates:!0}).setSuggestionsSupplier(new Ge)}}]);

//# sourceMappingURL=candlestickPanel.4350b704dc0f577f1aed.js.map