"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[7455],{776:(Ie,ie,t)=>{t.d(ie,{B:()=>de});var e=t(74848),y=t(96540),D=t(39601),oe=t(42418),q=t(82843),M=t(93667),_=t(21607),N=t(57220),U=t(72399),O=t(49785),re=t(88575),le=t(10880);const E=({pathPrefix:j,className:T,readOnly:z=!1})=>{const{register:C}=(0,O.xW)();return(0,e.jsx)("div",{className:T,children:(0,e.jsx)(re.D,{disabled:z,children:(0,e.jsx)(le.S,{...C(`${j}sendResolved`),label:"Send resolved",disabled:z,description:"Whether or not to notify about resolved alerts."})})})};var ee=t(18022);const K=Object.freeze({__id:"",sendResolved:!0,secureSettings:{},settings:{},secureFields:{},type:"email"}),ce=_.r.map(j=>({dto:j})),{useGetAlertmanagerConfigurationQuery:H}=q.m,de=({contactPoint:j,alertManagerSourceName:T,readOnly:z=!1,editMode:C})=>{const{isLoading:me,data:J}=H(T),te=(0,N.AL)(T),[ue]=(0,M.Kt)({alertmanager:T}),[ne]=(0,M.Pm)({alertmanager:T}),[ge]=(0,y.useMemo)(()=>j?(0,U.Iq)(j,_.r):[void 0,{}],[j]),ve=async X=>{const se=(0,U.QX)(X,K);try{C&&j?await ne.execute({contactPoint:se,originalName:j.name}):await ue.execute({contactPoint:se}),D.Ny.push("/alerting/notifications")}catch{}},Q=!z;return(0,e.jsxs)(e.Fragment,{children:[!te&&(0,e.jsx)(oe.F,{title:"Info",severity:"info",children:"Note that empty string values will be replaced with global defaults where appropriate."}),(0,e.jsx)(ee.k,{showDefaultRouteWarning:!me&&!J?.alertmanager_config.route,isEditable:Q,isTestable:Q,onSubmit:ve,initialValues:ge,notifiers:ce,alertManagerSourceName:T,defaultItem:K,commonSettingsComponent:E})]})}},17430:(Ie,ie,t)=>{t.d(ie,{a:()=>Fe});var e=t(74848),y=t(96540),D=t(39601),oe=t(39558),q=t(42418),M=t(93667),_=t(77141),N=t(57220),U=t(51703),O=t(31678),re=t(82843),le=t(26627),E=t(72399),ee=t(48205),K=t(37534),ce=t(59647),H=t(49785),de=t(88575),j=t(10880);const T=({pathPrefix:s,className:L,readOnly:n=!1})=>{const{register:a}=(0,H.xW)();return(0,e.jsx)("div",{className:L,children:(0,e.jsx)(de.D,{children:(0,e.jsx)(j.S,{...a(`${s}disableResolveMessage`),label:"Disable resolved message",description:"Disable the resolve message [OK] that is sent when alerting state returns to false",disabled:n})})})};var z=t(18022),C=t(32196),me=t(40845),J=t(37390),te=t(60029),ue=t(94354),ne=t(55852),ge=t(55740),ve=t(31099),Q=t(97171),X=(s=>(s.predefined="Predefined",s.custom="Custom",s))(X||{});const se=Object.values(X).map(s=>({label:s,value:s})),xe={annotations:[...ge.kl],labels:[{key:"",value:""}]},pe=({isOpen:s,onDismiss:L,onTest:n})=>{const[a,r]=(0,y.useState)("Predefined"),u=(0,me.of)(je),F=(0,H.mN)({defaultValues:xe,mode:"onBlur"}),S=p=>{if(a==="Custom"){const f={annotations:p.annotations.filter(({key:h,value:c})=>!!h&&!!c).reduce((h,{key:c,value:i})=>({...h,[c]:i}),{}),labels:p.labels.filter(({key:h,value:c})=>!!h&&!!c).reduce((h,{key:c,value:i})=>({...h,[c]:i}),{})};n(f)}else n()};return(0,e.jsxs)(J.a,{onDismiss:L,isOpen:s,title:"Test contact point",children:[(0,e.jsxs)("div",{className:u.section,children:[(0,e.jsx)(te.J,{children:"Notification message"}),(0,e.jsx)(ue.z,{options:se,value:a,onChange:p=>r(p)})]}),(0,e.jsx)(H.Op,{...F,children:(0,e.jsxs)("form",{onSubmit:F.handleSubmit(S),children:[a==="Predefined"&&(0,e.jsxs)("div",{className:u.section,children:["You will send a test notification that uses a predefined alert. If you have defined a custom template or message, for better results switch to ",(0,e.jsx)("strong",{children:"custom"})," notification message, from above."]}),a==="Custom"&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)("div",{className:u.section,children:"You will send a test notification that uses the annotations defined below. This is a good option if you use custom templates and messages."}),(0,e.jsx)("div",{className:u.section,children:(0,e.jsx)(ve.A,{})}),(0,e.jsx)("div",{className:u.section,children:(0,e.jsx)(Q.Ay,{})})]}),(0,e.jsx)(J.a.ButtonRow,{children:(0,e.jsx)(ne.$n,{type:"submit",children:"Send test notification"})})]})})]})},je=s=>({flexRow:(0,C.css)({display:"flex",flexDirection:"row",alignItems:"flex-start",marginBottom:s.spacing(1)}),section:(0,C.css)({marginBottom:s.spacing(2)})}),fe=Object.freeze({__id:"",secureSettings:{},settings:{},secureFields:{},disableResolveMessage:!1,type:"email"}),{useGrafanaNotifiersQuery:Ce}=re.m,Fe=({contactPoint:s,readOnly:L=!1,editMode:n})=>{const a=(0,O.useDispatch)(),r=(0,U.dM)(N.hY),[u]=(0,M.Kt)({alertmanager:N.hY}),[F]=(0,M.Pm)({alertmanager:N.hY}),{onCallNotifierMeta:S,extendOnCallNotifierFeatures:p,extendOnCallReceivers:f,onCallFormValidators:h,isLoadingOnCallIntegration:c,hasOnCallError:i}=(0,ce.VY)(),{data:A=[],isLoading:I}=Ce(),[x,d]=(0,y.useState)(),[P,$]=(0,y.useMemo)(()=>!s||I||c?[void 0,{}]:(0,E.Xo)(f(s),A),[s,I,A,f,c]),Z=async m=>{const Y=(0,E.bB)(m,$,fe,A);try{n?r&&s&&s.id?await F.execute({contactPoint:Y,id:s.id,resourceVersion:s?.metadata?.resourceVersion}):s&&await F.execute({contactPoint:Y,originalName:s.name}):await u.execute({contactPoint:Y}),D.Ny.push("/alerting/notifications")}catch{}},w=m=>{d(m)},he=m=>{if(x){const Y=$[x.__id],k=(0,E.qg)(x,fe,"test",Y),G={alertManagerSourceName:N.hY,receivers:[{name:"test",grafana_managed_receiver_configs:[k]}],alert:m};a((0,le.bO)(G))}},B=!!((!L||s&&(0,U.Au)(s))&&!s?.provisioned),V=!L;if(I||c)return(0,e.jsx)(oe._,{text:"Loading notifiers..."});const W=A.map(m=>m.type===K.J4.OnCall?{dto:p(m),meta:S}:{dto:m});return(0,e.jsxs)(e.Fragment,{children:[i&&(0,e.jsx)(q.F,{severity:"error",title:"Loading OnCall integration failed",children:"Grafana OnCall plugin has been enabled in your Grafana instances but it is not reachable. Please check the plugin configuration"}),s?.provisioned&&(0,e.jsx)(ee.Yi,{resource:ee.hk.ContactPoint}),(0,e.jsx)(z.k,{contactPointId:s?.id,isEditable:B,isTestable:V,onSubmit:Z,initialValues:P,onTestChannel:w,notifiers:W,alertManagerSourceName:N.hY,defaultItem:{...fe},commonSettingsComponent:T,customValidators:{[K.J4.OnCall]:h},canManagePermissions:n&&s&&(0,_.T8)(N.hY,s)}),(0,e.jsx)(pe,{onDismiss:()=>d(void 0),isOpen:!!x,onTest:m=>he(m)})]})}},18022:(Ie,ie,t)=>{t.d(ie,{k:()=>Fe});var e=t(74848),y=t(32196),D=t(49785),oe=t(17172),q=t(40845),M=t(42418),_=t(67061),N=t(88575),U=t(10354),O=t(55852),re=t(3169),le=t(40715),E=t(93667),ee=t(17046),K=t(94954),ce=t(25027),H=t(26423),de=t(45124),j=t(78742),T=t(88467),z=t(2543),C=t(96540),me=t(90182),J=t(94753),te=t(8484),ue=t(61410),ne=t(59647),ge=t(9226),ve=t(23807);function Q({defaultValues:n,selectedChannelOptions:a,onResetSecureField:r,secureFields:u,errors:F,pathPrefix:S="",readOnly:p=!1,customValidators:f={}}){const{watch:h}=(0,D.xW)(),c=h();return(0,e.jsx)(e.Fragment,{children:a.map((i,A)=>{const I=`${i.label}-${A}`,x=S.split("."),d=x.length>=2?c.items?.[Number(x[1])].settings?.[i.showWhen.field]:void 0;if(i.showWhen.field&&d!==i.showWhen.is)return null;if(u&&u[i.propertyName])return(0,e.jsx)(N.D,{label:i.label,description:i.description,children:(0,e.jsx)(ge.L4,{onReset:()=>r(i.propertyName),isConfigured:!0})},I);const P=(i.secure?F?.secureSettings:F?.settings)?.[i.propertyName],$=n?.settings?.[i.propertyName];return(0,e.jsx)(ve.e,{onResetSecureField:r,secureFields:u,defaultValue:$,readOnly:p,error:P,pathPrefix:S,pathSuffix:i.secure?"secureSettings.":"settings.",option:i,customValidator:f[i.propertyName]},I)})})}var X=t(14591);function se({defaultValues:n,initialValues:a,pathPrefix:r,onDuplicate:u,onDelete:F,onTest:S,notifiers:p,errors:f,secureFields:h,commonSettingsComponent:c,isEditable:i=!0,isTestable:A,customValidators:I={}}){const x=(0,q.of)(xe),d=(0,C.useCallback)(l=>`${r}${l}`,[r]),{control:P,watch:$,register:Z,trigger:w,formState:he,setValue:B}=(0,D.xW)(),V=$(d("type"))??n.type,W=$(d("settings.parse_mode")),{loading:m}=(0,ue.$)(l=>l.testReceivers),k=$(d("settings.integration_type"))!==ne.U0.NewIntegration;(0,C.useEffect)(()=>{Z(`${r}.__id`),Z(`${r}.secureFields`)},[Z,r]),(0,C.useEffect)(()=>{const l=$((R,{name:b,type:Ae})=>{const Re=b?R[b]:"";a&&b===d("type")&&Re===a.type&&Ae==="change"&&B(d("settings"),a.settings),a&&b===d("settings.integration_type")&&Re===ne.U0.ExistingIntegration&&B(d("settings.url"),a.settings.url)});return()=>l.unsubscribe()},[V,a,B,d,$]);const[G,Se]=(0,C.useState)(h??{}),ye=l=>{if(G[l]){const R={...G};R[l]="",Se(R),B(`${r}.secureFields`,R)}},g=(0,C.useMemo)(()=>(0,z.sortBy)(p,({dto:l,meta:R})=>[R?.order??0,l.name]).map(({dto:{name:l,type:R},meta:b})=>({label:l,value:R,description:b?.description,isDisabled:b?!b.enabled:!1,imgUrl:b?.iconUrl})),[p]),o=async()=>{await w(),Object.keys(he.errors).length===0&&S&&S()},v=p.find(({dto:{type:l}})=>l===V),be=V==="telegram"&&!(W==="None"||!W),Oe=v?.dto.options.filter(l=>l.required),Te=v?.dto.options.filter(l=>!l.required),$e=`contact-point-type-${r}`;return(0,e.jsxs)("div",{className:x.wrapper,"data-testid":"item-container",children:[(0,e.jsxs)("div",{className:x.topRow,children:[(0,e.jsx)("div",{children:(0,e.jsx)(N.D,{label:"Integration",htmlFor:$e,"data-testid":`${r}type`,children:(0,e.jsx)(D.xI,{name:d("type"),defaultValue:n.type,render:({field:{ref:l,onChange:R,...b}})=>(0,e.jsx)(me.l6,{disabled:!i,inputId:$e,...b,width:37,options:g,onChange:Ae=>R(Ae?.value)}),control:P,rules:{required:!0}})})}),(0,e.jsxs)("div",{className:x.buttons,children:[A&&S&&k&&(0,e.jsx)(O.$n,{disabled:m,size:"xs",variant:"secondary",type:"button",onClick:()=>o(),icon:m?"spinner":"message",children:"Test"}),i&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(O.$n,{size:"xs",variant:"secondary",type:"button",onClick:()=>u(),icon:"copy",children:"Duplicate"}),F&&(0,e.jsx)(O.$n,{"data-testid":`${r}delete-button`,size:"xs",variant:"secondary",type:"button",onClick:()=>F(),icon:"trash-alt",children:"Delete"})]})]})]}),v&&(0,e.jsxs)("div",{className:x.innerContent,children:[be&&(0,e.jsx)(M.F,{title:(0,te.t)("alerting.contact-points.telegram.parse-mode-warning-title","Telegram messages are limited to 4096 UTF-8 characters."),severity:"warning",children:(0,e.jsxs)(te.x6,{i18nKey:"alerting.contact-points.telegram.parse-mode-warning-body",children:["If you use a ",(0,e.jsx)(J.E,{variant:"code",children:"parse_mode"})," option other than ",(0,e.jsx)(J.E,{variant:"code",children:"None"}),", truncation may result in an invalid message, causing the notification to fail. For longer messages, we recommend using an alternative contact method."]})}),(0,e.jsx)(Q,{defaultValues:n,selectedChannelOptions:Oe?.length?Oe:Te,secureFields:G,errors:f,onResetSecureField:ye,pathPrefix:r,readOnly:!i,customValidators:I}),!!(Oe?.length&&Te?.length)&&(0,e.jsxs)(X.i,{label:`Optional ${v.dto.name} settings`,children:[v.dto.info!==""&&(0,e.jsx)(M.F,{title:"",severity:"info",children:v.dto.info}),(0,e.jsx)(Q,{defaultValues:n,selectedChannelOptions:Te,secureFields:G,onResetSecureField:ye,errors:f,pathPrefix:r,readOnly:!i,customValidators:I})]}),(0,e.jsx)(X.i,{label:"Notification settings",children:(0,e.jsx)(c,{pathPrefix:r,readOnly:!i})})]})]})}const xe=n=>({buttons:(0,y.css)({"& > * + *":{marginLeft:n.spacing(1)}}),innerContent:(0,y.css)({maxWidth:"536px"}),wrapper:(0,y.css)({margin:n.spacing(2,0),padding:n.spacing(1),border:`solid 1px ${n.colors.border.medium}`,borderRadius:n.shape.radius.default}),topRow:(0,y.css)({display:"flex",flexDirection:"row",justifyContent:"space-between"}),channelSettingsHeader:(0,y.css)({marginTop:n.spacing(2)})});function pe({pathPrefix:n}){const{register:a}=(0,D.xW)();return(0,C.useEffect)(()=>{a(`${n}.__id`),a(`${n}.__deleted`)},[a,n]),(0,e.jsx)(e.Fragment,{})}function je(n){if(n)return{...n,items:n.items.map(a=>({...a,settings:{...a.settings,http_config:a.settings?.http_config?fe(a.settings?.http_config):void 0}}))}}function fe(n){return Ce(n)?n:{...(0,z.omit)(n,"authorization"),bearer_token:n.authorization?.credentials,bearer_token_file:n.authorization?.credentials_file}}function Ce(n){return["bearer_token","bearer_token_file"].some(a=>a in n)}function Fe({initialValues:n,defaultItem:a,notifiers:r,alertManagerSourceName:u,onSubmit:F,onTestChannel:S,commonSettingsComponent:p,isEditable:f,isTestable:h,customValidators:c,showDefaultRouteWarning:i,contactPointId:A,canManagePermissions:I}){const x=(0,re._2)(),d=(0,q.of)(s),P=(0,E.cB)({alertmanager:u}),Z=je(n)??{name:"",items:[{...a,__id:String(Math.random())}]},w=(0,D.mN)({defaultValues:structuredClone(Z)});(0,le.o)(g=>g.unifiedAlerting.saveAMConfig=T.jA);const{handleSubmit:he,register:B,formState:{errors:V,isSubmitting:W},getValues:m}=w,{fields:Y,append:k,remove:G}=(0,de.r)({name:"items",formAPI:w,softDelete:!0}),Se=async g=>{g.items.forEach(o=>{o.secureFields&&Object.keys(o.secureFields).forEach(v=>{(o.secureFields[v]===!0||o.secureFields[v]===!1)&&delete o.secureFields[v]})});try{await F({...g,items:g.items.filter(o=>!o.__deleted)})}catch(o){if(o instanceof Error||(0,oe.NF)(o)){x.error("Failed to save the contact point",L(o));const v=new Error("Failed to save the contact point");v.cause=o,(0,ce.vV)(v)}throw o}},ye=()=>{x.error("There are errors in the form. Please correct them and try again!")};return(0,e.jsxs)(D.Op,{...w,children:[i&&(0,e.jsx)(M.F,{severity:"warning",title:"Attention",children:"Because there is no default policy configured yet, this contact point will automatically be set as default."}),(0,e.jsxs)("form",{onSubmit:he(Se,ye),className:d.wrapper,children:[(0,e.jsxs)(_.B,{justifyContent:"space-between",alignItems:"center",children:[(0,e.jsx)("h2",{className:d.heading,children:f?n?"Update contact point":"Create contact point":"Contact point"}),I&&A&&(0,e.jsx)(ee.k,{resource:"receivers",resourceId:A,resourceName:n?.name,title:"Manage contact point permissions"})]}),(0,e.jsx)(N.D,{label:"Name",invalid:!!V.name,error:V.name&&V.name.message,required:!0,children:(0,e.jsx)(U.p,{readOnly:!f,id:"name",...B("name",{required:"Name is required",validate:async g=>{const o=n?.name;return P(g,o)}}),width:39,placeholder:"Name"})}),Y.map((g,o)=>{const v=`items.${o}.`;if(g.__deleted)return(0,e.jsx)(pe,{pathPrefix:v},g.__id);const Ne=n?.items.find(({__id:ae})=>ae===g.__id);return(0,e.jsx)(se,{defaultValues:g,initialValues:Ne,onDuplicate:()=>{const ae=m().items[o];k({...ae,__id:String(Math.random())})},onTest:S?()=>{const ae=m().items[o];S(ae)}:void 0,onDelete:()=>G(o),pathPrefix:v,notifiers:r,secureFields:Ne?.secureFields,errors:V?.items?.[o],commonSettingsComponent:p,isEditable:f,isTestable:h,customValidators:c?c[g.type]:void 0},g.__id)}),(0,e.jsxs)(e.Fragment,{children:[f&&(0,e.jsx)(O.$n,{type:"button",icon:"plus",variant:"secondary",onClick:()=>k({...a,__id:String(Math.random())}),children:"Add contact point integration"}),(0,e.jsxs)("div",{className:d.buttons,children:[f&&(0,e.jsxs)(e.Fragment,{children:[W&&(0,e.jsx)(O.$n,{disabled:!0,icon:"spinner",variant:"primary",children:"Saving..."}),!W&&(0,e.jsx)(O.$n,{type:"submit",children:"Save contact point"})]}),(0,e.jsx)(O.z9,{disabled:W,variant:"secondary","data-testid":"cancel-button",href:(0,j.nL)("/alerting/notifications",u),children:"Cancel"})]})]})]})]})}const s=n=>({heading:(0,y.css)({margin:n.spacing(2,0,3,0)}),buttons:(0,y.css)({marginTop:n.spacing(4),"& > * + *":{marginLeft:n.spacing(1)}}),wrapper:(0,y.css)({maxWidth:`${n.breakpoints.values.xl}px`})});function L(n){return(0,H.uz)(n)?n.data.detail:(0,K.q)(n)}}}]);

//# sourceMappingURL=7455.bea2262b50ce52a3f921.js.map