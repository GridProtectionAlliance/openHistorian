"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[4009],{44848:(Bt,xe,t)=>{t.r(xe),t.d(xe,{default:()=>gn});var e=t(74848),m=t(96540),$=t(54148),p=t(16817),k=t(66602),U=t(31678),v=t(32196),B=t(42418),de=t(40845),ee=t(55852);function H({title:a,children:g}){return(0,e.jsxs)(B.F,{className:(0,de.of)(te).warning,severity:"warning",title:a,children:[(0,e.jsx)("p",{children:g}),(0,e.jsx)(ee.z9,{href:"alerting/list",children:"To rule list"})]})}const te=a=>({warning:(0,v.css)({margin:a.spacing(4)})});var he=t(2543),ie=t(39601),_=t(39558),oe=t(49785),Ge=t(24180),Be=t(32264),Ue=t(67061),ze=t(62930),ye=t(40276),se=t(96374),Fe=t(75269),fe=t(21780),le=t(3169),Y=t(10096),qe=t(93810),L=t(23662),Ne=t(25027),ct=t(24608),dt=t(96065),je=t(1932),b=t(8484),Se=t(79938),Ie=t(48070),Qe=t(6833),De=t(43482);function ut(){const[a]=(0,De.D)(),[g]=Se.hK.endpoints.upsertRuleGroupForNamespace.useMutation(),S=(0,b.t)("alerting.rules.add-rule.success","Rule added successfully");return(0,Qe.Yb)(async(T,M,Q)=>{const{namespaceName:J}=T,C=(0,Ie.Qn)({rule:M,interval:Q,groupName:T.groupName}),{newRuleGroupDefinition:ue,rulerConfig:Ce}=await a(T,C);return g({rulerConfig:Ce,namespace:J,payload:ue,notificationOptions:{successMessage:S}}).unwrap()})}function Re(){const[a]=(0,De.D)(),[g]=Ze(),[S]=Se.hK.endpoints.upsertRuleGroupForNamespace.useMutation(),T=(0,b.t)("alerting.rules.update-rule.success","Rule updated successfully");return(0,Qe.Yb)(async(M,Q,J,C,ue)=>{const{namespaceName:Ce}=M,Ee=pe(Q,J),ce=(0,he.isEqual)(M,C);if(C&&!ce)return g.execute(M,C,Q,J,ue);const we=(0,Ie.Wu)({identifier:Q,rule:Ee}),{newRuleGroupDefinition:Ve,rulerConfig:gt}=await a(M,we);return S({rulerConfig:gt,namespace:Ce,payload:Ve,notificationOptions:{successMessage:T}}).unwrap()})}function Ze(){const[a]=(0,De.D)(),[g]=(0,dt.Y)(),[S]=Se.hK.endpoints.upsertRuleGroupForNamespace.useMutation(),T=(0,b.t)("alerting.rules.update-rule.success","Rule updated successfully");return(0,Qe.Yb)(async(M,Q,J,C,ue)=>{const Ce=pe(J,C),Ee=(0,Ie.Qn)({rule:Ce,interval:ue}),{newRuleGroupDefinition:ce,rulerConfig:we}=await a(Q,Ee),Ve=await S({rulerConfig:we,namespace:Q.namespaceName,payload:ce,notificationOptions:{successMessage:T}}).unwrap();return(0,L.A4)(J)||await g.execute(M,J),Ve})}function pe(a,g){const S=(0,L.A4)(a);return(0,je.jM)(g,T=>{const M=(0,L.lT)(T);S&&M&&(T.grafana_alert.uid=a.uid)})}var mt=t(55776),be=t(39964),E=t(86590),f=t(63066),y=t(18461),j=t(3704),w=t(16293),q=t(76648),ae=t(84029);const K=({alertUid:a,exportFormat:g,onClose:S})=>{const{currentData:T="",isFetching:M}=Se.hK.endpoints.exportRules.useQuery({ruleUid:a,format:g}),Q=`${a}-${new Date().getTime()}`;return M?(0,e.jsx)(_._,{text:"Loading...."}):(0,e.jsx)(w.J,{format:g,textDefinition:T,downloadFileName:Q,onClose:S})},F=({onClose:a,alertUid:g})=>{const[S,T]=(0,m.useState)("yaml");return(0,e.jsx)(q.m,{activeTab:S,onTabChange:T,onClose:a,formatProviders:Object.values(ae.sl),children:(0,e.jsx)(K,{alertUid:g,exportFormat:S,onClose:a})})};var _e=t(53534),yt=t(31099),He=t(88575),jt=t(10354),et=t(90182),tt=t(25968),Ye=t(40111);const St=({rulesSourceName:a})=>{const{control:g,watch:S,formState:{errors:T},setValue:M}=(0,oe.xW)(),Q=(0,de.of)(Le),{namespaceGroups:J,isLoading:C}=(0,Ye.V)(a),ue=S("namespace"),Ce=(0,m.useMemo)(()=>Array.from(J.keys()).map(ce=>({label:ce,value:ce})),[J]),Ee=(0,m.useMemo)(()=>ue&&J.get(ue)?.map(ce=>({label:ce,value:ce}))||[],[ue,J]);return(0,e.jsxs)("div",{className:Q.flexRow,children:[(0,e.jsx)(He.D,{"data-testid":"namespace-picker",label:"Namespace",error:T.namespace?.message,invalid:!!T.namespace?.message,children:(0,e.jsx)(oe.xI,{render:({field:{onChange:ce,ref:we,...Ve}})=>(0,e.jsx)(et.ip,{...Ve,allowCustomValue:!0,className:Q.input,onChange:gt=>{M("group",""),ce(gt.value)},options:Ce,width:42,isLoading:C,disabled:C}),name:"namespace",control:g,rules:{required:{value:!0,message:"Required."}}})}),(0,e.jsx)(He.D,{"data-testid":"group-picker",label:"Group",error:T.group?.message,invalid:!!T.group?.message,children:(0,e.jsx)(oe.xI,{render:({field:{ref:ce,...we}})=>(0,e.jsx)(et.ip,{...we,allowCustomValue:!0,options:Ee,width:42,onChange:Ve=>{M("group",Ve.value??"")},className:Q.input,isLoading:C,disabled:C}),name:"group",control:g,rules:{required:{value:!0,message:"Required."}}})})]})},Le=a=>({flexRow:(0,v.css)({display:"flex",flexDirection:"row",justifyContent:"flex-start","& > * + *":{marginLeft:a.spacing(3)}}),input:(0,v.css)({width:"330px !important"})});var It=t(67986),ft=t(271);const Ft=()=>{const a=(0,de.of)(zt),{register:g,control:S,watch:T,formState:{errors:M}}=(0,oe.xW)(),Q=T("type"),J=T("dataSourceName");return(0,e.jsxs)(ft.P,{stepNo:3,title:"Set evaluation behavior",children:[(0,e.jsx)(He.D,{label:"Pending period",description:'Period the threshold condition must be met to trigger the alert. Selecting "None" triggers the alert immediately once the condition is met.',children:(0,e.jsxs)("div",{className:a.flexRow,children:[(0,e.jsx)(He.D,{invalid:!!M.forTime?.message,error:M.forTime?.message,className:a.inlineField,children:(0,e.jsx)(jt.p,{...g("forTime",{pattern:{value:/^\d+$/,message:"Must be a positive integer."}}),width:8})}),(0,e.jsx)(oe.xI,{name:"forTimeUnit",render:({field:{onChange:C,ref:ue,...Ce}})=>(0,e.jsx)(et.l6,{...Ce,options:tt.sc,onChange:Ee=>C(Ee?.value),width:15,className:a.timeUnit}),control:S})]})}),Q===E.Z.cloudAlerting&&J&&(0,e.jsx)(St,{rulesSourceName:J}),(0,e.jsx)(It.L,{})]})},zt=a=>({inlineField:(0,v.css)({marginBottom:0}),flexRow:(0,v.css)({display:"flex",flexDirection:"row",justifyContent:"flex-start",alignItems:"flex-start"}),timeUnit:(0,v.css)({marginLeft:a.spacing(.5)})});var Zt=t(1723),Ht=t(95305);function wt(){const{watch:a}=(0,oe.xW)(),g=a("dataSourceName");return g?(0,e.jsx)(ft.P,{stepNo:3,title:"Add namespace and group",description:"Select the Namespace and Group for your recording rule.",children:(0,e.jsx)(St,{rulesSourceName:g})}):null}var Yt=t(73716),Kt=t(51682),Jt=t(52487);const Vt=(0,ct.w)(),l=({existing:a,prefill:g})=>{const S=(0,de.of)(W),T=(0,le._2)(),[M]=(0,be.l)(),[Q,J]=(0,m.useState)(!1),[C,ue]=(0,m.useState)(a?.group.interval??f.T6),[Ce]=(0,dt.Y)(),[Ee]=ut(),[ce]=Re(),{returnTo:we}=(0,mt.h)(),Ve=(0,Ge.g)(),gt=(0,Jt._u)(Ve.type),At=Ve.id,[sn,Xt]=(0,m.useState)(!1),an=(0,m.useMemo)(()=>a?(0,f.ir)(a):g?O(g):M.has("defaults")?z(M.get("defaults")??"",gt):{...(0,f.IJ)(),condition:"C",queries:(0,f.qO)(),type:gt||E.Z.grafana,evaluateEvery:C},[a,g,M,C,gt]),kt=(0,oe.mN)({mode:"onSubmit",defaultValues:an,shouldFocusError:!0}),{handleSubmit:Ct,watch:Nt,formState:{isSubmitting:ht}}=kt,Je=Nt("type"),qt=(0,L.H2)(Je??E.Z.grafana),hn=Nt("dataSourceName"),vn=!!(Je&&((0,L.H2)(Je)||hn)),[Wt,_t]=(0,m.useState)(""),xn=(me="")=>{_t(me)},Qt=(0,m.useCallback)(async(me,bt)=>{if(Wt!==""){T.error(Wt);return}(0,Ne.nf)({formAction:a?"update":"create",ruleType:me.type});const vt=qt?(0,f.Z9)(me):(0,f.l1)(me),Lt=a?(0,L.I2)(a):(0,L.j_)(me);if(!a)N(me),await Ee.execute(Lt,vt,C);else{const Ot=(0,y.mw)(Lt,a.rule),Rn=(0,L.j_)(me);await ce.execute(Lt,Ot,vt,Rn,C)}const{dataSourceName:Sn,namespaceName:cn,groupName:In}=Lt;if(bt){const Ot=we||R(Lt,vt);ie.Ny.push(Ot);return}if((0,L.Mt)(vt)){const Ot=(0,y.P1)(Sn,cn,In,vt);ie.Ny.replace(`/alerting/${encodeURIComponent((0,y.$9)(Ot))}/edit`)}},[Ee,Wt,C,a,qt,T,ce,we]),yn=async()=>{if(a){const me=M.get("returnTo")||"/alerting/list",bt=(0,L.I2)(a),vt=(0,y.mw)(bt,a.rule);await Ce.execute(bt,vt),ie.Ny.replace(me)}},en=(0,m.useCallback)(me=>{(0,Ne.IR)({grafana_version:Be.$.buildInfo.version,org_id:Y.TP.user.orgId,user_id:Y.TP.user.id,error:Object.keys(me).toString(),formAction:a?"update":"create"}),T.error("There are errors in the form. Please correct them and try again!")},[a,T]),$t=(0,m.useCallback)(()=>{(0,Ne.fH)(Ne.le.cancelSavingAlertRule),(0,Ne.Rk)({formAction:a?"update":"create"}),ie.Ny.getHistory().goBack()},[a]),Et=Nt("evaluateEvery");(0,m.useEffect)(()=>ue(Et),[Et]);const ln=(0,m.useMemo)(()=>(0,e.jsxs)(Ue.B,{justifyContent:"flex-end",alignItems:"center",children:[a&&(0,e.jsxs)(ee.$n,{variant:"primary",type:"button",size:"sm",onClick:Ct(me=>Qt(me,!1),en),disabled:ht,children:[ht&&(0,e.jsx)(ze.y,{className:S.buttonSpinner,inline:!0}),"Save rule"]}),(0,e.jsxs)(ee.$n,{variant:"primary",type:"button",size:"sm",onClick:Ct(me=>Qt(me,!0),en),disabled:ht,children:[ht&&(0,e.jsx)(ze.y,{className:S.buttonSpinner,inline:!0}),"Save rule and exit"]}),(0,e.jsx)(ee.$n,{variant:"secondary",disabled:ht,type:"button",onClick:$t,size:"sm",children:"Cancel"}),a?(0,e.jsx)(ee.$n,{fill:"outline",variant:"destructive",type:"button",onClick:()=>Xt(!0),size:"sm",children:"Delete"}):null,a&&A(Nt)&&(0,e.jsx)(ee.$n,{variant:"secondary",type:"button",onClick:()=>J(!0),disabled:ht,size:"sm",children:"Edit YAML"})]}),[$t,a,Ct,ht,en,S.buttonSpinner,Qt,Nt]);(0,fe.YO)(ln);const jn=a&&(0,L.lT)(a.rule)&&(0,L.HH)(a.rule);return Je?(0,e.jsxs)(oe.Op,{...kt,children:[!Be.$.featureToggles.singleTopNav&&(0,e.jsx)(Fe.H,{actions:ln}),(0,e.jsx)("form",{onSubmit:me=>me.preventDefault(),className:S.form,children:(0,e.jsxs)("div",{className:S.contentOuter,children:[jn&&(0,e.jsx)(qe.A,{}),(0,e.jsx)(ye.E,{autoHeightMin:"100%",hideHorizontalTrack:!0,children:(0,e.jsxs)(Ue.B,{direction:"column",gap:3,children:[(0,e.jsx)(_e.H,{}),(0,e.jsx)(Kt.N,{editingExistingRule:!!a,onDataChange:xn}),vn&&(0,e.jsxs)(e.Fragment,{children:[(0,L.H2)(Je)&&(0,e.jsx)(Zt.R,{evaluateEvery:C,setEvaluateEvery:ue,existing:!!a,enableProvisionedGroups:!1}),Je===E.Z.cloudAlerting&&(0,e.jsx)(Ft,{}),Je===E.Z.cloudRecording&&(0,e.jsx)(wt,{}),(0,e.jsx)(Ht.N,{alertUid:At}),!(0,L.vE)(Je)&&(0,e.jsx)(yt.A,{})]})]})})]})}),sn?(0,e.jsx)(se.u,{isOpen:!0,title:"Delete rule",body:"Deleting this rule will permanently remove it. Are you sure you want to delete this rule?",confirmText:"Yes, delete",icon:"exclamation-triangle",onConfirm:yn,onDismiss:()=>Xt(!1)}):null,Q?(0,L.H2)(Je)?(0,e.jsx)(F,{alertUid:At,onClose:()=>J(!1)}):(0,e.jsx)(Yt.G_,{onClose:()=>J(!1)}):null]}):null};function R(a,g){const{dataSourceName:S,namespaceName:T,groupName:M}=a;if(Vt&&(0,L.Mt)(g)){const Q=(0,y.P1)(S,T,M,g);return P(Q)}return"/alerting/list"}function P(a,g){const S=encodeURIComponent(y.$9(a)),T=encodeURIComponent(a.ruleSourceName);return(0,j.G)(`/alerting/${T}/${S}/view`,g?{returnTo:g}:{})}const A=a=>{const[g,S]=a(["type","dataSourceName"]);return(g===E.Z.cloudAlerting||g===E.Z.cloudRecording)&&S!==""};function z(a,g){let S;try{S=JSON.parse(a)}catch{return{...(0,f.IJ)(),queries:(0,f.qO)()}}return(0,f.Rk)({...(0,f.IJ)(),...S,annotations:(0,f.JE)(S.annotations??[]),queries:S.queries??(0,f.qO)(),type:g||E.Z.grafana,evaluateEvery:f.T6})}function O(a){return(0,f.Rk)({...(0,f.IJ)(),...a})}function N(a){a.manualRouting?localStorage.setItem(f.Q8,"true"):localStorage.setItem(f.Q8,"false"),a.editorSettings&&(a.editorSettings.simplifiedQueryEditor?localStorage.setItem(f.Os,"true"):localStorage.setItem(f.Os,"false"))}const W=a=>({buttonSpinner:(0,v.css)({marginRight:a.spacing(1)}),form:(0,v.css)({width:"100%",height:"100%",display:"flex",flexDirection:"column"}),contentOuter:(0,v.css)({background:a.colors.background.primary,overflow:"hidden",maxWidth:a.breakpoints.values.xl,flex:1}),flexRow:(0,v.css)({display:"flex",flexDirection:"row",justifyContent:"flex-start"})});var Me=t(730),Ke=t(79944),nt=t(78742);function pt({sourceRuleId:a}){const{loading:g,result:S,error:T}=(0,Me.Ll)({ruleIdentifier:a});if(g)return(0,e.jsx)(_._,{text:"Loading the rule..."});if(S){const M=ot(S),Q=(0,f.QX)(M);return(0,e.jsx)(l,{prefill:Q})}return T?(0,e.jsx)(B.F,{title:"Error",severity:"error",children:(0,nt.JZ)(T)}):(0,e.jsx)(B.F,{title:"Cannot copy the rule. The rule does not exist",buttonContent:"Go back to alert list",onRemove:()=>ie.Ny.replace((0,j.G)("/alerting/list"))})}function Pe(a,g){(0,L.lT)(a)&&(a.grafana_alert.title=g),(0,L.$y)(a)&&(a.alert=g),(0,L.i7)(a)&&(a.record=g)}function ot(a){const g=(0,he.cloneDeep)(a);return Pe(g.rule,(0,Ke.V)((0,L.qz)(g.rule),g.group.rules.map(L.qz))),(0,L.lT)(g.rule)&&(g.rule.grafana_alert.uid="",g.rule.grafana_alert.provenance&&(g.group={name:"",rules:g.group.rules})),g}var rt=t(97009);function st({identifier:a,id:g}){const{loading:S,result:T,error:M}=(0,Me.Ll)({ruleIdentifier:a}),Q=y.VY(a),{isEditable:J,loading:C}=(0,rt.g)(Q,T?.rule);return S||C?(0,e.jsx)(_._,{text:"Loading rule..."}):M?(0,e.jsx)(B.F,{severity:"error",title:"Failed to load rule",children:(0,nt.JZ)(M)}):T?J===!1?(0,e.jsx)(H,{title:"Cannot edit rule",children:"Sorry! You do not have permission to edit this rule."}):(0,e.jsx)(l,{existing:T}):(0,e.jsx)(H,{title:"Rule not found",children:"Sorry! This rule does not exist."})}var Oe=t(37959),at=t(26627),Dt=t(41520);const Rt={icon:"bell",id:"alert-rule-view"},it=(a,g)=>g==="recording"||g==="grafana-recording"?a?{...Rt,id:"alert-rule-edit",text:"Edit recording rule"}:{...Rt,id:"alert-rule-add",text:"New recording rule"}:a?{...Rt,id:"alert-rule-edit",text:"Edit rule"}:{...Rt,id:"alert-rule-add",text:"New alert rule"},Pt=()=>{const a=(0,U.useDispatch)(),[g]=(0,be.l)(),S=(0,$.g)(),{type:T}=S,M=y.uE(S),Q=y.x6(M,!0),J=g.get("copyFrom")??void 0,C=y.x6(J),{loading:ue=!0}=(0,p.A)(async()=>{Q&&await a((0,at.DC)({rulesSourceName:Q.ruleSourceName})),C&&await a((0,at.DC)({rulesSourceName:C.ruleSourceName}))},[a]),{canCreateGrafanaRules:Ce,canCreateCloudRules:Ee,canEditRules:ce}=(0,Dt.V)(),we=(0,m.useCallback)(()=>{if(!ue)return!Q&&!Ce&&!Ee?(0,e.jsx)(H,{title:"Cannot create rules",children:"Sorry! You are not allowed to create rules."}):Q&&!ce(Q.ruleSourceName)?(0,e.jsx)(H,{title:"Cannot edit rules",children:"Sorry! You are not allowed to edit rules."}):Q?(0,e.jsx)(st,{identifier:Q,id:M},M):C?(0,e.jsx)(pt,{sourceRuleId:C}):(0,e.jsx)(l,{})},[Ee,Ce,ce,C,M,Q,ue]);return(0,e.jsx)(Oe.d,{isLoading:ue,navId:"alert-list",pageNav:it(Q,T),children:we()})},gn=(0,k.Xc)(Pt,{style:"page"})},69179:(Bt,xe,t)=>{t.r(xe),t.d(xe,{default:()=>pe});var e=t(74848),m=t(96540),$=t(54148),p=t(39601),k=t(42418),U=t(39558),v=t(730),B=t(78742),de=t(63066),ee=t(18461),H=t(23662),te=t(3704),he=t(37959),ie=t(49785),_=t(16817),oe=t(32264),Ge=t(55852),Be=t(40276),Ue=t(67061),ze=t(21780),ye=t(3169),se=t(75269),Fe=t(79938),fe=t(28220),le=t(55776),Y=t(57220),qe=t(16293),L=t(76648),Ne=t(84029),ct=t(53534),dt=t(31099),je=t(1723),b=t(95305),Se=t(51682);function Ie({ruleForm:E,alertUid:f}){const y=(0,ie.mN)({mode:"onSubmit",defaultValues:E,shouldFocusError:!0}),j=!!E,w=(0,ye._2)(),{returnTo:q}=(0,le.h)("/alerting/list"),[ae,K]=(0,m.useState)(void 0),[F,_e]=(0,m.useState)(""),[yt,He]=(0,m.useState)(E?.evaluateEvery??de.T6),jt=(0,m.useCallback)(()=>{w.error("There are errors in the form. Please correct them and try again!")},[w]),et=(Le="")=>{_e(Le)},tt=(0,m.useCallback)(Le=>{if(F!==""){w.error(F);return}K(Le)},[F,w]),Ye=(0,m.useCallback)(()=>{K(void 0)},[K]),St=(0,m.useMemo)(()=>[(0,e.jsx)(Ge.z9,{href:q,size:"sm",variant:"secondary",onClick:()=>tt(void 0),children:"Cancel"},"cancel"),(0,e.jsx)(Ge.$n,{size:"sm",onClick:y.handleSubmit(Le=>tt(Le),jt),children:"Export"},"export-rule")],[y,jt,q,tt]);return(0,ze.YO)(St),(0,e.jsx)(e.Fragment,{children:(0,e.jsxs)(ie.Op,{...y,children:[!oe.$.featureToggles.singleTopNav&&(0,e.jsx)(se.H,{actions:St}),(0,e.jsx)("form",{onSubmit:Le=>Le.preventDefault(),children:(0,e.jsx)("div",{children:(0,e.jsx)(Be.E,{autoHeightMin:"100%",hideHorizontalTrack:!0,children:(0,e.jsxs)(Ue.B,{direction:"column",gap:3,children:[(0,e.jsx)(ct.H,{}),(0,e.jsx)(Se.N,{editingExistingRule:j,onDataChange:et}),(0,e.jsx)(je.R,{evaluateEvery:yt,setEvaluateEvery:He,existing:!!j,enableProvisionedGroups:!0}),(0,e.jsx)(b.N,{alertUid:f}),(0,e.jsx)(dt.A,{})]})})})}),ae&&(0,e.jsx)(Ze,{exportValues:ae,onClose:Ye,uid:f})]})})}const Qe=(E,f)=>{const{dsFeatures:y}=(0,v.O3)(Y.hY),j=y?.rulerConfig;return(0,_.A)(async()=>j?await(0,fe.HO)(j,E,f):void 0,[j,E,f])},De=(E,f,y)=>{const j=(0,de.Z9)(f),w={...j,grafana_alert:{...j.grafana_alert,uid:E}};if(y?.rules){let q=!1;const ae=y.rules.map(K=>(0,H.lT)(K)&&K.grafana_alert.uid===E?(q=!0,w):K);return q||ae.push(w),{...y,rules:ae}}else return{name:y?.name??"",rules:[w]}},ut=(E,f)=>{const y=Qe(E.folder?.uid??"",E.group);return{payload:(0,m.useMemo)(()=>De(f,E,y?.value),[f,y,E]),loadingGroup:y.loading}},Re=({exportFormat:E,exportValues:f,onClose:y,uid:j})=>{const[w,q]=Fe.hK.endpoints.exportModifiedRuleGroup.useMutation(),{loadingGroup:ae,payload:K}=ut(f,j),F=f.folder?.uid??"";if((0,m.useEffect)(()=>{!ae&&w({payload:K,format:E,nameSpaceUID:F})},[F,E,K,w,ae]),q.isLoading)return(0,e.jsx)(U._,{text:"Loading...."});const _e=`modify-export-${K.name}-${j}-${new Date().getTime()}`;return(0,e.jsx)(qe.J,{format:E,textDefinition:q.data??"",downloadFileName:_e,onClose:y})},Ze=(0,m.memo)(({onClose:E,exportValues:f,uid:y})=>{const[j,w]=(0,m.useState)("yaml");return(0,e.jsx)(L.m,{title:"Export Group",activeTab:j,onTabChange:w,onClose:E,formatProviders:Object.values(Ne.sl),children:(0,e.jsx)(Re,{exportFormat:j,onClose:E,exportValues:f,uid:y})})});Ze.displayName="GrafanaRuleDesignExporter";function pe(){const{id:E}=(0,$.g)(),f=(0,m.useMemo)(()=>ee.x6(E,!0),[E]);return f?(0,e.jsx)(mt,{children:(0,e.jsx)(be,{ruleIdentifier:f})}):(0,e.jsx)(mt,{children:(0,e.jsx)(k.F,{title:"Invalid rule ID",severity:"error",children:"The rule UID in the page URL is invalid. Please check the URL and try again."})})}function mt({children:E}){return(0,e.jsx)(he.d,{navId:"alert-list",pageNav:{text:"Modify export",subTitle:"Modify the current alert rule and export the rule definition in the format of your choice. Any changes you make will not be saved."},children:E})}function be({ruleIdentifier:E}){const{loading:f,error:y,result:j}=(0,v.Ll)({ruleIdentifier:E});return f?(0,e.jsx)(U._,{text:"Loading the rule..."}):y?(0,e.jsx)(k.F,{title:"Cannot load modify export",severity:"error",children:(0,B.JZ)(y)}):!j&&!f?(0,e.jsx)(k.F,{title:"Cannot load the rule. The rule does not exist",buttonContent:"Go back to alert list",onRemove:()=>p.Ny.replace((0,te.G)("/alerting/list"))}):j&&!(0,H.lT)(j.rule)?(0,e.jsx)(k.F,{title:"This rule is not a Grafana-managed alert rule",buttonContent:"Go back to alert list",onRemove:()=>p.Ny.replace((0,te.G)("/alerting/list"))}):j&&(0,H.lT)(j.rule)?(0,e.jsx)(Ie,{ruleForm:(0,de.ir)(j),alertUid:j.rule.grafana_alert.uid}):(0,e.jsx)(k.F,{title:"Unknown error"})}},53534:(Bt,xe,t)=>{t.d(xe,{H:()=>te});var e=t(74848),m=t(49785),$=t(13544),p=t(94753),k=t(67061),U=t(88575),v=t(10354),B=t(86590),de=t(23662),ee=t(271);const H=he=>({message:(0,de.pq)(he)?"Recording rule metric must be valid metric name. It may only contain letters, numbers, and colons. It may not contain whitespace.":"Recording rule name must be valid metric name. It may only contain letters, numbers, and colons. It may not contain whitespace.",value:/^[a-zA-Z_:][a-zA-Z0-9_:]*$/}),te=()=>{const{register:he,watch:ie,formState:{errors:_}}=(0,m.xW)(),oe=ie("type");if(!oe)return null;const Ge=(0,de.vE)(oe),Be=(0,de.pq)(oe),Ue=(0,de.OF)(oe),ze=Be?"recording rule and metric":"recording rule",ye=Ge?"recording rule":"alert rule",se=Ge?ze:"alert rule";return(0,e.jsx)(ee.P,{stepNo:1,title:`Enter ${se} name`,description:(0,e.jsxs)(p.E,{variant:"bodySmall",color:"secondary",children:["Enter a name to identify your ",se,"."]}),children:(0,e.jsxs)(k.B,{direction:"column",children:[(0,e.jsx)(U.D,{label:"Name",error:_?.name?.message,invalid:!!_.name?.message,children:(0,e.jsx)(v.p,{"data-testid":$.Tp.components.AlertRules.ruleNameField,id:"name",width:38,...he("name",{required:{value:!0,message:"Must enter a name"},pattern:Ue?H(B.Z.cloudRecording):void 0}),"aria-label":"name",placeholder:`Give your ${ye} a name`})}),Be&&(0,e.jsx)(U.D,{label:"Metric",error:_?.metric?.message,invalid:!!_.metric?.message,children:(0,e.jsx)(v.p,{id:"metric",width:38,...he("metric",{required:{value:!0,message:"Must enter a metric name"},pattern:H(B.Z.grafanaRecording)}),"aria-label":"metric",placeholder:"Give your metric a name"})})]})})}},95305:(Bt,xe,t)=>{t.d(xe,{N:()=>Zt});var e=t(74848),m=t(32196),$=t(96540),p=t(49785),k=t(32264),U=t(40845),v=t(67061),B=t(94753),de=t(94354),ee=t(14578),H=t(60021),te=t(82843),he=t(86590),ie=t(57220),_=t(23662),oe=t(19338),Ge=t(271),Be=t(70383),Ue=t(57418),ze=t(79633),ye=t(21308),se=t(77141);const Fe=({receivers:l})=>(0,e.jsx)(v.B,{direction:"column",gap:0,children:(0,e.jsx)("div",{children:l.map((R,P)=>{const A=R[ye.MX],z=R[ye.sW],O=A.name+P;return(0,e.jsx)(ze.uO,{name:A.name,type:R.type,description:(0,se.aM)(R),pluginMetadata:z},O)})})});var fe=t(88575),le=t(72093),Y=t(72109),qe=t(39184),L=t(3704);function Ne({alertManager:l,onSelectContactPoint:R}){const{control:P,watch:A,trigger:z}=(0,p.xW)(),O=A(`contactPoints.${l}.selectedContactPoint`),N=(0,$.useCallback)(()=>{O&&z(`contactPoints.${l}.selectedContactPoint`,{shouldFocus:!0})},[l,O,z]);return(0,$.useEffect)(()=>{N()},[N]),(0,e.jsx)(v.B,{direction:"column",children:(0,e.jsx)(v.B,{direction:"row",alignItems:"center",children:(0,e.jsx)(fe.D,{label:"Contact point","data-testid":"contact-point-picker",children:(0,e.jsx)(p.xI,{render:({field:{onChange:W},fieldState:{error:Me}})=>(0,e.jsxs)(e.Fragment,{children:[(0,e.jsxs)(v.B,{children:[(0,e.jsx)(qe.u,{selectProps:{onChange:(Ke,nt)=>{W(Ke?.value?.name),R(Ke?.value)},width:50},showRefreshButton:!0,selectedContactPointName:O}),(0,e.jsx)(ct,{})]}),Me&&(0,e.jsx)(le.P,{children:Me?.message})]}),rules:{required:{value:!0,message:"Contact point is required."}},control:P,name:`contactPoints.${l}.selectedContactPoint`})})})})}function ct(){return(0,e.jsx)(Y.Y,{external:!0,href:(0,L.G)("/alerting/notifications"),"aria-label":"View or create contact points",children:"View or create contact points"})}var dt=t(39127),je=t(79657);function b({alertmanager:l}){const{control:R,formState:{errors:P}}=(0,p.xW)();return(0,e.jsx)(fe.D,{label:"Mute timings","data-testid":"am-mute-timing-select",description:"Select a mute timing to define when not to send notifications for this alert rule",invalid:!!P.contactPoints?.[l]?.muteTimeIntervals,children:(0,e.jsx)(p.xI,{render:({field:{onChange:A,ref:z,...O}})=>(0,e.jsx)(dt.A,{alertmanager:l,selectProps:{...O,onChange:N=>A((0,je.ie)(N))}}),control:R,name:`contactPoints.${l}.muteTimeIntervals`})})}var Se=t(14186),Ie=t(15292),Qe=t(90182),De=t(5342),ut=t(99903),Re=t(27835),Ze=t(33915),pe=t(97174);function mt({alertManager:l}){const R=(0,U.of)(ut.t),{register:P,formState:{errors:A},getValues:z}=(0,p.xW)();return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(fe.D,{label:pe.G.groupWait.label,description:pe.G.groupWait.description,invalid:!!A.contactPoints?.[l]?.groupWaitValue,error:A.contactPoints?.[l]?.groupWaitValue?.message,children:(0,e.jsx)(Ze.V,{...P(`contactPoints.${l}.groupWaitValue`,{validate:je.hH}),"aria-label":pe.G.groupWait.ariaLabel,className:R.promDurationInput,placeholder:Re.H.group_wait})}),(0,e.jsx)(fe.D,{label:pe.G.groupInterval.label,description:pe.G.groupInterval.description,invalid:!!A.contactPoints?.[l]?.groupIntervalValue,error:A.contactPoints?.[l]?.groupIntervalValue?.message,children:(0,e.jsx)(Ze.V,{...P(`contactPoints.${l}.groupIntervalValue`,{validate:je.hH}),"aria-label":pe.G.groupInterval.ariaLabel,className:R.promDurationInput,placeholder:Re.H.group_interval})}),(0,e.jsx)(fe.D,{label:pe.G.repeatInterval.label,description:pe.G.repeatInterval.description,invalid:!!A.contactPoints?.[l]?.repeatIntervalValue,error:A.contactPoints?.[l]?.repeatIntervalValue?.message,children:(0,e.jsx)(Ze.V,{...P(`contactPoints.${l}.repeatIntervalValue`,{validate:O=>{const N=z(`contactPoints.${l}.repeatIntervalValue`);return(0,je.DY)(O,N)}}),"aria-label":pe.G.repeatInterval.ariaLabel,className:R.promDurationInput,placeholder:Re.H.repeat_interval})})]})}const be=["grafana_folder","alertname"],E={groupWaitValue:Re.H.group_wait,groupIntervalValue:Re.H.group_interval,repeatIntervalValue:Re.H.repeat_interval},f="...",y=({alertManager:l})=>{const R=(0,U.of)(ut.t),{control:P,watch:A,register:z,setValue:O,formState:{errors:N}}=(0,p.xW)(),[W,Me]=(0,$.useState)((0,je.gY)([])),{groupIntervalValue:Ke,groupWaitValue:nt,repeatIntervalValue:pt}=E,Pe=A(`contactPoints.${l}.overrideGrouping`),ot=A(`contactPoints.${l}.overrideTimings`),rt=A(`contactPoints.${l}.groupBy`)?.length??0,st=(0,U.of)(j);return(0,$.useEffect)(()=>{Pe&&rt===0&&O(`contactPoints.${l}.groupBy`,be)},[Pe,O,l,rt]),(0,e.jsxs)(v.B,{direction:"column",children:[(0,e.jsxs)(v.B,{direction:"row",gap:1,alignItems:"center",justifyContent:"space-between",children:[(0,e.jsx)(Se.I,{label:"Override grouping",transparent:!0,className:st.switchElement,children:(0,e.jsx)(Ie.d,{id:"override-grouping-toggle",...z(`contactPoints.${l}.overrideGrouping`)})}),!Pe&&(0,e.jsxs)(B.E,{variant:"body",color:"secondary",children:["Grouping: ",(0,e.jsx)("strong",{children:be.join(", ")})]})]}),Pe&&(0,e.jsx)(fe.D,{label:"Group by",description:"Combine multiple alerts into a single notification by grouping them by the same label values. If empty, it is inherited from the default notification policy.",...z(`contactPoints.${l}.groupBy`),invalid:!!N.contactPoints?.[l]?.groupBy,className:st.optionalContent,children:(0,e.jsx)(p.xI,{rules:{validate:Oe=>!Oe||Oe.length===0?"At least one group by option is required.":Oe.length===1&&Oe[0]===f||be.every(Dt=>Oe.includes(Dt))?!0:`Group by must include ${be.join(", ")}`},render:({field:{onChange:Oe,ref:at,...Dt},fieldState:{error:Rt}})=>(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(Qe.KF,{"aria-label":"Group by",...Dt,allowCustomValue:!0,className:R.input,onCreateOption:it=>{Me(Pt=>[...Pt,(0,je.Mk)(it)]),O(`contactPoints.${l}.groupBy`,[...Dt.value,it])},onChange:it=>Oe((0,je.ie)(it)),options:[...je.Yl,...W],components:{MultiValueRemove(it){const{data:Pt}=it;return Pt.isFixed?null:(0,De.p)(it)}}}),Rt&&(0,e.jsx)(le.P,{children:Rt.message})]}),name:`contactPoints.${l}.groupBy`,control:P})}),(0,e.jsxs)(v.B,{direction:"row",gap:1,alignItems:"center",justifyContent:"space-between",children:[(0,e.jsx)(Se.I,{label:"Override timings",transparent:!0,className:st.switchElement,children:(0,e.jsx)(Ie.d,{id:"override-timings-toggle",...z(`contactPoints.${l}.overrideTimings`)})}),!ot&&(0,e.jsxs)(B.E,{variant:"body",color:"secondary",children:["Group wait: ",(0,e.jsxs)("strong",{children:[nt,", "]}),"Group interval: ",(0,e.jsxs)("strong",{children:[Ke,", "]}),"Repeat interval: ",(0,e.jsx)("strong",{children:pt})]})]}),ot&&(0,e.jsx)("div",{className:st.optionalContent,children:(0,e.jsx)(mt,{alertManager:l})})]})},j=l=>({switchElement:(0,m.css)({flexFlow:"row-reverse",gap:l.spacing(1),alignItems:"center"}),optionalContent:(0,m.css)({marginLeft:"49px",marginBottom:l.spacing(1)})});function w({alertManager:l}){const R=(0,U.of)(q),P=l.name,[A,z]=(0,$.useState)(),O=Me=>{z(Me)},{watch:N}=(0,p.xW)(),W=N(`contactPoints.${P}.overrideGrouping`)||N(`contactPoints.${P}.overrideTimings`)||N(`contactPoints.${P}.muteTimeIntervals`)?.length>0;return(0,e.jsxs)(v.B,{direction:"column",children:[(0,e.jsxs)(v.B,{direction:"row",alignItems:"center",children:[(0,e.jsx)("div",{className:R.firstAlertManagerLine}),(0,e.jsxs)("div",{className:R.alertManagerName,children:["Alertmanager:",(0,e.jsx)("img",{src:l.imgUrl,alt:"Alert manager logo",className:R.img}),P]}),(0,e.jsx)("div",{className:R.secondAlertManagerLine})]}),(0,e.jsx)(v.B,{direction:"row",gap:1,alignItems:"center",children:(0,e.jsx)(Ne,{alertManager:P,onSelectContactPoint:O})}),A?.grafana_managed_receiver_configs&&(0,e.jsx)(Fe,{receivers:A.grafana_managed_receiver_configs}),(0,e.jsx)("div",{className:R.routingSection,children:(0,e.jsx)(Ue.M,{label:"Muting, grouping and timings (optional)",isOpen:W,className:R.collapsableSection,children:(0,e.jsxs)(v.B,{direction:"column",gap:1,children:[(0,e.jsx)(b,{alertmanager:P}),(0,e.jsx)(y,{alertManager:P})]})})})]})}const q=l=>({firstAlertManagerLine:(0,m.css)({height:1,width:l.spacing(4),backgroundColor:l.colors.secondary.main}),alertManagerName:(0,m.css)({with:"fit-content"}),secondAlertManagerLine:(0,m.css)({height:"1px",width:"100%",flex:1,backgroundColor:l.colors.secondary.main}),img:(0,m.css)({marginLeft:l.spacing(2),width:l.spacing(3),height:l.spacing(3),marginRight:l.spacing(1)}),collapsableSection:(0,m.css)({width:"fit-content",fontSize:l.typography.body.fontSize}),routingSection:(0,m.css)({display:"flex",flexDirection:"column",maxWidth:l.breakpoints.values.xl,border:`solid 1px ${l.colors.border.weak}`,borderRadius:l.shape.radius.default,padding:`${l.spacing(1)} ${l.spacing(2)}`,marginTop:l.spacing(2)})});function ae(){const{getValues:l}=(0,p.xW)(),R=l("contactPoints"),z=(0,ie.sq)("notification").availableInternalDataSources.filter(N=>N.hasConfigurationAPI);return(0,$.useMemo)(()=>z.map(N=>{const W=R?R[N.name]:void 0;return{alertManager:N,selectedContactPoint:W?.selectedContactPoint??"",routeSettings:{muteTimeIntervals:W?.muteTimeIntervals??[],overrideGrouping:W?.overrideGrouping??!1,groupBy:W?.groupBy??[],overrideTimings:W?.overrideTimings??!1,groupWaitValue:W?.groupWaitValue??"",groupIntervalValue:W?.groupIntervalValue??"",repeatIntervalValue:W?.repeatIntervalValue??""}}}),[z,R]).map((N,W)=>(0,e.jsx)(Be.b9,{accessType:"notification",alertmanagerSourceName:N.alertManager.name,children:(0,e.jsx)(w,{alertManager:N.alertManager})},N.alertManager.name+W))}var K=t(37390),F=t(97171);function _e({isOpen:l,onClose:R,dataSourceName:P,initialLabels:A}){return(0,e.jsx)(K.a,{title:"Edit labels",closeOnEscape:!0,isOpen:l,onDismiss:()=>R(),children:(0,e.jsx)(F.C1,{dataSourceName:P,onClose:R,initialLabels:A})})}var yt=t(55852),He=t(8484);function jt({onEditClick:l}){const{watch:R}=(0,p.xW)(),P=R("labels"),A=R("type"),O=(A?(0,_.vE)(A):!1)?(0,He.t)("alerting.alertform.labels.recording","Add labels to your rule."):(0,He.t)("alerting.alertform.labels.alerting","Add labels to your rule for searching, silencing, or routing to a notification policy."),N=Object.keys(P).length>0&&P.some(W=>W.key||W.value);return(0,e.jsxs)(v.B,{direction:"column",gap:2,children:[(0,e.jsxs)(v.B,{direction:"column",gap:1,children:[(0,e.jsx)(B.E,{element:"h5",children:"Labels"}),(0,e.jsxs)(v.B,{direction:"row",gap:1,children:[(0,e.jsx)(B.E,{variant:"bodySmall",color:"secondary",children:O}),(0,e.jsx)(oe.G,{contentText:`The dropdown only displays labels that you have previously used for alerts.
              Select a label from the options below or type in a new one.`,title:"Labels"})]})]}),(0,e.jsxs)(v.B,{direction:"row",gap:1,alignItems:"center",children:[(0,e.jsx)(F.DI,{labels:P}),N?(0,e.jsx)(yt.$n,{variant:"secondary",type:"button",onClick:l,size:"sm",children:"Edit labels"}):(0,e.jsxs)(v.B,{direction:"row",gap:2,alignItems:"center",children:[(0,e.jsx)(B.E,{children:"No labels selected"}),(0,e.jsx)(yt.$n,{icon:"plus",type:"button",variant:"secondary",onClick:l,size:"sm",children:"Add labels"})]})]})]})}var et=t(2543),tt=t(39558),Ye=t(79938),St=t(87286);const Le=(0,$.lazy)(()=>t.e(9711).then(t.bind(t,39711))),It=({alertQueries:l,customLabels:R,condition:P,folder:A,alertName:z,alertUid:O})=>{const N=(0,U.of)(ft),W=!P||!A,Me=Ye.hK.endpoints.preview,[Ke,{data:nt=[],isLoading:pt,isUninitialized:Pe}]=Me.useMutation(),ot=(0,et.compact)(nt.flatMap(at=>at?.labels)),rt=()=>{!A||!P||Ke({alertQueries:l,condition:P,customLabels:R,folder:A,alertName:z,alertUid:O})},st=(0,ie.cy)("notification"),Oe=st.length===1;return(0,e.jsxs)(St.B,{direction:"column",children:[(0,e.jsxs)("div",{className:N.routePreviewHeaderRow,children:[(0,e.jsxs)("div",{className:N.previewHeader,children:[(0,e.jsx)(B.E,{element:"h5",children:"Alert instance routing preview"}),pt&&Pe&&(0,e.jsx)(B.E,{color:"secondary",variant:"bodySmall",children:"Loading..."}),Pe?(0,e.jsx)(B.E,{color:"secondary",variant:"bodySmall",children:'When you have your folder selected and your query and labels are configured, click "Preview routing" to see the results here.'}):(0,e.jsx)(B.E,{color:"secondary",variant:"bodySmall",children:"Based on the labels added, alert instances are routed to the following notification policies. Expand each notification policy below to view more details."})]}),(0,e.jsx)("div",{className:N.button,children:(0,e.jsx)(yt.$n,{icon:"sync",variant:"secondary",type:"button",onClick:rt,disabled:W,children:"Preview routing"})})]}),!pt&&!Pe&&ot.length>0&&(0,e.jsx)($.Suspense,{fallback:(0,e.jsx)(tt._,{text:"Loading preview..."}),children:st.map(at=>(0,e.jsx)(Le,{alertManagerSource:at,potentialInstances:ot,onlyOneAM:Oe},at.name))})]})},ft=l=>({collapsableSection:(0,m.css)({width:"auto",border:0}),previewHeader:(0,m.css)({margin:0}),routePreviewHeaderRow:(0,m.css)({display:"flex",flexDirection:"row",justifyContent:"space-between",alignItems:"flex-start",marginTop:l.spacing(1)}),collapseLabel:(0,m.css)({flex:1}),button:(0,m.css)({justifyContent:"flex-end"}),tagsInDetails:(0,m.css)({display:"flex",justifyContent:"flex-start",flexWrap:"wrap"}),policyPathItemMatchers:(0,m.css)({display:"flex",flexDirection:"row",gap:l.spacing(1)})});var Ft=(l=>(l.NotificationPolicy="notification policy",l.ContactPoint="contact point",l))(Ft||{});function zt(){const{useGetGrafanaAlertingConfigurationStatusQuery:l}=te.m,{currentData:R}=l(void 0);return R?.alertmanagersChoice===H.nA.Internal||R?.alertmanagersChoice===H.nA.All}const Zt=({alertUid:l})=>{const{watch:R,getValues:P,setValue:A}=(0,p.xW)(),z=(0,U.of)(Vt),[O]=R(["type","labels","queries","condition","folder","name","manualRouting"]),[N,W]=(0,$.useState)(!1),Me=R("dataSourceName")??ie.hY,Ke=k.$.featureToggles.alertingSimplifiedRouting??!1,nt=O===he.Z.grafana,pt=zt(),Pe=O===he.Z.grafana&&Ke&&pt;function ot(rt){rt&&A("labels",rt),W(!1)}return O?(0,e.jsxs)(Ge.P,{stepNo:4,title:(0,_.vE)(O)?"Add labels":"Configure labels and notifications",description:(0,e.jsx)(v.B,{direction:"row",gap:.5,alignItems:"center",children:(0,_.vE)(O)?(0,e.jsx)(B.E,{variant:"bodySmall",color:"secondary",children:"Add labels to help you better manage your recording rules."}):Pe&&(0,e.jsx)(B.E,{variant:"bodySmall",color:"secondary",children:"Select who should receive a notification when an alert rule fires."})}),fullWidth:!0,children:[(0,e.jsx)(jt,{onEditClick:()=>W(!0)}),(0,e.jsx)(_e,{isOpen:N,onClose:ot,dataSourceName:Me,initialLabels:P("labels")}),Pe&&(0,e.jsxs)("div",{className:z.configureNotifications,children:[(0,e.jsx)(B.E,{element:"h5",children:"Notifications"}),(0,e.jsx)(B.E,{variant:"bodySmall",color:"secondary",children:"Select who should receive a notification when an alert rule fires."})]}),Pe?(0,e.jsx)(Ht,{alertUid:l}):nt?(0,e.jsx)(wt,{alertUid:l}):null]}):null};function Ht({alertUid:l}){const{watch:R,setValue:P}=(0,p.xW)(),A=(0,U.of)(Vt),[z]=R(["manualRouting"]),O=[{label:"Select contact point",value:"contact point"},{label:"Use notification policy",value:"notification policy"}],N=W=>{P("manualRouting",W==="contact point")};return(0,e.jsxs)(v.B,{direction:"column",gap:2,children:[(0,e.jsx)(v.B,{direction:"column",children:(0,e.jsx)(de.z,{options:O,value:z?"contact point":"notification policy",onChange:N,className:A.routingOptions})}),(0,e.jsx)(Jt,{manualRouting:z}),z?(0,e.jsx)(ae,{}):(0,e.jsx)(wt,{alertUid:l})]})}function wt({alertUid:l}){const{watch:R}=(0,p.xW)(),[P,A,z,O,N]=R(["labels","queries","condition","folder","name","manualRouting"]);return(0,e.jsx)(It,{alertQueries:A,customLabels:P,condition:z,folder:O,alertName:N,alertUid:l})}function Yt(){return(0,e.jsx)(oe.G,{contentText:(0,e.jsxs)(v.B,{gap:1,direction:"column",children:[(0,e.jsx)(v.B,{direction:"column",gap:0,children:(0,e.jsx)(e.Fragment,{children:"Firing alert instances are routed to notification policies based on matching labels. The default notification policy matches all alert instances."})}),(0,e.jsxs)(v.B,{direction:"column",gap:0,children:[(0,e.jsx)(e.Fragment,{children:"Custom labels change the way your notifications are routed. First, add labels to your alert rule and then connect them to your notification policy by adding label matchers."}),(0,e.jsx)("a",{href:"https://grafana.com/docs/grafana/latest/alerting/fundamentals/notifications/notification-policies/",target:"_blank",rel:"noreferrer",children:(0,e.jsxs)(B.E,{color:"link",children:["Read about notification policies. ",(0,e.jsx)(ee.I,{name:"external-link-alt"})]})})]})]}),title:"Notification routing"})}function Kt(){return(0,e.jsx)(oe.G,{contentText:(0,e.jsxs)(e.Fragment,{children:["Select a contact point to notify all recipients in it.",(0,e.jsx)("br",{}),(0,e.jsx)("br",{}),"Notifications for firing alert instances are grouped based on folder and alert rule name.",(0,e.jsx)("br",{}),"The wait time before sending the first notification for a new group of alerts is 30 seconds.",(0,e.jsx)("br",{}),"The waiting time before sending a notification about changes in the alert group after the first notification has been sent is 5 minutes.",(0,e.jsx)("br",{}),"The wait time before resending a notification that has already been sent successfully is 4 hours.",(0,e.jsx)("br",{}),"Grouping and wait time values are defined in your default notification policy."]}),externalLink:"https://grafana.com/docs/grafana/latest/alerting/fundamentals/notifications/",linkText:"Read more about notifications",title:"Notify contact points"})}const Jt=({manualRouting:l})=>(0,e.jsxs)(v.B,{alignItems:"center",children:[(0,e.jsx)(B.E,{variant:"bodySmall",color:"secondary",children:l?"Notifications for firing alerts are routed to a selected contact point.":"Notifications for firing alerts are routed to contact points based on matching labels and the notification policy tree."}),l?(0,e.jsx)(Kt,{}):(0,e.jsx)(Yt,{})]}),Vt=l=>({routingOptions:(0,m.css)({width:"fit-content"}),configureNotifications:(0,m.css)({display:"flex",flexDirection:"column",marginTop:l.spacing(2)})})},67986:(Bt,xe,t)=>{t.d(xe,{L:()=>Ze,g:()=>pe});var e=t(74848),m=t(32196),$=t(96540),p=t(49785),k=t(1604),U=t(46662),v=t(72724),B=t(39070),de=t(19347),ee=t(40845),H=t(67061),te=t(55852),he=t(42418),ie=t(62467),_=t(81160),oe=t(66847),Ge=t(1005),Be=t(72495),Ue=t(89667),ze=t(43127),ye=t(17172),se=t(12091);function Fe(f){return"expr"in f}function fe(f){return"grafana_condition"in f}var le=t(86590),Y=t(57220);function qe(f){if(Fe(f))return L(f,f.dataSourceUid,le.Z.cloudAlerting);if(fe(f))return L(f,Y.hY,le.Z.grafana);throw new Error("unsupported preview rule request")}function L(f,y,j){return(0,Be.k)({whileLoading:Ne(j),source:(0,ye.AI)().fetch({method:"POST",url:`/api/v1/rule/test/${y}`,data:f}).pipe((0,_.T)(({data:w})=>Ne(j,{state:B.Gu.Done,series:w.instances.map(Ue.or)})),(0,oe.W)(w=>(0,ie.of)(Ne(j,{state:B.Gu.Error,error:(0,se.u)(w)}))),(0,Ge.u)())})}function Ne(f,y={}){return{ruleType:f,data:{state:B.Gu.Loading,series:[],timeRange:(0,ze.E2)(),...y}}}var ct=t(36135),dt=t(23662),je=t(70713),b=t(1173),Se=t(24308),Ie=t(52622),Qe=t(88467);function De(f){const{preview:y}=f,j=(0,ee.of)(ut),w={defaults:{},overrides:[{matcher:{id:b.Ct.byName,options:"Info"},properties:[{id:"custom.displayMode",value:Ie.ob.JSONView}]}]};if(!y)return null;const{data:q,ruleType:ae}=y;return q.state===B.Gu.Loading?(0,e.jsx)("div",{className:j.container,children:(0,e.jsx)("span",{children:"Loading preview..."})}):q.state===B.Gu.Error?(0,e.jsx)("div",{className:j.container,children:q.error?(0,Qe.CZ)(q.error):"Failed to preview alert rule"}):(0,e.jsxs)("div",{className:j.container,children:[(0,e.jsxs)("span",{children:["Preview based on the result of running the query, for this moment."," ",ae===le.Z.grafana?"Configuration for `no data` and `error handling` is not applied.":null]}),(0,e.jsx)("div",{className:j.table,children:(0,e.jsx)(je.Ay,{children:({width:K,height:F})=>(0,e.jsx)("div",{style:{width:`${K}px`,height:`${F}px`},children:(0,e.jsx)(Se.m,{title:"",width:K,height:F,pluginId:"table",data:q,fieldConfig:w})})})})]})}function ut(f){return{container:(0,m.css)({margin:`${f.spacing(2)} 0`}),table:(0,m.css)({flex:"1 1 auto",height:"135px",marginTop:f.spacing(2),border:`1px solid ${f.colors.border.medium}`,borderRadius:f.shape.radius.default})}}const Re=["type","dataSourceName","condition","queries","expression"];function Ze(){const f=(0,ee.of)(E),[y,j]=pe(),{watch:w}=(0,p.xW)(),[q,ae,K]=w(["type","condition","queries"]),{allDataSourcesAvailable:F}=(0,ct.g)(K);if(!q||(0,dt.s_)(q))return null;const _e=!!ae&&F;return(0,e.jsxs)("div",{className:f.container,children:[(0,e.jsxs)(H.B,{children:[F&&(0,e.jsx)(te.$n,{disabled:!_e,type:"button",variant:"primary",onClick:j,children:"Preview alerts"}),!F&&(0,e.jsx)(he.F,{title:"Preview is not available",severity:"warning",children:"Cannot display the query preview. Some of the data sources used in the queries are not available."})]}),(0,e.jsx)(De,{preview:y})]})}function pe(){const[f,y]=(0,$.useState)(),{getValues:j}=(0,p.xW)(),w=(0,k.A)(),q=(0,$.useCallback)(()=>{const ae=j(Re),K=mt(ae);qe(K).pipe((0,U.v)(F=>!be(F),!0)).subscribe(F=>{w()&&y(F)})},[j,w]);return[f,q]}function mt(f){const[y,j,w,q,ae]=f,K=(0,de.l)().getInstanceSettings(j);if(!K)throw new Error(`Cannot find data source settings for ${j}`);switch(y){case le.Z.cloudAlerting:return{dataSourceUid:K.uid,dataSourceName:j,expr:ae};case le.Z.grafana:return{grafana_condition:{condition:w,data:q,now:(0,v.M7)(Date.now())}};default:throw new Error(`Alert type ${y} not supported by preview.`)}}function be(f){switch(f.data.state){case B.Gu.Done:case B.Gu.Error:return!0;default:return!1}}function E(f){return{container:(0,m.css)({marginTop:f.spacing(2),maxWidth:`${f.breakpoints.values.xxl}px`})}}},51682:(Bt,xe,t)=>{t.d(xe,{N:()=>Wn});var e=t(74848),m=t(32196),$=t(2543),p=t(96540),k=t(49785),U=t(75059),v=t(43127),B=t(13544),de=t(32264),ee=t(19347),H=t(40845),te=t(67061),he=t(88575),ie=t(56034),_=t(55852),oe=t(42418),Ge=t(96374),Be=t(38138),Ue=t(64539),ze=t(83122),ye=t(14578),se=t(94753),Fe=t(8484),fe=t(55907),le=t(69437),Y=t(66718),qe=t(31678),L=t(57220),Ne=t(61410);function ct(){const n=(0,Ne.$)(o=>o.dataSources);return Object.values(n).map(o=>o.result).filter(o=>!!o?.rulerConfig).map(o=>(0,L.oh)(o.name)).filter(o=>!!o)}var dt=t(39964),je=t(26627),b=t(86590),Se=t(63066),Ie=t(23662),Qe=t(16817),De=t(39070),ut=t(76287),Re=t(41987),Ze=t(64149),pe=t(75214),mt=t(30423),be=t(94822);function E({fields:n}){const r=n.filter(d=>!["State","Info"].includes(d.name)),o=n.findIndex(d=>d.name==="State"),s=n.findIndex(d=>d.name==="Info"),c=r.map(d=>n.indexOf(d)),i=n[o]?.values.length??0,u=[];for(let d=0;d<i;d++){const D=c.map(I=>[n[I].name,n[I].values[d]]),G=n[o]?.values?.[d],h=n[s]?.values?.[d];(0,be.s1)(G)&&u.push({state:G,info:h,labels:Object.fromEntries(D)})}return{instances:u}}function f({preview:n}){const r=(0,H.of)(y),o=E(n);return(0,e.jsxs)("table",{className:r.table,children:[(0,e.jsxs)("caption",{children:[(0,e.jsx)("div",{children:"Alerts preview"}),(0,e.jsx)("span",{children:"Preview based on the result of running the query for this moment."})]}),(0,e.jsx)("thead",{children:(0,e.jsxs)("tr",{children:[(0,e.jsx)("th",{children:"State"}),(0,e.jsx)("th",{children:"Labels"}),(0,e.jsx)("th",{children:"Info"})]})}),(0,e.jsx)("tbody",{children:o.instances.map(({state:s,info:c,labels:i},u)=>{const d=(0,pe.M4)(i);return(0,e.jsxs)("tr",{children:[(0,e.jsx)("td",{children:(0,e.jsx)(mt.C,{state:s})}),(0,e.jsx)("td",{children:(0,e.jsx)(Ze.L,{tags:d,className:r.tagList})}),(0,e.jsx)("td",{children:c&&(0,e.jsx)(ie.m,{content:c,children:(0,e.jsx)(ye.I,{name:"info-circle"})})})]},u)})})]})}const y=n=>({table:(0,m.css)({width:"100%",margin:n.spacing(2,0),caption:{captionSide:"top",color:n.colors.text.primary,"& > span":{fontSize:n.typography.bodySmall.fontSize,color:n.colors.text.secondary}},"td, th":{padding:n.spacing(1,1)},"td + td, th + th":{paddingLeft:n.spacing(3)},"thead th":{"&:nth-child(1)":{width:"80px"},"&:nth-child(2)":{width:"auto"},"&:nth-child(3)":{width:"40px"}},"td:nth-child(3)":{textAlign:"center"},"tbody tr:nth-child(2n + 1)":{backgroundColor:n.colors.background.secondary}}),tagList:(0,m.css)({justifyContent:"flex-start"})});var j=t(67986);const w=({value:n,onChange:r,dataSourceName:o,showPreviewAlertsButton:s=!0})=>{const c=(0,H.of)(q),{mapToValue:i,mapToQuery:u}=ae(o),d=u({refId:"A",hide:!1},n),{error:D,loading:G,value:h}=(0,Qe.A)(()=>(0,ee.l)().get(o),[o]),I=(0,p.useCallback)(re=>{r(i(re))},[r,i]),[ge,We]=(0,j.g)(),ne=async()=>{We()};if(G||h?.name!==o)return null;const Mt=(0,ee.l)().getInstanceSettings(o);if(D||!h||!h?.components?.QueryEditor||!Mt){const re=D?.message||"Data source plugin does not export any Query Editor component";return(0,e.jsxs)("div",{children:["Could not load query editor due to: ",re]})}const Z=ge?.data.state===De.Gu.Done,X=h?.components?.QueryEditor,Xe=ge?.data?.series?.find(re=>re.name==="evaluation results"),Te=Xe&&Xe.fields.some(re=>re.values.length>0);return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(ut.p,{instanceSettings:Mt,children:(0,e.jsx)(X,{query:d,queries:[d],app:Re.Jk.CloudAlerting,onChange:I,onRunQuery:$.noop,datasource:h})}),s&&(0,e.jsxs)("div",{className:c.preview,children:[(0,e.jsx)(_.$n,{type:"button",onClick:ne,disabled:ge?.data.state===De.Gu.Loading,children:"Preview alerts"}),Z&&!Te&&(0,e.jsx)(oe.F,{title:"Alerts preview",severity:"info",className:c.previewAlert,children:"There are no firing alerts for your query."}),Te&&(0,e.jsx)(f,{preview:Xe})]})]})},q=n=>({preview:(0,m.css)({padding:n.spacing(2,0),maxWidth:`${n.breakpoints.values.xl}px`}),previewAlert:(0,m.css)({margin:n.spacing(1,0)})});function ae(n){return(0,p.useMemo)(()=>{switch((0,ee.l)().getInstanceSettings(n)?.type){case"loki":case"prometheus":return{mapToValue:o=>o.expr,mapToQuery:(o,s)=>({...o,expr:s})};default:throw new Error(`${n} is not supported as an expression editor`)}},[n])}var K=t(56528),F=t(52487);const _e=({condition:n,onSetCondition:r,queries:o,panelData:s,onUpdateRefId:c,onRemoveExpression:i,onUpdateExpressionType:u,onUpdateQueryExpression:d})=>{const D=(0,p.useMemo)(()=>o.reduce((h,I)=>(0,le.f)(I.model)?h.concat(I.model):h,[]),[o]),G=(0,H.of)(yt);return(0,e.jsx)("div",{className:G.wrapper,children:D.map(h=>{const I=s[h.refId],ge=n===h.refId,We=I?(0,F.lb)(I):void 0,ne=I?(0,F.yr)(I.series):void 0;return(0,e.jsx)(K.r4,{isAlertCondition:ge,data:I,error:We,warning:ne,queries:o,query:h,onSetCondition:r,onRemoveExpression:i,onUpdateRefId:c,onUpdateExpressionType:u,onChangeQuery:d},h.refId)})})},yt=n=>({wrapper:(0,m.css)({display:"flex",gap:n.spacing(2),alignContent:"stretch",flexWrap:"wrap"})});var He=t(19338),jt=t(91076),et=t(65879),tt=t(22391),Ye=t(10860),St=t(7788),Le=t(31193),It=t(14186),ft=t(10354),Ft=t(25027),zt=t(48514),Zt=t(25968),Ht=t(81875),wt=t(47232),Yt=t(60782),Kt=t(5308);const Jt=({query:n,queryOptions:r,onChangeTimeRange:o,onChangeQueryOptions:s,index:c})=>{const i=(0,H.of)(Vt),[u,d]=(0,p.useState)(!1),D=n.relativeTimeRange?(0,et.relativeToTimeRange)(n.relativeTimeRange):void 0;return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(Yt.G,{content:(0,e.jsxs)("div",{className:i.queryOptions,children:[o&&(0,e.jsx)(It.I,{label:"Time Range",children:(0,e.jsx)(Kt.N,{timeRange:n.relativeTimeRange??(0,v.Cn)(),onChange:G=>o(G,c)})}),(0,e.jsx)(O,{options:r,onChange:G=>s(G,c)}),(0,e.jsx)(N,{options:r,onChange:G=>s(G,c)})]}),closeButton:!0,placement:"bottom-start",children:(0,e.jsxs)("button",{type:"button",className:i.actionLink,onClick:()=>d(!u),children:["Options ",u?(0,e.jsx)(ye.I,{name:"angle-right"}):(0,e.jsx)(ye.I,{name:"angle-down"})]})}),(0,e.jsxs)("div",{className:i.staticValues,children:[(0,e.jsx)("span",{children:(0,wt.KQ)(D?.from).locale("en").fromNow(!0)}),r.maxDataPoints&&(0,e.jsxs)("span",{children:[", MD = ",r.maxDataPoints]}),r.minInterval&&(0,e.jsxs)("span",{children:[", Min. Interval = ",r.minInterval]})]})]})},Vt=n=>{const r=(0,_.my)(n);return{queryOptions:(0,m.css)({"> div":{justifyContent:"space-between"}}),staticValues:(0,m.css)({color:n.colors.text.secondary,marginRight:n.spacing(1)}),actionLink:(0,m.css)(r,{color:n.colors.text.link,cursor:"pointer","&:hover":{textDecoration:"underline"}})}};var l=t(74685);const R=43200,P="1s",A=({data:n,error:r,dsSettings:o,index:s,onChangeDataSource:c,onChangeQuery:i,onChangeTimeRange:u,onRunQueries:d,onRemoveQuery:D,onDuplicateQuery:G,query:h,queries:I,thresholds:ge,thresholdsType:We,onChangeThreshold:ne,condition:Mt,onSetCondition:Z,onChangeQueryOptions:X})=>{const Xe=(0,H.of)(W),[Te,re]=(0,p.useState)(),lt=Te?.getDefaultQuery?Te.getDefaultQuery(Re.Jk.UnifiedAlerting):{},{getValues:Gt}=(0,k.xW)(),tn=Gt("editorSettings.simplifiedQueryEditor")!==!0,ve={...lt,...(0,$.cloneDeep)(h.model)};ve.datasource&&ve.datasource?.uid!==h.datasourceUid&&((0,Ft.fH)("rule query datasource and datasourceUid mismatch",{queryModelDatasourceUid:ve.datasource?.uid||"",queryDatasourceUid:h.datasourceUid,datasourceType:h.model.datasource?.type||"unknown type"}),typeof ve.datasource=="object"&&ve.datasource?ve.datasource.uid=h.datasourceUid:(ve.datasource={},ve.datasource.uid=h.datasourceUid,ve.datasource.type=h.model.datasource?.type,ve.datasource.apiVersion=h.model.datasource?.apiVersion));function dn(){const Ae=(0,H.of)(W);return(0,e.jsx)("div",{className:Ae.dsTooltip,children:(0,e.jsx)(ie.m,{content:(0,e.jsx)(e.Fragment,{children:"Not finding the data source you want? Some data sources are not supported for alerting. Click on the icon for more information."}),children:(0,e.jsx)(ye.I,{name:"info-circle",onClick:()=>window.open(" https://grafana.com/docs/grafana/latest/alerting/fundamentals/data-source-alerting/","_blank")})})})}function nn({query:Ae,error:un,index:Tn,isAdvancedMode:mn=!0}){const on={maxDataPoints:Ae.model.maxDataPoints,minInterval:Ae.model.intervalMs?(0,Zt.yl)(Ae.model.intervalMs):void 0},rn={maxDataPoints:on.maxDataPoints,minInterval:on.minInterval},xt=Mt===Ae.refId;return(0,e.jsxs)(te.B,{direction:"row",alignItems:"center",gap:1,children:[(0,e.jsx)(dn,{}),(0,e.jsx)(Jt,{onChangeTimeRange:u,query:Ae,queryOptions:rn,onChangeQueryOptions:X,index:Tn}),mn&&(0,e.jsx)(Ht.a,{onSetCondition:()=>Z(Ae.refId),isCondition:xt})]})}const En=n.state!==De.Gu.NotStarted,$e=(0,$.cloneDeep)(I.map(Ae=>Ae.model));return(0,e.jsxs)(te.B,{direction:"column",gap:.5,children:[(0,e.jsx)("div",{className:Xe.wrapper,children:(0,e.jsx)(zt.c,{alerting:!0,hideRefId:!tn,hideActionButtons:!tn,collapsable:!1,dataSource:o,onDataSourceLoaded:re,onChangeDataSource:Ae=>c(Ae,s),id:h.refId,index:s,data:n,query:ve,onChange:Ae=>i(Ae,s),onRemoveQuery:D,onAddQuery:()=>G((0,$.cloneDeep)(h)),onRunQuery:d,queries:$e,renderHeaderExtras:()=>(0,e.jsx)(nn,{query:h,index:s,error:r,isAdvancedMode:tn}),app:Re.Jk.UnifiedAlerting,hideHideQueryButton:!0},h.refId)}),En&&(0,e.jsx)(l.j,{data:n,thresholds:ge,thresholdsType:We})]})},z=({children:n})=>{const r=(0,H.of)(W);return(0,e.jsx)("div",{className:r.wrapper,children:n})};function O({options:n,onChange:r}){const o=n.maxDataPoints??"",s=c=>{const i=parseInt(c.target.value,10),u=isNaN(i)||i===0?void 0:i;u!==n.maxDataPoints&&r({...n,maxDataPoints:u})};return(0,e.jsx)(It.I,{labelWidth:24,label:"Max data points",tooltip:"The maximum data points per series. Used directly by some data sources and used in calculation of auto interval. With streaming data this value is used for the rolling buffer.",children:(0,e.jsx)(ft.p,{type:"number",width:10,placeholder:R.toString(),spellCheck:!1,onBlur:s,defaultValue:o})})}function N({options:n,onChange:r}){const o=n.minInterval??"",s=c=>{const i=c.target.value;i!==o&&r({...n,minInterval:i})};return(0,e.jsx)(It.I,{label:"Interval",labelWidth:24,tooltip:(0,e.jsxs)(e.Fragment,{children:["Interval sent to the data source. Recommended to be set to write frequency, for example ",(0,e.jsx)("code",{children:"1m"})," if your data is written every minute."]}),children:(0,e.jsx)(ft.p,{type:"text",width:10,placeholder:P,spellCheck:!1,onBlur:s,defaultValue:o})})}const W=n=>({wrapper:(0,m.css)({label:"AlertingQueryWrapper",marginBottom:n.spacing(1),border:`1px solid ${n.colors.border.weak}`,borderRadius:n.shape.radius.default,button:{overflow:"visible"}}),dsTooltip:(0,m.css)({display:"flex",alignItems:"center","&:hover":{opacity:.85,cursor:"pointer"}})});class Me extends p.PureComponent{constructor(r){super(r),this.onRemoveQuery=o=>{const{queries:s,onQueriesChange:c}=this.props;c(s.filter(i=>i.refId!==o.refId))},this.onChangeTimeRange=(o,s)=>{const{queries:c,onQueriesChange:i}=this.props;i(c.map((u,d)=>d!==s?u:{...u,relativeTimeRange:o}))},this.onChangeQueryOptions=(o,s)=>{const{queries:c,onQueriesChange:i}=this.props;i(c.map((u,d)=>d!==s?u:{...u,model:{...u.model,maxDataPoints:o.maxDataPoints,intervalMs:o.minInterval?et.intervalToMs(o.minInterval):void 0}}))},this.onChangeDataSource=(o,s)=>{const{queries:c,onQueriesChange:i}=this.props,u=c.map((d,D)=>{if(D!==s)return d;const G=this.getDataSourceSettings(d);return o.type===G?.type?Ke(d,o):nt(d,o)});i(u)},this.onChangeQuery=(o,s)=>{const{queries:c,onQueriesChange:i}=this.props;i(c.map((u,d)=>d!==s?u:{...u,refId:o.refId,queryType:u.model.queryType??"",model:{...u.model,...o,datasource:o.datasource}}))},this.onDragEnd=o=>{const{queries:s,onQueriesChange:c}=this.props;if(!o||!o.destination)return;const i=o.source.index,u=o.destination.index;if(i===u)return;const d=Array.from(s),[D]=d.splice(i,1);d.splice(u,0,D),c(d)},this.getDataSourceSettings=o=>(0,ee.l)().getInstanceSettings(o.datasourceUid)}render(){const{queries:r,expressions:o,condition:s}=this.props,c=(0,F.an)([...r,...o],s);return(0,e.jsx)(jt.JY,{onDragEnd:this.onDragEnd,children:(0,e.jsx)(jt.gL,{droppableId:"alerting-queries",direction:"vertical",children:i=>(0,e.jsx)("div",{ref:i.innerRef,...i.droppableProps,children:(0,e.jsxs)(te.B,{direction:"column",children:[r.map((u,d)=>{const D=this.props.condition===u.refId,G=this.props.data?.[u.refId]??{series:[],state:De.Gu.NotStarted},h=this.getDataSourceSettings(u);let I;return G&&D?I=(0,F.zy)(G):G&&(I=(0,F.lb)(G)),h?(0,e.jsx)(A,{index:d,dsSettings:h,data:G,error:I,query:u,onChangeQuery:this.onChangeQuery,onRemoveQuery:this.onRemoveQuery,queries:[...r,...o],onChangeDataSource:this.onChangeDataSource,onDuplicateQuery:this.props.onDuplicateQuery,onChangeTimeRange:this.onChangeTimeRange,onChangeQueryOptions:this.onChangeQueryOptions,thresholds:c[u.refId]?.config,thresholdsType:c[u.refId]?.mode,onRunQueries:this.props.onRunQueries,condition:this.props.condition,onSetCondition:this.props.onSetCondition},u.refId):(0,e.jsx)(pt,{index:d,model:u.model,onUpdateDatasource:()=>{const ge=(0,Le.tR)().getInstanceSettings(null);ge&&this.onChangeDataSource(ge,d)},onRemoveQuery:()=>{this.onRemoveQuery(u)}},`${u.refId}-${d}`)}),i.placeholder]})})})})}}function Ke(n,r){return{...n,model:{...(0,$.omit)(n.model,"datasource"),datasource:(0,tt.p$)(r)},datasourceUid:r.uid}}function nt(n,r){return{refId:n.refId,relativeTimeRange:n.relativeTimeRange,queryType:"",datasourceUid:r.uid,model:{refId:n.refId,hide:!1,datasource:(0,tt.p$)(r)}}}const pt=({index:n,onUpdateDatasource:r,onRemoveQuery:o,model:s})=>{const c=s.refId,[i,u]=(0,p.useState)(!1),d=()=>{u(G=>!G)},D=()=>{r()};return(0,e.jsx)(z,{children:(0,e.jsxs)(St.u,{title:c,draggable:!0,index:n,id:c,isOpen:!0,collapsable:!1,children:[(0,e.jsxs)(Ye.Z,{children:[(0,e.jsx)(Ye.Z.Heading,{children:"This datasource has been removed"}),(0,e.jsx)(Ye.Z.Description,{children:"The datasource for this query was not found, it was either removed or is not installed correctly."}),(0,e.jsx)(Ye.Z.Figure,{children:(0,e.jsx)(ye.I,{name:"question-circle"})}),(0,e.jsxs)(Ye.Z.Actions,{children:[(0,e.jsx)(_.$n,{variant:"secondary",onClick:D,children:"Update datasource"},"update"),(0,e.jsx)(_.$n,{variant:"destructive",onClick:o,children:"Remove query"},"remove")]}),(0,e.jsx)(Ye.Z.SecondaryActions,{children:(0,e.jsx)(_.$n,{onClick:d,icon:i?"angle-up":"angle-down",fill:"text",size:"sm",children:"Show details"},"details")})]}),i&&(0,e.jsx)("div",{children:(0,e.jsx)("pre",{children:(0,e.jsx)("code",{children:JSON.stringify(s,null,2)})})})]})})},Pe=({queries:n,expressions:r,panelData:o,onRunQueries:s,onChangeQueries:c,onDuplicateQuery:i,condition:u,onSetCondition:d})=>{const D=(0,H.of)(ot);return(0,e.jsx)("div",{className:D.container,children:(0,e.jsx)(Me,{data:o,queries:n,expressions:r,onRunQueries:s,onQueriesChange:c,onDuplicateQuery:i,condition:u,onSetCondition:d})})},ot=n=>({container:(0,m.css)({backgroundColor:n.colors.background.primary,height:"100%"})});var rt=t(74856),st=t(84959),Oe=t(64100);const at=({queries:n,onChangeQuery:r,runQueries:o,panelData:s,dataSourceName:c})=>{const[i,u]=(0,p.useState)({series:[],state:De.Gu.NotStarted,timeRange:(0,rt.jG)().timeRange()}),d=(0,H.of)(Dt);(0,p.useEffect)(()=>{u(s?.[n[0]?.refId])},[s,n]);const{error:D,loading:G,value:h}=(0,Qe.A)(()=>(0,ee.l)().get(c),[c]),I=ne=>{if(!(0,Se.Bu)(ne)||!h)return;const[Mt]=n,{uid:Z,type:X}=h,Xe=X===L.ol.Loki,Te=ne.expr,re={...Mt,...ne,datasourceUid:Z,expr:Te,model:{expr:Te,datasource:ne.datasource,refId:ne.refId,editorMode:ne.editorMode,instant:ne.instant,range:ne.range,queryType:Xe?ne.queryType||Oe.U3.Instant:ne.queryType,legendFormat:ne.legendFormat}};r([re])};if(G||h?.name!==c)return null;const ge=(0,ee.l)().getInstanceSettings(c);if(D||!h||!h?.components?.QueryEditor||!ge){const ne=D?.message||"Data source plugin does not export any Query Editor component";return(0,e.jsxs)("div",{children:["Could not load query editor due to: ",ne]})}const We=h.components.QueryEditor;return(0,e.jsxs)(e.Fragment,{children:[n.length&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(We,{query:n[0],queries:n,app:Re.Jk.UnifiedAlerting,onChange:I,onRunQuery:o,datasource:h}),(i?.errors||[]).map(ne=>(0,e.jsx)(st.x,{error:ne},ne.message))]}),i&&(0,e.jsx)("div",{className:d.vizWrapper,children:(0,e.jsx)(l.j,{data:i})})]})},Dt=n=>({vizWrapper:(0,m.css)({margin:n.spacing(1,0)})});var Rt=t(271),it=t(51612),Pt=t(99140);function gn({value:n,disabled:r,...o}){const s=ct(),{loading:c=!0}=(0,Qe.A)(()=>(0,Pt.JD)((0,je.wE)()),[Pt.JD]),i=(0,p.useCallback)(u=>!!s.find(({id:d})=>d===u.id),[s]);return(0,e.jsx)(it.s,{disabled:c||r,noDefault:!0,alerting:!0,filter:i,current:n,...o})}const a=({disabled:n,onChangeCloudDatasource:r})=>{const{control:o,formState:{errors:s},setValue:c,watch:i}=(0,k.xW)(),u=(0,H.of)(g),d=i("type");return(0,e.jsx)(e.Fragment,{children:(0,e.jsx)("div",{className:u.flexRow,children:(d===b.Z.cloudAlerting||d===b.Z.cloudRecording)&&(0,e.jsx)(he.D,{className:u.formInput,label:n?"Data source":"Select data source",error:s.dataSourceName?.message,invalid:!!s.dataSourceName?.message,children:(0,e.jsx)(k.xI,{render:({field:{onChange:D,ref:G,...h}})=>(0,e.jsx)(gn,{...h,disabled:n,onChange:I=>{c("expression",""),D(I?.name??null),r(I?.uid??null)}}),name:"dataSourceName",control:o,rules:{required:{value:!0,message:"Please select a data source"}}})})})})},g=n=>({formInput:(0,m.css)({width:"330px","& + &":{marginLeft:n.spacing(3)}}),flexRow:(0,m.css)({display:"flex",flexDirection:"row",justifyContent:"flex-start",alignItems:"flex-end"})});var S=t(1932),T=t(39268),M=t(90182),Q=t(9261),J=t(76942),C=t(65307),ue=t(77789),Ce=t(53478),Ee=t(36795);const ce=(n,r)=>{const o=(0,Ee.vL)(n),s=(0,Ee.qQ)(r,o)[0];if(!s)return;const c=n.find(i=>i.refId===s);if(c&&"relativeTimeRange"in c)return c},we={queries:[]},Ve=(0,C.VP)("duplicateQuery"),gt=(0,C.VP)("addNewDataQuery"),At=(0,C.VP)("setDataQueries"),sn=(0,C.VP)("addNewExpression"),Xt=(0,C.VP)("removeExpression"),an=(0,C.VP)("removeExpressions"),kt=(0,C.VP)("addExpressions"),Ct=(0,C.VP)("updateExpression"),Nt=(0,C.VP)("updateExpressionRefId"),ht=(0,C.VP)("rewireExpressions"),Je=(0,C.VP)("updateExpressionType"),qt=(0,C.VP)("updateExpressionTimeRange"),hn=(0,C.VP)("updateMaxDataPoints"),vn=(0,C.VP)("updateMinInterval"),Wt=(0,C.VP)("resetToSimpleCondition"),_t=(0,C.VP)("setRecordingRulesQueries"),xn=(0,C.vy)(we,n=>{n.addCase(Wt,r=>{r.queries=(0,Se.qO)()}).addCase(Ve,(r,{payload:o})=>{r.queries=Qt(r.queries,o)}).addCase(gt,r=>{const o=(0,L.y9)();o&&(r.queries=Qt(r.queries,{datasourceUid:o.uid,model:{refId:"",datasource:(0,tt.p$)(o)}}))}).addCase(At,(r,{payload:o})=>{const s=r.queries.filter(c=>(0,le.f)(c.model));r.queries=[...o,...s]}).addCase(_t,(r,{payload:o})=>{const s=o.recordingRuleQueries[0],c={...s,expr:o.expression,model:s?.model};r.queries=[c]}).addCase(hn,(r,o)=>{r.queries=r.queries.map(s=>s.refId===o.payload.refId?{...s,model:{...s.model,maxDataPoints:o.payload.maxDataPoints}}:s)}).addCase(vn,(r,o)=>{r.queries=r.queries.map(s=>s.refId===o.payload.refId?{...s,model:{...s.model,intervalMs:o.payload.minInterval?et.intervalToMs(o.payload.minInterval):void 0}}:s)}),n.addCase(sn,(r,{payload:o})=>{r.queries=Qt(r.queries,{datasourceUid:Y.Uj,model:Ce.Ex.newQuery({type:o,conditions:[{...J.P0,query:{params:[]}}],expression:""})})}).addCase(Xt,(r,{payload:o})=>{r.queries=r.queries.filter(s=>s.refId!==o)}).addCase(an,r=>{r.queries=r.queries.filter(o=>!(0,le.f)(o.model))}).addCase(kt,(r,{payload:o})=>{r.queries=[...r.queries,...o]}).addCase(Ct,(r,{payload:o})=>{const s=r.queries.find(c=>c.refId===o.refId);if(s&&(s.model=o,o.type===Y.Tz.resample&&o.expression)){const c=(0,S.c2)(r)?.queries??[];let i=(0,v.Cn)();try{const u=ce(c,o.expression);u?.relativeTimeRange&&(i=u.relativeTimeRange)}catch(u){u instanceof Error?(0,Ft.vV)(u):(0,Ft.vV)(new Error("Error while trying to find data source from expression"))}s.relativeTimeRange=i}}).addCase(qt,r=>{r.queries.forEach(o=>{if((0,le.f)(o.model)&&o.model.type===Y.Tz.resample&&o.model.expression){const s=(0,S.c2)(r)?.queries??[],c=ce(s,o.model.expression),i=c?c.relativeTimeRange:(0,v.Cn)();o.relativeTimeRange=i}})}).addCase(Nt,(r,{payload:o})=>{const{newRefId:s,oldRefId:c}=o;if((0,F.xb)(r.queries,s))return;const u=(0,F.I3)(r.queries,c,s);r.queries=u.map(d=>d.refId===c?{...d,refId:s,model:{...d.model,refId:s}}:d)}).addCase(ht,(r,{payload:o})=>{r.queries=(0,F.I3)(r.queries,o.oldRefId,o.newRefId)}).addCase(Je,(r,o)=>{r.queries=r.queries.map(s=>s.refId===o.payload.refId?{...s,model:{...Ce.Ex.newQuery({type:o.payload.type,conditions:[{...J.P0,query:{params:[]}}],expression:""}),refId:o.payload.refId}}:s)})}),Qt=(n,r)=>{const o=(0,ue.M)(n),s={...r,refId:o,queryType:"",model:{...r.model,hide:!1,refId:o},relativeTimeRange:r.relativeTimeRange??yn(r.model)};return[...n,s]},yn=n=>{if(!(0,le.f)(n))return(0,v.Cn)()},en="A",$t="B",Et="C",ln=({simpleCondition:n,onChange:r,expressionQueriesList:o,dispatch:s,previewData:c})=>{const i=I=>{r({...n,whenField:I.value??U.gy.last}),jn(I.value??U.gy.last,o,s)},u=n.evaluator.type===fe.p.IsWithinRange||n.evaluator.type===fe.p.IsOutsideRange,d=Y.zd.find(I=>I.value===n.evaluator?.type),D=I=>{r({...n,evaluator:{...n.evaluator,type:I.value??fe.p.IsAbove}}),me(I.value??fe.p.IsAbove,o,s)},G=(I,ge)=>{if(u){const We=(0,S.jM)(n.evaluator.params,ne=>{ne[ge??0]=parseFloat(I.currentTarget.value)});r({...n,evaluator:{...n.evaluator,params:We}}),bt(parseFloat(I.currentTarget.value),ge??0,o,s)}else r({...n,evaluator:{...n.evaluator,params:[parseFloat(I.currentTarget.value)]}}),bt(parseFloat(I.currentTarget.value),0,o,s)},h=(0,H.of)(Lt);return(0,e.jsx)("div",{className:h.condition.wrapper,children:(0,e.jsxs)(te.B,{direction:"column",gap:0,width:"100%",children:[(0,e.jsx)("header",{className:h.condition.header,children:(0,e.jsx)(se.E,{variant:"body",children:(0,e.jsx)(Fe.x6,{i18nKey:"alerting.simpleCondition.alertCondition",children:"Alert condition"})})}),(0,e.jsxs)(T.C,{className:h.condition.container,children:[(0,e.jsx)(It.I,{label:"WHEN",children:(0,e.jsx)(M.l6,{options:Y.Cu,value:Y.Cu.find(I=>I.value===n.whenField),onChange:i,width:20})}),(0,e.jsx)(It.I,{label:"OF QUERY",children:(0,e.jsxs)(te.B,{direction:"row",gap:1,alignItems:"center",children:[(0,e.jsx)(Q.f,{className:h.buttonSelectText,options:Y.zd,onChange:D,value:d}),u?(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(ft.p,{type:"number",width:10,value:n.evaluator.params[0],onChange:I=>G(I,0)}),(0,e.jsx)("div",{className:h.condition.button,children:(0,e.jsx)(Fe.x6,{i18nKey:"alerting.simpleCondition.ofQuery.To",children:"TO"})}),(0,e.jsx)(ft.p,{type:"number",width:10,value:n.evaluator.params[1],onChange:I=>G(I,1)})]}):(0,e.jsx)(ft.p,{type:"number",width:10,onChange:G,value:n.evaluator.params[0]})]})})]}),c?.series&&(0,e.jsx)(K.GX,{series:c?.series,isAlertCondition:!0})]})})};function jn(n,r,o){const s=r.find(i=>i.model.type===Y.Tz.reduce&&i.model.refId===$t),c=s?(0,S.jM)(s?.model,i=>{i&&i.conditions&&(i.reducer=n,i.conditions[0].reducer.type=(0,J.H3)(n)??U.gy.last)}):void 0;c&&o(Ct(c))}function me(n,r,o){const s=r.find(i=>i.model.type===Y.Tz.threshold&&i.model.refId===Et),c=(0,S.jM)(s,i=>{i&&i.model.conditions&&(i.model.conditions[0].evaluator.type=n)});c&&o(Ct(c.model))}function bt(n,r,o,s){const c=o.find(u=>u.model.type===Y.Tz.threshold&&u.model.refId===Et),i=(0,S.jM)(c,u=>{u&&u.model.conditions&&(u.model.conditions[0].evaluator.params[r]=n)});i&&s(Ct(i.model))}function vt(n){const r=n.find(d=>d.model.type===Y.Tz.reduce&&d.refId===$t),s=n.find(d=>d.model.type===Y.Tz.threshold&&d.refId===Et)?.model.conditions??[],c=r?.model.reducer??U.gy.last,i=s[0]?.evaluator?.params?[...s[0]?.evaluator?.params]:[0],u=s[0]?.evaluator?.type??fe.p.IsAbove;return{whenField:c,evaluator:{params:i,type:u}}}const Lt=n=>({buttonSelectText:(0,m.css)({color:n.colors.primary.text,fontSize:n.typography.bodySmall.fontSize,textTransform:"uppercase",padding:`0 ${n.spacing(1)}`}),condition:{wrapper:(0,m.css)({display:"flex",border:`solid 1px ${n.colors.border.medium}`,flex:1,height:"fit-content",borderRadius:n.shape.radius.default}),container:(0,m.css)({display:"flex",flexDirection:"row",padding:n.spacing(1),flex:1,width:"100%"}),header:(0,m.css)({background:n.colors.background.secondary,padding:`${n.spacing(.5)} ${n.spacing(1)}`,borderBottom:`solid 1px ${n.colors.border.weak}`,flex:1}),button:(0,m.css)({height:"32px",color:n.colors.primary.text,fontSize:n.typography.bodySmall.fontSize,textTransform:"uppercase",display:"flex",alignItems:"center",borderRadius:n.shape.radius.default,fontWeight:n.typography.fontWeightBold,border:`1px solid ${n.colors.border.medium}`,whiteSpace:"nowrap",padding:`0 ${n.spacing(1)}`,backgroundColor:n.colors.background.primary})}});var Sn=t(94354),cn=t(10096);function In(){const n=cn.TP.hasPermission(qe.AccessControlAction.AlertingRuleCreate),r=cn.TP.hasPermission(qe.AccessControlAction.AlertingRuleExternalWrite),o=n?b.Z.grafana:b.Z.cloudAlerting,s=[];return n&&s.push(b.Z.grafana),r&&s.push(b.Z.cloudAlerting,b.Z.cloudRecording),{enabledRuleTypes:s,defaultRuleType:o}}const Ot=n=>n.filter(r=>r.datasourceUid!==Y.Uj).length===1,Rn=({queries:n,ruleFormType:r,rulesSourcesWithRuler:o})=>{const s=In(),c=Ot(n),i=n[0]?.datasourceUid??"",u=r===b.Z.cloudRecording,d=!u&&c&&o.some(We=>We.uid===i),D=!u,G=s.enabledRuleTypes.includes(b.Z.grafana),h=s.enabledRuleTypes.includes(b.Z.cloudAlerting),I=r===b.Z.cloudAlerting&&G&&D,ge=r===b.Z.grafana&&d&&h&&d;return I||ge};function An({editingExistingRule:n,rulesSourcesWithRuler:r,queries:o,onClickSwitch:s}){const{getValues:c}=(0,k.xW)(),[i]=c(["type"]),u=Rn({queries:o,ruleFormType:i,rulesSourcesWithRuler:r}),d=[{label:"Grafana-managed",value:b.Z.grafana},{label:"Data source-managed",value:b.Z.cloudAlerting}],D=u?[]:[b.Z.cloudAlerting];return(0,e.jsxs)(te.B,{direction:"column",gap:1,alignItems:"flex-start",children:[(0,e.jsxs)(te.B,{direction:"column",gap:0,children:[(0,e.jsx)(se.E,{variant:"h5",children:"Rule type"}),(0,e.jsxs)(te.B,{direction:"row",gap:.5,alignItems:"center",children:[(0,e.jsx)(se.E,{variant:"bodySmall",color:"secondary",children:"Select where the alert rule will be managed."}),(0,e.jsx)(He.G,{contentText:(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(se.E,{color:"primary",variant:"h6",children:"Grafana-managed alert rules"}),(0,e.jsx)("p",{children:"Grafana-managed alert rules allow you to create alerts that can act on data from any of our supported data sources, including having multiple data sources in the same rule. You can also add expressions to transform your data and set alert conditions. Using images in alert notifications is also supported."}),(0,e.jsx)(se.E,{color:"primary",variant:"h6",children:"Data source-managed alert rules"}),(0,e.jsx)("p",{children:"Data source-managed alert rules can be used for Grafana Mimir or Grafana Loki data sources which have been configured to support rule creation. The use of expressions or multiple queries is not supported."})]}),externalLink:"https://grafana.com/docs/grafana/latest/alerting/fundamentals/alert-rules/alert-rule-types/",linkText:"Read about alert rule types",title:"Alert rule types"})]})]}),(0,e.jsx)(Sn.z,{options:d,disabled:n,disabledOptions:D,value:i,onChange:s}),n&&(0,e.jsx)(se.E,{color:"secondary",children:"The alert rule type cannot be changed for an existing rule."}),!n&&(0,e.jsx)(e.Fragment,{children:u?(0,e.jsx)(se.E,{color:"secondary",children:i===b.Z.grafana?"The data source selected in your query supports alert rule management. Switch to data source-managed if you want the alert rule to be managed by the data source instead of Grafana.":"Switch to Grafana-managed to use expressions, multiple queries, images in notifications and various other features."}):(0,e.jsx)(se.E,{color:"secondary",children:"Based on the selected data sources this alert rule will be Grafana-managed."})})]})}const On={[b.Z.cloudRecording]:{sectionTitle:"Define recording rule",helpLabel:"Define your recording rule",helpContent:"Pre-compute frequently needed or computationally expensive expressions and save their result as a new set of time series.",helpLink:""},[b.Z.grafanaRecording]:{sectionTitle:"Define recording rule",helpLabel:"Define your recording rule",helpContent:"Pre-compute frequently needed or computationally expensive expressions and save their result as a new set of time series.",helpLink:""},[b.Z.grafana]:{sectionTitle:"Define query and alert condition",helpLabel:"Define query and alert condition",helpContent:"An alert rule consists of one or more queries and expressions that select the data you want to measure. Define queries and/or expressions and then choose one of them as the alert rule condition. This is the threshold that an alert rule must meet or exceed in order to fire. For more information on queries and expressions, see Query and transform data.",helpLink:"https://grafana.com/docs/grafana/latest/panels-visualizations/query-transform-data/"},[b.Z.cloudAlerting]:{sectionTitle:"Define query and alert condition",helpLabel:"Define query and alert condition",helpContent:"An alert rule consists of one or more queries and expressions that select the data you want to measure. Define queries and/or expressions and then choose one of them as the alert rule condition. This is the threshold that an alert rule must meet or exceed in order to fire. For more information on queries and expressions, see Query and transform data.",helpLink:"https://grafana.com/docs/grafana/latest/panels-visualizations/query-transform-data/"}};var wn=t(28318);function Vn(){const[n,r]=(0,p.useState)({}),o=(0,p.useRef)(new wn.t);(0,p.useEffect)(()=>{const d=o.current;return d.get().subscribe(D=>{r(D)}),()=>{d.destroy()}},[]);const s=(0,p.useCallback)(()=>{r({})},[]),c=(0,p.useCallback)(()=>{o.current.cancel()},[]),i=(0,p.useCallback)((d,D)=>{o.current.run(d,D)},[]),u=(0,p.useMemo)(()=>Object.values(n).some(d=>d.state===De.Gu.Loading),[n]);return{queryPreviewData:n,runQueries:i,cancelQueries:c,isPreviewLoading:u,clearPreviewData:s}}function Cn(n,r){if(n.length!==1||r.length!==2||n[0].refId!==en)return!1;const s=r.findIndex(h=>h.model.type===Y.Tz.reduce&&h.refId===$t),c=r.at(s),i=c&&s===0&&(c.model.settings?.mode===Y.Mt.Strict||c.model.settings?.mode===void 0),u=r.findIndex(h=>h.model.type===Y.Tz.threshold&&h.refId===Et),d=r.at(u),D=d?.model.conditions??[],G=d&&u===1&&D[0]?.unloadEvaluator===void 0;return!!i&&!!G}const Wn=({editingExistingRule:n,onDataChange:r})=>{const{setValue:o,getValues:s,watch:c,formState:{errors:i},control:u}=(0,k.xW)(),{queryPreviewData:d,runQueries:D,cancelQueries:G,isPreviewLoading:h,clearPreviewData:I}=Vn(),[ge]=(0,dt.l)(),We=de.$.featureToggles.alertingQueryAndExpressionsStepMode??!1,ne=ge.has("defaults")&&!n,Mt={queries:s("queries")},[{queries:Z},X]=(0,p.useReducer)(xn,Mt),Xe=(0,p.useMemo)(()=>Z.filter(x=>!(0,le.f)(x.model)),[Z]),Te=(0,p.useMemo)(()=>Z.filter(x=>Zn(x)),[Z]),[re,lt,Gt,tn]=c(["type","condition","dataSourceName","editorSettings"]),ve=(0,Ie.Mu)(re),dn=(0,Ie.OF)(re),nn=(0,Ie.BL)(re),En=Cn(Xe,Te),$e=!tn?.simplifiedQueryEditor||!ve||ne&&!En,[Ae,un]=(0,p.useState)(!1),[Tn,mn]=(0,p.useState)(ve&&Cn(Xe,Te)?vt(Te):{whenField:U.gy.last,evaluator:{params:[0],type:fe.p.IsAbove}});(0,p.useEffect)(()=>{!$e&&ve&&mn(vt(Te))},[$e,Te,ve]);const on=(0,qe.useDispatch)();(0,p.useEffect)(()=>{on((0,je.wE)())},[on]);const rn=ct(),xt=(0,p.useCallback)(x=>{nn||($e?D(s("queries"),x||(s("condition")??"")):(o("condition",Et),D(s("queries"),Et)))},[nn,D,s,$e,o]);(0,p.useEffect)(()=>{o("queries",Z,{shouldValidate:!1})},[Z,D,o]);const Nn=(0,L.y9)()===void 0,Mn=Z.length===0;(0,p.useEffect)(()=>{if(re&&!(0,Ie.H2)(re))return;const x=s("condition");if(!x)return;const V=d[x];if(!V)return;const ke=(0,F.lb)(V)??(0,F.zy)(V);r(ke?.message||"")},[d,s,r,re]);const Ut=(0,p.useCallback)(x=>{x&&(xt(x),o("condition",x))},[xt,o]),Hn=(0,p.useCallback)((x,V)=>{(0,F.xb)(Z,V)||(X(Nt({oldRefId:x,newRefId:V})),lt===x&&Ut(V))},[lt,Z,Ut]),Tt=zn(),Yn=(0,p.useCallback)(x=>{const ke=s("queries").filter(ao=>(0,le.f)(ao.model));o("queries",[...x,...ke],{shouldValidate:!1}),Tt(x),X(At(x)),X(qt());const[pn,Ln]=(0,F.YG)(Z,x);pn&&Ln&&X(ht({oldRefId:pn,newRefId:Ln}))},[Z,Tt,s,o]),Kn=(0,p.useCallback)(x=>{const V=x[0];if(!(0,Se.Bu)(V.model))return;const ke=V.model.expr;o("queries",x,{shouldValidate:!1}),Tt(x),X(_t({recordingRuleQueries:x,expression:ke})),xt()},[xt,o,Tt]),Dn=rn[0];(0,p.useEffect)(()=>{if(I(),re===b.Z.cloudRecording){const x=s("expression");if(!Dn)return;const ke={refId:"A",datasourceUid:n&&(0,ee.l)().getInstanceSettings(Gt)?.uid||Dn.uid,queryType:"",relativeTimeRange:(0,v.Cn)(),expr:x,instant:!0,model:{refId:"A",hide:!1,expr:x}};X(_t({recordingRuleQueries:[ke],expression:x}))}},[re,Dn,n,s,Gt,I]);const Jn=(0,p.useCallback)(x=>{X(Ve(x))},[]);(0,p.useEffect)(()=>{if(!(0,F.xb)(Z,lt)){const x=Z.at(-1)?.refId??null;Ut(x)}},[lt,Z,Ut]);const Xn=(0,p.useCallback)(x=>{X(sn(x))},[X]),kn=(0,H.of)(Un),qn=(0,p.useCallback)(x=>{const V=(0,$.cloneDeep)(Z);V[0].datasourceUid=x,o("queries",V,{shouldValidate:!1}),Tt(V),X(At(V))},[Z,o,Tt,X]),_n=x=>{const V=(0,$.cloneDeep)(Z);if(V[0].model)if((0,Se.Bu)(V[0].model))V[0].model.expr=x;else{const ke={...(0,$.cloneDeep)(V[0].model),expr:x};V[0].model=ke}o("queries",V,{shouldValidate:!1}),Tt(V),X(At(V)),xt()},Gn=(0,p.useCallback)(()=>X(an()),[X]),Bn=(0,p.useCallback)(x=>X(kt(x)),[X]),[fn,eo]=(0,p.useState)([]),[Pn,to]=(0,p.useState)(null),Fn=(0,p.useCallback)(()=>{Bn(fn)},[fn,Bn]),Qn=(0,p.useCallback)(()=>{if(s("type")===b.Z.cloudAlerting)o("type",b.Z.grafana),o("dataSourceName",null),fn.length>0&&Fn(),Pn&&o("condition",Pn);else{o("type",b.Z.cloudAlerting);const V=(0,ee.l)().getInstanceSettings(Z[0].datasourceUid)?.name;V&&o("dataSourceName",V),Tt(Z);const ke=Z.filter(pn=>pn.datasourceUid===Y.Uj);eo(ke),Gn(),to(lt)}},[s,o,fn.length,Fn,Pn,Tt,Z,Gn,lt]),{sectionTitle:no,helpLabel:bn,helpContent:oo,helpLink:ro}=On[re??b.Z.grafana];if(!re)return null;const so=ve&&We?{isAdvancedMode:$e,setAdvancedMode:x=>{if(!x&&!Cn(Xe,Te)){un(!0);return}o("editorSettings",{simplifiedQueryEditor:!x})}}:void 0;return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsxs)(Rt.P,{stepNo:2,title:no,fullWidth:!0,description:(0,e.jsxs)(te.B,{direction:"row",gap:.5,alignItems:"center",children:[(0,e.jsx)(se.E,{variant:"bodySmall",color:"secondary",children:bn}),(0,e.jsx)(He.G,{contentText:oo,externalLink:ro,linkText:"Read more on our documentation website",title:bn})]}),switchMode:so,children:[(0,Ie.s_)(re)&&(0,e.jsx)(a,{onChangeCloudDatasource:qn,disabled:n}),dn&&Gt&&(0,e.jsx)(he.D,{error:i.expression?.message,invalid:!!i.expression?.message,children:(0,e.jsx)(at,{dataSourceName:Gt,queries:Z,runQueries:()=>xt(),onChangeQuery:Kn,panelData:d})}),nn&&Gt&&(0,e.jsxs)(te.B,{direction:"column",children:[(0,e.jsx)(he.D,{error:i.expression?.message,invalid:!!i.expression?.message,children:(0,e.jsx)(k.xI,{name:"expression",render:({field:{ref:x,...V}})=>(0,e.jsx)(w,{...V,dataSourceName:Gt,showPreviewAlertsButton:!dn,onChange:_n}),control:u,rules:{required:{value:!0,message:"A valid expression is required"}}})}),(0,e.jsx)(An,{editingExistingRule:n,queries:Z,rulesSourcesWithRuler:rn,onClickSwitch:Qn})]}),(0,Ie.H2)(re)&&(0,e.jsxs)(te.B,{direction:"column",children:[(0,e.jsx)(Pe,{queries:Xe,expressions:Te,onRunQueries:()=>xt(),onChangeQueries:Yn,onDuplicateQuery:Jn,panelData:d,condition:lt,onSetCondition:Ut}),$e&&(0,e.jsx)(ie.m,{content:"You appear to have no compatible data sources",show:Nn,children:(0,e.jsx)(_.$n,{type:"button",onClick:()=>{X(gt())},variant:"secondary","data-testid":B.Tp.components.QueryTab.addQuery,disabled:Nn,className:kn.addQueryButton,children:"Add query"})}),ve&&$e&&(0,e.jsx)(An,{editingExistingRule:n,rulesSourcesWithRuler:rn,queries:Z,onClickSwitch:Qn}),$e&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsxs)(te.B,{direction:"column",gap:0,children:[(0,e.jsx)(se.E,{element:"h5",children:"Expressions"}),(0,e.jsx)(se.E,{variant:"bodySmall",color:"secondary",children:"Manipulate data returned from queries with math and other operations."})]}),(0,e.jsx)(_e,{queries:Z,panelData:d,condition:lt,onSetCondition:Ut,onRemoveExpression:x=>{X(Xt(x))},onUpdateRefId:Hn,onUpdateExpressionType:(x,V)=>{X(Je({refId:x,type:V}))},onUpdateQueryExpression:x=>{X(Ct(x))}})]}),(0,e.jsxs)(te.B,{direction:"column",children:[!$e&&(0,e.jsx)(ln,{simpleCondition:Tn,onChange:mn,expressionQueriesList:Te,dispatch:X,previewData:d[lt??""]}),(0,e.jsxs)(te.B,{direction:"row",children:[$e&&de.$.expressionsEnabled&&(0,e.jsx)($n,{onClickType:Xn}),h&&(0,e.jsx)(_.$n,{icon:"spinner",type:"button",variant:"destructive",onClick:G,children:"Cancel"}),!h&&(0,e.jsx)(_.$n,{"data-testid":B.Tp.components.AlertRules.previewButton,icon:"sync",type:"button",onClick:()=>xt(),disabled:Mn,children:$e?(0,Fe.t)("alerting.queryAndExpressionsStep.preview","Preview"):(0,Fe.t)("alerting.queryAndExpressionsStep.previewCondition","Preview alert rule condition")})]})]}),Mn&&(0,e.jsx)(oe.F,{title:"No queries or expressions have been configured",severity:"warning",children:"Create at least one query or expression to be alerted on"})]})]}),(0,e.jsx)(Ge.u,{isOpen:Ae,title:"Deactivate advanced options",body:(0,e.jsxs)("div",{children:[(0,e.jsx)(se.E,{element:"p",children:(0,e.jsx)(Fe.x6,{i18nKey:"alerting.queryAndExpressionsStep.disableAdvancedOptions.text",children:"The selected queries and expressions cannot be converted to default. If you deactivate advanced options, your query and condition will be reset to default settings."})}),(0,e.jsx)("br",{})]}),confirmText:"Deactivate",icon:"exclamation-triangle",onConfirm:()=>{o("editorSettings",{simplifiedQueryEditor:!0}),un(!1),X(Wt())},onDismiss:()=>un(!1)})]})};function $n({onClickType:n}){const r=(0,e.jsx)(Be.W,{children:Y.uQ.map(o=>(0,e.jsx)(ie.m,{content:o.description??"",placement:"right",children:(0,e.jsx)(Ue.D,{onClick:()=>n(o.value??Y.Tz.math),label:o.label??""},o.value)},o.value))});return(0,e.jsx)(ze.m,{overlay:r,children:(0,e.jsxs)(_.$n,{variant:"secondary",children:["Add expression",(0,e.jsx)(ye.I,{name:"angle-down"})]})})}const Un=n=>({addQueryButton:(0,m.css)({width:"fit-content"}),helpInfo:(0,m.css)({display:"flex",flexDirection:"row",alignItems:"center",width:"fit-content",fontWeight:n.typography.fontWeightMedium,marginLeft:n.spacing(1),fontSize:n.typography.size.sm,cursor:"pointer"}),helpInfoText:(0,m.css)({marginLeft:n.spacing(.5),textDecoration:"underline"}),infoLink:(0,m.css)({color:n.colors.text.link})}),zn=()=>{const{setValue:n}=(0,k.xW)();return r=>{const o=r[0];if(!o)return;if(!(0,ee.l)().getInstanceSettings(o.datasourceUid))throw new Error("The Data source has not been defined.");if((0,Se.Bu)(o.model)){const c=o.model.expr;n("expression",c)}}};function Zn(n){return(0,le.f)(n.model)}},79944:(Bt,xe,t)=>{t.d(xe,{V:()=>e});function e(m,$){const p=m.replace(/\(copy( [0-9]+)?\)$/,"").trim();let k=`${p} (copy)`;for(let U=2;$.includes(k);U++)k=`${p} (copy ${U})`;return k}},87286:(Bt,xe,t)=>{t.d(xe,{B:()=>p});var e=t(74848),m=t(32196),$=t(40845);function p(U){const v=(0,$.of)(k,U);return(0,e.jsx)("div",{className:v.root,children:U.children})}const k=(U,v)=>({root:(0,m.css)({display:"flex",flexDirection:v.direction??"row",flexWrap:v.wrap??!0?"wrap":void 0,alignItems:v.alignItems,gap:U.spacing(v.gap??2),flexGrow:v.flexGrow})})}}]);

//# sourceMappingURL=AlertingRuleForm.8f80cb7838714858d51c.js.map