"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[9438],{53191:(le,$,a)=>{a.r($),a.d($,{default:()=>ke});var e=a(74848),p=a(55852),C=a(67061),I=a(94753),G=a(37959),K=a(96636),v=a(96540),ce=a(87978),de=a(63021),X=a(40675),A=a(57220),V=a(32196),ge=a(49785),ue=a(70713),k=a(40845),T=a(42418),fe=a(32372),q=a(96374),me=a(25027),he=a(51488),_=a(61410),ee=a(26058);function ve({alertmanagerName:n,onDismiss:t,onSave:r,onReset:i}){const{loading:o,error:l}=(0,_.$)(E=>E.deleteAMConfig),{loading:u,error:s}=(0,_.$)(E=>E.saveAMConfig),[d,g]=(0,v.useState)(!1),h=n?(0,A.AL)(n):!1,x=n===A.hY,j=(0,k.of)(Ae),{currentData:y,error:N,isSuccess:R,isLoading:f}=(0,he.f)(n),c={configJSON:y?JSON.stringify(y,null,2):""},{register:m,setValue:D,setError:L,handleSubmit:H,formState:{errors:U}}=(0,ge.mN)({defaultValues:c});(0,v.useEffect)(()=>{y&&D("configJSON",JSON.stringify(y,null,2))},[y,D]),(0,v.useEffect)(()=>{s&&L("configJSON",{type:"deps",message:s.message})},[s,L]),(0,v.useEffect)(()=>{l&&L("configJSON",{type:"deps",message:l.message})},[l,L]),m("configJSON",{required:{value:!0,message:"Configuration cannot be empty"},validate:E=>{try{return JSON.parse(E),!0}catch(Y){return Y instanceof Error?Y.message:"JSON is invalid"}}});const Z=H(E=>{r(n,c.configJSON,E.configJSON)},me.KF),W=f||o||u;if(N)return(0,e.jsx)(T.F,{severity:"error",title:"Failed to load Alertmanager configuration",children:N.message??"An unknown error occurred."});if(o)return(0,e.jsx)(T.F,{severity:"info",title:"Resetting Alertmanager configuration",children:"Resetting configuration, this might take a while."});const _e=x?"Are you sure you want to reset configuration for the Grafana Alertmanager? Contact points and notification policies will be reset to their defaults.":`Are you sure you want to reset configuration for "${n}"? Contact points and notification policies will be reset to their defaults.`;return(0,e.jsxs)("div",{className:j.container,children:[U.configJSON&&(0,e.jsx)(T.F,{severity:"error",title:"Oops, something went wrong",children:U.configJSON.message||"An unknown error occurred."}),R&&(0,e.jsx)("div",{className:j.content,children:(0,e.jsx)(ue.Ay,{children:({height:E,width:Y})=>(0,e.jsx)(fe.B,{language:"json",width:Y,height:E,showLineNumbers:!0,monacoOptions:{scrollBeyondLastLine:!1},value:c.configJSON,showMiniMap:!1,onSave:Q=>D("configJSON",Q),onBlur:Q=>D("configJSON",Q),readOnly:W})})}),(0,e.jsxs)(C.B,{justifyContent:"flex-end",children:[!h&&(0,e.jsx)(p.$n,{variant:"destructive",onClick:()=>g(!0),disabled:W,children:"Reset"}),(0,e.jsx)(ee.h,{}),(0,e.jsx)(p.$n,{variant:"secondary",onClick:()=>t(),disabled:W,children:"Cancel"}),!h&&(0,e.jsx)(p.$n,{variant:"primary",onClick:Z,disabled:W,children:"Save"})]}),(0,e.jsx)(q.u,{isOpen:d,title:"Reset Alertmanager configuration",body:_e,confirmText:"Yes, reset configuration",onConfirm:()=>{i(n),g(!1)},onDismiss:()=>{g(!1)}})]})}const Ae=n=>({container:(0,V.css)({display:"flex",flexDirection:"column",height:"100%",gap:n.spacing(2)}),content:(0,V.css)({flex:"1 1 100%"})});var O=a(2543),Se=a(26272),xe=a(3591),pe=a(32264),M=a(60021),z=a(99140),J=a(82843),Ce=a(49962);const w=Ce.H.injectEndpoints({endpoints:n=>({getAllDataSourceSettings:n.query({query:()=>({url:"api/datasources"}),providesTags:t=>t?t.map(({uid:r})=>({type:"DataSourceSettings",id:r})):["DataSourceSettings"]}),getDataSourceSettingsForUID:n.query({query:t=>({url:`api/datasources/uid/${t}`}),providesTags:(t,r,i)=>[{type:"DataSourceSettings",id:i}]}),updateDataSourceSettingsForUID:n.mutation({query:({uid:t,settings:r})=>({url:`api/datasources/uid/${t}`,method:"PUT",data:r,showSuccessAlert:!1}),invalidatesTags:(t,r,i)=>[{type:"DataSourceSettings",id:i.uid}]})})});function je({refetchOnMountOrArgChange:n=!1}={}){const{alertmanagerDataSources:t}=w.endpoints.getAllDataSourceSettings.useQuery(void 0,{refetchOnReconnect:!0,refetchOnMountOrArgChange:n,selectFromResult:i=>{const o=i.currentData?.filter(A.bD)??[];return{...i,alertmanagerDataSources:o}}}),{currentData:r}=J.m.endpoints.getExternalAlertmanagers.useQuery(void 0,{refetchOnReconnect:!0,refetchOnMountOrArgChange:n});return t?t.map(i=>{const o=r?ye(r,i):"unknown";return{dataSourceSettings:i,status:o}}):[]}function ye(n,t){if(!t.jsonData.handleGrafanaManagedAlerts)return"uninterested";const i=n?.activeAlertManagers.some(s=>ne(t.url,s.url))??[],o=n?.droppedAlertManagers.some(s=>ne(t.url,s.url))??[];return!i&&!o?"pending":i&&o?"inconclusive":i?"active":o?"dropped":"unknown"}const De="/alertmanager/api/v2/alerts",Ee="/api/v2/alerts";function ne(n,t){const r=Ie(n),i=t===`${r}${Ee}`,o=t===`${r}${De}`;return i||o}function Ie(n){return(new RegExp("^[^:]*://").test(n)?n:`http://${n}`).replace(/\/+$/,"")}var te=a(26627);const re=n=>{if(!n)return!0;switch(n.alertmanagersChoice){case M.nA.Internal:case M.nA.All:return!0;case M.nA.External:default:return!1}};var Me=a(1932);const Le=()=>{const[n,t]=w.endpoints.getDataSourceSettingsForUID.useLazyQuery(),[r,i]=w.endpoints.updateDataSourceSettingsForUID.useMutation(),o=async(d,g)=>{const S=await n(d).unwrap();if(!(0,A.bD)(S))throw new Error(`Data source with UID ${d} is not an Alertmanager data source`);const h=(0,Me.jM)(S,x=>{x.jsonData.handleGrafanaManagedAlerts=g});r({uid:d,settings:h})},l=d=>o(d,!0),u=d=>o(d,!1),s={isLoading:t.isLoading||i.isLoading,isError:t.isError||i.isError,error:t.error||i.error,data:i.data};return[l,u,s]},Oe=(0,xe.J7)(),ae=(0,v.createContext)(void 0),se=n=>n===A.hY,Ne=n=>{const t=[],r=pe.$.featureToggles.alertingDisableSendAlertsExternal===!0,{currentData:i,isLoading:o}=J.m.endpoints.getGrafanaAlertingConfiguration.useQuery(),[l,u]=J.m.endpoints.updateGrafanaAlertingConfiguration.useMutation(),[s,d,g]=Le(),S=je({refetchOnMountOrArgChange:!0});re(i)&&t.push(A.hY),S.filter(f=>(0,A.iV)(f.dataSourceSettings)).forEach(f=>{t.push(f.dataSourceSettings.uid)});const x=f=>{const c=(0,O.union)([f],t),m=ie(c);m!==null&&(m!==i?.alertmanagersChoice&&l({alertmanagersChoice:m}),se(f)||s(f))},j=f=>{const c=(0,O.without)(t,f),m=ie(c);m!==null&&(m!==i?.alertmanagersChoice&&l({alertmanagersChoice:m}),se(f)||d(f))},y=(f,c,m)=>{(0,z.JD)((0,te.RW)({newConfig:JSON.parse(m),oldConfig:JSON.parse(c),alertManagerSourceName:f,successMessage:"Alertmanager configuration updated."}))},N=f=>{(0,z.JD)((0,te.nO)(f))},R={configuration:i,forwardingDisabled:r,externalAlertmanagerDataSourcesWithStatus:S,enableAlertmanager:x,disableAlertmanager:j,isLoading:o,isUpdating:u.isLoading||g.isLoading,updateAlertmanagerSettings:y,resetAlertmanagerSettings:N};return(0,e.jsx)(ae.Provider,{value:R,children:n.children})};function ie(n){const t=n.some(i=>i===A.hY),r=n.some(i=>i!==A.hY);return t&&r?M.nA.All:!t&&r?M.nA.External:t&&!r?M.nA.Internal:(Oe.publish({type:Se.r1.alertError.name,payload:["You need to have at least one Alertmanager to receive alerts."]}),null)}function F(){const n=(0,v.useContext)(ae);if(n===void 0)throw new Error("useSettings must be used within a SettingsContext");const t=(0,O.debounce)(()=>{(0,z.JD)(w.util.invalidateTags(["AlertmanagerConnectionStatus"]))},3e3),r=(0,v.useRef)(t);return n.externalAlertmanagerDataSourcesWithStatus.some(({status:o})=>o==="pending")&&r.current(),(0,v.useEffect)(()=>{t.cancel()},[t]),n}var Re=a(95093),be=a.n(Re),B=a(39938),Te=a(48840),Je=a(22764),Be=a(56596),$e=a(78742);const Ge=30,Ve=({alertmanagerName:n})=>{const[t,r]=(0,v.useState)(void 0),[i,o]=(0,v.useState)(!1),[l,u]=(0,v.useState)(void 0),{currentData:s=[],isLoading:d,error:g}=J.m.endpoints.getAlertmanagerConfigurationHistory.useQuery(void 0),[S,h]=J.m.endpoints.resetAlertmanagerConfigurationToOldVersion.useMutation(),x=()=>{o(!0)},j=()=>{o(!1)},y=c=>{u(void 0),r(void 0),S({id:c})};if(g)return(0,e.jsx)(T.F,{title:"Failed to load configuration history",children:(0,$e.JZ)(g)});if(d)return"Loading...";if(!s.length)return"No previous configurations";const R=s.map((c,m)=>{const D=s[0],L=s[m];return{...c,diff:L?Ue(c,D):{added:0,removed:0}}}).map(c=>({id:String(c.id??0),lastAppliedAt:c.last_applied??"unknown",diff:c.diff})),f=[{id:"lastAppliedAt",header:"Last applied",cell:Fe},{id:"diff",disableGrow:!0,cell:({row:c,value:m})=>c.index===0?null:(0,e.jsxs)(C.B,{alignItems:"baseline",gap:.5,children:[(0,e.jsxs)(I.E,{color:"success",variant:"bodySmall",children:["+",m.added]}),(0,e.jsxs)(I.E,{color:"error",variant:"bodySmall",children:["-",m.removed]})]})},{id:"actions",disableGrow:!0,cell:({row:c})=>{const m=c.index===0,D=Number(c.id);return(0,e.jsx)(C.B,{direction:"row",alignItems:"center",justifyContent:"flex-end",children:m?(0,e.jsx)(B.E,{text:"Latest",color:"blue"}):(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(p.$n,{variant:"secondary",size:"sm",icon:"code-branch",fill:"outline",onClick:()=>{const L=s[0],H=s[c.index],U=P(L),Z=P(H);r(D),u([JSON.stringify(U,null,2),JSON.stringify(Z,null,2)])},children:"Compare"}),(0,e.jsx)(p.$n,{variant:"secondary",size:"sm",icon:"history",onClick:()=>{r(D),x()},disabled:h.isLoading,children:"Restore"})]})})}}];return h.isLoading?(0,e.jsx)(T.F,{severity:"info",title:"Restoring Alertmanager configuration",children:"This might take a while..."}):(0,e.jsxs)(e.Fragment,{children:[l?(0,e.jsx)(we,{left:l[0],right:l[1],disabled:h.isLoading,onCancel:()=>{r(void 0),u(void 0),j()},onConfirm:()=>{x()}}):(0,e.jsx)(Te.j,{pageSize:Ge,columns:f,data:R,getRowId:c=>c.id}),(0,e.jsx)(q.u,{isOpen:i,title:"Restore Version",body:"Are you sure you want to restore the configuration to this version? All unsaved changes will be lost.",confirmText:"Yes, restore configuration",onConfirm:()=>{t&&y(t),j()},onDismiss:()=>j()})]})};function we({left:n,right:t,disabled:r=!1,onCancel:i,onConfirm:o}){const l=(0,k.of)(Pe);return(0,e.jsxs)("div",{className:l.drawerWrapper,children:[(0,e.jsx)("div",{className:l.diffWrapper,children:(0,e.jsx)(Je.M,{newValue:n,oldValue:t,hideLineNumbers:!0})}),(0,e.jsxs)(C.B,{direction:"row",alignItems:"center",children:[(0,e.jsx)(ee.h,{}),(0,e.jsx)(p.$n,{variant:"secondary",onClick:i,disabled:r,children:"Return"}),(0,e.jsx)(p.$n,{icon:"history",variant:"primary",onClick:o,disabled:r,children:"Restore"})]})]})}const Fe=({value:n})=>{const t=be()(n);return(0,e.jsxs)(C.B,{direction:"row",alignItems:"center",children:[t.toLocaleString(),(0,e.jsx)(I.E,{variant:"bodySmall",color:"secondary",children:t.fromNow()})]})},Pe=n=>({drawerWrapper:(0,V.css)({maxHeight:"100%",display:"flex",flexDirection:"column",gap:n.spacing(1)}),diffWrapper:(0,V.css)({overflowY:"auto"})});function P(n){return(0,O.omit)(n,["id","last_applied"])}function Ue(n,t){const r=P(n),i=P(t),o=(0,Be.G4)(r,i),l=(0,O.chain)(o).values().flatMap().filter(s=>s.op==="add"||s.op==="replace"||s.op==="move").sumBy(s=>s.endLineNumber-s.startLineNumber+1).value(),u=(0,O.chain)(o).values().flatMap().filter(s=>s.op==="remove"||s.op==="replace").sumBy(s=>s.endLineNumber-s.startLineNumber+1).value();return{added:l,removed:u}}function We(){const[n,t]=(0,v.useState)("configuration"),[r,i]=(0,v.useState)(),[o,l]=(0,v.useState)(!1),{updateAlertmanagerSettings:u,resetAlertmanagerSettings:s}=F(),d=h=>{i(h),l(!0)},g=(0,v.useCallback)(()=>{t("configuration"),l(!1)},[]);return[(0,v.useMemo)(()=>{if(!o)return null;const h=r===A.hY,x=h?"Internal Grafana Alertmanager":r;return(0,e.jsxs)(ce._,{onClose:g,title:x,subtitle:"Edit the Alertmanager configuration",tabs:(0,e.jsxs)(de.U,{children:[(0,e.jsx)(X.o,{label:"JSON Model",icon:"arrow",active:n==="configuration",onChangeTab:()=>t("configuration")},"configuration"),(0,e.jsx)(X.o,{label:"Versions",icon:"history",active:n==="versions",onChangeTab:()=>t("versions"),hidden:!h},"versions")]}),children:[n==="configuration"&&r&&(0,e.jsx)(ve,{alertmanagerName:r,onDismiss:g,onSave:u,onReset:s}),n==="versions"&&r&&(0,e.jsx)(Ve,{alertmanagerName:r})]})},[o,r,g,n,u,s]),d,g]}var Ye=a(83883),ze=a(3704),b=a(10860),He=a(72109),Ze=a(48205);function oe({name:n,href:t,url:r,logo:i="public/app/plugins/datasource/alertmanager/img/logo.svg",provisioned:o=!1,readOnly:l=o,showStatus:u=!0,implementation:s,receiving:d=!1,status:g="unknown",onEditConfiguration:S,onEnable:h,onDisable:x}){const j=!o&&!!h&&!!x;return(0,e.jsxs)(b.Z,{"data-testid":`alertmanager-card-${n}`,children:[(0,e.jsx)(b.Z.Heading,{children:(0,e.jsxs)(C.B,{alignItems:"center",gap:1,children:[t?(0,e.jsx)(K.d,{title:"Alerting settings",component:(0,e.jsx)(He.Y,{href:t,inline:!1,children:n})}):n,o&&(0,e.jsx)(Ze.rS,{})]})}),(0,e.jsx)(b.Z.Figure,{children:(0,e.jsx)("img",{alt:`logo for ${n}`,src:i})}),(0,e.jsx)(b.Z.Meta,{children:(0,e.jsxs)(C.B,{direction:"column",gap:1,alignItems:"flex-start",children:[(0,e.jsxs)(b.Z.Meta,{children:[s&&(0,O.capitalize)(s),r&&r]}),u?(0,e.jsx)(e.Fragment,{children:d?(0,e.jsxs)(e.Fragment,{children:[g==="pending"&&(0,e.jsx)(B.E,{text:"Activation in progress",color:"orange"}),g==="active"&&(0,e.jsx)(B.E,{text:"Receiving Grafana-managed alerts",color:"green"}),g==="dropped"&&(0,e.jsx)(B.E,{text:"Failed to adopt Alertmanager",color:"red"}),g==="inconclusive"&&(0,e.jsx)(B.E,{text:"Inconclusive",color:"orange"})]}):(0,e.jsx)(I.E,{variant:"bodySmall",children:"Not receiving Grafana managed alerts"})}):null]})}),(0,e.jsx)(b.Z.Tags,{children:(0,e.jsxs)(C.B,{direction:"row",gap:1,children:[(0,e.jsx)(p.$n,{onClick:S,icon:l?"eye":"edit",variant:"secondary",fill:"outline",children:l?"View configuration":"Edit configuration"}),j?(0,e.jsx)(e.Fragment,{children:d?(0,e.jsx)(p.$n,{icon:"times",variant:"destructive",fill:"outline",onClick:x,children:"Disable"}):(0,e.jsx)(p.$n,{icon:"check",variant:"secondary",fill:"outline",onClick:h,children:"Enable"})}):null]})})]})}const Qe=({onEditConfiguration:n})=>{const{externalAlertmanagerDataSourcesWithStatus:t,configuration:r,enableAlertmanager:i,disableAlertmanager:o,forwardingDisabled:l}=F(),u=s=>{const d=[M.nA.All,M.nA.External].some(S=>r?.alertmanagersChoice===S),g=(0,A.iV)(s.dataSourceSettings);return d&&g};return(0,e.jsx)(C.B,{direction:"column",gap:0,children:t.map(s=>{const{uid:d,name:g,jsonData:S,url:h}=s.dataSourceSettings,{status:x}=s,j=u(s),y=(0,A.yc)(s.dataSourceSettings),N=(0,A.AL)(s.dataSourceSettings.name),R=(0,ze.G)(Ye.I.Edit.replace(/:uid/gi,d)),f=()=>n(g),c=l?void 0:()=>i(d),m=l?void 0:()=>o(d);return(0,e.jsx)(oe,{name:g,href:R,url:h,provisioned:y,readOnly:N,showStatus:!l,implementation:S.implementation??"Prometheus",receiving:j,status:x,onEditConfiguration:f,onDisable:m,onEnable:c},d)})})},Ke="Grafana built-in";function Xe({onEditConfiguration:n}){const{configuration:t,enableAlertmanager:r,disableAlertmanager:i,forwardingDisabled:o}=F(),l=re(t),u=l?"active":"uninterested",s=()=>n(A.hY),d=o?void 0:()=>r(A.hY),g=o?void 0:()=>i(A.hY);return(0,e.jsx)(oe,{name:Ke,logo:"public/img/grafana_icon.svg",status:u,receiving:l,onEditConfiguration:s,onEnable:d,onDisable:g})}function ke(){return(0,e.jsx)(Ne,{children:(0,e.jsx)(qe,{})})}function qe(){const[n,t]=We(),{isLoading:r}=F();return(0,e.jsxs)(G.d,{navId:"alerting-admin",isLoading:r,actions:[(0,e.jsx)(K.d,{title:"Alerting settings",component:(0,e.jsx)(p.z9,{href:"/connections/datasources/alertmanager",icon:"plus",variant:"primary",children:"Add new Alertmanager"})},"add-alertmanager")],children:[(0,e.jsxs)(C.B,{direction:"column",gap:2,children:[(0,e.jsx)(I.E,{variant:"h5",children:"Built-in Alertmanager"}),(0,e.jsx)(Xe,{onEditConfiguration:t}),(0,e.jsx)(I.E,{variant:"h5",children:"Other Alertmanagers"}),(0,e.jsx)(Qe,{onEditConfiguration:t})]}),n]})}},51488:(le,$,a)=>{a.d($,{f:()=>p});var e=a(82843);function p(C,I){const G=e.m.endpoints.getAlertmanagerConfiguration.useQuery(C??"",{refetchOnMountOrArgChange:!0,...I,skip:!C});return{...G,error:G.error}}}}]);

//# sourceMappingURL=AlertingSettings.51e2844c4b5205461122.js.map