"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[8779],{4417:be=>{be.exports=function(V,o){return o||(o={}),V&&(V=String(V.__esModule?V.default:V),/^['"].*['"]$/.test(V)&&(V=V.slice(1,-1)),o.hash&&(V+=o.hash),/["'() \t\n]|(%20)/.test(V)||o.needQuotes?'"'.concat(V.replace(/"/g,'\\"').replace(/\n/g,"\\n"),'"'):V)}},80907:(be,V,o)=>{o.r(V),o.d(V,{default:()=>Zo});var t=o(74848),X=o(54148),z=o(16817),A=o(32264),g=o(96540),me=o(84596),_=o(64388),ae=o(81887),ie=o(90613),H=o(42418),j=o(21780),w=o(39419),J=o(33390),k=o(20470),P=o(31678),u=o(32196),ye=o(24180),x=o(39601),B=o(71678),D=o(40845),G=o(37390),b=o(55852),ee=o(16233),Tn=o(1951),mt=o(74730);const ft=(0,g.memo)(({dashboard:e})=>{const n=(0,g.useMemo)(()=>x.Ny.getLocation().pathname,[e]),{showModal:s,hideModal:a}=(0,g.useContext)(B.wE);(0,g.useEffect)(()=>{const r=l=>{vt(e,e.getInitialSaveModel())||e.state.isDirty&&(l.preventDefault(),l.returnValue="")};return window.addEventListener("beforeunload",r),()=>window.removeEventListener("beforeunload",r)},[e]);const i=r=>{const l=e.state.editPanel,d=l?.getPanel(),c=new URLSearchParams(r.search);if(l&&d&&(0,mt.ME)(d)&&l.state.isDirty&&!c.has("editPanel")){const h=(0,mt.iL)(d);return s(Tn.Z,{dashboard:e,isUnsavedPrompt:!0,libraryPanel:h,onConfirm:()=>{l.onConfirmSaveLibraryPanel(),a(),je(r)},onDiscard:()=>{l.onDiscard(),a(),je(r)},onDismiss:a}),!1}return n===r.pathname||vt(e,e.getInitialSaveModel())||!e.state.isDirty?!0:(s(Nn,{dashboard:e,onSaveDashboardClick:()=>{a(),e.openSaveDrawer({onSaveSuccess:()=>{je(r)}})},onDiscard:()=>{e.exitEditMode({skipConfirm:!0}),a(),je(r)},onDismiss:a}),!1)};return(0,t.jsx)(ye.XG,{when:!0,message:i})});ft.displayName="DashboardPrompt";function je(e){e&&setTimeout(()=>x.Ny.push(e),10)}const Nn=({onDiscard:e,onDismiss:n,onSaveDashboardClick:s})=>{const a=(0,D.of)(En);return(0,t.jsxs)(G.a,{isOpen:!0,title:"Unsaved changes",onDismiss:n,icon:"exclamation-triangle",className:a.modal,children:[(0,t.jsx)("h5",{children:"Do you want to save your changes?"}),(0,t.jsxs)(G.a.ButtonRow,{children:[(0,t.jsx)(b.$n,{variant:"secondary",onClick:n,fill:"outline",children:"Cancel"}),(0,t.jsx)(b.$n,{variant:"destructive",onClick:e,children:"Discard"}),(0,t.jsx)(b.$n,{onClick:s,children:"Save dashboard"})]})]})},En=()=>({modal:(0,u.css)({width:"500px"})});function vt(e,n){if(!n||n.version===0||!ee.TP.isSignedIn||!e)return!0;const{canSave:s,fromScript:a,fromFile:i}=e.state.meta;return!ee.TP.isEditor&&!s?!0:!s||a||i}var xt=o(72255);function In({route:e,queryParams:n,history:s}){const a=(0,X.g)(),{type:i,slug:r,uid:l}=a,d=(0,me.A)({params:a}),c=(0,xt.sP)(),{dashboard:h,isLoading:p,loadError:m}=c.useState(),f=s.location.state?.routeReloadCounter,E=(0,g.useMemo)(()=>!!J.A.getObject(k.us),[l,r,i]);return(0,g.useEffect)(()=>(e.routeName===P.DashboardRoutes.Normal&&i==="snapshot"?c.loadSnapshot(r):c.loadDashboard({uid:l??"",route:e.routeName,urlFolderUid:n.folderUid,keepDashboardFromExploreInLocalStorage:!1}),()=>{c.clearState()}),[c,l,e.routeName,n.folderUid,f,r,i]),(0,g.useEffect)(()=>{h&&E&&e.routeName!==P.DashboardRoutes.New&&h.onEnterEditMode(E)},[h,E,e.routeName]),h?i!=="snapshot"&&(!d||l!==d?.params.uid)?(console.log("skipping rendering"),null):(0,t.jsxs)(ae.$L,{scene:h,updateUrlOnInit:!0,createBrowserHistorySteps:!0,children:[(0,t.jsx)(h.Component,{model:h},h.state.key),(0,t.jsx)(ft,{dashboard:h})]}):(0,t.jsx)(j.YW,{navId:"dashboards/browse",layout:_.k.Canvas,"data-testid":"dashboard-scene-page",children:(0,t.jsxs)(ie.a,{paddingY:4,display:"flex",direction:"column",alignItems:"center",children:[p&&(0,t.jsx)(w.A,{}),m&&(0,t.jsx)(H.F,{title:"Dashboard failed to load",severity:"error","data-testid":"dashboard-not-found",children:m})]})})}const bt=In;var oe=o(71468),Se=o(71733),y=o(13544),yt=o(82467),$e=o(75269),Mn=o(7392),wn=o(76888),ze=o(3169);function An(e){switch(e.kiosk){case"tv":return P.KioskMode.TV;case"1":case!0:return P.KioskMode.Full;default:return null}}var Ln=o(91219),We=o(17422),Ce=o(6473),Vn=o(66827),Rn=o(8480);const On=()=>{const e=new URL(window.location.toString()),n=new URLSearchParams(e.search);n.forEach((s,a)=>{if(a.startsWith("__feature.")){const i=a.substring(10);Rn.mz.has(i)&&n.delete(a)}}),window.location.href=new URL(e.origin+e.pathname+"?"+n.toString()).toString()},Un=()=>{window.open("https://github.com/grafana/grafana/issues/new?assignees=&labels=&projects=&template=0-bug-report.yaml&title=Product+Area%3A+Short+description+of+bug")};function Fn({dashboardUid:e}){const n=(0,D.of)(Bn),[s,a]=(0,g.useState)(!0);return s?(0,t.jsx)(H.F,{severity:"info",title:"This dashboard was migrated from Angular. Please make sure everything is behaving as expected and save and refresh this dashboard to persist the migration.",onRemove:()=>a(!1),children:(0,t.jsxs)("div",{className:"markdown-html",children:[(0,t.jsx)(b.$n,{fill:"outline",size:"sm",className:n.linkButton,onClick:Un,children:"Report issue"}),(0,t.jsx)(b.$n,{fill:"outline",size:"sm",className:n.linkButton,onClick:On,children:"Revert migration"})]})}):null}const Bn=e=>({linkButton:(0,u.css)({marginRight:10})});var qo=o(53652);function _o(){const{slug:e=""}=useParams(),n=useAsync(()=>getGrafanaStorage().list("content/"+e),[e]),s=e.length>0?`g/${e}/`:"g/",a=jt(e),i=()=>n.value?n.value.fields[0].values.map(d=>{let c=d;const h=c.indexOf(".")<0,p=!h&&c.endsWith(".json"),m=`${s}${c}`;return jsxs(Card,{href:h||p?m:void 0,children:[jsx(Card.Heading,{children:c}),jsx(Card.Figure,{children:jsx(Icon,{name:h?"folder":p?"gf-grid":"file-alt",size:"sm"})})]},c)}):n.loading?jsx(Spinner,{}):jsx("div",{children:"?"}),r=St();return jsx(Page,{navModel:r,pageNav:a,children:i()})}function jt(e){const n=e.split("/");let s=[],a="g",i;for(let r=0;r<n.length;r++)a+=`/${n[r]}`,s.push({text:n[r],url:a,parentItem:i}),i=s[s.length-1];return i}function St(){return{main:{text:"C:"},node:{text:"Content",url:"/g"}}}const er=null;var Z=o(28444),ke=o(72401),L=o(75096),Pe=o(10354),q=o(14578),Ge=o(40276),Ct=o(36974),$n=o(48889),Pt=o(17706);const zn=()=>{const e=(0,D.of)(Wn),[n,s]=(0,g.useState)(""),a=(0,P.useSelector)(d=>d.dashboard.getModel()),i=(0,g.useMemo)(()=>(0,Pt.nr)(),[]),r=(0,g.useMemo)(()=>(0,Pt.CO)(i,n),[i,n]),l=()=>{x.Ny.partial({addWidget:null})};return(0,t.jsxs)(G.a,{title:"Select widget type",closeOnEscape:!0,closeOnBackdropClick:!0,isOpen:!0,className:e.modal,onClickBackdrop:l,onDismiss:l,children:[(0,t.jsx)(Pe.p,{type:"search",autoFocus:!0,className:e.searchInput,value:n,prefix:(0,t.jsx)(q.I,{name:"search"}),placeholder:"Search widget",onChange:d=>{s(d.currentTarget.value)}}),(0,t.jsx)(Ge.E,{children:(0,t.jsx)("div",{className:e.grid,children:r.map((d,c)=>(0,t.jsx)($n.f,{disabled:!1,isCurrent:!1,plugin:d,onClick:h=>{const p=(0,Ct.ob)(a,d.id);x.Ny.partial({editPanel:p,addWidget:null})}},d.id))})})]})},Wn=e=>({modal:(0,u.css)({width:"65%",maxWidth:"960px",[e.breakpoints.down("md")]:{width:"100%"}}),searchInput:(0,u.css)({marginBottom:e.spacing(2)}),grid:(0,u.css)({display:"grid",gridGap:e.spacing(1)})});var Dt=o(20120),kn=o(82138),Gn=o(9980),he=o(2543),Kn=o(28138),Hn=o(40996),Qn=o(57767),Jn=o(43535),Yn=o(88861);const Tt=({panel:e,folderUid:n,isUnsavedPrompt:s,onDismiss:a,onConfirm:i,onDiscard:r})=>{const[l,d]=(0,g.useState)(""),c=(0,z.A)(async()=>{const C=await(0,Qn.xV)(e.libraryPanel.uid);return C.length>0?C.map(R=>R.title):[]},[e.libraryPanel.uid]),[h,p]=(0,g.useState)([]);(0,Hn.A)(()=>c.value?p(c.value.filter(C=>C.toLowerCase().includes(l.toLowerCase()))):p([]),300,[c.value,l]);const{saveLibraryPanel:m}=(0,Yn.b)(),f=(0,D.of)(Jn.o),E=(0,g.useCallback)(()=>{r()},[r]),T=s?"Unsaved library panel changes":"Save library panel";return(0,t.jsx)(G.a,{title:T,icon:"save",onDismiss:a,isOpen:!0,children:(0,t.jsxs)("div",{children:[(0,t.jsxs)("p",{className:f.textInfo,children:["This update will affect ",(0,t.jsxs)("strong",{children:[e.libraryPanel.meta?.connectedDashboards," ",e.libraryPanel.meta?.connectedDashboards===1?"dashboard":"dashboards","."]}),"The following dashboards using the panel will be affected:"]}),(0,t.jsx)(Pe.p,{className:f.dashboardSearch,prefix:(0,t.jsx)(q.I,{name:"search"}),placeholder:"Search affected dashboards",value:l,onChange:C=>d(C.currentTarget.value)}),c.loading?(0,t.jsx)("p",{children:"Loading connected dashboards..."}):(0,t.jsxs)("table",{className:f.myTable,children:[(0,t.jsx)("thead",{children:(0,t.jsx)("tr",{children:(0,t.jsx)("th",{children:"Dashboard name"})})}),(0,t.jsx)("tbody",{children:h.map((C,R)=>(0,t.jsx)("tr",{children:(0,t.jsx)("td",{children:C})},`dashrow-${R}`))})]}),(0,t.jsxs)(G.a.ButtonRow,{children:[(0,t.jsx)(b.$n,{variant:"secondary",onClick:a,fill:"outline",children:"Cancel"}),s&&(0,t.jsx)(b.$n,{variant:"destructive",onClick:E,children:"Discard"}),(0,t.jsx)(b.$n,{onClick:()=>{m(e,n).then(()=>{i()})},children:"Update all"})]})]})})};var Xn=o(98365),Nt=o(19752),Ke=o(79971),Et=o(80095),te=o(53466);function Zn(e,n){return async s=>{const a=n.initEditPanel(e);s((0,te.GU)({panel:a,sourcePanel:e}))}}function It(){return async(e,n)=>{const{getPanel:s}=n().panelEditor;s().configRev=0,e((0,te.MJ)(!0))}}function qn(e,n){return s=>{if(e.libraryPanel?.uid===void 0||!n)return;const a=e.getSaveModel();for(const i of n.panels){if(_n(e,i))continue;i.restoreModel({...a,...(0,he.pick)(i,"gridPos","id")});const r=i.plugin?.meta.id!==e.plugin?.meta.id;i.plugin=e.plugin,i.configRev++,r&&(i.generateNewKey(),s((0,Et.XM)({key:i.key,plugin:i.plugin}))),setTimeout(()=>{i.getQueryRunner().useLastResultFrom(e.getQueryRunner())},20)}e.repeat&&setTimeout(()=>n.processRepeats(),20)}}function _n(e,n){return!!(n.libraryPanel?.uid!==e.libraryPanel.uid||n.id&&n.id===e.id||n.repeatPanelId)}function es(){return async(e,n)=>{const s=n().dashboard.getModel(),{getPanel:a,getSourcePanel:i,shouldDiscardChanges:r}=n().panelEditor,l=a();s&&s.exitPanelEditor();const d=i();if(ts(l)&&!r){const c=l.getSaveModel(),h=d.type!==l.type;e(qn(l,s)),d.restoreModel(c),d.configRev++,h&&(d.plugin=l.plugin,d.generateNewKey(),await e((0,Et.XM)({key:d.key,plugin:l.plugin}))),setTimeout(()=>{d.getQueryRunner().useLastResultFrom(l.getQueryRunner()),d.render(),l.hasSavedPanelEditChange&&!l.hasChanged&&(d.configRev=0)},20)}d.isNew&&(r?s&&(0,Nt.FC)(s,d,!0):delete d.isNew),e((0,Ke.O6)(l.key)),e((0,te.Ox)())}}function ts(e){return e.hasChanged||e.hasSavedPanelEditChange||e.isAngularPlugin()}function He(e){return(n,s)=>{const a={...s().panelEditor.ui,...e};n((0,te.fR)(a));try{J.A.setObject(te.wi,a)}catch(i){console.error(i)}}}var Qe=o(78050);const ns=({dashboard:e,onSaveSuccess:n,onDiscard:s,onDismiss:a})=>(0,t.jsxs)(G.a,{isOpen:!0,title:"Unsaved changes",onDismiss:a,icon:"exclamation-triangle",className:(0,u.css)({width:"500px"}),children:[(0,t.jsx)("h5",{children:"Do you want to save your changes?"}),(0,t.jsxs)(G.a.ButtonRow,{children:[(0,t.jsx)(b.$n,{variant:"secondary",onClick:a,fill:"outline",children:"Cancel"}),(0,t.jsx)(b.$n,{variant:"destructive",onClick:s,children:"Discard"}),(0,t.jsx)(Qe.C,{dashboard:e,onSaveSuccess:n})]})]}),Mt=(0,g.memo)(({dashboard:e})=>{const[n,s]=(0,g.useState)({original:null}),a=(0,P.useDispatch)(),{original:i,originalPath:r}=n,{showModal:l,hideModal:d}=(0,g.useContext)(B.wE);(0,g.useEffect)(()=>{const h=setTimeout(()=>{const m=x.Ny.getLocation().pathname,f=e.getSaveModelCloneOld();s({originalPath:m,original:f})},1e3),p=Kn.l.subscribe(Z.Eu,()=>{const m=e.getSaveModelCloneOld();s({originalPath:r,original:m})});return()=>{clearTimeout(h),p.unsubscribe()}},[e,r]),(0,g.useEffect)(()=>{const h=p=>{wt(e,i)||Lt(e,i)&&(p.preventDefault(),p.returnValue="")};return window.addEventListener("beforeunload",h),()=>window.removeEventListener("beforeunload",h)},[e,i]);const c=h=>{const p=e.panelInEdit,m=new URLSearchParams(h.search);return p&&p.libraryPanel&&p.hasChanged&&!m.has("editPanel")?(l(Tt,{isUnsavedPrompt:!0,panel:e.panelInEdit,folderUid:e.meta.folderUid??"",onConfirm:()=>{d(),De(h)},onDiscard:()=>{a(It()),De(h),d()},onDismiss:d}),!1):r===h.pathname||!i?(p&&!m.has("editPanel")&&a(es()),!0):wt(e,i)||!Lt(e,i)?!0:(l(ns,{dashboard:e,onSaveSuccess:()=>{d(),De(h)},onDiscard:()=>{s({...n,original:null}),d(),De(h)},onDismiss:d}),!1)};return(0,t.jsx)(ye.XG,{when:!0,message:c})});Mt.displayName="DashboardPrompt";function De(e){e&&setTimeout(()=>x.Ny.push(e),10)}function wt(e,n){if(!n||n.version===0||!ee.TP.isSignedIn||!e)return!0;const{canSave:s,fromScript:a,fromFile:i}=e.meta;return!ee.TP.isEditor&&!s?!0:!s||a||i}function At(e){const n=new Xn.G(e);n.expandRows();const s=n.getSaveModelClone();if(delete s.time,delete s.refresh,s.schemaVersion=0,delete s.timezone,s.panels=[],s.templating?.list)for(const a of s.templating.list)delete a.current,delete a.options,delete a.filters;return s}function Lt(e,n){if(e.hasUnsavedChanges())return!0;const s=At(e.getSaveModelCloneOld()),a=At(n),i=(0,he.find)(s.nav,{type:"timepicker"}),r=(0,he.find)(a.nav,{type:"timepicker"});i&&r&&(i.now=r.now);const l=JSON.stringify(s,null),d=JSON.stringify(a,null);return l!==d}var Te=o(15068),F=o(67061),Ne=o(94753),v=o(8484),Vt=o(14644),ne=o(14110),Je=o(57418),re=o(66864),Ye=o(62930),Ee=o(56034),ue=o(29158),Xe=o(2223);const ss=({id:e,usages:n})=>{const s=(0,g.useMemo)(()=>n.find(i=>i.variable.id===e),[e,n]);if(!s)return null;const a=s.nodes.map(i=>i.label.includes(`$${e}`)?{...i,color:"#FB7E81"}:i);return(0,t.jsx)(Xe.i,{show:!1,title:`Showing usages for: $${e}`,nodes:a,edges:s.edges,children:({showModal:i})=>(0,t.jsx)(ue.K,{onClick:()=>i(),name:"code-branch",tooltip:"Show usages","data-testid":"VariablesUnknownButton"})})};var le=o(12846);const as=1e3;function is({variables:e,dashboard:n}){const[s,a]=(0,g.useState)(!1),[i,r]=(0,g.useState)(0),[l,d]=(0,g.useState)([]),c=(0,D.of)(Ze);(0,g.useEffect)(()=>r(m=>m+1),[e,n]);const{loading:h}=(0,z.A)(async()=>{if(s&&i>0){const m=Date.now(),f=await(0,le.g0)(e,n),T=Date.now()-m;return T>=as&&(0,ne.rR)("Slow unknown variables expansion",{elapsed:T}),r(0),d(f),f}return[]},[e,n,s,i]),p=m=>{m&&(0,ne.rR)("Unknown variables section expanded"),a(m)};return(0,t.jsx)("div",{className:c.container,children:(0,t.jsxs)(Je.M,{label:(0,t.jsx)(os,{}),isOpen:s,onToggle:p,children:[h&&(0,t.jsx)(re.gW,{justify:"center",children:(0,t.jsxs)(re.Gy,{justify:"center",children:[(0,t.jsx)("span",{children:"Loading..."}),(0,t.jsx)(Ye.y,{})]})}),!h&&l&&(0,t.jsxs)(t.Fragment,{children:[l.length===0&&(0,t.jsx)(rs,{}),l.length>0&&(0,t.jsx)(ls,{usages:l})]})]})})}function os(){const e=(0,D.of)(Ze);return(0,t.jsxs)("h5",{children:["Renamed or missing variables",(0,t.jsx)(Ee.m,{content:"Click to expand a list with all variable references that have been renamed or are missing from the dashboard.",children:(0,t.jsx)(q.I,{name:"info-circle",className:e.infoIcon})})]})}function rs(){return(0,t.jsx)("span",{children:"No renamed or missing variables found."})}function ls({usages:e}){const n=(0,D.of)(Ze);return(0,t.jsxs)("table",{className:"filter-table filter-table--hover",children:[(0,t.jsx)("thead",{children:(0,t.jsxs)("tr",{children:[(0,t.jsx)("th",{children:"Variable"}),(0,t.jsx)("th",{colSpan:5})]})}),(0,t.jsx)("tbody",{children:e.map(s=>{const{variable:a}=s,{id:i,name:r}=a;return(0,t.jsxs)("tr",{children:[(0,t.jsx)("td",{className:n.firstColumn,children:(0,t.jsx)("span",{children:r})}),(0,t.jsx)("td",{className:n.defaultColumn}),(0,t.jsx)("td",{className:n.defaultColumn}),(0,t.jsx)("td",{className:n.defaultColumn}),(0,t.jsx)("td",{className:n.lastColumn,children:(0,t.jsx)(ss,{id:a.id,usages:e})})]},i)})})]})}const Ze=e=>({container:(0,u.css)`
    margin-top: ${e.spacing(4)};
    padding-top: ${e.spacing(4)};
  `,infoIcon:(0,u.css)`
    margin-left: ${e.spacing(1)};
  `,defaultColumn:(0,u.css)`
    width: 1%;
  `,firstColumn:(0,u.css)`
    width: 1%;
    vertical-align: top;
    color: ${e.colors.text.maxContrast};
  `,lastColumn:(0,u.css)`
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    width: 100%;
    text-align: right;
  `});var W=o(48594),K=o(87421),se=o(56968),qe=o(96374);function Rt({varName:e,isOpen:n=!1,onConfirm:s,onDismiss:a}){return(0,t.jsx)(qe.u,{title:"Delete variable",isOpen:n,onConfirm:s,onDismiss:a,body:`
      Are you sure you want to delete variable "${e}"?
    `,modalClass:ds.modal,confirmText:"Delete"})}const ds={modal:(0,u.css)({width:"max-content",maxWidth:"80vw"})};var Ie=o(39070),cs=o(8964),hs=o(58975),us=o(85140),Ot=o(14329),ps=o(41820),_e=o(20601),et=o(24240),gs=o(89458);function ms({onChange:e,type:n}){const s=(0,g.useMemo)(()=>(0,L.AX)(),[]),a=(0,g.useMemo)(()=>s.find(i=>i.value===n)??s[0],[s,n]);return(0,t.jsx)(gs.v,{name:"Select variable type",value:a,options:s,onChange:e,testId:y.Tp.pages.Dashboard.Settings.Variables.Edit.General.generalTypeSelectV2})}var fs=o(27238),fe=o(3843);const vs=e=>async n=>{const{rootStateKey:s}=e;n((0,W.kb)(s,(0,fe.sJ)({name:(0,K.dn)(e).name,id:e.id})))},xs=e=>async(n,s)=>{const{rootStateKey:a}=e;n((0,W.kb)(a,(0,fe.T7)((0,L.qD)(e))))},bs=(e,n)=>(s,a)=>{const{id:i,rootStateKey:r}=e;let l=null;if(n.match(/^(?!__).*$/)||(l="Template names cannot begin with '__', that's reserved for Grafana's global variables"),n.match(/^\w+$/)||(l="Only word characters are allowed in variable names"),(0,K.SS)(r,a()).filter(h=>h.name===n&&h.id!==i).length&&(l="Variable with the same name already exists"),l){s((0,W.kb)(r,(0,fe.DW)({newName:n,errorText:l})));return}s(ys(e,n))},ys=(e,n)=>(s,a)=>{const{rootStateKey:i}=e,r=(0,K.dn)(e,a());if(r.name===n){s((0,W.kb)(i,(0,fe.FN)((0,L.qD)(e,{newName:n}))));return}const l={...(0,he.cloneDeep)(r),name:n,id:n},d=r.global,c=r.index,h=(0,L.jX)(l);s((0,W.kb)(i,(0,se.QV)((0,L.qD)(h,{global:d,index:c,model:l})))),s((0,W.kb)(i,(0,fe.FN)((0,L.qD)(h,{newName:n})))),s((0,W.kb)(i,(0,se.Hr)((0,L.qD)(e,{reIndex:!1}))))},js=(e,n="query")=>(s,a)=>{const i=(0,L.q4)(e),r=(0,K.SS)(i,a()),l=Cs(n,r),d={type:n,id:l},c=!1,h=(0,K.hk)(i,a()),p=(0,he.cloneDeep)(_e.B.get(n).initialState);p.id=l,p.name=l,p.rootStateKey=i,s((0,W.kb)(i,(0,se.QV)((0,L.qD)(d,{global:c,model:p,index:h})))),x.Ny.partial({editIndex:r.length})},Ss=e=>(n,s)=>{const a=(0,L.q4)(e),i=s(),r=(0,K.nS)(a,i),l=i.dashboard.getModel(),{usages:d}=(0,le.hM)(r,l),c=(0,le.Ow)(d);n((0,W.kb)(a,(0,fs.bX)({usages:d,usagesNetwork:c})))};function Cs(e,n){let s=0,a=`${e}${s}`;for(;n.find(i=>i.id===a);)a=`${e}${++s}`;return a}var Ps=o(85830);const Ds=(e,n)=>({editor:(0,K.nx)(n.identifier.rootStateKey,e).editor,variable:(0,K.dn)(n.identifier,e)}),Ts=e=>({...(0,Vt.bindActionCreators)({variableEditorMount:vs,variableEditorUnMount:xs,changeVariableName:bs,updateOptions:ke.mZ},e),changeVariableProp:(n,s,a)=>e((0,W.kb)(n.rootStateKey,(0,se.QP)((0,L.qD)(n,{propName:s,propValue:a})))),changeVariableType:(n,s)=>e((0,W.kb)(n.rootStateKey,(0,se.l_)((0,L.qD)(n,{newType:s})))),removeVariable:n=>{e((0,W.kb)(n.rootStateKey,(0,se.Hr)((0,L.qD)(n,{reIndex:!0}))))}}),Ns=(0,oe.connect)(Ds,Ts);class Es extends g.PureComponent{constructor(){super(...arguments),this.state={showDeleteModal:!1},this.onNameChange=n=>{n.preventDefault(),this.props.changeVariableName(this.props.identifier,n.currentTarget.value)},this.onTypeChange=n=>{n.value&&this.props.changeVariableType(this.props.identifier,n.value)},this.onLabelChange=n=>{n.preventDefault(),this.props.changeVariableProp(this.props.identifier,"label",n.currentTarget.value)},this.onDescriptionChange=n=>{this.props.changeVariableProp(this.props.identifier,"description",n.currentTarget.value)},this.onHideChange=n=>{this.props.changeVariableProp(this.props.identifier,"hide",n)},this.onPropChanged=({propName:n,propValue:s,updateOptions:a=!1})=>{this.props.changeVariableProp(this.props.identifier,n,s),a&&this.props.updateOptions((0,L.jX)(this.props.variable))},this.onHandleSubmit=async n=>{n.preventDefault(),this.props.editor.isValid&&this.props.updateOptions((0,L.jX)(this.props.variable))},this.onModalOpen=()=>{this.setState({showDeleteModal:!0})},this.onModalClose=()=>{this.setState({showDeleteModal:!1})},this.onDelete=()=>{this.props.removeVariable(this.props.identifier),this.onModalClose(),x.Ny.partial({editIndex:null})},this.onApply=()=>{x.Ny.partial({editIndex:null})},this.getVariableOptions=()=>{const{variable:n}=this.props;return(0,et.SP)(n)?n.options.map(s=>({label:String(s.text),value:String(s.value)})):[]}}componentDidMount(){this.props.variableEditorMount(this.props.identifier)}componentWillUnmount(){this.props.variableEditorUnMount(this.props.identifier)}render(){const{theme:n,variable:s}=this.props,a=_e.B.get(this.props.variable.type).editor;if(!a)return null;const i=s.state===Ie.Gu.Loading,r=window.matchMedia("(prefers-reduced-motion: reduce)").matches,l=ws(n);return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("form",{"aria-label":"Variable editor Form",onSubmit:this.onHandleSubmit,children:[(0,t.jsx)(ms,{onChange:this.onTypeChange,type:this.props.variable.type}),(0,t.jsx)(hs.Y,{children:"General"}),(0,t.jsx)(Ot._,{value:this.props.editor.name,onChange:this.onNameChange,name:"Name",placeholder:"Variable name",description:"The name of the template variable. (Max. 50 characters)",invalid:!!this.props.editor.errors.name,error:this.props.editor.errors.name,testId:y.Tp.pages.Dashboard.Settings.Variables.Edit.General.generalNameInputV2,maxLength:Ps.M.MaxSize,required:!0}),(0,t.jsx)(Ot._,{name:"Label",description:"Optional display name",value:this.props.variable.label??"",placeholder:"Label name",onChange:this.onLabelChange,testId:y.Tp.pages.Dashboard.Settings.Variables.Edit.General.generalLabelInputV2}),(0,t.jsx)(us.Z,{name:"Description",value:s.description??"",placeholder:"Descriptive text",onChange:this.onDescriptionChange,width:52}),(0,t.jsx)(cs.D,{onChange:this.onHideChange,hide:this.props.variable.hide,type:this.props.variable.type}),a&&(0,t.jsx)(a,{variable:this.props.variable,onPropChange:this.onPropChanged}),(0,et.SP)(this.props.variable)?(0,t.jsx)(ps.j,{options:this.getVariableOptions()}):null,(0,t.jsx)("div",{style:{marginTop:"16px"},children:(0,t.jsxs)(re.Gy,{spacing:"md",height:"inherit",children:[(0,t.jsx)(b.$n,{variant:"destructive",fill:"outline",onClick:this.onModalOpen,children:"Delete"}),(0,t.jsxs)(b.$n,{type:"submit","data-testid":y.Tp.pages.Dashboard.Settings.Variables.Edit.General.submitButton,disabled:i,variant:"secondary",children:["Run query",i&&(0,t.jsx)(q.I,{className:l.spin,name:r?"hourglass":"sync",size:"sm",style:{marginLeft:"2px"}})]}),(0,t.jsx)(b.$n,{variant:"primary",onClick:this.onApply,"data-testid":y.Tp.pages.Dashboard.Settings.Variables.Edit.General.applyButton,children:"Apply"})]})})]}),(0,t.jsx)(Rt,{isOpen:this.state.showDeleteModal,varName:this.props.editor.name,onConfirm:this.onDelete,onDismiss:this.onModalClose})]})}}const Is=(0,D.cV)(Ns(Es)),Ms=(0,u.keyframes)({"0%":{transform:"rotate(0deg) scaleX(-1)"},"100%":{transform:"rotate(359deg) scaleX(-1)"}}),ws=e=>({spin:(0,u.css)({[e.transitions.handleMotion("no-preference")]:{animation:`${Ms} 3s linear infinite`}})});var tt=o(91076),Ut=o(69529),nt=o(72109);const As=({variables:e})=>{const n=(0,g.useMemo)(()=>(0,le.hI)(e),[e]),s=(0,g.useMemo)(()=>(0,le.qJ)(e),[e]);return s.length?(0,t.jsx)(Xe.i,{show:!1,title:"Dependencies",nodes:(0,le.H7)(n,s),edges:s,children:({showModal:a})=>(0,t.jsx)(b.$n,{onClick:()=>{(0,ne.rR)("Show variable dependencies"),a()},icon:"channel-add",variant:"secondary",children:"Show dependencies"})}):null},Ls=({id:e,usages:n,isAdhoc:s})=>{const a=(0,g.useMemo)(()=>n.find(r=>r.variable.id===e),[n,e]);if(n.length===0||s||!a)return null;const i=a.nodes.map(r=>r.label.includes(`$${e}`)?{...r,color:"#FB7E81"}:r);return(0,t.jsx)(Xe.i,{show:!1,title:`Showing usages for: $${e}`,nodes:i,edges:a.edges,children:({showModal:r})=>(0,t.jsx)(ue.K,{onClick:()=>{(0,ne.rR)("Show variable usages"),r()},name:"code-branch",tooltip:"Show usages"})})};function Vs({index:e,variable:n,usageTree:s,usagesNetwork:a,onEdit:i,onDuplicate:r,onDelete:l}){const d=(0,D.$j)(),c=(0,D.of)(Ft),h=Rs(n),m=(0,le.PK)(n.id,s)>0||n.type==="adhoc",f=(0,L.jX)(n);return(0,t.jsx)(tt.sx,{draggableId:JSON.stringify(f),index:e,children:(E,T)=>(0,t.jsxs)("tr",{ref:E.innerRef,...E.draggableProps,style:{userSelect:T.isDragging?"none":"auto",background:T.isDragging?d.colors.background.secondary:void 0,...E.draggableProps.style},children:[(0,t.jsx)("td",{role:"gridcell",className:c.column,children:(0,t.jsx)(b.$n,{size:"xs",fill:"text",onClick:C=>{C.preventDefault(),i(f)},className:c.nameLink,"aria-label":y.Tp.pages.Dashboard.Settings.Variables.List.tableRowNameFields(n.name),children:n.name})}),(0,t.jsx)("td",{role:"gridcell",className:c.definitionColumn,onClick:C=>{C.preventDefault(),i(f)},"aria-label":y.Tp.pages.Dashboard.Settings.Variables.List.tableRowDefinitionFields(n.name),children:h}),(0,t.jsx)("td",{role:"gridcell",className:c.column,children:(0,t.jsxs)("div",{className:c.icons,children:[(0,t.jsx)(Os,{passed:m}),(0,t.jsx)(Ls,{id:n.id,isAdhoc:n.type==="adhoc",usages:a}),(0,t.jsx)(ue.K,{onClick:C=>{C.preventDefault(),(0,ne.rR)("Duplicate variable"),r(f)},name:"copy",tooltip:"Duplicate variable","aria-label":y.Tp.pages.Dashboard.Settings.Variables.List.tableRowDuplicateButtons(n.name)}),(0,t.jsx)(ue.K,{onClick:C=>{C.preventDefault(),(0,ne.rR)("Delete variable"),l(f)},name:"trash-alt",tooltip:"Remove variable","aria-label":y.Tp.pages.Dashboard.Settings.Variables.List.tableRowRemoveButtons(n.name)}),(0,t.jsx)("div",{...E.dragHandleProps,className:c.dragHandle,children:(0,t.jsx)(q.I,{name:"draggabledots",size:"lg"})})]})})]})})}function Rs(e){let n="";return e.type==="query"?e.definition?n=e.definition:typeof e.query=="string"&&(n=e.query):(0,et.SP)(e)&&(n=e.query),n}function Os({passed:e}){const n=(0,D.of)(Ft);return e?(0,t.jsx)(q.I,{name:"check",className:n.iconPassed,title:"This variable is referenced by other variables or dashboard."}):(0,t.jsx)(q.I,{name:"exclamation-triangle",className:n.iconFailed,title:"This variable is not referenced by any variable or dashboard."})}function Ft(e){return{dragHandle:(0,u.css)`
      cursor: grab;
      margin-left: ${e.spacing(1)};
    `,column:(0,u.css)`
      width: 1%;
    `,nameLink:(0,u.css)`
      cursor: pointer;
      color: ${e.colors.primary.text};
    `,definitionColumn:(0,u.css)`
      width: 100%;
      max-width: 200px;
      cursor: pointer;
      overflow: hidden;
      text-overflow: ellipsis;
      -o-text-overflow: ellipsis;
      white-space: nowrap;
    `,iconPassed:(0,u.css)`
      color: ${e.v1.palette.greenBase};
      margin-right: ${e.spacing(2)};
    `,iconFailed:(0,u.css)`
      color: ${e.v1.palette.orange};
      margin-right: ${e.spacing(2)};
    `,icons:(0,u.css)`
      display: flex;
      gap: ${e.spacing(2)};
      align-items: center;
    `}}function Us({variables:e,usages:n,usagesNetwork:s,onChangeOrder:a,onAdd:i,onEdit:r,onDelete:l,onDuplicate:d}){const c=(0,D.of)(Bs),h=p=>{if(!p.destination||!p.source)return;(0,ne.rR)("Variable drag and drop");const m=JSON.parse(p.draggableId);a(m,e[p.source.index].index,e[p.destination.index].index)};return(0,t.jsx)("div",{children:(0,t.jsxs)("div",{children:[e.length===0&&(0,t.jsx)(Fs,{onAdd:i}),e.length>0&&(0,t.jsxs)(F.B,{direction:"column",gap:4,children:[(0,t.jsx)("div",{className:c.tableContainer,children:(0,t.jsxs)("table",{className:"filter-table filter-table--hover","aria-label":y.Tp.pages.Dashboard.Settings.Variables.List.table,role:"grid",children:[(0,t.jsx)("thead",{children:(0,t.jsxs)("tr",{children:[(0,t.jsx)("th",{children:"Variable"}),(0,t.jsx)("th",{children:"Definition"}),(0,t.jsx)("th",{colSpan:5})]})}),(0,t.jsx)(tt.JY,{onDragEnd:h,children:(0,t.jsx)(tt.gL,{droppableId:"variables-list",direction:"vertical",children:p=>(0,t.jsxs)("tbody",{ref:p.innerRef,...p.droppableProps,children:[e.map((m,f)=>(0,t.jsx)(Vs,{index:f,variable:m,usageTree:n,usagesNetwork:s,onDelete:l,onDuplicate:d,onEdit:r},`${m.name}-${f}`)),p.placeholder]})})})]})}),(0,t.jsxs)(F.B,{children:[(0,t.jsx)(As,{variables:e}),(0,t.jsx)(b.$n,{"aria-label":y.Tp.pages.Dashboard.Settings.Variables.List.newButton,onClick:i,icon:"plus",children:"New variable"})]})]})]})})}function Fs({onAdd:e}){return(0,t.jsx)(F.B,{direction:"column",children:(0,t.jsxs)(Ut.p,{variant:"call-to-action",button:(0,t.jsx)(b.$n,{"data-testid":y.Tp.components.CallToActionCard.buttonV2("Add variable"),icon:"calculator-alt",onClick:e,size:"lg",children:(0,t.jsx)(v.x6,{i18nKey:"variables.empty-state.button-title",children:"Add variable"})}),message:(0,v.t)("variables.empty-state.title","There are no variables added yet"),children:[(0,t.jsx)("p",{children:(0,t.jsx)(v.x6,{i18nKey:"variables.empty-state.info-box-content",children:"Variables enable more interactive and dynamic dashboards. Instead of hard-coding things like server or sensor names in your metric queries you can use variables in their place. Variables are shown as list boxes at the top of the dashboard. These drop-down lists make it easy to change the data being displayed in your dashboard."})}),(0,t.jsxs)(v.x6,{i18nKey:"variables.empty-state.info-box-content-2",children:["Check out the"," ",(0,t.jsx)(nt.Y,{external:!0,href:"https://grafana.com/docs/grafana/latest/variables/",children:"Templates and variables documentation"})," ","for more information."]})]})})}const Bs=()=>({tableContainer:(0,u.css)`
    overflow: scroll;
    width: 100%;
  `}),$s=(e,n)=>{const{uid:s}=n.dashboard,a=(0,K.nx)(s,e);return{variables:(0,K.nS)(s,e),idInEditor:a.editor.id,usagesNetwork:a.inspect.usagesNetwork,usages:a.inspect.usages}},zs=e=>({...(0,Vt.bindActionCreators)({createNewVariable:js,initListMode:Ss},e),changeVariableOrder:(n,s,a)=>e((0,W.kb)(n.rootStateKey,(0,se.hj)((0,L.qD)(n,{fromIndex:s,toIndex:a})))),duplicateVariable:n=>e((0,W.kb)(n.rootStateKey,(0,se.ut)((0,L.qD)(n,{newId:void 0})))),removeVariable:n=>{e((0,W.kb)(n.rootStateKey,(0,se.Hr)((0,L.qD)(n,{reIndex:!0}))))}}),Ws=(0,oe.connect)($s,zs);class ks extends g.PureComponent{constructor(){super(...arguments),this.state={variableId:void 0},this.onEditVariable=n=>{const s=this.props.variables.findIndex(a=>a.id===n.id);x.Ny.partial({editIndex:s})},this.onNewVariable=()=>{this.props.createNewVariable(this.props.dashboard.uid)},this.onChangeVariableOrder=(n,s,a)=>{this.props.changeVariableOrder(n,s,a)},this.onDuplicateVariable=n=>{this.props.duplicateVariable(n)},this.onModalOpen=n=>{this.setState({variableId:n})},this.onModalClose=()=>{this.setState({variableId:void 0})},this.onRemoveVariable=()=>{this.props.removeVariable(this.state.variableId),this.onModalClose()}}componentDidMount(){this.props.initListMode(this.props.dashboard.uid)}render(){const{editIndex:n,variables:s,sectionNav:a,toolbar:i}=this.props,r=n!=null?s[n]:void 0,d=a.node.parentItem,c=r?{text:r.name,parentItem:d}:d;return(0,t.jsxs)(j.YW,{toolbar:i,navModel:this.props.sectionNav,pageNav:c,children:[!r&&(0,t.jsx)(Us,{variables:this.props.variables,onAdd:this.onNewVariable,onEdit:this.onEditVariable,onChangeOrder:this.onChangeVariableOrder,onDuplicate:this.onDuplicateVariable,onDelete:this.onModalOpen,usages:this.props.usages,usagesNetwork:this.props.usagesNetwork}),!r&&this.props.variables.length>0&&(0,t.jsx)(is,{variables:this.props.variables,dashboard:this.props.dashboard}),r&&(0,t.jsx)(Is,{identifier:(0,L.jX)(r)}),(0,t.jsx)(Rt,{isOpen:this.state.variableId!==void 0,varName:this.state.variableId?.id??"",onConfirm:this.onRemoveVariable,onDismiss:this.onModalClose})]})}}const Gs=Ws(ks);var Ks=o(5108),Bt=o(10096);const Hs=({dashboard:e,sectionNav:n,toolbar:s})=>{const a=Bt.TP.hasPermission(P.AccessControlAction.DashboardsPermissionsWrite),i=n.node.parentItem;return(0,t.jsx)(j.YW,{navModel:n,pageNav:i,toolbar:s,children:(0,t.jsx)(Ks.x,{resource:"dashboards",resourceId:e.uid,canSetPermissions:a})})};var Me=o(22391),we=o(19347),$t=o(84167),$=o(88575),st=o(10880),at=o(90182),Qs=o(77268),it=o(2913),Js=o(82241),Ys=o(46502),Xs=o(51612);const zt="New annotation",Zs=({editIdx:e,dashboard:n})=>{const s=(0,D.of)(qs),[a,i]=(0,g.useState)(n.annotations.list[e]),r=(0,g.useMemo)(()=>a.filter?a.filter.exclude?2:1:0,[a.filter]),{value:l}=(0,z.A)(()=>(0,we.l)().get(a.datasource),[a.datasource]),d=(0,we.l)().getInstanceSettings(a.datasource),c=S=>{const M=[...n.annotations.list];M.splice(e,1,S),i(S),n.annotations.list=M},h=S=>{c({...a,name:S.currentTarget.value})},p=S=>{const M=(0,Me.p$)(S);a.datasource?.type!==M.type?c({datasource:M,builtIn:a.builtIn,enable:a.enable,iconColor:a.iconColor,name:a.name,hide:a.hide,filter:a.filter,mappings:a.mappings,type:a.type}):c({...a,datasource:M})},m=S=>{const M=S.currentTarget;c({...a,[M.name]:M.type==="checkbox"?M.checked:M.value})},f=S=>{c({...a,iconColor:S})},E=S=>{let M=S.value===0?void 0:{exclude:S.value===2,ids:a.filter?.ids??[]};c({...a,filter:M})},T=S=>{if(!Array.isArray(S))return;const M={exclude:r===2,ids:[]};S.forEach(ce=>ce.value&&M.ids.push(ce.value)),c({...a,filter:M})},C=Wt,R=()=>{x.Ny.partial({editview:null,editIndex:null})},O=()=>{const S=n.annotations.list;n.annotations.list=[...S.slice(0,e),...S.slice(e+1)],Wt()},U=a.name===zt,de=(S,M)=>S.label&&M.label?S.label.toLowerCase().localeCompare(M.label.toLowerCase()):-1,Y=(0,g.useMemo)(()=>n?.panels.filter(S=>it.Ay.panels[S.type]).map(S=>({value:S.id,label:S.title??`Panel ${S.id}`,description:S.description,imgUrl:it.Ay.panels[S.type].info.logos.small})).sort(de)??[],[n]);return(0,t.jsxs)("div",{children:[(0,t.jsxs)($t.n,{className:s.settingsForm,children:[(0,t.jsx)($.D,{label:"Name",children:(0,t.jsx)(Pe.p,{"data-testid":y.Tp.pages.Dashboard.Settings.Annotations.Settings.name,name:"name",id:"name",autoFocus:U,value:a.name,onChange:h})}),(0,t.jsx)($.D,{label:"Data source",htmlFor:"data-source-picker",children:(0,t.jsx)(Xs.s,{annotations:!0,variables:!0,current:a.datasource,onChange:p})}),!l?.meta.annotations&&(0,t.jsx)(H.F,{title:"No annotation support for this data source",severity:"error",children:(0,t.jsx)(v.x6,{i18nKey:"errors.dashboard-settings.annotations.datasource",children:"The selected data source does not support annotations. Please select a different data source."})}),(0,t.jsx)($.D,{label:"Enabled",description:"When enabled the annotation query is issued every dashboard refresh",children:(0,t.jsx)(st.S,{name:"enable",id:"enable",value:a.enable,onChange:m})}),(0,t.jsx)($.D,{label:"Hidden",description:"Annotation queries can be toggled on or off at the top of the dashboard. With this option checked this toggle will be hidden.",children:(0,t.jsx)(st.S,{name:"hide",id:"hide",value:a.hide,onChange:m})}),(0,t.jsx)($.D,{label:"Color",description:"Color to use for the annotation event markers",children:(0,t.jsx)(re.Gy,{children:(0,t.jsx)(Qs.a,{value:a?.iconColor,onChange:f})})}),(0,t.jsx)($.D,{label:"Show in","data-testid":y.Tp.pages.Dashboard.Settings.Annotations.NewAnnotation.showInLabel,children:(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(at.l6,{options:ea,value:r,onChange:E,"data-testid":y.Tp.components.Annotations.annotationsTypeInput}),r!==0&&(0,t.jsx)(at.KF,{options:Y,value:Y.filter(S=>a.filter?.ids.includes(S.value)),onChange:T,isClearable:!0,placeholder:"Choose panels",width:100,closeMenuOnSelect:!1,className:s.select,"data-testid":y.Tp.components.Annotations.annotationsChoosePanelInput})]})})]}),(0,t.jsxs)($t.n,{children:[(0,t.jsx)("h3",{className:"page-heading",children:"Query"}),l?.annotations&&d&&(0,t.jsx)(Js.A,{datasource:l,datasourceInstanceSettings:d,annotation:a,onChange:c}),l&&!l.annotations&&(0,t.jsx)(Ys.F,{datasource:l,annotation:a,onChange:c})]}),(0,t.jsxs)(F.B,{children:[!a.builtIn&&(0,t.jsx)(b.$n,{variant:"destructive",onClick:O,children:"Delete"}),(0,t.jsx)(b.$n,{variant:"secondary",onClick:R,"data-testid":y.Tp.pages.Dashboard.Settings.Annotations.NewAnnotation.previewInDashboard,children:"Preview in dashboard"}),(0,t.jsx)(b.$n,{variant:"primary",onClick:C,children:"Apply"})]})]})},qs=e=>({settingsForm:(0,u.css)({maxWidth:e.spacing(60),marginBottom:e.spacing(2)}),select:(0,u.css)({marginTop:"8px"})});function Wt(){x.Ny.partial({editIndex:null})}var _s=(e=>(e[e.AllPanels=0]="AllPanels",e[e.IncludePanels=1]="IncludePanels",e[e.ExcludePanels=2]="ExcludePanels",e))(_s||{});const ea=[{label:"All panels",value:0,description:"Send the annotation data to all panels that support annotations"},{label:"Selected panels",value:1,description:"Send the annotations to the explicitly listed panels"},{label:"All panels except",value:2,description:"Do not send annotation data to the following panels"}];var kt=o(14588),ta=o(91605),na=o(46991);const sa=({dashboard:e,onNew:n,onEdit:s})=>{const a=(0,D.of)(aa),[i,r]=(0,g.useState)(e.annotations.list),l=(m,f)=>{e.annotations.list=kt.moveItemImmutably(i,m,m+f),r(e.annotations.list)},d=m=>{e.annotations.list=[...i.slice(0,m),...i.slice(m+1)],r(e.annotations.list)},c=i.length===0||i.length===1&&i[0].builtIn,h=m=>m.enable===!1?(0,t.jsx)(t.Fragment,{children:(0,t.jsxs)("em",{className:"muted",children:["(Disabled) \xA0 ",m.name]})}):m.builtIn?(0,t.jsx)(t.Fragment,{children:(0,t.jsxs)("em",{className:"muted",children:[m.name," \xA0 (Built-in)"]})}):(0,t.jsx)(t.Fragment,{children:m.name}),p=(0,we.l)();return(0,t.jsxs)(F.B,{direction:"column",children:[i.length>0&&(0,t.jsx)("div",{className:a.table,children:(0,t.jsxs)("table",{role:"grid",className:"filter-table filter-table--hover",children:[(0,t.jsx)("thead",{children:(0,t.jsxs)("tr",{children:[(0,t.jsx)("th",{children:"Query name"}),(0,t.jsx)("th",{children:"Data source"}),(0,t.jsx)("th",{colSpan:3})]})}),(0,t.jsx)("tbody",{children:e.annotations.list.map((m,f)=>(0,t.jsxs)("tr",{children:[m.builtIn?(0,t.jsx)("td",{role:"gridcell",style:{width:"90%"},className:"pointer",onClick:()=>s(f),children:(0,t.jsx)(b.$n,{size:"sm",fill:"text",variant:"secondary",children:h(m)})}):(0,t.jsx)("td",{role:"gridcell",className:"pointer",onClick:()=>s(f),children:(0,t.jsx)(b.$n,{size:"sm",fill:"text",variant:"secondary",children:h(m)})}),(0,t.jsx)("td",{role:"gridcell",className:"pointer",onClick:()=>s(f),children:p.getInstanceSettings(m.datasource)?.name||m.datasource?.uid}),(0,t.jsx)("td",{role:"gridcell",style:{width:"1%"},children:f!==0&&(0,t.jsx)(ue.K,{name:"arrow-up",onClick:()=>l(f,-1),tooltip:"Move up"})}),(0,t.jsx)("td",{role:"gridcell",style:{width:"1%"},children:e.annotations.list.length>1&&f!==e.annotations.list.length-1?(0,t.jsx)(ue.K,{name:"arrow-down",onClick:()=>l(f,1),tooltip:"Move down"}):null}),(0,t.jsx)("td",{role:"gridcell",style:{width:"1%"},children:!m.builtIn&&(0,t.jsx)(ta.e,{size:"sm",onConfirm:()=>d(f),"aria-label":`Delete query with title "${m.name}"`})})]},`${m.name}-${f}`))})]})}),c&&(0,t.jsx)(F.B,{direction:"column",children:(0,t.jsxs)(Ut.p,{variant:"call-to-action",button:(0,t.jsx)(b.$n,{"data-testid":y.Tp.components.CallToActionCard.buttonV2("Add annotation query"),icon:"comment-alt",onClick:n,size:"lg",children:(0,t.jsx)(v.x6,{i18nKey:"annotations.empty-state.button-title",children:"Add annotation query"})}),message:(0,v.t)("annotations.empty-state.title","There are no custom annotation queries added yet"),children:[(0,t.jsx)(v.x6,{i18nKey:"annotations.empty-state.info-box-content",children:(0,t.jsx)("p",{children:"Annotations provide a way to integrate event data into your graphs. They are visualized as vertical lines and icons on all graph panels. When you hover over an annotation icon you can get event text & tags for the event. You can add annotation events directly from grafana by holding CTRL or CMD + click on graph (or drag region). These will be stored in Grafana's annotation database."})}),(0,t.jsxs)(v.x6,{i18nKey:"annotations.empty-state.info-box-content-2",children:["Checkout the"," ",(0,t.jsx)(nt.Y,{external:!0,href:"http://docs.grafana.org/reference/annotations/",children:"Annotations documentation"})," ","for more information."]})]})}),!c&&(0,t.jsx)(na.d,{"data-testid":y.Tp.pages.Dashboard.Settings.Annotations.List.addAnnotationCTAV2,onClick:n,children:"New query"})]})},aa=()=>({table:(0,u.css)({width:"100%",overflowX:"scroll"})});function ia({dashboard:e,editIndex:n,sectionNav:s,toolbar:a}){const i=()=>{const d={name:zt,enable:!0,datasource:(0,Me.p$)((0,we.l)().getInstanceSettings(null)),iconColor:"red"};e.annotations.list=[...e.annotations.list,{...d}],x.Ny.partial({editIndex:e.annotations.list.length-1})},r=d=>{x.Ny.partial({editIndex:d})},l=n!=null&&n<e.annotations.list.length;return(0,t.jsxs)(j.YW,{toolbar:a,navModel:s,pageNav:oa(e,n,s.node),children:[!l&&(0,t.jsx)(sa,{dashboard:e,onNew:i,onEdit:r}),l&&(0,t.jsx)(Zs,{dashboard:e,editIdx:n})]})}function oa(e,n,s){const a=s.parentItem;if(n==null)return a;const i=e.annotations.list[n];if(i)return{text:i.name,parentItem:a}}var Gt=o(60029),ra=o(21744),la=o(79924),Ae=o(94354),da=o(36607),Le=o(3673),Ve=o(14792),ca=o(5805),Kt=o(68402),ha=o(55314),ua=o(24466);const pa={cleanUpDashboardAndVariables:Le.Bz},ga=(0,oe.connect)(null,pa),ma=({hideModal:e,cleanUpDashboardAndVariables:n,dashboard:s})=>{const a=s.meta.provisioned,[i]=(0,ha.uz)(),[,r]=(0,ca.default)(async()=>{(0,ne.rR)("grafana_manage_dashboards_delete_clicked",{item_counts:{dashboard:1},source:"dashboard_settings",restore_enabled:A.$.featureToggles.dashboardRestoreUI}),await i({selectedItems:{dashboard:{[s.uid]:!0},folder:{}}}),n(),e(),x.Ny.replace("/")},[e]);return a?(0,t.jsx)(fa,{hideModal:e,provisionedId:s.meta.provisionedExternalId}):(0,t.jsx)(ua.h,{onConfirm:r,onClose:e,dashboardTitle:s.title})},fa=({hideModal:e,provisionedId:n})=>(0,t.jsxs)(G.a,{isOpen:!0,title:(0,v.t)("dashboard-settings.provisioned-delete-modal.title","Cannot delete provisioned dashboard"),icon:"trash-alt",onDismiss:e,className:(0,u.css)({width:"500px"}),children:[(0,t.jsx)(Ne.E,{element:"p",children:(0,t.jsx)(v.x6,{i18nKey:"dashboard-settings.provisioned-delete-modal.text-1",children:"This dashboard is managed by Grafana provisioning and cannot be deleted. Remove the dashboard from the config file to delete it."})}),(0,t.jsx)(Kt.$,{v:1}),(0,t.jsxs)(Ne.E,{element:"p",children:[(0,t.jsx)(v.x6,{i18nKey:"dashboard-settings.provisioned-delete-modal.text-2",children:"See grafana documentation for more information about provisioning.\xA0"}),(0,t.jsx)(nt.Y,{href:"https://grafana.com/docs/grafana/latest/administration/provisioning/#dashboards",external:!0,children:(0,v.t)("dashboard-settings.provisioned-delete-modal.text-link","Go to docs page")})]}),(0,t.jsx)(Kt.$,{v:2}),(0,t.jsx)(Ne.E,{element:"p",children:(0,t.jsxs)(v.x6,{i18nKey:"dashboard-settings.provisioned-delete-modal.text-3",children:["File path: ",{provisionedId:n}]})}),(0,t.jsx)(G.a.ButtonRow,{children:(0,t.jsx)(b.$n,{variant:"primary",onClick:e,children:(0,t.jsx)(v.x6,{i18nKey:"dashboard-settings.provisioned-delete-modal.confirm-button",children:"OK"})})})]}),va=ga(ma),xa=()=>{const e=(0,Ve.UA)().getCurrent();return(0,t.jsx)(B.$s,{children:({showModal:n,hideModal:s})=>(0,t.jsx)(b.$n,{variant:"destructive",onClick:()=>{n(va,{dashboard:e,hideModal:s})},"data-testid":y.Tp.pages.Dashboard.Settings.General.deleteDashBoard,children:(0,t.jsx)(v.x6,{i18nKey:"dashboard-settings.dashboard-delete-button",children:"Delete dashboard"})})})};var ba=o(81394),ya=o(27966),ja=o(75590);const Sa=[{value:0,label:"Default"},{value:1,label:"Shared crosshair"},{value:2,label:"Shared Tooltip"}];function Ca({dashboard:e,updateTimeZone:n,updateWeekStart:s,sectionNav:a,toolbar:i}){const[r,l]=(0,g.useState)(0),[d,c]=(0,g.useState)(e.title),[h,p]=(0,g.useState)(e.description),m=a.node.parentItem,f=(N,Be)=>{e.meta.folderUid=N,e.meta.folderTitle=Be,e.meta.hasUnsavedFolderChange=!0,l(r+1)},E=(0,g.useCallback)(N=>{e.title=N,c(N)},[c,e]),T=(0,g.useCallback)(N=>{e.description=N,p(N)},[p,e]),C=N=>{e.graphTooltip=N,l(r+1)},R=N=>{e.timepicker.refresh_intervals=N.filter(Be=>Be.trim()!=="")},O=N=>{e.timepicker.nowDelay=N},U=N=>{e.timepicker.hidden=N,l(r+1)},de=N=>{e.liveNow=N,l(r+1)},Y=N=>{e.timezone=N,l(r+1),n(N)},S=N=>{e.weekStart=N,l(r+1),s(N)},M=N=>{e.tags=N,l(r+1)},ce=N=>{e.editable=N,l(r+1)},Fe=[{label:"Editable",value:!0},{label:"Read-only",value:!1}];return(0,t.jsx)(j.YW,{navModel:a,pageNav:m,toolbar:i,children:(0,t.jsxs)("div",{style:{maxWidth:"600px"},children:[(0,t.jsxs)(ie.a,{marginBottom:5,children:[(0,t.jsx)($.D,{label:(0,t.jsxs)(F.B,{justifyContent:"space-between",children:[(0,t.jsx)(Gt.J,{htmlFor:"title-input",children:(0,t.jsx)(v.x6,{i18nKey:"dashboard-settings.general.title-label",children:"Title"})}),A.$.featureToggles.dashgpt&&(0,t.jsx)(ya.Z,{onGenerate:E})]}),children:(0,t.jsx)(Pe.p,{id:"title-input",name:"title",value:d,onChange:N=>E(N.target.value)})}),(0,t.jsx)($.D,{label:(0,t.jsxs)(F.B,{justifyContent:"space-between",children:[(0,t.jsx)(Gt.J,{htmlFor:"description-input",children:(0,v.t)("dashboard-settings.general.description-label","Description")}),A.$.featureToggles.dashgpt&&(0,t.jsx)(ba.V,{onGenerate:T})]}),children:(0,t.jsx)(ra.f,{id:"description-input",name:"description",value:h,onChange:N=>T(N.target.value)})}),(0,t.jsx)($.D,{label:(0,v.t)("dashboard-settings.general.tags-label","Tags"),children:(0,t.jsx)(la.u,{id:"tags-input",tags:e.tags,onChange:M,width:40})}),(0,t.jsx)($.D,{label:(0,v.t)("dashboard-settings.general.folder-label","Folder"),children:(0,t.jsx)(da.d,{value:e.meta.folderUid,onChange:f,initialTitle:e.meta.folderTitle,inputId:"dashboard-folder-input",enableCreateNew:!0,dashboardId:e.id,skipInitialLoad:!0})}),(0,t.jsx)($.D,{label:(0,v.t)("dashboard-settings.general.editable-label","Editable"),description:(0,v.t)("dashboard-settings.general.editable-description","Set to read-only to disable all editing. Reload the dashboard for changes to take effect"),children:(0,t.jsx)(Ae.z,{value:e.editable,options:Fe,onChange:ce})})]}),(0,t.jsx)(ja.p,{onTimeZoneChange:Y,onWeekStartChange:S,onRefreshIntervalChange:R,onNowDelayChange:O,onHideTimePickerChange:U,onLiveNowChange:de,refreshIntervals:e.timepicker.refresh_intervals,timePickerHidden:e.timepicker.hidden,nowDelay:e.timepicker.nowDelay,timezone:e.timezone,weekStart:e.weekStart,liveNow:e.liveNow}),(0,t.jsx)(Je.M,{label:(0,v.t)("dashboard-settings.general.panel-options-label","Panel options"),isOpen:!0,children:(0,t.jsx)($.D,{label:(0,v.t)("dashboard-settings.general.panel-options-graph-tooltip-label","Graph tooltip"),description:(0,v.t)("dashboard-settings.general.panel-options-graph-tooltip-description","Controls tooltip and hover highlight behavior across different panels. Reload the dashboard for changes to take effect"),children:(0,t.jsx)(Ae.z,{onChange:C,options:Sa,value:e.graphTooltip})})}),(0,t.jsx)(ie.a,{marginTop:3,children:e.meta.canDelete&&(0,t.jsx)(xa,{})})]})})}const Pa={updateTimeZone:Le.lC,updateWeekStart:Le.Ss},Da=(0,oe.connect)(null,Pa)(Ca);var Ht=o(32372);function Ta({dashboard:e,sectionNav:n,toolbar:s}){const a=e.getSaveModelClone(),[i,r]=(0,g.useState)(JSON.stringify(a,null,2)),l=n.node.parentItem,d=async()=>{await(0,Ve.UA)().saveJSONDashboard(i),Ce.t.reloadPage()},c=(0,D.of)(Na);return(0,t.jsx)(j.YW,{navModel:n,pageNav:l,toolbar:s,children:(0,t.jsxs)("div",{className:c.wrapper,children:[(0,t.jsx)(v.x6,{i18nKey:"dashboard-settings.json-editor.subtitle",children:"The JSON model below is the data structure that defines the dashboard. This includes dashboard settings, panel settings, layout, queries, and so on."}),(0,t.jsx)(Ht.B,{value:i,language:"json",showMiniMap:!0,showLineNumbers:!0,onBlur:r,containerStyles:c.codeEditor}),e.meta.canSave&&(0,t.jsx)("div",{children:(0,t.jsx)(b.$n,{type:"submit",onClick:d,children:(0,t.jsx)(v.x6,{i18nKey:"dashboard-settings.json-editor.save-button",children:"Save changes"})})})]})})}const Na=e=>({wrapper:(0,u.css)({display:"flex",height:"100%",flexDirection:"column",gap:e.spacing(2)}),codeEditor:(0,u.css)({flexGrow:1})});var ot=o(4588),Ea=o(65857);const Ia=({editLinkIdx:e,dashboard:n,onGoBack:s})=>{const[a,i]=(0,g.useState)(e!==null?n.links[e]:ot.q),r=l=>{const d=[...n.links];d.splice(e,1,l),n.links=d,i(l)};return(0,t.jsx)(Ea.d,{link:a,onUpdate:r,onGoBack:s})};var Ma=o(6199);const wa=({dashboard:e,onNew:n,onEdit:s})=>{const[a,i]=(0,g.useState)(e.links),r=(c,h)=>{e.links=kt.moveItemImmutably(a,c,c+h),i(e.links)},l=c=>{e.links=[...a,{...c}],i(e.links)},d=c=>{e.links=[...a.slice(0,c),...a.slice(c+1)],i(e.links)};return(0,t.jsx)(Ma.X,{links:a,onNew:n,onEdit:s,onDuplicate:l,onDelete:d,onOrderChange:r})};function Aa({dashboard:e,sectionNav:n,editIndex:s,toolbar:a}){const[i,r]=(0,g.useState)(!1),l=()=>{r(!1),x.Ny.partial({editIndex:void 0})},d=()=>{e.links=[...e.links,{...ot.q}],r(!0),x.Ny.partial({editIndex:e.links.length-1})},c=m=>{r(!1),x.Ny.partial({editIndex:m})},h=s!==void 0;let p=n.node.parentItem;return h&&(p={text:i?"New link":"Edit link",subTitle:i?"Create a new link on your dashboard":"Edit a specific link of your dashboard",parentItem:n.node.parentItem}),(0,t.jsxs)(j.YW,{navModel:n,pageNav:p,toolbar:a,children:[!h&&(0,t.jsx)(wa,{dashboard:e,onNew:d,onEdit:c}),h&&(0,t.jsx)(Ia,{dashboard:e,editLinkIdx:s,onGoBack:l})]})}var pe=o(57714),La=o(19626),Va=o(22764),Ra=o(56596),Oa=o(41053);const Ua=async(e,n)=>(Ce.t.ignoreNextSave(),await pe.wL.restoreDashboard(n.uid,e)),Fa=e=>{const n=(0,P.useSelector)(r=>r.dashboard.getModel()),[s,a]=(0,Oa.A)(async()=>await Ua(e,n),[]),i=(0,ze._2)();return(0,g.useEffect)(()=>{if(s.value){const r=x.Ny.getLocation(),l=Se.I.stripBaseFromUrl(s.value.url),d=r.state?.routeReloadCounter;x.Ny.replace({...r,pathname:l,state:{routeReloadCounter:d?d+1:1}}),i.success("Dashboard restored",`Restored from version ${e}`)}},[s,e,i]),{state:s,onRestoreDashboard:a}},Qt=({hideModal:e,version:n})=>{const{state:s,onRestoreDashboard:a}=Fa(n);return(0,g.useEffect)(()=>{!s.loading&&s.value&&e()},[s,e]),(0,t.jsx)(qe.u,{isOpen:!0,title:"Restore Version",icon:"history",onDismiss:e,onConfirm:a,body:(0,t.jsxs)("p",{children:["Are you sure you want to restore the dashboard to version ",n,"? All unsaved changes will be lost."]}),confirmText:`Yes, restore to version ${n}`})},Ba=({baseInfo:e,newInfo:n,diffData:s,isNewLatest:a})=>{const i=(0,Ra.G4)(s.lhs,s.rhs),r=(0,D.of)($a);return(0,t.jsxs)(F.B,{direction:"column",gap:1,children:[(0,t.jsxs)(F.B,{justifyContent:"space-between",alignItems:"center",children:[(0,t.jsxs)(F.B,{alignItems:"center",children:[(0,t.jsxs)("span",{className:(0,u.cx)(r.versionInfo,r.noMarginBottom),children:[(0,t.jsxs)("strong",{children:["Version ",e.version]})," updated by ",e.createdBy," ",e.ageString,e.message]}),(0,t.jsx)(q.I,{name:"arrow-right",size:"sm"}),(0,t.jsxs)("span",{className:r.versionInfo,children:[(0,t.jsxs)("strong",{children:["Version ",n.version]})," updated by ",n.createdBy," ",n.ageString,n.message]})]}),a&&(0,t.jsx)(B.$s,{children:({showModal:l,hideModal:d})=>(0,t.jsxs)(b.$n,{variant:"destructive",icon:"history",onClick:()=>{l(Qt,{version:e.version,hideModal:d})},children:["Restore to version ",e.version]})})]}),Object.entries(i).map(([l,d])=>(0,t.jsx)(La.D,{diffs:d,title:l},l)),(0,t.jsx)(ie.a,{paddingTop:2,children:(0,t.jsx)(Je.M,{isOpen:!1,label:"View JSON Diff",children:(0,t.jsx)(Va.M,{oldValue:JSON.stringify(s.lhs,null,2),newValue:JSON.stringify(s.rhs,null,2)})})})]})},$a=e=>({versionInfo:(0,u.css)({color:e.colors.text.secondary,fontSize:e.typography.bodySmall.fontSize}),noMarginBottom:(0,u.css)({marginBottom:0})});var za=o(78369);const Wa=({versions:e,canCompare:n,onCheck:s})=>{const a=(0,D.of)(ka);return(0,t.jsx)("div",{className:a.margin,children:(0,t.jsxs)("table",{className:"filter-table",children:[(0,t.jsx)("thead",{children:(0,t.jsxs)("tr",{children:[(0,t.jsx)("th",{className:"width-4"}),(0,t.jsx)("th",{className:"width-4",children:"Version"}),(0,t.jsx)("th",{className:"width-14",children:"Date"}),(0,t.jsx)("th",{className:"width-10",children:"Updated by"}),(0,t.jsx)("th",{children:"Notes"}),(0,t.jsx)("th",{})]})}),(0,t.jsx)("tbody",{children:e.map((i,r)=>(0,t.jsxs)("tr",{children:[(0,t.jsx)("td",{children:(0,t.jsx)(st.S,{"aria-label":`Toggle selection of version ${i.version}`,className:(0,u.css)({display:"inline"}),checked:i.checked,onChange:l=>s(l,i.id),disabled:!i.checked&&n})}),(0,t.jsx)("td",{children:i.version}),(0,t.jsx)("td",{children:i.createdDateString}),(0,t.jsx)("td",{children:i.createdBy}),(0,t.jsx)("td",{children:i.message}),(0,t.jsx)("td",{className:"text-right",children:r===0?(0,t.jsx)(za.v,{name:"Latest",colorIndex:17}):(0,t.jsx)(B.$s,{children:({showModal:l,hideModal:d})=>(0,t.jsx)(b.$n,{variant:"secondary",size:"sm",icon:"history",onClick:()=>{l(Qt,{version:i.version,hideModal:d})},children:"Restore"})})})]},i.id))})]})})};function ka(e){return{margin:(0,u.css)({marginBottom:e.spacing(4)})}}const Ga=10;class Ka extends g.PureComponent{constructor(n){super(n),this.getVersions=(s=!1)=>{this.setState({isAppending:s}),pe.wL.getHistoryList(this.props.dashboard.uid,{limit:this.limit,start:this.start}).then(a=>{this.setState({isLoading:!1,versions:[...this.state.versions,...this.decorateVersions(a)]}),this.start+=this.limit}).catch(a=>console.log(a)).finally(()=>this.setState({isAppending:!1}))},this.getDiff=async()=>{const s=this.state.versions.filter(c=>c.checked),[a,i]=s,r=a.version===this.props.dashboard.version;this.setState({isLoading:!0});const l=await pe.wL.getDashboardVersion(this.props.dashboard.uid,i.version),d=await pe.wL.getDashboardVersion(this.props.dashboard.uid,a.version);this.setState({baseInfo:i,isLoading:!1,isNewLatest:r,newInfo:a,viewMode:"compare",diffData:{lhs:l.data,rhs:d.data}})},this.decorateVersions=s=>s.map(a=>({...a,createdDateString:this.props.dashboard.formatDate(a.created),ageString:this.props.dashboard.getRelativeTime(a.created),checked:!1})),this.onCheck=(s,a)=>{this.setState({versions:this.state.versions.map(i=>i.id===a?{...i,checked:s.currentTarget.checked}:i)})},this.reset=()=>{this.setState({baseInfo:void 0,diffData:{lhs:"",rhs:""},isNewLatest:!1,newInfo:void 0,versions:this.state.versions.map(s=>({...s,checked:!1})),viewMode:"list"})},this.limit=Ga,this.start=0,this.state={isAppending:!0,isLoading:!0,versions:[],viewMode:"list",isNewLatest:!1,diffData:{lhs:"",rhs:""}}}componentDidMount(){this.getVersions()}isLastPage(){return this.state.versions.find(n=>n.version===1)}render(){const{versions:n,viewMode:s,baseInfo:a,newInfo:i,isNewLatest:r,isLoading:l,diffData:d}=this.state,c=n.filter(f=>f.checked).length===2,h=n.length>1,p=n.length>=this.limit,m=this.props.sectionNav.node.parentItem;return s==="compare"?(0,t.jsxs)(j.YW,{navModel:this.props.sectionNav,pageNav:m,toolbar:this.props.toolbar,children:[(0,t.jsx)(pe.me,{onClick:this.reset,baseVersion:a?.version,newVersion:i?.version,isNewLatest:r}),l?(0,t.jsx)(rt,{msg:"Fetching changes\u2026"}):(0,t.jsx)(Ba,{newInfo:i,baseInfo:a,isNewLatest:r,diffData:d})]}):(0,t.jsxs)(j.YW,{navModel:this.props.sectionNav,pageNav:m,toolbar:this.props.toolbar,children:[l?(0,t.jsx)(rt,{msg:"Fetching history list\u2026"}):(0,t.jsx)(Wa,{versions:n,onCheck:this.onCheck,canCompare:c}),this.state.isAppending&&(0,t.jsx)(rt,{msg:"Fetching more entries\u2026"}),h&&(0,t.jsx)(pe.rJ,{hasMore:p,canCompare:c,getVersions:this.getVersions,getDiff:this.getDiff,isLastPage:!!this.isLastPage()})]})}}const rt=({msg:e})=>(0,t.jsxs)(re.Gy,{children:[(0,t.jsx)(Ye.y,{}),(0,t.jsx)("em",{children:e})]}),Ha=()=>x.Ny.partial({editview:null,editIndex:null});function Qa({dashboard:e,editview:n,pageNav:s,sectionNav:a}){const[i,r]=(0,g.useState)(0),l=A.$.featureToggles.singleTopNav;(0,g.useEffect)(()=>{e.events.subscribe(Z.Cf,()=>r(O=>O+1))},[e]);const d=(0,g.useMemo)(()=>Ja(e),[e,i]),c=()=>{e.meta.hasUnsavedFolderChange=!1},h=d.find(O=>O.id===n)??d[0],p=ee.TP.hasEditPermissionInFolders,m=e.meta.canSave,f=(0,X.zy)(),E=Za(f),T=Ya(s,a,d,h,f,e.uid),C="sm",R=[(0,t.jsx)(b.$n,{"data-testid":y.Tp.pages.Dashboard.Settings.Actions.close,variant:"secondary",fill:"outline",size:C,onClick:Ha,children:"Close"},"close"),p&&(0,t.jsx)(Qe.m,{dashboard:e,onSaveSuccess:c,variant:"secondary",size:C},"save as"),m&&(0,t.jsx)(Qe.C,{dashboard:e,onSaveSuccess:c,size:C},"Save")];return(0,t.jsxs)(t.Fragment,{children:[!l&&(0,t.jsx)($e.H,{actions:(0,t.jsx)(Te.U,{alignment:"right",children:R})}),(0,t.jsx)(h.component,{toolbar:l?(0,t.jsx)(Te.U,{alignment:"right",children:R}):void 0,sectionNav:T,dashboard:e,editIndex:E})]})}function Ja(e){const n=[],s=(0,v.t)("dashboard-settings.general.title","General");e.meta.canEdit&&(n.push({title:s,id:"settings",icon:"sliders-v-alt",component:Da}),n.push({title:(0,v.t)("dashboard-settings.annotations.title","Annotations"),id:"annotations",icon:"comment-alt",component:ia,subTitle:"Annotation queries return events that can be visualized as event markers in graphs across the dashboard."}),n.push({title:(0,v.t)("dashboard-settings.variables.title","Variables"),id:"templating",icon:"calculator-alt",component:Gs,subTitle:"Variables can make your dashboard more dynamic and act as global filters."}),n.push({title:(0,v.t)("dashboard-settings.links.title","Links"),id:"links",icon:"link",component:Aa})),e.meta.canMakeEditable&&n.push({title:s,icon:"sliders-v-alt",id:"settings",component:Xa}),e.id&&e.meta.canSave&&n.push({title:(0,v.t)("dashboard-settings.versions.title","Versions"),id:"versions",icon:"history",component:Ka});const a=(0,v.t)("dashboard-settings.permissions.title","Permissions");return e.id&&e.meta.canAdmin&&ee.TP.hasPermission(P.AccessControlAction.DashboardsPermissionsRead)&&n.push({title:a,id:"permissions",icon:"lock",component:Hs}),n.push({title:(0,v.t)("dashboard-settings.json-editor.title","JSON Model"),id:"dashboard_json",icon:"arrow",component:Ta}),n}function Jt(e,n){return{...e,parentItem:e.parentItem?Jt(e.parentItem,n):n}}function Ya(e,n,s,a,i,r){const l={text:(0,v.t)("dashboard-settings.settings.title","Settings"),children:[],icon:"apps",hideFromBreadcrumbs:!1,url:Se.I.getUrlForPartial(i,{editview:"settings",editIndex:null})};l.children=s.map(c=>({text:c.title,icon:c.icon,id:`${r}/${c.id}`,url:Se.I.getUrlForPartial(i,{editview:c.id,editIndex:null}),active:c===a,parentItem:l,subTitle:c.subTitle}));const d=Jt(e,n.main);return l.parentItem=d,{main:l,node:l.children.find(c=>c.active)}}function Xa({dashboard:e,sectionNav:n,toolbar:s}){return(0,t.jsx)(j.YW,{navModel:n,toolbar:s,children:(0,t.jsxs)(F.B,{direction:"column",gap:2,alignItems:"flex-start",children:[(0,t.jsx)(Ne.E,{variant:"h3",children:"Dashboard not editable"}),(0,t.jsx)(b.$n,{type:"submit",onClick:()=>e.makeEditable(),children:"Make editable"})]})})}function Za(e){const n=new URLSearchParams(e.search).get("editIndex");if(n!=null)return parseInt(n,10)}var Q=o(16560),Yt=o(40334),lt=o(70713),Xt=o(87978),dt=o(63021),Re=o(40675),Zt=o(10534),ve=o(15292),qa=o(4213),_a=o.n(qa),ei=o(72724),Oe=o(83195),ti=o(2619),ni=o(19997),ge=o(74856),si=o(34214),qt=o(18803),xe=(e=>(e[e.Support=0]="Support",e[e.Data=1]="Data",e))(xe||{}),Ue=(e=>(e[e.PanelSnapshot=0]="PanelSnapshot",e[e.GithubComment=1]="GithubComment",e))(Ue||{});class ai extends ti.Q{constructor(n){super({panel:n,panelTitle:n.replaceVariables(n.title,void 0,"text")||"Panel",currentTab:0,showMessage:1,snapshotText:"",markdownText:"",randomize:{},snapshotUpdate:0,options:[{label:"GitHub comment",description:"Copy and paste this message into a GitHub issue or comment",value:1},{label:"Panel support snapshot",description:"Dashboard JSON used to help troubleshoot visualization issues",value:0}]}),this.onCurrentTabChange=s=>{this.setState({currentTab:s})},this.onShowMessageChange=s=>{this.setState({showMessage:s.value})},this.onGetMarkdownForClipboard=()=>{const{markdownText:s}=this.state,a=Math.pow(1024,2)*1.5;return s.length>a?(this.setState({error:{title:"Copy to clipboard failed",message:"Snapshot is too large, consider download and attaching a file instead"}}),""):s},this.onDownloadDashboard=()=>{const{snapshotText:s,panelTitle:a}=this.state,i=new Blob([s],{type:"text/plain"}),r=`debug-${a}-${(0,ei.LE)(new Date)}.json.txt`;_a()(i,r)},this.onSetSnapshotText=s=>{this.setState({snapshotText:s})},this.onToggleRandomize=s=>{const{randomize:a}=this.state;this.setState({randomize:{...a,[s]:!a[s]}})},this.onPreviewDashboard=()=>{const{snapshot:s}=this.state;s&&((0,k.OI)({meta:{},dashboard:s}),o.g.open(A.$.appUrl+"dashboard/new","_blank"))}}async buildDebugDashboard(){const{panel:n,randomize:s,snapshotUpdate:a}=this.state,i=await(0,qt.E_)(n,s,(0,ge.jG)().timeRange()),r=JSON.stringify(i,null,2),l=(0,qt.jD)(n,r),d=(0,Oe.cN)((0,Oe.j_)("bytes")(r?.length??0));let c;if(!n.isAngularPlugin())try{const h=new si.G(i,{isEmbedded:!0});c=(0,ni.EH)(h,i).state.body}catch(h){console.log("Error creating scene:",h)}this.setState({snapshot:i,snapshotText:r,markdownText:l,snapshotSize:d,snapshotUpdate:a+1,scene:c})}}function ii({panel:e,plugin:n,onClose:s}){const a=(0,D.of)(oi),i=(0,g.useMemo)(()=>new ai(e),[e]),{currentTab:r,loading:l,error:d,options:c,showMessage:h,snapshotSize:p,markdownText:m,snapshotText:f,randomize:E,panelTitle:T,scene:C}=i.useState();if((0,g.useEffect)(()=>{i.buildDebugDashboard()},[i,n,E]),!n)return null;const R=[{label:"Snapshot",value:xe.Support},{label:"Data",value:xe.Data}],O=A.$.supportBundlesEnabled&&ee.TP.hasPermission(P.AccessControlAction.ActionSupportBundlesCreate);return(0,t.jsxs)(Xt._,{title:"Get help with this panel",size:"lg",onClose:s,subtitle:(0,t.jsxs)(F.B,{direction:"column",gap:1,children:[(0,t.jsx)(F.B,{direction:"row",gap:1,children:(0,t.jsxs)("a",{href:"https://grafana.com/docs/grafana/latest/troubleshooting/",target:"blank",className:"external-link",rel:"noopener noreferrer",children:["Troubleshooting docs ",(0,t.jsx)(q.I,{name:"external-link-alt"})]})}),(0,t.jsx)("span",{className:"muted",children:(0,t.jsx)(v.x6,{i18nKey:"help-wizard.troubleshooting-help",children:"To request troubleshooting help, send a snapshot of this panel to Grafana Labs Technical Support. The snapshot contains query response data and panel settings."})}),O&&(0,t.jsx)("span",{className:"muted",children:(0,t.jsxs)(v.x6,{i18nKey:"help-wizard.support-bundle",children:["You can also retrieve a support bundle containing information concerning your Grafana instance and configured datasources in the ",(0,t.jsx)("a",{href:"/support-bundles",children:"support bundles section"}),"."]})})]}),tabs:(0,t.jsx)(dt.U,{children:R.map((U,de)=>(0,t.jsx)(Re.o,{label:U.label,active:U.value===r,onChangeTab:()=>i.onCurrentTabChange(U.value)},`${U.value}-${de}`))}),children:[l&&(0,t.jsx)(Ye.y,{}),d&&(0,t.jsx)(H.F,{title:d.title,children:d.message}),r===xe.Data&&(0,t.jsxs)("div",{className:a.code,children:[(0,t.jsxs)("div",{className:a.opts,children:[(0,t.jsx)($.D,{label:"Template",className:a.field,children:(0,t.jsx)(at.l6,{options:c,value:h,onChange:i.onShowMessageChange})}),h===Ue.GithubComment?(0,t.jsx)(Zt.b,{icon:"copy",getText:i.onGetMarkdownForClipboard,children:"Copy to clipboard"}):(0,t.jsxs)(b.$n,{icon:"download-alt",onClick:i.onDownloadDashboard,children:["Download (",p,")"]})]}),(0,t.jsx)(lt.Ay,{disableWidth:!0,children:({height:U})=>(0,t.jsx)(Ht.B,{width:"100%",height:U,language:h===Ue.GithubComment?"markdown":"json",showLineNumbers:!0,showMiniMap:!0,value:h===Ue.GithubComment?m:f,readOnly:!1,onBlur:i.onSetSnapshotText})})]}),r===xe.Support&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)($.D,{label:"Obfuscate data",description:"Modify the original data to hide sensitve information.  Note the lengths will stay the same, and duplicate values will be equal.",children:(0,t.jsxs)(F.B,{direction:"row",gap:1,children:[(0,t.jsx)(ve.K,{label:"Labels",id:"randomize-labels",showLabel:!0,value:!!E.labels,onChange:()=>i.onToggleRandomize("labels")}),(0,t.jsx)(ve.K,{label:"Field names",id:"randomize-field-names",showLabel:!0,value:!!E.names,onChange:()=>i.onToggleRandomize("names")}),(0,t.jsx)(ve.K,{label:"String values",id:"randomize-string-values",showLabel:!0,value:!!E.values,onChange:()=>i.onToggleRandomize("values")})]})}),(0,t.jsx)($.D,{label:"Support snapshot",description:`Panel: ${T}`,children:(0,t.jsxs)(F.B,{children:[(0,t.jsxs)(b.$n,{icon:"download-alt",onClick:i.onDownloadDashboard,children:[(0,t.jsx)(v.x6,{i18nKey:"help-wizard.download-snapshot",children:"Download snapshot"})," (",p,")"]}),(0,t.jsx)(Zt.b,{icon:"github",getText:i.onGetMarkdownForClipboard,title:"Copy a complete GitHub comment to the clipboard",children:(0,t.jsx)(v.x6,{i18nKey:"help-wizard.github-comment",children:"Copy Github comment"})}),(0,t.jsx)(b.$n,{icon:"eye",onClick:i.onPreviewDashboard,title:"Open support snapshot dashboard in a new tab",children:(0,t.jsx)(v.x6,{i18nKey:"help-wizard.preview-snapshot",children:"Preview snapshot"})})]})}),(0,t.jsx)(lt.Ay,{disableWidth:!0,children:({height:U})=>(0,t.jsx)("div",{style:{height:U,overflow:"auto"},children:C&&(0,t.jsx)(C.Component,{model:C})})})]})]})}const oi=e=>({code:(0,u.css)({flexGrow:1,height:"100%",overflow:"scroll"}),field:(0,u.css)({width:"100%"}),opts:(0,u.css)({display:"flex",width:"100%",flexGrow:0,alignItems:"center",justifyContent:"flex-end",button:{marginLeft:"8px"}})}),ct=(e,n,s)=>{const a=(0,g.useRef)(),[i,r]=(0,g.useState)();return(0,g.useEffect)(()=>{let l=-1,d=0;return a.current=e.getQueryRunner().getData({withTransforms:n.withTransforms,withFieldConfig:!1}).subscribe({next:c=>{if(s){if(l===c.structureRev){const h=Date.now();if(h-d<1e4)return;d=h}l=c.structureRev??-1}r(c)}}),()=>{a.current&&a.current.unsubscribe()}},[e,n.withTransforms]),{data:i,isLoading:i?.state===Ie.Gu.Loading,hasSeries:i?!!i.series:!1,hasError:!!(i&&(i.error||i?.errors?.length||i.state===Ie.Gu.Error))}};var ri=o(41987),_t=o(72574),li=o(61453),di=o(82344),ci=o(61396);const hi=({data:e,metadataDatasource:n})=>!n||!n.components?.MetadataInspector?(0,t.jsx)(v.x6,{i18nKey:"dashboard.inspect-meta.no-inspector",children:"No Metadata Inspector"}):(0,t.jsx)(n.components.MetadataInspector,{datasource:n,data:e.series});var ui=o(32067),pi=o(90820);const gi=({panel:e,plugin:n,dashboard:s,tabs:a,data:i,isDataLoading:r,dataOptions:l,metadataDatasource:d,defaultTab:c,onDataOptionsChange:h,onClose:p})=>{const[m,f]=(0,g.useState)(c??Q.q.Data);if(!n)return null;let E=mi(i),T=m;a.find(O=>O.value===m)||(T=Q.q.JSON);const C=(0,_t.w)().replace(e.title,e.scopedVars,"text")||"Panel",R=(0,v.t)("dashboard.inspect.title","Inspect: {{panelTitle}}",{panelTitle:C});return(0,t.jsxs)(Xt._,{title:R,subtitle:i&&fi(i),onClose:p,tabs:(0,t.jsx)(dt.U,{children:a.map((O,U)=>(0,t.jsx)(Re.o,{label:O.label,active:O.value===T,onChangeTab:()=>f(O.value||Q.q.Data)},`${O.value}-${U}`))}),children:[T===Q.q.Data&&(0,t.jsx)(li.q,{dataName:e.getDisplayTitle(),panelPluginId:e.type,fieldConfig:e.fieldConfig,hasTransformations:!!e.transformations?.length,data:i&&i.series,isLoading:r,options:l,onOptionsChange:h,timeZone:s.timezone,app:ri.Jk.Dashboard}),i&&T===Q.q.Meta&&(0,t.jsx)(hi,{data:i,metadataDatasource:d}),T===Q.q.JSON&&(0,t.jsx)(ci.w,{panel:e,dashboard:s,data:i,onClose:p}),T===Q.q.Error&&(0,t.jsx)(di.y,{errors:E}),i&&T===Q.q.Stats&&(0,t.jsx)(ui.N,{data:i,timeZone:s.getTimezone()}),i&&T===Q.q.Query&&(0,t.jsx)(pi.e,{data:i,onRefreshQuery:()=>e.refresh()})]})};function mi(e){let n=e?.errors??[];return e?.error&&!n.includes(e.error)&&(n=[e.error,...n]),!n.length&&e?.state===Ie.Gu.Error?[{message:"Error loading data"}]:n}function fi(e){const{request:n}=e;if(!n||(0,he.isEmpty)(n))return"";const s=n.targets.length,a=n.endTime?n.endTime-n.startTime:0,i=(0,Oe.cN)((0,Oe.j_)("ms")(a));return(0,t.jsxs)(v.x6,{i18nKey:"dashboard.inspect.subtitle",children:[{queryCount:s}," queries with total query time of ",{formatted:i}]})}var en=o(65123);const vi=({panel:e,dashboard:n,plugin:s})=>{const a=(0,X.zy)(),i=new URLSearchParams(a.search).get("inspectTab"),[r,l]=(0,g.useState)({withTransforms:i===Q.q.Error,withFieldConfig:!0}),{data:d,isLoading:c,hasError:h}=ct(e,r,!1),p=(0,en.sd)(d),m=(0,en.kx)(e,n,s,h,p),f=()=>{x.Ny.partial({inspect:null,inspectTab:null})};return s?i===Q.q.Help?(0,t.jsx)(ii,{panel:e,plugin:s,onClose:f}):(0,t.jsx)(gi,{dashboard:n,panel:e,plugin:s,defaultTab:i,tabs:m,data:d,isDataLoading:c,dataOptions:r,onDataOptionsChange:l,metadataDatasource:p,onClose:f}):null},xi=(e,n)=>{const s=(0,Yt.U)(e,n.panel);return s?{plugin:s.plugin}:{plugin:null}},bi=(0,oe.connect)(xi)(vi);var tn=o(64423),ht=o(27746),nn=o(3911),sn=o(58720),ut=o(12470),yi=o(13344);const ji=e=>{const n=(0,g.useMemo)(()=>_e.B.get(e.variable.type).picker,[e.variable]);return e.variable?(0,t.jsxs)(F.B,{gap:0,children:[(0,t.jsx)(Si,{variable:e.variable}),e.variable.hide!==ut.zL.hideVariable&&n&&(0,t.jsx)(n,{variable:e.variable,readOnly:e.readOnly??!1})]}):(0,t.jsx)("div",{children:"Couldn't load variable"})};function Si({variable:e}){const n=(0,g.useMemo)(()=>e.label||e.name,[e]);if(e.hide!==ut.zL.dontHide)return null;const s=yi.qz+e.id;return e.description?(0,t.jsx)(Ee.m,{content:e.description,placement:"bottom",children:(0,t.jsx)("label",{className:"gf-form-label gf-form-label--variable","data-testid":y.Tp.pages.Dashboard.SubMenu.submenuItemLabels(n),htmlFor:s,children:n})}):(0,t.jsx)("label",{className:"gf-form-label gf-form-label--variable","data-testid":y.Tp.pages.Dashboard.SubMenu.submenuItemLabels(n),htmlFor:s,children:n})}const an=({variables:e,readOnly:n})=>{const[s,a]=(0,g.useState)([]),i=(0,D.of)(Ci);return(0,g.useEffect)(()=>{a(e.filter(r=>r.hide!==ut.zL.hideVariable))},[e]),s.length===0?null:(0,t.jsx)(t.Fragment,{children:s.map(r=>(0,t.jsx)("div",{className:i.submenuItem,"data-testid":y.Tp.pages.Dashboard.SubMenu.submenuItem,children:(0,t.jsx)(ji,{variable:r,readOnly:n})},r.id))})},Ci=e=>({submenuItem:(0,u.css)({display:"inline-block",".fa-caret-down":{fontSize:"75%",paddingLeft:e.spacing(1)},".gf-form":{marginBottom:0}})});var Pi=o(81862),Di=o(54174),on=o(82792),Ti=o(39569),Ni=o(62367),Ei=o(70497),Ii=o(26443),Mi=o(19727),wi=o(41394);const rn=e=>n=>n.plugins.panels[e]||(0,wi.$)(`Panel plugin not found (${e})`,!0),pt=({panel:e})=>{const n=(0,P.useDispatch)(),s=(0,P.useSelector)(rn(e.type)),a=(0,P.useSelector)(d=>d.panelEditor.ui.isPanelOptionsVisible),i=(0,P.useSelector)(d=>d.panelEditor.isVizPickerOpen),r=()=>{n((0,te.eK)(!i))},l=()=>{n(He({isPanelOptionsVisible:!a}))};return s?(0,t.jsx)("div",{className:ln.wrapper,children:(0,t.jsxs)(Mi.e,{children:[(0,t.jsx)(ht.I,{className:ln.vizButton,tooltip:"Click to change visualization",imgSrc:s.meta.info.logos.small,isOpen:i,onClick:r,"data-testid":y.Tp.components.PanelEditor.toggleVizPicker,"aria-label":"Change Visualization",variant:"canvas",fullWidth:!0,children:s.meta.name}),(0,t.jsx)(ht.I,{tooltip:a?"Close options pane":"Show options pane",icon:a?"angle-right":"angle-left",onClick:l,variant:"canvas","data-testid":y.Tp.components.PanelEditor.toggleVizOptions,"aria-label":a?"Close options pane":"Show options pane"})]})}):null};pt.displayName="VisualizationTab";const ln={wrapper:(0,u.css)({display:"flex",flexDirection:"column"}),vizButton:(0,u.css)({textAlign:"left"})};var Ai=o(78685),Li=o(67647),dn=o(15054),Vi=o(68313),Ri=o(96227);const Oi=({onConfirm:e,onDismiss:n,panel:s})=>{const a=(0,on.X)(s),i=`${a?"Changing":"Replace with"} library panel`,r=`${a?"Changing":"Replacing with a"} library panel will remove any changes since last save.`;return(0,t.jsx)(qe.u,{onConfirm:e,onDismiss:n,confirmText:a?"Change":"Replace",title:i,body:r,dismissText:"Cancel",isOpen:!0})};var Ui=o(83791);const Fi=({panel:e,searchQuery:n,isWidget:s=!1})=>{const[a,i]=(0,g.useState)(!1),[r,l]=(0,g.useState)(void 0),[d,c]=(0,g.useState)([]),h=(0,g.useCallback)(C=>{c(C.map(R=>R.id))},[c]),p=(0,Ve.UA)().getCurrent(),m=(0,P.useDispatch)(),f=async()=>{r&&(l(void 0),m((0,Ke.Xk)(e,r)))},E=()=>i(!0),T=()=>l(void 0);return(0,t.jsxs)(re.gW,{spacing:"md",children:[!e.libraryPanel&&(0,t.jsx)(re.gW,{align:"center",children:(0,t.jsx)(b.$n,{icon:"plus",onClick:E,variant:"secondary",fullWidth:!0,children:"Create new library panel"})}),(0,t.jsx)(Vi.$,{onChange:h,isWidget:s}),(0,t.jsx)("div",{className:Bi.libraryPanelsView,children:(0,t.jsx)(Ui.y,{currentPanelId:e.libraryPanel?.uid,searchString:n,panelFilter:d,onClickCard:l,showSecondaryActions:!0,isWidget:s})}),a&&(0,t.jsx)(Ri.o,{panel:e,onDismiss:()=>i(!1),initialFolderUid:p?.meta.folderUid,isOpen:a}),r&&(0,t.jsx)(Oi,{panel:e,onDismiss:T,onConfirm:f})]})},Bi={libraryPanelsView:(0,u.css)`
    width: 100%;
  `};var $i=o(56707),cn=o(86292),I=o(32696);const hn=({panel:e,data:n})=>{const s=(0,P.useSelector)(rn(e.type)),[a,i]=(0,g.useState)(""),r=!!s.meta.skipDataQuery,l=!!(r&&A.$.featureToggles.vizAndWidgetSplit),d=l?dn.MM:dn.wV,c=l?I.__.Widgets:I.__.Visualizations,[h,p]=(0,Ai.A)(d,c),m=(0,P.useDispatch)(),f=(0,D.of)(zi),E=(0,g.useRef)(null),T=(0,g.useCallback)(U=>{m((0,Ke.gW)({panel:e,...U})),U.withModKey||m((0,te.eK)(!1))},[m,e]),C=()=>{m((0,te.eK)(!1))};if(!s)return null;const R=[{label:"Visualizations",value:I.__.Visualizations},{label:"Suggestions",value:I.__.Suggestions},{label:"Library panels",value:I.__.LibraryPanels,description:"Reusable panels you can share between multiple dashboards."}],O=[{label:"Widgets",value:I.__.Widgets},{label:"Library panels",value:I.__.LibraryPanels,description:"Reusable panels you can share between multiple dashboards."}];return(0,t.jsxs)("div",{className:f.openWrapper,children:[(0,t.jsxs)("div",{className:f.formBox,children:[(0,t.jsxs)("div",{className:f.searchRow,children:[(0,t.jsx)(Li.Z,{value:a,onChange:i,ref:E,autoFocus:!0,placeholder:"Search for..."}),(0,t.jsx)(b.$n,{title:"Close",variant:"secondary",icon:"angle-up",className:f.closeButton,"aria-label":y.Tp.components.PanelEditor.toggleVizPicker,onClick:C})]}),(0,t.jsx)($.D,{className:f.customFieldMargin,children:(0,t.jsx)(Ae.z,{options:l?O:R,value:h,onChange:p,fullWidth:!0})})]}),(0,t.jsx)("div",{className:f.scrollWrapper,children:(0,t.jsx)(Ge.E,{autoHeightMin:"100%",children:(0,t.jsxs)("div",{className:f.scrollContent,children:[h===I.__.Visualizations&&(0,t.jsx)(cn.G,{pluginId:s.meta.id,onChange:T,searchQuery:a}),h===I.__.Widgets&&(0,t.jsx)(cn.G,{pluginId:s.meta.id,onChange:T,searchQuery:a,isWidget:!0}),h===I.__.Suggestions&&(0,t.jsx)($i.a,{onChange:T,searchQuery:a,panel:e,data:n}),h===I.__.LibraryPanels&&(0,t.jsx)(Fi,{searchQuery:a,panel:e,isWidget:r},"Panel Library")]})})})]})};hn.displayName="VisualizationSelectPane";const zi=e=>({icon:(0,u.css)({color:e.v1.palette.gray33}),wrapper:(0,u.css)({display:"flex",flexDirection:"column",flex:"1 1 0",height:"100%"}),vizButton:(0,u.css)({textAlign:"left"}),scrollWrapper:(0,u.css)({flexGrow:1,minHeight:0}),scrollContent:(0,u.css)({padding:e.spacing(1)}),openWrapper:(0,u.css)({display:"flex",flexDirection:"column",flex:"1 1 100%",height:"100%",background:e.colors.background.primary,border:`1px solid ${e.colors.border.weak}`}),searchRow:(0,u.css)({display:"flex",marginBottom:e.spacing(1)}),closeButton:(0,u.css)({marginLeft:e.spacing(1)}),customFieldMargin:(0,u.css)({marginBottom:e.spacing(1)}),formBox:(0,u.css)({padding:e.spacing(1),paddingBottom:0})}),Wi=({plugin:e,panel:n,onFieldConfigsChange:s,onPanelOptionsChanged:a,onPanelConfigChange:i,dashboard:r,instanceState:l})=>{const d=(0,D.of)(ki),c=(0,P.useSelector)(p=>p.panelEditor.isVizPickerOpen),{data:h}=ct(n,{withTransforms:!0,withFieldConfig:!1},!0);return(0,t.jsxs)("div",{className:d.wrapper,"data-testid":y.Tp.components.PanelEditor.OptionsPane.content,children:[!c&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("div",{className:d.vizButtonWrapper,children:(0,t.jsx)(pt,{panel:n})}),(0,t.jsx)("div",{className:d.optionsWrapper,children:(0,t.jsx)(Ii.Ff,{panel:n,dashboard:r,plugin:e,instanceState:l,data:h,onFieldConfigsChange:s,onPanelOptionsChanged:a,onPanelConfigChange:i})})]}),c&&(0,t.jsx)(hn,{panel:n,data:h})]})},ki=e=>({wrapper:(0,u.css)({height:"100%",width:"100%",display:"flex",flex:"1 1 0",flexDirection:"column",padding:0}),optionsWrapper:(0,u.css)({flexGrow:1,minHeight:0}),vizButtonWrapper:(0,u.css)({padding:`0 ${e.spacing(2,2)} 0`}),legacyOptions:(0,u.css)({label:"legacy-options",".panel-options-grid":{display:"flex",flexDirection:"column"},".panel-options-group":{marginBottom:0},".panel-options-group__body":{padding:`${e.spacing(2)} 0`},".section":{display:"block",margin:`${e.spacing(2)} 0`,"&:first-child":{marginTop:0}}})});var un=o(3591),Gi=o(91052),Ki=o(20726),Hi=o(36663),Qi=(e=>(e.Error="Error",e.Info="Info",e.Links="Links",e))(Qi||{});class Ji extends g.Component{constructor(){super(...arguments),this.timeSrv=(0,ge.jG)(),this.getInfoMode=()=>{const{panel:n,error:s}=this.props;if(s)return"Error";if(n.description)return"Info";if(n.links&&n.links.length)return"Links"},this.getInfoContent=()=>{const{panel:n,theme:s}=this.props,a=n.description||"",i=(0,_t.w)().replace(a,n.scopedVars),r=(0,Hi.G)(i),l=this.props.links&&this.props.links.getLinks(n.replaceVariables),d=Zi(s);return(0,t.jsxs)("div",{className:d.content,children:[(0,t.jsx)("div",{dangerouslySetInnerHTML:{__html:r}}),l&&l.length>0&&(0,t.jsx)("ul",{className:d.cornerLinks,children:l.map((c,h)=>(0,t.jsx)("li",{children:(0,t.jsx)("a",{href:c.href,target:c.target,children:c.title})},h))})]})},this.onClickError=()=>{x.Ny.partial({inspect:this.props.panel.id,inspectTab:Q.q.Error})}}render(){const{error:n}=this.props,s=this.getInfoMode();return s?s==="Error"&&n?(0,t.jsx)(pn,{infoMode:s,content:n,onClick:this.onClickError}):s==="Info"||s==="Links"?(0,t.jsx)(pn,{infoMode:s,content:this.getInfoContent}):null:null}}const Yi=(0,D.cV)(Ji);function pn({infoMode:e,content:n,onClick:s}){const a=e==="Error"?"error":"info",i=y.Tp.components.Panels.Panel.headerCornerInfo(e.toLowerCase()),r=(0,D.of)(qi);return(0,t.jsx)(Ee.m,{content:n,placement:"top-start",theme:a,interactive:!0,children:(0,t.jsxs)("button",{type:"button",className:r.infoCorner,onClick:s,"aria-label":i,children:[(0,t.jsx)(q.I,{name:Xi[e],size:e==="Links"?"sm":"lg",className:(0,u.cx)(r.icon,{[r.iconLinks]:e==="Links"})}),(0,t.jsx)("span",{className:(0,u.cx)(r.inner,{[r.error]:e==="Error"})})]})})}const Xi={Error:"exclamation",Info:"info",Links:"external-link-alt"},Zi=e=>({content:(0,u.css)({overflow:"auto",code:{whiteSpace:"normal",wordWrap:"break-word"},"pre > code":{display:"block"}}),cornerLinks:(0,u.css)({listStyle:"none",paddingLeft:0})}),qi=e=>({icon:(0,u.css)({position:"absolute",top:0,left:0,zIndex:2,fill:e.colors.text.maxContrast}),iconLinks:(0,u.css)({left:e.spacing(.5),top:e.spacing(.25)}),inner:(0,u.css)({width:0,height:0,position:"absolute",left:0,bottom:0,borderBottom:`${e.spacing(4)} solid transparent`,borderLeft:`${e.spacing(4)} solid ${e.colors.background.secondary}`}),error:(0,u.css)({borderLeftColor:e.colors.error.main}),infoCorner:(0,u.css)({background:"none",border:"none",color:e.colors.text.secondary,cursor:"pointer",position:"absolute",left:0,top:0,width:e.spacing(4),height:e.spacing(4),zIndex:3})});function _i({width:e,height:n,panel:s,dashboard:a}){const{data:i}=ct(s,{withTransforms:!0,withFieldConfig:!1},!1),[r,l]=(0,g.useState)({frameIndex:0,showHeader:!0,showTypeIcons:!0});if((0,g.useEffect)(()=>{const c=(0,ge.jG)(),h=s.events.subscribe(un._,()=>{const p=(0,Nt.nk)(s,c.timeRange());s.runAllPanelQueries({dashboardUID:a.uid,dashboardTimezone:a.getTimezone(),timeData:p,width:e})});return()=>{h.unsubscribe()}},[s,a,e]),!i)return null;const d=i?.errors?i.errors.length>1?"Multiple errors found. Click for more details":i.errors[0].message:i?.error?.message;return(0,t.jsx)(Gi.NR,{width:e,height:n,padding:"none",children:(c,h)=>(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(Yi,{panel:s,error:d}),(0,t.jsx)(Ki.m,{title:"Raw data",pluginId:"table",width:c,height:h,data:i,options:r,onOptionsChange:l})]})})}var gn=o(69731),mn=o(8887),eo=o(40980),fn=o(27747);const to=({panel:e,dashboard:n,...s})=>{const{rules:a,loading:i}=(0,fn.S)({panelId:e.id,dashboardUID:n.uid});return(0,t.jsx)(Re.o,{...s,counter:i?null:a.length})};var no=o(39558),so=o(76885),vn=o(25027),ao=o(63066);const xn=({dashboard:e,panel:n,className:s})=>{const a=(0,P.useSelector)(c=>c.templating),i=(0,X.zy)(),{loading:r,value:l}=(0,z.A)(()=>(0,ao.mp)(n,e),[n,e,a]);if(r)return(0,t.jsx)(b.$n,{disabled:!0,children:"New alert rule"});if(!l)return(0,t.jsx)(H.F,{severity:"info",title:"No alerting capable query found",children:"Cannot create alerts from this panel because no query to an alerting capable datasource is found."});const d=so.kM.renderUrl("alerting/new",{defaults:JSON.stringify(l),returnTo:i.pathname+i.search});return(0,t.jsx)(b.z9,{icon:"bell",onClick:()=>(0,vn.fH)(vn.le.alertRuleFromPanel),href:d,className:s,"data-testid":"create-alert-rule-button",children:"New alert rule"})};var io=o(80215),bn=o(75471),oo=o(78742);const ro=({dashboard:e,panel:n})=>{const s=(0,D.of)(lo),{errors:a,loading:i,rules:r}=(0,fn.S)({dashboardUID:e.uid,panelId:n.id,poll:!0}),l=(0,bn.Wd)("grafana"),d=ee.TP.hasPermission(l.create),c=a.length?(0,t.jsx)(H.F,{title:"Errors loading rules",severity:"error",children:a.map((h,p)=>(0,t.jsxs)("div",{children:["Failed to load Grafana rules state: ",(0,oo.JZ)(h)]},p))}):null;return i&&!r.length?(0,t.jsxs)("div",{className:s.innerWrapper,children:[c,(0,t.jsx)(no._,{text:"Loading rules..."})]}):r.length?(0,t.jsx)(Ge.E,{autoHeightMin:"100%",children:(0,t.jsxs)("div",{className:s.innerWrapper,children:[c,(0,t.jsx)(io.s,{rules:r}),!!e.meta.canSave&&d&&(0,t.jsx)(xn,{className:s.newButton,panel:n,dashboard:e})]})}):(0,t.jsxs)("div",{"data-testid":y.Tp.components.PanelAlertTabContent.content,className:s.noRulesWrapper,children:[c,!!e.uid&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("p",{children:"There are no alert rules linked to this panel."}),!!e.meta.canSave&&d&&(0,t.jsx)(xn,{panel:n,dashboard:e})]}),!e.uid&&!!e.meta.canSave&&(0,t.jsx)(H.F,{severity:"info",title:"Dashboard not saved",children:"Dashboard must be saved before alerts can be added."})]})},lo=e=>({newButton:(0,u.css)({marginTop:e.spacing(3)}),innerWrapper:(0,u.css)({padding:e.spacing(2)}),noRulesWrapper:(0,u.css)({margin:e.spacing(2),backgroundColor:e.colors.background.secondary,padding:e.spacing(3)})});var co=o(66879),ho=o(47311),gt=o(31193),uo=o(37464);class po extends g.PureComponent{constructor(n){super(n),this.updateLastUsedDatasource=s=>{(0,ho.tw)(s)},this.onRunQueries=()=>{this.props.panel.refresh()},this.onOpenQueryInspector=()=>{x.Ny.partial({inspect:this.props.panel.id,inspectTab:"query"})},this.onOptionsChange=s=>{const{panel:a}=this.props;a.updateQueries(s),s.dataSource.uid!==a.datasource?.uid&&setTimeout(this.onRunQueries,10),this.forceUpdate()}}buildQueryOptions(n){const s=n.datasource??{default:!0},a=(0,gt.tR)().getInstanceSettings(s);return this.updateLastUsedDatasource(s),{cacheTimeout:a?.meta.queryOptions?.cacheTimeout?n.cacheTimeout:void 0,dataSource:{default:a?.isDefault,...a?(0,Me.p$)(a):{type:void 0,uid:void 0}},queryCachingTTL:a?.cachingConfig?.enabled?n.queryCachingTTL:void 0,queries:n.targets,maxDataPoints:n.maxDataPoints,minInterval:n.interval,timeRange:{from:n.timeFrom,shift:n.timeShift,hide:n.hideTimeOverride}}}async componentDidMount(){const{panel:n}=this.props;if(!n.datasource){let s;const a=(0,Ve.UA)().getCurrent()?.uid??"",i=(0,Ct.CW)(a);i?.datasourceUid!==null&&(s=(0,gt.tR)().getInstanceSettings(i?.datasourceUid)),s||(s=(0,gt.tR)().getInstanceSettings(null)),n.datasource=(0,Me.p$)(s),this.forceUpdate()}}render(){const{panel:n}=this.props;if(!n.datasource)return null;const s=this.buildQueryOptions(n);return(0,t.jsx)(uo.g,{options:s,queryRunner:n.getQueryRunner(),onRunQueries:this.onRunQueries,onOpenQueryInspector:this.onOpenQueryInspector,onOptionsChange:this.onOptionsChange})}}const yn=(0,g.memo)(({panel:e,dashboard:n,tabs:s,onChangeTab:a})=>{const i=(0,gn.C)(),r=(0,D.of)(mo),l=(0,g.useCallback)(h=>{let p="panel_editor_tabs_changed";A.$.featureToggles.transformationsRedesign&&(p="transformations_redesign_"+p),h.active||(0,ne.rR)(p,{tab_id:h.id}),a(h)},[a]);(0,g.useEffect)(()=>{const h=new tn.yU;return h.add(e.events.subscribe(Z.zq,i)),h.add(e.events.subscribe(Z.JI,i)),()=>h.unsubscribe()},[e,n,i]);const d=s.find(h=>h.active);if(s.length===0)return null;const c=A.$.unifiedAlertingEnabled;return(0,t.jsxs)("div",{className:r.wrapper,children:[(0,t.jsx)(dt.U,{className:r.tabBar,hideBorder:!0,children:s.map(h=>h.id===I.M8.Alert&&c?(0,t.jsx)(to,{label:h.text,active:h.active,onChangeTab:()=>a(h),icon:(0,mn.Uo)(h.icon),panel:e,dashboard:n},h.id):(0,t.jsx)(Re.o,{label:h.text,active:h.active,onChangeTab:()=>l(h),icon:(0,mn.Uo)(h.icon),counter:go(e,h)},h.id))}),(0,t.jsxs)(eo.J,{className:r.tabContent,children:[d.id===I.M8.Query&&(0,t.jsx)(po,{panel:e,queries:e.targets}),d.id===I.M8.Alert&&(0,t.jsx)(ro,{panel:e,dashboard:n}),d.id===I.M8.Transform&&(0,t.jsx)(co.o,{panel:e})]})]})});yn.displayName="PanelEditorTabs";function go(e,n){switch(n.id){case I.M8.Query:return e.targets.length;case I.M8.Alert:return e.alert?1:0;case I.M8.Transform:return(e.getTransformations()??[]).length}return null}const mo=e=>({wrapper:(0,u.css)({display:"flex",flexDirection:"column",height:"100%"}),tabBar:(0,u.css)({paddingLeft:e.spacing(2)}),tabContent:(0,u.css)({padding:0,display:"flex",flexDirection:"column",flex:1,minHeight:0,background:e.colors.background.primary,border:`1px solid ${e.components.panel.borderColor}`,borderLeft:"none",borderBottom:"none",borderTopRightRadius:e.shape.borderRadius(1.5)})});var fo=o(41811),vo=o(57220);const xo=(0,fo.A)((e,n)=>{const s=[];if(!n)return s;let a=I.M8.Visualize;if(n.meta.skipDataQuery)return[];n.meta.skipDataQuery||(a=I.M8.Query,s.push({id:I.M8.Query,text:"Query",icon:"database",active:!1}),s.push({id:I.M8.Transform,text:"Transform data",icon:"process",active:!1})),bo(n)&&s.push({id:I.M8.Alert,text:"Alert",icon:"bell",active:!1});const i=s.find(r=>r.id===(e||a))??s[0];return i.active=!0,s});function bo(e){const{unifiedAlertingEnabled:n=!1}=(0,it.zj)(),s=ee.TP.hasPermission((0,bn.Wd)(vo.hY).read);if(!(n&&s))return!1;const i=e.meta.id==="graph",r=e.meta.id==="timeseries";return i||r}var yo=o(54612);const jo=(e,n)=>{const s=e.panelEditor.getPanel(),a=(0,Yt.U)(e,s);return{panel:s,plugin:a?.plugin,instanceState:a?.instanceState,initDone:e.panelEditor.initDone,uiState:e.panelEditor.ui,tableViewEnabled:e.panelEditor.tableViewEnabled,variables:(0,K.SS)(n.dashboard.uid,e)}},So={initPanelEditor:Zn,discardPanelChanges:It,updatePanelEditorUIState:He,updateTimeZoneForSession:Pi.Cj,toggleTableView:te.kw,notifyApp:yt.dx},Co=(0,oe.connect)(jo,So);class Po extends g.PureComponent{constructor(){super(...arguments),this.state={showSaveLibraryPanelModal:!1},this.triggerForceUpdate=()=>{this.forceUpdate()},this.onBack=()=>{x.Ny.partial({editPanel:null,tab:null,showCategory:null})},this.onDiscard=()=>{this.props.discardPanelChanges(),this.onBack()},this.onSaveDashboard=()=>{Bt.lE.publish(new Z.S8({component:Ei.$,props:{dashboard:this.props.dashboard}}))},this.onSaveLibraryPanel=async()=>{(0,on.X)(this.props.panel)&&this.setState({showSaveLibraryPanelModal:!0})},this.onChangeTab=n=>{x.Ny.partial({tab:n.id})},this.onFieldConfigChange=n=>{this.props.panel.updateFieldConfig({...n})},this.onPanelOptionsChanged=n=>{this.props.panel.updateOptions(n)},this.onPanelConfigChanged=(n,s)=>{this.props.panel.setProperty(n,s),this.props.panel.render(),this.forceUpdate()},this.onDisplayModeChange=n=>{const{updatePanelEditorUIState:s}=this.props;this.props.tableViewEnabled&&this.props.toggleTableView(),s({mode:n})},this.onToggleTableView=()=>{this.props.toggleTableView()},this.onGoBackToDashboard=()=>{x.Ny.partial({editPanel:null,tab:null,showCategory:null})},this.onConfirmAndDismissLibarayPanelModel=()=>{this.setState({showSaveLibraryPanelModal:!1})}}componentDidMount(){this.props.initPanelEditor(this.props.sourcePanel,this.props.dashboard)}componentDidUpdate(){const{panel:n,initDone:s}=this.props;s&&!this.eventSubs&&(this.eventSubs=new tn.yU,this.eventSubs.add(n.events.subscribe(Z.PR,this.triggerForceUpdate)))}componentWillUnmount(){this.eventSubs?.unsubscribe()}renderPanel(n,s){const{dashboard:a,panel:i,uiState:r,tableViewEnabled:l,theme:d}=this.props;return(0,t.jsxs)("div",{className:n.mainPaneWrapper,children:[this.renderPanelToolbar(n),(0,t.jsx)("div",{className:n.panelWrapper,children:(0,t.jsx)(lt.Ay,{children:({width:c,height:h})=>{if(c<3||h<3)return null;if(s&&(h-=d.spacing.gridSize*2),l)return(0,t.jsx)(_i,{width:c,height:h,panel:i,dashboard:a});const p=(0,yo.A)(r.mode,c,h,i);return(0,t.jsx)("div",{className:n.centeringContainer,style:{width:c,height:h},children:(0,t.jsx)("div",{style:p,"data-panelid":i.id,children:(0,t.jsx)(Ti.L,{stateKey:i.key,dashboard:a,panel:i,isEditing:!0,isViewing:!1,lazy:!1,width:p.width,height:p.height},i.key)})})}})})]},"panel")}renderPanelAndEditor(n,s){const{panel:a,dashboard:i,plugin:r,tab:l}=this.props,d=xo(l,r),c=d.length===0,h=this.renderPanel(s,c);return d.length===0?(0,t.jsx)("div",{className:s.onlyPanel,children:h}):(0,t.jsxs)(sn.g,{splitOrientation:"horizontal",maxSize:-200,paneSize:n.topPaneSize,primary:"first",secondaryPaneStyle:{minHeight:0},onDragFinished:p=>{p&&He({topPaneSize:p/window.innerHeight})},children:[h,(0,t.jsx)("div",{className:s.tabsWrapper,"data-testid":y.Tp.components.PanelEditor.DataPane.content,children:(0,t.jsx)(yn,{panel:a,dashboard:i,tabs:d,onChangeTab:this.onChangeTab},a.key)},"panel-editor-tabs")]})}renderTemplateVariables(n){const{variables:s}=this.props;return s.length?(0,t.jsx)("div",{className:n.variablesWrapper,children:(0,t.jsx)(an,{variables:s})}):null}renderPanelToolbar(n){const{dashboard:s,uiState:a,variables:i,updateTimeZoneForSession:r,panel:l,tableViewEnabled:d}=this.props;return(0,t.jsx)("div",{className:n.panelToolbar,children:(0,t.jsxs)(re.Gy,{justify:i.length>0?"space-between":"flex-end",align:"flex-start",children:[this.renderTemplateVariables(n),(0,t.jsxs)(F.B,{gap:1,children:[(0,t.jsx)(ve.K,{label:"Table view",showLabel:!0,id:"table-view",value:d,onClick:this.onToggleTableView,"data-testid":y.Tp.components.PanelEditor.toggleTableView}),(0,t.jsx)(Ae.z,{value:a.mode,options:I.Nt,onChange:this.onDisplayModeChange}),(0,t.jsx)(Ni.$,{dashboard:s,onChangeTimeZone:r,isOnCanvas:!0}),!a.isPanelOptionsVisible&&(0,t.jsx)(pt,{panel:l})]})]})})}renderEditorActions(){const n="sm";let s=[(0,t.jsx)(b.$n,{onClick:this.onDiscard,title:"Undo all changes",size:n,variant:"destructive",fill:"outline",children:"Discard"},"discard"),this.props.dashboard.meta.canSave&&(this.props.panel.libraryPanel?(0,t.jsx)(b.$n,{onClick:this.onSaveLibraryPanel,variant:"primary",size:n,title:"Apply changes and save library panel",children:"Save library panel"},"save-panel"):(0,t.jsx)(b.$n,{onClick:this.onSaveDashboard,title:"Apply changes and save dashboard",size:n,variant:"secondary",children:"Save"},"save")),(0,t.jsx)(b.$n,{onClick:this.onBack,variant:"primary",title:"Apply changes and go back to dashboard","data-testid":y.Tp.components.PanelEditor.applyButton,size:n,children:"Apply"},"apply")];return this.props.panel.libraryPanel&&(s.splice(1,0,(0,t.jsx)(B.$s,{children:({showModal:a,hideModal:i})=>(0,t.jsx)(ht.I,{onClick:()=>{a(Di.l,{onConfirm:()=>{this.props.panel.unlinkLibraryPanel(),this.forceUpdate()},onDismiss:i,isOpen:!0})},title:"Disconnects this panel from the library panel so that you can edit it regularly.",children:"Unlink"},"unlink")},"unlink-controller")),s.pop()),s}renderOptionsPane(){const{plugin:n,dashboard:s,panel:a,instanceState:i}=this.props;return n?(0,t.jsx)(Wi,{plugin:n,dashboard:s,panel:a,instanceState:i,onFieldConfigsChange:this.onFieldConfigChange,onPanelOptionsChanged:this.onPanelOptionsChanged,onPanelConfigChange:this.onPanelConfigChanged}):(0,t.jsx)("div",{})}render(){const{initDone:n,uiState:s,theme:a,sectionNav:i,pageNav:r,className:l,updatePanelEditorUIState:d}=this.props,c=A.$.featureToggles.singleTopNav,h=To(a,this.props);return n?(0,t.jsxs)(j.YW,{navModel:i,pageNav:r,"data-testid":y.Tp.components.PanelEditor.General.content,layout:_.k.Custom,className:l,toolbar:c?(0,t.jsx)(Te.U,{alignment:"right",children:this.renderEditorActions()}):void 0,children:[!c&&(0,t.jsx)($e.H,{actions:(0,t.jsx)(Te.U,{alignment:"right",children:this.renderEditorActions()})}),(0,t.jsxs)("div",{className:h.wrapper,children:[(0,t.jsx)("div",{className:h.verticalSplitPanesWrapper,children:s.isPanelOptionsVisible?(0,t.jsxs)(sn.g,{splitOrientation:"vertical",maxSize:-300,paneSize:s.rightPaneSize,primary:"second",onDragFinished:p=>{p&&d({rightPaneSize:p/window.innerWidth})},children:[this.renderPanelAndEditor(s,h),this.renderOptionsPane()]}):this.renderPanelAndEditor(s,h)}),this.state.showSaveLibraryPanelModal&&(0,t.jsx)(Tt,{panel:this.props.panel,folderUid:this.props.dashboard.meta.folderUid??"",onConfirm:this.onConfirmAndDismissLibarayPanelModel,onDiscard:this.onDiscard,onDismiss:this.onConfirmAndDismissLibarayPanelModel})]})]}):null}}const Do=(0,D.cV)(Co(Po)),To=(0,nn.N)((e,n)=>{const{uiState:s}=n,a=e.spacing(2);return{wrapper:(0,u.css)({width:"100%",flexGrow:1,minHeight:0,display:"flex",paddingTop:e.spacing(2)}),verticalSplitPanesWrapper:(0,u.css)({display:"flex",flexDirection:"column",height:"100%",width:"100%",position:"relative"}),mainPaneWrapper:(0,u.css)({display:"flex",flexDirection:"column",height:"100%",width:"100%",paddingRight:`${s.isPanelOptionsVisible?0:a}`}),variablesWrapper:(0,u.css)({label:"variablesWrapper",display:"flex",flexGrow:1,flexWrap:"wrap",gap:e.spacing(1,2)}),panelWrapper:(0,u.css)({flex:"1 1 0",minHeight:0,width:"100%",paddingLeft:a}),tabsWrapper:(0,u.css)({height:"100%",width:"100%"}),panelToolbar:(0,u.css)({display:"flex",padding:`0 0 ${a} ${a}`,justifyContent:"space-between",flexWrap:"wrap"}),angularWarning:(0,u.css)({display:"flex",height:e.spacing(4),alignItems:"center"}),toolbarLeft:(0,u.css)({paddingLeft:e.spacing(1)}),centeringContainer:(0,u.css)({display:"flex",justifyContent:"center",alignItems:"center",position:"relative",flexDirection:"column"}),onlyPanel:(0,u.css)({height:"100%",position:"absolute",overflow:"hidden",width:"100%"})}});var No=o(1702),Eo=o(39268),Io=o(14186),Mo=o(89963),wo=o(42972);const Ao=({annotation:e,events:n,onEnabledChanged:s})=>{const[a,i]=(0,g.useState)(!1),r=(0,D.of)(Lo),l=()=>(0,wo.Dh)().cancel(e);return(0,g.useEffect)(()=>{const d=n.getStream(Z.xc).subscribe({next:h=>{h.payload===e&&i(!0)}}),c=n.getStream(Z.yj).subscribe({next:h=>{h.payload===e&&i(!1)}});return()=>{d.unsubscribe(),c.unsubscribe()}}),(0,t.jsx)("div",{className:r.annotation,children:(0,t.jsxs)(Eo.C,{children:[(0,t.jsx)(Io.I,{label:e.name,disabled:a,"data-testid":y.Tp.pages.Dashboard.SubMenu.Annotations.annotationLabel(e.name),children:(0,t.jsx)(ve.K,{label:e.name,value:e.enable,onChange:()=>s(e),disabled:a,"data-testid":y.Tp.pages.Dashboard.SubMenu.Annotations.annotationToggle(e.name)})}),(0,t.jsx)("div",{className:r.indicator,children:(0,t.jsx)(Mo.I,{loading:a,onCancel:l})})]})},e.name)};function Lo(e){return{annotation:(0,u.css)({display:"inline-block",marginRight:e.spacing(1),".fa-caret-down":{fontSize:"75%",paddingLeft:e.spacing(1)},".gf-form-inline .gf-form":{marginBottom:0}}),indicator:(0,u.css)({alignSelf:"center",padding:`0 ${e.spacing(.5)}`})}}const Vo=({annotations:e,onAnnotationChanged:n,events:s})=>{const[a,i]=(0,g.useState)([]);return(0,g.useEffect)(()=>{i(e.filter(r=>r.hide!==!0))},[e]),a.length===0?null:(0,t.jsx)("div",{"data-testid":y.Tp.pages.Dashboard.SubMenu.Annotations.annotationsWrapper,children:a.map(r=>(0,t.jsx)(Ao,{events:s,annotation:r,onEnabledChanged:n},r.name))})};var Ro=o(94701),Oo=o(80997),Uo=o(29304),jn=o(52424);const Fo=({dashboard:e,links:n})=>{const s=(0,gn.C)();return(0,Ro.A)(()=>{const a=e.events.subscribe(un.sR,s);return()=>a.unsubscribe()}),n.length?(0,t.jsx)(t.Fragment,{children:n.map((a,i)=>{const r=(0,Uo.mQ)().getAnchorInfo(a),l=`${a.title}-$${i}`;if(a.type==="dashboards")return(0,t.jsx)(jn.aK,{link:a,linkInfo:r,dashboardUID:e.uid},l);const d=ot.G[a.icon],c=(0,t.jsx)(jn.Zx,{href:(0,Oo.Jf)(r.href),target:a.targetBlank?"_blank":void 0,rel:"noreferrer","data-testid":y.Tp.components.DashboardLinks.link,icon:d,children:r.title});return(0,t.jsx)("div",{"data-testid":y.Tp.components.DashboardLinks.container,children:a.tooltip?(0,t.jsx)(Ee.m,{content:r.tooltip,children:c}):c},l)})}):null};class Bo extends g.PureComponent{constructor(){super(...arguments),this.onAnnotationStateChanged=n=>{for(let s=0;s<this.props.dashboard.annotations.list.length;s++){const a=this.props.dashboard.annotations.list[s];if(a.name===n.name){a.enable=!a.enable;break}}this.props.dashboard.startRefresh(),this.forceUpdate()},this.disableSubmitOnEnter=n=>{n.preventDefault()}}render(){const{dashboard:n,variables:s,links:a,annotations:i,theme:r}=this.props,l=zo(r),d=n.meta.isSnapshot??!1;return(0,t.jsxs)("div",{className:l.submenu,children:[(0,t.jsx)("form",{"aria-label":"Template variables",className:l.formStyles,onSubmit:this.disableSubmitOnEnter,children:(0,t.jsx)(an,{variables:s,readOnly:d})}),(0,t.jsx)(Vo,{annotations:i,onAnnotationChanged:this.onAnnotationStateChanged,events:n.events}),(0,t.jsx)("div",{className:l.spacer}),n&&(0,t.jsx)(Fo,{dashboard:n,links:a})]})}}const $o=(e,n)=>{const{uid:s}=n.dashboard,a=(0,K.nx)(s,e);return{variables:(0,K.pi)(s,a.variables)}},zo=(0,nn.N)(e=>({formStyles:(0,u.css)({display:"contents",flexWrap:"wrap"}),submenu:(0,u.css)({display:"flex",flexDirection:"row",flexWrap:"wrap",alignContent:"flex-start",alignItems:"flex-start",gap:`${e.spacing(1)} ${e.spacing(2)}`,padding:`0 0 ${e.spacing(1)} 0`}),spacer:(0,u.css)({flexGrow:1})})),Sn=(0,D.cV)((0,oe.connect)($o)(Bo));Sn.displayName="SubMenu";var Wo=o(2118),ko=o(61582),Cn=o(84423),nr=o(65572),sr=o(9964);const Go=e=>({initPhase:e.dashboard.initPhase,initError:e.dashboard.initError,dashboard:e.dashboard.getModel(),navIndex:e.navIndex}),Ko={initDashboard:k.vR,cleanUpDashboardAndVariables:Le.Bz,notifyApp:yt.dx,cancelVariables:ke.Y7,templateVarsChangedInUrl:ke.Hn},Ho=(0,oe.connect)(Go,Ko),Qo=e=>({fullScreenPanel:(0,u.css)({".react-grid-layout":{height:"auto !important",transitionProperty:"none"},".react-grid-item":{display:"none !important",transitionProperty:"none !important","&--fullscreen":{display:"block !important",position:"unset !important",transform:"translate(0px, 0px) !important"}},".panel-header:hover":{backgroundColor:"inherit"},".panel-title-container":{cursor:"pointer"},".react-resizable-handle":{display:"none"}})});class Jo extends g.PureComponent{constructor(){super(...arguments),this.forceRouteReloadCounter=0,this.state=this.getCleanState(),this.updateLiveTimer=()=>{let n;this.props.dashboard?.liveNow&&(n=(0,ge.jG)().timeRange()),ko.a.setLiveTimeRange(n)},this.setScrollRef=n=>{this.setState({scrollElement:n})},this.onCloseShareModal=()=>{x.Ny.partial({shareView:null})}}static{this.contextType=wn.YE}getCleanState(){return{editView:null,editPanel:null,viewPanel:null,showLoadingState:!1,panelNotFound:!1,editPanelAccessDenied:!1}}componentDidMount(){this.initDashboard(),this.forceRouteReloadCounter=this.props.location.state?.routeReloadCounter||0}componentWillUnmount(){this.closeDashboard()}closeDashboard(){this.props.cleanUpDashboardAndVariables(),this.setState(this.getCleanState())}initDashboard(){const{dashboard:n,params:s,queryParams:a}=this.props;n&&this.closeDashboard(),this.props.initDashboard({urlSlug:s.slug,urlUid:s.uid,urlType:s.type,urlFolderUid:a.folderUid,panelType:a.panelType,routeName:this.props.route.routeName,fixUrl:!0,accessToken:s.accessToken,keybindingSrv:this.context.keybindings}),setTimeout(this.updateLiveTimer,250)}componentDidUpdate(n,s){const{dashboard:a,params:i,templateVarsChangedInUrl:r}=this.props,l=this.props.location.state?.routeReloadCounter;if(a){if(n.params.uid!==i.uid||l!==void 0&&this.forceRouteReloadCounter!==l){this.initDashboard(),this.forceRouteReloadCounter=l;return}if(n.location.search!==this.props.location.search){const d=n.queryParams,c=this.props.queryParams;(c?.from!==d?.from||c?.to!==d?.to)&&((0,ge.jG)().updateTimeRangeFromUrl(),this.updateLiveTimer()),!d?.refresh&&c?.refresh&&(0,ge.jG)().setAutoRefresh(c.refresh);const h=(0,L.Wz)(this.props.queryParams,n.queryParams);h&&r(a.uid,h)}this.state.editPanel&&!s.editPanel&&(Ce.t.setEditingState(!0),this.props.dashboard?.events.publish(new Z.sL(this.state.editPanel.id))),!this.state.editPanel&&s.editPanel&&(Ce.t.setEditingState(!1),this.props.dashboard?.events.publish(new Z.i0(s.editPanel.id))),this.state.editPanelAccessDenied&&(this.props.notifyApp((0,ze.gi)("Permission to edit panel denied")),x.Ny.partial({editPanel:null})),this.state.panelNotFound&&(this.props.notifyApp((0,ze.gi)("Panel not found")),x.Ny.partial({editPanel:null,viewPanel:null})),this.state.updateScrollTop!==void 0&&this.state.updateScrollTop!==s.updateScrollTop&&this.state.scrollElement?.scrollTo(0,this.state.updateScrollTop)}}static getDerivedStateFromProps(n,s){const{dashboard:a,queryParams:i}=n,r=i.editPanel,l=i.viewPanel,d=i.editview;if(!a)return s;const c={...s};if(!s.editView&&d?(c.editView=d,c.rememberScrollTop=s.scrollElement?.scrollTop,c.updateScrollTop=0):s.editView&&!d&&(c.updateScrollTop=s.rememberScrollTop,c.editView=null),!s.editPanel&&r){const h=a.getPanelByUrlId(r);h?a.canEditPanel(h)?(c.editPanel=h,c.rememberScrollTop=s.scrollElement?.scrollTop):c.editPanelAccessDenied=!0:c.panelNotFound=!0}else s.editPanel&&!r&&(c.editPanel=null,c.updateScrollTop=s.rememberScrollTop);if(!s.viewPanel&&l){const h=a.getPanelByUrlId(l);h?(a.initViewPanel(h),c.viewPanel=h,c.rememberScrollTop=s.scrollElement?.scrollTop,c.updateScrollTop=0):c.panelNotFound=!0}else s.viewPanel&&!l&&(a.exitViewPanel(s.viewPanel),c.viewPanel=null,c.updateScrollTop=s.rememberScrollTop);return(s.panelNotFound||s.editPanelAccessDenied&&!r)&&(c.panelNotFound=!1,c.editPanelAccessDenied=!1),Yo(n,c)}getInspectPanel(){const{dashboard:n,queryParams:s}=this.props,a=s.inspect;if(!n||!a)return null;const i=n.getPanelById(parseInt(a,10));return i||null}render(){const{dashboard:n,initError:s,queryParams:a,theme:i}=this.props,{editPanel:r,viewPanel:l,pageNav:d,sectionNav:c}=this.state,h=An(this.props.queryParams),p=Qo(i),m=A.$.featureToggles.singleTopNav;if(!n||!d||!c)return(0,t.jsx)(Gn.P,{initPhase:this.props.initPhase});const f=this.getInspectPanel(),E=!r&&!h&&!this.props.queryParams.editview&&n.isSubMenuVisible(),T=h!==P.KioskMode.Full&&!a.editview,C=(0,u.cx)({[p.fullScreenPanel]:!!l,"page-hidden":!!(a.editview||r)});if(n.meta.dashboardNotFound)return(0,t.jsx)(j.YW,{navId:"dashboards/browse",layout:_.k.Canvas,pageNav:{text:"Not found"},children:(0,t.jsx)(Mn.L,{entity:"Dashboard"})});const R=new Set(["autoMigrateOldPanels","autoMigrateGraphPanel","autoMigrateTablePanel","autoMigratePiechartPanel","autoMigrateWorldmapPanel","autoMigrateStatPanel","disableAngular"]),O=()=>{const Y=new URLSearchParams(window.location.search);let S=!1;return Y.forEach((M,ce)=>{if(ce.startsWith("__feature.")){const Fe=ce.substring(10),N=M==="true"||M==="";if(A.$.featureToggles[Fe])return;if(R.has(Fe)&&N){S=!0;return}}}),S},U=n.panels.some(Y=>Y.autoMigrateFrom&&Cn.NB[Y.autoMigrateFrom]!=null),de=A.$.featureToggles.angularDeprecationUI&&U&&O()&&n.uid!==null;return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(j.YW,{navModel:c,pageNav:d,layout:_.k.Canvas,className:C,onSetScrollRef:this.setScrollRef,toolbar:m?(0,t.jsx)(Dt.Ay,{dashboard:n,title:n.title,folderTitle:n.meta.folderTitle,isFullscreen:!!l,kioskMode:h,hideTimePicker:n.timepicker.hidden}):void 0,children:[T&&(0,t.jsx)("header",{"data-testid":y.Tp.pages.Dashboard.DashNav.navV2,children:(0,t.jsx)($e.H,{actions:(0,t.jsx)(Dt.Ay,{dashboard:n,title:n.title,folderTitle:n.meta.folderTitle,isFullscreen:!!l,kioskMode:h,hideTimePicker:n.timepicker.hidden})})}),(0,t.jsx)(Mt,{dashboard:n}),s&&(0,t.jsx)(kn.y,{}),E&&(0,t.jsx)("section",{"aria-label":y.Tp.pages.Dashboard.SubMenu.submenu,children:(0,t.jsx)(Sn,{dashboard:n,annotations:n.annotations.list,links:n.links})}),A.$.featureToggles.angularDeprecationUI&&n.hasAngularPlugins()&&n.uid!==null&&(0,t.jsx)(Vn.j,{dashboardUid:n.uid,showAutoMigrateLink:n.panels.some(Y=>Cn.vI.includes(Y.type))}),de&&(0,t.jsx)(Fn,{dashboardUid:n.uid}),(0,t.jsx)(Wo.N,{dashboard:n,isEditable:!!n.meta.canEdit,viewPanel:l,editPanel:r}),f&&(0,t.jsx)(bi,{dashboard:n,panel:f}),a.shareView&&(0,t.jsx)(No.ShareModal,{dashboard:n,onDismiss:this.onCloseShareModal,activeTab:a.shareView})]}),r&&(0,t.jsx)(Do,{dashboard:n,sourcePanel:r,tab:this.props.queryParams.tab,sectionNav:c,pageNav:d}),a.editview&&(0,t.jsx)(Qa,{dashboard:n,editview:a.editview,pageNav:d,sectionNav:c}),a.addWidget&&A.$.featureToggles.vizAndWidgetSplit&&(0,t.jsx)(zn,{})]})}}function Yo(e,n){const{dashboard:s,navIndex:a}=e;if(!s)return n;let i=n.pageNav,r=n.sectionNav;if((!i||s.title!==i.text||s.meta.folderUrl!==i.parentItem?.url)&&(i={text:s.title,url:Se.I.getUrlForPartial(e.location,{editview:null,editPanel:null,viewPanel:null})}),e.route.routeName===P.DashboardRoutes.Path){r=St();const d=jt(e.params.slug);d?.parentItem&&(d.parentItem=d.parentItem)}else r=(0,We.tc)(e.navIndex,Ln.L1+s.uid,(0,We.tc)(e.navIndex,"dashboards/browse"));const{folderUid:l}=s.meta;if(l&&i&&r.main.id!=="starred"){const d=(0,We.tc)(a,`folder-dashboards-${l}`).main;d.id!=="not-found"&&(i={...i,parentItem:d})}return(n.editPanel||n.viewPanel)&&(i={...i,text:`${n.editPanel?"Edit":"View"} panel`,parentItem:i,url:void 0}),n.pageNav===i&&n.sectionNav===r?n:{...n,pageNav:i,sectionNav:r}}const Pn=(0,D.cV)(Jo);Pn.displayName="DashboardPage";const Dn=Ho(Pn);function Xo(e){const n=e.queryParams.scenes===!0,s=e.queryParams.scenes===!1,a=(0,X.g)(),i=(0,X.zy)();if(n||A.$.featureToggles.dashboardScene&&!s)return(0,t.jsx)(bt,{...e});const r=(0,xt.sP)(),l=!!(e.route.routeName===P.DashboardRoutes.Home||e.route.routeName===P.DashboardRoutes.Normal&&a.uid),d=(0,z.A)(async()=>a.type==="snapshot"?null:r.fetchDashboard({route:e.route.routeName,uid:a.uid??"",keepDashboardFromExploreInLocalStorage:!0}),[a.uid,e.route.routeName]);return A.$.featureToggles.dashboardSceneForViewers?d.loading||d?.value?.dashboard?.uid!==a.uid&&d.value?.meta?.isNew!==!0?null:d.value&&!(d.value.meta?.canEdit||d.value.meta?.canMakeEditable)&&l?(0,t.jsx)(bt,{...e}):(0,t.jsx)(Dn,{...e,params:a,location:i}):(0,t.jsx)(Dn,{...e,params:a,location:i})}const Zo=Xo},3673:(be,V,o)=>{o.d(V,{Bz:()=>P,Q9:()=>J,Ss:()=>ye,TA:()=>k,lC:()=>u});var t=o(17172),X=o(82467),z=o(3169),A=o(28676),g=o(6473),me=o(80095),_=o(81862),ae=o(20701),ie=o(72401),H=o(14792),j=o(74856),w=o(28601);function J(x,B){return async D=>{await(0,t.AI)().post("/api/dashboards/import",x),D((0,X.dx)((0,z.tZ)("Dashboard Imported",B))),D((0,ae.h9)())}}function k(x){return async B=>{await(0,A.n)().deleteDashboard(x,!1),B((0,ae.h9)())}}const P=()=>(x,B)=>{const G=B().dashboard.getModel();G&&(G.destroy(),x((0,ie.Y7)(G.uid))),(0,j.jG)().stopAutoRefresh(),x((0,w.p0)()),x((0,me.rG)()),g.t.leave(),(0,H.UA)().setCurrent(void 0)},u=x=>B=>{B((0,_.Cj)(x)),(0,j.jG)().refreshTimeModel()},ye=x=>B=>{B((0,_.xu)(x)),(0,j.jG)().refreshTimeModel()}},53652:(be,V,o)=>{o.d(V,{E:()=>_,o:()=>ie});var t=o(89667),X=o(57875),z=o(17172),A=o(32264),g=o(27677);class me{constructor(){}async get(j){const w=`api/storage/read/${j}`.replace("//","/");return(0,z.AI)().get(w)}async list(j){let w="api/storage/list/";j&&(w+=j+"/");const J=await(0,z.AI)().get(w);if(J?.data){const k=(0,t.or)(J);for(const P of k.fields)P.display=(0,X.J)({field:P,theme:A.$.theme2});return k}}async createFolder(j){const w=await(0,z.AI)().post("/api/storage/createFolder",JSON.stringify({path:j}));return w.success?{}:{error:w.message??"unknown error"}}async deleteFolder(j){const w=await(0,z.AI)().post("/api/storage/deleteFolder",JSON.stringify(j));return w.success?{}:{error:w.message??"unknown error"}}async deleteFile(j){const w=await(0,z.AI)().post(`/api/storage/delete/${j.path}`);return w.success?{}:{error:w.message??"unknown error"}}async delete(j){return j.isFolder?this.deleteFolder({path:j.path,force:!0}):this.deleteFile({path:j.path})}async upload(j,w,J){const k=new FormData;k.append("folder",j),k.append("file",w),k.append("overwriteExistingFile",String(J));const P=await fetch("/api/storage/upload",{method:"POST",body:k});let u=await P.json();return u||(u={}),u.status=P.status,u.statusText=P.statusText,P.status!==200&&!u.err&&(u.err=!0),u}async write(j,w){return g.IB.post(`/api/storage/write/${j}`,w)}async getConfig(){return(0,z.AI)().get("/api/storage/config")}async getOptions(j){return(0,z.AI)().get(`/api/storage/options/${j}`)}}function _(H,j){const J=H.toLowerCase().trim();return j.map(P=>P.trim().toLowerCase()).includes(J)}let ae;function ie(){return ae||(ae=new me),ae}}}]);

//# sourceMappingURL=8779.e255d939a1787b5617b6.js.map