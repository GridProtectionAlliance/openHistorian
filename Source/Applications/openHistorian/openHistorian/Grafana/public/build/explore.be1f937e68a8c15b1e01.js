"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[9604],{2864:(cs,Ve,p)=>{p.d(Ve,{L5:()=>u,hr:()=>ge,jN:()=>U});var t=p(91890),h=p(8484);function u(k){}function ge(k){switch(k){case t.CC.Logfmt:return{label:(0,h.t)("correlations.trans-details.logfmt-label","Logfmt"),value:t.CC.Logfmt,description:(0,h.t)("correlations.trans-details.logfmt-description","Parse provided field with logfmt to get variables"),expressionDetails:{show:!1},mapValueDetails:{show:!1}};case t.CC.Regex:return{label:(0,h.t)("correlations.trans-details.regex-label","Regular expression"),value:t.CC.Regex,description:(0,h.t)("correlations.trans-details.regex-description","Field will be parsed with regex. Use named capture groups to return multiple variables, or a single unnamed capture group to add variable to named map value. Regex is case insensitive."),expressionDetails:{show:!0,required:!0,helpText:(0,h.t)("correlations.trans-details.regex-expression","Use capture groups to extract a portion of the field.")},mapValueDetails:{show:!0,required:!1,helpText:(0,h.t)("correlations.trans-details.regex-map-values","Defines the name of the variable if the capture group is not named.")}};default:return{label:k,value:k,expressionDetails:{show:!1},mapValueDetails:{show:!1}}}}const U=()=>Object.values(t.CC).map(k=>{const ae=ge(k);return{label:ae.label,value:ae.value,description:ae.description}})},94767:(cs,Ve,p)=>{p.r(Ve),p.d(Ve,{default:()=>Wc});var t=p(74848),h=p(32196),u=p(96540),ge=p(41987),U=p(32264),k=p(40845),ae=p(66602),Fe=p(37390),Ot=p(10343),Ft=p(58720),ot=p(76888),Dt=p(25249),j=p(8484),A=p(31678),ds=p(64152),us=p(24180),rt=p(2739),$=function(e,s){e===void 0&&(e=!0);var n=(0,u.useCallback)(function(o){var r=typeof e=="function"?e():!0;if(r)return o.preventDefault(),s&&(o.returnValue=s),s},[e,s]);(0,u.useEffect)(function(){if(e)return(0,rt.on)(window,"beforeunload",n),function(){return(0,rt.AU)(window,"beforeunload",n)}},[e,n])};const se=$;var ee=p(64305),ce=p(23596),D=p(14110),je=p(67061),xe=p(56034),de=p(14578),Q=p(55852);const Do=({onSave:e,onDiscard:s,onCancel:n,message:o})=>(0,t.jsxs)(Fe.a,{isOpen:!0,title:"Unsaved changes to correlation",onDismiss:n,icon:"exclamation-triangle",className:(0,h.css)({width:"600px"}),children:[(0,t.jsx)("h5",{children:o}),(0,t.jsxs)(Fe.a.ButtonRow,{children:[(0,t.jsx)(Q.$n,{variant:"secondary",onClick:n,fill:"outline",children:"Cancel"}),(0,t.jsx)(Q.$n,{variant:"destructive",onClick:s,children:"Continue without saving"}),(0,t.jsx)(Q.$n,{variant:"primary",onClick:e,children:"Save correlation"})]})]});var ie=p(2543),Ao=(e=>(e.SOURCE_TARGET_CHANGE="cause the query in the right pane to be re-ran and links added to that data",e.FULL_QUERY_LOSS="lose the changed query",e.FULL_CORR_LOSS="cause the correlation in progress to be lost",e.INVALID_VAR="remove the variables, and your changed query may no longer be valid",e))(Ao||{});const No=(e,s,n,o)=>{const r=(0,ie.template)("<%= actionStr %> will <%= consequenceStr %>. Would you like to save before continuing?");let i="",a="";if(e===A.CORRELATION_EDITOR_POST_CONFIRM_ACTION.CLOSE_PANE)if(i="Closing the pane",s)if(n)a="cause the correlation in progress to be lost";else if(o)a="cause the query in the right pane to be re-ran and links added to that data";else return;else if(n)a="cause the correlation in progress to be lost";else if(o)a="lose the changed query";else return;else if(e===A.CORRELATION_EDITOR_POST_CONFIRM_ACTION.CHANGE_DATASOURCE)if(i="Changing the datasource",s)if(n)a="cause the correlation in progress to be lost";else return;else if(o)a="lose the changed query";else return;else if(e===A.CORRELATION_EDITOR_POST_CONFIRM_ACTION.CLOSE_EDITOR)if(i="Closing the editor",n)a="cause the correlation in progress to be lost";else if(o)a="remove the variables, and your changed query may no longer be valid";else return;return r({actionStr:i,consequenceStr:a})};var ko=p(324),Xe=p(62860),He=p(62256),J=p(29436),Z=p(23994),_=p(9955);const Po=({panes:e})=>{const s=(0,A.useDispatch)(),n=(0,k.of)(Mo),o=(0,A.useSelector)(_.vC),r=(0,A.useSelector)(_.st),[i,a]=(0,u.useState)(void 0);se(o?.correlationDirty||!1,"Save correlation?"),se(!o?.correlationDirty&&o?.queryEditorDirty||!1,"The query editor was changed. Save correlation before continuing?"),(0,u.useEffect)(()=>{if(o?.isExiting){const{correlationDirty:g,queryEditorDirty:m}=o;let y,C;o.postConfirmAction?(y=o.postConfirmAction.isActionLeft,C=o.postConfirmAction.action):(C=A.CORRELATION_EDITOR_POST_CONFIRM_ACTION.CLOSE_EDITOR,y=!1);const x=No(C,y,g,m);if(x!==void 0)a(x);else if(C===A.CORRELATION_EDITOR_POST_CONFIRM_ACTION.CHANGE_DATASOURCE&&o.postConfirmAction){const{exploreId:b,changeDatasourceUid:S}=o?.postConfirmAction;b&&S&&(s((0,Xe.wh)({exploreId:b,datasource:S,options:{importQueries:!0}})),s((0,J.am)({isExiting:!1})))}else if(C===A.CORRELATION_EDITOR_POST_CONFIRM_ACTION.CLOSE_PANE&&o.postConfirmAction){const{exploreId:b}=o?.postConfirmAction;b!==void 0&&(s((0,J.J8)(b)),s((0,J.am)({isExiting:!1})))}else C===A.CORRELATION_EDITOR_POST_CONFIRM_ACTION.CLOSE_EDITOR&&s((0,J.am)({editorMode:!1}))}},[o,s,r]),(0,ee.A)(()=>{s((0,J.am)({editorMode:!1,isExiting:!1,correlationDirty:!1,label:void 0,description:void 0,canSave:!1})),e.forEach(g=>{s((0,He.nE)({exploreId:g[0],correlationEditorHelperData:void 0})),s((0,Z.Od)({exploreId:g[0]}))})});const l=()=>{s((0,J.am)({editorMode:!0,isExiting:!1,correlationDirty:!1,label:void 0,description:void 0,canSave:!1})),e.forEach(g=>{s((0,He.nE)({exploreId:g[0],correlationEditorHelperData:void 0})),s((0,Z.Od)({exploreId:g[0]}))})},d=g=>{a(void 0),s((0,J.J8)(g)),(0,D.rR)("grafana_explore_split_view_closed")},f=(g,m)=>{a(void 0),s((0,Xe.wh)({exploreId:g,datasource:m,options:{importQueries:!0}}))},c=g=>{if(s((0,ko.v)(o?.label,o?.description,o?.transformations)),!g&&o?.postConfirmAction!==void 0){const{exploreId:m,action:y,changeDatasourceUid:C}=o?.postConfirmAction;y===A.CORRELATION_EDITOR_POST_CONFIRM_ACTION.CLOSE_PANE?(d(m),l()):y===A.CORRELATION_EDITOR_POST_CONFIRM_ACTION.CHANGE_DATASOURCE&&C!==void 0&&((0,Xe.wh)({exploreId:m,datasource:C}),l())}else s((0,J.am)({editorMode:!1,correlationDirty:!1,isExiting:!1}))};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(us.XG,{message:g=>g.pathname!=="/explore"&&o?.editorMode&&o?.correlationDirty?"You have unsaved correlation data. Continue?":!0}),i!==void 0&&(0,t.jsx)(Do,{onDiscard:()=>{if(o?.postConfirmAction!==void 0){const{exploreId:g,action:m,changeDatasourceUid:y}=o?.postConfirmAction;m===A.CORRELATION_EDITOR_POST_CONFIRM_ACTION.CLOSE_PANE?d(g):m===A.CORRELATION_EDITOR_POST_CONFIRM_ACTION.CHANGE_DATASOURCE&&y!==void 0&&f(g,y),s((0,J.am)({isExiting:!1}))}else s((0,J.am)({editorMode:!1,correlationDirty:!1,isExiting:!1}))},onCancel:()=>{s((0,J.am)({isExiting:!1})),a(void 0)},onSave:()=>{c(!1)},message:i}),(0,t.jsx)("div",{className:n.correlationEditorTop,children:(0,t.jsxs)(je.B,{gap:2,justifyContent:"flex-end",alignItems:"center",children:[(0,t.jsx)(xe.m,{content:"Correlations editor in Explore is an experimental feature.",children:(0,t.jsx)(de.I,{className:n.iconColor,name:"info-circle",size:"xl"})}),(0,t.jsx)(Q.$n,{variant:"secondary",disabled:!o?.canSave,fill:"outline",className:o?.canSave?n.buttonColor:n.disabledButtonColor,onClick:()=>{c(!0)},children:"Save"}),(0,t.jsx)(Q.$n,{variant:"secondary",fill:"outline",className:n.buttonColor,icon:"times",onClick:()=>{s((0,J.am)({isExiting:!0})),(0,D.rR)("grafana_explore_correlation_editor_exit_pressed")},children:"Exit correlation editor"})]})})]})},Mo=e=>{const s=e.colors.getContrastText(e.colors.primary.main),n=ce.MV.lighten(e.colors.primary.main,.1),o=ce.MV.darken(e.colors.primary.main,.2),r=ce.MV.darken(s,.2);return{correlationEditorTop:(0,h.css)({backgroundColor:e.colors.primary.main,marginTop:"3px",padding:e.spacing(1)}),iconColor:(0,h.css)({color:s}),buttonColor:(0,h.css)({color:s,borderColor:s,"&:hover":{color:s,borderColor:s,backgroundColor:n}}),disabledButtonColor:(0,h.css)({color:`${r} !important`,backgroundColor:`${o} !important`})}};var ps=p(1503),At=p(16233),Nt=p(14678);const $o=()=>{const[e,s]=(0,u.useState)([]),{query:n}=(0,ps.useKBar)(),o=(0,A.useDispatch)(),r=(0,A.useSelector)(_.Qb),i=(0,A.useSelector)(_.pF),a=At.TP.hasPermission(A.AccessControlAction.DataSourcesWrite);return(0,u.useEffect)(()=>{const l=Object.keys(r),d={name:"Explore",priority:ps.Priority.HIGH+1},f=[];if(i)f.push({id:"explore/run-query-left",name:"Run query (left)",keywords:"query left",perform:()=>{o((0,Z.Od)({exploreId:l[0]}))},section:d}),r[1],f.push({id:"explore/run-query-right",name:"Run query (right)",keywords:"query right",perform:()=>{o((0,Z.Od)({exploreId:l[1]}))},section:d}),f.push({id:"explore/split-view-close-left",name:"Close split view left",keywords:"split",perform:()=>{o((0,J.J8)(l[0]))},section:d}),f.push({id:"explore/split-view-close-right",name:"Close split view right",keywords:"split",perform:()=>{o((0,J.J8)(l[1]))},section:d});else{const c=Object.values(r).some(g=>g?.datasourceInstance?.uid===Nt.uv);U.$.featureToggles.correlations&&a&&!c&&f.push({id:"explore/correlations-editor",name:"Correlations editor",perform:()=>{o((0,J.am)({editorMode:!0})),o((0,Z.Od)({exploreId:l[0]}))},section:d}),f.push({id:"explore/run-query",name:"Run query",keywords:"query",perform:()=>{o((0,Z.Od)({exploreId:l[0]}))},section:d}),f.push({id:"explore/split-view-open",name:"Open split view",keywords:"split",perform:()=>{o((0,J.ve)())},section:d})}s(f)},[r,i,n,o,a]),(0,ps.useRegisterActions)(n?e:[],[e,n]),null};var zo=p(40961),Bo=function(){var e=function(s,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(o,r){o.__proto__=r}||function(o,r){for(var i in r)Object.prototype.hasOwnProperty.call(r,i)&&(o[i]=r[i])},e(s,n)};return function(s,n){e(s,n);function o(){this.constructor=s}s.prototype=n===null?Object.create(n):(o.prototype=n.prototype,new o)}}(),le=function(){return le=Object.assign||function(e){for(var s,n=1,o=arguments.length;n<o;n++){s=arguments[n];for(var r in s)Object.prototype.hasOwnProperty.call(s,r)&&(e[r]=s[r])}return e},le.apply(this,arguments)},Xs={width:"100%",height:"10px",top:"0px",left:"0px",cursor:"row-resize"},_s={width:"10px",height:"100%",top:"0px",left:"0px",cursor:"col-resize"},kt={width:"20px",height:"20px",position:"absolute"},Ho={top:le(le({},Xs),{top:"-5px"}),right:le(le({},_s),{left:void 0,right:"-5px"}),bottom:le(le({},Xs),{top:void 0,bottom:"-5px"}),left:le(le({},_s),{left:"-5px"}),topRight:le(le({},kt),{right:"-10px",top:"-10px",cursor:"ne-resize"}),bottomRight:le(le({},kt),{right:"-10px",bottom:"-10px",cursor:"se-resize"}),bottomLeft:le(le({},kt),{left:"-10px",bottom:"-10px",cursor:"sw-resize"}),topLeft:le(le({},kt),{left:"-10px",top:"-10px",cursor:"nw-resize"})},Qo=function(e){Bo(s,e);function s(){var n=e!==null&&e.apply(this,arguments)||this;return n.onMouseDown=function(o){n.props.onResizeStart(o,n.props.direction)},n.onTouchStart=function(o){n.props.onResizeStart(o,n.props.direction)},n}return s.prototype.render=function(){return u.createElement("div",{className:this.props.className||"",style:le(le({position:"absolute",userSelect:"none"},Ho[this.props.direction]),this.props.replaceStyles||{}),onMouseDown:this.onMouseDown,onTouchStart:this.onTouchStart},this.props.children)},s}(u.PureComponent),Wo=function(){var e=function(s,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(o,r){o.__proto__=r}||function(o,r){for(var i in r)Object.prototype.hasOwnProperty.call(r,i)&&(o[i]=r[i])},e(s,n)};return function(s,n){e(s,n);function o(){this.constructor=s}s.prototype=n===null?Object.create(n):(o.prototype=n.prototype,new o)}}(),De=function(){return De=Object.assign||function(e){for(var s,n=1,o=arguments.length;n<o;n++){s=arguments[n];for(var r in s)Object.prototype.hasOwnProperty.call(s,r)&&(e[r]=s[r])}return e},De.apply(this,arguments)},Vo={width:"auto",height:"auto"},Pt=function(e,s,n){return Math.max(Math.min(e,n),s)},en=function(e,s,n){var o=Math.round(e/s);return o*s+n*(o-1)},it=function(e,s){return new RegExp(e,"i").test(s)},Mt=function(e){return!!(e.touches&&e.touches.length)},qo=function(e){return!!((e.clientX||e.clientX===0)&&(e.clientY||e.clientY===0))},tn=function(e,s,n){n===void 0&&(n=0);var o=s.reduce(function(i,a,l){return Math.abs(a-e)<Math.abs(s[i]-e)?l:i},0),r=Math.abs(s[o]-e);return n===0||r<n?s[o]:e},hs=function(e){return e=e.toString(),e==="auto"||e.endsWith("px")||e.endsWith("%")||e.endsWith("vh")||e.endsWith("vw")||e.endsWith("vmax")||e.endsWith("vmin")?e:e+"px"},$t=function(e,s,n,o){if(e&&typeof e=="string"){if(e.endsWith("px"))return Number(e.replace("px",""));if(e.endsWith("%")){var r=Number(e.replace("%",""))/100;return s*r}if(e.endsWith("vw")){var r=Number(e.replace("vw",""))/100;return n*r}if(e.endsWith("vh")){var r=Number(e.replace("vh",""))/100;return o*r}}return e},Uo=function(e,s,n,o,r,i,a){return o=$t(o,e.width,s,n),r=$t(r,e.height,s,n),i=$t(i,e.width,s,n),a=$t(a,e.height,s,n),{maxWidth:typeof o>"u"?void 0:Number(o),maxHeight:typeof r>"u"?void 0:Number(r),minWidth:typeof i>"u"?void 0:Number(i),minHeight:typeof a>"u"?void 0:Number(a)}},Go=function(e){return Array.isArray(e)?e:[e,e]},Ko=["as","ref","style","className","grid","gridGap","snap","bounds","boundsByDirection","size","defaultSize","minWidth","minHeight","maxWidth","maxHeight","lockAspectRatio","lockAspectRatioExtraWidth","lockAspectRatioExtraHeight","enable","handleStyles","handleClasses","handleWrapperStyle","handleWrapperClass","children","onResizeStart","onResize","onResizeStop","handleComponent","scale","resizeRatio","snapGap"],sn="__resizable_base__",nn=function(e){Wo(s,e);function s(n){var o,r,i,a,l=e.call(this,n)||this;return l.ratio=1,l.resizable=null,l.parentLeft=0,l.parentTop=0,l.resizableLeft=0,l.resizableRight=0,l.resizableTop=0,l.resizableBottom=0,l.targetLeft=0,l.targetTop=0,l.appendBase=function(){if(!l.resizable||!l.window)return null;var d=l.parentNode;if(!d)return null;var f=l.window.document.createElement("div");return f.style.width="100%",f.style.height="100%",f.style.position="absolute",f.style.transform="scale(0, 0)",f.style.left="0",f.style.flex="0 0 100%",f.classList?f.classList.add(sn):f.className+=sn,d.appendChild(f),f},l.removeBase=function(d){var f=l.parentNode;f&&f.removeChild(d)},l.state={isResizing:!1,width:(r=(o=l.propsSize)===null||o===void 0?void 0:o.width)!==null&&r!==void 0?r:"auto",height:(a=(i=l.propsSize)===null||i===void 0?void 0:i.height)!==null&&a!==void 0?a:"auto",direction:"right",original:{x:0,y:0,width:0,height:0},backgroundStyle:{height:"100%",width:"100%",backgroundColor:"rgba(0,0,0,0)",cursor:"auto",opacity:0,position:"fixed",zIndex:9999,top:"0",left:"0",bottom:"0",right:"0"},flexBasis:void 0},l.onResizeStart=l.onResizeStart.bind(l),l.onMouseMove=l.onMouseMove.bind(l),l.onMouseUp=l.onMouseUp.bind(l),l}return Object.defineProperty(s.prototype,"parentNode",{get:function(){return this.resizable?this.resizable.parentNode:null},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"window",{get:function(){return!this.resizable||!this.resizable.ownerDocument?null:this.resizable.ownerDocument.defaultView},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"propsSize",{get:function(){return this.props.size||this.props.defaultSize||Vo},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"size",{get:function(){var n=0,o=0;if(this.resizable&&this.window){var r=this.resizable.offsetWidth,i=this.resizable.offsetHeight,a=this.resizable.style.position;a!=="relative"&&(this.resizable.style.position="relative"),n=this.resizable.style.width!=="auto"?this.resizable.offsetWidth:r,o=this.resizable.style.height!=="auto"?this.resizable.offsetHeight:i,this.resizable.style.position=a}return{width:n,height:o}},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"sizeStyle",{get:function(){var n=this,o=this.props.size,r=function(l){var d;if(typeof n.state[l]>"u"||n.state[l]==="auto")return"auto";if(n.propsSize&&n.propsSize[l]&&(!((d=n.propsSize[l])===null||d===void 0)&&d.toString().endsWith("%"))){if(n.state[l].toString().endsWith("%"))return n.state[l].toString();var f=n.getParentSize(),c=Number(n.state[l].toString().replace("px","")),g=c/f[l]*100;return g+"%"}return hs(n.state[l])},i=o&&typeof o.width<"u"&&!this.state.isResizing?hs(o.width):r("width"),a=o&&typeof o.height<"u"&&!this.state.isResizing?hs(o.height):r("height");return{width:i,height:a}},enumerable:!1,configurable:!0}),s.prototype.getParentSize=function(){if(!this.parentNode)return this.window?{width:this.window.innerWidth,height:this.window.innerHeight}:{width:0,height:0};var n=this.appendBase();if(!n)return{width:0,height:0};var o=!1,r=this.parentNode.style.flexWrap;r!=="wrap"&&(o=!0,this.parentNode.style.flexWrap="wrap"),n.style.position="relative",n.style.minWidth="100%",n.style.minHeight="100%";var i={width:n.offsetWidth,height:n.offsetHeight};return o&&(this.parentNode.style.flexWrap=r),this.removeBase(n),i},s.prototype.bindEvents=function(){this.window&&(this.window.addEventListener("mouseup",this.onMouseUp),this.window.addEventListener("mousemove",this.onMouseMove),this.window.addEventListener("mouseleave",this.onMouseUp),this.window.addEventListener("touchmove",this.onMouseMove,{capture:!0,passive:!1}),this.window.addEventListener("touchend",this.onMouseUp))},s.prototype.unbindEvents=function(){this.window&&(this.window.removeEventListener("mouseup",this.onMouseUp),this.window.removeEventListener("mousemove",this.onMouseMove),this.window.removeEventListener("mouseleave",this.onMouseUp),this.window.removeEventListener("touchmove",this.onMouseMove,!0),this.window.removeEventListener("touchend",this.onMouseUp))},s.prototype.componentDidMount=function(){if(!(!this.resizable||!this.window)){var n=this.window.getComputedStyle(this.resizable);this.setState({width:this.state.width||this.size.width,height:this.state.height||this.size.height,flexBasis:n.flexBasis!=="auto"?n.flexBasis:void 0})}},s.prototype.componentWillUnmount=function(){this.window&&this.unbindEvents()},s.prototype.createSizeForCssProperty=function(n,o){var r=this.propsSize&&this.propsSize[o];return this.state[o]==="auto"&&this.state.original[o]===n&&(typeof r>"u"||r==="auto")?"auto":n},s.prototype.calculateNewMaxFromBoundary=function(n,o){var r=this.props.boundsByDirection,i=this.state.direction,a=r&&it("left",i),l=r&&it("top",i),d,f;if(this.props.bounds==="parent"){var c=this.parentNode;c&&(d=a?this.resizableRight-this.parentLeft:c.offsetWidth+(this.parentLeft-this.resizableLeft),f=l?this.resizableBottom-this.parentTop:c.offsetHeight+(this.parentTop-this.resizableTop))}else this.props.bounds==="window"?this.window&&(d=a?this.resizableRight:this.window.innerWidth-this.resizableLeft,f=l?this.resizableBottom:this.window.innerHeight-this.resizableTop):this.props.bounds&&(d=a?this.resizableRight-this.targetLeft:this.props.bounds.offsetWidth+(this.targetLeft-this.resizableLeft),f=l?this.resizableBottom-this.targetTop:this.props.bounds.offsetHeight+(this.targetTop-this.resizableTop));return d&&Number.isFinite(d)&&(n=n&&n<d?n:d),f&&Number.isFinite(f)&&(o=o&&o<f?o:f),{maxWidth:n,maxHeight:o}},s.prototype.calculateNewSizeFromDirection=function(n,o){var r=this.props.scale||1,i=Go(this.props.resizeRatio||1),a=i[0],l=i[1],d=this.state,f=d.direction,c=d.original,g=this.props,m=g.lockAspectRatio,y=g.lockAspectRatioExtraHeight,C=g.lockAspectRatioExtraWidth,x=c.width,b=c.height,S=y||0,w=C||0;return it("right",f)&&(x=c.width+(n-c.x)*a/r,m&&(b=(x-w)/this.ratio+S)),it("left",f)&&(x=c.width-(n-c.x)*a/r,m&&(b=(x-w)/this.ratio+S)),it("bottom",f)&&(b=c.height+(o-c.y)*l/r,m&&(x=(b-S)*this.ratio+w)),it("top",f)&&(b=c.height-(o-c.y)*l/r,m&&(x=(b-S)*this.ratio+w)),{newWidth:x,newHeight:b}},s.prototype.calculateNewSizeFromAspectRatio=function(n,o,r,i){var a=this.props,l=a.lockAspectRatio,d=a.lockAspectRatioExtraHeight,f=a.lockAspectRatioExtraWidth,c=typeof i.width>"u"?10:i.width,g=typeof r.width>"u"||r.width<0?n:r.width,m=typeof i.height>"u"?10:i.height,y=typeof r.height>"u"||r.height<0?o:r.height,C=d||0,x=f||0;if(l){var b=(m-C)*this.ratio+x,S=(y-C)*this.ratio+x,w=(c-x)/this.ratio+C,R=(g-x)/this.ratio+C,v=Math.max(c,b),L=Math.min(g,S),T=Math.max(m,w),F=Math.min(y,R);n=Pt(n,v,L),o=Pt(o,T,F)}else n=Pt(n,c,g),o=Pt(o,m,y);return{newWidth:n,newHeight:o}},s.prototype.setBoundingClientRect=function(){var n=1/(this.props.scale||1);if(this.props.bounds==="parent"){var o=this.parentNode;if(o){var r=o.getBoundingClientRect();this.parentLeft=r.left*n,this.parentTop=r.top*n}}if(this.props.bounds&&typeof this.props.bounds!="string"){var i=this.props.bounds.getBoundingClientRect();this.targetLeft=i.left*n,this.targetTop=i.top*n}if(this.resizable){var a=this.resizable.getBoundingClientRect(),l=a.left,d=a.top,f=a.right,c=a.bottom;this.resizableLeft=l*n,this.resizableRight=f*n,this.resizableTop=d*n,this.resizableBottom=c*n}},s.prototype.onResizeStart=function(n,o){if(!(!this.resizable||!this.window)){var r=0,i=0;if(n.nativeEvent&&qo(n.nativeEvent)?(r=n.nativeEvent.clientX,i=n.nativeEvent.clientY):n.nativeEvent&&Mt(n.nativeEvent)&&(r=n.nativeEvent.touches[0].clientX,i=n.nativeEvent.touches[0].clientY),this.props.onResizeStart&&this.resizable){var a=this.props.onResizeStart(n,o,this.resizable);if(a===!1)return}this.props.size&&(typeof this.props.size.height<"u"&&this.props.size.height!==this.state.height&&this.setState({height:this.props.size.height}),typeof this.props.size.width<"u"&&this.props.size.width!==this.state.width&&this.setState({width:this.props.size.width})),this.ratio=typeof this.props.lockAspectRatio=="number"?this.props.lockAspectRatio:this.size.width/this.size.height;var l,d=this.window.getComputedStyle(this.resizable);if(d.flexBasis!=="auto"){var f=this.parentNode;if(f){var c=this.window.getComputedStyle(f).flexDirection;this.flexDir=c.startsWith("row")?"row":"column",l=d.flexBasis}}this.setBoundingClientRect(),this.bindEvents();var g={original:{x:r,y:i,width:this.size.width,height:this.size.height},isResizing:!0,backgroundStyle:De(De({},this.state.backgroundStyle),{cursor:this.window.getComputedStyle(n.target).cursor||"auto"}),direction:o,flexBasis:l};this.setState(g)}},s.prototype.onMouseMove=function(n){var o=this;if(!(!this.state.isResizing||!this.resizable||!this.window)){if(this.window.TouchEvent&&Mt(n))try{n.preventDefault(),n.stopPropagation()}catch{}var r=this.props,i=r.maxWidth,a=r.maxHeight,l=r.minWidth,d=r.minHeight,f=Mt(n)?n.touches[0].clientX:n.clientX,c=Mt(n)?n.touches[0].clientY:n.clientY,g=this.state,m=g.direction,y=g.original,C=g.width,x=g.height,b=this.getParentSize(),S=Uo(b,this.window.innerWidth,this.window.innerHeight,i,a,l,d);i=S.maxWidth,a=S.maxHeight,l=S.minWidth,d=S.minHeight;var w=this.calculateNewSizeFromDirection(f,c),R=w.newHeight,v=w.newWidth,L=this.calculateNewMaxFromBoundary(i,a);this.props.snap&&this.props.snap.x&&(v=tn(v,this.props.snap.x,this.props.snapGap)),this.props.snap&&this.props.snap.y&&(R=tn(R,this.props.snap.y,this.props.snapGap));var T=this.calculateNewSizeFromAspectRatio(v,R,{width:L.maxWidth,height:L.maxHeight},{width:l,height:d});if(v=T.newWidth,R=T.newHeight,this.props.grid){var F=en(v,this.props.grid[0],this.props.gridGap?this.props.gridGap[0]:0),N=en(R,this.props.grid[1],this.props.gridGap?this.props.gridGap[1]:0),P=this.props.snapGap||0,H=P===0||Math.abs(F-v)<=P?F:v,E=P===0||Math.abs(N-R)<=P?N:R;v=H,R=E}var q={width:v-y.width,height:R-y.height};if(C&&typeof C=="string"){if(C.endsWith("%")){var X=v/b.width*100;v=X+"%"}else if(C.endsWith("vw")){var oe=v/this.window.innerWidth*100;v=oe+"vw"}else if(C.endsWith("vh")){var he=v/this.window.innerHeight*100;v=he+"vh"}}if(x&&typeof x=="string"){if(x.endsWith("%")){var X=R/b.height*100;R=X+"%"}else if(x.endsWith("vw")){var oe=R/this.window.innerWidth*100;R=oe+"vw"}else if(x.endsWith("vh")){var he=R/this.window.innerHeight*100;R=he+"vh"}}var O={width:this.createSizeForCssProperty(v,"width"),height:this.createSizeForCssProperty(R,"height")};this.flexDir==="row"?O.flexBasis=O.width:this.flexDir==="column"&&(O.flexBasis=O.height);var z=this.state.width!==O.width,B=this.state.height!==O.height,G=this.state.flexBasis!==O.flexBasis,M=z||B||G;M&&(0,zo.flushSync)(function(){o.setState(O)}),this.props.onResize&&M&&this.props.onResize(n,m,this.resizable,q)}},s.prototype.onMouseUp=function(n){var o,r,i=this.state,a=i.isResizing,l=i.direction,d=i.original;if(!(!a||!this.resizable)){var f={width:this.size.width-d.width,height:this.size.height-d.height};this.props.onResizeStop&&this.props.onResizeStop(n,l,this.resizable,f),this.props.size&&this.setState({width:(o=this.props.size.width)!==null&&o!==void 0?o:"auto",height:(r=this.props.size.height)!==null&&r!==void 0?r:"auto"}),this.unbindEvents(),this.setState({isResizing:!1,backgroundStyle:De(De({},this.state.backgroundStyle),{cursor:"auto"})})}},s.prototype.updateSize=function(n){var o,r;this.setState({width:(o=n.width)!==null&&o!==void 0?o:"auto",height:(r=n.height)!==null&&r!==void 0?r:"auto"})},s.prototype.renderResizer=function(n){var o=this,r=this.props,i=r.enable,a=r.handleStyles,l=r.handleClasses,d=r.handleWrapperStyle,f=r.handleWrapperClass,c=r.handleComponent;if(!i)return null;var g=n.filter(function(m){return i[m]!==!1}).map(function(m){return i[m]!==!1?u.createElement(Qo,{key:m,direction:m,onResizeStart:o.onResizeStart,replaceStyles:a&&a[m],className:l&&l[m]},c&&c[m]?c[m]:null):null});return u.createElement("div",{className:f,style:d},g)},s.prototype.render=function(){var n=this,o=Object.keys(this.props).reduce(function(a,l){return Ko.indexOf(l)!==-1||(a[l]=n.props[l]),a},{}),r=De(De(De({position:"relative",userSelect:this.state.isResizing?"none":"auto"},this.props.style),this.sizeStyle),{maxWidth:this.props.maxWidth,maxHeight:this.props.maxHeight,minWidth:this.props.minWidth,minHeight:this.props.minHeight,boxSizing:"border-box",flexShrink:0});this.state.flexBasis&&(r.flexBasis=this.state.flexBasis);var i=this.props.as||"div";return u.createElement(i,De({style:r,className:this.props.className},o,{ref:function(a){a&&(n.resizable=a)}}),this.state.isResizing&&u.createElement("div",{style:this.state.backgroundStyle}),this.renderResizer(["topLeft","top","topRight","left"]),this.props.children,this.renderResizer(["right","bottomLeft","bottom","bottomRight"]))},s.defaultProps={as:"div",onResizeStart:function(){},onResize:function(){},onResizeStop:function(){},enable:{top:!0,right:!0,bottom:!0,left:!0,topRight:!0,bottomRight:!0,bottomLeft:!0,topLeft:!0},style:{},grid:[1,1],gridGap:[0,0],lockAspectRatio:!1,lockAspectRatioExtraWidth:0,lockAspectRatioExtraHeight:0,scale:1,resizeRatio:1,snapGap:0},s}(u.PureComponent),Yo=p(69144);function on(e){const{children:s,onResize:n,initialHeight:o}=e,r=(0,k.$j)(),i=(0,k.of)(Jo),a=(0,Yo.l)(r),l=o||`${r.components.horizontalDrawer.defaultHeight}px`;return(0,t.jsx)(nn,{className:(0,h.cx)(i.fixed,i.container,i.drawerActive),defaultSize:{width:"100%",height:l},handleClasses:{top:a.dragHandleHorizontal},enable:{top:!0,right:!1,bottom:!1,left:!1,topRight:!1,bottomRight:!1,bottomLeft:!1,topLeft:!1},maxHeight:"100vh",onResize:n,children:s})}const Zo=e=>(0,h.keyframes)`
  0% {
    transform: translateY(${e.components.horizontalDrawer.defaultHeight}px);
  }

  100% {
    transform: translateY(0px);
  }
`,Jo=e=>({fixed:(0,h.css)({position:"absolute !important"}),container:(0,h.css)({bottom:0,background:e.colors.background.primary,borderTop:`1px solid ${e.colors.border.weak}`,boxShadow:e.shadows.z3,zIndex:e.zIndex.navbarFixed}),drawerActive:(0,h.css)({opacity:1,[e.transitions.handleMotion("no-preference")]:{animation:`0.5s ease-out ${Zo(e)}`}})});var Ie=p(71468),Xo=p(18226),rn=p(1933),pt=p(13544),zt=p(40276),ht=p(87490),_o=p(70713),Bt=p(68941),ne=p(9557),Re=p(39070),Ae=p(19347),gs=p(52494),Ht=p(88407),gt=p(11401),Qt=p(32901),an=p(42941),er=p(23535),tr=function(e){var s=(0,er.A)({x:0,y:0}),n=s[0],o=s[1];return(0,u.useEffect)(function(){var r=function(){e.current&&o({x:e.current.scrollLeft,y:e.current.scrollTop})};return e.current&&(0,rt.on)(e.current,"scroll",r,{capture:!1,passive:!0}),function(){e.current&&(0,rt.AU)(e.current,"scroll",r)}},[e]),n};const sr=tr,ln=(0,u.createContext)(void 0);function nr({children:e,refreshDependencies:s}){const[n,o]=(0,u.useState)([]),r=(0,u.useRef)({}),i=(0,u.useCallback)(c=>{const g=c.id?c.id:(0,ie.uniqueId)(`${c.panelId}-${c.title}-${c.icon}_`);return o(m=>{if(c.level==="root"){const y=r.current[c.panelId]||[];return y.length>0&&r.current[c.panelId].forEach(x=>{x.type==="filter"&&(x.ref=c.ref)}),r.current[c.panelId]=[],[...m,{...c,id:g,children:y}].sort(cn)}if(c.level==="child"){let y=!1;if(Object.keys(r.current).forEach(v=>{if(r.current[v].find(T=>T.title===c.title&&c.type==="filter"&&c.panelId===T.panelId)){y=!0;return}}),y)return[...m];const C=m.findIndex(v=>v.panelId===c.panelId&&v.level==="root");if(C===-1)return Object.keys(r.current).find(L=>L===c.panelId)?r.current[c.panelId].push({...c,id:g}):r.current[c.panelId]=[{...c,id:g}],[...m];const x=[...m],b={...x[C]},S=b.children?.find(v=>v.title===c.title&&c.type==="filter"&&c.panelId===v.panelId);if(S&&S.highlight!==c.highlight)return b.children?.map(v=>{v.title===S?.title&&(v.highlight=c.highlight)}),[...m];if(S)return[...m];let w=c.ref;c.type==="filter"&&(w=b.ref);let R=[{...c,id:g,ref:w},...b.children||[]];return c.childOnTop||(R=dn(R)),x[C]={...b,children:R},x}return[...m]}),g},[]),a=(0,u.useCallback)(c=>{o(g=>g.filter(m=>m.id!==c).map(m=>(m.children&&(m.children=m.children.filter(y=>y.id!==c)),m)))},[]),l=(0,u.useCallback)(c=>{o(c)},[]),d=(0,u.useCallback)((c,g)=>{o(m=>m.map(y=>y.id===c?{...y,...g}:y))},[]),f=(0,u.useCallback)((c,g)=>{o(m=>{const y=c(m);return y?m.map(C=>(C.id===y&&(C.children=C.children?.filter(x=>x.type!==g)),C)):m})},[]);return(0,u.useEffect)(()=>{o(c=>{const g=[...c];for(const m of g){const y=dn(m.children||[]);m.children=y}return g})},[s]),(0,t.jsx)(ln.Provider,{value:{outlineItems:n,register:i,unregister:a,updateOutlineItems:l,unregisterAllChildren:f,updateItem:d},children:e})}function cn(e,s){if(e.ref&&s.ref){const n=e.ref.compareDocumentPosition(s.ref);if(n===Node.DOCUMENT_POSITION_PRECEDING)return 1;if(n===Node.DOCUMENT_POSITION_FOLLOWING)return-1}return 0}function dn(e){const[s,n]=e.reduce((o,r)=>(r.childOnTop?o[0].push(r):o[1].push(r),o),[[],[]]);return n.sort(cn),[...s,...n]}function fs(){return(0,u.useContext)(ln)}var or=p(8887);function ms({contentOutlineExpanded:e,title:s,icon:n,tooltip:o,tooltipPlacement:r="bottom",className:i,indentStyle:a,collapsible:l,collapsed:d,isActive:f,extraHighlight:c,sectionId:g,toggleCollapsed:m,color:y,onRemove:C,...x}){const b=(0,k.$j)(),S=rr(b,y),w=(0,h.cx)(S.button,i),R=(0,u.useRef)(null),[v,L]=(0,u.useState)(!1);(0,u.useEffect)(()=>{R.current&&L(R.current?.scrollWidth>R.current?.clientWidth)},[s]);const T=(0,t.jsxs)("div",{className:(0,h.cx)(S.buttonContainer,a),children:[l&&(0,t.jsx)("button",{className:S.collapseButton,onClick:m,"aria-label":"Content outline item collapse button","aria-expanded":!d,"aria-controls":g,children:(0,t.jsx)(un,{icon:d?"angle-right":"angle-down"})}),(0,t.jsxs)("button",{className:(0,h.cx)(w,{[S.active]:f,[S.extraHighlight]:c}),"aria-label":o,...x,children:[(0,t.jsx)(un,{icon:n}),s&&(0,t.jsx)("span",{className:S.textContainer,ref:R,children:s})]}),C&&(0,t.jsx)(Q.$n,{variant:"destructive",className:S.deleteButton,icon:"times",onClick:()=>C(),"data-testid":"content-outline-item-delete-button"})]});return o&&(!e||v)?(0,t.jsx)(xe.m,{content:o,placement:r,children:T}):T}function un({icon:e}){return e?(0,or.n6)(e)?(0,t.jsx)(de.I,{name:e,size:"lg",title:e}):e:null}const rr=(e,s)=>({buttonContainer:(0,h.css)({position:"relative",display:"flex",alignItems:"center",flexGrow:1,gap:e.spacing(.25),width:"100%",overflow:"hidden"}),button:(0,h.css)({label:"content-outline-item-button",display:"flex",alignItems:"center",height:e.spacing(e.components.height.md),gap:e.spacing(.5),color:e.colors.text.secondary,width:"100%",background:"transparent",overflow:"hidden",border:"none"}),collapseButton:(0,h.css)({display:"flex",alignItems:"center",justifyContent:"center",width:e.spacing(3),height:e.spacing(4),borderRadius:e.shape.radius.default,color:e.colors.text.secondary,background:"transparent",border:"none",overflow:"hidden","&:hover":{color:e.colors.text.primary,background:e.colors.secondary.shade}}),textContainer:(0,h.css)({whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",fontSize:e.typography.bodySmall.fontSize,marginLeft:e.spacing(.5)}),active:(0,h.css)({backgroundColor:e.colors.background.secondary,borderTopRightRadius:e.shape.radius.default,borderBottomRightRadius:e.shape.radius.default,position:"relative",height:e.spacing(e.components.height.md),"&::before":{backgroundImage:s!==void 0?"none":e.colors.gradients.brandVertical,backgroundColor:s!==void 0?s:"none",borderRadius:e.shape.radius.default,content:'" "',display:"block",height:"100%",position:"absolute",transform:"translateX(-50%)",width:e.spacing(.5),left:"2px"}}),extraHighlight:(0,h.css)({backgroundColor:e.colors.background.secondary,borderTopRightRadius:e.shape.radius.default,borderBottomRightRadius:e.shape.radius.default,position:"relative","&::before":{backgroundImage:s!==void 0?"none":e.colors.gradients.brandVertical,backgroundColor:s!==void 0?s:"none",borderRadius:e.shape.radius.default,content:'" "',display:"block",height:"100%",position:"absolute",transform:"translateX(-50%)",width:e.spacing(.5),left:"2px"}}),deleteButton:(0,h.css)({width:e.spacing(1),height:e.spacing(1),padding:e.spacing(.75,.75),marginRight:e.spacing(.5)})});function pn(e){return e.children?.filter(s=>s.type!=="filter")||[]}function hn(e,s,n,o){const r=s===e.id,i=n===e.id,a=!o[e.id],l=pn(e).length>0,d=qt(e,n)&&!o[e.id];return l?a&&(r||d):r||i}const Wt={visible:"grafana.explore.contentOutline.visible",expanded:"grafana.explore.contentOutline.expanded"};function ir({scroller:e,panelId:s}){const[n,o]=(0,an.A)(Bt.M.getBool(Wt.expanded,!0)),r=(0,k.of)(ar,n),i=(0,u.useRef)(e||null),{y:a}=sr(i),{outlineItems:l}=fs()??{outlineItems:[]},[d,f]=(0,u.useState)(l[0]?.id),[c,g]=(0,u.useState)(l[0]?.children?.[0]?.id),m=l.some(v=>v.children&&!(v.mergeSingleChild&&v.children?.length===1)&&v.children.length>0),y=l.some(v=>v.children?.some(L=>L.onRemove)),[C,x]=(0,u.useState)(()=>l.reduce((v,L)=>(v[L.id]=!!L.expanded,v),{})),b=(v,L=0)=>{let T=0,F=v;if(F){do T+=F?.offsetTop||0,F=F?.offsetParent instanceof HTMLElement?F.offsetParent:void 0;while(F&&F!==e);e?.scroll({top:T+L,behavior:"smooth"})}},S=v=>{if(v.level==="child"&&v.type==="filter"){const L=l.find(T=>T.children?.find(F=>F.id===v.id));L&&b(L.ref,L.customTopOffset)}else b(v.ref,v.customTopOffset),(0,D.rR)("explore_toolbar_contentoutline_clicked",{item:"select_section",type:v.panelId})},w=()=>{Bt.M.set(Wt.expanded,!n),o(),(0,D.rR)("explore_toolbar_contentoutline_clicked",{item:"outline",type:n?"minimize":"expand"})},R=v=>{x(L=>({...L,[v]:!L[v]})),(0,D.rR)("explore_toolbar_contentoutline_clicked",{item:"section",type:C[v]?"expand":"minimize"})};return(0,u.useEffect)(()=>{let v;for(const L of l){let T=L?.ref?.getBoundingClientRect().top;T&&T>=0&&(v=L);const F=pn(L).find(N=>{const P=N.customTopOffset||0;let H=N?.ref?.getBoundingClientRect().top;return H&&H>=P});if(F&&Vt(L)){g(F.id),f(L.id);break}if(v){f(v.id),g(void 0);break}}},[l,a]),(0,t.jsx)(gs._,{className:r.wrapper,id:s,children:(0,t.jsx)(zt.E,{children:(0,t.jsxs)("div",{className:r.content,children:[(0,t.jsx)(ms,{icon:"arrow-from-right",tooltip:n?"Collapse outline":"Expand outline",tooltipPlacement:n?"right":"bottom",onClick:w,className:(0,h.cx)(r.toggleContentOutlineButton,{[r.justifyCenter]:!n&&!m}),"aria-expanded":n}),l.map(v=>(0,t.jsxs)(u.Fragment,{children:[(0,t.jsx)(ms,{title:n?v.title:void 0,contentOutlineExpanded:n,className:(0,h.cx)(r.buttonStyles,{[r.justifyCenter]:!n&&!y,[r.sectionHighlighter]:qt(v,c)&&!n}),indentStyle:(0,h.cx)({[r.indentRoot]:!Vt(v)&&m,[r.sectionHighlighter]:qt(v,c)&&!n&&C[v.id]}),icon:v.icon,onClick:()=>S(v),tooltip:v.title,collapsible:Vt(v),collapsed:!C[v.id],toggleCollapsed:()=>R(v.id),isActive:hn(v,d,c,C),sectionId:v.id,color:v.color},v.id),(0,t.jsx)("div",{id:v.id,"data-testid":`section-wrapper-${v.id}`,children:v.children&&Vt(v)&&C[v.id]&&v.children.map((L,T)=>(0,t.jsxs)("div",{className:r.itemWrapper,children:[n&&(0,t.jsx)("div",{className:(0,h.cx)(r.itemConnector,{[r.firstItemConnector]:T===0,[r.lastItemConnector]:T===(v.children?.length||0)-1})}),(0,t.jsx)(ms,{title:n?L.title:void 0,contentOutlineExpanded:n,icon:n?void 0:v.icon,className:(0,h.cx)(r.buttonStyles,{[r.justifyCenter]:!n&&!y,[r.sectionHighlighter]:qt(v,c)&&!n}),indentStyle:r.indentChild,onClick:F=>{S(L),L.onClick?.(F)},tooltip:L.title,isActive:hn(L,d,c,C),extraHighlight:L.highlight,color:L.color,onRemove:L.onRemove?()=>L.onRemove?.(L.id):void 0},L.id)]},L.id))})]},v.id))]})})})}const ar=(e,s)=>({wrapper:(0,h.css)({label:"wrapper",position:"relative",display:"flex",justifyContent:"center",marginRight:e.spacing(1),height:"100%",backgroundColor:e.colors.background.primary,width:s?"160px":void 0,minWidth:s?"160px":void 0}),content:(0,h.css)({label:"content",marginLeft:e.spacing(.5),top:0}),buttonStyles:(0,h.css)({display:"flex","&:hover":{color:e.colors.text.primary,textDecoration:"underline"}}),toggleContentOutlineButton:(0,h.css)({"&:hover":{color:e.colors.text.primary},transform:s?"rotate(180deg)":"",marginRight:s?e.spacing(.5):void 0}),indentRoot:(0,h.css)({paddingLeft:e.spacing(3)}),indentChild:(0,h.css)({paddingLeft:s?e.spacing(5):e.spacing(2.75)}),itemWrapper:(0,h.css)({display:"flex",height:e.spacing(4),alignItems:"center"}),itemConnector:(0,h.css)({position:"relative",height:"100%",width:e.spacing(1.5),"&::before":{borderRight:`1px solid ${e.colors.border.medium}`,content:'""',height:"100%",left:e.spacing(4.75),position:"absolute",transform:"translateX(50%)"}}),firstItemConnector:(0,h.css)({"&::before":{top:e.spacing(1),height:`calc(100% - ${e.spacing(1)})`}}),lastItemConnector:(0,h.css)({"&::before":{height:`calc(100% - ${e.spacing(1)})`}}),justifyCenter:(0,h.css)({justifyContent:"center"}),sectionHighlighter:(0,h.css)({backgroundColor:e.colors.background.secondary})});function Vt(e){return!!(e.children&&e.children.length>0&&(!e.mergeSingleChild||e.children.length!==1))}function qt(e,s){return e.children?.some(n=>n.id===s)}function Ee({panelId:e,title:s,icon:n,customTopOffset:o,children:r,className:i,level:a="root",mergeSingleChild:l,type:d="scrollIntoView",onClick:f}){const{register:c,unregister:g}=fs()??{},m=(0,u.useRef)(null);return(0,u.useEffect)(()=>{if(!c||!g)return;const y=c({panelId:e,title:s,icon:n,ref:m.current,customTopOffset:o,level:a,mergeSingleChild:l,type:d});return()=>g(y)},[e,s,n,o,a,l,c,g,d,f]),(0,t.jsx)("div",{className:i,ref:m,children:r})}var ft=p(49785),mt=p(16817),yt=p(42418),Ut=p(82762),ve=p(88575),_e=p(10354),Gt=p(10860),qe=p(29158),lr=p(91605),ys=p(67023),cr=p(18380),dr=p(23257),ur=p.n(dr),pr=p(60029),Ne=p(90182),xs=p(2864);const gn=({label:e,tooltipText:s})=>(0,t.jsxs)(je.B,{gap:1,direction:"row",wrap:"wrap",alignItems:"flex-start",children:[(0,t.jsx)(pr.J,{children:e}),(0,t.jsx)(xe.m,{content:s,children:(0,t.jsx)(de.I,{name:"info-circle",size:"sm"})})]}),hr=({onSave:e,onCancel:s,fieldList:n,transformationToEdit:o})=>{const[r,i]=(0,u.useState)(void 0),[a,l]=(0,u.useState)({}),[d,f]=(0,u.useState)({mapValueDetails:{show:!1},expressionDetails:{show:!1}}),[c,g]=(0,u.useState)(!1),[m,y]=(0,u.useState)(!1),{getValues:C,control:x,register:b,watch:S}=(0,ft.mN)({defaultValues:(0,u.useMemo)(()=>{if(o){const R=n[o?.field];i(R),o?.expression&&g(!0);const v=(0,xs.hr)(o?.type);f({mapValueDetails:v.mapValueDetails,expressionDetails:v.expressionDetails});const L=(0,ys.k)({type:o?.type,expression:o?.expression,mapValue:o?.mapValue},R||"",o?.field);return l({...L}),y(!0),{type:o?.type,field:o?.field,mapValue:o?.mapValue,expression:o?.expression}}else return},[n,o])}),w=(0,u.useId)();return(0,u.useEffect)(()=>{const R=S(v=>{const L=v.expression;let T=!1;if(L!==void 0){T=!0;try{new RegExp(L)}catch{T=!1}}else T=!d.expressionDetails.show;g(T);let F=[];if(v.type){const N=(0,ys.k)({type:v.type,expression:T?L:"",mapValue:v.mapValue},n[v.field]||"",v.field);F=Object.keys(N),l(F.length>0?{...N}:{})}F.length===0||!T?y(!1):y(!0)});return()=>R.unsubscribe()},[n,d.expressionDetails.show,S]),(0,t.jsxs)(Fe.a,{isOpen:!0,title:`${o?"Edit":"Add"} transformation`,onDismiss:s,className:(0,h.css)({width:"700px"}),children:[(0,t.jsx)("p",{children:"A transformation extracts variables out of a single field. These variables will be available along with your field variables."}),(0,t.jsx)(ve.D,{label:"Field",children:(0,t.jsx)(ft.xI,{control:x,render:({field:{onChange:R,ref:v,...L}})=>(0,t.jsx)(Ne.l6,{...L,onChange:T=>{T.value&&(R(T.value),i(n[T.value]))},options:Object.entries(n).map(T=>({label:T[0],value:T[0]})),"aria-label":"field"}),name:"field"})}),r&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("pre",{children:(0,t.jsx)(ur(),{textToHighlight:r,searchWords:[c?C("expression")??"":""],autoEscape:!1})}),(0,t.jsx)(ve.D,{label:"Type",children:(0,t.jsx)(ft.xI,{control:x,render:({field:{onChange:R,ref:v,...L}})=>(0,t.jsx)(Ne.l6,{...L,onChange:T=>{R(T.value);const F=(0,xs.hr)(T.value);f({mapValueDetails:F.mapValueDetails,expressionDetails:F.expressionDetails})},options:(0,xs.jN)(),"aria-label":"type"}),name:"type"})}),d.expressionDetails.show&&(0,t.jsx)(ve.D,{label:d.expressionDetails.helpText?(0,t.jsx)(gn,{label:"Expression",tooltipText:d.expressionDetails.helpText}):"Expression",htmlFor:`${w}-expression`,required:d.expressionDetails.required,children:(0,t.jsx)(_e.p,{...b("expression"),id:`${w}-expression`})}),d.mapValueDetails.show&&(0,t.jsx)(ve.D,{label:d.mapValueDetails.helpText?(0,t.jsx)(gn,{label:"Variable Name",tooltipText:d.mapValueDetails.helpText}):"Variable Name",htmlFor:`${w}-mapValue`,children:(0,t.jsx)(_e.p,{...b("mapValue"),id:`${w}-mapValue`})}),Object.entries(a).length>0&&(0,t.jsxs)(t.Fragment,{children:["This transformation will add the following variables:",(0,t.jsx)("pre",{children:Object.entries(a).map(R=>`\${${R[0]}} = ${R[1]?.value}
`)})]})]}),(0,t.jsxs)(Fe.a.ButtonRow,{children:[(0,t.jsx)(Q.$n,{variant:"secondary",onClick:s,fill:"outline",children:"Cancel"}),(0,t.jsx)(Q.$n,{variant:"primary",onClick:()=>e(C()),disabled:!m,children:o?"Edit transformation":"Add transformation to correlation"})]})]})},gr=({exploreId:e,correlations:s})=>{const n=(0,A.useDispatch)(),o=(0,k.of)(fr),r=(0,A.useSelector)(_.Qb),i=Object.values(r),{value:a,loading:l}=(0,mt.A)(async()=>await(0,cr.tZ)(i[0],i[1]),[i[0]?.datasourceInstance,i[0]?.queries[0].datasource,i[1]?.datasourceInstance,i[1]?.queries[0].datasource]),{register:d,watch:f,getValues:c,setValue:g}=(0,ft.mN)(),[m,y]=(0,u.useState)(!1),[C,x]=(0,u.useState)(!1),[b,S]=(0,u.useState)(!1),[w,R]=(0,u.useState)([]),[v,L]=(0,u.useState)(void 0),T=(0,A.useSelector)(_.vC),F=(0,u.useId)();return(0,u.useEffect)(()=>(n((0,J.am)({canSave:!0})),()=>{n((0,J.am)({canSave:!1}))}),[n]),(0,u.useEffect)(()=>{!l&&a!==void 0&&!T?.correlationDirty&&c("label")!==""&&g("label",a)},[T?.correlationDirty,a,c,l,g]),(0,u.useEffect)(()=>{const N=f(P=>{let H=T?.correlationDirty||!1,E=P.description||"";!H&&(P.label!==a||E!=="")?H=!0:H&&P.label===a&&E.trim()===""&&(H=!1),n((0,J.am)({label:P.label,description:P.description,correlationDirty:H}))});return()=>N.unsubscribe()},[T?.correlationDirty,a,n,f]),(0,u.useEffect)(()=>{const N=!T?.correlationDirty&&w.length>0?!0:T?.correlationDirty;n((0,J.am)({transformations:w,correlationDirty:N}));let P={};w.forEach(H=>{const E=(0,ys.k)({type:H.type,expression:H.expression,mapValue:H.mapValue},s.vars[H.field],H.field);Object.keys(E).forEach(q=>{P[q]=E[q]?.value})}),n((0,He.nE)({exploreId:e,correlationEditorHelperData:{resultField:s.resultField,origVars:s.origVars,vars:{...s.origVars,...P}}}))},[n,w]),(0,t.jsxs)(t.Fragment,{children:[b&&(0,t.jsx)(hr,{onCancel:()=>{L(void 0),S(!1)},onSave:N=>{if(v!==void 0){const P=[...w];P[v]=N,R(P),L(void 0)}else R([...w,N]);S(!1)},fieldList:s.origVars,transformationToEdit:v!==void 0?w[v]:void 0}),(0,t.jsxs)(yt.F,{title:"Correlation details",severity:"info",children:["The correlation link will appear by the ",(0,t.jsx)("code",{children:s.resultField})," field. You can use the following variables to set up your correlations:",(0,t.jsx)("pre",{children:Object.entries(s.vars).map(N=>`\${${N[0]}} = ${N[1]}
`)}),(0,t.jsxs)(Ut.S,{collapsible:!0,isOpen:m,onToggle:()=>{y(!m)},label:(0,t.jsxs)(je.B,{gap:1,direction:"row",wrap:"wrap",alignItems:"center",children:["Label / Description",!m&&!l&&(0,t.jsx)("span",{className:o.labelCollapseDetails,children:`Label: ${c("label")||a}`})]}),children:[(0,t.jsx)(ve.D,{label:"Label",htmlFor:`${F}-label`,children:(0,t.jsx)(_e.p,{...d("label"),id:`${F}-label`,onBlur:()=>{c("label")===""&&a!==void 0&&g("label",a)}})}),(0,t.jsx)(ve.D,{label:"Description",htmlFor:`${F}-description`,children:(0,t.jsx)(_e.p,{...d("description"),id:`${F}-description`})})]}),(0,t.jsxs)(Ut.S,{collapsible:!0,isOpen:C,onToggle:()=>{x(!C)},label:(0,t.jsxs)(je.B,{gap:1,direction:"row",wrap:"wrap",alignItems:"center",children:["Transformations",(0,t.jsx)(xe.m,{content:"A transformation extracts one or more variables out of a single field.",children:(0,t.jsx)(de.I,{name:"info-circle",size:"sm"})})]}),children:[(0,t.jsx)(Q.$n,{variant:"secondary",fill:"outline",onClick:()=>{S(!0)},className:o.transformationAction,children:"Add transformation"}),w.map((N,P)=>{const{type:H,field:E,expression:q,mapValue:X}=N,oe=[(X??"").length>0?`Variable name: ${X}`:void 0,(q??"").length>0?(0,t.jsxs)(t.Fragment,{children:["Expression: ",(0,t.jsx)("code",{children:q})]}):void 0].filter(he=>he);return(0,t.jsxs)(Gt.Z,{children:[(0,t.jsxs)(Gt.Z.Heading,{children:[E,": ",H]}),oe.length>0&&(0,t.jsx)(Gt.Z.Meta,{className:o.transformationMeta,children:oe}),(0,t.jsxs)(Gt.Z.SecondaryActions,{children:[(0,t.jsx)(qe.K,{name:"edit","aria-label":"edit transformation",onClick:()=>{L(P),S(!0)}},"edit"),(0,t.jsx)(lr.e,{"aria-label":"delete transformation",onConfirm:()=>R(w.filter((he,O)=>P!==O)),closeOnConfirm:!0})]})]},`trans-${P}`)})]})]})]})},fr=e=>({labelCollapseDetails:(0,h.css)({marginLeft:e.spacing(2),...e.typography.bodySmall,fontStyle:"italic"}),transformationAction:(0,h.css)({marginBottom:e.spacing(2)}),transformationMeta:(0,h.css)({alignItems:"baseline"})});var mr=p(24308),yr=p(79041),Qe=p(91052),xr=p(15162),vr=p(33368);function br({width:e,height:s,timeZone:n,state:o,pluginId:r,frames:i,timeRange:a,splitOpenFn:l,eventBus:d}){const f=(0,xr.d4)(r),g={dataLinkPostProcessor:(0,vr.h)(l,a),eventBus:d,eventsScope:"explore"};return(0,t.jsx)(yr.XF,{value:g,children:(0,t.jsx)(Qe.NR,{title:f.name,width:e,height:s,loadingState:o,children:(m,y)=>(0,t.jsx)(mr.m,{data:{series:i,state:o,timeRange:a},pluginId:r,title:"",width:m,height:y,timeZone:n})})})}var Sr=p(67570),Cr=p(95247),ue=p(27746),vs=p(19727),Kt=p(11134),jr=p(75269),Rr=p(51612),bs=p(54317),Te=p(64756),Ss=p(10096),fn=p(81862),Ue=p(47232),mn=p(85858),Tr=p(25573),yn=p(80582);function wr(e){const{onClick:s,isSynced:n}=e,o=()=>{const{isSynced:r}=e,i=r?"Unsync all views":"Sync all views to this time range";return(0,t.jsx)(t.Fragment,{children:i})};return(0,t.jsx)(xe.m,{content:o,placement:"bottom",children:(0,t.jsx)(ue.I,{icon:"link",variant:n?"active":"canvas","aria-label":n?"Synced times":"Unsynced times",onClick:s})})}class Lr extends u.Component{constructor(){super(...arguments),this.onMoveTimePicker=s=>{const{range:n,onChangeTime:o,timeZone:r}=this.props,{from:i,to:a}=(0,yn.Wb)(s,n),l={from:(0,Ue.oZ)(r,i),to:(0,Ue.oZ)(r,a)};o(l)},this.onMoveForward=()=>this.onMoveTimePicker(1),this.onMoveBack=()=>this.onMoveTimePicker(-1),this.onChangeTimePicker=s=>{const n=mn.isMathString(s.raw.from)?s.raw.from:s.from,o=mn.isMathString(s.raw.to)?s.raw.to:s.to;this.props.onChangeTime({from:n,to:o}),(0,D.rR)("grafana_explore_time_picker_time_range_changed",{timeRangeFrom:n,timeRangeTo:o})},this.onZoom=()=>{const{range:s,onChangeTime:n,timeZone:o}=this.props,{from:r,to:i}=(0,yn.Zk)(s,2),a={from:(0,Ue.oZ)(o,r),to:(0,Ue.oZ)(o,i)};n(a)}}render(){const{range:s,timeZone:n,fiscalYearStartMonth:o,splitted:r,syncedTimes:i,onChangeTimeSync:a,hideText:l,onChangeTimeZone:d,onChangeFiscalYearStartMonth:f}=this.props,c=r?(0,t.jsx)(wr,{onClick:a,isSynced:i}):void 0,g={value:s,timeZone:n,fiscalYearStartMonth:o,onMoveBackward:this.onMoveBack,onMoveForward:this.onMoveForward,onZoom:this.onZoom,hideText:l};return(0,t.jsx)(Tr.m,{isOnCanvas:!0,...g,timeSyncButton:c,isSynced:i,widthOverride:r?window.innerWidth/2:void 0,onChange:this.onChangeTimePicker,onChangeTimeZone:d,onChangeFiscalYearStartMonth:f})}}var xn=p(86634);function Ir(e){const s=(0,u.useRef)(null),{start:n,pause:o,resume:r,isLive:i,isPaused:a,stop:l,splitted:d}=e,f=i&&!a?"active":"canvas",c=i?a?r:o:n;return(0,t.jsxs)(vs.e,{children:[(0,t.jsx)(xe.m,{content:i&&!a?(0,t.jsx)(t.Fragment,{children:"Pause the live stream"}):(0,t.jsx)(t.Fragment,{children:"Start live stream your logs"}),placement:"bottom",children:(0,t.jsx)(ue.I,{iconOnly:d,variant:f,icon:!i||a?"play":"pause",onClick:c,children:i&&a?"Paused":"Live"})}),(0,t.jsx)(xn.A,{mountOnEnter:!0,unmountOnExit:!0,timeout:100,in:i,classNames:{enter:Yt.stopButtonEnter,enterActive:Yt.stopButtonEnterActive,exit:Yt.stopButtonExit,exitActive:Yt.stopButtonExitActive},nodeRef:s,children:(0,t.jsx)(xe.m,{content:(0,t.jsx)(t.Fragment,{children:"Stop and exit the live stream"}),placement:"bottom",children:(0,t.jsx)(ue.I,{ref:s,variant:f,onClick:l,icon:"square-shape"})})})]})}const Yt={stopButtonEnter:(0,h.css)({label:"stopButtonEnter",width:0,opacity:0,overflow:"hidden"}),stopButtonEnterActive:(0,h.css)({label:"stopButtonEnterActive",opacity:1,width:"32px"}),stopButtonExit:(0,h.css)({label:"stopButtonExit",width:"32px",opacity:1,overflow:"hidden"}),stopButtonExitActive:(0,h.css)({label:"stopButtonExitActive",opacity:0,width:0})};var Oe=p(38138),xt=p(83122);const Ge="query_library_explore_clicked";function Cs(e){(0,D.rR)(Ge,{item:"query_library_toggle",type:e?"open":"close"})}function Er(e){(0,D.rR)(Ge,{item:"add_query_from_query_history",type:e})}function Or(){(0,D.rR)(Ge,{item:"add_query_modal_from_query_history",type:"open"})}function Fr(e){(0,D.rR)(Ge,{item:"add_query_from_query_row",type:e})}function Dr(){(0,D.rR)(Ge,{item:"delete_query"})}function Ar(e){(0,D.rR)(Ge,{item:"run_query",type:e})}function Nr(){(0,D.rR)(Ge,{item:"add_or_edit_description"})}function vn(){(0,D.rR)(Ge,{item:"filter_datasource"})}var ke=(e=>(e.QueryLibrary="Query library",e.RichHistory="Query history",e.Starred="Starred",e.Settings="Settings",e))(ke||{});const bn=(0,u.createContext)({selectedTab:void 0,setSelectedTab:()=>{},queryLibraryAvailable:!1,drawerOpened:!1,setDrawerOpened:()=>{}});function at(){return(0,u.useContext)(bn)}function kr({children:e}){const s=U.$.featureToggles.queryLibrary===!0,[n,o]=(0,u.useState)(s?"Query library":void 0),[r,i]=(0,u.useState)(!1),a=(0,A.useSelector)(_.i6);return(0,u.useEffect)(()=>{a&&!s&&o(a.starredTabAsFirstTab?"Starred":"Query history")},[a,o,s]),(0,t.jsx)(bn.Provider,{value:{queryLibraryAvailable:s,selectedTab:n,setSelectedTab:o,drawerOpened:r,setDrawerOpened:i},children:e})}const Zt={queryLibrary:(0,j.t)("explore.rich-history.query-library","Query library"),queryHistory:(0,j.t)("explore.rich-history.query-history","Query history")};function Pr({variant:e}){const{selectedTab:s,setSelectedTab:n,queryLibraryAvailable:o,drawerOpened:r,setDrawerOpened:i}=at(),a=(0,k.of)(Mr);if(!o)return;function l(f){f===ke.QueryLibrary&&Cs(!r),n(f),i(!1),i(!0)}const d=(0,t.jsxs)(Oe.W,{children:[(0,t.jsx)(Oe.W.Item,{label:Zt.queryLibrary,onClick:()=>l(ke.QueryLibrary)}),(0,t.jsx)(Oe.W.Item,{label:Zt.queryHistory,onClick:()=>l(ke.RichHistory)})]});return(0,t.jsxs)(vs.e,{children:[(0,t.jsx)(ue.I,{icon:"book",variant:r?"active":"canvas",onClick:()=>{i(!r),s===ke.QueryLibrary&&Cs(!r)},"aria-label":s,children:e==="full"?s:void 0}),r?(0,t.jsx)(Q.$n,{className:a.close,variant:"secondary",icon:"times",onClick:()=>{i(!1),s===ke.QueryLibrary&&Cs(!1)}}):(0,t.jsx)(xt.m,{overlay:d,children:(0,t.jsx)(ue.I,{className:a.toggle,variant:"canvas",icon:"angle-down"})})]})}const Mr=()=>({toggle:(0,h.css)({width:"36px"}),close:(0,h.css)({width:"36px","> svg":{position:"relative",left:2}})});var $r=p(59093),zr=p(15068),js=p(7030),et=p(96192);const Br={key:"copy-link",label:(0,j.t)("explore.toolbar.copy-shortened-link","Copy shortened URL"),icon:"share-alt",getUrl:()=>{},shorten:!0,absTime:!1};function Sn(){const e=(0,A.useSelector)(_.Qb),[s,n]=(0,u.useState)(!1),[o,r]=(0,u.useState)(Br),i=(d,f,c)=>{d?((0,js.VP)(c||p.g.location.href),(0,D.rR)("grafana_explore_shortened_link_clicked",{isAbsoluteTime:f})):((0,ht.uJ)(c!==void 0?`${window.location.protocol}//${window.location.host}${U.$.appSubUrl}${c}`:p.g.location.href),(0,D.rR)("grafana_explore_copy_link_clicked",{isAbsoluteTime:f}))},a=[{key:"normal",label:(0,j.t)("explore.toolbar.copy-links-normal-category","Normal URL links"),items:[{key:"copy-shortened-link",icon:"link",label:(0,j.t)("explore.toolbar.copy-shortened-link","Copy shortened URL"),getUrl:()=>{},shorten:!0,absTime:!1},{key:"copy-link",icon:"link",label:(0,j.t)("explore.toolbar.copy-link","Copy URL"),getUrl:()=>{},shorten:!1,absTime:!1}]},{key:"timesync",label:(0,j.t)("explore.toolbar.copy-links-absolute-category","Time-sync URL links (share with time range intact)"),items:[{key:"copy-short-link-abs-time",icon:"clock-nine",label:(0,j.t)("explore.toolbar.copy-shortened-link-abs-time","Copy absolute shortened URL"),shorten:!0,getUrl:()=>(0,et._O)(e),absTime:!0},{key:"copy-link-abs-time",icon:"clock-nine",label:(0,j.t)("explore.toolbar.copy-link-abs-time","Copy absolute URL"),shorten:!1,getUrl:()=>(0,et._O)(e),absTime:!0}]}],l=(0,t.jsx)(Oe.W,{children:a.map(d=>(0,t.jsx)($r.r,{label:d.label,children:d.items.map(f=>(0,t.jsx)(Oe.W.Item,{label:f.label,icon:f.icon,onClick:()=>{const c=f.getUrl();i(f.shorten,f.absTime,c),r(f)}},f.key))},d.key))});return(0,t.jsx)(zr.U,{children:(0,t.jsxs)(je.B,{gap:0,direction:"row",alignItems:"center",wrap:"nowrap",children:[(0,t.jsx)(ue.I,{tooltip:o.label,icon:o.icon,iconOnly:!0,narrow:!0,onClick:()=>{const d=o.getUrl();i(o.shorten,o.absTime,d)},"aria-label":(0,j.t)("explore.toolbar.copy-shortened-link","Copy shortened URL")}),(0,t.jsx)(xt.m,{overlay:l,placement:"bottom-end",onVisibleChange:n,children:(0,t.jsx)(ue.I,{narrow:!0,isOpen:s,"aria-label":(0,j.t)("explore.toolbar.copy-shortened-link-menu","Open copy link options")})})]})})}var Hr=p(74135),Qr=p(71798),Wr=p(24401),Vr=p(30973);const qr=(0,u.lazy)(()=>p.e(4787).then(p.bind(p,74787)).then(({AddToDashboard:e})=>({default:e})));function Ur(e){const{exploreId:s}=e,[n,o]=(0,u.useState)(),[r,i]=(0,u.useState)(!1),a=Gr(e),{links:l}=(0,Qr.U)({extensionPointId:Hr.S.ExploreToolbarAction,context:a,limitPerPlugin:3}),d=(0,_.qq)(s),f=(0,A.useSelector)(d)?.queries?.length;if(l.length<=1)return At.TP.hasPermission(A.AccessControlAction.DashboardsCreate)||At.TP.hasPermission(A.AccessControlAction.DashboardsWrite)?(0,t.jsx)(u.Suspense,{fallback:null,children:(0,t.jsx)(qr,{exploreId:s})}):null;const c=(0,t.jsx)(Vr.w,{extensions:l,onSelect:o});return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(xt.m,{onVisibleChange:i,placement:"bottom-start",overlay:c,children:(0,t.jsx)(ue.I,{"aria-label":"Add",disabled:!f,variant:"canvas",isOpen:r,children:"Add"})}),!!n&&!!n.path&&(0,t.jsx)(Wr.s,{path:n.path,title:n.title,onDismiss:()=>o(void 0)})]})}function Gr(e){const{exploreId:s,timeZone:n}=e,r=(0,A.useSelector)(_.vC)?.editorMode||!1,{queries:i,queryResponse:a,range:l}=(0,A.useSelector)((0,_.qq)(s)),d=(0,A.useSelector)((0,_.Jr)(s)),f=i.map(m=>m?.datasource?.uid).filter(m=>m!==void 0),c=[...new Set(f)].length,g=At.TP.hasPermission(A.AccessControlAction.DataSourcesWrite);return(0,u.useMemo)(()=>({exploreId:s,targets:i,data:a,timeRange:l.raw,timeZone:(0,rn.O)({timeZone:n}),shouldShowAddCorrelation:U.$.featureToggles.correlations===!0&&g&&!r&&d&&c===1}),[s,i,a,l.raw,n,g,r,d,c])}var we=p(89224);function Kr(e){const s=(0,A.useDispatch)(),n=(0,u.useCallback)(()=>{s((0,Z.qk)({exploreId:e,isPaused:!0}))},[e,s]),o=(0,u.useCallback)(()=>{s((0,Z.qk)({exploreId:e,isPaused:!1}))},[e,s]),r=(0,u.useCallback)(()=>{n(),s((0,we.hO)({exploreId:e,refreshInterval:Kt.cC.offOption.value})),s((0,Z.Od)({exploreId:e}))},[e,s,n]),i=(0,u.useCallback)(()=>{s((0,we.hO)({exploreId:e,refreshInterval:Kt.cC.liveOption.value}))},[e,s]),a=(0,u.useCallback)(()=>{s((0,Z.rR)({exploreId:e}))},[e,s]);return{pause:n,resume:o,stop:r,start:i,clear:a}}function Cn(e){const s=Kr(e.exploreId);return e.children(s)}const Yr=(e,s)=>({rotateIcon:(0,h.css)({"> div > svg":{transform:"rotate(180deg)"}}),toolbarButton:(0,h.css)({display:"flex",justifyContent:"center",marginRight:e.spacing(.5),width:s&&e.spacing(6)})});function Zr({exploreId:e,onChangeTime:s,onContentOutlineToogle:n,isContentOutlineOpen:o}){const r=(0,Te.wA)(),i=(0,Te.d4)(_.pF),a=(0,k.of)(Yr,i),l=(0,Te.d4)(M=>(0,Qt.O)(M.user)),d=(0,Te.d4)(M=>(0,Qt.q)(M.user)),{refreshInterval:f,datasourceInstance:c,range:g,isLive:m,isPaused:y,syncedTimes:C}=(0,Te.d4)(M=>({...(0,ie.pick)(M.explore.panes[e],"refreshInterval","datasourceInstance","range","isLive","isPaused"),syncedTimes:M.explore.syncedTimes}),Ie.shallowEqual),x=(0,Te.d4)((0,Z.h1)(e)),b=(0,Te.d4)(M=>M.explore.largerExploreId===e),S=(0,Te.d4)(M=>i||M.explore.panes[e].containerWidth<1210),w=(0,Te.d4)(M=>M.explore.panes[e].containerWidth<(i?700:800)),R=(0,Te.d4)(_.K6),v=(0,Te.d4)(_.vC),L=v?.editorMode||!1,T=(0,Te.d4)((0,_.Jr)(e)),F=U.$.featureToggles.singleTopNav,N=(0,u.useMemo)(()=>T&&b||!T&&!b,[T,b]),P=x?(0,j.t)("explore.toolbar.refresh-picker-cancel","Cancel"):(0,j.t)("explore.toolbar.refresh-picker-run","Run query"),H=async M=>{L?v?.correlationDirty||v?.queryEditorDirty?r((0,J.am)({isExiting:!0,postConfirmAction:{exploreId:e,action:bs.IW.CHANGE_DATASOURCE,changeDatasourceUid:M.uid,isActionLeft:T}})):(T&&R.forEach(W=>{r((0,He.nE)({exploreId:W[0],correlationEditorHelperData:void 0}))}),r((0,Xe.wh)({exploreId:e,datasource:M.uid,options:{importQueries:!0}}))):r((0,Xe.wh)({exploreId:e,datasource:M.uid,options:{importQueries:!0}}))},E=(M=!1)=>r(M?(0,Z.hS)(e):(0,Z.Od)({exploreId:e})),q=M=>r((0,fn.Cj)(M)),X=()=>{r((0,J.ve)()),(0,D.rR)("grafana_explore_split_view_opened",{origin:"menu"})},oe=()=>{L?v?.correlationDirty||v?.queryEditorDirty?r((0,J.am)({isExiting:!0,postConfirmAction:{exploreId:e,action:bs.IW.CLOSE_PANE,isActionLeft:T}})):(R.forEach(M=>{r((0,He.nE)({exploreId:M[0],correlationEditorHelperData:void 0}))}),r((0,J.J8)(e)),(0,D.rR)("grafana_explore_split_view_closed")):(r((0,J.J8)(e)),(0,D.rR)("grafana_explore_split_view_closed"))},he=()=>{r(b?(0,J.JA)():(0,J.tP)({exploreId:e}))},O=()=>{r((0,we.iO)(e))},z=M=>r((0,fn.c1)(M)),B=M=>{r((0,we.hO)({exploreId:e,refreshInterval:M}))},G=[(0,t.jsx)(Sn,{},"share"),(0,t.jsx)("div",{style:{flex:1}},"spacer0")];return(0,t.jsxs)("div",{children:[f&&(0,t.jsx)(Sr.u,{func:E,interval:f,loading:x}),!F&&(0,t.jsx)("div",{children:(0,t.jsx)(jr.H,{actions:G})}),(0,t.jsx)(Cr.d,{"aria-label":(0,j.t)("explore.toolbar.aria-label","Explore toolbar"),leftItems:[(0,t.jsx)(ue.I,{variant:"canvas",tooltip:"Content outline",icon:"list-ui-alt",iconOnly:i,onClick:n,"aria-expanded":o,"aria-controls":o?"content-outline-container":void 0,className:a.toolbarButton,children:"Outline"},"content-outline"),(0,t.jsx)(Rr.s,{mixed:!L,onChange:H,current:c?.getRef(),hideTextValue:w,width:w?8:void 0},`${e}-ds-picker`),F&&(0,t.jsx)(Sn,{},"share")].filter(Boolean),forceShowLeftItems:!0,children:[(0,t.jsx)(Pr,{variant:i?"compact":"full"},"queryLibrary"),i?(0,t.jsxs)(vs.e,{children:[(0,t.jsx)(ue.I,{variant:"canvas",tooltip:b?(0,j.t)("explore.toolbar.split-narrow","Narrow pane"):(0,j.t)("explore.toolbar.split-widen","Widen pane"),onClick:he,icon:b?"gf-movepane-left":"gf-movepane-right",iconOnly:!0,className:(0,h.cx)(N&&a.rotateIcon)}),(0,t.jsx)(ue.I,{tooltip:(0,j.t)("explore.toolbar.split-close-tooltip","Close split pane"),onClick:oe,icon:"times",variant:"canvas",children:(0,t.jsx)(j.x6,{i18nKey:"explore.toolbar.split-close",children:" Close "})})]},"split-controls"):(0,t.jsx)(ue.I,{variant:"canvas",tooltip:(0,j.t)("explore.toolbar.split-tooltip","Split the pane"),onClick:X,icon:"columns",disabled:m,children:(0,t.jsx)(j.x6,{i18nKey:"explore.toolbar.split-title",children:"Split"})},"split"),(0,t.jsx)(Ur,{exploreId:e,timeZone:l},"toolbar-extension-point"),!m&&(0,t.jsx)(Lr,{exploreId:e,range:g,timeZone:l,fiscalYearStartMonth:d,onChangeTime:s,splitted:i,syncedTimes:C,onChangeTimeSync:O,hideText:S,onChangeTimeZone:q,onChangeFiscalYearStartMonth:z},"timeControls"),(0,t.jsx)(Kt.cC,{onIntervalChanged:B,value:f,isLoading:x,text:S?void 0:P,tooltip:S?P:void 0,intervals:Ss.TP.getValidIntervals(Kt.cb),isLive:m,onRefresh:()=>E(x),noIntervalPicker:m,primary:!0,width:(S?35:108)+"px"},"refreshPicker"),c?.meta.streaming&&(0,t.jsx)(Cn,{exploreId:e,children:M=>{const W={...M,start:()=>{(0,D.rR)("grafana_explore_logs_live_tailing_clicked",{datasourceType:c?.type}),M.start()}};return(0,t.jsx)(Ir,{splitted:i,isLive:m,isPaused:y,start:W.start,pause:W.pause,resume:W.resume,stop:W.stop})}},"liveControls")].filter(Boolean)})]})}var Jr=p(85194);function Jt(e,s={}){(0,D.rR)(`grafana_flamegraph_${e}`,{app:ge.Jk.Unknown,grafana_version:U.$.buildInfo.version,...s})}const Xr=e=>{const s=(0,k.of)(n=>_r(n));return(0,t.jsx)("div",{className:s.container,children:(0,t.jsx)(Jr.A,{data:e.dataFrames[0],stickyHeader:!0,getTheme:()=>U.$.theme2,onTableSymbolClick:()=>Jt("table_item_selected"),onViewSelected:n=>Jt("view_selected",{view:n}),onTextAlignSelected:n=>Jt("text_align_selected",{align:n}),onTableSort:n=>Jt("table_sort_selected",{sort:n})})})},_r=e=>({container:(0,h.css)({background:e.colors.background.primary,display:"flow-root",padding:e.spacing(0,1,1,1),border:`1px solid ${e.components.panel.borderColor}`,borderRadius:e.shape.radius.default})});var ei=p(72519),jn=p(84140),Y=p(52622),Rs=p(72724),ti=p(85492),si=p(77020),Pe=p(91002),ni=p(10940),oi=p(97814);const Rn=150,ri=({resetKey:e,humanize:s,className:n})=>{const[o,r]=(0,u.useState)(0);return(0,ni.A)(()=>r(o+Rn),Rn),(0,u.useEffect)(()=>r(0),[e]),(0,t.jsx)(oi.g,{timeInMs:o,className:n,humanize:s})};var ii=p(34028);const ai=e=>({logsRowsLive:(0,h.css)`
    label: logs-rows-live;
    font-family: ${e.typography.fontFamilyMonospace};
    font-size: ${e.typography.bodySmall.fontSize};
    display: flex;
    flex-flow: column nowrap;
    height: 60vh;
    overflow-y: scroll;
    :first-child {
      margin-top: auto !important;
    }
  `,logsRowFade:(0,h.css)`
    label: logs-row-fresh;
    color: ${e.colors.text};
    background-color: ${(0,jn.A)(e.colors.info.transparent).setAlpha(.25).toString()};
    animation: fade 1s ease-out 1s 1 normal forwards;
    @keyframes fade {
      from {
        background-color: ${(0,jn.A)(e.colors.info.transparent).setAlpha(.25).toString()};
      }
      to {
        background-color: transparent;
      }
    }
  `,logsRowsIndicator:(0,h.css)`
    font-size: ${e.typography.h6.fontSize};
    padding-top: ${e.spacing(1)};
    display: flex;
    align-items: center;
  `,button:(0,h.css)`
    margin-right: ${e.spacing(1)};
  `,fullWidth:(0,h.css)`
    width: 100%;
  `});class li extends u.PureComponent{constructor(s){super(s),this.liveEndDiv=null,this.scrollContainerRef=u.createRef(),this.onScroll=n=>{const{isPaused:o,onPause:r}=this.props,{scrollTop:i,clientHeight:a,scrollHeight:l}=n.currentTarget;l-(i+a)>=5&&!o&&r()},this.rowsToRender=()=>{const{isPaused:n}=this.props;let{logRowsToRender:o=[]}=this.state;return n||(o=(0,Pe.oR)(o,Y.uH.Ascending).slice(-100)),o},this.state={logRowsToRender:s.logRows}}static getDerivedStateFromProps(s,n){return s.isPaused&&s.clearedAtIndex?{logRowsToRender:(0,ii.pg)(s.clearedAtIndex,n.logRowsToRender)}:s.isPaused?null:{logRowsToRender:s.logRows}}render(){const{theme:s,timeZone:n,onPause:o,onResume:r,onClear:i,isPaused:a}=this.props,l=ai(s),{logsRow:d,logsRowLocalTime:f,logsRowMessage:c}=(0,si.D)(s);return(0,t.jsxs)("div",{children:[(0,t.jsx)("table",{className:l.fullWidth,children:(0,t.jsxs)("tbody",{onScroll:a?void 0:this.onScroll,className:l.logsRowsLive,ref:this.scrollContainerRef,children:[this.rowsToRender().map(g=>(0,t.jsxs)("tr",{className:(0,h.cx)(d,l.logsRowFade),children:[(0,t.jsx)("td",{className:f,children:(0,Rs.LE)(g.timeEpochMs,{timeZone:n})}),(0,t.jsx)("td",{className:c,children:g.hasAnsi?(0,t.jsx)(ti.$,{value:g.raw}):g.entry})]},g.uid)),(0,t.jsx)("tr",{ref:g=>{this.liveEndDiv=g,this.liveEndDiv&&this.scrollContainerRef.current?.scrollTo&&!a&&this.scrollContainerRef.current?.scrollTo(0,this.scrollContainerRef.current.scrollHeight)}})]})}),(0,t.jsxs)("div",{className:l.logsRowsIndicator,children:[(0,t.jsx)(Q.$n,{icon:a?"play":"pause",variant:"secondary",onClick:a?r:o,className:l.button,children:a?"Resume":"Pause"}),(0,t.jsx)(Q.$n,{icon:"trash-alt",variant:"secondary",onClick:i,className:l.button,children:"Clear logs"}),(0,t.jsx)(Q.$n,{icon:"square-shape",variant:"secondary",onClick:this.props.stopLive,className:l.button,children:"Exit live mode"}),a||this.rowsToRender().length>0&&(0,t.jsxs)("span",{children:["Last line received: ",(0,t.jsx)(ri,{resetKey:this.props.logRows,humanize:!0})," ago"]})]})]})}}const ci=(0,k.cV)(li);var vt=p(41811),di=p(84596),bt=p(65879),Tn=p(69129),wn=p(76885),St=p(94354),ui=p(39268),Me=p(14186),Ke=p(15292),pi=p(44895),fe=p(33390),Ln=p(81073);const hi=({app:e,children:s,loading:n,loadMoreLogs:o,range:r,rows:i,scrollElement:a,sortOrder:l,timeZone:d,topScrollEnabled:f=!1})=>{const[c,g]=(0,u.useState)(!1),[m,y]=(0,u.useState)(!1),[C,x]=(0,u.useState)(!1),[b,S]=(0,u.useState)(!1),w=(0,u.useRef)(i),R=(0,u.useRef)(a?.scrollTop||0);(0,u.useEffect)(()=>{g(!1),y(!1)},[r,i,l]),(0,u.useEffect)(()=>{n||(x(!1),S(!1))},[n]),(0,u.useEffect)(()=>{b&&a&&a.scrollTo(0,a.scrollHeight-a.clientHeight)},[b,a]),(0,u.useEffect)(()=>{i!==w.current&&i.length===w.current.length&&(C||b)&&(l===Y.uH.Descending&&b?y(!0):l===Y.uH.Ascending&&C&&g(!0)),w.current=i},[b,i,l,C]),(0,u.useEffect)(()=>{if(!a||!o)return;function F(H){if(!a||!o||!i.length||n||!U.$.featureToggles.logsInfiniteScrolling)return;H.stopImmediatePropagation();const E=fi(H,a,R.current);R.current=a.scrollTop,E!==0&&(E===-1&&f?N():E===1&&P())}function N(){const H=Fn(ws(i),r,d,l);if(!H){g(!0);return}g(!1),o?.(H),x(!0),(0,D.rR)("grafana_logs_infinite_scrolling",{direction:"top",sort_order:l})}function P(){const H=mi(ws(i),r,d,l);if(!H){y(!0);return}y(!1),o?.(H),S(!0),(0,D.rR)("grafana_logs_infinite_scrolling",{direction:"bottom",sort_order:l})}return a.addEventListener("scroll",F),a.addEventListener("wheel",F),()=>{a.removeEventListener("scroll",F),a.removeEventListener("wheel",F)}},[o,n,r,i,a,l,d,f]);const v=l===Y.uH.Descending&&(0,bt.isRelativeTime)(r.raw.to),L=l===Y.uH.Ascending&&(0,bt.isRelativeTime)(r.raw.to),T=(0,u.useCallback)(()=>{(0,D.rR)("grafana_explore_logs_infinite_pagination_clicked",{pageType:"olderLogsButton"});const F=Fn(ws(i),r,d,l);if(!F){g(!0);return}g(!1),o?.(F),x(!0),a?.scroll({behavior:"auto",top:0})},[o,r,i,a,l,d]);return(0,t.jsxs)(t.Fragment,{children:[C&&(0,t.jsx)(Ln.I,{adjective:l===Y.uH.Descending?"newer":"older"}),!v&&c&&In,l===Y.uH.Ascending&&e===ge.Jk.Explore&&(0,t.jsx)(Q.$n,{className:Ts.navButton,variant:"secondary",onClick:T,disabled:n,children:(0,t.jsxs)("div",{className:Ts.navButtonContent,children:[(0,t.jsx)(de.I,{name:"angle-up",size:"lg"}),(0,t.jsx)(j.x6,{i18nKey:"logs.infinite-scroll.older-logs",children:"Older logs"})]})}),s,!L&&m&&In,b&&(0,t.jsx)(Ln.I,{adjective:l===Y.uH.Descending?"older":"newer"})]})},Ts={messageContainer:(0,h.css)({textAlign:"center",padding:.25}),navButton:(0,h.css)({width:"58px",height:"68px",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",lineHeight:"1",position:"absolute",top:0,right:-3,zIndex:1}),navButtonContent:(0,h.css)({display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",whiteSpace:"normal"})},In=(0,t.jsx)("div",{className:Ts.messageContainer,"data-testid":"end-of-range",children:"End of the selected time range."});var gi=(e=>(e[e.Top=-1]="Top",e[e.Bottom=1]="Bottom",e[e.NoScroll=0]="NoScroll",e))(gi||{});function fi(e,s,n){if(s.scrollHeight<=s.clientHeight)return 0;const o=e instanceof WheelEvent?e.deltaY:s.scrollTop-n;if(o===0)return 0;const r=o<0?-1:1;return(r===-1?s.scrollTop:s.scrollHeight-s.scrollTop-s.clientHeight)<=1?r:0}function ws(e){const s=e[0].timeEpochMs,n=e[e.length-1].timeEpochMs;return n<s?{from:n,to:s}:{from:s,to:n}}function En(e,s){return{from:s.from.valueOf(),to:e.from}}function On(e,s,n){return s=Ls(s,n),{from:e.to,to:s.to.valueOf()}}const Xt=1e3;function Fn(e,s,n,o){return o===Y.uH.Descending?(s=Ls(s,n),s.to.valueOf()-e.to>Xt?On(e,s,n):void 0):Math.abs(s.from.valueOf()-e.from)>Xt?En(e,s):void 0}function mi(e,s,n,o){return o===Y.uH.Descending?Math.abs(s.from.valueOf()-e.from)>Xt?En(e,s):void 0:(s=Ls(s,n),s.to.valueOf()-e.to>Xt?On(e,s,n):void 0)}function Ls(e,s){return(0,bt.isRelativeTimeRange)(e.raw)?(0,bt.convertRawToRange)(e.raw,s):e}var Dn=p(14647),yi=p(81166),lt=p(69147),ct=p(99140);function xi(){(0,D.rR)("explore_toolbar_contentoutline_clicked",{item:"section",type:"Logs:pinned:pinned-log-added"})}function vi(){(0,D.rR)("explore_toolbar_contentoutline_clicked",{item:"section",type:"Logs:pinned:pinned-log-deleted"})}function bi(){(0,D.rR)("explore_toolbar_contentoutline_clicked",{item:"section",type:"Logs:pinned:pinned-log-limit-reached"})}function Si(){(0,D.rR)("explore_toolbar_contentoutline_clicked",{item:"section",type:"Logs:pinned:pinned-log-clicked"})}function Ci(){(0,D.rR)("explore_toolbar_contentoutline_clicked",{item:"section",type:"Logs:pinned:pinned-log-deleted"})}function ji(e){(0,D.rR)("explore_toolbar_contentoutline_clicked",{item:"section",type:`Logs:filter:${e.levelStr}`})}var An=p(39590);function Ri({feedbackUrl:e}){const s=(0,k.of)(Ti);return(0,t.jsx)(je.B,{children:(0,t.jsxs)("a",{href:e,className:s.link,title:"The logs table is new, please let us know how we can improve it",target:"_blank",rel:"noreferrer noopener",children:[(0,t.jsx)(de.I,{name:"comment-alt-message"})," Give feedback"]})})}function Ti(e){return{link:(0,h.css)({color:e.colors.text.secondary,fontSize:e.typography.bodySmall.fontSize,":hover":{color:e.colors.text.link}})}}var wi=p(4213),Li=p.n(wi),Nn=p(75505),kn=p(2514),Pn=p(18358),Mn=p(93463),Ii=p(40455);const $n=e=>({metaContainer:(0,h.css)({flex:1,color:e.colors.text.secondary,marginBottom:e.spacing(2),minWidth:"30%",display:"flex",flexWrap:"wrap"}),metaItem:(0,h.css)({marginRight:e.spacing(2),marginTop:e.spacing(.5),display:"flex",alignItems:"center",".logs-meta-item__error":{color:e.colors.error.text}}),metaLabel:(0,h.css)({marginRight:`calc(${e.spacing(2)} / 2)`,fontSize:e.typography.bodySmall.fontSize,fontWeight:e.typography.fontWeightMedium}),metaValue:(0,h.css)({fontFamily:e.typography.fontFamilyMonospace,fontSize:e.typography.bodySmall.fontSize})}),Ei=(0,u.memo)(function(s){const n=(0,k.of)($n),{label:o,value:r}=s;return(0,t.jsxs)("div",{"data-testid":"meta-info-text-item",className:n.metaItem,children:[o&&(0,t.jsxs)("span",{className:n.metaLabel,children:[o,":"]}),(0,t.jsx)("span",{className:n.metaValue,children:r})]})}),Is=(0,u.memo)(function(s){const n=(0,k.of)($n),{metaItems:o}=s;return(0,t.jsx)("div",{className:n.metaContainer,"data-testid":"meta-info-text",children:o.map((r,i)=>(0,t.jsx)(Ei,{label:r.label,value:r.value},`${i}-${r.label}`))})});var zn=p(14236),_t=p(90708),Ct=p(11261),Bn=p(41260),Es=p(77093);function Oi(e){const{timeZone:s,splitOpen:n,range:o,logsSortOrder:r,width:i,dataFrame:a,columnsWithMeta:l,logsFrame:d}=e,[f,c]=(0,u.useState)(void 0),g=d?.timeField.index,m=(0,u.useCallback)(C=>{if(!C.length)return C;const x=(0,zn.ES)(C,g,r===Y.uH.Descending),[b]=(0,_t.we)({data:[x],timeZone:s,theme:U.$.theme2,replaceVariables:S=>S,fieldConfig:{defaults:{custom:{}},overrides:[]}});for(const S of b.fields)S.getLinks=w=>(0,et.QL)({field:S,rowIndex:w.valueRowIndex,splitOpenFn:n,range:o,dataFrame:x}),S.config={...S.config,custom:{inspect:!0,filterable:!0,width:Ni(S),...S.config.custom},filterable:Fi(S,d?.bodyField.name??"",d?.timeField.name??"")},S.type=S.type===Ct.PU.string?(0,zn.dF)(S)??Ct.PU.string:S.type;return b},[r,s,n,o,d?.bodyField.name,d?.timeField.name,g]);if((0,u.useEffect)(()=>{(async()=>{if(!d?.timeField.name||!d?.bodyField.name){c(void 0);return}const x=Hn(a);let b=Di(l);const S=Ai(b);if(S?x.push(S):x.push({id:"organize",options:{indexByName:{[d.bodyField.name]:0,[d.timeField.name]:1},includeByName:{[d.bodyField.name]:!0,[d.timeField.name]:!0}}}),x.length>0){const w=await(0,Nn.s)((0,kn.m)(x,[a])),R=m(w[0]);c(R)}else c(m(a))})()},[l,a,r,m,d?.bodyField.name,d?.timeField.name]),!f)return null;const y=C=>{const{value:x,key:b,operator:S}=C,{onClickFilterLabel:w,onClickFilterOutLabel:R}=e;!w||!R||(S===Ht.mc&&w(b,x,a),S===Ht.Zi&&R(b,x,a))};return(0,t.jsx)(Es.X,{data:f,width:i,onCellFilterAdded:e.onClickFilterLabel&&e.onClickFilterOutLabel?y:void 0,height:e.height,footerOptions:{show:!0,reducer:["count"],countRows:!0},initialSortBy:[{displayName:d?.timeField.name||"",desc:r===Y.uH.Descending}]})}const Fi=(e,s,n)=>!(!s||!n||s===e.name||n===e.name||e.config.links?.length);function Hn(e){return e.fields.filter(s=>{const n=s.typeInfo?.frame==="json.RawMessage"&&s.name==="labels"&&e?.meta?.type!==Bn.m.LogLines,o=s.name==="labels"&&s.type===Ct.PU.other&&e?.meta?.type===Bn.m.LogLines;return n||o}).flatMap(s=>[{id:"extractFields",options:{format:"json",keepTime:!1,replace:!1,source:s.name}}])}function Di(e){let s={};return Object.keys(e).filter(n=>e[n].active).forEach(n=>{const o=e[n].index;o!==void 0&&(s[n]=o)}),s}function Ai(e){let s={};for(const n in e)s[n]=!0;return Object.keys(e).length>0?{id:"organize",options:{indexByName:e,includeByName:s}}:null}function Ni(e){if(e.type===Ct.PU.time)return 200}const ki=()=>({metaContainer:(0,h.css)`
    flex: 1;
    display: flex;
    flex-wrap: wrap;
  `});var Pi=(e=>(e.Text="text",e.Json="json",e.CSV="csv",e))(Pi||{});const Qn=(0,u.memo)(({meta:e,dedupStrategy:s,dedupCount:n,displayedFields:o,clearDetectedFields:r,hasUnescapedContent:i,forceEscape:a,onEscapeNewlines:l,logRows:d})=>{const f=(0,k.of)(ki),c=async y=>{switch((0,D.rR)("grafana_logs_download_logs_clicked",{app:ge.Jk.Explore,format:y,area:"logs-meta-row"}),y){case"text":(0,Pn.Zy)({meta:e,rows:d},"Explore");break;case"json":const C=(0,Pe.Dg)(d),x=new Blob([JSON.stringify(C)],{type:"application/json;charset=utf-8"}),b=`Explore-logs-${(0,Rs.LE)(new Date)}.json`;Li()(x,b);break;case"csv":const S=new Map;d.forEach(w=>{w.dataFrame?.refId&&!S.has(w.dataFrame?.refId)&&S.set(w.dataFrame?.refId,w.dataFrame)}),S.forEach(async w=>{const R=Hn(w);R.push({id:"organize",options:{excludeByName:{labels:!0,labelTypes:!0}}});const v=await(0,Nn.s)((0,kn.m)(R,[w]));(0,Pn.EM)(v[0],`Explore-logs-${w.refId}`)})}},g=[...e];s!==Y.fY.none&&g.push({label:"Deduplication count",value:n,kind:ne.tG.Number}),d.some(y=>y.entry.length>Ii.S)&&g.push({label:"Info",value:"Logs with more than 100,000 characters could not be parsed and highlighted",kind:ne.tG.String}),o?.length>0&&g.push({label:"Showing only selected fields",value:(0,t.jsx)(Mn.A,{labels:o})},{label:"",value:(0,t.jsx)(Q.$n,{variant:"secondary",size:"sm",onClick:r,children:"Show original line"})}),i&&g.push({label:"Your logs might have incorrectly escaped content",value:(0,t.jsx)(xe.m,{content:"Fix incorrectly escaped newline and tab sequences in log lines. Manually review the results to confirm that the replacements are correct.",placement:"right",children:(0,t.jsx)(Q.$n,{variant:"secondary",size:"sm",onClick:l,children:a?"Remove escaping":"Escape newlines"})})});const m=(0,t.jsxs)(Oe.W,{children:[(0,t.jsx)(Oe.W.Item,{label:"txt",onClick:()=>c("text")}),(0,t.jsx)(Oe.W.Item,{label:"json",onClick:()=>c("json")}),(0,t.jsx)(Oe.W.Item,{label:"csv",onClick:()=>c("csv")})]});return(0,t.jsx)(t.Fragment,{children:g&&(0,t.jsxs)("div",{className:f.metaContainer,children:[(0,t.jsx)(Is,{metaItems:g.map(y=>({label:y.label,value:"kind"in y?Mi(y.value,y.kind):y.value}))}),(0,t.jsx)(xt.m,{overlay:m,children:(0,t.jsx)(ue.I,{isOpen:!1,variant:"canvas",icon:"download-alt",children:"Download"})})]})})});Qn.displayName="LogsMetaRow";function Mi(e,s){return typeof e=="string"||typeof e=="number"?(0,t.jsx)(t.Fragment,{children:e}):s===ne.tG.LabelsMap?(0,t.jsx)(Mn.h,{labels:e}):s===ne.tG.Error?(0,t.jsx)("span",{className:"logs-meta-item__error",children:e.toString()}):(console.error(`Meta type ${typeof e} ${e} not recognized.`),(0,t.jsx)(t.Fragment,{}))}var jt=p(62930),$i=p(57571),zi=p(42994);function Bi({pages:e,currentPageIndex:s,oldestLogsFirst:n,timeZone:o,loading:r,onClick:i}){const a=c=>`${(0,Rs.LE)(c,{format:zi.WC.interval.second,timeZone:o})}`,l=(c,g)=>{if(s===g&&r)return(0,t.jsx)(jt.y,{});const m=a(n?c.logsRange.from:c.logsRange.to),y=a(n?c.logsRange.to:c.logsRange.from);return`${m} \u2014 ${y}`},d=(0,k.$j)(),f=Hi(d,r);return(0,t.jsx)(zt.E,{autoHide:!0,children:(0,t.jsx)("div",{className:f.pagesWrapper,"data-testid":"logsNavigationPages",children:(0,t.jsx)("div",{className:f.pagesContainer,children:e.map((c,g)=>(0,t.jsxs)("button",{type:"button","data-testid":`page${g+1}`,className:(0,h.cx)((0,Q.my)(d),f.page),onClick:()=>{i(c,g+1)},disabled:r,children:[(0,t.jsx)("div",{className:(0,h.cx)(f.line,{selectedBg:s===g})}),(0,t.jsx)("div",{className:(0,h.cx)(f.time,{selectedText:s===g}),children:l(c,g)})]},c.queryRange.to))})})})}const Hi=(e,s)=>({pagesWrapper:(0,h.css)`
      height: 100%;
      padding-left: ${e.spacing(.5)};
      display: flex;
      flex-direction: column;
      overflow-y: scroll;
      &::after {
        content: '';
        display: block;
        background: repeating-linear-gradient(
          135deg,
          ${e.colors.background.primary},
          ${e.colors.background.primary} 5px,
          ${e.colors.background.secondary} 5px,
          ${e.colors.background.secondary} 15px
        );
        width: 3px;
        height: inherit;
        margin-bottom: 8px;
      }
    `,pagesContainer:(0,h.css)`
      display: flex;
      padding: 0;
      flex-direction: column;
    `,page:(0,h.css)`
      display: flex;
      margin: ${e.spacing(2)} 0;
      cursor: ${s?"auto":"pointer"};
      white-space: normal;
      .selectedBg {
        background: ${e.colors.primary.main};
      }
      .selectedText {
        color: ${e.colors.primary.main};
      }
    `,line:(0,h.css)`
      width: 3px;
      height: 100%;
      align-items: center;
      background: ${e.colors.text.secondary};
    `,time:(0,h.css)`
      width: 60px;
      min-height: 80px;
      font-size: ${e.v1.typography.size.sm};
      padding-left: ${e.spacing(.5)};
      display: flex;
      align-items: center;
    `});function Qi({absoluteRange:e,logsSortOrder:s,timeZone:n,loading:o,onChangeTime:r,scrollToTopLogs:i,visibleRange:a,queries:l,clearCache:d,addResultsToCache:f}){const[c,g]=(0,u.useState)([]),m=(0,u.useRef)(),y=(0,u.useRef)(),C=(0,u.useRef)(0),x=(0,u.useMemo)(()=>c.findIndex(E=>E.queryRange.to===e.to),[e.to,c]),b=s===Y.uH.Ascending,S=b?x===c.length-1:x===0,w=b?x===0:x===c.length-1,R=(0,k.$j)(),v=Vi(R,b);(0,u.useEffect)(()=>{const E={logsRange:a,queryRange:e};let q=[];!(0,ie.isEqual)(y.current,e)||!(0,ie.isEqual)(m.current,l)?(d(),g([E]),m.current=l,C.current=e.to-e.from):g(X=>(q=X.filter(oe=>!(0,ie.isEqual)(E.queryRange,oe.queryRange)),q=[...q,E].sort((oe,he)=>T(oe,he,s)),q))},[a,e,s,l,d,f]);const L=(0,u.useCallback)(({from:E,to:q})=>{f(),y.current={from:E,to:q},r({from:E,to:q})},[r,f]),T=(E,q,X)=>X===Y.uH.Ascending?E.queryRange.to>q.queryRange.to?1:-1:E.queryRange.to>q.queryRange.to?-1:1,F=(0,t.jsx)(Q.$n,{"data-testid":"olderLogsButton",className:v.navButton,variant:"secondary",onClick:()=>{if((0,D.rR)("grafana_explore_logs_pagination_clicked",{pageType:"olderLogsButton"}),w)L({from:a.from-C.current,to:a.from});else{const E=b?-1:1;L({from:c[x+E].queryRange.from,to:c[x+E].queryRange.to})}i()},disabled:o,children:(0,t.jsxs)("div",{className:v.navButtonContent,children:[o?(0,t.jsx)(jt.y,{}):(0,t.jsx)(de.I,{name:b?"angle-up":"angle-down",size:"lg"}),"Older logs"]})}),N=(0,t.jsx)(Q.$n,{"data-testid":"newerLogsButton",className:v.navButton,variant:"secondary",onClick:()=>{if((0,D.rR)("grafana_explore_logs_pagination_clicked",{pageType:"newerLogsButton"}),!S){const E=b?1:-1;L({from:c[x+E].queryRange.from,to:c[x+E].queryRange.to})}i()},disabled:o||S,children:(0,t.jsxs)("div",{className:v.navButtonContent,children:[o&&(0,t.jsx)(jt.y,{}),S||o?null:(0,t.jsx)(de.I,{name:b?"angle-down":"angle-up",size:"lg"}),S?"Start of range":"Newer logs"]})}),P=(0,u.useCallback)((E,q)=>{(0,D.rR)("grafana_explore_logs_pagination_clicked",{pageType:"page",pageNumber:q}),L({from:E.queryRange.from,to:E.queryRange.to}),i()},[L,i]),H=(0,u.useCallback)(()=>{(0,D.rR)("grafana_explore_logs_scroll_top_clicked"),i()},[i]);return(0,t.jsxs)("div",{className:v.navContainer,children:[!U.$.featureToggles.logsInfiniteScrolling&&(0,t.jsxs)(t.Fragment,{children:[b?F:N,(0,t.jsx)(Bi,{pages:c,currentPageIndex:x,oldestLogsFirst:b,timeZone:n,loading:o,onClick:P}),b?N:F]}),(0,t.jsx)(Q.$n,{"data-testid":"scrollToTop",className:v.scrollToTopButton,variant:"secondary",onClick:H,title:"Scroll to top",children:(0,t.jsx)(de.I,{name:"arrow-up",size:"lg"})})]})}const Wi=(0,u.memo)(Qi),Vi=(e,s)=>{const n=`calc(100vh - 2*${e.spacing(2)} - 2*${$i.l}px)`;return{navContainer:(0,h.css)`
      max-height: ${n};
      ${s?"width: 58px;":""}
      display: flex;
      flex-direction: column;
      ${U.$.featureToggles.logsInfiniteScrolling?"justify-content: flex-end;":`justify-content: ${s?"flex-start":"space-between"};`}
      position: sticky;
      top: ${e.spacing(2)};
      right: 0;
    `,navButton:(0,h.css)`
      width: 58px;
      height: 68px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      line-height: 1;
    `,navButtonContent:(0,h.css)`
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      width: 100%;
      height: 100%;
      white-space: normal;
    `,scrollToTopButton:(0,h.css)`
      width: 40px;
      height: 40px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      margin-top: ${e.spacing(1)};
    `}};var Wn=p(98101);function qi(e){return{searchWrap:(0,h.css)({padding:`${e.spacing(.4)} 0 ${e.spacing(.4)} ${e.spacing(.4)}`})}}function Ui(e){const s=(0,k.$j)(),n=qi(s);return(0,t.jsx)(ve.D,{className:n.searchWrap,children:(0,t.jsx)(_e.p,{value:e.value,type:"text",placeholder:"Search fields by name",onChange:e.onChange})})}var Os=p(91076);function Gi(e){return{empty:(0,h.css)({marginBottom:e.spacing(2),marginLeft:e.spacing(1.75),fontSize:e.typography.fontSize})}}function Vn(){const e=(0,k.$j)(),s=Gi(e);return(0,t.jsx)("div",{className:s.empty,children:"No fields"})}var Ki=p(10880);function Yi(e){return{dragIcon:(0,h.css)({cursor:"drag",marginLeft:e.spacing(1),opacity:.4}),labelCount:(0,h.css)({marginLeft:e.spacing(.5),marginRight:e.spacing(.5),appearance:"none",background:"none",border:"none",fontSize:e.typography.pxToRem(11),opacity:.6}),contentWrap:(0,h.css)({display:"flex",alignItems:"center",justifyContent:"space-between",width:"100%"}),checkboxLabel:(0,h.css)({"> span":{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",display:"block",maxWidth:"100%"}})}}function qn(e){const s=(0,k.$j)(),n=Yi(s);if(e.labels[e.label])return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("div",{className:n.contentWrap,children:[(0,t.jsx)(Ki.S,{className:n.checkboxLabel,label:e.label,onChange:e.onChange,checked:e.labels[e.label]?.active??!1}),e.showCount&&(0,t.jsxs)("button",{className:n.labelCount,onClick:e.onChange,children:[e.labels[e.label]?.percentOfLinesWithLabel,"%"]})]}),e.draggable&&(0,t.jsx)(de.I,{"aria-label":"Drag and drop icon",title:"Drag and drop to reorder",name:"draggabledots",size:"lg",className:n.dragIcon})]})}function Un(e){return{wrap:(0,h.css)({marginTop:e.spacing(1),marginBottom:e.spacing(1),display:"flex",background:e.colors.background.primary}),dragging:(0,h.css)({background:e.colors.background.secondary}),columnWrapper:(0,h.css)({marginBottom:e.spacing(1.5),paddingLeft:e.spacing(.5)})}}function Zi(e){return(s,n)=>{const o=e[s],r=e[n];return o.index!=null&&r.index!=null?o.index-r.index:0}}const Ji=e=>{const{reorderColumn:s,labels:n,valueFilter:o,toggleColumn:r}=e,i=(0,k.$j)(),a=Un(i),l=Object.keys(n).filter(c=>o(c)),d=c=>{c.destination&&s(c.source.index,c.destination.index)},f=c=>{const g=n[c];if(g)return`${c} appears in ${g?.percentOfLinesWithLabel}% of log lines`};return l.length?(0,t.jsx)(Os.JY,{onDragEnd:d,children:(0,t.jsx)(Os.gL,{droppableId:"order-fields",direction:"vertical",children:c=>(0,t.jsxs)("div",{className:a.columnWrapper,...c.droppableProps,ref:c.innerRef,children:[l.sort(Zi(n)).map((g,m)=>(0,t.jsx)(Os.sx,{draggableId:g,index:m,children:(y,C)=>(0,t.jsx)("div",{className:(0,h.cx)(a.wrap,C.isDragging?a.dragging:void 0),ref:y.innerRef,...y.draggableProps,...y.dragHandleProps,title:f(g),children:(0,t.jsx)(qn,{label:g,onChange:()=>r(g),labels:n,draggable:!0})})},g)),c.placeholder]})})}):(0,t.jsx)(Vn,{})},Xi=new Intl.Collator(void 0,{sensitivity:"base"});function _i(e){return(s,n)=>{const o=e[s],r=e[n];return o!=null&&r!=null?+(r.type==="TIME_FIELD")-+(o.type==="TIME_FIELD")||+(r.type==="BODY_FIELD")-+(o.type==="BODY_FIELD")||Xi.compare(s,n):0}}const ea=e=>{const{labels:s,valueFilter:n,toggleColumn:o}=e,r=(0,k.$j)(),i=Un(r),a=Object.keys(s).filter(l=>n(l));return a.length?(0,t.jsx)("div",{className:i.columnWrapper,children:a.sort(_i(s)).map((l,d)=>(0,t.jsx)("div",{className:i.wrap,title:`${l} appears in ${s[l]?.percentOfLinesWithLabel}% of log lines`,children:(0,t.jsx)(qn,{showCount:!0,label:l,onChange:()=>o(l),labels:s})},l))}):(0,t.jsx)(Vn,{})};function ta(e){return{sidebarWrap:(0,h.css)({overflowY:"scroll",height:"calc(100% - 50px)","&::-webkit-scrollbar":{display:"none"},scrollbarWidth:"none"}),columnHeaderButton:(0,h.css)({appearance:"none",background:"none",border:"none",fontSize:e.typography.pxToRem(11)}),columnHeader:(0,h.css)({display:"flex",justifyContent:"space-between",fontSize:e.typography.h6.fontSize,background:e.colors.background.secondary,position:"sticky",top:0,left:0,paddingTop:e.spacing(.75),paddingRight:e.spacing(.75),paddingBottom:e.spacing(.75),paddingLeft:e.spacing(1.5),zIndex:3,marginBottom:e.spacing(2)})}}const sa=e=>{const s=(0,k.$j)(),n=ta(s);return(0,t.jsx)("div",{className:n.sidebarWrap,children:(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("div",{className:n.columnHeader,children:["Selected fields",(0,t.jsx)("button",{onClick:e.clear,className:n.columnHeaderButton,children:"Reset"})]}),(0,t.jsx)(Ji,{reorderColumn:e.reorderColumn,toggleColumn:e.toggleColumn,labels:e.filteredColumnsWithMeta??e.columnsWithMeta,valueFilter:o=>e.columnsWithMeta[o]?.active??!1,id:"selected-fields"}),(0,t.jsx)("div",{className:n.columnHeader,children:"Fields"}),(0,t.jsx)(ea,{toggleColumn:e.toggleColumn,labels:e.filteredColumnsWithMeta??e.columnsWithMeta,valueFilter:o=>!e.columnsWithMeta[o]?.active})]})})};var Gn=p(53076);const na=new Gn.A({intraMode:1,intraIns:1,intraSub:1,intraTrn:1,intraDel:1});function Kn(e,s,n){const[o,r,i]=na.search(e,s,0,1e5);let a=[],l=new Set;if(o&&i){const d=(f,c)=>{c&&l.add(f)};for(let f=0;f<i.length;f++){let c=i[f];Gn.A.highlight(e[r.idx[c]],r.ranges[c],d),a.push(e[r.idx[c]])}n([a,[...l]])}else s||n([[],[]])}const Ld=(0,ie.debounce)(Kn,300);function oa(e){const{logsFrames:s,updatePanelState:n,panelState:o}=e,r=o?.columns,[i,a]=(0,u.useState)(void 0),[l,d]=(0,u.useState)(void 0),[f,c]=(0,u.useState)(""),g=Yn(),m=e?.panelState?.refId,[y,C]=(0,u.useState)(s.find(O=>O.refId===m)??s[0]),x=(0,u.useCallback)(O=>{const z=e.panelState?.columns;return z&&Object.values(z).forEach((B,G)=>{O[B]&&(O[B].active=!0,O[B].index=G)}),O},[e.panelState?.columns]),b=(0,Wn.O)(y);(0,u.useEffect)(()=>{if(b?.timeField.name&&b?.bodyField.name&&!r){const O={0:b?.timeField.name??"",1:b?.bodyField.name??""};n({columns:Object.values(O),visualisationType:"table",labelFieldName:b?.getLabelFieldName()??void 0})}},[b,r,n]),(0,u.useEffect)(()=>{const O=s.find(z=>z.refId===m)??s[0];O&&C(O)},[s,m]),(0,u.useEffect)(()=>{if(!i||!l)return;let O={...l},z=!1;Object.keys(i).forEach(B=>{O[B]&&O[B].active!==i[B].active&&(O[B]=i[B],z=!0)}),z&&d(O)},[i,l]),(0,u.useEffect)(()=>{if(!y.length)return;const O=y?y.length:0,z=(0,Wn.O)(y),B=z?.getLogFrameLabelsAsLabels(),G=[];z&&G.push(...z.extraFields.filter(re=>!re?.config?.custom?.hidden)),z?.severityField&&G.push(z?.severityField),z?.bodyField&&G.push(z?.bodyField),z?.timeField&&G.push(z?.timeField);const M=new Map;let W={};B?.length&&O&&(B.forEach(re=>{Object.keys(re).forEach(ye=>{if(M.has(ye)){const Se=M.get(ye);Se&&(Se?.active?M.set(ye,{percentOfLinesWithLabel:Se.percentOfLinesWithLabel+1,active:!0,index:Se.index}):M.set(ye,{percentOfLinesWithLabel:Se.percentOfLinesWithLabel+1,active:!1,index:void 0}))}else M.set(ye,{percentOfLinesWithLabel:1,active:!1,index:void 0})})}),W=Object.fromEntries(M),Object.keys(W).forEach(re=>{W[re].percentOfLinesWithLabel=Fs(W[re].percentOfLinesWithLabel,O)})),G.forEach(re=>{const tt=W[re.name]?.active,ye=W[re.name]?.index;tt&&ye!==void 0?W[re.name]={percentOfLinesWithLabel:Fs(re.values.filter(Se=>Se!=null).length,O),active:!0,index:ye}:W[re.name]={percentOfLinesWithLabel:Fs(re.values.filter(Se=>Se!=null).length,O),active:!1,index:void 0}}),W=x(W),Object.keys(W).filter(re=>W[re].active).length===0&&(z?.bodyField?.name&&(W[z.bodyField.name].active=!0),z?.timeField?.name&&(W[z.timeField.name].active=!0)),z?.bodyField?.name&&z?.timeField?.name&&(W[z.bodyField.name].type="BODY_FIELD",W[z.timeField.name].type="TIME_FIELD"),a(W)},[y,x]);const[S,w]=(0,u.useState)(220),R=e.width-S;if(!i)return null;function v(O){if(i){const z=!i[O]?.active,B=Object.keys(i).filter(M=>i[M]?.active)?.length,G={columnAction:z?"add":"remove",columnCount:z?B+1:B-1,datasourceType:e.datasourceType};(0,D.rR)("grafana_explore_logs_table_column_filter_clicked",G)}}function L(O){(0,D.rR)("grafana_explore_logs_table_text_search_result_count",{resultCount:O,datasourceType:e.datasourceType??"unknown"})}const T=()=>{const O={...i};let z=0;Object.keys(O).forEach(B=>{const G=!!O[B].type;O[B].active=G,O[B].index=G?z++:void 0}),a(O)},F=(O,z)=>{if(O===z)return;const B={...i},G=Object.keys(B).filter(W=>B[W].active).map(W=>({fieldName:W,index:B[W].index??0})).sort((W,Ze)=>W.index-Ze.index),[M]=G.splice(O,1);G.splice(z,0,M),G.forEach((W,Ze)=>{B[W.fieldName].index=Ze}),a(B),N(B)};function N(O){const z=Object.keys(O).filter(W=>O[W]?.active).sort((W,Ze)=>{const re=O[W],tt=O[Ze];return re.index!==void 0&&tt.index!==void 0?re.index-tt.index:0}),B=Object.assign({},z),G={0:b?.timeField.name??"",1:b?.bodyField.name??""},M={...e.panelState,columns:Object.keys(B).length?B:G,refId:y.refId,visualisationType:"table",labelFieldName:b?.getLabelFieldName()??void 0};n(M)}const P=O=>{if(!i||!(O in i)){console.warn("failed to get column",i);return}const z=Object.keys(i).filter(M=>i[M].active).length,B=i[O].active?void 0:!0;let G;if(B?G={...i,[O]:{...i[O],active:B,index:z}}:G={...i,[O]:{...i[O],active:!1,index:void 0}},v(O),a(G),l){const M=!l[O]?.active;let W;M?W={...l,[O]:{...l[O],active:M,index:z}}:W={...l,[O]:{...l[O],active:!1,index:void 0}},d(W)}N(G)},H=O=>{const z=O[0];let B={},G=0;z.forEach(M=>{M in i&&(B[M]=i[M],G++)}),d(B),L(G)},E=O=>{Kn(Object.keys(i),O,H)},q=O=>{const z=O.currentTarget?.value;c(z),z?E(z):d(void 0)},X=O=>{s.find(B=>B.refId===O.value)&&C(s.find(B=>B.refId===O.value)??s[0]),e.updatePanelState({refId:O.value,labelFieldName:b?.getLabelFieldName()??void 0})},oe=ra(e.theme,g,S),he=(O,z,B)=>{const G=Number(B.style.width.slice(0,-2));isNaN(G)||w(G)};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("div",{children:s.length>1&&(0,t.jsx)("div",{children:(0,t.jsx)(Me.I,{label:"Select query",htmlFor:"explore_logs_table_frame_selector",labelWidth:22,tooltip:"Select a query to visualize in the table.",children:(0,t.jsx)(Ne.l6,{inputId:"explore_logs_table_frame_selector","aria-label":"Select query by name",value:y.refId,options:s.map(O=>({label:O.refId,value:O.refId})),onChange:X})})})}),(0,t.jsxs)("div",{className:oe.wrapper,children:[(0,t.jsx)(nn,{enable:{right:!0},handleClasses:{right:oe.rzHandle},onResize:he,children:(0,t.jsxs)("section",{className:oe.sidebar,children:[(0,t.jsx)(Ui,{value:f,onChange:q}),(0,t.jsx)(sa,{reorderColumn:F,toggleColumn:P,filteredColumnsWithMeta:l,columnsWithMeta:i,clear:T})]})}),(0,t.jsx)(Oi,{logsFrame:b,onClickFilterLabel:e.onClickFilterLabel,onClickFilterOutLabel:e.onClickFilterOutLabel,logsSortOrder:e.logsSortOrder,range:e.range,splitOpen:e.splitOpen,timeZone:e.timeZone,width:R,dataFrame:y,columnsWithMeta:i,height:g})]})]})}const Fs=(e,s)=>Math.ceil(100*e/s);function ra(e,s,n){return{wrapper:(0,h.css)({display:"flex"}),sidebar:(0,h.css)({height:s,fontSize:e.typography.pxToRem(11),overflowY:"hidden",width:n,paddingRight:e.spacing(3)}),rzHandle:(0,h.css)({background:e.colors.secondary.main,[e.transitions.handleMotion("no-preference","reduce")]:{transition:"0.3s background ease-in-out"},position:"relative",height:"50% !important",width:`${e.spacing(1)} !important`,top:"25% !important",right:`${e.spacing(1)} !important`,cursor:"grab",borderRadius:e.shape.radius.pill,"&:hover":{background:e.colors.secondary.shade}})}}const Yn=()=>Math.max(window.innerHeight-500,500);function Ds(e){const[s,n]=(0,u.useState)(!1),o=100,{error:r,title:i,suggestedAction:a,onSuggestedAction:l,onRemove:d,severity:f="warning"}=e,c=r?.message||r?.data?.message||"",g=!s&&c.length>o,m=(0,k.$j)(),y=ia(m);return(0,t.jsx)("div",{className:y.supplementaryErrorContainer,children:(0,t.jsx)(yt.F,{title:i,severity:f,onRemove:d,children:(0,t.jsxs)("div",{className:y.suggestedActionWrapper,children:[g?(0,t.jsx)(Q.$n,{variant:"secondary",size:"xs",onClick:()=>{n(!0)},children:"Show details"}):c,a&&l&&(0,t.jsx)("div",{className:y.suggestedActionWrapper,children:(0,t.jsx)(Q.$n,{variant:"primary",size:"xs",onClick:l,children:a})})]})})})}const ia=e=>({supplementaryErrorContainer:(0,h.css)({width:"50%",minWidth:`${e.breakpoints.values.sm}px`,margin:"0 auto"}),suggestedActionWrapper:(0,h.css)({height:e.spacing(6),button:{position:"absolute",right:e.spacing(2),top:e.spacing(7)}})});var aa=p(9791);function la(e){const{width:s,timeZone:n,splitOpen:o,onUpdateTimeRange:r,onHiddenSeriesChanged:i,allLogsVolumeMaximum:a,toggleLegendRef:l}=e,d=(0,k.$j)(),f=(0,k.of)(ca),c=parseInt(d.spacing(2).slice(0,-2),10),g=150,m=e.logsVolumeData,y=(0,Pe.Dm)(m?.data);let C=y?`${y.name}`:"";(0,Pe.e3)(m.data)&&(C=[C,"This datasource does not support full-range histograms. The graph below is based on the logs seen in the response."].filter(ie.identity).join(". "));let x=(0,t.jsx)("span",{children:C});return m.state===Re.Gu.Streaming&&(x=(0,t.jsxs)(t.Fragment,{children:[x,(0,t.jsx)(xe.m,{content:"Streaming",children:(0,t.jsx)(de.I,{name:"circle-mono",size:"md",className:f.streaming,"data-testid":"logs-volume-streaming"})})]})),(0,t.jsxs)("div",{style:{height:g},className:f.contentContainer,children:[(0,t.jsx)(aa.k,{toggleLegendRef:l,vizLegendOverrides:{calcs:["sum"]},graphStyle:"lines",loadingState:m.state??Re.Gu.Done,data:m.data,height:g,width:s-c*2,timeRange:e.timeRange,onChangeTime:r,timeZone:n,splitOpenFn:o,tooltipDisplayMode:Y.$N.Multi,onHiddenSeriesChanged:i,anchorToZero:!0,yAxisMaximum:a,eventBus:e.eventBus,annotations:e.annotations}),x&&(0,t.jsx)("div",{className:f.extraInfoContainer,children:x})]})}const ca=e=>({extraInfoContainer:(0,h.css)`
      display: flex;
      justify-content: end;
      position: absolute;
      right: 5px;
      top: -10px;
      font-size: ${e.typography.bodySmall.fontSize};
      color: ${e.colors.text.secondary};
    `,contentContainer:(0,h.css)`
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    `,streaming:(0,h.css)`
      color: ${e.colors.success.text};
    `});function da(e){return!e||!e.error&&!e.errors?!1:(e.error?[e.error]:e.errors||[]).some(n=>(`${n.message||n.data?.message}`?.toLowerCase()).includes("timeout"))}const ua=({logsVolumeData:e,absoluteRange:s,onUpdateTimeRange:n,width:o,onLoadLogsVolume:r,onHiddenSeriesChanged:i,eventBus:a,splitOpen:l,timeZone:d,onClose:f,toggleLegendRef:c})=>{const{logVolumes:g,maximumValue:m,maximumRange:y,annotations:C}=(0,u.useMemo)(()=>{let T=-1/0;const F=e?.data.filter(X=>X.meta?.dataTopic!==Y.QR.Annotations),N=e?.data.filter(X=>X.meta?.dataTopic===Y.QR.Annotations)||[],P=(0,ie.sortBy)(F||[],"meta.custom.datasourceName"),H=(0,ie.groupBy)(P,"meta.custom.datasourceName"),E=(0,ie.mapValues)(H,X=>{const oe=(0,Pe.oT)(X);return T=Math.max(T,oe.maximum),oe.dataFrames}),q=(0,Pe.Dx)((0,ie.flatten)(Object.values(E)));return{maximumValue:T,maximumRange:q,logVolumes:E,annotations:N}},[e]),x=(0,k.of)(pa),b=Object.keys(g).length,S=Object.values(g).some(T=>{const F=ha(T,s);return!(0,Pe.e3)(T)&&F&&F<1}),w=da(e),R=(0,Ue.KQ)(Math.max(s.from,y.from)),v=(0,Ue.KQ)(Math.min(s.to,y.to)),L={from:R,to:v,raw:{from:R,to:v}};return e?.state===Re.Gu.Loading?(0,t.jsx)("span",{children:"Loading..."}):w?(0,t.jsx)(Ds,{title:"The logs volume query has timed out",severity:"info",suggestedAction:"Retry",onSuggestedAction:r,onRemove:f}):e?.error!==void 0?(0,t.jsx)(Ds,{error:e.error,title:"Failed to load log volume for this query"}):b===0?(0,t.jsx)("div",{className:x.alertContainer,children:(0,t.jsx)(yt.F,{severity:"info",title:"No logs volume available",children:"No volume information available for the current queries and time range."})}):(0,t.jsxs)("div",{className:x.listContainer,children:[Object.keys(g).map((T,F)=>{const N={data:g[T]};return(0,t.jsx)(la,{toggleLegendRef:c,timeRange:L,allLogsVolumeMaximum:m,width:o,logsVolumeData:N,onUpdateTimeRange:n,timeZone:d,splitOpen:l,onLoadLogsVolume:r,onHiddenSeriesChanged:b>1?()=>{}:i,eventBus:a,annotations:C},F)}),S&&(0,t.jsx)("div",{className:x.extraInfoContainer,children:(0,t.jsx)(Me.I,{label:"Reload log volume",transparent:!0,children:(0,t.jsx)(Q.$n,{size:"xs",icon:"sync",variant:"secondary",onClick:r,id:"reload-volume"})})})]})},pa=e=>({listContainer:(0,h.css)`
      padding-top: 10px;
    `,extraInfoContainer:(0,h.css)`
      display: flex;
      justify-content: end;
      position: absolute;
      right: 5px;
      top: 5px;
    `,oldInfoText:(0,h.css)`
      font-size: ${e.typography.bodySmall.fontSize};
      color: ${e.colors.text.secondary};
    `,alertContainer:(0,h.css)`
      width: 50%;
      min-width: ${e.breakpoints.values.sm}px;
      margin: 0 auto;
    `});function ha(e,s){const n=e&&e[0]&&e[0].meta?.custom?.absoluteRange;return n?(s.from-s.to)/(n.from-n.to):void 0}var me=p(97186);const ga=[Y.fY.none,Y.fY.exact,Y.fY.numbers,Y.fY.signature],As=()=>{const e=fe.A.get(me.r);return e==="table"?"table":e==="logs"?"logs":U.$.featureToggles.logsExploreTableDefaultVisualization?"table":"logs"},es=10,Ns="Pinned log",Zn="Pin to content outline",dt="Logs",fa=e=>{const{width:s,splitOpen:n,logRows:o,logsMeta:r,logsVolumeEnabled:i,logsVolumeData:a,loadLogsVolumeData:l,loading:d=!1,onClickFilterLabel:f,onClickFilterOutLabel:c,timeZone:g,scanning:m,scanRange:y,showContextToggle:C,absoluteRange:x,onChangeTime:b,getFieldLinks:S,theme:w,logsQueries:R,clearCache:v,addResultsToCache:L,exploreId:T,getRowContext:F,getLogRowContextUi:N,getRowContextQuery:P,loadMoreLogs:H,panelState:E,eventBus:q}=e,[X,oe]=(0,u.useState)(fe.A.getBool(me.$.showLabels,!1)),[he,O]=(0,u.useState)(fe.A.getBool(me.$.showTime,!0)),[z,B]=(0,u.useState)(fe.A.getBool(me.$.wrapLogMessage,!0)),[G,M]=(0,u.useState)(fe.A.getBool(me.$.prettifyLogMessage,!1)),[W,Ze]=(0,u.useState)(Y.fY.none),[re,tt]=(0,u.useState)([]),[ye,Se]=(0,u.useState)(fe.A.get(me.$.logsSortOrder)||Y.uH.Descending),[Uc,mo]=(0,u.useState)(!1),[Je,Ws]=(0,u.useState)([]),[os,Gc]=(0,u.useState)(!1),[Kc,yo]=(0,u.useState)(!1),[st,xo]=(0,u.useState)(void 0),[Yc,vo]=(0,u.useState)(Zn),[ze,bo]=(0,u.useState)(E?.logs?.visualisationType??As()),[Zc,Jc]=(0,u.useState)(void 0),We=(0,u.useRef)(void 0),It=(0,A.useDispatch)(),So=(0,di.A)(d),Xc=q.newScopedBus("logsvolume",{onlyLocal:!1}),{register:rs,unregister:Co,outlineItems:Et,updateItem:jo,unregisterAllChildren:Vs}=fs()??{},qs=(0,u.useRef)(void 0),Us=(0,u.useRef)(void 0),Gs=(0,u.useRef)(()=>{}),is=(0,u.useRef)(null),_c=Yn(),te=ya(w,z,_c),Ks=o&&o.length>0,ed=y?`Scanning ${bt.describeTimeRange(y)}`:"Scanning...",Ro=Et?.find(I=>I.panelId===dt&&I.level==="root")?.children?.filter(I=>I.title===Ns).map(I=>I.id),as=(0,u.useCallback)(()=>Et?.find(V=>V.panelId===dt&&V.level==="root")?.children?.filter(V=>V.title===Ns).length??0,[Et]),To=(0,u.useCallback)(()=>{const I=Object.keys(lt.cZ),V=new Set(a?.data),K=a?.data.filter(Ce=>Ce.meta?.dataTopic!==Y.QR.Annotations),Be=(0,ie.groupBy)(K,"meta.custom.datasourceName"),Le=Object.keys(Be).length;Vs&&Vs(Ce=>Ce?.find(ls=>ls.panelId===dt&&ls.level==="root")?.id,"filter");const Oo=[];V.forEach(Ce=>{const{level:nt}=(0,Pe.tX)(Ce);Oo.push({levelStr:nt,logLevel:(0,Pe.XM)(nt)})});const wd=Oo.sort((Ce,nt)=>I.indexOf(Ce.logLevel.toString())>I.indexOf(nt.logLevel.toString())?1:-1),Fo=new Set(wd);Fo.size>1&&i&&Le===1&&Fo.forEach(Ce=>{const nt=re.length===0,ls=!re.find(Js=>Js===Ce.levelStr);rs&&rs({title:Ce.levelStr,icon:"gf-logs",panelId:dt,level:"child",type:"filter",highlight:ls&&!nt,onClick:Js=>{Gs.current?.(Ce.levelStr,(0,pi.W)(Js)),ji(Ce)},ref:null,color:lt.cZ[Ce.logLevel]})})},[a?.data,Vs,i,re,rs,Gs]);(0,u.useEffect)(()=>{as()===es?vo((0,t.jsxs)("span",{style:{display:"flex",textAlign:"center"},children:["\u2757\uFE0F",(0,t.jsxs)(j.x6,{i18nKey:"explore.logs.maximum-pinned-logs",children:["Maximum of ",{PINNED_LOGS_LIMIT:es}," pinned logs reached. Unpin a log to add another."]})]})):vo(Zn)},[Et,as]),(0,u.useEffect)(()=>{d&&!So&&E?.logs?.id&&(delete E.logs.id,It((0,He.EA)(T,"logs",{...E})))},[It,T,d,E,So]),(0,u.useEffect)(()=>{const I=E?.logs?.visualisationType??As();bo(I),fe.A.set(me.r,I)},[E?.logs?.visualisationType]),(0,u.useEffect)(()=>{To()},[a?.data,re,To]),(0,ee.A)(()=>{qs&&window.clearTimeout(qs.current),Us&&window.clearTimeout(Us.current)}),(0,ee.A)(()=>{(E?.logs?.columns||E?.logs?.refId||E?.logs?.labelFieldName)&&It((0,He.EA)(T,"logs",{...E?.logs,columns:void 0,visualisationType:ze,labelFieldName:void 0,refId:void 0}))});const Ys=(0,u.useCallback)(I=>{const V=(0,ct.Gu)().explore.panes[T];V?.panelsState&&It((0,He.EA)(T,"logs",{...V.panelsState.logs,columns:I.columns??E?.logs?.columns,visualisationType:I.visualisationType??ze,labelFieldName:I.labelFieldName,refId:I.refId??E?.logs?.refId}))},[It,T,E?.logs?.columns,E?.logs?.refId,ze]),td=(0,u.useCallback)(I=>{I?e.eventBus.publish(new Tn.b_({point:{time:I.timeEpochMs}})):e.eventBus.publish(new Tn.ql)},[e.eventBus]),sd=(0,u.useCallback)(I=>{We.current=I,Jc(()=>V=>{if(U.$.featureToggles.logsInfiniteScrolling){We.current&&(is.current?.scrollIntoView(),We.current.scroll({behavior:"smooth",top:We.current.scrollTop+V.getBoundingClientRect().top-window.innerHeight/2}));return}const K=e.scrollElement;K&&K.scroll({behavior:"smooth",top:K.scrollTop+V.getBoundingClientRect().top-window.innerHeight/2})})},[e.scrollElement]),nd=()=>{mo(!0),qs.current=window.setTimeout(()=>{const I=ye===Y.uH.Descending?Y.uH.Ascending:Y.uH.Descending;fe.A.set(me.$.logsSortOrder,I),Se(I)},0),Us.current=window.setTimeout(()=>mo(!1),1e3)},od=(0,u.useCallback)(()=>{Gc(!os)},[os]),rd=(0,u.useCallback)(I=>{bo(I);const V={...E?.logs,visualisationType:I};Ys(V),(0,D.rR)("grafana_explore_logs_visualisation_changed",{newVisualizationType:I,datasourceType:e.datasourceType??"unknown",defaultVisualisationType:U.$.featureToggles.logsExploreTableDefaultVisualization?"table":"logs"})},[E?.logs,e.datasourceType,Ys]),id=(0,u.useCallback)(I=>{(0,D.rR)("grafana_explore_logs_deduplication_clicked",{deduplicationType:I,datasourceType:e.datasourceType}),Ze(I)},[e.datasourceType]),ad=(0,u.useCallback)(I=>{const{target:V}=I;if(V){const K=V.checked;oe(K),fe.A.set(me.$.showLabels,K)}},[]),ld=(0,u.useCallback)(I=>{const{target:V}=I;if(V){const K=V.checked;O(K),fe.A.set(me.$.showTime,K)}},[]),cd=(0,u.useCallback)(I=>{const{target:V}=I;if(V){const K=V.checked;B(K),fe.A.set(me.$.wrapLogMessage,K)}},[]),dd=(0,u.useCallback)(I=>{const{target:V}=I;if(V){const K=V.checked;M(K),fe.A.set(me.$.prettifyLogMessage,K)}},[]),ud=(0,u.useCallback)(I=>{const V=I.map(K=>(0,Pe.EK)(K));tt(V)},[]),wo=(0,u.useCallback)(I=>{e.onSetLogsVolumeEnabled(!I),(0,D.rR)("grafana_explore_logs_histogram_toggle_clicked",{datasourceType:e.datasourceType,type:I?"close":"open"})},[e]),pd=(0,u.useCallback)(I=>{I.preventDefault(),e.onStartScanning&&(e.onStartScanning(),(0,D.rR)("grafana_explore_logs_scanning_button_clicked",{type:"start",datasourceType:e.datasourceType}))},[e]),hd=(0,u.useCallback)(I=>{I.preventDefault(),e.onStopScanning&&e.onStopScanning()},[e]),gd=(0,u.useCallback)(I=>{Je.indexOf(I)===-1&&Ws(Je.concat(I))},[Je]),fd=(0,u.useCallback)(I=>{Je.indexOf(I)>-1&&Ws(Je.filter(K=>I!==K))},[Je]),md=(0,u.useCallback)(()=>{Ws([])},[]),Zs=(0,u.useRef)(()=>{});let yd=(0,u.useCallback)(()=>{yo(!1),xo(void 0),(0,D.rR)("grafana_explore_logs_log_context_closed",{datasourceType:st?.datasourceType,logRowUid:st?.uid}),Zs?.current()},[st?.datasourceType,st?.uid,Zs]);const Lo=(I,V)=>{yo(!0),xo(I),(0,D.rR)("grafana_explore_logs_log_context_opened",{datasourceType:I.datasourceType,logRowUid:I.uid}),Zs.current=V},Io=(0,u.useCallback)((I,V)=>{for(let K=V.indexOf(I)-1;K>=0;K--)if(V[K].timeEpochMs>I.timeEpochMs)return V[K];return null},[]),xd=(0,u.useCallback)(I=>{const V={from:new Date(x.from).toISOString(),to:new Date(x.to).toISOString()};if(!U.$.featureToggles.logsInfiniteScrolling)return V;const K=o.filter(Le=>Le.dataFrame.refId===I.dataFrame.refId),Be=Io(I,K);return I.timeEpochMs>x.to&&!Be?{from:new Date(x.from).toISOString(),to:new Date(I.timeEpochMs+1).toISOString()}:{from:new Date(x.from).toISOString(),to:new Date(Be?Be.timeEpochMs:x.to).toISOString()}},[x.from,x.to,Io,o]),vd=async I=>{if(I.rowId===void 0)return;const V=(0,An.m)((0,ct.Gu)().explore.panes[T]);V.panelsState={...E,logs:{id:I.uid,visualisationType:ze??As()}},V.range=xd(I);const K=(0,wn.Pp)(V),Be=/.*(?=\/explore)/.exec(`${window.location.href}`)[0],Le=wn.kM.renderUrl(`${Be}/explore`,{left:K});await(0,js.VP)(Le),(0,D.rR)("grafana_explore_logs_permalink_clicked",{datasourceType:I.datasourceType??"unknown",logRowUid:I.uid,logRowLevel:I.logLevel})},bd=(0,u.useCallback)(()=>{U.$.featureToggles.logsInfiniteScrolling&&We.current&&We.current.scroll({behavior:"auto",top:0}),is.current?.scrollIntoView()},[We,is]),Eo=(I,V=!0)=>{if(as()===es&&!V){bi();return}const K=Et?.find(Le=>Le.panelId===dt&&Le.level==="root");K&&jo&&jo(K.id,{expanded:!0});const Be=Ro?.find(Le=>Le===I.rowId);Be&&I.rowId&&V?(Co?.(I.rowId),vi()):as()!==es&&!Be&&(rs?.({id:I.rowId,icon:"gf-logs",title:Ns,panelId:dt,level:"child",ref:null,color:lt.cZ[I.logLevel],childOnTop:!0,onClick:()=>{Lo(I,()=>{}),Si()},onRemove:Le=>{Co?.(Le),Ci()}}),xi()),e.onPinLineCallback?.()},Sd=xa(o),Cd=ba(o,re),{dedupedRows:jd,dedupCount:Rd}=va(Cd,W),Td=Sa(o);return(0,t.jsxs)(t.Fragment,{children:[F&&st&&(0,t.jsx)(yi.V,{open:Kc,row:st,onClose:yd,getRowContext:(I,V)=>F(I,st,V),getRowContextQuery:P,getLogRowContextUi:N,logsSortOrder:ye,timeZone:g}),(0,t.jsx)(Qe.NR,{title:"Logs volume",collapsible:!0,collapsed:!i,onToggleCollapse:wo,children:i&&(0,t.jsx)(ua,{toggleLegendRef:Gs,absoluteRange:x,width:s,logsVolumeData:a,onUpdateTimeRange:b,timeZone:g,splitOpen:n,onLoadLogsVolume:l,onHiddenSeriesChanged:ud,eventBus:Xc,onClose:()=>wo(!0)})}),(0,t.jsxs)(Qe.NR,{titleItems:[U.$.featureToggles.logsExploreTableVisualisation?ze==="logs"?null:(0,t.jsx)(Qe.NR.TitleItem,{title:"Feedback",children:(0,t.jsx)(Ri,{feedbackUrl:"https://forms.gle/5YyKdRQJ5hzq4c289"})},"A"):null],title:"Logs",actions:(0,t.jsx)(t.Fragment,{children:U.$.featureToggles.logsExploreTableVisualisation&&(0,t.jsx)("div",{className:te.visualisationType,children:(0,t.jsx)(St.z,{className:te.visualisationTypeRadio,options:[{label:"Logs",value:"logs",description:"Show results in logs visualisation"},{label:"Table",value:"table",description:"Show results in table visualisation"}],size:"sm",value:ze,onChange:rd})})}),loadingState:d?Re.Gu.Loading:Re.Gu.Done,children:[(0,t.jsxs)("div",{className:te.stickyNavigation,children:[ze!=="table"&&(0,t.jsxs)("div",{className:te.logOptions,children:[(0,t.jsxs)(ui.C,{children:[(0,t.jsx)(Me.I,{label:"Time",className:te.horizontalInlineLabel,transparent:!0,children:(0,t.jsx)(Ke.K,{value:he,onChange:ld,className:te.horizontalInlineSwitch,transparent:!0,id:`show-time_${T}`})}),(0,t.jsx)(Me.I,{label:"Unique labels",className:te.horizontalInlineLabel,transparent:!0,children:(0,t.jsx)(Ke.K,{value:X,onChange:ad,className:te.horizontalInlineSwitch,transparent:!0,id:`unique-labels_${T}`})}),(0,t.jsx)(Me.I,{label:"Wrap lines",className:te.horizontalInlineLabel,transparent:!0,children:(0,t.jsx)(Ke.K,{value:z,onChange:cd,className:te.horizontalInlineSwitch,transparent:!0,id:`wrap-lines_${T}`})}),(0,t.jsx)(Me.I,{label:"Prettify JSON",className:te.horizontalInlineLabel,transparent:!0,children:(0,t.jsx)(Ke.K,{value:G,onChange:dd,className:te.horizontalInlineSwitch,transparent:!0,id:`prettify_${T}`})}),(0,t.jsx)(Me.I,{label:"Deduplication",className:te.horizontalInlineLabel,transparent:!0,children:(0,t.jsx)(St.z,{options:ga.map(I=>({label:(0,ie.capitalize)(I),value:I,description:ne._C[I]})),value:W,onChange:id,className:te.radioButtons})})]}),(0,t.jsx)("div",{children:(0,t.jsx)(Me.I,{label:"Display results",className:te.horizontalInlineLabel,transparent:!0,disabled:Uc||d,children:(0,t.jsx)(St.z,{options:[{label:"Newest first",value:Y.uH.Descending,description:"Show results newest to oldest"},{label:"Oldest first",value:Y.uH.Ascending,description:"Show results oldest to newest"}],value:ye,onChange:nd,className:te.radioButtons})})})]}),(0,t.jsx)("div",{ref:is}),(0,t.jsx)(Qn,{logRows:o,meta:r||[],dedupStrategy:W,dedupCount:Rd,hasUnescapedContent:Sd,forceEscape:os,displayedFields:Je,onEscapeNewlines:od,clearDetectedFields:md})]}),(0,t.jsxs)("div",{className:(0,h.cx)(te.logsSection,ze==="table"?te.logsTable:void 0),children:[ze==="table"&&Ks&&(0,t.jsx)("div",{className:te.logRows,"data-testid":"logRowsTable",children:(0,t.jsx)(oa,{logsSortOrder:ye,range:e.range,splitOpen:n,timeZone:g,width:s-80,logsFrames:e.logsFrames??[],onClickFilterLabel:f,onClickFilterOutLabel:c,panelState:E?.logs,theme:w,updatePanelState:Ys,datasourceType:e.datasourceType})}),ze==="logs"&&Ks&&(0,t.jsx)("div",{className:U.$.featureToggles.logsInfiniteScrolling?te.scrollableLogRows:te.logRows,"data-testid":"logRows",ref:sd,children:(0,t.jsx)(hi,{loading:d,loadMoreLogs:H,range:e.range,timeZone:g,rows:o,scrollElement:We.current,sortOrder:ye,app:ge.Jk.Explore,children:(0,t.jsx)(Dn.k,{pinnedLogs:Ro,logRows:o,deduplicatedRows:jd,dedupStrategy:W,onClickFilterLabel:f,onClickFilterOutLabel:c,showContextToggle:C,getRowContextQuery:P,showLabels:X,showTime:he,enableLogDetails:!0,forceEscape:os,wrapLogMessage:z,prettifyLogMessage:G,timeZone:g,getFieldLinks:S,logsSortOrder:ye,displayedFields:Je,onClickShowField:gd,onClickHideField:fd,app:ge.Jk.Explore,onLogRowHover:td,onOpenContext:Lo,onPermalinkClick:vd,permalinkedRowId:E?.logs?.id,scrollIntoView:Zc,isFilterLabelActive:e.isFilterLabelActive,containerRendered:!!We,onClickFilterString:e.onClickFilterString,onClickFilterOutString:e.onClickFilterOutString,onUnpinLine:Eo,onPinLine:Eo,pinLineButtonTooltipTitle:Yc})})}),!d&&!Ks&&!m&&(0,t.jsx)("div",{className:te.logRows,children:(0,t.jsxs)("div",{className:te.noData,children:[(0,t.jsx)(j.x6,{i18nKey:"explore.logs.no-logs-found",children:"No logs found."}),(0,t.jsx)(Q.$n,{size:"sm",variant:"secondary",onClick:pd,children:(0,t.jsx)(j.x6,{i18nKey:"explore.logs.scan-for-older-logs",children:"Scan for older logs"})})]})}),m&&(0,t.jsx)("div",{className:te.logRows,children:(0,t.jsxs)("div",{className:te.noData,children:[(0,t.jsx)("span",{children:ed}),(0,t.jsx)(Q.$n,{size:"sm",variant:"secondary",onClick:hd,children:(0,t.jsx)(j.x6,{i18nKey:"explore.logs.stop-scan",children:"Stop scan"})})]})}),(0,t.jsx)(Wi,{logsSortOrder:ye,visibleRange:Td??x,absoluteRange:x,timeZone:g,onChangeTime:b,loading:d,queries:R??[],scrollToTopLogs:bd,addResultsToCache:L,clearCache:v})]})]})]})},ma=(0,k.cV)(fa),ya=(e,s,n)=>({noData:(0,h.css)({"& > *":{marginLeft:"0.5em"}}),logOptions:(0,h.css)({display:"flex",justifyContent:"space-between",alignItems:"baseline",flexWrap:"wrap",backgroundColor:e.colors.background.primary,padding:`${e.spacing(1)} ${e.spacing(2)}`,borderRadius:e.shape.radius.default,margin:`${e.spacing(0,0,1)}`,border:`1px solid ${e.colors.border.medium}`}),headerButton:(0,h.css)({margin:`${e.spacing(.5,0,0,1)}`}),horizontalInlineLabel:(0,h.css)({"& > label":{marginRight:"0"}}),horizontalInlineSwitch:(0,h.css)({padding:`0 ${e.spacing(1)} 0 0`}),radioButtons:(0,h.css)({margin:"0"}),logsSection:(0,h.css)({display:"flex",flexDirection:"row",justifyContent:"space-between",position:"relative"}),logsTable:(0,h.css)({maxHeight:`${n}px`}),scrollableLogRows:(0,h.css)({overflowY:"scroll",width:"100%",maxHeight:"75vh"}),logRows:(0,h.css)({overflowX:`${s?"unset":"scroll"}`,overflowY:"visible",width:"100%"}),visualisationType:(0,h.css)({display:"flex",flex:"1",justifyContent:"space-between"}),visualisationTypeRadio:(0,h.css)({margin:`0 0 0 ${e.spacing(1)}`}),stickyNavigation:(0,h.css)({overflow:"visible",...U.$.featureToggles.logsInfiniteScrolling&&{marginBottom:"0px"}})}),xa=(0,vt.A)(e=>e.some(s=>s.hasUnescapedContent)),va=(0,vt.A)((e,s)=>{const n=(0,lt.M0)(e,s),o=n.reduce((r,i)=>i.duplicates?r+i.duplicates:r,0);return{dedupedRows:n,dedupCount:o}}),ba=(0,vt.A)((e,s)=>(0,lt.ct)(e,new Set(s))),Sa=(0,vt.A)(e=>{if(!e||e.length===0)return;const s=e[0].timeEpochMs,n=e[e.length-1].timeEpochMs;return n<s?{from:n,to:s}:{from:s,to:n}}),ks=500,Ps=100,Ca=(0,vt.A)(()=>({logsEnter:(0,h.css)`
      label: logsEnter;
      position: absolute;
      opacity: 0;
      height: auto;
      width: 100%;
    `,logsEnterActive:(0,h.css)`
      label: logsEnterActive;
      opacity: 1;
      transition: opacity ${ks}ms ease-out ${Ps}ms;
    `,logsExit:(0,h.css)`
      label: logsExit;
      position: absolute;
      opacity: 1;
      height: auto;
      width: 100%;
    `,logsExitActive:(0,h.css)`
      label: logsExitActive;
      opacity: 0;
      transition: opacity ${ks}ms ease-out ${Ps}ms;
    `}));function Jn(e){const{visible:s,children:n}=e,o=(0,u.useRef)(null),r=Ca();return(0,t.jsx)(xn.A,{in:s,mountOnEnter:!0,unmountOnExit:!0,timeout:ks+Ps,classNames:{enter:r.logsEnter,enterActive:r.logsEnterActive,exit:r.logsExit,exitActive:r.logsExitActive},nodeRef:o,children:(0,t.jsx)("div",{ref:o,children:n})})}class ja extends u.PureComponent{constructor(){super(...arguments),this.state={dsInstances:{}},this.onChangeTime=s=>{const{exploreId:n,updateTimeRange:o}=this.props;o({exploreId:n,absoluteRange:s})},this.loadMoreLogs=s=>{const{exploreId:n,loadMoreLogs:o}=this.props;o({exploreId:n,absoluteRange:s})},this.getLogRowContext=async(s,n,o)=>{const{logsQueries:r}=this.props;if(!n.dataFrame.refId||!this.state.dsInstances[n.dataFrame.refId])return Promise.resolve([]);const i=this.state.dsInstances[n.dataFrame.refId];if(!(0,ne.Ol)(i))return Promise.resolve([]);const a=this.getQuery(r,n,i);return a?i.getLogRowContext(s,o,a):Promise.resolve([])},this.getLogRowContextQuery=async(s,n,o=!0)=>{const{logsQueries:r}=this.props;if(!s.dataFrame.refId||!this.state.dsInstances[s.dataFrame.refId])return Promise.resolve(null);const i=this.state.dsInstances[s.dataFrame.refId];if(!(0,ne.Ol)(i))return Promise.resolve(null);const a=this.getQuery(r,s,i);return a&&i.getLogRowContextQuery?i.getLogRowContextQuery(s,n,a,o):Promise.resolve(null)},this.getLogRowContextUi=(s,n)=>{const{logsQueries:o}=this.props;if(!s.dataFrame.refId||!this.state.dsInstances[s.dataFrame.refId])return(0,t.jsx)(t.Fragment,{});const r=this.state.dsInstances[s.dataFrame.refId];if(!(0,ne.Ol)(r))return(0,t.jsx)(t.Fragment,{});const i=this.getQuery(o,s,r);return i&&(0,ne.wj)(r)&&r.getLogRowContextUi?r.getLogRowContextUi(s,n,i):(0,t.jsx)(t.Fragment,{})},this.showContextToggle=s=>!s?.dataFrame.refId||!this.state.dsInstances[s.dataFrame.refId]?!1:(0,ne.Ol)(this.state.dsInstances[s.dataFrame.refId]),this.getFieldLinks=(s,n,o)=>{const{splitOpenFn:r,range:i}=this.props;return(0,et.QL)({field:s,rowIndex:n,splitOpenFn:r,range:i,dataFrame:o})},this.logDetailsFilterAvailable=()=>Object.values(this.state.dsInstances).some(s=>s?.modifyQuery||(0,ne._0)(s)||(0,ne.FP)(s)),this.filterValueAvailable=()=>Object.values(this.state.dsInstances).some(s=>(0,ne._0)(s)&&s?.getSupportedQueryModifications().includes("ADD_STRING_FILTER")),this.filterOutValueAvailable=()=>Object.values(this.state.dsInstances).some(s=>(0,ne._0)(s)&&s?.getSupportedQueryModifications().includes("ADD_STRING_FILTER_OUT")),this.addResultsToCache=()=>{this.props.addResultsToCache(this.props.exploreId)},this.clearCache=()=>{this.props.clearCache(this.props.exploreId)}}componentDidMount(){this.updateDataSourceInstances()}componentDidUpdate(s){s.logsQueries!==this.props.logsQueries&&this.updateDataSourceInstances()}updateDataSourceInstances(){const{logsQueries:s,datasourceInstance:n}=this.props;if(!s||!n)return;const o={};if(n.uid!==Nt.uv){s.forEach(({refId:i})=>{o[i]=n}),this.setState({dsInstances:o});return}const r=[];for(const i of s){if(!i.datasource)continue;(!o[i.refId]||o[i.refId].uid!==i.datasource.uid)&&r.push(new Promise(l=>{(0,Ae.l)().get(i.datasource).then(d=>{l({ds:d,refId:i.refId})})}))}r.length&&Promise.all(r).then(i=>{i.forEach(({ds:a,refId:l})=>{o[l]=a}),this.setState({dsInstances:o})})}getQuery(s,n,o){return(s??[]).find(r=>r.refId===n.dataFrame.refId&&r.datasource!=null&&r.datasource.type===o.type)}render(){const{loading:s,loadingState:n,logRows:o,logsMeta:r,logsSeries:i,logsQueries:a,loadSupplementaryQueryData:l,setSupplementaryQueryEnabled:d,onClickFilterLabel:f,onClickFilterOutLabel:c,onStartScanning:g,onStopScanning:m,absoluteRange:y,timeZone:C,visibleRange:x,scanning:b,range:S,width:w,splitOpenFn:R,isLive:v,exploreId:L,logsVolume:T,scrollElement:F,onPinLineCallback:N}=this.props;return o?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(Jn,{visible:v,children:(0,t.jsx)(Ut.S,{label:"Logs",loading:!1,isOpen:!0,children:(0,t.jsx)(Cn,{exploreId:L,children:P=>(0,t.jsx)(ci,{logRows:o,timeZone:C,stopLive:P.stop,isPaused:this.props.isPaused,onPause:P.pause,onResume:P.resume,onClear:P.clear,clearedAtIndex:this.props.clearedAtIndex})})})}),(0,t.jsx)(Jn,{visible:!v,children:(0,t.jsx)(ma,{exploreId:L,datasourceType:this.props.datasourceInstance?.type,logRows:o,logsMeta:r,logsSeries:i,logsVolumeEnabled:T.enabled,onSetLogsVolumeEnabled:P=>d(L,P,ne.cF.LogsVolume),logsVolumeData:T.data,logsQueries:a,width:w,splitOpen:R,loading:s,loadingState:n,loadLogsVolumeData:()=>l(L,ne.cF.LogsVolume),onChangeTime:this.onChangeTime,loadMoreLogs:this.loadMoreLogs,onClickFilterLabel:this.logDetailsFilterAvailable()?f:void 0,onClickFilterOutLabel:this.logDetailsFilterAvailable()?c:void 0,onStartScanning:g,onStopScanning:m,absoluteRange:y,visibleRange:x,timeZone:C,scanning:b,scanRange:S.raw,showContextToggle:this.showContextToggle,getRowContext:this.getLogRowContext,getRowContextQuery:this.getLogRowContextQuery,getLogRowContextUi:this.getLogRowContextUi,getFieldLinks:this.getFieldLinks,addResultsToCache:this.addResultsToCache,clearCache:this.clearCache,eventBus:this.props.eventBus,panelState:this.props.panelState,logsFrames:this.props.logsFrames,scrollElement:F,isFilterLabelActive:this.logDetailsFilterAvailable()?this.props.isFilterLabelActive:void 0,range:S,onPinLineCallback:N,onClickFilterString:this.filterValueAvailable()?this.props.onClickFilterString:void 0,onClickFilterOutString:this.filterOutValueAvailable()?this.props.onClickFilterOutString:void 0})})]}):null}}function Ra(e,{exploreId:s}){const o=e.explore.panes[s],{logsResult:r,scanning:i,datasourceInstance:a,isLive:l,isPaused:d,clearedAtIndex:f,range:c,absoluteRange:g,supplementaryQueries:m}=o,y=(0,Z.h1)(s)(e),C=o.panelsState,x=(0,Qt.O)(e.user),b=m[ne.cF.LogsVolume];return{loading:y,logRows:r?.rows,logsMeta:r?.meta,logsSeries:r?.series,logsQueries:r?.queries,visibleRange:r?.visibleRange,scanning:i,timeZone:x,datasourceInstance:a,isLive:l,isPaused:d,clearedAtIndex:f,range:c,absoluteRange:g,logsVolume:b,panelState:C,logsFrames:o.queryResponse.logsFrames}}const Ta={updateTimeRange:we.GH,loadMoreLogs:we.zY,addResultsToCache:Z.He,clearCache:Z.IL,loadSupplementaryQueryData:Z.Az,setSupplementaryQueryEnabled:Z.TO},wa=(0,Ie.connect)(Ra,Ta)(ja);function La(e){const{queryResponse:s,timeZone:n,enabled:o,setLogsSampleEnabled:r,datasourceInstance:i,queries:a,splitOpen:l}=e,d=(0,k.of)(Ia),f=m=>{r(m),(0,D.rR)("grafana_explore_logs_sample_toggle_clicked",{datasourceType:i?.type??"unknown",type:m?"open":"close"})},c=()=>{if(!i||!(0,ne.Nc)(i,ne.cF.LogsSample))return null;const m=a.map(C=>i.getSupplementaryQuery({type:ne.cF.LogsSample},C)).filter(C=>!!C);if(!m.length)return null;const y=()=>{l({queries:m,datasourceUid:i.uid}),(0,D.rR)("grafana_explore_logs_sample_split_button_clicked",{datasourceType:i?.type??"unknown",queriesCount:m.length})};return(0,t.jsx)(Q.$n,{size:"sm",className:d.logSamplesButton,onClick:y,children:"Open logs in split view"})};let g;if(s===void 0)g=null;else if(s.error!==void 0)g=(0,t.jsx)(Ds,{error:s.error,title:"Failed to load logs sample for this query"});else if(s.state===Re.Gu.Loading)g=(0,t.jsx)("span",{children:"Logs sample is loading..."});else if(s.data.length===0||s.data.every(m=>m.length===0))g=(0,t.jsx)("span",{children:"No logs sample data."});else{const m=(0,lt.HT)(s.data);g=(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(c,{}),(0,t.jsx)("div",{className:d.logContainer,children:(0,t.jsx)(Dn.k,{logRows:m.rows,dedupStrategy:Y.fY.none,showLabels:fe.A.getBool(me.$.showLabels,!1),showTime:fe.A.getBool(me.$.showTime,!0),wrapLogMessage:fe.A.getBool(me.$.wrapLogMessage,!0),prettifyLogMessage:fe.A.getBool(me.$.prettifyLogMessage,!1),timeZone:n,enableLogDetails:!0})})]})}return s?.state!==Re.Gu.NotStarted?(0,t.jsx)(Ut.S,{label:(0,t.jsxs)("div",{children:["Logs sample",(0,t.jsx)(xe.m,{content:"Show log lines that contributed to visualized metrics",children:(0,t.jsx)(de.I,{name:"info-circle",className:d.infoTooltip})})]}),isOpen:o,collapsible:!0,onToggle:f,children:g}):null}const Ia=e=>({logSamplesButton:(0,h.css)`
      position: absolute;
      top: ${e.spacing(1)};
      right: ${e.spacing(1)};
    `,logContainer:(0,h.css)`
      overflow: scroll;
    `,infoTooltip:(0,h.css)`
      margin-left: ${e.spacing(1)};
    `}),Ea=()=>{const e=(0,k.of)(Oa);return(0,t.jsx)(t.Fragment,{children:(0,t.jsx)(gs._,{"data-testid":"explore-no-data",className:e.wrapper,children:(0,t.jsx)("span",{className:e.message,children:"No data"})})})},Oa=e=>({wrapper:(0,h.css)({label:"no-data-card",padding:e.spacing(3),background:e.colors.background.primary,borderRadius:e.shape.radius.default,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",flexGrow:1}),message:(0,h.css)({fontSize:e.typography.h2.fontSize,padding:e.spacing(4),color:e.colors.text.disabled})});var Fa=p(76442);function Da(e){return(0,h.css)({maxWidth:`${e.breakpoints.values.lg}px`,marginTop:e.spacing(2),alignSelf:"center"})}const Aa=()=>{const e=(0,k.of)(Da),s=Ss.TP.hasPermission(A.AccessControlAction.DataSourcesCreate)&&Ss.TP.hasPermission(A.AccessControlAction.DataSourcesWrite),n="Explore requires at least one data source. Once you have added a data source, you can query it here.",o=(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(de.I,{name:"rocket"}),(0,t.jsx)(t.Fragment,{children:" ProTip: You can also define data sources through configuration files. "}),(0,t.jsx)("a",{href:"http://docs.grafana.org/administration/provisioning/?utm_source=explore#data-sources",target:"_blank",rel:"noreferrer",className:"text-link",children:"Learn more"})]}),r=(0,t.jsx)(Q.z9,{size:"lg",href:"datasources/new",icon:"database",disabled:!s,children:"Add data source"});return(0,t.jsx)(Fa.c,{callToActionElement:r,className:e,footer:o,message:n})};var Ms=p(52908),Na=p(95511),ka=p(94382);const Pa=e=>({warningText:(0,h.css)`
    label: warningText;
    display: flex;
    align-items: center;
    font-size: ${e.typography.bodySmall.fontSize};
    color: ${e.colors.text.secondary};
  `});function Ma(e){const{dataFrames:s,range:n,splitOpenFn:o,withTraceView:r,datasourceType:i}=e,a=(0,et.JQ)(n,o),l=(0,k.$j)(),d=(0,k.of)(Pa),f=(0,_t.we)({fieldConfig:{defaults:{},overrides:[]},data:s,replaceVariables:v=>v,theme:l}),{nodes:c}=(0,ka.d)(f),[g,m]=(0,an.A)(!0),y=()=>{m(),(0,D.rR)("grafana_traces_node_graph_panel_clicked",{datasourceType:i,grafana_version:U.$.buildInfo.version,isExpanded:!open})},{height:C}=(0,Ms.A)(),x=(0,u.useRef)(null),[b,S]=(0,u.useState)(250);(0,u.useEffect)(()=>{if(x.current){const{top:v}=x.current.getBoundingClientRect();S(v)}},[x]);const w=C-b-32,R=r&&c[0]?.length>1e3?(0,t.jsxs)("span",{className:d.warningText,children:[" (",c[0].length," nodes, can be slow to load)"]}):null;return(0,t.jsx)(Qe.NR,{title:"Node graph",titleItems:R,collapsible:!!r,collapsed:r?g:!1,onToggleCollapse:r?y:void 0,children:(0,t.jsx)("div",{ref:x,style:r?{height:500}:{minHeight:600,height:w},children:(0,t.jsx)(Na.F,{dataFrames:f,getLinks:a})})})}function $a(e,{exploreId:s}){return{range:e.explore.panes[s].range}}const za=(0,Ie.connect)($a,{})(Ma);var Rt=p(25508),Ba=p(77789),Xn=p(31193),Ha=p(44932);const Qa=e=>{const s=(0,_.qq)(e);return{getQueries:(0,Rt.Mz)(s,n=>n.queries),getQueryResponse:(0,Rt.Mz)(s,n=>n.queryResponse),getHistory:(0,Rt.Mz)(s,n=>n.history),getEventBridge:(0,Rt.Mz)(s,n=>n.eventBridge),getDatasourceInstanceSettings:(0,Rt.Mz)(s,n=>(0,Xn.tR)().getInstanceSettings(n.datasourceInstance?.uid))}},Wa=({exploreId:e})=>{const s=(0,A.useDispatch)(),{getQueries:n,getDatasourceInstanceSettings:o,getQueryResponse:r,getHistory:i,getEventBridge:a}=(0,u.useMemo)(()=>Qa(e),[e]),l=(0,A.useSelector)(n),d=(0,A.useSelector)(o),f=(0,A.useSelector)(r),c=(0,A.useSelector)(i),g=(0,A.useSelector)(a),m=(0,u.useCallback)(()=>{s((0,Z.Od)({exploreId:e}))},[s,e]),y=(0,u.useCallback)(w=>{s((0,Z.bO)({exploreId:e,queries:w}))},[s,e]),C=(0,u.useCallback)(w=>{y([...l,{...w,refId:(0,Ba.M)(l)}])},[y,l]),x=()=>{(0,D.rR)("grafana_explore_query_row_copy")},b=()=>{(0,D.rR)("grafana_explore_query_row_remove")},S=w=>{(0,D.rR)("grafana_query_row_toggle",w===void 0?{}:{queryEnabled:w})};return(0,t.jsx)(Ha.L,{dsSettings:d,queries:l,onQueriesChange:y,onAddQuery:C,onRunQueries:m,onQueryCopied:x,onQueryRemoved:b,onQueryToggled:S,data:f,app:ge.Jk.Explore,history:c,eventBus:g,queryRowWrapper:(w,R)=>(0,t.jsx)(Ee,{title:R,icon:"arrow",panelId:"Queries",customTopOffset:-10,level:"child",children:w},R)})};var ts=p(72574),$s=p(2913),Va=p(15054),qa=p(91793),Ua=p(9651),Ga=p(9663),_n=p(57408);const Tt={wrapper:(0,h.css)`
    height: 100%;
    overflow: scroll;
  `,switchWrapper:(0,h.css)`
    display: flex;
    flex-direction: row;
    margin-bottom: 0;
  `,switchLabel:(0,h.css)`
    margin-left: 15px;
    margin-bottom: 0;
  `,switch:(0,h.css)`
    margin-left: 10px;
  `,resultCount:(0,h.css)`
    margin-bottom: 4px;
  `,header:(0,h.css)`
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    font-size: 12px;
    line-height: 1.25;
  `},Ka=480,Ya=2,Za=e=>{const{tableResult:s}=e,n=(0,ie.cloneDeep)(s),o=(0,u.useRef)(null),r=n.fields.filter(y=>y.name.includes("Value")),i=(0,_n.E)(n),{width:a}=(0,Ms.A)(),[l,d]=(0,u.useState)(a<=Ka||r.length>Ya),f=()=>{d(!l);const y={isExpanded:!l};(0,D.rR)("grafana_explore_prometheus_instant_query_ui_raw_toggle_expand",y)};(0,u.useEffect)(()=>{o.current?.resetAfterIndex(0,!0)},[l]);const c=y=>{if(y<10){let b=0;for(let S=0;S<y;S++)b+=g(S,!0);return Math.min(600,b)}return 600},g=(y,C)=>{if(!C)return 32;const S=i[y];return 1.5*32+(Object.keys(S).length-r.length)*22},m=`isExpandedView ${(0,u.useId)()}`;return(0,t.jsxs)("section",{children:[(0,t.jsxs)("header",{className:Tt.header,children:[(0,t.jsx)(ve.D,{className:Tt.switchWrapper,label:"Expand results",htmlFor:"isExpandedView",children:(0,t.jsx)("div",{className:Tt.switch,children:(0,t.jsx)(Ke.d,{onChange:f,id:m,value:l,label:"Expand results"})})}),(0,t.jsxs)("div",{className:Tt.resultCount,children:["Result series: ",i.length]})]}),(0,t.jsx)("div",{role:"table",children:(0,t.jsxs)(t.Fragment,{children:[r.length>1&&!l&&(0,t.jsx)(Ua.d,{valueLabels:r,expanded:l}),(0,t.jsx)(qa._m,{ref:o,itemCount:i.length,className:Tt.wrapper,itemSize:y=>g(y,l),height:c(i.length),width:"100%",children:({index:y,style:C})=>{let x;return l&&(x=r.filter(b=>{const S=i[y][b.name];return S&&S!==_n.M})),(0,t.jsx)("div",{role:"row",style:{...C,overflow:"hidden"},children:(0,t.jsx)(Ga.Ay,{isExpandedView:l,valueLabels:x,totalNumberOfValues:r.length,listKey:i[y].__name__,listItemData:i[y]})})}})]})})]})};function Ja(e,{exploreId:s}){const o=e.explore.panes[s],{tableResult:r,rawPrometheusResult:i,range:a,queryResponse:l}=o,d=i?[i]:[],f=(r?.length??0)>0&&i?r:d;return{loading:l.state,tableResult:f,range:a}}const Xa=(0,Ie.connect)(Ja,{});class _a extends u.PureComponent{constructor(s){super(s),this.onChangeResultsStyle=n=>{this.setState({resultsStyle:n})},this.renderLabel=()=>{const n=(0,h.css)({display:"flex",justifyContent:"space-between",flex:"1"}),o=bs.jH.map(r=>({value:r,label:r[0].toUpperCase()+r.slice(1).replace(/_/," ")}));return(0,t.jsx)("div",{className:n,children:(0,t.jsx)(St.z,{onClick:()=>{const r={state:this.state.resultsStyle===A.TABLE_RESULTS_STYLE.table?A.TABLE_RESULTS_STYLE.raw:A.TABLE_RESULTS_STYLE.table};(0,D.rR)("grafana_explore_prometheus_instant_query_ui_toggle_clicked",r)},size:"sm",options:o,value:this.state?.resultsStyle,onChange:this.onChangeResultsStyle})})},s.showRawPrometheus&&(this.state={resultsStyle:A.TABLE_RESULTS_STYLE.raw})}getTableHeight(){const{tableResult:s}=this.props;return!s||s.length===0?200:Math.max(Math.min(600,s[0].length*35)+35)}render(){const{loading:s,onCellFilterAdded:n,tableResult:o,width:r,splitOpenFn:i,range:a,ariaLabel:l,timeZone:d}=this.props,f=this.getTableHeight(),c=r-$s.$W.theme.panelPadding*2-Va.IZ;let g=o;const m=(0,et.YV)(i,a);g?.length&&(g=(0,_t.we)({data:g,timeZone:d,theme:$s.$W.theme2,replaceVariables:(0,ts.w)().replace.bind((0,ts.w)()),fieldConfig:{defaults:{},overrides:[]},dataLinkPostProcessor:m}));const y=g?.filter(S=>!!S&&S.length!==0),C=this.state.resultsStyle===A.TABLE_RESULTS_STYLE.raw?"Raw":"Table",x=this.state?.resultsStyle!==void 0?this.renderLabel():"Table",b=!this.state?.resultsStyle||this.state?.resultsStyle===A.TABLE_RESULTS_STYLE.table;return(0,t.jsxs)(Qe.NR,{title:C,actions:x,loadingState:s,children:[y?.length&&(0,t.jsxs)(t.Fragment,{children:[b&&(0,t.jsx)(Es.X,{ariaLabel:l,data:y[0],width:c,height:f,onCellFilterAdded:n}),this.state?.resultsStyle===A.TABLE_RESULTS_STYLE.raw&&(0,t.jsx)(Za,{tableResult:y[0]})]}),!y?.length&&(0,t.jsx)(Is,{metaItems:[{value:"0 series returned"}]})]})}}const el=Xa(_a);var tl=p(22669);const sl=e=>{const s=(0,u.useRef)(null),n={transition:`opacity ${e.duration}ms linear`,opacity:0},o={exited:{opacity:0,display:"none"},entering:{opacity:0},entered:{opacity:1},exiting:{opacity:0}};return(0,t.jsx)(tl.Ay,{in:e.in,timeout:e.duration,unmountOnExit:e.unmountOnExit||!1,onExited:e.onExited,nodeRef:s,children:r=>(0,t.jsx)("div",{ref:s,style:{...n,...o[r]},children:e.children})})},nl=e=>{const{queryError:s}=e,n=!!s,o=n?100:10,r=s?"Query error":"Unknown error",i=s?.message||s?.data?.message||null;return(0,t.jsx)(sl,{in:n,duration:o,children:(0,t.jsx)(yt.F,{severity:"error",title:r,topSpacing:2,children:i})})};function ol(e){const s=(0,A.useSelector)(o=>o.explore.panes[e.exploreId].queryResponse),n=s?.state===Re.Gu.Error?s?.error:void 0;return n?.refId?null:(0,t.jsx)(nl,{queryError:n})}var rl=p(13390);const il=e=>({containerMargin:(0,h.css)({display:"flex",flexWrap:"wrap",gap:e.spacing(1),marginTop:e.spacing(2)})});function al(e){const s=(0,k.$j)(),n=il(s),{drawerOpened:o,setDrawerOpened:r,queryLibraryAvailable:i}=at(),a=!e.richHistoryRowButtonHidden&&!i;return(0,t.jsxs)("div",{className:n.containerMargin,children:[!e.addQueryRowButtonHidden&&(0,t.jsx)(ue.I,{variant:"canvas","aria-label":(0,j.t)("explore.secondary-actions.query-add-button-aria-label","Add query"),onClick:e.onClickAddQueryRowButton,disabled:e.addQueryRowButtonDisabled,icon:"plus",children:(0,t.jsx)(j.x6,{i18nKey:"explore.secondary-actions.query-add-button",children:"Add query"})}),a&&(0,t.jsx)(ue.I,{variant:o?"active":"canvas","aria-label":(0,j.t)("explore.secondary-actions.query-history-button-aria-label","Query history"),onClick:()=>r(!o),"data-testid":rl.X.QueryTab.queryHistoryButton,icon:"history",children:(0,t.jsx)(j.x6,{i18nKey:"explore.secondary-actions.query-history-button",children:"Query history"})}),(0,t.jsx)(ue.I,{variant:e.queryInspectorButtonActive?"active":"canvas","aria-label":(0,j.t)("explore.secondary-actions.query-inspector-button-aria-label","Query inspector"),onClick:e.onClickQueryInspectorButton,icon:"info-circle",children:(0,t.jsx)(j.x6,{i18nKey:"explore.secondary-actions.query-inspector-button",children:"Query inspector"})})]})}var eo=p(65885);function ll(e,{exploreId:s}){const o=e.explore.panes[s],{tableResult:r,range:i}=o,a=(0,Z.h1)(s);return{loading:r&&r.length>0?!1:a,tableResult:r,range:i}}const cl=(0,Ie.connect)(ll,{});class to extends u.PureComponent{constructor(){super(...arguments),this.hasSubFrames=s=>s.fields.some(n=>n.type===Ct.PU.nestedFrames)}getTableHeight(s,n){return s===0?200:Math.min(600,Math.max(s*36,n?300:0)+40+46)}getTableTitle(s,n,o){let r=n.name;return!r&&(s?.length??0)>1&&(r=n.refId||`${o}`),r?(0,j.t)("explore.table.title-with-name","Table - {{name}}",{name:r,interpolation:{escapeValue:!1}}):(0,j.t)("explore.table.title","Table")}render(){const{loading:s,onCellFilterAdded:n,tableResult:o,width:r,splitOpenFn:i,range:a,ariaLabel:l,timeZone:d,theme:f}=this.props;let c=(0,eo.gy)(o)?(0,eo.S5)(o):o;const g=(0,et.YV)(i,a);c?.length&&(c=(0,_t.we)({data:c,timeZone:d,theme:$s.$W.theme2,replaceVariables:(0,ts.w)().replace.bind((0,ts.w)()),fieldConfig:{defaults:{},overrides:[]},dataLinkPostProcessor:g}));const m=c?.filter(y=>!!y&&y.length!==0);return(0,t.jsxs)(t.Fragment,{children:[m&&m.length===0&&(0,t.jsx)(Qe.NR,{title:(0,j.t)("explore.table.title","Table"),width:r,height:200,children:()=>(0,t.jsx)(Is,{metaItems:[{value:(0,j.t)("explore.table.no-data","0 series returned")}]})}),m&&m.length>0&&(0,t.jsx)("div",{className:(0,h.css)({display:"flex",flexDirection:"column",gap:f.spacing(1)}),children:m.map((y,C)=>(0,t.jsx)(Qe.NR,{title:this.getTableTitle(c,y,C),width:r,height:this.getTableHeight(y.length,this.hasSubFrames(y)),loadingState:s?Re.Gu.Loading:void 0,children:(x,b)=>(0,t.jsx)(Es.X,{ariaLabel:l,data:y,width:x,height:b,onCellFilterAdded:n})},y.refId||`table-${C}`))})]})}}const Fd=(0,k.cV)(to),dl=(0,k.cV)(cl(to));var ul=p(92599),pl=p(35090);function hl(e){const s=e.dataFrames[0],{dataFrames:n,splitOpenFn:o,exploreId:r,scrollElement:i}=e,a=(0,u.useMemo)(()=>(0,pl.L)(s),[s]),l=(0,A.useSelector)(d=>d.explore.panes[e.exploreId]?.datasourceInstance??void 0);return a?(0,t.jsx)(Qe.NR,{padding:"none",title:"Trace",children:(0,t.jsx)(ul.V,{exploreId:r,dataFrames:n,splitOpenFn:o,scrollElement:i,traceProp:a,datasource:l})}):null}const gl=e=>({exploreMain:(0,h.css)({label:"exploreMain",position:"relative",marginTop:"21px",display:"flex",flexDirection:"column",gap:e.spacing(1)}),queryContainer:(0,h.css)({label:"queryContainer",padding:e.spacing(1)}),exploreContainer:(0,h.css)({label:"exploreContainer",display:"flex",flexDirection:"column",paddingRight:e.spacing(2),marginBottom:e.spacing(2)}),wrapper:(0,h.css)({position:"absolute",top:0,left:e.spacing(2),right:0,bottom:0,display:"flex"})});class fl extends u.PureComponent{constructor(s){super(s),this.onChangeTime=n=>{const{updateTimeRange:o,exploreId:r}=this.props;o({exploreId:r,rawRange:n})},this.onClickExample=n=>{this.props.setQueries(this.props.exploreId,[n])},this.onCellFilterAdded=n=>{const{value:o,key:r,operator:i}=n;i===Ht.mc&&this.onClickFilterLabel(r,o),i===Ht.Zi&&this.onClickFilterOutLabel(r,o)},this.onContentOutlineToogle=()=>{Bt.M.set(Wt.visible,!this.state.contentOutlineVisible),this.setState(n=>((0,D.rR)("explore_toolbar_contentoutline_clicked",{item:"outline",type:n.contentOutlineVisible?"close":"open"}),{contentOutlineVisible:!n.contentOutlineVisible}))},this.isFilterLabelActive=async(n,o,r)=>{const i=this.props.queries.find(l=>l.refId===r);if(!i)return!1;const a=await(0,Ae.l)().get(i.datasource);return!!((0,ne.FP)(a)&&a.queryHasFilter(i,{key:n,value:o.toString()}))},this.onClickFilterLabel=(n,o,r)=>{this.onModifyQueries({type:"ADD_FILTER",options:{key:n,value:o.toString()},frame:r},r?.refId)},this.onClickFilterOutLabel=(n,o,r)=>{this.onModifyQueries({type:"ADD_FILTER_OUT",options:{key:n,value:o.toString()},frame:r},r?.refId)},this.onClickFilterString=(n,o)=>{this.onModifyQueries({type:"ADD_STRING_FILTER",options:{value:n.toString()}},o)},this.onClickFilterOutString=(n,o)=>{this.onModifyQueries({type:"ADD_STRING_FILTER_OUT",options:{value:n.toString()}},o)},this.onClickAddQueryRowButton=()=>{const{exploreId:n,queryKeys:o}=this.props;this.props.addQueryRow(n,o.length)},this.onModifyQueries=(n,o)=>{const r=async(i,a)=>{if(o&&o!==i.refId)return i;const{datasource:l}=i;if(l==null)return i;const d=await(0,Ae.l)().get(l),f=["ADD_FILTER","ADD_FILTER_OUT"];return(0,ne.FP)(d)&&f.includes(a.type)?d.toggleQueryFilter(i,{type:a.type==="ADD_FILTER"?"FILTER_FOR":"FILTER_OUT",options:a.options??{},frame:a.frame}):d.modifyQuery?d.modifyQuery(i,a):i};this.props.modifyQueries(this.props.exploreId,n,r)},this.onResize=n=>{this.props.changeSize(this.props.exploreId,n)},this.onStartScanning=()=>{this.props.scanStart(this.props.exploreId)},this.onStopScanning=()=>{this.props.scanStopAction({exploreId:this.props.exploreId})},this.onUpdateTimeRange=n=>{const{exploreId:o,updateTimeRange:r}=this.props;r({exploreId:o,absoluteRange:n})},this.onSplitOpen=n=>async o=>{if(this.props.splitOpen(o),o&&this.props.datasourceInstance){const r=(await(0,Ae.l)().get(o.datasourceUid)).type,i=this.props.datasourceInstance.uid===Nt.uv?(0,ie.get)(this.props.queries,"0.datasource.type"):this.props.datasourceInstance.type,a={origin:"panel",panelType:n,source:i,target:r,exploreId:this.props.exploreId};(0,D.rR)("grafana_explore_split_view_opened",a)}},this.state={contentOutlineVisible:Bt.M.getBool(Wt.visible,!0)},this.graphEventBus=s.eventBus.newScopedBus("graph",{onlyLocal:!1}),this.logsEventBus=s.eventBus.newScopedBus("logs",{onlyLocal:!1})}renderEmptyState(s){return(0,t.jsx)("div",{className:(0,h.cx)(s),children:(0,t.jsx)(Aa,{})})}renderNoData(){return(0,t.jsx)(Ea,{})}renderCustom(s){const{timeZone:n,queryResponse:o,eventBus:r}=this.props,i=(0,ie.groupBy)(o?.customFrames,"meta.preferredVisualisationPluginId");return Object.entries(i).map(([a,l],d)=>(0,t.jsx)(Ee,{panelId:a,title:a,icon:"plug",children:(0,t.jsx)(br,{timeZone:n,pluginId:a,frames:l,state:o.state,timeRange:o.timeRange,height:400,width:s,splitOpenFn:this.onSplitOpen(a),eventBus:r},d)},d))}renderGraphPanel(s){const{graphResult:n,timeZone:o,queryResponse:r,showFlameGraph:i}=this.props;return(0,t.jsx)(Ee,{panelId:"Graph",title:"Graph",icon:"graph-bar",children:(0,t.jsx)(ei.y,{data:n,height:i?180:400,width:s,timeRange:r.timeRange,timeZone:o,onChangeTime:this.onUpdateTimeRange,annotations:r.annotations,splitOpenFn:this.onSplitOpen("graph"),loadingState:r.state,eventBus:this.graphEventBus})})}renderTablePanel(s){const{exploreId:n,timeZone:o}=this.props;return(0,t.jsx)(Ee,{panelId:"Table",title:"Table",icon:"table",children:(0,t.jsx)(dl,{ariaLabel:pt.Tp.pages.Explore.General.table,width:s,exploreId:n,onCellFilterAdded:this.onCellFilterAdded,timeZone:o,splitOpenFn:this.onSplitOpen("table")})})}renderRawPrometheus(s){const{exploreId:n,datasourceInstance:o,timeZone:r}=this.props;return(0,t.jsx)(Ee,{panelId:"Raw Prometheus",title:"Raw Prometheus",icon:"gf-prometheus",children:(0,t.jsx)(el,{showRawPrometheus:!0,ariaLabel:pt.Tp.pages.Explore.General.table,width:s,exploreId:n,onCellFilterAdded:o?.modifyQuery?this.onCellFilterAdded:void 0,timeZone:r,splitOpenFn:this.onSplitOpen("table")})})}renderLogsPanel(s){const{exploreId:n,syncedTimes:o,theme:r,queryResponse:i}=this.props,a=parseInt(r.spacing(2).slice(0,-2),10),l=(0,h.css)({display:"flex",flexDirection:"column",gap:r.spacing(1)});return(0,t.jsx)(Ee,{panelId:"Logs",title:"Logs",icon:"gf-logs",className:l,children:(0,t.jsx)(wa,{exploreId:n,loadingState:i.state,syncedTimes:o,width:s-a,onClickFilterLabel:this.onClickFilterLabel,onClickFilterOutLabel:this.onClickFilterOutLabel,onStartScanning:this.onStartScanning,onStopScanning:this.onStopScanning,eventBus:this.logsEventBus,splitOpenFn:this.onSplitOpen("logs"),scrollElement:this.scrollElement,isFilterLabelActive:this.isFilterLabelActive,onClickFilterString:this.onClickFilterString,onClickFilterOutString:this.onClickFilterOutString,onPinLineCallback:()=>{this.setState({contentOutlineVisible:!0})}})})}renderLogsSamplePanel(){const{logsSample:s,timeZone:n,setSupplementaryQueryEnabled:o,exploreId:r,datasourceInstance:i,queries:a}=this.props;return(0,t.jsx)(Ee,{panelId:"Logs Sample",title:"Logs Sample",icon:"gf-logs",children:(0,t.jsx)(La,{queryResponse:s.data,timeZone:n,enabled:s.enabled,queries:a,datasourceInstance:i,splitOpen:this.onSplitOpen("logsSample"),setLogsSampleEnabled:l=>o(r,l,ne.cF.LogsSample)})})}renderNodeGraphPanel(){const{exploreId:s,showTrace:n,queryResponse:o,datasourceInstance:r}=this.props,i=r?r?.type:"unknown";return(0,t.jsx)(Ee,{panelId:"Node Graph",title:"Node Graph",icon:"code-branch",children:(0,t.jsx)(za,{dataFrames:o.nodeGraphFrames,exploreId:s,withTraceView:n,datasourceType:i,splitOpenFn:this.onSplitOpen("nodeGraph")})})}renderFlameGraphPanel(){const{queryResponse:s}=this.props;return(0,t.jsx)(Ee,{panelId:"Flame Graph",title:"Flame Graph",icon:"fire",children:(0,t.jsx)(Xr,{dataFrames:s.flameGraphFrames})})}renderTraceViewPanel(){const{queryResponse:s,exploreId:n}=this.props,o=s.series.filter(r=>r.meta?.preferredVisualisationType==="trace");return o.length&&(0,t.jsx)(Ee,{panelId:"Traces",title:"Traces",icon:"file-alt",children:(0,t.jsx)(hl,{exploreId:n,dataFrames:o,splitOpenFn:this.onSplitOpen("traceView"),scrollElement:this.scrollElement})})}render(){const{datasourceInstance:s,exploreId:n,graphResult:o,queryResponse:r,isLive:i,theme:a,showMetrics:l,showTable:d,showRawPrometheus:f,showLogs:c,showTrace:g,showCustom:m,showNodeGraph:y,showFlameGraph:C,showLogsSample:x,correlationEditorDetails:b,correlationEditorHelperData:S,showQueryInspector:w,setShowQueryInspector:R}=this.props,{contentOutlineVisible:v}=this.state,L=gl(a),T=r&&r.state!==Re.Gu.NotStarted,F=!(0,gt.gQ)().queryHistoryAvailable,N=r.state===Re.Gu.Done&&[r.logsFrames,r.graphFrames,r.nodeGraphFrames,r.flameGraphFrames,r.tableFrames,r.rawPrometheusFrames,r.traceFrames,r.customFrames].every(q=>q.length===0);let P;const H=b?.editorMode;return!!(H||b?.correlationDirty)&&S!==void 0&&(P=(0,t.jsx)(gr,{exploreId:n,correlations:S})),(0,t.jsxs)(nr,{refreshDependencies:this.props.queries,children:[(0,t.jsx)(Zr,{exploreId:n,onChangeTime:this.onChangeTime,onContentOutlineToogle:this.onContentOutlineToogle,isContentOutlineOpen:v}),(0,t.jsx)("div",{style:{position:"relative",height:"100%",paddingLeft:a.spacing(2)},children:(0,t.jsxs)("div",{className:L.wrapper,children:[v&&(0,t.jsx)(ir,{scroller:this.scrollElement,panelId:`content-outline-container-${n}`}),(0,t.jsx)(zt.E,{testId:pt.Tp.pages.Explore.General.scrollView,scrollRefCallback:q=>this.scrollElement=q||void 0,hideHorizontalTrack:!0,children:(0,t.jsx)("div",{className:L.exploreContainer,children:s?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(Ee,{panelId:"Queries",title:"Queries",icon:"arrow",mergeSingleChild:!0,children:(0,t.jsxs)(gs._,{className:L.queryContainer,children:[P,(0,t.jsx)(Wa,{exploreId:n}),(0,t.jsx)(al,{addQueryRowButtonDisabled:i||H&&s.meta.mixed,addQueryRowButtonHidden:!1,richHistoryRowButtonHidden:F,queryInspectorButtonActive:w,onClickAddQueryRowButton:this.onClickAddQueryRowButton,onClickQueryInspectorButton:()=>R(!w)}),(0,t.jsx)(ol,{exploreId:n})]})}),(0,t.jsx)(_o.Ay,{onResize:this.onResize,disableHeight:!0,children:({width:q})=>q===0?null:(0,t.jsx)("main",{className:(0,h.cx)(L.exploreMain),style:{width:q},children:(0,t.jsx)(ae.Xw,{children:T&&(0,t.jsxs)(t.Fragment,{children:[l&&o&&(0,t.jsx)(ae.Xw,{children:this.renderGraphPanel(q)}),f&&(0,t.jsx)(ae.Xw,{children:this.renderRawPrometheus(q)}),d&&(0,t.jsx)(ae.Xw,{children:this.renderTablePanel(q)}),c&&(0,t.jsx)(ae.Xw,{children:this.renderLogsPanel(q)}),y&&(0,t.jsx)(ae.Xw,{children:this.renderNodeGraphPanel()}),C&&(0,t.jsx)(ae.Xw,{children:this.renderFlameGraphPanel()}),g&&(0,t.jsx)(ae.Xw,{children:this.renderTraceViewPanel()}),x&&(0,t.jsx)(ae.Xw,{children:this.renderLogsSamplePanel()}),m&&(0,t.jsx)(ae.Xw,{children:this.renderCustom(q)}),N&&(0,t.jsx)(ae.Xw,{children:this.renderNoData()})]})})})})]}):this.renderEmptyState(L.exploreContainer)})})]})})]})}}function ml(e,{exploreId:s}){const n=e.explore,{syncedTimes:o}=n,r=n.panes[s],i=(0,Qt.O)(e.user),{datasourceInstance:a,queryKeys:l,queries:d,isLive:f,graphResult:c,tableResult:g,logsResult:m,showLogs:y,showMetrics:C,showTable:x,showTrace:b,showCustom:S,queryResponse:w,showNodeGraph:R,showFlameGraph:v,showRawPrometheus:L,supplementaryQueries:T,correlationEditorHelperData:F}=r,N=(0,Z.h1)(s)(e),P=T[ne.cF.LogsSample],H=!!(P.dataProvider!==void 0&&!m&&(c||g));return{datasourceInstance:a,queryKeys:l,queries:d,isLive:f,graphResult:c,logsResult:m??void 0,queryResponse:w,syncedTimes:o,timeZone:i,showLogs:y,showMetrics:C,showTable:x,showTrace:b,showCustom:S,showNodeGraph:R,showRawPrometheus:L,showFlameGraph:v,splitted:(0,_.pF)(e),loading:N,logsSample:P,showLogsSample:H,correlationEditorHelperData:F,correlationEditorDetails:n.correlationEditorDetails}}const yl={changeSize:He.QZ,modifyQueries:Z.PD,scanStart:Z.GI,scanStopAction:Z.q9,setQueries:Z.Rk,updateTimeRange:we.GH,addQueryRow:Z._0,splitOpen:J.ve,setSupplementaryQueryEnabled:Z.TO},xl=(0,Ie.connect)(ml,yl),vl=(0,k.cV)(xl(fl));var so=p(60734),bl=p(61453),Sl=p(82344),Cl=p(61396),jl=p(32067),Rl=p(90820);function Tl(e){const{onClose:s,queryResponse:n,timeZone:o,isMixed:r,exploreId:i}=e,[a,l]=(0,u.useState)({withTransforms:!1,withFieldConfig:!0}),d=n?.series||[];let f=n?.errors;!f?.length&&n?.error&&(f=[n.error]);const c=(0,k.of)(Il);(0,u.useEffect)(()=>{(0,D.rR)("grafana_explore_query_inspector_opened")},[]);const g={label:"Stats",value:"stats",icon:"chart-line",content:(0,t.jsx)(jl.N,{data:n,timeZone:n?.request?.timezone??Y.vp})},m={label:"JSON",value:"json",icon:"brackets-curly",content:(0,t.jsx)(Cl.w,{data:n,onClose:s})},y={label:"Data",value:"data",icon:"database",content:(0,t.jsx)(bl.q,{data:d,dataName:"Explore",isLoading:n.state===Re.Gu.Loading,options:a,timeZone:o,app:ge.Jk.Explore,formattedDataDescription:"Matches the format in the panel",onOptionsChange:l})},C={label:"Query",value:"query",icon:"info-circle",content:(0,t.jsx)("div",{className:c.queryInspectorWrapper,children:(0,t.jsx)(Rl.e,{instanceId:r?(0,Nt.qM)(0,(0,ht.uq)(i)):(0,ht.uq)(i),data:n,onRefreshQuery:()=>e.runQueries({exploreId:i})})})},x=[g,C,m,y];if(f?.length){const b={label:"Error",value:"error",icon:"exclamation-triangle",content:(0,t.jsx)(Sl.y,{errors:f})};x.push(b)}return(0,t.jsx)(on,{children:(0,t.jsx)(so.q,{tabs:x,onClose:s,closeIconTooltip:"Close query inspector"})})}function wl(e,{exploreId:s}){const o=e.explore.panes[s],{queryResponse:r}=o;return{queryResponse:r,isMixed:o.datasourceInstance?.meta.mixed||!1}}const Ll={runQueries:Z.Od},Il=e=>({queryInspectorWrapper:(0,h.css)({paddingBottom:e.spacing(3)})}),El=(0,Ie.connect)(wl,Ll)(Tl),Ol=(0,h.css)({label:"explorePaneContainer",display:"flex",flexDirection:"column",minWidth:"600px",height:"100%"});function Fl({exploreId:e}){Nl(e);const s=(0,u.useRef)(new Xo.o),n=(0,u.useRef)(null),[o,r]=(0,u.useState)(!1);return(0,u.useEffect)(()=>{const i=s.current;return()=>i.removeAllListeners()},[]),(0,t.jsx)(zt.E,{hideVerticalTrack:!0,children:(0,t.jsxs)("div",{className:Ol,ref:n,"data-testid":pt.Tp.pages.Explore.General.container,children:[(0,t.jsx)(vl,{exploreId:e,eventBus:s.current,showQueryInspector:o,setShowQueryInspector:r}),o&&(0,t.jsx)(El,{exploreId:e,onClose:()=>r(!1),timeZone:(0,rn.O)()})]})})}function Dl(e,s){return{pane:e.explore.panes[s.exploreId]}}const Al=(0,Ie.connect)(Dl)(Fl);function Nl(e){const s=(0,u.useMemo)(()=>(0,_.qq)(e),[e]),n=(0,u.useRef)();n.current=(0,A.useSelector)(s),(0,u.useEffect)(()=>()=>{(0,ht._u)(n.current?.querySubscription)},[])}var ut=p(26272),be=p(3591),kl=p(55882),no=p(21744),pe=p(81523),Pl=p(2858),Ml=p(56389);const $l=()=>({kind:"DisplayList",apiVersion:"iam.grafana.app/v0alpha1",metadata:{},keys:["user:u000000001","user:u000000002"],display:[{identity:{type:"user",name:"u000000001"},displayName:"Test User1",avatarURL:"/avatar/46d229b033af06a191ff2267bca9ae56",internalId:1},{identity:{type:"user",name:"u000000002"},displayName:"Test User2",avatarURL:"/avatar/24c9e15e52afc47c225b757e7bee1f9d",internalId:2}]}),zl=()=>({kind:"QueryTemplateList",apiVersion:"peakq.grafana.app/v0alpha1",metadata:{resourceVersion:"1783293408052252672",remainingItemCount:0},items:[{kind:"QueryTemplate",apiVersion:"peakq.grafana.app/v0alpha1",metadata:{name:"AElastic2nkf9",generateName:"AElastic",namespace:"default",uid:"65327fce-c545-489d-ada5-16f909453d12",resourceVersion:"1783293341664808960",creationTimestamp:"2024-04-25T20:32:58Z",annotations:{"grafana.app/createdBy":"user:u000000001"}},spec:{title:"Elastic Query Template",targets:[{variables:{},properties:{refId:"A",datasource:{type:"elasticsearch",uid:"elastic-uid"},alias:"",metrics:[{id:"1",type:"count"}],bucketAggs:[{field:"@timestamp",id:"2",settings:{interval:"auto"},type:"date_histogram"}],timeField:"@timestamp",query:"test:test "}}]}},{kind:"QueryTemplate",apiVersion:"peakq.grafana.app/v0alpha1",metadata:{name:"ALoki296tj",generateName:"ALoki",namespace:"default",uid:"3e71de65-efa7-40e3-8f23-124212cca455",resourceVersion:"1783214217151647744",creationTimestamp:"2024-04-25T11:05:55Z",annotations:{"grafana.app/createdBy":"user:u000000001"}},spec:{title:"Loki Query Template",vars:[{key:"__value",defaultValues:[""],valueListDefinition:{customValues:""}}],targets:[{variables:{__value:[{path:"$.datasource.jsonData.derivedFields.0.url",position:{start:0,end:14},format:"raw"},{path:"$.datasource.jsonData.derivedFields.1.url",position:{start:0,end:14},format:"raw"},{path:"$.datasource.jsonData.derivedFields.2.url",position:{start:0,end:14},format:"raw"}]},properties:{refId:"A",datasource:{type:"loki",uid:"loki-uid"},queryType:"range",editorMode:"code",expr:'{test="test"}'}}]}}]}),oo={all:{url:Ml.C1,response:zl()},identityDisplay:{response:$l()}},{useAllQueryTemplatesQuery:Bl,useAddQueryTemplateMutation:Hl,useDeleteQueryTemplateMutation:Ql,useEditQueryTemplateMutation:Wl}=Pl.g;function Vl(){return U.$.featureToggles.queryLibrary}const Nd={data:oo.all},kd={data:oo.identityDisplay};function zs(e){const{value:s}=(0,mt.A)(async()=>await(0,Ae.l)().get(e),[e]);return s}const ql=[{value:"Public",label:(0,j.t)("explore.query-library.public","Public")},{value:"Private",label:(0,j.t)("explore.query-library.private","Private")}],Ul=e=>e?(0,j.t)("explore.query-template-modal.add-info","You're about to save this query. Once saved, you can easily access it in the Query Library tab for future use and reference."):(0,j.t)("explore.query-template-modal.edit-info","You're about to edit this query. Once saved, you can easily access it in the Query Library tab for future use and reference."),Bs=({onCancel:e,onSave:s,queryToAdd:n,templateData:o})=>{const{register:r,handleSubmit:i}=(0,ft.mN)({defaultValues:{description:o?.description}}),[a]=Hl(),[l]=Wl(),d=zs(n?.datasource),f=n!==void 0?[n]:o?.query!==void 0?[o?.query]:[],c=async C=>a(C).unwrap().then(()=>((0,be.J7)().publish({type:ut.r1.alertSuccess.name,payload:[(0,j.t)("explore.query-library.query-template-added","Query template successfully added to the library")]}),!0)).catch(()=>((0,be.J7)().publish({type:ut.r1.alertError.name,payload:[(0,j.t)("explore.query-library.query-template-add-error","Error attempting to add this query to the library")]}),!1)),g=async C=>l(C).unwrap().then(()=>((0,be.J7)().publish({type:ut.r1.alertSuccess.name,payload:[(0,j.t)("explore.query-library.query-template-edited","Query template successfully edited")]}),!0)).catch(()=>((0,be.J7)().publish({type:ut.r1.alertError.name,payload:[(0,j.t)("explore.query-library.query-template-edit-error","Error attempting to edit this query")]}),!1)),m=async C=>{const x=(0,Ue.KQ)().toISOString(),b=C.description||(0,j.t)("explore.query-library.default-description","Public",{timestamp:x});o?.uid?g({uid:o.uid,partialSpec:{title:C.description}}).then(S=>{s(S)}):n&&c({title:b,targets:[n]}).then(S=>{s(S)})},{value:y}=(0,mt.A)(async()=>{const C=f.map(async(x,b)=>(await(0,Ae.l)().get(x.datasource))?.getQueryDisplayText?.(x)||(0,pe.ev)(x));return Promise.all(C)});return(0,t.jsxs)("form",{onSubmit:i(m),children:[(0,t.jsx)("p",{children:Ul(o===void 0)}),y&&y.map((C,x)=>(0,t.jsx)(ve.D,{label:(0,j.t)("explore.query-template-modal.query","Query"),children:(0,t.jsx)(no.f,{readOnly:!0,value:C})},`query-${x}`)),n&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(ve.D,{label:(0,j.t)("explore.query-template-modal.data-source-name","Data source name"),children:(0,t.jsx)(kl.s,{current:d?.uid,disabled:!0})}),(0,t.jsx)(ve.D,{label:(0,j.t)("explore.query-template-modall.data-source-type","Data source type"),children:(0,t.jsx)(_e.p,{disabled:!0,defaultValue:d?.meta.name})})]}),(0,t.jsx)(ve.D,{label:(0,j.t)("explore.query-template-modal.description","Description"),children:(0,t.jsx)(_e.p,{id:"query-template-description",autoFocus:!0,...r("description")})}),(0,t.jsx)(ve.D,{label:(0,j.t)("explore.query-template-modal.visibility","Visibility"),children:(0,t.jsx)(St.z,{options:ql,value:"Public",disabled:!0})}),(0,t.jsx)(Ke.K,{showLabel:!0,disabled:!0,label:(0,j.t)("explore.query-template-modal.auto-star","Auto-star this query to add it to your starred list in the Query Library.")}),(0,t.jsxs)(Fe.a.ButtonRow,{children:[(0,t.jsx)(Q.$n,{variant:"secondary",onClick:()=>e(),fill:"outline",children:(0,t.jsx)(j.x6,{i18nKey:"explore.query-library.cancel",children:"Cancel"})}),(0,t.jsx)(Q.$n,{variant:"primary",type:"submit",children:(0,t.jsx)(j.x6,{i18nKey:"explore.query-library.save",children:"Save"})})]})]})};var $e=p(72433),ro=p(69529),Hs=p(67647),io=p(76892),Gl=p(17172);const Kl=`apis/iam.grafana.app/v0alpha1/namespaces/${U.$.namespace}/display`;async function Yl(e){return await(0,Gl.AI)().get(`${Kl}${e}`)}var Zl=p(48840),ss=p(82467),ns=p(3169),Ye=p(28444),wt=p(76412);const Jl={setQueries:Z.Rk,changeDatasource:Xe.wh},Xl=(0,Ie.connect)(void 0,Jl);function _l({rootDatasourceUid:e,queries:s,disabled:n=!1,variant:o="secondary",onClick:r,changeDatasource:i,setQueries:a}){const[l,d]=(0,u.useState)(!1),f=(0,A.useSelector)(_.pF),c=(0,A.useSelector)(_.Kl),g=(0,A.useSelector)(_.K6),m=(b,S)=>!c.dsToExplore.find(w=>w.datasource.uid===b)?.exploreIds.includes(S),y=(b,S)=>S!==void 0&&b!==void 0&&m(S,b)?{fallbackText:"Switch data source and run query",translation:(0,wt.t)("explore.run-query.switch-datasource-button","Switch data source and run query")}:{fallbackText:"Run query",translation:(0,wt.t)("explore.run-query.run-query-button","Run query")},C=async b=>{const S=m(e,b);S&&await i({exploreId:b,datasource:e}),a(b,s),(0,D.rR)("grafana_explore_query_history_run",{queryHistoryEnabled:U.$.queryHistoryEnabled,differentDataSource:S})},x=()=>{const b=n||s.length===0||e===void 0;if(f){const S=(0,t.jsx)(Oe.W,{children:g.map((w,R)=>{const v=y(w[0],e),L=R===0?(0,wt.t)("explore.run-query.left-pane","Left pane"):(0,wt.t)("explore.run-query.right-pane","Right pane");return(0,t.jsx)(Oe.W.Item,{ariaLabel:v.fallbackText,onClick:()=>{C(w[0]),r?.()},label:`${L}: ${v.translation}`,disabled:b||w[0]===void 0},R)})});return(0,t.jsx)(xt.m,{onVisibleChange:w=>d(w),placement:"bottom-start",overlay:S,children:(0,t.jsx)(ue.I,{"aria-label":"run query options",variant:"canvas",isOpen:l,children:(0,wt.t)("explore.run-query.run-query-button","Run query")})})}else{const S=c.exploreToDS[0]?.exploreId,w=y(S,e);return(0,t.jsx)(Q.$n,{variant:o,"aria-label":w.translation,onClick:()=>{C(S),r?.()},disabled:b||S===void 0,children:w.translation})}};return(0,t.jsx)(t.Fragment,{children:x()})}const ao=Xl(_l),Lt=()=>(0,k.of)(ec),ec=e=>({logo:(0,h.css)({marginRight:e.spacing(2),width:"16px"}),header:(0,h.css)({margin:0,fontSize:e.typography.h5.fontSize,color:e.colors.text.secondary}),mainText:(0,h.css)({margin:0,fontSize:e.typography.body.fontSize,textOverflow:"ellipsis"}),otherText:(0,h.css)({margin:0,fontSize:e.typography.body.fontSize,color:e.colors.text.secondary,textOverflow:"ellipsis"}),singleLine:(0,h.css)({display:"-webkit-box",WebkitBoxOrient:"vertical",WebkitLineClamp:1,overflow:"hidden"}),cell:(0,h.css)({display:"flex",alignItems:"center","&:last-child":{justifyContent:"end"}}),actionButton:(0,h.css)({padding:e.spacing(1)})});function tc({queryTemplate:e,rootDatasourceUid:s,queryUid:n}){const[o]=Ql(),[r,i]=(0,u.useState)(!1),{setDrawerOpened:a}=at(),l=Lt(),d=f=>{const c=g=>{o({uid:g}),(0,ct.JD)((0,ss.dx)((0,ns.tZ)((0,j.t)("explore.query-library.query-deleted","Query deleted")))),Dr()};(0,be.J7)().publish(new Ye.bY({title:(0,j.t)("explore.query-library.delete-query-title","Delete query"),text:(0,j.t)("explore.query-library.delete-query-text","You're about to remove this query from the query library. This action cannot be undone. Do you want to continue?"),yesText:(0,j.t)("query-library.delete-query-button","Delete query"),icon:"trash-alt",onConfirm:()=>c(f)}))};return(0,t.jsxs)("div",{className:l.cell,children:[(0,t.jsx)(qe.K,{className:l.actionButton,size:"lg",name:"trash-alt",title:(0,j.t)("explore.query-library.delete-query","Delete query"),tooltip:(0,j.t)("explore.query-library.delete-query","Delete query"),onClick:()=>{n&&d(n)}}),(0,t.jsx)(qe.K,{className:l.actionButton,size:"lg",name:"comment-alt",title:(0,j.t)("explore.query-library.add-edit-description","Add/edit description"),tooltip:(0,j.t)("explore.query-library.add-edit-description","Add/edit description"),onClick:()=>{i(!0),Nr()}}),(0,t.jsx)(ao,{queries:e.query?[e.query]:[],rootDatasourceUid:s,variant:"primary",onClick:()=>{a(!1),Ar(e.datasourceType||"")}}),(0,t.jsx)(Fe.a,{title:(0,j.t)("explore.query-template-modal.edit-title","Edit query"),isOpen:r,onDismiss:()=>i(!1),children:(0,t.jsx)(Bs,{onCancel:()=>i(!1),templateData:e,onSave:()=>{i(!1)}})})]})}const sc=tc;var nc=p(12942);function oc(e){const s=Lt();return(0,t.jsxs)("div",{children:[(0,t.jsx)("span",{className:s.logo,children:(0,t.jsx)(nc.e,{src:e.user?.avatarUrl||"https://secure.gravatar.com/avatar",alt:"unknown"})}),(0,t.jsx)("span",{className:s.otherText,children:e.user?.displayName||"Unknown"})]})}function rc(e){const s=zs(e.row.original.datasourceRef),n=Lt();return(0,t.jsx)("p",{className:n.otherText,children:s?.meta.name})}function ic(e){const s=Lt(),n=(0,Ue.KQ)(e.row.original.createdAtTimestamp).format("YYYY-MM-DD HH:mm:ss");return(0,t.jsx)("p",{className:s.otherText,children:n})}function ac(e){const s=zs(e.row.original.datasourceRef),n=Lt(),o=(0,k.of)(lc);if(!s)return(0,t.jsx)(jt.y,{});if(!e.row.original.query)return(0,t.jsx)("div",{children:"No queries"});const r=e.row.original.queryText,i=e.row.original.description,a=e.row.original.datasourceName;return(0,t.jsxs)("div",{className:o.container,"aria-label":`Query template for ${a}: ${i}`,children:[(0,t.jsxs)("p",{className:n.header,children:[(0,t.jsx)("img",{className:n.logo,src:s?.meta.info.logos.small||"public/img/icn-datasource.svg",alt:s?.meta.info.description}),a]}),(0,t.jsx)(xe.m,{content:r??"",placement:"bottom-start",children:(0,t.jsx)("p",{className:(0,h.cx)(n.mainText,n.singleLine,o.queryDisplayText),children:r})}),(0,t.jsx)("p",{className:(0,h.cx)(n.otherText,n.singleLine),children:i})]})}const lc=e=>({container:(0,h.css)({maxWidth:e.spacing(60)}),queryDisplayText:(0,h.css)({backgroundColor:e.colors.background.canvas})}),cc=[{id:"description",header:"Data source and query",cell:ac},{id:"addedBy",header:"Added by",cell:({row:{original:e}})=>(0,t.jsx)(oc,{user:e.user})},{id:"datasourceType",header:"Datasource type",cell:rc,sortType:"string"},{id:"createdAtTimestamp",header:"Date added",cell:ic,sortType:(e,s,n,o)=>{const r=e.original.createdAtTimestamp||0,i=s.original.createdAtTimestamp||0;return o?r-i:i-r}},{id:"actions",header:"",cell:({row:{original:e}})=>(0,t.jsx)(sc,{queryTemplate:e,rootDatasourceUid:e.datasourceRef?.uid,queryUid:e.uid})}];function dc({queryTemplateRows:e}){const s=(0,k.of)(uc);return(0,t.jsx)(Zl.j,{columns:cc,data:e,getRowId:n=>n.index,pageSize:20,className:s.table})}const uc=e=>({table:(0,h.css)({"tbody tr":{position:"relative",backgroundColor:e.colors.background.secondary,borderCollapse:"collapse",borderBottom:"unset",overflow:"hidden"},"tbody tr::after":{content:'""',position:"absolute",inset:"auto 0 0 0",height:e.spacing(.5),backgroundColor:e.colors.background.primary}})}),pc=(e,s,n,o)=>e.filter(i=>{const a=n.length===0||n.some(d=>i.datasourceName?.toLowerCase().includes(d.toLowerCase())),l=o.length===0||o.includes(i.user?.displayName||"");return(i.datasourceName?.toLowerCase().includes(s.toLowerCase())||i.datasourceType?.toLowerCase().includes(s.toLowerCase())||i.description?.toLowerCase().includes(s.toLowerCase())||i.queryText?.toLowerCase().includes(s.toLowerCase()))&&a&&l});function hc(e){const{data:s,isLoading:n,error:o}=Bl(),[r,i]=(0,u.useState)(""),[a,l]=(0,u.useState)(e.activeDatasources?.map(R=>({value:R,label:R}))||[]),[d,f]=(0,u.useState)([]),[c,g]=(0,u.useState)([]),[m,y]=(0,u.useState)([]),[C,x]=(0,u.useState)(!0),b=(0,k.of)(gc);(0,u.useEffect)(()=>{let R=!0;return(async()=>{if(!s){x(!1);return}let L;const F=(0,ie.uniq)((0,ie.compact)(s.map(E=>E.user?.uid))).map(E=>`key=${encodeURIComponent(E)}`).join("&");try{L=await Yl(`?${F}`)}catch(E){(0,be.J7)().publish({type:ut.r1.alertError.name,payload:[(0,j.t)("query-library.user-info-get-error","Error attempting to get user info from the library: {{error}}",{error:JSON.stringify(E)})]}),x(!1);return}f(L.display.map(E=>E.displayName));const N=s.map(async(E,q)=>{try{const X=E.targets[0]?.datasource,oe=await(0,Ae.l)().get(X),he=(0,Xn.tR)().getInstanceSettings(X)?.meta.name||"",O=E.targets[0],z=(0,pe.Ax)(O,oe),B=oe?.name||"",G=L.display.find(M=>`${M?.identity.type}:${M?.identity.name}`===E.user?.uid);return{index:q.toString(),uid:E.uid,datasourceName:B,datasourceRef:X,datasourceType:he,createdAtTimestamp:E?.createdAtTimestamp||0,query:O,queryText:z,description:E.title,user:{uid:E.user?.uid||"",displayName:G?.displayName||"",avatarUrl:G?.avatarUrl||""}}}catch(X){return(0,be.J7)().publish({type:ut.r1.alertError.name,payload:[(0,j.t)("query-library.query-template-get-error","Error attempting to get query template from the library: {{error}}",{error:JSON.stringify(X)})]}),{index:q.toString(),error:X}}}),H=(await Promise.allSettled(N)).filter(E=>E.status==="fulfilled").map(E=>E.value);R&&(y(H),x(!1))})(),()=>{R=!1}},[s]);const S=(0,u.useMemo)(()=>pc(m,r,a.map(R=>R.value||""),c.map(R=>R.value||"")),[m,r,a,c]),w=(0,u.useMemo)(()=>(0,ie.uniqBy)(m,"datasourceName").map(R=>R.datasourceName),[m]);return o?(0,t.jsx)(ro.p,{variant:"not-found",message:"Something went wrong",children:o.message}):n||C?(0,t.jsx)(jt.y,{}):!s||s.length===0?(0,t.jsx)(ro.p,{message:"Query Library",variant:"not-found",children:(0,t.jsx)("p",{children:"You haven't saved any queries to your library yet. Start adding them from Explore or your Query History tab."})}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(je.B,{gap:.5,children:[(0,t.jsx)(Hs.Z,{className:b.searchInput,placeholder:(0,j.t)("query-library.search","Search by data source, query content or description"),"aria-label":(0,j.t)("query-library.search","Search by data source, query content or description"),value:r,onChange:R=>i(R),escapeRegex:!1}),(0,t.jsx)(io.c,{className:b.label,width:"auto",children:(0,t.jsx)(j.x6,{i18nKey:"query-library.datasource-names",children:"Datasource name(s):"})}),(0,t.jsx)(Ne.KF,{className:b.multiSelect,onChange:(R,v)=>{l(R),v.action==="select-option"&&vn()},value:a,options:w.map(R=>({value:R,label:R})),placeholder:"Filter queries for data sources(s)","aria-label":"Filter queries for data sources(s)"}),(0,t.jsx)(io.c,{className:b.label,width:"auto",children:(0,t.jsx)(j.x6,{i18nKey:"query-library.user-names",children:"User name(s):"})}),(0,t.jsx)(Ne.KF,{className:b.multiSelect,onChange:(R,v)=>{g(R),v.action==="select-option"&&vn()},value:c,options:d.map(R=>({value:R,label:R})),placeholder:"Filter queries for user name(s)","aria-label":"Filter queries for user name(s)"})]}),(0,t.jsx)(dc,{queryTemplateRows:S})]})}const gc=e=>({searchInput:(0,h.css)({maxWidth:e.spacing(55)}),multiSelect:(0,h.css)({maxWidth:e.spacing(65)}),label:(0,h.css)({marginLeft:e.spacing(1),border:`1px solid ${e.colors.secondary.border}`})});function fc({activeDatasources:e}){return(0,t.jsx)(hc,{activeDatasources:e})}var mc=p(47097),lo=p(72635);const yc=({query:e})=>{const[s,n]=(0,u.useState)(!1),[o,r]=(0,u.useState)(!1),i=(0,lo.t)("explore.rich-history-card.add-to-library","Add to library");return Vl()&&!o?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(Q.$n,{variant:"secondary","aria-label":i,onClick:()=>{n(!0),Or()},children:i}),(0,t.jsx)(Fe.a,{title:(0,lo.t)("explore.query-template-modal.add-title","Add query to Query Library"),isOpen:s,onDismiss:()=>n(!1),children:(0,t.jsx)(Bs,{onCancel:()=>n(()=>!1),queryToAdd:e,onSave:a=>{a&&(n(!1),r(!0),Er(e.datasource?.type||""))}})})]}):void 0},xc={changeDatasource:Xe.wh,deleteHistoryItem:$e.VM,commentHistoryItem:$e.H9,starHistoryItem:$e.sh,setQueries:Z.Rk},vc=(0,Ie.connect)(void 0,xc),bc=e=>{const s="240px",n="170px",o=e.colors.background.secondary;return{queryCard:(0,h.css)`
      position: relative;
      display: flex;
      flex-direction: column;
      border: 1px solid ${e.colors.border.weak};
      margin: ${e.spacing(1)} 0;
      background-color: ${o};
      border-radius: ${e.shape.radius.default};
      .starred {
        color: ${e.v1.palette.orange};
      }
    `,cardRow:(0,h.css)`
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: ${e.spacing(1)};
      border-bottom: none;
      :first-of-type {
        border-bottom: 1px solid ${e.colors.border.weak};
        padding: ${e.spacing(.5,1)};
      }
      img {
        height: ${e.typography.fontSize}px;
        max-width: ${e.typography.fontSize}px;
        margin-right: ${e.spacing(1)};
      }
    `,queryActionButtons:(0,h.css)`
      max-width: ${n};
      display: flex;
      justify-content: flex-end;
      font-size: ${e.typography.size.base};
      button {
        margin-left: ${e.spacing(1)};
      }
    `,queryContainer:(0,h.css)`
      font-weight: ${e.typography.fontWeightMedium};
      width: calc(100% - ${s});
    `,updateCommentContainer:(0,h.css)`
      width: calc(100% + ${s});
      margin-top: ${e.spacing(1)};
    `,comment:(0,h.css)`
      overflow-wrap: break-word;
      font-size: ${e.typography.bodySmall.fontSize};
      font-weight: ${e.typography.fontWeightRegular};
      margin-top: ${e.spacing(.5)};
    `,commentButtonRow:(0,h.css)`
      > * {
        margin-top: ${e.spacing(1)};
        margin-right: ${e.spacing(1)};
      }
    `,textArea:(0,h.css)`
      width: 100%;
    `,runButton:(0,h.css)`
      max-width: ${n};
      display: flex;
      justify-content: flex-end;
      button {
        height: auto;
        padding: ${e.spacing(.5,2)};
        line-height: 1.4;
        span {
          white-space: normal !important;
        }
      }
    `,loader:(0,h.css)`
      position: absolute;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: ${e.colors.background.secondary};
    `}};function Sc(e){const{queryHistoryItem:s,commentHistoryItem:n,starHistoryItem:o,deleteHistoryItem:r,datasourceInstances:i}=e,[a,l]=(0,u.useState)(!1),[d,f]=(0,u.useState)(s.comment),c=(0,k.of)(bc),g=i?i.find(T=>T.uid===s.datasourceUid):void 0,m=async()=>{const T=[...s.queries.map(N=>N.datasource?.type||"unknown")];(0,D.rR)("grafana_explore_query_history_copy_query",{datasources:T,mixed:!!g?.meta.mixed});const F=s.queries.map(N=>{let P=i?.find(H=>H.uid===s.datasourceUid);return P?.meta.mixed&&(P=i?.find(H=>H.uid===N.datasource?.uid)),(0,pe.Ax)(N,P)}).join(`
`);(0,ht.uJ)(F),(0,ct.JD)((0,ss.dx)((0,ns.tZ)((0,j.t)("explore.rich-history-notification.query-copied","Query copied to clipboard"))))},y=async()=>{const T=(0,pe.U3)(s);await(0,js.VP)(T)},C=()=>{const T=F=>{r(F),(0,ct.JD)((0,ss.dx)((0,ns.tZ)((0,j.t)("explore.rich-history-notification.query-deleted","Query deleted")))),(0,D.rR)("grafana_explore_query_history_deleted",{queryHistoryEnabled:U.$.queryHistoryEnabled})};s.starred?(0,be.J7)().publish(new Ye.bY({title:(0,j.t)("explore.rich-history-card.delete-query-confirmation-title","Delete"),text:(0,j.t)("explore.rich-history-card.delete-starred-query-confirmation-text","Are you sure you want to permanently delete your starred query?"),yesText:(0,j.t)("explore.rich-history-card.confirm-delete","Delete"),icon:"trash-alt",onConfirm:()=>T(s.id)})):T(s.id)},x=()=>{o(s.id,!s.starred),(0,D.rR)("grafana_explore_query_history_starred",{queryHistoryEnabled:U.$.queryHistoryEnabled,newValue:!s.starred})},b=()=>l(!a),S=()=>{n(s.id,d),l(!1),(0,D.rR)("grafana_explore_query_history_commented",{queryHistoryEnabled:U.$.queryHistoryEnabled})},w=()=>{l(!1),f(s.comment)},R=T=>{T.key==="Enter"&&(T.shiftKey||T.ctrlKey)&&S(),T.key==="Escape"&&w()},v=(0,t.jsxs)("div",{className:c.updateCommentContainer,"aria-label":d?(0,j.t)("explore.rich-history-card.update-comment-form","Update comment form"):(0,j.t)("explore.rich-history-card.add-comment-form","Add comment form"),children:[(0,t.jsx)(no.f,{onKeyDown:R,value:d,placeholder:d?void 0:(0,j.t)("explore.rich-history-card.optional-description","An optional description of what the query does."),onChange:T=>f(T.currentTarget.value),className:c.textArea}),(0,t.jsxs)("div",{className:c.commentButtonRow,children:[(0,t.jsx)(Q.$n,{onClick:S,children:(0,t.jsx)(j.x6,{i18nKey:"explore.rich-history-card.save-comment",children:"Save comment"})}),(0,t.jsx)(Q.$n,{variant:"secondary",onClick:w,children:(0,t.jsx)(j.x6,{i18nKey:"explore.rich-history-card.cancel",children:"Cancel"})})]})]}),L=(0,t.jsxs)("div",{className:c.queryActionButtons,children:[(0,t.jsx)(qe.K,{name:"comment-alt",onClick:b,tooltip:s.comment?.length>0?(0,j.t)("explore.rich-history-card.edit-comment-tooltip","Edit comment"):(0,j.t)("explore.rich-history-card.add-comment-tooltip","Add comment")}),(0,t.jsx)(qe.K,{name:"copy",onClick:m,tooltip:(0,j.t)("explore.rich-history-card.copy-query-tooltip","Copy query to clipboard")}),g&&(0,t.jsx)(qe.K,{name:"share-alt",onClick:y,tooltip:(0,t.jsx)(j.x6,{i18nKey:"explore.rich-history-card.copy-shortened-link-tooltip",children:"Copy shortened link to clipboard"})}),(0,t.jsx)(qe.K,{name:"trash-alt",title:(0,j.t)("explore.rich-history-card.delete-query-title","Delete query"),tooltip:(0,j.t)("explore.rich-history-card.delete-query-tooltip","Delete query"),onClick:C}),(0,t.jsx)(qe.K,{name:s.starred?"favorite":"star",iconType:s.starred?"mono":"default",onClick:x,tooltip:s.starred?(0,j.t)("explore.rich-history-card.unstar-query-tooltip","Unstar query"):(0,j.t)("explore.rich-history-card.star-query-tooltip","Star query")})]});return(0,t.jsxs)("div",{className:c.queryCard,children:[(0,t.jsxs)("div",{className:c.cardRow,children:[(0,t.jsx)(co,{dsApi:g,size:"sm"}),L]}),(0,t.jsxs)("div",{className:(0,h.cx)(c.cardRow),children:[(0,t.jsxs)("div",{className:c.queryContainer,children:[s?.queries.map((T,F)=>{const N=i?.find(P=>P.uid===T.datasource?.uid);return(0,t.jsx)(jc,{query:{query:T,datasource:N},showDsInfo:g?.meta.mixed},`${T}-${F}`)}),!a&&s.comment&&(0,t.jsx)("div",{"aria-label":(0,j.t)("explore.rich-history-card.query-comment-label","Query comment"),className:c.comment,children:s.comment}),a&&v]}),!a&&(0,t.jsx)(yc,{query:s?.queries[0]}),!a&&(0,t.jsx)("div",{className:c.runButton,children:(0,t.jsx)(ao,{queries:s.queries,rootDatasourceUid:g?.uid})})]})]})}const Cc=e=>({queryRow:(0,h.css)`
    border-top: 1px solid ${e.colors.border.weak};
    display: flex;
    flex-direction: row;
    padding: 4px 0px;
    gap: 4px;
    :first-child {
      border-top: none;
    }
  `,dsInfoContainer:(0,h.css)`
    display: flex;
    align-items: center;
  `,queryText:(0,h.css)`
    word-break: break-all;
  `}),jc=({query:e,showDsInfo:s=!1})=>{const n=(0,k.of)(Cc);return(0,t.jsxs)("div",{className:n.queryRow,children:[s&&(0,t.jsxs)("div",{className:n.dsInfoContainer,children:[(0,t.jsx)(co,{dsApi:e.datasource,size:"md"}),": "]}),(0,t.jsx)("span",{"aria-label":(0,j.t)("explore.rich-history-card.query-text-label","Query text"),className:n.queryText,children:(0,pe.Ax)(e.query,e.datasource)})]})},Rc=e=>s=>(0,h.css)`
  display: flex;
  align-items: center;
  font-size: ${s.typography[e==="sm"?"bodySmall":"body"].fontSize};
  font-weight: ${s.typography.fontWeightMedium};
  white-space: nowrap;
`;function co({dsApi:e,size:s}){const n=(0,u.useCallback)(r=>Rc(s)(r),[s]),o=(0,k.of)(n);return(0,t.jsxs)("div",{className:o,children:[(0,t.jsx)("img",{src:e?.meta.info.logos.small||"public/img/icn-datasource.svg",alt:e?.type||(0,j.t)("explore.rich-history-card.datasource-not-exist","Data source does not exist anymore"),"aria-label":(0,j.t)("explore.rich-history-card.datasource-icon-label","Data source icon")}),(0,t.jsx)("div",{"aria-label":(0,j.t)("explore.rich-history-card.datasource-name-label","Data source name"),children:e?.name||(0,j.t)("explore.rich-history-card.datasource-not-exist","Data source does not exist anymore")})]})}const uo=vc(Sc),Tc=(e,s)=>({container:(0,h.css)`
      display: flex;
    `,labelSlider:(0,h.css)`
      font-size: ${e.typography.bodySmall.fontSize};
      &:last-of-type {
        margin-top: ${e.spacing(3)};
      }
      &:first-of-type {
        font-weight: ${e.typography.fontWeightMedium};
        margin-bottom: ${e.spacing(2)};
      }
    `,containerContent:(0,h.css)`
      /* 134px is based on the width of the Query history tabs bar, so the content is aligned to right side of the tab */
      width: calc(100% - 134px);
    `,containerSlider:(0,h.css)`
      width: 129px;
      margin-right: ${e.spacing(1)};
    `,fixedSlider:(0,h.css)`
      position: fixed;
    `,slider:(0,h.css)`
      bottom: 10px;
      height: ${s-180}px;
      width: 129px;
      padding: ${e.spacing(1)} 0;
    `,selectors:(0,h.css)`
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
    `,filterInput:(0,h.css)`
      margin-bottom: ${e.spacing(1)};
    `,multiselect:(0,h.css)`
      width: 100%;
      margin-bottom: ${e.spacing(1)};
    `,sort:(0,h.css)`
      width: 170px;
    `,sessionName:(0,h.css)`
      display: flex;
      align-items: flex-start;
      justify-content: flex-start;
      margin-top: ${e.spacing(3)};
      h4 {
        margin: 0 10px 0 0;
      }
    `,heading:(0,h.css)`
      font-size: ${e.typography.h4.fontSize};
      margin: ${e.spacing(2,.25,1,.25)};
    `,footer:(0,h.css)`
      height: 60px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: ${e.typography.fontWeightLight};
      font-size: ${e.typography.bodySmall.fontSize};
      a {
        font-weight: ${e.typography.fontWeightMedium};
        margin-left: ${e.spacing(.25)};
      }
    `,queries:(0,h.css)`
      font-size: ${e.typography.bodySmall.fontSize};
      font-weight: ${e.typography.fontWeightRegular};
      margin-left: ${e.spacing(.5)};
    `});function wc(e){const{queries:s,totalQueries:n,loading:o,richHistorySearchFilters:r,updateFilters:i,clearRichHistoryResults:a,loadMoreRichHistory:l,richHistorySettings:d,height:f,listOfDatasources:c,activeDatasources:g}=e,m=(0,k.of)(Tc,f);(0,u.useEffect)(()=>{const R=!d.activeDatasourcesOnly&&d.lastUsedDatasourceFilters?d.lastUsedDatasourceFilters:g,v={search:"",sortOrder:pe.xB.Descending,datasourceFilters:R,from:0,to:d.retentionPeriod,starred:!1};return i(v),()=>{a()}},[]);const{value:y,loading:C}=(0,mt.A)(async()=>{const v=c.map(L=>L.uid).map(async L=>{try{return(0,Ae.l)().get(L)}catch{return Promise.resolve()}});return v!==void 0?(await Promise.all(v)).filter(T=>!!T):[]},[r?.datasourceFilters]);if(!r)return(0,t.jsx)("span",{children:(0,t.jsx)(j.x6,{i18nKey:"explore.rich-history-queries-tab.loading",children:"Loading..."})});const x=(0,pe.x8)(s,r.sortOrder),b=ho(),S=s.length&&s.length!==n,w=[r.from||0,r.to||d.retentionPeriod];return(0,t.jsxs)("div",{className:m.container,children:[(0,t.jsx)("div",{className:m.containerSlider,children:(0,t.jsxs)("div",{className:m.fixedSlider,children:[(0,t.jsx)("div",{className:m.labelSlider,children:(0,t.jsx)(j.x6,{i18nKey:"explore.rich-history-queries-tab.filter-history",children:"Filter history"})}),(0,t.jsx)("div",{className:m.labelSlider,children:(0,pe.IA)(w[0])}),(0,t.jsx)("div",{className:m.slider,children:(0,t.jsx)(mc.F,{tooltipAlwaysVisible:!1,min:0,max:d.retentionPeriod,value:w,orientation:"vertical",formatTooltipResult:pe.IA,reverse:!0,onAfterChange:R=>{i({from:R[0],to:R[1]})}})}),(0,t.jsx)("div",{className:m.labelSlider,children:(0,pe.IA)(w[1])})]})}),(0,t.jsxs)("div",{className:m.containerContent,"data-testid":"query-history-queries-tab",children:[(0,t.jsxs)("div",{className:m.selectors,children:[!d.activeDatasourcesOnly&&(0,t.jsx)(Ne.KF,{className:m.multiselect,options:c.map(R=>({value:R.name,label:R.name})),value:r.datasourceFilters,placeholder:(0,j.t)("explore.rich-history-queries-tab.filter-placeholder","Filter queries for data sources(s)"),"aria-label":(0,j.t)("explore.rich-history-queries-tab.filter-aria-label","Filter queries for data sources(s)"),onChange:R=>{i({datasourceFilters:R.map(v=>v.value)})}}),(0,t.jsx)("div",{className:m.filterInput,children:(0,t.jsx)(Hs.Z,{escapeRegex:!1,placeholder:(0,j.t)("explore.rich-history-queries-tab.search-placeholder","Search queries"),value:r.search,onChange:R=>i({search:R})})}),(0,t.jsx)("div",{"aria-label":(0,j.t)("explore.rich-history-queries-tab.sort-aria-label","Sort queries"),className:m.sort,children:(0,t.jsx)(Ne.l6,{value:b.filter(R=>R.value===r.sortOrder),options:b,placeholder:(0,j.t)("explore.rich-history-queries-tab.sort-placeholder","Sort queries by"),onChange:R=>i({sortOrder:R.value})})})]}),(o||C)&&(0,t.jsx)("span",{children:(0,t.jsx)(j.x6,{i18nKey:"explore.rich-history-queries-tab.loading-results",children:"Loading results..."})}),!(o||C)&&Object.keys(x).map(R=>(0,t.jsxs)("div",{children:[(0,t.jsxs)("div",{className:m.heading,children:[R," ",(0,t.jsx)("span",{className:m.queries,children:S?(0,t.jsx)(j.x6,{i18nKey:"explore.rich-history-queries-tab.displaying-partial-queries",defaults:"Displaying {{ count }} queries",values:{count:x[R].length}}):(0,t.jsx)(j.x6,{i18nKey:"explore.rich-history-queries-tab.displaying-queries",defaults:"{{ count }} queries",values:{count:x[R].length}})})]}),x[R].map(v=>(0,t.jsx)(uo,{datasourceInstances:y,queryHistoryItem:v},v.id))]},R)),S?(0,t.jsx)("div",{children:(0,t.jsx)(j.x6,{i18nKey:"explore.rich-history-queries-tab.showing-queries",defaults:"Showing {{ shown }} of {{ total }} <0>Load more</0>",values:{shown:s.length,total:n},components:[(0,t.jsx)(Q.$n,{onClick:l,children:"Load more"},"loadMoreButton")]})}):null,(0,t.jsx)("div",{className:m.footer,children:U.$.queryHistoryEnabled?"":(0,j.t)("explore.rich-history-queries-tab.history-local","The history is local to your browser and is not shared with others.")})]})]})}var Lc=p(39640);const Ic=e=>({container:(0,h.css)`
      font-size: ${e.typography.bodySmall.fontSize};
    `,spaceBetween:(0,h.css)`
      margin-bottom: ${e.spacing(3)};
    `,input:(0,h.css)`
      max-width: 200px;
    `,bold:(0,h.css)`
      font-weight: ${e.typography.fontWeightBold};
    `,bottomMargin:(0,h.css)`
      margin-bottom: ${e.spacing(1)};
    `}),po=[{value:2,label:(0,j.t)("explore.rich-history-settings-tab.retention-period.2-days","2 days")},{value:5,label:(0,j.t)("explore.rich-history-settings-tab.retention-period.5-days","5 days")},{value:7,label:(0,j.t)("explore.rich-history-settings-tab.retention-period.1-week","1 week")},{value:14,label:(0,j.t)("explore.rich-history-settings-tab.retention-period.2-weeks","2 weeks")}];function Ec(e){const{retentionPeriod:s,starredTabAsFirstTab:n,activeDatasourcesOnly:o,onChangeRetentionPeriod:r,toggleStarredTabAsFirstTab:i,toggleActiveDatasourcesOnly:a,deleteRichHistory:l}=e,d=(0,k.of)(Ic),f=po.find(g=>g.value===s),c=()=>{(0,be.J7)().publish(new Ye.bY({title:(0,j.t)("explore.rich-history-settings-tab.delete-title","Delete"),text:(0,j.t)("explore.rich-history-settings-tab.delete-confirm-text","Are you sure you want to permanently delete your query history?"),yesText:(0,j.t)("explore.rich-history-settings-tab.delete-confirm","Delete"),icon:"trash-alt",onConfirm:()=>{l(),(0,ct.JD)((0,ss.dx)((0,ns.tZ)((0,j.t)("explore.rich-history-settings-tab.query-history-deleted","Query history deleted"))))}}))};return(0,t.jsxs)("div",{className:d.container,children:[(0,gt.gQ)().changeRetention?(0,t.jsx)(ve.D,{label:(0,j.t)("explore.rich-history-settings-tab.history-time-span","History time span"),description:(0,j.t)("explore.rich-history-settings-tab.history-time-span-description","Select the period of time for which Grafana will save your query history. Up to {{MAX_HISTORY_ITEMS}} entries will be stored.",{MAX_HISTORY_ITEMS:Lc.$H}),children:(0,t.jsx)("div",{className:d.input,children:(0,t.jsx)(Ne.l6,{value:f,options:po,onChange:r})})}):(0,t.jsx)(yt.F,{severity:"info",title:(0,j.t)("explore.rich-history-settings-tab.history-time-span","History time span"),children:(0,j.t)("explore.rich-history-settings-tab.alert-info","Grafana will keep entries up to {{optionLabel}}.Starred entries won't be deleted.",{optionLabel:f?.label})}),(0,t.jsx)(Me.I,{label:(0,j.t)("explore.rich-history-settings-tab.change-default-tab","Change the default active tab from \u201CQuery history\u201D to \u201CStarred\u201D"),className:d.spaceBetween,children:(0,t.jsx)(Ke.K,{id:"explore-query-history-settings-default-active-tab",value:n,onChange:i})}),(0,gt.gQ)().onlyActiveDataSource&&(0,t.jsx)(Me.I,{label:(0,j.t)("explore.rich-history-settings-tab.only-show-active-datasource","Only show queries for data source currently active in Explore"),className:d.spaceBetween,children:(0,t.jsx)(Ke.K,{id:"explore-query-history-settings-data-source-behavior",value:o,onChange:a})}),(0,gt.gQ)().clearHistory&&(0,t.jsxs)("div",{children:[(0,t.jsx)("div",{className:d.bold,children:(0,t.jsx)(j.x6,{i18nKey:"explore.rich-history-settings-tab.clear-query-history",children:"Clear query history"})}),(0,t.jsx)("div",{className:d.bottomMargin,children:(0,t.jsx)(j.x6,{i18nKey:"explore.rich-history-settings-tab.clear-history-info",children:"Delete all of your query history, permanently."})}),(0,t.jsx)(Q.$n,{variant:"destructive",onClick:c,children:(0,t.jsx)(j.x6,{i18nKey:"explore.rich-history-settings-tab.clear-query-history-button",children:"Clear query history"})})]})]})}const Oc=e=>({container:(0,h.css)`
      display: flex;
    `,containerContent:(0,h.css)`
      width: 100%;
    `,selectors:(0,h.css)`
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
    `,multiselect:(0,h.css)`
      width: 100%;
      margin-bottom: ${e.spacing(1)};
    `,filterInput:(0,h.css)`
      margin-bottom: ${e.spacing(1)};
    `,sort:(0,h.css)`
      width: 170px;
    `,footer:(0,h.css)`
      height: 60px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: ${e.typography.fontWeightLight};
      font-size: ${e.typography.bodySmall.fontSize};
      a {
        font-weight: ${e.typography.fontWeightMedium};
        margin-left: ${e.spacing(.25)};
      }
    `});function Fc(e){const{updateFilters:s,clearRichHistoryResults:n,loadMoreRichHistory:o,richHistorySettings:r,queries:i,totalQueries:a,loading:l,richHistorySearchFilters:d}=e,f=(0,k.of)(Oc),c=(0,A.useSelector)(_.Kl),g=(0,pe.TR)();(0,u.useEffect)(()=>{const x=r.activeDatasourcesOnly&&r.lastUsedDatasourceFilters?r.lastUsedDatasourceFilters:c.dsToExplore.map(S=>g.find(w=>w.uid===S.datasource?.uid)?.name).filter(S=>!!S),b={search:"",sortOrder:pe.xB.Descending,datasourceFilters:x,from:0,to:r.retentionPeriod,starred:!0};return s(b),()=>{n()}},[]);const{value:m,loading:y}=(0,mt.A)(async()=>{const b=await(d?.datasourceFilters&&d?.datasourceFilters.length>0?d?.datasourceFilters:g.map(S=>S.uid)).map(async S=>{try{return(0,Ae.l)().get(S)}catch{return Promise.resolve()}});return b!==void 0?(await Promise.all(b)).filter(w=>!!w):[]},[d?.datasourceFilters]);if(!d)return(0,t.jsxs)("span",{children:[(0,t.jsx)(j.x6,{i18nKey:"explore.rich-history-starred-tab.loading",children:"Loading..."}),";"]});const C=ho();return(0,t.jsx)("div",{className:f.container,children:(0,t.jsxs)("div",{className:f.containerContent,children:[(0,t.jsxs)("div",{className:f.selectors,children:[!r.activeDatasourcesOnly&&(0,t.jsx)(Ne.KF,{className:f.multiselect,options:g.map(x=>({value:x.name,label:x.name})),value:d.datasourceFilters,placeholder:(0,j.t)("explore.rich-history-starred-tab.filter-queries-placeholder","Filter queries for data sources(s)"),"aria-label":(0,j.t)("explore.rich-history-starred-tab.filter-queries-aria-label","Filter queries for data sources(s)"),onChange:x=>{s({datasourceFilters:x.map(b=>b.value)})}}),(0,t.jsx)("div",{className:f.filterInput,children:(0,t.jsx)(Hs.Z,{escapeRegex:!1,placeholder:(0,j.t)("explore.rich-history-starred-tab.search-queries-placeholder","Search queries"),value:d.search,onChange:x=>s({search:x})})}),(0,t.jsx)("div",{"aria-label":(0,j.t)("explore.rich-history-starred-tab.sort-queries-aria-label","Sort queries"),className:f.sort,children:(0,t.jsx)(Ne.l6,{value:C.filter(x=>x.value===d.sortOrder),options:C,placeholder:(0,j.t)("explore.rich-history-starred-tab.sort-queries-placeholder","Sort queries by"),onChange:x=>s({sortOrder:x.value})})})]}),l&&y&&(0,t.jsx)("span",{children:(0,t.jsx)(j.x6,{i18nKey:"explore.rich-history-starred-tab.loading-results",children:"Loading results..."})}),!(l&&y)&&i.map(x=>(0,t.jsx)(uo,{queryHistoryItem:x,datasourceInstances:m},x.id)),i.length&&i.length!==a?(0,t.jsx)("div",{children:(0,t.jsx)(j.x6,{i18nKey:"explore.rich-history-starred-tab.showing-queries",defaults:"Showing {{ shown }} of {{ total }} <0>Load more</0>",values:{shown:i.length,total:a},components:[(0,t.jsx)(Q.$n,{onClick:o,children:"Load more"},"loadMoreButton")]})}):null,(0,t.jsx)("div",{className:f.footer,children:U.$.queryHistoryEnabled?"":(0,j.t)("explore.rich-history-starred-tab.local-history-message","The history is local to your browser and is not shared with others.")})]})})}const ho=()=>[{label:(0,j.t)("explore.rich-history.newest-first","Newest first"),value:pe.xB.Descending},{label:(0,j.t)("explore.rich-history.oldest-first","Oldest first"),value:pe.xB.Ascending},{label:(0,j.t)("explore.rich-history.datasource-a-z","Data source A-Z"),value:pe.xB.DatasourceAZ},{label:(0,j.t)("explore.rich-history.datasource-z-a","Data source Z-A"),value:pe.xB.DatasourceZA}].filter(e=>(0,gt.gQ)().availableFilters.includes(e.value));function Dc(e){const{richHistory:s,richHistoryTotal:n,height:o,deleteRichHistory:r,onClose:i,firstTab:a}=e,[l,d]=(0,u.useState)(!1),{queryLibraryAvailable:f}=at(),c=N=>{e.updateHistorySettings({...e.richHistorySettings,...N})},g=N=>{const P={...e.richHistorySearchFilters,...N,page:1};e.updateHistorySearchFilters(P),m()},m=(0,ie.debounce)(()=>{e.loadRichHistory(),d(!0)},300),y=N=>{N.value!==void 0&&c({retentionPeriod:N.value})},C=()=>c({starredTabAsFirstTab:!e.richHistorySettings.starredTabAsFirstTab}),x=()=>c({activeDatasourcesOnly:!e.richHistorySettings.activeDatasourcesOnly});(0,u.useEffect)(()=>{d(!1)},[s]);const b=(0,A.useSelector)(_.Kl),S=(0,pe.TR)(),w=b.dsToExplore.map(N=>S.find(P=>P.uid===N.datasource?.uid)?.name).filter(N=>!!N),R={label:Zt.queryLibrary,value:ke.QueryLibrary,content:(0,t.jsx)(fc,{activeDatasources:w}),icon:"book"},v={label:Zt.queryHistory,value:ke.RichHistory,content:(0,t.jsx)(wc,{queries:s,totalQueries:n||0,loading:l,updateFilters:g,clearRichHistoryResults:()=>e.clearRichHistoryResults(),loadMoreRichHistory:()=>e.loadMoreRichHistory(),richHistorySettings:e.richHistorySettings,richHistorySearchFilters:e.richHistorySearchFilters,height:o,activeDatasources:w,listOfDatasources:S}),icon:"history"},L={label:(0,j.t)("explore.rich-history.starred","Starred"),value:ke.Starred,content:(0,t.jsx)(Fc,{queries:s,totalQueries:n||0,loading:l,updateFilters:g,clearRichHistoryResults:()=>e.clearRichHistoryResults(),loadMoreRichHistory:()=>e.loadMoreRichHistory(),richHistorySettings:e.richHistorySettings,richHistorySearchFilters:e.richHistorySearchFilters}),icon:"star"},T={label:(0,j.t)("explore.rich-history.settings","Settings"),value:ke.Settings,content:(0,t.jsx)(Ec,{retentionPeriod:e.richHistorySettings.retentionPeriod,starredTabAsFirstTab:e.richHistorySettings.starredTabAsFirstTab,activeDatasourcesOnly:e.richHistorySettings.activeDatasourcesOnly,onChangeRetentionPeriod:y,toggleStarredTabAsFirstTab:C,toggleActiveDatasourcesOnly:x,deleteRichHistory:r}),icon:"sliders-v-alt"};let F=(f?[R]:[]).concat([v,L,T]);return(0,t.jsx)(so.q,{tabs:F,onClose:i,defaultTab:a,closeIconTooltip:(0,j.t)("explore.rich-history.close-tooltip","Close query history"),testId:pt.Tp.pages.Explore.QueryHistory.container})}function Ac(e){const s=e.explore,n=s.richHistorySearchFilters,{richHistorySettings:o,richHistory:r,richHistoryTotal:i}=s;return{richHistory:r,richHistoryTotal:i,richHistorySettings:o,richHistorySearchFilters:n}}const Nc={initRichHistory:$e.PA,loadRichHistory:$e.jX,loadMoreRichHistory:$e.Uu,clearRichHistoryResults:$e.wk,updateHistorySettings:$e.fP,updateHistorySearchFilters:$e.Bj,deleteRichHistory:$e.s1},kc=(0,Ie.connect)(Ac,Nc);function Pc(e){const s=(0,k.$j)(),{richHistory:n,richHistoryTotal:o,deleteRichHistory:r,initRichHistory:i,loadRichHistory:a,loadMoreRichHistory:l,clearRichHistoryResults:d,richHistorySettings:f,updateHistorySettings:c,richHistorySearchFilters:g,updateHistorySearchFilters:m,onClose:y}=e;(0,u.useEffect)(()=>{i()},[i]);const{selectedTab:C}=at(),[x,b]=(0,u.useState)(!1);return(0,u.useEffect)(()=>{x||(b(!0),(0,D.rR)("grafana_explore_query_history_opened",{queryHistoryEnabled:U.$.queryHistoryEnabled,selectedTab:C}))},[x,C]),!f||!C?(0,t.jsx)("span",{children:(0,t.jsx)(j.x6,{i18nKey:"explore.rich-history-container.loading",children:"Loading..."})}):(0,t.jsx)(Dc,{richHistory:n,richHistoryTotal:o,firstTab:C,onClose:y,height:s.components.horizontalDrawer.defaultHeight,deleteRichHistory:r,richHistorySettings:f,richHistorySearchFilters:g,updateHistorySettings:c,updateHistorySearchFilters:m,loadRichHistory:a,loadMoreRichHistory:l,clearRichHistoryResults:d})}const Mc=kc(Pc);var go=p(19361),fo=p(15961);function $c(e){const s=(0,Dt.C)("explore"),{chrome:n}=(0,ot.Il)();(0,u.useEffect)(()=>{if(!e.panes||typeof e.panes!="string")return;let o;try{o=JSON.parse(e.panes)}catch{return}typeof o!="object"||o===null||Promise.allSettled(Object.values(o).map(r=>!r||typeof r!="object"||!(0,fo.C)("datasource",r)||!r.datasource||typeof r.datasource!="string"?Promise.reject():(0,Ae.l)().get(r.datasource))).then(r=>r.filter(fo.s).map(i=>i.value)).then(r=>{if(r.length===0){p.g.document.title=`${s.main.text} - ${go.M.AppTitle}`,n.update({pageNav:void 0});return}const i=r.map(a=>a.name).join(" | ");n.update({pageNav:{text:i}}),p.g.document.title=`${s.main.text} - ${i} - ${go.M.AppTitle}`})},[e.panes,s.main.text,n])}function zc(){const{keybindings:e}=(0,ot.Il)(),s=(0,A.useDispatch)();(0,u.useEffect)(()=>{e.setupTimeRangeBindings(!1);const n=[];return n.push((0,be.J7)().subscribe(Ye.Rh,()=>{s((0,we.$_)())})),n.push((0,be.J7)().subscribe(Ye.Io,o=>{s((0,we.Iy)(o.payload.direction))})),n.push((0,be.J7)().subscribe(Ye.U0,o=>{s((0,we.ke)(o.payload.scale))})),n.push((0,be.J7)().subscribe(Ye.Bt,()=>{s((0,we.Xk)())})),n.push((0,be.J7)().subscribe(Ye.VZ,()=>{s((0,we.GA)())})),()=>{n.forEach(o=>o.unsubscribe())}},[s,e])}const Bc=e=>{const s=(0,A.useDispatch)(),{width:n}=(0,Ms.A)(),o=(0,A.useSelector)(_.K6),r=(0,A.useSelector)(_.pF),[i,a]=(0,u.useState)(.5),l=(0,A.useSelector)(c=>c.explore),d=c=>{const g=n/2,m=(0,ie.inRange)(c,g-100,g+100);s(m?(0,J.nD)({largerExploreId:void 0}):(0,J.nD)({largerExploreId:c>g?o[1][0]:o[0][0]})),a(c/n)};let f=0;return r&&(!l.evenSplitPanes&&l.maxedExploreId?f=l.maxedExploreId===o[1][0]?n-e:e:l.evenSplitPanes?f=Math.floor(n/2):i!==void 0&&(f=n*i)),{updateSplitSize:d,widthCalc:f}};function Hc(){const{location:e}=(0,ot.Il)();(0,u.useEffect)(()=>{const s=e.getSearchObject();(s.from||s.to)&&e.partial({from:void 0,to:void 0},!0)},[e])}const Qs=200,Qc="queryLibraryAction";function Wc(e){return(0,t.jsx)(kr,{children:(0,t.jsx)(Vc,{...e})})}function Vc(e){const s=(0,k.of)(qc),n=(0,k.$j)();Hc(),(0,An.s)(e.queryParams),$c(e.queryParams);const{chrome:o}=(0,ot.Il)(),r=(0,Dt.C)("explore"),{updateSplitSize:i,widthCalc:a}=Bc(Qs),l=(0,A.useSelector)(_.K6),d=(0,A.useSelector)(_.pF),f=(0,A.useSelector)(_.vC),{drawerOpened:c,setDrawerOpened:g,queryLibraryAvailable:m}=at(),y=U.$.featureToggles.correlations&&(f?.editorMode||!1),[C,x]=(0,u.useState)();return(0,u.useEffect)(()=>{o.update({sectionNav:r})},[o,r]),(0,u.useEffect)(()=>{(U.$.featureToggles.queryLibrary||!1)&&ds.d.addKeyedExtraRenderAction(Qc,{scope:ge.Jk.Explore,queryActionComponent:S=>(0,t.jsx)(Ot.q,{title:(0,j.t)("query-operation.header.save-to-query-library","Save to query library"),icon:"save",onClick:()=>{x(S.query)}},S.key)})},[]),zc(),(0,t.jsxs)("div",{className:(0,h.cx)(s.pageScrollbarWrapper,{[s.correlationsEditorIndicator]:y}),children:[(0,t.jsx)("h1",{className:"sr-only",children:(0,t.jsx)(j.x6,{i18nKey:"nav.explore.title"})}),(0,t.jsx)($o,{}),y&&(0,t.jsx)(Po,{panes:l}),(0,t.jsx)(Ft.g,{splitOrientation:"vertical",paneSize:a,minSize:Qs,maxSize:Qs*-1,primary:"second",splitVisible:d,parentStyle:y?{height:`calc(100% - ${n.spacing(6)}`}:{},paneStyle:{overflow:"auto",display:"flex",flexDirection:"column"},onDragFinished:b=>b&&i(b),children:l.map(([b])=>(0,t.jsx)(ae.Xw,{style:"page",children:(0,t.jsx)(Al,{exploreId:b})},b))}),c&&(0,t.jsx)(on,{initialHeight:m?"75vh":void 0,children:(0,t.jsx)(Mc,{onClose:()=>{g(!1)}})}),(0,t.jsx)(Fe.a,{title:(0,j.t)("explore.query-template-modal.add-title","Add query to Query Library"),isOpen:C!==void 0,onDismiss:()=>x(void 0),children:(0,t.jsx)(Bs,{onCancel:()=>{x(void 0)},onSave:b=>{b&&(x(void 0),Fr(C?.datasource?.type||""))},queryToAdd:C})})]})}const qc=e=>({pageScrollbarWrapper:(0,h.css)({width:"100%",flexGrow:1,minHeight:0,height:"100%",position:"relative",overflow:"hidden"}),correlationsEditorIndicator:(0,h.css)({borderLeft:`4px solid ${e.colors.primary.main}`,borderRight:`4px solid ${e.colors.primary.main}`,borderBottom:`4px solid ${e.colors.primary.main}`,overflow:"scroll"})})},65885:(cs,Ve,p)=>{p.d(Ve,{S5:()=>us,fq:()=>k,gy:()=>rt,l1:()=>A});var t=p(2543),h=p.n(t),u=p(1173),ge=p(50082),U=p(11261);const k=$=>(!$.pluginVersion&&"columns"in $&&console.log("Was angular table",$),$.options),ae={timeseries_to_rows:"seriesToRows",timeseries_to_columns:"seriesToColumns",timeseries_aggregations:"reduce",table:"merge"},Fe={avg:"mean",min:"min",max:"max",total:"sum",current:"lastNotNull",count:"count"},Ot={cell:"color-background",row:"color-background",value:"color-text"},Ft=($,se)=>[-1/0,...$].map((ee,ce)=>({color:se[ce],value:(0,t.isNumber)(ee)?ee:parseInt(ee,10)})),ot=($,se)=>{const ee=$.transformations??[];if(Object.keys(ae).includes(se.transform)){const ce={reducers:[]};se.transform==="timeseries_aggregations"&&(ce.includeTimeField=!1,ce.reducers=se.columns.map(D=>Fe[D.value])),ee.push({id:ae[se.transform],options:ce})}return ee},Dt=$=>{const ee={matcher:{id:/^\/.*\/$/.test($.pattern)?u.Ct.byRegexp:u.Ct.byName,options:$.pattern},properties:[]};return $.alias&&ee.properties.push({id:"displayName",value:$.alias}),$.unit&&ee.properties.push({id:"unit",value:$.unit}),$.decimals&&ee.properties.push({id:"decimals",value:$.decimals}),$.type==="date"&&ee.properties.push({id:"unit",value:`time: ${$.dateFormat}`}),$.type==="hidden"&&ee.properties.push({id:"custom.hidden",value:!0}),$.link&&ee.properties.push({id:"links",value:[{title:(0,t.defaultTo)($.linkTooltip,""),url:(0,t.defaultTo)($.linkUrl,""),targetBlank:(0,t.defaultTo)($.linkTargetBlank,!1)}]}),$.colorMode&&ee.properties.push({id:"custom.cellOptions",value:{type:Ot[$.colorMode]}}),$.align&&ee.properties.push({id:"custom.align",value:$.align==="auto"?null:$.align}),$.thresholds?.length&&ee.properties.push({id:"thresholds",value:{mode:ge.O.Absolute,steps:Ft($.thresholds,$.colors)}}),ee},j=$=>{let se={custom:{}};if($){if(se=(0,t.omitBy)({unit:$.unit,decimals:$.decimals,displayName:$.alias,custom:{align:$.align==="auto"?null:$.align}},t.isNil),$.thresholds.length){const ee={mode:ge.O.Absolute,steps:Ft($.thresholds,$.colors)};se.thresholds=ee}$.colorMode&&(se.custom.cellOptions={type:Ot[$.colorMode]})}return se},A=($,se,ee)=>{if(se==="table-old"&&ee.angular){const ce=ee.angular,D=ot($,ce),je=ce.styles.find(Q=>Q.pattern==="/.*/"),xe=j(je),de=ce.styles.filter(Q=>Q.pattern!=="/.*/").map(Dt);$.transformations=D,$.fieldConfig={defaults:xe,overrides:de}}return{}},ds=$=>$?.filter(se=>se.meta?.custom?.parentRowIndex===void 0)||[$?.[0]],us=$=>{const se=[];return ds($).filter(ce=>!!ce&&ce.length!==0)?.forEach(ce=>{const D=$?.filter(Q=>ce.refId===Q.refId&&Q.meta?.custom?.parentRowIndex!==void 0),je=(0,t.groupBy)(D,Q=>Q.meta?.custom?.parentRowIndex),xe=Object.keys(je).map(Q=>je[Q]),de={...ce};D&&D.length>0&&de.fields.push({name:"nested",type:U.PU.nestedFrames,config:{},values:xe}),se.push(de)}),se},rt=$=>$?.some(se=>se.meta?.custom?.parentRowIndex!==void 0)},10940:(cs,Ve,p)=>{p.d(Ve,{A:()=>u});var t=p(96540),h=function(ge,U){var k=(0,t.useRef)(function(){});(0,t.useEffect)(function(){k.current=ge}),(0,t.useEffect)(function(){if(U!==null){var ae=setInterval(function(){return k.current()},U||0);return function(){return clearInterval(ae)}}},[U])};const u=h}}]);

//# sourceMappingURL=explore.be1f937e68a8c15b1e01.js.map