{"version":3,"sources":["../src/scadavis_ctrl.js"],"names":["MetricsPanelCtrl","_","kbn","TimeSeries","legend","SCADAvisCtrl","$scope","$injector","$rootScope","hiddenSeries","panelDefaults","svgurl","showZoomPan","zoomLevel","show","values","links","datasource","maxDataPoints","interval","targets","cacheTimeout","nullPointMode","legendType","breakPoint","aliasColors","format","valueName","strokeWidth","fontSize","defaults","panel","events","on","onRender","bind","onDataReceived","onDataError","onInitEditMode","setLegendWidthForLegacyBrowser","addEditorTab","unitFormats","getUnitFormats","subItem","value","render","series","color","alias","data","parseSeries","map","serie","i","label","stats","colors","legendData","dataList","seriesHandler","templateSrv","replace","scopedVars","e","console","log","$panelContainer","svelem","querySelector","svgraph","scadavis","container","iframeparams","clientWidth","clientHeight","enableMouse","zoomTo","hideWatermark","_lastZoomLevel","zoomToOriginal","loadURL","enableTools","length","setValue","seriesData","datapoints","target","flotpairs","getFlotPairs","isNumber","decimals","scaledDecimals","delta","dec","Math","floor","LN10","magn","pow","norm","size","result","max","decimalInfo","getDecimalsForValue","formatFunc","valueFormats","scope","elem","attrs","ctrl","find","isIE11","window","MSInputMethodContext","document","documentMode","sideWidth","templateUrl"],"mappings":"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","file":"scadavis_ctrl.js","sourcesContent":["import {MetricsPanelCtrl} from 'app/plugins/sdk';\r\nimport _ from 'lodash';\r\nimport kbn from 'app/core/utils/kbn';\r\nimport TimeSeries from 'app/core/time_series';\r\n// import rendering from './rendering';\r\nimport legend from './legend';\r\nimport 'https://scadavis.io/synoptic/synopticapi.js';\r\n\r\nexport class SCADAvisCtrl extends MetricsPanelCtrl {\r\n\r\n  constructor($scope, $injector, $rootScope) {\r\n    super($scope, $injector);\r\n    this.$rootScope = $rootScope;\r\n    this.hiddenSeries = {};\r\n\r\n    var panelDefaults = {\r\n      svgurl: 'https://raw.githubusercontent.com/riclolsen/displayfiles/master/helloworld.svg',\r\n      showZoomPan: false,\r\n      zoomLevel: 1.0,\r\n      legend: {\r\n        show: true, // disable/enable legend\r\n        values: true\r\n      },\r\n      links: [],\r\n      datasource: null,\r\n      maxDataPoints: 3,\r\n      interval: null,\r\n      targets: [{}],\r\n      cacheTimeout: null,\r\n      nullPointMode: 'connected',\r\n      legendType: 'Under graph',\r\n      breakPoint: '50%',\r\n      aliasColors: {},\r\n      format: 'short',\r\n      valueName: 'current',\r\n      strokeWidth: 1,\r\n      fontSize: '80%'\r\n    };\r\n\r\n    _.defaults(this.panel, panelDefaults);\r\n    _.defaults(this.panel.legend, panelDefaults.legend);\r\n\r\n    this.events.on('render', this.onRender.bind(this));\r\n    this.events.on('data-received', this.onDataReceived.bind(this));\r\n    this.events.on('data-error', this.onDataError.bind(this));\r\n    this.events.on('data-snapshot-load', this.onDataReceived.bind(this));\r\n    this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\r\n\r\n    this.setLegendWidthForLegacyBrowser();\r\n  }\r\n\r\n  onInitEditMode() {\r\n    this.addEditorTab('Options', 'public/plugins/scadavis-synoptic-panel/editor.html', 2);\r\n    this.unitFormats = kbn.getUnitFormats();\r\n  }\r\n\r\n  setUnitFormat(subItem) {\r\n    this.panel.format = subItem.value;\r\n    this.render();\r\n  }\r\n\r\n  onDataError() {\r\n    this.series = [];\r\n    this.render();\r\n  }\r\n\r\n  changeSeriesColor(series, color) {\r\n    series.color = color;\r\n    this.panel.aliasColors[series.alias] = series.color;\r\n    this.render();\r\n  }\r\n\r\n  onRender() {\r\n    this.data = this.parseSeries(this.series);\r\n  }\r\n\r\n  parseSeries(series) {\r\n    return _.map(this.series, (serie, i) => {\r\n      return {\r\n        label: serie.alias,\r\n        data: serie.stats[this.panel.valueName],\r\n        color: this.panel.aliasColors[serie.alias] || this.$rootScope.colors[i],\r\n        legendData: serie.stats[this.panel.valueName],\r\n      };\r\n    });\r\n  }\r\n\r\n  onDataReceived(dataList) {\r\n    this.series = dataList.map(this.seriesHandler.bind(this));\r\n    this.data = this.parseSeries(this.series);\r\n    this.render(this.data);\r\n\t\r\n\tlet svgurl = this.panel.svgurl\r\n\ttry {\r\n\t\t\tsvgurl = this.templateSrv.replace(this.panel.svgurl, this.panel.scopedVars, 'html');\r\n\t\t} catch (e) {\r\n\t\t\tconsole.log('panel error: ', e);\r\n\t\t}\r\n\t\t\t\r\n\t\t\t\r\n    if ( typeof this.$panelContainer != 'undefined' ) {\r\n      var svelem = this.$panelContainer[0].querySelector('.scadavis-panel__chart');\r\n\r\n      if (svelem && typeof svelem.svgraph === \"undefined\") {      \r\n        svelem.svgraph = new scadavis({ svgurl: svgurl, \r\n                                        container: svelem, \r\n                                        iframeparams: 'frameborder=\"0\" width=\"'+ svelem.clientWidth +'\" height=\"'+ svelem.clientHeight +'\"'\r\n                                      });\r\n        svelem.svgraph.enableMouse(false, false);\r\n        svelem.svgraph.zoomTo(this.panel.zoomLevel);\r\n        svelem.svgraph.hideWatermark();\r\n        this.panel._lastZoomLevel = this.panel.zoomLevel;\r\n        }\r\n\r\n      if (svelem && typeof svelem.svgraph !== \"undefined\") {\r\n        if ( this.panel._lastZoomLevel != this.panel.zoomLevel ) {  \r\n          svelem.svgraph.zoomToOriginal();\r\n          svelem.svgraph.zoomTo(this.panel.zoomLevel);\r\n          this.panel._lastZoomLevel = this.panel.zoomLevel;\r\n          }\r\n        //if (svelem.svgraph.getComponentState() === 0) {\r\n        //   svelem.svgraph.loadURL(this.panel.svgurl);\r\n        //   }\r\n        //else\r\n\t\t\r\n        if ( svelem.svgraph.svgurl != svgurl ) {\r\n           svelem.svgraph.loadURL(svgurl);\r\n           }        \r\n        svelem.svgraph.enableTools(this.panel.showZoomPan, this.panel.showZoomPan);\r\n        for (var i=0; i<this.data.length; i++)\r\n          svelem.svgraph.setValue(this.data[i].label, this.data[i].data); \r\n      }\r\n\r\n    }\r\n\r\n  }\r\n\r\n  seriesHandler(seriesData) {\r\n    var series = new TimeSeries({\r\n      datapoints: seriesData.datapoints,\r\n      alias: seriesData.target\r\n    });\r\n\r\n    series.flotpairs = series.getFlotPairs(this.panel.nullPointMode);\r\n    return series;\r\n  }\r\n\r\n  getDecimalsForValue(value) {\r\n    if (_.isNumber(this.panel.decimals)) {\r\n      return { decimals: this.panel.decimals, scaledDecimals: null };\r\n    }\r\n\r\n    var delta = value / 2;\r\n    var dec = -Math.floor(Math.log(delta) / Math.LN10);\r\n\r\n    var magn = Math.pow(10, -dec);\r\n    var norm = delta / magn; // norm is between 1.0 and 10.0\r\n    var size;\r\n\r\n    if (norm < 1.5) {\r\n      size = 1;\r\n    } else if (norm < 3) {\r\n      size = 2;\r\n      // special case for 2.5, requires an extra decimal\r\n      if (norm > 2.25) {\r\n        size = 2.5;\r\n        ++dec;\r\n      }\r\n    } else if (norm < 7.5) {\r\n      size = 5;\r\n    } else {\r\n      size = 10;\r\n    }\r\n\r\n    size *= magn;\r\n\r\n    // reduce starting decimals if not needed\r\n    if (Math.floor(value) === value) { dec = 0; }\r\n\r\n    var result = {};\r\n    result.decimals = Math.max(0, dec);\r\n    result.scaledDecimals = result.decimals - Math.floor(Math.log(size) / Math.LN10) + 2;\r\n\r\n    return result;\r\n  }\r\n\r\n  formatValue(value) {\r\n    var decimalInfo = this.getDecimalsForValue(value);\r\n    var formatFunc = kbn.valueFormats[this.panel.format];\r\n    if (formatFunc) {\r\n      return formatFunc(value, decimalInfo.decimals, decimalInfo.scaledDecimals);\r\n    }\r\n    return value;\r\n  }\r\n\r\n  link(scope, elem, attrs, ctrl) {\r\n    this.$panelContainer = elem.find('.panel-container');\r\n    // rendering(scope, elem, attrs, ctrl);\r\n  }\r\n\r\n  toggleSeries(serie) {\r\n    if (this.hiddenSeries[serie.label]) {\r\n      delete this.hiddenSeries[serie.label];\r\n    } else {\r\n      this.hiddenSeries[serie.label] = true;\r\n    }\r\n    this.render();\r\n  }\r\n\r\n  onLegendTypeChanged() {\r\n    this.setLegendWidthForLegacyBrowser();\r\n    this.render();\r\n  }\r\n\r\n  setLegendWidthForLegacyBrowser() {\r\n    var isIE11 = !!window.MSInputMethodContext && !!document.documentMode;\r\n    if (isIE11 && this.panel.legendType === 'Right side' && !this.panel.legend.sideWidth) {\r\n      this.panel.legend.sideWidth = 150;\r\n    }\r\n  }\r\n}\r\n\r\nSCADAvisCtrl.templateUrl = 'module.html';\r\n"]}