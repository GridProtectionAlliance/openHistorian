/*! For license information please see module.js.LICENSE.txt */
define(["@grafana/data","@grafana/runtime","@grafana/ui","lodash","react"],((e,t,n,a,r)=>(()=>{"use strict";var i=[e=>{e.exports=r},e=>{e.exports=n},t=>{t.exports=e},e=>{e.exports=a},,e=>{e.exports=t}],o={};function l(e){var t=o[e];if(void 0!==t)return t.exports;var n=o[e]={exports:{}};return i[e](n,n.exports,l),n.exports}l.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return l.d(t,{a:t}),t},l.d=(e,t)=>{for(var n in t)l.o(t,n)&&!l.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},l.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),l.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var u={};return(()=>{l.r(u),l.d(u,{plugin:()=>me});var e=l(2);function t(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function n(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var a=function(){function e(t){var a=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),n(this,"$scope",void 0),n(this,"annotation",void 0),n(this,"datasource",void 0),this.$scope=t,this.annotation=t.ctrl.annotation,this.datasource=t.ctrl.datasource,this.annotation.query=this.annotation.query||{},this.annotation.databases=this.annotation.databases||[],this.annotation.templates=this.annotation.templates||[],this.annotation.regex=this.annotation.regex||{},this.annotation.attribute=this.annotation.attribute||{},this.annotation.showEndTime=this.annotation.showEndTime||!1,this.datasource.getAssetServer(this.datasource.afserver.name).then((function(e){return a.getDatabases(e.WebId)}))}var a,r,i;return e.$inject=["$scope"],a=e,(r=[{key:"templateChanged",value:function(){}},{key:"databaseChanged",value:function(){this.annotation.templates=[],this.getEventFrames()}},{key:"getDatabases",value:function(e){var t=this,n=this;n.datasource.getDatabases(e).then((function(e){n.annotation.databases=e,t.$scope.$apply()}))}},{key:"getEventFrames",value:function(){var e=this,t=this;t.datasource.getEventFrameTemplates(this.annotation.database.WebId).then((function(n){t.annotation.templates=n,e.$scope.$apply()}))}}])&&t(a.prototype,r),i&&t(a,i),Object.defineProperty(a,"prototype",{writable:!1}),e}();n(a,"templateUrl","partials/annotations.editor.html");var r,i=l(0),o=l.n(i),s=l(1);function c(e){return c="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},c(e)}function m(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function h(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function p(e,t){return p=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},p(e,t)}function d(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=b(e);if(t){var r=b(this).constructor;n=Reflect.construct(a,arguments,r)}else n=a.apply(this,arguments);return f(this,n)}}function f(e,t){if(t&&("object"===c(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return v(e)}function v(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function b(e){return b=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},b(e)}function g(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function y(){return y=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e},y.apply(this,arguments)}var P,S,E=s.LegacyForms.FormField,w=function(e){return y({},e,{jsonData:y({},e.jsonData,{url:e.url})})},I=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&p(e,t)}(l,e);var t,n,a,i=d(l);function l(){var e;m(this,l);for(var t=arguments.length,n=new Array(t),a=0;a<t;a++)n[a]=arguments[a];return g(v(e=i.call.apply(i,[this].concat(n))),"onPIServerChange",(function(t){var n=e.props,a=n.onOptionsChange,r=n.options,i=y({},r.jsonData,{piserver:t.target.value});a(y({},r,{jsonData:i}))})),g(v(e),"onAFServerChange",(function(t){var n=e.props,a=n.onOptionsChange,r=n.options,i=y({},r.jsonData,{afserver:t.target.value});a(y({},r,{jsonData:i}))})),g(v(e),"onAFDatabaseChange",(function(t){var n=e.props,a=n.onOptionsChange,r=n.options,i=y({},r.jsonData,{afdatabase:t.target.value});a(y({},r,{jsonData:i}))})),g(v(e),"onMyOptionsChange",(function(t){(0,e.props.onOptionsChange)(w(t))})),e}return t=l,(n=[{key:"render",value:function(){var e=this.props.options,t=w(e);return o().createElement("div",null,o().createElement(s.DataSourceHttpSettings,{defaultUrl:"https://server.name/piwebapi",dataSourceConfig:t,onChange:this.onMyOptionsChange,showAccessOptions:!0}),r||(r=o().createElement("h3",{className:"page-heading"},"PI/AF Connection Details")),o().createElement("div",{className:"gf-form-group"},o().createElement("div",{className:"gf-form"},o().createElement(E,{label:"PI Server",labelWidth:10,inputWidth:25,onChange:this.onPIServerChange,value:t.jsonData.piserver||"",placeholder:"Default PI Server to use for data requests"})),o().createElement("div",{className:"gf-form"},o().createElement(E,{label:"AF Server",labelWidth:10,inputWidth:25,onChange:this.onAFServerChange,value:t.jsonData.afserver||"",placeholder:"Default AF Server to use for data requests"})),o().createElement("div",{className:"gf-form"},o().createElement(E,{label:"AF Database",labelWidth:10,inputWidth:25,onChange:this.onAFDatabaseChange,value:t.jsonData.afdatabase||"",placeholder:"Default AF Database server for AF queries"}))))}}])&&h(t.prototype,n),a&&h(t,a),Object.defineProperty(t,"prototype",{writable:!1}),l}(i.PureComponent),C=l(3);function x(){return x=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e},x.apply(this,arguments)}var O=function(e){var t=e.label,n=e.labelWidth,a=void 0===n?12:n,r=e.tooltip,i=e.children;return o().createElement(o().Fragment,null,o().createElement(s.InlineFormLabel,{width:a,tooltip:r},t),i)},A=function(){return P||(P=o().createElement("div",{className:"gf-form gf-form--grow"},o().createElement("div",{className:"gf-form-label gf-form-label--grow"})))},k=function(e){var t=x({},e);return o().createElement(N,null,o().createElement(O,t))},N=function(e){return o().createElement("div",{className:"gf-form-inline"},e.children,S||(S=o().createElement(A,null)))},j=function(e){var t=x({},e);return o().createElement(V,null,o().createElement(O,t))},V=function(e){return o().createElement(o().Fragment,null,e.children)},F={target:";",attributes:[],segments:[],regex:{enable:!1},summary:{types:[],basis:"EventWeighted",interval:"",nodata:"Null"},expression:"",interpolate:{enable:!1},recordedValues:{enable:!1},digitalStates:{enable:!1},isPiPoint:!1};function T(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null==n)return;var a,r,i=[],o=!0,l=!1;try{for(n=n.call(e);!(o=(a=n.next()).done)&&(i.push(a.value),!t||i.length!==t);o=!0);}catch(e){l=!0,r=e}finally{try{o||null==n.return||n.return()}finally{if(l)throw r}}return i}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return D(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return D(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function D(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,a=new Array(t);n<t;n++)a[n]=e[n];return a}var W,R,B=function(e){var t=e.isRaw,n=e.onChange,a=T((0,i.useState)(!1),2),r=a[0],l=a[1];return(0,i.useEffect)((function(){l(!1)}),[t]),t?o().createElement(o().Fragment,null,o().createElement(s.Button,{"aria-label":"Switch to visual editor",icon:"pen",variant:"secondary",type:"button",onClick:function(){l(!0)}}),o().createElement(s.ConfirmModal,{isOpen:r,title:"Switch to visual editor mode",body:"Are you sure to switch to visual editor mode? You will lose the changes done in raw query mode.",confirmText:"Yes, switch to editor mode",dismissText:"No, stay in raw query mode",onConfirm:function(){n(!1)},onDismiss:function(){l(!1)}})):o().createElement(s.Button,{"aria-label":"Switch to text editor",icon:"pen",variant:"secondary",type:"button",onClick:function(){n(!0)}})};function q(e){return q="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},q(e)}function _(){return _=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e},_.apply(this,arguments)}function G(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function L(e,t){return L=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},L(e,t)}function M(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=U(e);if(t){var r=U(this).constructor;n=Reflect.construct(a,arguments,r)}else n=a.apply(this,arguments);return Q(this,n)}}function Q(e,t){if(t&&("object"===q(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return $(e)}function $(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function U(e){return U=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},U(e)}function H(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var z=24,J=250,X="-REMOVE-",Y=function(e){var t;return e.value?o().createElement("div",{className:"gf-form-label ".concat("template"===e.value.type?"query-keyword":"")},null!==(t=e.label)&&void 0!==t?t:"--no label--"):W||(W=o().createElement("a",{className:"gf-form-label query-part"},o().createElement(s.Icon,{name:"plus"})))},K=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&L(e,t)}(i,e);var t,n,a,r=M(i);function i(e){var t;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,i),H($(t=r.call(this,e)),"error",void 0),H($(t),"piServer",[]),H($(t),"availableAttributes",{}),H($(t),"summaryTypes",void 0),H($(t),"calculationBasis",void 0),H($(t),"noDataReplacement",void 0),H($(t),"state",{isPiPoint:!1,segments:[],attributes:[],summaries:[],attributeSegment:{},summarySegment:{},calculationBasisSegment:{},noDataReplacementSegment:{}}),H($(t),"segmentChangeValue",(function(e){var n=t.props.query;t.setState({segments:e},(function(){return t.onChange(_({},n,{segments:e}))}))})),H($(t),"attributeChangeValue",(function(e){var n=t.props.query;t.setState({attributes:e},(function(){return t.onChange(_({},n,{attributes:e}))}))})),H($(t),"onPiPointChange",(function(e,n){var a=t.state.attributes.slice(0);e.label===X?(0,C.remove)(a,(function(e,t){return t===n})):a[n]=e,t.checkPiPointSegments(e,a)})),H($(t),"onAttributeChange",(function(e,n){var a=t.state.attributes.slice(0);a[n]=e,t.checkAttributeSegments(a,t.state.segments)})),H($(t),"onSegmentChange",(function(e,n){var a,r,i=t.props.query,o=t.state.segments.slice(0);return e.label===X?(o=(0,C.slice)(o,0,n),t.checkAttributeSegments([],o),0===o.length?o.push({label:""}):null!==(r=o[o.length-1].value)&&void 0!==r&&r.expandable&&o.push({label:"Select Element",value:{value:"-Select Element-"}}),i.isPiPoint&&(t.piServer=[]),void t.segmentChangeValue(o)):(o[n]=e,i.isPiPoint?(t.piServer.push(e),void t.segmentChangeValue(o)):(n<o.length-1&&(o=(0,C.slice)(o,0,n+1)),t.checkAttributeSegments([],o),null!==(a=e.value)&&void 0!==a&&a.expandable&&o.push({label:"Select Element",value:{value:"-Select Element-"}}),void t.segmentChangeValue(o)))})),H($(t),"getElementSegments",(function(e,n){var a,r,i=t.props,o=i.datasource,l=i.query,u=i.data,s=$(t),c=l.isPiPoint?{type:"dataserver"}:{path:t.getSegmentPathUpTo(null!=n?n:t.state.segments.slice(0),e)};if(!l.isPiPoint){var m,h,p;if(null!==(m=o.afserver)&&void 0!==m&&m.name&&0===e)return Promise.resolve([{label:o.afserver.name,value:{value:o.afserver.name,expandable:!0}}]);if(null!==(h=o.afserver)&&void 0!==h&&h.name&&null!==(p=o.afdatabase)&&void 0!==p&&p.name&&1===e)return Promise.resolve([{label:o.afdatabase.name,value:{value:o.afdatabase.name,expandable:!0}}])}return o.metricFindQuery(c,Object.assign(null!==(a=null==u||null===(r=u.request)||void 0===r?void 0:r.scopedVars)&&void 0!==a?a:{},{isPiPoint:l.isPiPoint})).then((function(e){var t=(0,C.map)(e,(function(e){return{label:e.text,value:{webId:e.WebId,value:e.text,expandable:!l.isPiPoint&&e.expandable}}}));if(0===t.length)return t;var n=o.templateSrv.getVariables();return(0,C.each)(n,(function(e){var n={label:"${"+e.name+"}",value:{type:"template",value:"${"+e.name+"}",expandable:!l.isPiPoint}};t.unshift(n)})),t.unshift({label:X,value:{value:X}}),t})).catch((function(e){return s.error=e.message||"Failed to issue metric query",[]}))})),H($(t),"getAttributeSegmentsPI",(function(e){var n,a,r=t.props,i=r.datasource,o=r.query,l=r.data,u=$(t),s={path:"",webId:t.getSelectedPIServer(),pointName:(null!=e?e:"")+"*",type:"pipoint"},c=[];return i.metricFindQuery(s,Object.assign(null!==(n=null==l||null===(a=l.request)||void 0===a?void 0:a.scopedVars)&&void 0!==n?n:{},{isPiPoint:o.isPiPoint})).then((function(t){return(c=(0,C.map)(t,(function(e){return{path:e.Path,label:e.text,value:{value:e.text,expandable:!1}}}))).unshift({label:e,value:{value:e,expandable:!1}}),c.unshift({label:X,value:{value:X}}),c})).catch((function(e){return u.error=e.message||"Failed to issue metric query",c}))})),H($(t),"getAttributeSegmentsAF",(function(e){var n=$(t),a=[];return(0,C.forOwn)(n.availableAttributes,(function(e,t){var n={label:t,value:{value:t,expandable:!0}};a.push(n)})),a.unshift({label:X,value:{value:X}}),a})),H($(t),"buildFromTarget",(function(e,n,a){var r=e.target.split(";"),i=r.length>0?r[0].split("\\"):[];return i.length>1||1===i.length&&""!==i[0]?(r.splice(0,1),(0,C.each)(i,(function(e,t){n.push({label:e,value:{value:e,expandable:!0}})})),(0,C.each)(r,(function(e,t){""!==e&&a.push({label:e,value:{value:e,expandable:!1}})})),t.getElementSegments(i.length+1,n).then((function(e){return e.length>0&&n.push({label:"Select Element",value:{value:"-Select Element-"}}),n}))):Promise.resolve(n)})),H($(t),"checkAfServer",(function(){var e,n,a=t.props.datasource,r=[];null!==(e=a.afserver)&&void 0!==e&&e.name?(r.push({label:a.afserver.name,value:{value:a.afserver.name,expandable:!0}}),null!==(n=a.afdatabase)&&void 0!==n&&n.name&&r.push({label:a.afdatabase.name,value:{value:a.afdatabase.name,expandable:!0}}),r.push({label:"Select Element",value:{value:"-Select Element-"}})):r.push({label:""});return r})),H($(t),"updateArray",(function(e,n,a,r,i){t.setState({segments:e,attributes:n,summaries:a,isPiPoint:r},(function(){return t.checkAttributeSegments(n,t.state.segments).then((function(){i&&i()}))}))})),H($(t),"scopedVarsDone",!1),H($(t),"componentDidMount",(function(){t.initialLoad(!1)})),H($(t),"componentDidUpdate",(function(){var e,n,a,r=t.props.query;"Done"===(null===(e=t.props.data)||void 0===e?void 0:e.state)&&null!==(n=t.props.data)&&void 0!==n&&null!==(a=n.request)&&void 0!==a&&a.scopedVars&&!t.scopedVarsDone&&(t.scopedVarsDone=!0,t.initialLoad(!r.isPiPoint))})),H($(t),"initialLoad",(function(e){var n,a,r,i=t.props.query,o=(0,C.defaults)(i,F),l=o.segments,u=o.attributes,s=o.summary,c=o.isPiPoint,m=e?[]:null!==(n=null==l?void 0:l.slice(0))&&void 0!==n?n:[],h=e?[]:null!==(a=null==u?void 0:u.slice(0))&&void 0!==a?a:[],p=null!==(r=null==s?void 0:s.types)&&void 0!==r?r:[];if(c||0!==m.length)c&&m.length>0&&(t.piServer=m);else{if(i.target&&i.target.length>0&&";"!==i.target)return h=[],void t.buildFromTarget(i,m,h).then((function(e){t.updateArray(e,h,p,c)})).catch((function(e){}));m=t.checkAfServer()}t.updateArray(m,h,p,c,(function(){t.onChange(i)}))})),H($(t),"onChange",(function(e){var n,a=t.props,r=a.onChange,i=a.onRunQuery;if(e.summary.types=t.state.summaries,e.rawQuery){if(e.target=null!==(n=e.query)&&void 0!==n?n:"",""!==e.target){var o=e.target.split(";"),l=o[0].split("\\");o.splice(0,1),e.attributes=[],(l.length>1||1===l.length&&""!==l[0])&&(e.elementPath=l.join("\\"),(0,C.each)(o,(function(t,n){""!==t&&e.attributes.push({label:t,value:{value:t,expandable:!1}})})))}}else e.elementPath=t.getSegmentPathUpTo(t.state.segments,t.state.segments.length),e.target=e.elementPath+";"+(0,C.join)(e.attributes.map((function(e){var t;return null===(t=e.value)||void 0===t?void 0:t.value})),";");r(e),e.target&&e.target.length>0&&e.attributes.length>0&&i()})),H($(t),"stateCallback",(function(){var e=t.props.query;t.onChange(e)})),H($(t),"onIsPiPointChange",(function(e){var n=t.props.query,a=!n.isPiPoint;t.setState({segments:a?[{label:""}]:t.checkAfServer(),attributes:[],isPiPoint:a},(function(){t.onChange(_({},n,{expression:"",attributes:t.state.attributes,segments:t.state.segments,isPiPoint:a}))}))})),t.onSegmentChange=t.onSegmentChange.bind($(t)),t.calcBasisValueChanged=t.calcBasisValueChanged.bind($(t)),t.calcNoDataValueChanged=t.calcNoDataValueChanged.bind($(t)),t.onSummaryAction=t.onSummaryAction.bind($(t)),t.onSummaryValueChanged=t.onSummaryValueChanged.bind($(t)),t.onAttributeAction=t.onAttributeAction.bind($(t)),t.onAttributeChange=t.onAttributeChange.bind($(t)),t.summaryTypes=["Total","Average","Minimum","Maximum","Range","StdDev","PopulationStdDev","Count","PercentGood","All","AllForNonNumeric"],t.calculationBasis=["TimeWeighted","EventWeighted","TimeWeightedContinuous","TimeWeightedDiscrete","EventWeightedExcludeMostRecentEvent","EventWeightedExcludeEarliestEvent","EventWeightedIncludeBothEnds"],t.noDataReplacement=["Null","Drop","Previous","0","Keep"],t}return t=i,(n=[{key:"isValueEmpty",value:function(e){return!e||!e.value||!e.value.length||e.value===X}},{key:"calcBasisValueChanged",value:function(e){var t,n=this.props.query,a=n.summary;a.basis=null===(t=e.value)||void 0===t?void 0:t.value,this.onChange(_({},n,{summary:a}))}},{key:"getCalcBasisSegments",value:function(){return(0,C.map)(this.calculationBasis,(function(e){return{label:e,value:{value:e,expandable:!0}}}))}},{key:"calcNoDataValueChanged",value:function(e){var t,n=this.props.query,a=n.summary;a.nodata=null===(t=e.value)||void 0===t?void 0:t.value,this.onChange(_({},n,{summary:a}))}},{key:"getNoDataSegments",value:function(){return(0,C.map)(this.noDataReplacement,(function(e){return{label:e,value:{value:e,expandable:!0}}}))}},{key:"onSummaryValueChanged",value:function(e,t){var n=this.state.summaries.slice(0);n[t]=e,this.isValueEmpty(e.value)&&n.splice(t,1),this.setState({summaries:n},this.stateCallback)}},{key:"getSummarySegments",value:function(){var e=this,t=(0,C.filter)(this.summaryTypes,(function(t){return-1===e.state.summaries.map((function(e){var t;return null===(t=e.value)||void 0===t?void 0:t.value})).indexOf(t)})),n=(0,C.map)(t,(function(e){return{label:e,value:{value:e,expandable:!0}}}));return n.unshift({label:X,value:{value:X}}),n}},{key:"removeSummary",value:function(e){var t=(0,C.filter)(this.state.summaries,(function(t){return t!==e}));this.setState({summaries:t})}},{key:"onSummaryAction",value:function(e){var t=this.state.summaries.slice(0);if(!this.isValueEmpty(e.value)){var n,a={label:e.label,value:{value:null===(n=e.value)||void 0===n?void 0:n.value,expandable:!0}};t.push(a)}this.setState({summarySegment:{},summaries:t},this.stateCallback)}},{key:"removeAttribute",value:function(e){var t=(0,C.filter)(this.state.attributes,(function(t){return t!==e}));this.attributeChangeValue(t)}},{key:"onAttributeAction",value:function(e){var t=this.props.query,n=this.state.attributes.slice(0);if(!this.isValueEmpty(e.value)){var a,r={label:e.label,value:{value:null===(a=e.value)||void 0===a?void 0:a.value,expandable:!t.isPiPoint}};n.push(r)}this.attributeChangeValue(n)}},{key:"getSegmentPathUpTo",value:function(e,t){var n=e.slice(0,t);return(0,C.reduce)(n,(function(e,t){var n;return t.value?null!==(n=t.value.value)&&void 0!==n&&n.startsWith("-Select")?e:e?e+"\\"+t.value.value:t.value.value:""}),"")}},{key:"checkAttributeSegments",value:function(e,t){var n,a,r=this,i=this.props,o=i.datasource,l=i.data,u=this,s={path:this.getSegmentPathUpTo(t.slice(0),t.length),type:"attributes"};return o.metricFindQuery(s,Object.assign(null!==(n=null==l||null===(a=l.request)||void 0===a?void 0:a.scopedVars)&&void 0!==n?n:{},{isPiPoint:!1})).then((function(t){var n={};(0,C.each)(t,(function(e){n[e.Path.substring(e.Path.indexOf("|")+1)]=e.WebId}));var a=(0,C.filter)(e,(function(e){var t,a=o.templateSrv.replace(null===(t=e.value)||void 0===t?void 0:t.value);return void 0!==n[a]}));u.availableAttributes=n,r.attributeChangeValue(a)})).catch((function(t){u.error=t.message||"Failed to issue metric query",r.attributeChangeValue(e)}))}},{key:"checkPiPointSegments",value:function(e,t){var n,a,r=this.props,i=r.datasource,o=r.data,l=this,u={path:e.path,webId:l.getSelectedPIServer(),pointName:e.label,type:"pipoint"};return i.metricFindQuery(u,Object.assign(null!==(n=null==o||null===(a=o.request)||void 0===a?void 0:a.scopedVars)&&void 0!==n?n:{},{isPiPoint:!0})).then((function(){l.attributeChangeValue(t)})).catch((function(e){l.error=e.message||"Failed to issue metric query",l.attributeChangeValue([])}))}},{key:"getSelectedPIServer",value:function(){var e,t=this,n="";return this.piServer.forEach((function(e){var a=t.props.query.target.split(";");a.length>=2&&a[0]===e.text&&(n=e.WebId)})),this.piServer.length>0?null===(e=this.piServer[0].value)||void 0===e?void 0:e.webId:n}},{key:"textEditorChanged",value:function(){var e=this,t=this.props,n=t.query,a=t.onChange,r=n.target.split(";"),i=r.length>0?r[0].split("\\"):[],o=[],l=[];i.length>1||1===i.length&&""!==i[0]?(r.splice(0,1),(0,C.each)(i,(function(e,t){o.push({label:e,value:{type:e.match(/\${\w+}/gi)?"template":void 0,value:e,expandable:!0}})})),this.getElementSegments(i.length+1,o).then((function(e){e.length>0&&o.push({label:"Select Element",value:{value:"-Select Element-"}})})),(0,C.each)(r,(function(e,t){""!==e&&l.push({label:e,value:{value:e,expandable:!1}})})),this.updateArray(o,l,this.state.summaries,n.isPiPoint,(function(){a(_({},n,{query:void 0,rawQuery:!1}))}))):(o=this.checkAfServer(),this.updateArray(o,this.state.attributes,this.state.summaries,n.isPiPoint,(function(){e.onChange(_({},n,{query:void 0,rawQuery:!1,attributes:e.state.attributes,segments:e.state.segments}))})))}},{key:"render",value:function(){var e=this,t=this.props,n=t.query,a=t.onChange,r=t.onRunQuery,i=(0,C.defaults)(n,F),l=i.interpolate,u=i.query,c=i.rawQuery,m=i.digitalStates,h=i.recordedValues,p=i.expression,d=i.isPiPoint,f=i.summary,v=i.display,b=i.regex;return o().createElement(o().Fragment,null,o().createElement(s.InlineField,{label:"Is Pi Point?",labelWidth:z},o().createElement(s.InlineSwitch,{value:d,onChange:this.onIsPiPointChange})),!!c&&o().createElement(s.InlineFieldRow,null,o().createElement(s.InlineField,{label:"Raw Query",labelWidth:z,grow:!0},o().createElement(s.Input,{onBlur:this.stateCallback,value:u,onChange:function(e){return a(_({},i,{query:e.target.value}))},placeholder:"enter query"})),o().createElement(B,{isRaw:!0,onChange:function(t){return e.textEditorChanged()}})),!c&&o().createElement(o().Fragment,null,o().createElement("div",{className:"gf-form-inline"},o().createElement(j,{label:d?"PI Server":"AF Elements",tooltip:d?"Select PI server.":"Select AF Element."},this.state.segments.map((function(t,n){return o().createElement(s.SegmentAsync,{key:"element-"+n,Component:o().createElement(Y,{value:t.value,label:t.label}),onChange:function(t){return e.onSegmentChange(t,n)},loadOptions:function(t){return e.getElementSegments(n)},allowCustomValue:!0,inputMinWidth:200})})),R||(R=o().createElement(A,null)),!d&&o().createElement(B,{isRaw:!1,onChange:function(e){a(_({},i,{query:i.target,rawQuery:e}))}}))),o().createElement(k,{label:d?"Pi Points":"Attributes"},this.state.attributes.map((function(t,n){return d?o().createElement(s.SegmentAsync,{key:"attributes-"+n,Component:o().createElement(Y,{value:t.value,label:t.label}),disabled:0===e.piServer.length,onChange:function(t){return e.onPiPointChange(t,n)},loadOptions:e.getAttributeSegmentsPI,reloadOptionsOnChange:!0,allowCustomValue:!0,inputMinWidth:J}):o().createElement(s.Segment,{key:"attributes-"+n,Component:o().createElement(Y,{value:t.value,label:t.label}),disabled:e.state.segments.length<=2,onChange:function(t){return e.onAttributeChange(t,n)},options:e.getAttributeSegmentsAF(),allowCustomValue:!0,inputMinWidth:J})})),d&&o().createElement(s.SegmentAsync,{Component:o().createElement(Y,{value:this.state.attributeSegment.value,label:this.state.attributeSegment.label}),disabled:0===this.piServer.length,onChange:this.onAttributeAction,loadOptions:this.getAttributeSegmentsPI,reloadOptionsOnChange:!0,allowCustomValue:!0,inputMinWidth:J}),!d&&o().createElement(s.Segment,{Component:o().createElement(Y,{value:this.state.attributeSegment.value,label:this.state.attributeSegment.label}),disabled:this.state.segments.length<=2,onChange:this.onAttributeAction,options:this.getAttributeSegmentsAF(),allowCustomValue:!0,inputMinWidth:J}))),!d&&o().createElement(s.InlineField,{label:"Calculation",labelWidth:z,tooltip:"Modify all attributes by an equation. Use '.' for current item. Leave Attributes empty if you wish to perform element based calculations."},o().createElement(s.Input,{onBlur:r,value:p,onChange:function(t){return e.onChange(_({},i,{expression:t.target.value}))},placeholder:"'.'*2"})),o().createElement(s.InlineFieldRow,null,o().createElement(s.InlineField,{label:"Max Recorded Values",labelWidth:z,tooltip:"Maximum number of recorded value to retrive from the data archive, without using interpolation."},o().createElement(s.Input,{onBlur:r,value:h.maxNumber,onChange:function(t){return e.onChange(_({},i,{recordedValues:_({},h,{maxNumber:parseInt(t.target.value,10)})}))},type:"number",placeholder:"1000"})),o().createElement(s.InlineField,{label:"Recorded Values",labelWidth:z},o().createElement(s.InlineSwitch,{value:h.enable,onChange:function(){return e.onChange(_({},i,{recordedValues:_({},h,{enable:!h.enable})}))}})),o().createElement(s.InlineField,{label:"Digital States",labelWidth:z},o().createElement(s.InlineSwitch,{value:m.enable,onChange:function(){return e.onChange(_({},i,{digitalStates:_({},m,{enable:!m.enable})}))}}))),o().createElement(s.InlineFieldRow,null,o().createElement(s.InlineField,{label:"Interpolate Period",labelWidth:z,tooltip:"Override time between sampling, e.g. '30s'. Defaults to timespan/chart width."},o().createElement(s.Input,{onBlur:r,value:l.interval,onChange:function(t){return e.onChange(_({},i,{interpolate:_({},l,{interval:t.target.value})}))},placeholder:"30s"})),o().createElement(s.InlineField,{label:"Interpolate",labelWidth:z},o().createElement(s.InlineSwitch,{value:l.enable,onChange:function(){return e.onChange(_({},i,{interpolate:_({},l,{enable:!l.enable})}))}})),o().createElement(s.InlineField,{label:"Replace Bad Data",labelWidth:z,tooltip:"Replacement for bad quality values."},o().createElement(s.Segment,{Component:o().createElement(Y,{value:{value:f.nodata},label:f.nodata}),onChange:this.calcNoDataValueChanged,options:this.getNoDataSegments(),allowCustomValue:!0}))),o().createElement(s.InlineFieldRow,null,o().createElement(s.InlineField,{label:"Summary Period",labelWidth:z,tooltip:"Override time between sampling, e.g. '30s'."},o().createElement(s.Input,{onBlur:r,value:f.interval,onChange:function(e){return a(_({},i,{summary:_({},f,{interval:e.target.value})}))},placeholder:"30s"})),o().createElement(s.InlineField,{label:"Basis",labelWidth:z,tooltip:"Defines the possible calculation options when performing summary calculations over time-series data."},o().createElement(s.Segment,{Component:o().createElement(Y,{value:{value:f.basis},label:f.basis}),onChange:this.calcBasisValueChanged,options:this.getCalcBasisSegments(),allowCustomValue:!0})),o().createElement(s.InlineField,{label:"Summaries",labelWidth:z,tooltip:"Replacement for bad quality values."},o().createElement(s.InlineFieldRow,null,this.state.summaries.map((function(t,n){return o().createElement(s.Segment,{key:"summaries-"+n,Component:o().createElement(Y,{value:t.value,label:t.label}),onChange:function(t){return e.onSummaryValueChanged(t,n)},options:e.getSummarySegments(),allowCustomValue:!0})})),o().createElement(s.Segment,{Component:o().createElement(Y,{value:this.state.summarySegment.value,label:this.state.summarySegment.label}),onChange:this.onSummaryAction,options:this.getSummarySegments(),allowCustomValue:!0})))),o().createElement(s.InlineFieldRow,null,o().createElement(s.InlineField,{label:"Display Name",labelWidth:z,tooltip:"If single attribute, modify display name. Otherwise use regex to modify display name."},o().createElement(s.Input,{onBlur:r,value:v,onChange:function(t){return e.onChange(_({},i,{display:t.target.value}))},placeholder:"Display"})),o().createElement(s.InlineField,{label:"Enable Regex Replace",labelWidth:z},o().createElement(s.InlineSwitch,{value:b.enable,onChange:function(){e.onChange(_({},i,{regex:_({},b,{enable:!b.enable})}))}})),o().createElement(s.InlineField,{label:"Search",labelWidth:16},o().createElement(s.Input,{onBlur:r,value:b.search,onChange:function(t){return e.onChange(_({},i,{regex:_({},b,{search:t.target.value})}))},placeholder:"(.*)"})),o().createElement(s.InlineField,{label:"Replace",labelWidth:16},o().createElement(s.Input,{onBlur:r,value:b.replace,onChange:function(t){return e.onChange(_({},i,{regex:_({},b,{replace:t.target.value})}))},placeholder:"$1"}))))}}])&&G(t.prototype,n),a&&G(t,a),Object.defineProperty(t,"prototype",{writable:!1}),i}(i.PureComponent),Z=l(5);function ee(e){return ee="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},ee(e)}function te(){te=function(){return e};var e={},t=Object.prototype,n=t.hasOwnProperty,a="function"==typeof Symbol?Symbol:{},r=a.iterator||"@@iterator",i=a.asyncIterator||"@@asyncIterator",o=a.toStringTag||"@@toStringTag";function l(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function(e,t,n){return e[t]=n}}function u(e,t,n,a){var r=t&&t.prototype instanceof m?t:m,i=Object.create(r.prototype),o=new w(a||[]);return i._invoke=function(e,t,n){var a="suspendedStart";return function(r,i){if("executing"===a)throw new Error("Generator is already running");if("completed"===a){if("throw"===r)throw i;return C()}for(n.method=r,n.arg=i;;){var o=n.delegate;if(o){var l=P(o,n);if(l){if(l===c)continue;return l}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if("suspendedStart"===a)throw a="completed",n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);a="executing";var u=s(e,t,n);if("normal"===u.type){if(a=n.done?"completed":"suspendedYield",u.arg===c)continue;return{value:u.arg,done:n.done}}"throw"===u.type&&(a="completed",n.method="throw",n.arg=u.arg)}}}(e,n,o),i}function s(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}e.wrap=u;var c={};function m(){}function h(){}function p(){}var d={};l(d,r,(function(){return this}));var f=Object.getPrototypeOf,v=f&&f(f(I([])));v&&v!==t&&n.call(v,r)&&(d=v);var b=p.prototype=m.prototype=Object.create(d);function g(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function y(e,t){function a(r,i,o,l){var u=s(e[r],e,i);if("throw"!==u.type){var c=u.arg,m=c.value;return m&&"object"==ee(m)&&n.call(m,"__await")?t.resolve(m.__await).then((function(e){a("next",e,o,l)}),(function(e){a("throw",e,o,l)})):t.resolve(m).then((function(e){c.value=e,o(c)}),(function(e){return a("throw",e,o,l)}))}l(u.arg)}var r;this._invoke=function(e,n){function i(){return new t((function(t,r){a(e,n,t,r)}))}return r=r?r.then(i,i):i()}}function P(e,t){var n=e.iterator[t.method];if(void 0===n){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,P(e,t),"throw"===t.method))return c;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return c}var a=s(n,e.iterator,t.arg);if("throw"===a.type)return t.method="throw",t.arg=a.arg,t.delegate=null,c;var r=a.arg;return r?r.done?(t[e.resultName]=r.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,c):r:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,c)}function S(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function E(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function w(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(S,this),this.reset(!0)}function I(e){if(e){var t=e[r];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var a=-1,i=function t(){for(;++a<e.length;)if(n.call(e,a))return t.value=e[a],t.done=!1,t;return t.value=void 0,t.done=!0,t};return i.next=i}}return{next:C}}function C(){return{value:void 0,done:!0}}return h.prototype=p,l(b,"constructor",p),l(p,"constructor",h),h.displayName=l(p,o,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===h||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,p):(e.__proto__=p,l(e,o,"GeneratorFunction")),e.prototype=Object.create(b),e},e.awrap=function(e){return{__await:e}},g(y.prototype),l(y.prototype,i,(function(){return this})),e.AsyncIterator=y,e.async=function(t,n,a,r,i){void 0===i&&(i=Promise);var o=new y(u(t,n,a,r),i);return e.isGeneratorFunction(n)?o:o.next().then((function(e){return e.done?e.value:o.next()}))},g(b),l(b,o,"Generator"),l(b,r,(function(){return this})),l(b,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var n in e)t.push(n);return t.reverse(),function n(){for(;t.length;){var a=t.pop();if(a in e)return n.value=a,n.done=!1,n}return n.done=!0,n}},e.values=I,w.prototype={constructor:w,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(E),!e)for(var t in this)"t"===t.charAt(0)&&n.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function a(n,a){return o.type="throw",o.arg=e,t.next=n,a&&(t.method="next",t.arg=void 0),!!a}for(var r=this.tryEntries.length-1;r>=0;--r){var i=this.tryEntries[r],o=i.completion;if("root"===i.tryLoc)return a("end");if(i.tryLoc<=this.prev){var l=n.call(i,"catchLoc"),u=n.call(i,"finallyLoc");if(l&&u){if(this.prev<i.catchLoc)return a(i.catchLoc,!0);if(this.prev<i.finallyLoc)return a(i.finallyLoc)}else if(l){if(this.prev<i.catchLoc)return a(i.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return a(i.finallyLoc)}}}},abrupt:function(e,t){for(var a=this.tryEntries.length-1;a>=0;--a){var r=this.tryEntries[a];if(r.tryLoc<=this.prev&&n.call(r,"finallyLoc")&&this.prev<r.finallyLoc){var i=r;break}}i&&("break"===e||"continue"===e)&&i.tryLoc<=t&&t<=i.finallyLoc&&(i=null);var o=i?i.completion:{};return o.type=e,o.arg=t,i?(this.method="next",this.next=i.finallyLoc,c):this.complete(o)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),c},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),E(n),c}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var a=n.completion;if("throw"===a.type){var r=a.arg;E(n)}return r}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,n){return this.delegate={iterator:I(e),resultName:t,nextLoc:n},"next"===this.method&&(this.arg=void 0),c}},e}function ne(e,t,n,a,r,i,o){try{var l=e[i](o),u=l.value}catch(e){return void n(e)}l.done?t(u):Promise.resolve(u).then(a,r)}function ae(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function re(e,t){return re=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},re(e,t)}function ie(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=ue(e);if(t){var r=ue(this).constructor;n=Reflect.construct(a,arguments,r)}else n=a.apply(this,arguments);return oe(this,n)}}function oe(e,t){if(t&&("object"===ee(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return le(e)}function le(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function ue(e){return ue=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},ue(e)}function se(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var ce=function(t){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&re(e,t)}(u,t);var n,a,r,i,o,l=ie(u);function u(e){var t,n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,u),se(le(n=l.call(this,e)),"piserver",void 0),se(le(n),"afserver",void 0),se(le(n),"afdatabase",void 0),se(le(n),"basicAuth",void 0),se(le(n),"withCredentials",void 0),se(le(n),"url",void 0),se(le(n),"name",void 0),se(le(n),"isProxy",!1),se(le(n),"templateSrv",void 0),se(le(n),"backendSrv",void 0),se(le(n),"piwebapiurl",void 0),se(le(n),"webidCache",new Map),se(le(n),"error",void 0),n.basicAuth=e.basicAuth,n.withCredentials=e.withCredentials,n.url=e.url,n.name=e.name,n.templateSrv=(0,Z.getTemplateSrv)(),n.backendSrv=(0,Z.getBackendSrv)(),n.piwebapiurl=null===(t=e.jsonData.url)||void 0===t?void 0:t.toString(),n.isProxy=/^http(s)?:\/\//.test(n.url)||"proxy"===e.jsonData.access,n.piserver={name:(e.jsonData||{}).piserver,webid:void 0},n.afserver={name:(e.jsonData||{}).afserver,webid:void 0},n.afdatabase={name:(e.jsonData||{}).afdatabase,webid:void 0},Promise.all([n.getAssetServer(n.afserver.name).then((function(e){return n.afserver.webid=e.WebId})),n.getDataServer(n.piserver.name).then((function(e){return n.piserver.webid=e.WebId})),n.getDatabase(n.afserver.name?n.afserver.name+"\\"+n.afdatabase.name:void 0).then((function(e){return n.afdatabase.webid=e.WebId}))]),n}return n=u,a=[{key:"eventFrameToAnnotation",value:function(e,t,n,a){e.regex&&e.regex.enable&&(n.Name=n.Name.replace(new RegExp(e.regex.search),e.regex.replace));var r="";return a&&(0,C.each)(a,(function(e){var t=e.Value.Value?e.Value.Value.Name||e.Value.Value.Value||e.Value.Value:null;r+="<br />"+e.Name+": "+t})),{annotation:e,title:(t?"END ":e.showEndTime?"START ":"")+e.name,time:new Date(t?n.EndTime:n.StartTime).getTime(),text:n.Name+r+"<br />Start: "+n.StartTime+"<br />End: "+n.EndTime}}},{key:"buildQueryParameters",value:function(e){var t=this;return e.targets=(0,C.filter)(e.targets,(function(e){return!(!e||!e.target||e.target.startsWith("Select AF"))})),e.targets=(0,C.map)(e.targets,(function(n){var a=t,r={target:t.templateSrv.replace(n.elementPath,e.scopedVars),elementPath:t.templateSrv.replace(n.elementPath,e.scopedVars),elementPathArray:[{path:t.templateSrv.replace(n.elementPath,e.scopedVars),variable:""}],attributes:(0,C.map)(n.attributes,(function(n){var a;return t.templateSrv.replace((null===(a=n.value)||void 0===a?void 0:a.value)||n,e.scopedVars)})),segments:(0,C.map)(n.segments,(function(n){var a;return t.templateSrv.replace(null===(a=n.value)||void 0===a?void 0:a.value,e.scopedVars)})),display:n.display,refId:n.refId,hide:n.hide,interpolate:n.interpolate||{enable:!1},recordedValues:n.recordedValues||{enable:!1},digitalStates:n.digitalStates||{enable:!1},webid:n.webid,webids:n.webids||[],regex:n.regex||{enable:!1},expression:n.expression||"",summary:n.summary||{types:[]},startTime:e.range.from,endTime:e.range.to,isPiPoint:n.isPiPoint,scopedVars:e.scopedVars};r.expression&&(r.expression=t.templateSrv.replace(r.expression,e.scopedVars)),void 0!==r.summary.types&&(r.summary.types=(0,C.filter)(r.summary.types,(function(e){return null!=e&&""!==e})));var i=(0,C.keys)(e.scopedVars);return t.templateSrv.getVariables().forEach((function(e){if(a.isAllSelected(e.current)&&i.indexOf(e.name)<0){var t=e.options.filter((function(e){return!e.selected}));r.attributes=r.attributes.map((function(n){return t.map((function(t){return e.allValue?n.replace(e.allValue,t.value):n.replace(/{[a-zA-z0-9,-_]+}/gi,t.value)}))})),r.attributes=(0,C.uniq)((0,C.flatten)(r.attributes)),r.elementPathArray=a.getElementPath(r.elementPathArray,t,e.allValue)}else if(Array.isArray(e.current.text)&&i.indexOf(e.name)<0){var n=e.options.filter((function(e){return e.selected})),o=e.current.value.join(",");r.attributes=r.attributes.map((function(e){return n.map((function(t){return e.replace("{".concat(o,"}"),t.value)}))})),r.attributes=(0,C.uniq)((0,C.flatten)(r.attributes)),r.elementPathArray=a.getElementPath(r.elementPathArray,n,"{".concat(o,"}"))}})),r})),e}},{key:"query",value:(i=te().mark((function t(n){var a,r;return te().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(a=this,(r=this.buildQueryParameters(n)).targets=(0,C.filter)(r.targets,(function(e){return!e.hide})),!(r.targets.length<=0)){t.next=7;break}return t.abrupt("return",Promise.resolve({data:[]}));case 7:return t.abrupt("return",Promise.all(a.getStream(r)).then((function(t){var n=[];return(0,C.each)(t,(function(e){(0,C.each)(e,(function(e){return n.push(e)}))})),{data:n.sort((function(e,t){return+(e.target>t.target)||+(e.target===t.target)-1})).map((function(t){return(0,e.toDataFrame)(t)}))}})));case 8:case"end":return t.stop()}}),t,this)})),o=function(){var e=this,t=arguments;return new Promise((function(n,a){var r=i.apply(e,t);function o(e){ne(r,n,a,o,l,"next",e)}function l(e){ne(r,n,a,o,l,"throw",e)}o(void 0)}))},function(e){return o.apply(this,arguments)})},{key:"testDatasource",value:function(){return this.backendSrv.datasourceRequest({url:this.url+"/",method:"GET"}).then((function(e){if(200===e.status)return{status:"success",message:"Data source is working",title:"Success"};throw new Error("Failed")}))}},{key:"annotationQuery",value:function(e){var t=this;if(!this.afdatabase.webid)return Promise.resolve([]);var n=e.annotation.query.categoryName?this.templateSrv.replace(e.annotation.query.categoryName,e.scopedVars,"glob"):null,a=e.annotation.query.nameFilter?this.templateSrv.replace(e.annotation.query.nameFilter,e.scopedVars,"glob"):null,r=e.annotation.template?e.annotation.template.Name:null,i={name:e.annotation.name,datasource:e.annotation.datasource,enable:e.annotation.enable,iconColor:e.annotation.iconColor,showEndTime:e.annotation.showEndTime,regex:e.annotation.regex,attribute:e.annotation.attribute,categoryName:n,templateName:r,nameFilter:a},o=[];if(i.categoryName&&o.push("categoryName="+i.categoryName),i.nameFilter&&o.push("nameFilter="+i.nameFilter),i.templateName&&o.push("templateName="+i.templateName),!o.length)return Promise.resolve([]);if(o.push("startTime="+e.range.from.toJSON()),o.push("endTime="+e.range.to.toJSON()),i.attribute&&i.attribute.enable){var l=this.piwebapiurl+"/streamsets/{0}/value?selectedFields=Items.WebId%3BItems.Value%3BItems.Name";i.attribute.name&&(l=this.piwebapiurl+"/streamsets/{0}/value?nameFilter="+i.attribute.name+"&selectedFields=Items.WebId%3BItems.Value%3BItems.Name");var u={};return u[1]={Method:"GET",Resource:this.piwebapiurl+"/assetdatabases/"+this.afdatabase.webid+"/eventframes?"+o.join("&")},u[2]={Method:"GET",RequestTemplate:{Resource:l},Parameters:["$.1.Content.Items[*].WebId"],ParentIds:["1"]},this.restBatch(u).then((function(n){var a=n.data[1].Content,r=n.data[2].Content,o=(0,C.map)(a.Items,(function(e,n){return(0,C.curry)(t.eventFrameToAnnotation)(i,!1,e,r.Items[n].Content.Items)}));if(e.annotation.showEndTime){var l=(0,C.map)(a.Items,(function(e,n){return(0,C.curry)(t.eventFrameToAnnotation)(i,!0,e,r.Items[n].Content.Items)}));(0,C.each)(l,(function(e){o.push(e)}))}return o}))}return this.restGet("/assetdatabases/"+this.afdatabase.webid+"/eventframes?"+o.join("&")).then((function(n){var a=(0,C.map)(n.data.Items,(0,C.curry)(t.eventFrameToAnnotation)(i,!1));if(e.annotation.showEndTime){var r=(0,C.map)(n.data.Items,(0,C.curry)(t.eventFrameToAnnotation)(i,!0));(0,C.each)(r,(function(e){a.push(e)}))}return a}))}},{key:"metricQueryTransform",value:function(e){return(0,C.map)(e,(function(e){var t,n;return{text:e.Name,expandable:void 0===e.HasChildren||!0===e.HasChildren||(null!==(t=e.Path)&&void 0!==t?t:"").split("\\").length<=3,HasChildren:e.HasChildren,Items:null!==(n=e.Items)&&void 0!==n?n:[],Path:e.Path,WebId:e.WebId}}))}},{key:"metricFindQuery",value:function(e,t){var n,a,r=this,i=["servers","databases","databaseElements","elements"];return"string"==typeof e&&(e=JSON.parse(e)),t.isPiPoint?e.path=this.templateSrv.replace(e.path,t):(""===e.path?e.type=i[0]:"attributes"!==e.type&&(e.type=i[Math.max(0,Math.min(e.path.split("\\").length,i.length-1))]),e.path=this.templateSrv.replace(e.path,t),e.path=e.path.replace(/\{([^\\])*\}/gi,(function(e){return e.substring(1,e.length-2).split(",")[0]}))),e.filter=null!==(n=e.filter)&&void 0!==n?n:"*","servers"===e.type?null!==(a=r.afserver)&&void 0!==a&&a.name?r.getAssetServer(r.afserver.name).then((function(e){return[e]})).then(r.metricQueryTransform):r.getAssetServers().then(r.metricQueryTransform):"databases"===e.type?r.getAssetServer(e.path).then((function(e){var t;return r.getDatabases(null!==(t=e.WebId)&&void 0!==t?t:"",{})})).then(r.metricQueryTransform):"databaseElements"===e.type?r.getDatabase(e.path).then((function(e){var t;return r.getDatabaseElements(null!==(t=e.WebId)&&void 0!==t?t:"",{selectedFields:"Items.WebId%3BItems.Name%3BItems.Items%3BItems.Path%3BItems.HasChildren"})})).then(r.metricQueryTransform):"elements"===e.type?r.getElement(e.path).then((function(t){var n;return r.getElements(null!==(n=t.WebId)&&void 0!==n?n:"",{selectedFields:"Items.WebId%3BItems.Name%3BItems.Items%3BItems.Path%3BItems.HasChildren",nameFilter:e.filter})})).then(r.metricQueryTransform):"attributes"===e.type?r.getElement(e.path).then((function(t){var n;return r.getAttributes(null!==(n=t.WebId)&&void 0!==n?n:"",{searchFullHierarchy:"true",selectedFields:"Items.WebId%3BItems.Name%3BItems.Path",nameFilter:e.filter})})).then(r.metricQueryTransform):"dataserver"===e.type?r.getDataServers().then(r.metricQueryTransform):"pipoint"===e.type?r.piPointSearch(e.webId,e.pointName).then(r.metricQueryTransform):Promise.reject("Bad type")}},{key:"getSummaryUrl",value:function(e){return""===e.interval.trim()?"&summaryType="+e.types.map((function(e){var t;return null===(t=e.value)||void 0===t?void 0:t.value})).join("&summaryType=")+"&calculationBasis="+e.basis:"&summaryType="+e.types.map((function(e){var t;return null===(t=e.value)||void 0===t?void 0:t.value})).join("&summaryType=")+"&calculationBasis="+e.basis+"&summaryDuration="+e.interval.trim()}},{key:"parsePiPointValueList",value:function(e,t,n){var a=this,r=this,i=[];return(0,C.each)(e,(function(e){var o=a.noDataReplace(n?e.Value:e,t.summary.nodata,r.parsePiPointValue(n?e.Value:e,t,n)),l=o.grafanaDataPoint;o.previousValue,o.drop||i.push(l)})),i}},{key:"parsePiPointValue",value:function(e,t,n){var a,r,i,o,l=n||"object"!==ee(e.Value)?e.Value:null===(a=e.Value)||void 0===a?void 0:a.Value;return!e.Good||null!==(r=t.digitalStates)&&void 0!==r&&r.enable?(l=null!==(i=n||"object"!==ee(e.Value)?e.Name:null===(o=e.Value)||void 0===o?void 0:o.Name)&&void 0!==i?i:"",[this.checkNumber(l)?Number(l):l.trim(),new Date(e.Timestamp).getTime()]):[this.checkNumber(l)?Number(l):l.trim(),new Date(e.Timestamp).getTime()]}},{key:"noDataReplace",value:function(e,t,n){var a,r,i=null,o=!1;return!e.Good||"No Data"===e.Value||null!==(a=e.Value)&&void 0!==a&&a.Name&&"No Data"===(null===(r=e.Value)||void 0===r?void 0:r.Name)?"Drop"===t?o=!0:"0"===t?n[0]=0:"Keep"===t||("Null"===t?n[0]=null:"Previous"===t&&null!==i&&(n[0]=i)):i=e.Value,{grafanaDataPoint:n,previousValue:i,drop:o}}},{key:"processResults",value:function(e,t,n,a){var r=this,i=t.summary&&t.summary.types&&t.summary.types.length>0;if(n=a?n:this.getPath(t.elementPathArray,e.Path)+"|"+n,t.regex&&t.regex.enable&&t.regex.search.length&&t.regex.replace.length&&(n=n.replace(new RegExp(t.regex.search),t.regex.replace)),i){var o=[],l=(0,C.groupBy)(e.Items,(function(e){return e.Type}));return(0,C.forOwn)(l,(function(e,a){o.push({refId:t.refId,target:n+"["+a+"]",datapoints:r.parsePiPointValueList(e,t,i)})})),o}return[{refId:t.refId,target:n,datapoints:r.parsePiPointValueList(e.Items,t,i)}]}},{key:"isAllSelected",value:function(e){return!!e&&(Array.isArray(e.text)?e.text.indexOf("All")>=0:"All"===e.text)}},{key:"checkNumber",value:function(e){return"number"==typeof e&&!Number.isNaN(e)&&Number.isFinite(e)}},{key:"getElementPath",value:function(e,t,n){var a=[];return e.forEach((function(e){if(n&&e.path.indexOf(n)>=0||!n&&e.path.match(/{[a-zA-z0-9,-_]+}/gi)){var r=t.map((function(t){return{path:n?e.path.replace(n,t.value):e.path.replace(/{[a-zA-z0-9,-_]+}/gi,t.value),variable:t.value}}));a=a.concat(r)}})),a.length?(0,C.uniq)((0,C.flatten)(a)):e}},{key:"getPath",value:function(e,t){var n,a,r=t.split("|");if(0===r.length)return"";if(0===e.length)return"";var i=0===(r=r[0].split("\\")).length?"":null!==(n=r.pop())&&void 0!==n?n:"",o=null===(a=e.find((function(e){return t.indexOf(e.path)>=0})))||void 0===a?void 0:a.variable;return o?o+"|"+i:i}},{key:"getStream",value:function(e){var t=this,n=this,a=[];return(0,C.each)(e.targets,(function(r){r.attributes=(0,C.filter)(r.attributes||[],(function(e){return e}));var i="",o=r.summary&&r.summary.types&&r.summary.types.length>0,l=r.interpolate&&r.interpolate.enable,u=r.interpolate.interval?r.interpolate.interval:e.interval,s="?startTime="+e.range.from.toJSON()+"&endTime="+e.range.to.toJSON(),c=r.expression||r.elementPath,m=r.display?t.templateSrv.replace(r.display,e.scopedVars):null;if(r.expression)i+="/calculation",i+=o?"/summary"+s+(l?"&sampleType=Interval&sampleInterval="+u:""):"/intervals"+s+"&sampleInterval="+u,i+="&expression="+encodeURIComponent(r.expression),r.attributes.length>0?a.push(n.internalStream(e,r,i)):a.push(n.restGetWebId(r.elementPath,r.isPiPoint).then((function(e){return n.restPost(i+e.WebId).then((function(e){return n.processResults(e.data,r,m||c,!1)})).catch((function(e){return n.error=e}))})));else{if(i+="/streamsets",o)i+="/summary"+s+"&intervals="+e.maxDataPoints+t.getSummaryUrl(r.summary);else if(r.interpolate&&r.interpolate.enable)i+="/interpolated"+s+"&interval="+u;else if(r.recordedValues&&r.recordedValues.enable){var h=r.recordedValues.maxNumber&&!isNaN(r.recordedValues.maxNumber)?r.recordedValues.maxNumber:1e3;i+="/recorded"+s+"&maxCount="+h}else i+="/plot"+s+"&intervals="+e.maxDataPoints;a.push(n.internalStream(e,r,i))}})),a}},{key:"internalStream",value:function(e,t,n){var a=this,r=t.expression||t.elementPath,i=t.display?this.templateSrv.replace(t.display,e.scopedVars):null,o=1===t.elementPathArray.length&&t.elementPath===t.elementPathArray[0].path;return(o?t.attributes.length>1&&!t.isPiPoint?a.restGetWebId(t.elementPath,t.isPiPoint).then((function(e){return a.getAttributes(e.WebId,{searchFullHierarchy:"true",nameFilter:"*"})})).then((function(e){return e.filter((function(e){var n;return t.attributes.indexOf(e.Name)>=0||t.attributes.indexOf(null===(n=e.Path)||void 0===n?void 0:n.split("|").splice(1).join("|"))>=0}))})):Promise.all((0,C.map)(t.attributes,(function(e){return a.restGetWebId(t.elementPath+"|"+e,t.isPiPoint)}))):t.attributes.length>1&&!t.isPiPoint?Promise.all(t.elementPathArray.map((function(e){return a.restGetWebId(e.path,t.isPiPoint).then((function(e){return a.getAttributes(e.WebId,{searchFullHierarchy:"true",nameFilter:"*"})})).then((function(e){return e.filter((function(e){var n;return t.attributes.indexOf(e.Name)>=0||t.attributes.indexOf(null===(n=e.Path)||void 0===n?void 0:n.split("|").splice(1).join("|"))>=0}))}))}))):Promise.all((0,C.flatten)((0,C.map)(t.attributes,(function(e){return t.elementPathArray.map((function(n){return a.restGetWebId(n.path+"|"+e,t.isPiPoint)}))}))))).then((function(e){var l={};return(0,C.each)((0,C.flatten)(e),(function(e,t){l[t+1]={Method:"GET",Resource:a.piwebapiurl+n+"&webid="+e.WebId}})),a.restBatch(l).then((function(n){var l=[];return(0,C.each)(n.data,(function(n,u){if(t.expression){var s=e[parseInt(u,10)-1].Name;(0,C.each)(a.processResults(n.Content,t,i||s||r,o),(function(e){return l.push(e)}))}else(0,C.each)(n.Content.Items,(function(e){(0,C.each)(a.processResults(e,t,i||e.Name||r,o),(function(e){return l.push(e)}))}))})),l})).catch((function(e){return a.error=e}))}))}},{key:"restGet",value:function(e){return this.backendSrv.datasourceRequest({url:this.url+e,method:"GET",headers:{"Content-Type":"application/json"}}).then((function(e){return e}))}},{key:"restGetWebId",value:function(e,t){var n=this,a=n.webidCache.get(e);if(a)return Promise.resolve({Path:e,WebId:a.WebId,Name:a.Name});var r="";return r=t?"/points?selectedFields=WebId%3BName%3BPath&path=\\\\"+e.replace("|","\\"):(e.indexOf("|")>=0?"/attributes?selectedFields=WebId%3BName%3BPath&path=\\\\":"/elements?selectedFields=WebId%3BName%3BPath&path=\\\\")+e,this.backendSrv.datasourceRequest({url:this.url+r,method:"GET",headers:{"Content-Type":"application/json"}}).then((function(t){return n.webidCache.set(e,t.data),{Path:e,WebId:t.data.WebId,Name:t.data.Name}}))}},{key:"restBatch",value:function(e){return this.backendSrv.datasourceRequest({url:this.url+"/batch",data:e,method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"message/http"}})}},{key:"restPost",value:function(e){return this.backendSrv.datasourceRequest({url:this.url,method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"message/http","X-PIWEBAPI-HTTP-METHOD":"GET","X-PIWEBAPI-RESOURCE-ADDRESS":e}})}},{key:"getDataServers",value:function(){return this.restGet("/dataservers").then((function(e){var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]}))}},{key:"getDataServer",value:function(e){return e?this.restGet("/dataservers?name="+e).then((function(e){return e.data})):Promise.resolve({})}},{key:"getAssetServers",value:function(){return this.restGet("/assetservers").then((function(e){var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]}))}},{key:"getAssetServer",value:function(e){return e?this.restGet("/assetservers?path=\\\\"+e).then((function(e){return e.data})):Promise.resolve({})}},{key:"getDatabase",value:function(e){return e?this.restGet("/assetdatabases?path=\\\\"+e).then((function(e){return e.data})):Promise.resolve({})}},{key:"getDatabases",value:function(e,t){return e?this.restGet("/assetservers/"+e+"/assetdatabases").then((function(e){var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]})):Promise.resolve([])}},{key:"getElement",value:function(e){return e?this.restGet("/elements?path=\\\\"+e).then((function(e){return e.data})):Promise.resolve({})}},{key:"getEventFrameTemplates",value:function(e){return e?this.restGet("/assetdatabases/"+e+"/elementtemplates?selectedFields=Items.InstanceType%3BItems.Name%3BItems.WebId").then((function(e){var t;return(0,C.filter)(null!==(t=e.data.Items)&&void 0!==t?t:[],(function(e){return"EventFrame"===e.InstanceType}))})):Promise.resolve([])}},{key:"getElementTemplates",value:function(e){return e?this.restGet("/assetdatabases/"+e+"/elementtemplates?selectedFields=Items.InstanceType%3BItems.Name%3BItems.WebId").then((function(e){var t;return(0,C.filter)(null!==(t=e.data.Items)&&void 0!==t?t:[],(function(e){return"Element"===e.InstanceType}))})):Promise.resolve([])}},{key:"getAttributes",value:function(e,t){var n="?"+(0,C.map)(t,(function(e,t){return t+"="+e})).join("&");return"?"===n&&(n=""),this.restGet("/elements/"+e+"/attributes"+n).then((function(e){var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]}))}},{key:"getDatabaseElements",value:function(e,t){var n="?"+(0,C.map)(t,(function(e,t){return t+"="+e})).join("&");return"?"===n&&(n=""),this.restGet("/assetdatabases/"+e+"/elements"+n).then((function(e){var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]}))}},{key:"getElements",value:function(e,t){var n="?"+(0,C.map)(t,(function(e,t){return t+"="+e})).join("&");return"?"===n&&(n=""),this.restGet("/elements/"+e+"/elements"+n).then((function(e){var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]}))}},{key:"piPointSearch",value:function(e,t){var n=this.templateSrv.replace(t),a="".concat(n),r=!1;if(n!==t)for(var i,o=/\{(\w|,)+\}/g;null!==(i=o.exec(n));)i.index===o.lastIndex&&o.lastIndex++,i.forEach((function(e,t){0===t&&(n=n.replace(e,e.replace("{","(").replace("}",")").replace(",","|")),a=a.replace(e,"*"),r=!0)}));return this.restGet("/dataservers/"+e+"/points?maxCount=20&nameFilter="+a).then((function(e){var t;return e&&null!==(t=e.data)&&void 0!==t&&t.Items?r?e.data.Items.filter((function(e){var t;return null===(t=e.Name)||void 0===t?void 0:t.match(n)})):e.data.Items:[]}))}},{key:"getWebId",value:function(e){var t=this,n=e.target.indexOf("\\")>=0,a=e.target.indexOf("|")>=0;return n||-1!==e.target.indexOf(".")?n?n&&a?t.restGet("/attributes?path=\\\\"+e.target).then((function(t){return void 0===t.data||200!==t.status?[{WebId:e.target,Name:e.display||e.target}]:(t.data.Name=e.display||t.data.Name,[t.data])})):t.restGet("/elements?path=\\\\"+e.target).then((function(t){return void 0===t.data||200!==t.status?[{WebId:e.target,Name:e.display||e.target}]:(t.data.Name=e.display||t.data.Name,[t.data])})):t.piPointSearch(this.piserver.webid,e.target).then((function(t){return void 0===t||0===t.length?[{WebId:e.target,Name:e.display||e.target}]:t})):Promise.resolve([{WebId:e.target,Name:e.display||e.target}])}}],a&&ae(n.prototype,a),r&&ae(n,r),Object.defineProperty(n,"prototype",{writable:!1}),u}(e.DataSourceApi),me=new e.DataSourcePlugin(ce).setConfigEditor(I).setQueryEditor(K).setAnnotationQueryCtrl(a)})(),u})()));
//# sourceMappingURL=module.js.map